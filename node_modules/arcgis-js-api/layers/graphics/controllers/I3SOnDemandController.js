// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.10/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/declareExtendsHelper","../../../core/tsSupport/decorateHelper","dojo/errors/CancelError","../../../core/Accessor","../../../core/arrayUtils","../../../core/Evented","../../../core/Handles","../../../core/has","../../../core/Logger","../../../core/PooledArray","../../../core/Promise","../../../core/promiseUtils","../../../core/watchUtils","../../../core/accessorSupport/decorators","../../../core/libs/gl-matrix-2/gl-matrix","../../../core/sql/WhereClause","../../../geometry/support/aaBoundingBox","../../../views/3d/layers/i3s/I3SFrameWorker","../../../views/3d/layers/i3s/I3SIndex","../../../views/3d/layers/i3s/I3SLodHandling","../../../views/3d/layers/i3s/I3SNodeLoader","../../../views/3d/layers/i3s/I3SUtil","../../../views/3d/layers/i3s/I3SViewportQueries","../../../views/3d/layers/i3s/IdleQueue","../../../views/3d/support/projectionUtils","../../../views/3d/support/ResourceController"],function(e,t,i,r,n,o,a,s,d,l,u,h,p,c,_,f,g,y,v,m,w,b,x,L,N,I,D,C){function F(e,t){return e.length===t.length&&e.every(function(e){return O(t,e.name)>=0})}function O(e,t){for(var i=t.toLowerCase(),r=0;r<e.length;r++)if(e[r].name.toLowerCase()===i)return r;return-1}function V(e){return null!=e&&null!=e.loadedAttributes&&null!=e.attributeData}var P=u.getLogger("esri.layers.graphics.controllers.I3SOnDemandController"),E=function(e){function t(t){var i=e.call(this)||this;return i.nodeIndex={},i.screenSizeFactor=0,i.featureTarget=5e4,i.fixedFeatureTarget=!1,i.updating=!0,i.updatingPercentage=0,i.leafsReached=!1,i.uncompressedTextureDownsamplingEnabled=!1,i.alwaysLoadEverythingModeEnabled=!1,i._featureLOD=1,i._stableFeatureLOD=!1,i._isIdle=!1,i._cameraDirty=!0,i._hasFeatures=!1,i._downloadingNodes=new Set,i._loadingNodes=new Set,i._updatingNodes=new Map,i._progressMaxNumNodes=1,i._poi=null,i._requiredAttributesDirty=!0,i._updatesDisabled=!1,i.disableIDBCache=!1,i.disableMemCache=!1,i._restartNodeLoading=!1,i._fields=null,i._attributeStorageInfo=null,i._handles=new d,i._idleQueue=new I.IdleQueue,i._errorCount=0,i}return i(t,e),Object.defineProperty(t.prototype,"isMeshPyramid",{get:function(){return"mesh-pyramids"===this.layer.profile||"MeshPyramid"===this.layer.store.lodType},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"streamDataSupplier",{get:function(){return this.layerView.view.resourceController.getStreamDataSupplier(C.ClientType.SCENE,{trackRequests:!0})},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"parsedDefinitionExpression",{get:function(){if(!("definitionExpression"in this.layer&&this.layer.definitionExpression))return null;try{var e=y.create(this.layer.definitionExpression);if(!e.isStandardized())return P.error("definitionExpression is using non standard function"),null;var t=[],i=e.getFields();return L.findFieldsCaseInsensitive(i,this.layer.fields,{missingFields:t}),t.length>0?(P.error("definitionExpression references unknown fields: "+t.join(", ")),null):e}catch(e){return P.error("Failed to parse definitionExpression: "+e),null}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"definitionExpressionFields",{get:function(){if(this.parsedDefinitionExpression){var e=this.parsedDefinitionExpression.getFields();return L.findFieldsCaseInsensitive(e,this._fields)}return null},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"crsVertex",{get:function(){return L.getVertexCrs(this.layer)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"crsIndex",{get:function(){return L.getIndexCrs(this.layer)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"rootNodeVisible",{get:function(){var e=this._rootNodeId&&this.nodeIndex[this._rootNodeId];return!e||!this._viewportQueries||this._viewportQueries.isNodeVisible(e)},enumerable:!0,configurable:!0}),t.prototype.initialize=function(){var e=this;this.updateEventListener={needsUpdate:function(){return!1},idleBegin:function(){return e._updateIdleState(!0)},idleEnd:function(){return e._updateIdleState(!1)}},this.updateEventListenerWhileSuspended={idleBegin:function(){return e._startNodeLoadingWhileSuspended()}},this._lodHandling=new b(this.layerView,function(){return e.updatingChanged()});var t=this.layerView.layer;this.layer=t,this._defaultGeometrySchema=t.store.defaultGeometrySchema,this._rootNodeUrl=t.store.rootNode;var i=this._rootNodeUrl.split("/");this._rootNodeId=i[i.length-1],this.disableIDBCache=l("disable-feature:idb-cache"),"fields"in t&&(this._fields=t.fields,this._attributeStorageInfo=t.attributeStorageInfo);var r=c.all([this.layer.when(),this.layerView.when()]).then(function(){if(!e.destroyed&&e.layerView&&!e.layerView.destroyed){var t=e.layerView.view;e.setClippingArea(t.clippingArea);var i=t.pointsOfInterest;e._centerOnSurface=i.centerOnSurfaceFrequent,e._handles.add(e._centerOnSurface.watch("renderLocation",function(){return e._pointOfInterestChanged()}));var r=e.layerView.view.resourceController;e._handles.add(r.memoryEvents.on("quality-changed",function(){return e._setCameraDirty()})),e._handles.add(_.init(e.layerView,"suspended",function(t){e._idleFrameWorker&&(e._idleFrameWorker.remove(),e._idleFrameWorker=null,e.restartNodeLoading()),e._removeFrameWorker(),t?e._idleFrameWorker=r.registerIdleFrameWorker(e.updateEventListenerWhileSuspended):(e._idleFrameWorker=r.registerIdleFrameWorker(e.updateEventListener),e._initFrameWorker())}),"layerview"),e._handles.add(e.layer.watch("elevationInfo",function(t){return e._elevationInfoChanged(t)}),"layer"),e.watch("uncompressedTextureDownsamplingEnabled",function(){return e.restartNodeLoading()}),e.watch("alwaysLoadEverythingModeEnabled",function(){return e.restartNodeLoading()}),e._handles.add(t.state.watch("camera",function(){return e._setCameraDirty()})),e._handles.add(e.watch(["featureTarget","fixedFeatureTarget"],function(){return e._stableFeatureLOD=!1})),e._handles.add(e.layerView.watch("lodFactor",function(){return e._setCameraDirty()}),"quality"),e._handles.add([e.layer.watch("renderer",function(){return e._requiredFieldsChange()}),e.layer.watch("definitionExpression",function(){return e._requiredFieldsChange()}),e.layer.watch("labelsVisible",function(){return e._labelingChanged()}),e.layer.watch("labelingInfo",function(){return e._labelingChanged()}),e.layerView.watch("additionalRequiredFields",function(){return e._requiredFieldsChange()})],"requiredAttributes")}});this.addResolvingPromise(r),this.when(function(){return e._startNodeLoading()})},t.prototype.destroy=function(){this._removeFrameWorker(),this._idleFrameWorker&&(this._isIdle=!1,this._idleFrameWorker.remove(),this._idleFrameWorker=null),this._handles.destroy(),this._nodeLoader=null},t.prototype._initFrameWorker=function(){var e=this;this._frameWorker=m.addFrameWorker(this.layerView.view.resourceController,function(t,i){return e._frame(t,i),e._index?e._index.getPriority():-1/0})},t.prototype._removeFrameWorker=function(){null!=this._frameWorker&&(this._frameWorker.remove(),this._frameWorker=null)},t.prototype._getRequiredAttributes=function(){if(null==this._attributeStorageInfo||!this._fields)return[];var e=Object.create(null);if(this.layer.renderer&&this.layer.renderer.collectRequiredFields(e),this.layer.labelsVisible&&this.layer.labelingInfo&&this.layer.labelingInfo.forEach(function(t){t._collectRequiredFields(e)}),null!=this.definitionExpressionFields)for(var t=0,i=this.definitionExpressionFields;t<i.length;t++){var r=i[t];e[r]=!0}if(null!=this.layerView.additionalRequiredFields)for(var n=0,o=this.layerView.additionalRequiredFields;n<o.length;n++){var r=o[n];e[r]=!0}var a=this._attributeStorageInfo,s=this._fields,d=this.layer.objectIdField;return Object.keys(e).map(function(e){var t=O(a,e),i=O(s,e);return t>=0&&i>=0?{index:t,name:s[i].name,field:s[i],attributeStorageInfo:a[t]}:null}).filter(function(e){return null!=e&&e.name!==d}).sort(function(e,t){return t.index-e.index}).filter(function(e,t,i){return 0===t||i[t-1].index!==e.index})},t.prototype._requiredFieldsChange=function(){this._requiredAttributesDirty=!0,this.restartNodeLoading()},t.prototype._labelingChanged=function(){F(this._requiredAttributes,this._getRequiredAttributes())||this._requiredFieldsChange()},t.prototype.setClippingArea=function(e){var t=v.create();D.extentToBoundingBox(e,t,this.layerView.view.renderSpatialReference)?this._clippingArea=t:this._clippingArea=null},t.prototype._pointOfInterestChanged=function(){this._poi&&(this._calculatePointOfInterest(this._poi),this._viewportQueries&&(this._viewportQueries.updatePointOfInterest(this._poi),this._index&&(this._index.progressiveLoadPenalty=A.distancePenalty*this._viewportQueries.distCameraToPOI(),this._index.requestReload())))},t.prototype._calculatePointOfInterest=function(e){void 0===e&&(e=g.vec3f64.create());var t=this._centerOnSurface.renderLocation,i=g.vec3f64.create();g.vec3.subtract(i,t,this.camPos),g.vec3.normalize(i,i);var r=this.layerView.view.renderCoordsHelper,n=g.vec3f64.create();r.worldUpAtPosition(t,n);var o=Math.acos(g.vec3.dot(n,i))-.5*Math.PI;return g.vec3.lerp(e,this.camPos,t,Math.max(0,Math.min(1,o/(.5*Math.PI)))),e},t.prototype.updateClippingArea=function(e){this.setClippingArea(e),this._cameraDirty=!0,this._viewportQueries&&this._viewportQueries.updateExtent(this._clippingArea)},t.prototype._setCameraDirty=function(){this._cameraDirty=!0,this.updatingChanged()},t.prototype.getBaseUrl=function(){return this.layer.parsedUrl.path},t.prototype.updateElevationChanged=function(e,t,i){L.findIntersectingNodes(e,t,this.nodeIndex.root,this.crsIndex,this.nodeIndex,function(e){i.push(e)});for(var r=0;r<i.length;r++){var n=i.data[r];this._viewportQueries.invalidateCache(n.id),n.id===this._rootNodeId&&this.notifyChange("rootNodeVisible")}i.length&&this.restartNodeLoading()},t.prototype._elevationInfoChanged=function(e){this._viewportQueries.invalidateCache(),this._initViewData()},t.prototype.restartNodeLoading=function(){this._restartNodeLoading=!0,this.updatingChanged()},t.prototype.schedule=function(e,t){var i=this;return this._idleQueue.push(t).then(function(t){if(!i._loadingNodes.has(e)&&!i._updatingNodes.has(e))throw new n;return t})},t.prototype.reschedule=function(e,t){var i=this;return this._idleQueue.unshift(t).then(function(t){if(!i._loadingNodes.has(e)&&!i._updatingNodes.has(e))throw new n;return t})},Object.defineProperty(t.prototype,"unloadedMemoryEstimate",{get:function(){return!this._index||this.layerView.suspended?0:this._index.getUnloadedMemoryEstimate()*this.lodDropFactor},enumerable:!0,configurable:!0}),t.prototype._frame=function(e,t){null!==this._viewportQueries&&this._viewportQueries.setCameraIdle(!this._cameraDirty),this.layerView.visible&&this._processLogError(e,t)},t.prototype._processLogError=function(e,t){try{this._process(e,t)}catch(e){this._errorCount<50?P.error("Error during processing: "+e):50===this._errorCount&&P.error("Too many errors for this layer. Further errors will not be displayed."),this._errorCount++}},t.prototype._process=function(e,t){var i=this;if(this._restartNodeLoading&&(this.cancelNodeLoading(),this._startNodeLoading()),null!=this._nodeLoader&&null!=this._index){for(this._updateViewData(),e.runWithProgress(function(){return i._processIndex(t)}),this._updateFeatureLOD(),e.runWithProgress(function(){return i._processNodes(e,t)});this._idleQueue.length()>0&&!e.doneWithProgress();)this._idleQueue.process(),e.madeProgress();e.runWithProgress(function(){return i._prefetchIndex(t)}),t.numIndexLoading+=this._index.getIndexLoading(),t.numNodesLoading+=this._downloadingNodes.size,this.updatingChanged(),this._lodHandling.lodGlobalHandling()}},t.prototype._processIndex=function(e){var t=Math.min(10-e.numIndexLoading-this._index.getIndexLoading(),this._getAvailableLoadTokens(1,e));this._index.update(a.keysOfSet(this._loadingNodes));var i=this._index.getFeatureEstimate().leafsReached;return this._index.isLoading()||i===this._get("leafsReached")||this._set("leafsReached",i),this._index.load(t)},t.prototype._prefetchIndex=function(e){if(this._loadingNodes.size>0)return!1;var t=Math.min(10-e.numIndexLoading-this._index.getIndexLoading(),this._getAvailableLoadTokens(1,e));return this._index.prefetch(t)},t.prototype._updateFeatureLOD=function(){var e=this._index.getFeatureEstimate();if(e.estimate){var t=this.featureTarget*this.baseLOD,i=!this._index.isLoading();if(this._index.getIndexMissing()>500){if(this._featureLOD<=1e-4)return;this._featureLOD/=1.5,this._stableFeatureLOD=!1}else if(i&&e.estimate<t){if(e.leafsReached||this._featureLOD>=1e4||this._stableFeatureLOD)return;var r=Math.max(t/e.estimate,1.001);this._featureLOD*=r;var n=this.lod,o=this._index.checkFeatureTarget(t,n);o!==n&&(this._featureLOD=o/this.baseLOD,this._stableFeatureLOD=!0)}else{if(!(e.estimate>1.2*t||i&&e.estimate>t))return;if(this._featureLOD<=1e-4)return;this._featureLOD/=1+.25*(e.estimate/t-1),this._stableFeatureLOD=!1}this._featureLOD=Math.min(1e4,Math.max(1e-4,this._featureLOD)),this._viewportQueries.updateScreenSpaceErrorBias(this.lod),this._index.requestReload()}},t.prototype._processNodes=function(e,t){var i=this,r=(this._isIdle?100:2)-this._loadingNodes.size,n=this._index.getUpdates(r);return n.cancel.forEach(this._cancelNodeIdLoading,this),n.update.some(function(t){return!!e.doneWithProgress()||(i._updateLoadedNode(t),e.madeProgress(),!1)}),n.add.some(function(r){return!!e.doneWithProgress()||!(r.notInCache&&!i._hasNodeLoadToken(t))&&(i._loadNode(r),e.madeProgress(),!1)}),e.hasProgressed},t.prototype._cancelNodeLoading=function(){var e=this;this._loadingNodes.clear(),this._downloadingNodes.clear(),this._updatingNodes.forEach(function(t,i){return e._updatingNodes.get(i).cancel()}),this._updatingNodes.clear()},t.prototype._cancelNodeIdLoading=function(e){this._loadingNodes.delete(e),this._downloadingNodes.delete(e)},t.prototype._getAvailableLoadTokens=function(e,t){var i=t.numIndexLoading+this._index.getIndexLoading(),r=t.numNodesLoading+this._loadingNodes.size;return Math.floor((12-1*i-2*r)/e)},t.prototype._hasNodeLoadToken=function(e){var t=this._isIdle&&!this._index.isLoading()?5:2;return!(e.numNodesLoading+this._loadingNodes.size>=t)&&this._getAvailableLoadTokens(2,e)>0},t.prototype.updatingChanged=function(){var e=this._index?this._index.getIndexMissing():0,t=this._index?this._index.getNodesMissing():0,i=e+3*t+2*this._loadingNodes.size,r=!(!(i>0||this._updatingNodes.size>0||this._restartNodeLoading||this._cameraDirty||this._idleQueue.length()>0||this._lodHandling&&this._lodHandling.requiresLODGlobalHandling)&&this._isIdle);0===i&&(this._progressMaxNumNodes=1),this._progressMaxNumNodes=Math.max(i,this._progressMaxNumNodes),r!==this._get("updating")&&this._set("updating",r);var n=100*i/this._progressMaxNumNodes;n!==this._get("updatingPercentage")&&this._set("updatingPercentage",n)},t.prototype._initViewData=function(){var e=this.layerView.view,t=e.state.camera,i=e.renderCoordsHelper;this.camPos=g.vec3f64.clone(e.pointsOfInterest.renderPointOfView),this.screenSizeFactor=1/t.perPixelRatio,this._poi=this._calculatePointOfInterest();var r=this.lod;this._viewportQueries=new N(this.crsIndex,i,t,this._poi,this._clippingArea,e.elevationProvider,this.layer.elevationInfo,{progressiveLoadFactor:this._getProgressiveLoadFactor(this.layer),screenspaceErrorBias:r,angleDependentLoD:r<.5,disableLod:this.alwaysLoadEverythingModeEnabled}),this._cameraDirty=!1,this.notifyChange("rootNodeVisible")},t.prototype._updateViewData=function(){if(this._cameraDirty&&this._index){var e=this.layerView.view,t=e.state.camera;this.camPos=g.vec3f64.clone(e.pointsOfInterest.renderPointOfView),this.screenSizeFactor=1/t.perPixelRatio,this._poi=this._calculatePointOfInterest(this._poi),this._viewportQueries.updateCamera(t),this._viewportQueries.updatePointOfInterest(this._poi),this._viewportQueries.updateScreenSpaceErrorBias(this.lod),this._index.progressiveLoadPenalty=A.distancePenalty*this._viewportQueries.distCameraToPOI(),this._index.requestReload(),this._stableFeatureLOD=!1,this.alwaysLoadEverythingModeEnabled||this._removeInvisibleNodes(),this._cameraDirty=!1,this.notifyChange("rootNodeVisible")}},t.prototype._getProgressiveLoadFactor=function(e){return this.layerView.view.resourceController.memoryFactor<1?1:this.layerView.progressiveLoadFactor},Object.defineProperty(t.prototype,"lod",{get:function(){return this._featureLOD*this.baseLOD},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"baseLOD",{get:function(){return this.fixedFeatureTarget?1:this.layerView.lodFactor*this.layerView.view.resourceController.memoryFactor},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"lodDropFactor",{get:function(){return this.fixedFeatureTarget?0:2*Math.min(this.layerView.view.resourceController.memoryFactor,.5)},enumerable:!0,configurable:!0}),t.prototype._startNodeLoadingWhileSuspended=function(){this._initViewData(),this.alwaysLoadEverythingModeEnabled&&this.layerView.visible&&!this.layerView.get("parent.suspended")||this._removeInvisibleNodes()},t.prototype.isGeometryVisible=function(e){return this._viewportQueries.isGeometryVisible(e)},t.prototype.updateVisibility=function(e){return this._viewportQueries.updateNode(e)},t.prototype._shouldLoadNode=function(e){return!(!this._lodHandling.shouldLoadNode(e)||this._shouldDropNode(e))&&(!e.obb||this._viewportQueries.isGeometryVisible(e))},t.prototype._shouldDropNode=function(e){var t=this.lodDropFactor;return t<1&&this._lodHandling.childrenEmpty(e)&&this._viewportQueries.calcCameraDistance(e)>this._viewportQueries.maxDistance*t},t.prototype._startNodeLoading=function(){var e=this;if(this._restartNodeLoading=!1,!this._updatesDisabled&&null!=this.streamDataSupplier){this._initViewData(),this._requiredAttributesDirty&&(this._requiredAttributes=this._getRequiredAttributes(),this._requiredAttributesDirty=!1);var t=x.TextureFormat.Normal;this.layerView.useCompressedTextures?t=x.TextureFormat.Compressed:this.uncompressedTextureDownsamplingEnabled&&(t=x.TextureFormat.Downsampled);var i=this._defaultGeometrySchema,r={textureFormat:t,loadTextureData:this.layerView.rendererNeedsTextures,loadFeatureData:!this.isMeshPyramid||null==i||null==i.ordering};this._nodeLoader=new x(this.streamDataSupplier,P,i,this._requiredAttributes,r);var n=A.distancePenalty*this._viewportQueries.distCameraToPOI();this._index=new w(this.getBaseUrl(),this._rootNodeUrl,this._rootNodeId,n,this.nodeIndex,this.streamDataSupplier,this._viewportQueries,P,function(t){return e.layerView.isNodeLoaded(t)},function(t){return e._shouldLoadNode(t)},function(t){return e._enableFromGPUCache(t)},function(t){return e._needsUpdate(t)});var o=this.layerView.view.renderSpatialReference,a=this.crsIndex.equals(o)||this.crsIndex.isWGS84&&o.equals(D.SphericalECEFSpatialReference);this._index.ignoreServiceOBB=!a,this.alwaysLoadEverythingModeEnabled||this._removeInvisibleNodes(),this._lodHandling.startNodeLoading(function(t){return e._viewportQueries.isNodeVisible(t)},function(t){return e._viewportQueries.isGeometryVisible(t)},function(t){return e._index.nodeTraversalState(t)},this.nodeIndex,this._rootNodeId,{maxLodLevel:this._viewportQueries.maxLodLevel}),this.updatingChanged()}},t.prototype.isNodeLoading=function(){return null!=this._nodeLoader&&null!=this._index},t.prototype.cancelNodeLoading=function(){this.isNodeLoading()&&(this._nodeLoader.cancelAll(),this.streamDataSupplier.cancelAll(),this._idleQueue.cancelAll(),this._cancelNodeLoading(),this._nodeLoader=null,this._index=null,this._poi=null,this.layerView.additionalCancelNodeLoadingHandler&&this.layerView.additionalCancelNodeLoadingHandler(),this.updatingChanged())},t.prototype._removeInvisibleNodes=function(){var e=this.layerView.getLoadedNodeIDs();S.clear();for(var t=0;t<e.length;t++){var i=this.nodeIndex[e[t]];this._viewportQueries.isGeometryVisible(i)&&!this._shouldDropNode(i)||(this._lodHandling.setLodGlobalDirty(),S.push(i))}return S.length>0&&(this.layerView.removeNodeData(S),S.clear(),!0)},t.prototype._needsUpdate=function(e){if(null==e.featureData||0===e.featureData.length||this._updatingNodes.has(e.id))return!1;var t=this.layerView.getLoadedAttributes(e);return null!=t&&t!==this._requiredAttributes},t.prototype._updateLoadedNode=function(e){var t=this,i=e.baseUrl,r=this.layerView.getLoadedAttributes(e),o=F(r,this._requiredAttributes)?c.resolve(this.layerView.getAttributeData(e)):this._nodeLoader.loadAttributes(e,i,this._requiredAttributes);this._updatingNodes.set(e.id,o),o.then(function(i){return t.schedule(e.id).then(function(){return t.layerView.setAttributeData(e,{loadedAttributes:t._requiredAttributes,attributeData:i})})}).catch(function(i){i instanceof n||t.layerView.setAttributeData(e,{loadedAttributes:t._requiredAttributes,attributeData:{}})}).catch(function(){}).then(function(){t._updatingNodes.delete(e.id),t.updatingChanged()}),this.updatingChanged()},t.prototype._loadNode=function(e){var t=this;this._loadingNodes.add(e.id),this.updatingChanged(),this._loadAndAddBundle(e).catch(function(e){return e}).then(function(){t._loadingNodes.delete(e.id),t._hasFeatures=t._hasFeatures||!!e.numFeatures,t.updatingChanged()})},t.prototype._loadAndAddBundle=function(e){return 1!==e.featureData.length&&P.warn("Node ${node.id} has ${node.featureData.length} bundles. Only the first bundle will be loaded."),e.notInCache?this._loadUncached(e):this._loadCached(e).then(function(t){t||(e.notInCache=!0)}).catch(function(t){t instanceof n||(e.notInCache=!0)})},t.prototype._enableFromGPUCache=function(e){if(this.disableMemCache||!this.layerView.loadCachedGPUData||!this.layerView.addCachedGPUData)return!1;var t=this.layerView.loadCachedGPUData(e);return!!(t&&V(t.attributeInfo)&&F(t.attributeInfo.loadedAttributes,this._requiredAttributes))&&(this.layerView.addCachedGPUData(e,t),this._lodHandling.lodSwapBundleLoaded(e),!0)},t.prototype._loadCached=function(e){var t=this,i=this.layerView;return!this.disableIDBCache&&i.loadCachedNodeData&&i.addCachedNodeData?this.schedule(e.id).then(function(){return i.loadCachedNodeData(e,function(e,i){return t._nodeLoader.loadTextures(e,i)})}).then(function(r){if(null==r)return!1;var n=t._requiredAttributes;return V(r)&&F(r.loadedAttributes,n)?t.reschedule(e.id).then(function(){return i.addCachedNodeData(e,r,r)}).then(function(){return t._lodHandling.lodSwapBundleLoaded(e),!0}):t.reschedule(e.id).then(function(){return t._nodeLoader.loadAttributes(e,e.baseUrl,n)}).then(function(i){return t.reschedule(e.id,{loadedAttributes:n,attributeData:i})}).then(function(t){return i.addCachedNodeData(e,r,t)}).then(function(){return t._lodHandling.lodSwapBundleLoaded(e),!0})}):c.resolve(!1)},t.prototype._loadUncached=function(e){var t=this;return this._downloadingNodes.add(e.id),this._nodeLoader.loadBundleData(e,0).then(function(i){return t._downloadingNodes.delete(e.id),t.schedule(e.id,i)}).then(function(i){return t.layerView.addNodeData(e,i)}).then(function(){t._lodHandling.lodSwapBundleLoaded(e),e.notInCache=!1}).catch(function(t){t instanceof n||(P.error("Failed to load node '"+e.id+"' bundle 0: "+t),e.failed=!0)})},t.prototype._updateIdleState=function(e){e!==this._isIdle&&(this._isIdle=e,this._viewportQueries&&this._viewportQueries.setCameraIdle(!0),this.updatingChanged())},t.prototype.updateStats=function(e){e.index=Object.keys(this.nodeIndex).length,this._hasFeatures&&(e.detail=this._featureLOD,e.target=this.featureTarget*this.baseLOD),this._index&&this._index.updateStats(e)},r([f.property({readOnly:!0})],t.prototype,"isMeshPyramid",null),r([f.property({readOnly:!0})],t.prototype,"streamDataSupplier",null),r([f.property({readOnly:!0,dependsOn:["layer.definitionExpression"]})],t.prototype,"parsedDefinitionExpression",null),r([f.property({readOnly:!0,dependsOn:["parsedDefinitionExpression"]})],t.prototype,"definitionExpressionFields",null),r([f.property({readOnly:!0})],t.prototype,"crsVertex",null),r([f.property({readOnly:!0})],t.prototype,"crsIndex",null),r([f.property({readOnly:!0})],t.prototype,"nodeIndex",void 0),r([f.property()],t.prototype,"camPos",void 0),r([f.property()],t.prototype,"screenSizeFactor",void 0),r([f.property()],t.prototype,"featureTarget",void 0),r([f.property()],t.prototype,"fixedFeatureTarget",void 0),r([f.property()],t.prototype,"layerView",void 0),r([f.property()],t.prototype,"layer",void 0),r([f.property({readOnly:!0})],t.prototype,"updating",void 0),r([f.property({readOnly:!0})],t.prototype,"updatingPercentage",void 0),r([f.property({readOnly:!0})],t.prototype,"leafsReached",void 0),r([f.property({readOnly:!0})],t.prototype,"rootNodeVisible",null),r([f.property({aliasOf:"layerView.uncompressedTextureDownsamplingEnabled"})],t.prototype,"uncompressedTextureDownsamplingEnabled",void 0),r([f.property({aliasOf:"layerView.alwaysLoadEverythingModeEnabled"})],t.prototype,"alwaysLoadEverythingModeEnabled",void 0),t=r([f.subclass("esri.layers.graphics.controllers.I3SOnDemandController")],t)}(f.declared(o,p,s)),S=new h,A={factorIM:.2,factor3dObject:.05,distancePenalty:10};return E});