// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.10/esri/copyright.txt for details.

define(["require","exports","../../core/Error","../../core/Logger","./OptimizedFeature","./OptimizedFeatureSet","./OptimizedGeometry"],function(e,r,t,n,o,a,s){function u(e,r){var t=e.scale,n=e.translate;return Math.round((r-n[0])/t[0])}function i(e,r){var t=e.scale,n=e.translate;return Math.round((n[1]-r)/t[1])}function l(e,r){var t=e.scale,n=e.translate;return r*t[0]+n[0]}function h(e,r){var t=e.scale;return e.translate[1]-r*t[1]}function c(e,r,t){return e?r?t?I(e):d(e):t?v(e):g(e):null}function g(e){var r=e.coords;return{x:r[0],y:r[1]}}function f(e){var r=new s.default;return r.coords[0]=e.x,r.coords[1]=e.y,r}function d(e){var r=e.coords;return{x:r[0],y:r[1],z:r[2]}}function m(e){var r=new s.default;return r.coords[0]=e.x,r.coords[1]=e.y,r.coords[2]=e.z,r}function v(e){var r=e.coords;return{x:r[0],y:r[1],m:r[2]}}function y(e){var r=new s.default;return r.coords[0]=e.x,r.coords[1]=e.y,r.coords[2]=e.m,r}function I(e){var r=e.coords;return{x:r[0],y:r[1],z:r[2],m:r[3]}}function p(e){var r=new s.default;return r.coords[0]=e.x,r.coords[1]=e.y,r.coords[2]=e.z,r.coords[3]=e.m,r}function N(e,r,t,n){var o=g;t&&n?o=I:t?o=d:n&&(o=v);for(var a=0,s=r;a<s.length;a++){var u=s[a],i=u.geometry,l=u.attributes,h=i?o(i):null;e.push({attributes:l,geometry:h})}return e}function T(e,r,t,n,a){var s=f;t&&n?s=p:t?s=m:n&&(s=y);for(var u=0,i=r;u<i.length;u++){var l=i[u],h=l.geometry,c=l.attributes,g=h?s(h):void 0;e.push(new o.default(g,c,null,c[a]))}return e}function b(e,r,t,n){for(var o=0,a=r;o<a.length;o++){var s=a[o],u=s.geometry,i=s.attributes,l=void 0;u&&(l=F(u,t,n)),e.push({attributes:i,geometry:l})}return e}function F(e,r,t){if(!e)return null;for(var n=r?t?4:3:t?3:2,o=[],a=0;a<e.coords.length;a+=n){for(var s=[],u=0;u<n;u++)s.push(e.coords[a+u]);o.push(s)}return r?t?{points:o,hasZ:r,hasM:t}:{points:o,hasZ:r}:t?{points:o,hasM:t}:{points:o}}function M(e,r,t,n,a){for(var u=t?n?4:3:n?3:2,i=0,l=r;i<l.length;i++){var h=l[i],c=h.geometry,g=h.attributes,f=void 0;if(c){f=new s.default,f.lengths[0]=c.points.length;for(var d=f.coords,m=0,v=0,y=c.points;v<y.length;v++)for(var I=y[v],p=0;p<u;p++)d[m++]=I[p]}e.push(new o.default(f,g,null,g[a]))}return e}function G(e,r,t,n){for(var o=0,a=r;o<a.length;o++){var s=a[o],u=s.geometry,i=s.attributes,l=void 0;u&&(l=w(u,t,n)),e.push({attributes:i,geometry:l})}return e}function w(e,r,t){if(!e)return null;for(var n=r?t?4:3:t?3:2,o=e.coords,a=e.lengths,s=[],u=0,i=0,l=a;i<l.length;i++){for(var h=l[i],c=[],g=0;g<h;g++){for(var f=[],d=0;d<n;d++)f.push(o[u++]);c.push(f)}s.push(c)}return r?t?{paths:s,hasZ:r,hasM:t}:{paths:s,hasZ:r}:t?{paths:s,hasM:t}:{paths:s}}function E(e,r,t,n,a){for(var u=t?n?4:3:n?3:2,i=0,l=r;i<l.length;i++){var h=l[i],c=h.geometry,g=h.attributes,f=void 0;if(c){f=new s.default;for(var d=f.lengths,m=f.coords,v=0,y=0,I=c.paths;y<I.length;y++){for(var p=I[y],N=0,T=p;N<T.length;N++)for(var b=T[N],F=0;F<u;F++)m[v++]=b[F];d.push(p.length)}}e.push(new o.default(f,g,null,g[a]))}return e}function P(e,r,t,n){for(var o=0,a=r;o<a.length;o++){var s=a[o],u=s.geometry,i=s.attributes,l=s.centroid,h=void 0;if(u&&(h=z(u,t,n)),l){var c=g(l);e.push({attributes:i,centroid:c,geometry:h})}else e.push({attributes:i,geometry:h})}return e}function z(e,r,t){if(!e)return null;for(var n=r?t?4:3:t?3:2,o=e.coords,a=e.lengths,s=[],u=0,i=0,l=a;i<l.length;i++){for(var h=l[i],c=[],g=0;g<h;g++){for(var f=[],d=0;d<n;d++)f.push(o[u++]);c.push(f)}s.push(c)}return r?t?{rings:s,hasZ:r,hasM:t}:{rings:s,hasZ:r}:t?{rings:s,hasM:t}:{rings:s}}function O(e,r,t,n,a){for(var u=t?n?4:3:n?3:2,i=0,l=r;i<l.length;i++){var h=l[i],c=h.geometry,g=h.centroid,d=h.attributes,m=void 0;if(c){m=new s.default;for(var v=m.lengths,y=m.coords,I=0,p=0,N=c.rings;p<N.length;p++){for(var T=N[p],b=0,F=T;b<F.length;b++)for(var M=F[b],G=0;G<u;G++)y[I++]=M[G];v.push(T.length)}}g?e.push(new o.default(m,d,f(g),d[a])):e.push(new o.default(m,d,null,d[a]))}return e}function Y(e,r,t,n,o){se[0]=e;var a=_(ue,se,r,t,n,o)[0];return se.length=ue.length=0,a}function _(e,r,n,o,a,s){if(e.length=0,!n)return void(e.length=0);switch(n){case"esriGeometryPoint":return T(e,r,o,a,s);case"esriGeometryMultipoint":return M(e,r,o,a,s);case"esriGeometryPolyline":return E(e,r,o,a,s);case"esriGeometryPolygon":return O(e,r,o,a,s);default:re.error("convertToFeatureSet:unknown-geometry",new t("Unable to parse unknown geometry type '"+n+"'")),e.length=0}return e}function x(e,r,t,n){ue[0]=e,S(se,ue,r,t,n);var o=se[0];return se.length=ue.length=0,o}function V(e,r,n,o){if(!e||!e.geometry)return null;switch(r){case"esriGeometryPoint":var a=g;return n&&o?a=I:n?a=d:o&&(a=v),a(e.geometry);case"esriGeometryMultipoint":return F(e.geometry,n,o);case"esriGeometryPolyline":return w(e.geometry,n,o);case"esriGeometryPolygon":return z(e.geometry,n,o);default:re.error("convertToGeometry:unknown-geometry",new t("Unable to parse unknown geometry type '"+r+"'"))}}function S(e,r,n,o,a){switch(e.length=0,n){case"esriGeometryPoint":return N(e,r,o,a);case"esriGeometryMultipoint":return b(e,r,o,a);case"esriGeometryPolyline":return G(e,r,o,a);case"esriGeometryPolygon":return P(e,r,o,a);default:re.error("convertToFeatureSet:unknown-geometry",new t("Unable to parse unknown geometry type '"+n+"'"))}return e}function Z(e){var r=e.objectIdFieldName,t=e.spatialReference,n=e.transform,o=e.fields,a=e.hasM,s=e.hasZ,u=e.features,i=e.geometryType,l=e.exceededTransferLimit,h=S([],u,i,s,a),c={features:h,fields:o,geometryType:i,objectIdFieldName:r,spatialReference:t};return n&&(c.transform=n),l&&(c.exceededTransferLimit=l),a&&(c.hasM=a),s&&(c.hasZ=s),c}function j(e,r){var n=new a.default,o=e.hasM,s=e.hasZ,u=e.features,i=e.objectIdFieldName,l=e.spatialReference,h=e.geometryType,c=e.exceededTransferLimit,g=e.transform;return n.fields=e.fields,n.geometryType=h,n.objectIdFieldName=i||r,n.spatialReference=l,n.objectIdFieldName?(u&&_(n.features,u,h,s,o,n.objectIdFieldName),c&&(n.exceededTransferLimit=c),o&&(n.hasM=o),s&&(n.hasZ=s),g&&(n.transform=g),n):(re.error(new t("optimized-features:invalid-objectIdFieldName","objectIdFieldName is missing")),n)}function q(e){var r=e.transform,t=e.features,n=e.hasM,o=e.hasZ;if(!r)return e;for(var a=0,s=t;a<s.length;a++){var u=s[a];u.geometry&&X(u.geometry,u.geometry,n,o,r),u.centroid&&X(u.centroid,u.centroid,n,o,r)}return e.transform=null,e}function A(e,r){var t=r.geometryType,n=r.features,a=r.hasM,u=r.hasZ;if(!e)return r;for(var i=0;i<n.length;i++){var l=n[i],h=new o.default(new s.default,l.attributes);L(h.geometry,l.geometry,a,u,t,e),l.centroid&&(h.centroid=new s.default,L(h.centroid,l.centroid,a,u,"esriGeometryPoint",e)),n[i]=h}return r.transform=e,r}function L(e,r,t,n,o,a){if(e.lengths.length&&(e.lengths.length=0),e.coords.length&&(e.coords.length=0),!r||!r.coords.length)return null;var s=te[o],l=r.coords,h=r.lengths,c=t?n?4:3:n?3:2,g=t?n?ae:oe:n?oe:ne;if(!h.length)return g(e.coords,l,0,0,u(a,l[0]),i(a,l[1])),e.lengths.length&&(e.lengths.length=0),e.coords.length=c,e;for(var f,d,m,v,y=0,I=0,p=I,N=0,T=h;N<T.length;N++){var b=T[N];if(!(b<s)){var F=0;I=p,m=f=u(a,l[y]),v=d=i(a,l[y+1]),g(e.coords,l,I,y,m,v),F++,y+=c,I+=c;for(var M=1;M<b;M++,y+=c)m=u(a,l[y]),v=i(a,l[y+1]),m===f&&v===d||(g(e.coords,l,I,y,m-f,v-d),I+=c,F++,f=m,d=v);F>=s&&(e.lengths.push(F),p=I)}}return e.coords.length=p,e.coords.length?e:null}function k(e,r,t,n,o,a){if(e.lengths.length&&(e.lengths.length=0),e.coords.length&&(e.coords.length=0),!r||!r.coords.length)return null;var s=te[o],l=r.coords,h=r.lengths,c=t?n?4:3:n?3:2,g=t?n?ae:oe:n?oe:ne;if(!h.length)return g(e.coords,l,0,0,u(a,l[0]),i(a,l[1])),e.lengths.length&&(e.lengths.length=0),e.coords.length=c,e;for(var f,d,m,v,y=0,I=0,p=I,N=0,T=h;N<T.length;N++){var b=T[N];if(!(b<s)){var F=0;I=p,m=f=u(a,l[y]),v=d=i(a,l[y+1]),g(e.coords,l,I,y,m,v),F++,y+=c;for(var M=!1,G=0,w=0,E=1;E<b;E++,y+=c)if(m=u(a,l[y]),v=i(a,l[y+1]),m!==f||v!==d){var P=m-f,z=v-d;M&&(0===G&&0===P||0===w&&0===z)?(G+=P,w+=z,g(e.coords,l,I,y,G,w)):(M=!0,G=P,w=z,I+=c,F++,g(e.coords,l,I,y,G,w)),f=m,d=v}M&&(I+=c,g(e.coords,l,I,y,G,w)),F>=s&&(e.lengths.push(F),p=I)}}return e.coords.length!==p&&(e.coords.length=p),e.coords.length?e:null}function R(e,r,t,n,o,a){if(e.lengths.length&&(e.lengths.length=0),e.coords.length&&(e.coords.length=0),!r||!r.coords.length)return null;var s=te[o],u=r.coords,i=r.lengths,l=t?n?4:3:n?3:2,h=t?n?ae:oe:n?oe:ne;if(!i.length)return h(e.coords,u,0,0,u[0],u[1]),e.lengths.length&&(e.lengths.length=0),e.coords.length=l,e;for(var c=0,g=0,f=i;g<f.length;g++){var d=f[g];if(d<s)c+=d*l;else{var m=e.coords.length/l;C(e.coords,u,l,a,h,c,c+d*l);var v=e.coords.length/l-m;v>=s?e.lengths.push(v):e.coords.length=m*l,c+=d*l}}return e.coords.length?e:null}function D(e,r,t,n){var o=e[r],a=e[r+1],s=e[t],u=e[t+1],i=e[n],l=e[n+1];if(s===i)return Math.abs(o-s);var h=(l-u)/(i-s),c=u-h*s;return Math.abs(h*o-a+c)/Math.sqrt(h*h+1)}function C(e,r,t,n,o,a,s){for(var u,i=a,l=s-t,h=0,c=0,g=a+t;g<s-t;g+=t)(u=D(r,g,i,l))>h&&(c=g,h=u);h>n?(C(e,r,t,n,o,a,c+t),C(e,r,t,n,o,c,s)):(o(e,r,e.length,i,r[i],r[i+1]),o(e,r,e.length,l,r[l],r[l+1]))}function U(e,r,t,n){var o=t?n?4:3:n?3:2,a=Number.POSITIVE_INFINITY,s=Number.POSITIVE_INFINITY,u=Number.NEGATIVE_INFINITY,i=Number.NEGATIVE_INFINITY;if(r&&r.coords)for(var l=r.coords,h=0;h<l.length;h+=o){var c=l[h],g=l[h+1];a=Math.min(a,c),u=Math.max(u,c),s=Math.min(s,g),i=Math.max(i,g)}return e[0]=a,e[1]=s,e[2]=u,e[3]=i,e}function B(e,r,t,n){for(var o=t?n?4:3:n?3:2,a=r.lengths,s=r.coords,u=Number.POSITIVE_INFINITY,i=Number.POSITIVE_INFINITY,l=Number.NEGATIVE_INFINITY,h=Number.NEGATIVE_INFINITY,c=0,g=0,f=a;g<f.length;g++){var d=f[g],m=s[c],v=s[c+1];u=Math.min(m,u),i=Math.min(v,i),l=Math.max(m,l),h=Math.max(v,h),c+=o;for(var y=1;y<d;y++,c+=o){var I=s[c],p=s[c+1];m+=I,v+=p,I<0&&(u=Math.min(u,m)),I>0&&(l=Math.max(l,m)),p<0?i=Math.min(i,v):p>0&&(h=Math.max(h,v))}}return e[0]=u,e[1]=i,e[2]=l,e[3]=h,e}function X(e,r,t,n,o){var a=r.coords,s=r.lengths,u=t?n?ae:oe:n?oe:ne,i=t?n?4:3:n?3:2;if(!a.length)return e!==r&&(e.lengths.length=0,e.coords.length=0),e;if(!s.length)return u(e.coords,a,0,0,l(o,a[0]),h(o,a[1])),e!==r&&(e.lengths.length=0,e.coords.length=i),e;for(var c=o.scale,g=c[0],f=c[1],d=0,m=0;m<s.length;m++){var v=s[m];e.lengths[m]=v;var y=l(o,a[d]),I=h(o,a[d+1]);u(e.coords,a,d,d,y,I),d+=i;for(var p=1;p<v;p++,d+=i)y+=a[d]*g,I-=a[d+1]*f,u(e.coords,a,d,d,y,I)}return e!==r&&(e.lengths.length=s.length,e.coords.length=a.length),e}function Q(e,r,t,n){if(!r||!r.lengths.length)return null;e.lengths.length&&(e.lengths.length=0),e.coords.length&&(e.coords.length=0);for(var o=e.coords,a=[],s=t?[Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY]:[Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY],u=r.lengths,i=r.coords,l=t?n?4:3:n?3:2,h=0,c=0,g=u;c<g.length;c++){var f=g[c],d=H(s,i,h,f,t,n);d&&a.push(d),h+=f*l}if(a.sort(function(e,r){var n=e[2]-r[2];return 0===n&&t&&(n=e[4]-r[4]),n}),a.length){var m=6*a[0][2];o[0]=a[0][0]/m,o[1]=a[0][1]/m,t&&(m=6*a[0][4],o[2]=0!==m?a[0][3]/m:0),(o[0]<s[0]||o[0]>s[1]||o[1]<s[2]||o[1]>s[3]||t&&(o[2]<s[4]||o[2]>s[5]))&&(o.length=0)}if(!o.length){var v=r.lengths[0]?J(i,0,u[0],t,n):null;if(!v)return null;o[0]=v[0],o[1]=v[1],t&&v.length>2&&(o[2]=v[2])}return e}function H(e,r,t,n,o,a){for(var s=o?a?4:3:a?3:2,u=t,i=t+s,l=0,h=0,c=0,g=0,f=0,d=0,m=n-1;d<m;d++,u+=s,i+=s){var v=r[u],y=r[u+1],I=r[u+2],p=r[i],N=r[i+1],T=r[i+2],b=v*N-p*y;g+=b,l+=(v+p)*b,h+=(y+N)*b,o&&(b=v*T-p*I,c+=(I+T)*b,f+=b),v<e[0]&&(e[0]=v),v>e[1]&&(e[1]=v),y<e[2]&&(e[2]=y),y>e[3]&&(e[3]=y),o&&(I<e[4]&&(e[4]=I),I>e[5]&&(e[5]=I))}if(g>0&&(g*=-1),f>0&&(f*=-1),!g)return null;var F=[l,h,.5*g];return o&&(F[3]=c,F[4]=.5*f),F}function J(e,r,t,n,o){for(var a=n?o?4:3:o?3:2,s=r,u=r+a,i=0,l=0,h=0,c=0,g=0,f=t-1;g<f;g++,s+=a,u+=a){var d=e[s],m=e[s+1],v=e[s+2],y=e[u],I=e[u+1],p=e[u+2],N=n?W(d,m,v,y,I,p):K(d,m,y,I);if(N)if(i+=N,n){var T=ee(d,m,v,y,I,p);l+=N*T[0],h+=N*T[1],c+=N*T[2]}else{var T=$(d,m,y,I);l+=N*T[0],h+=N*T[1]}}return i>0?n?[l/i,h/i,c/i]:[l/i,h/i]:t>0?n?[e[r],e[r+1],e[r+2]]:[e[r],e[r+1]]:null}function K(e,r,t,n){var o=t-e,a=n-r;return Math.sqrt(o*o+a*a)}function W(e,r,t,n,o,a){var s=n-e,u=o-r,i=a-t;return Math.sqrt(s*s+u*u+i*i)}function $(e,r,t,n){return[e+.5*(t-e),r+.5*(n-r)]}function ee(e,r,t,n,o,a){return[e+.5*(n-e),r+.5*(o-r),t+.5*(a-t)]}Object.defineProperty(r,"__esModule",{value:!0});var re=n.getLogger("esri.tasks.support.optimizedFeatureSet"),te={esriGeometryPoint:0,esriGeometryPolyline:2,esriGeometryPolygon:3,esriGeometryMultipoint:0},ne=function(e,r,t,n,o,a){e[t]=o,e[t+1]=a},oe=function(e,r,t,n,o,a){e[t]=o,e[t+1]=a,e[t+2]=r[n+2]},ae=function(e,r,t,n,o,a){e[t]=o,e[t+1]=a,e[t+2]=r[n+2],e[t+3]=r[n+3]};r.quantizeX=u,r.quantizeY=i,r.hydrateX=l,r.hydrateY=h,r.convertToPoint=c,r.convertToMultipoint=F,r.convertToPolyline=w,r.convertToPolygon=z;var se=[],ue=[];r.convertFromFeature=Y,r.convertFromFeatures=_,r.convertToFeature=x,r.convertToGeometry=V,r.convertToFeatures=S,r.convertToFeatureSet=Z,r.convertFromFeatureSet=j,r.hydrateOptimizedFeatureSet=q,r.quantizeOptimizedFeatureSet=A,r.quantizeOptimizedGeometry=L,r.quantizeOptimizedGeometryRemoveCollinear=k,r.generalizeOptimizedGeometry=R,r.getBoundsOptimizedGeometry=U,r.getQuantizedBoundsOptimizedGeometry=B,r.hydrateOptimizedGeometry=X,r.getCentroidOptimizedGeometry=Q,r.lineCentroid=J,r.getLength2D=K,r.getLength3D=W,r.getMidpoint2D=$,r.getMidpoint3D=ee});