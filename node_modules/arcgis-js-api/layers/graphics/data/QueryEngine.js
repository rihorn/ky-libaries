// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.10/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/assignHelper","@dojo/framework/shim/Map","@dojo/framework/shim/Set","../../../geometry","../../../core/Error","../../../core/Logger","../../../core/MemCache","../../../core/promiseUtils","../../../geometry/projection","../../../geometry/support/aaBoundingRect","../../../geometry/support/normalizeUtils","../../../geometry/support/scaleUtils","../../../geometry/support/spatialReferenceUtils","./attributeSupport","./projectionSupport","./QueryEngineCapabilities","./QueryEngineResult","./spatialQuerySupport","./utils","../../../tasks/support/Query"],function(e,t,r,i,n,o,u,a,s,c,l,p,f,h,y,d,m,g,x,v,S,I){function Q(e){return e?JSON.parse(JSON.stringify(e,["latestWkid","wkid","wkt"])):e}function b(e,t,r,i,n,o,u,a){u&&!o?i.forEachFeatureInBounds(n,function(t){var i=S.getCentroid(r,t,a),n=t.attributes;i&&e.push(new _(n,null,i))}):o&&!u?i.forEachFeatureInBounds(n,function(i){var n=i.attributes,o=S.getGeometry(r,i,0,a);o&&(t.add(i.objectId),e.push(new _(n,o)))}):i.forEachFeatureInBounds(n,function(i){var n=i.attributes,o=S.getGeometry(r,i,0,a),u=S.getCentroid(r,i,a);o&&u&&(t.add(i.objectId),e.push(new _(n,o,u)))})}Object.defineProperty(t,"__esModule",{value:!0});var F=a.getLogger("esri.layers.graphics.data.QueryEngine"),_=function(){function e(e,t,r){this.attributes=e,this.geometry=t,this.centroid=r}return e}(),R={},w=new n.default,j=new s.Storage(2e6),E=0,C=function(){function e(e){var t=this;this.capabilities={query:g.queryCapabilities},this.fieldsMap=new i.default,this.geometryType=e.geometryType,this.hasM=e.hasM,this.hasZ=e.hasZ,this.objectIdField=e.objectIdField,this.spatialReference=e.spatialReference,this.definitionExpression=e.definitionExpression,this.cacheSpatialQueries=e.cacheSpatialQueries||!1,this.gdbVersion=e.gdbVersion,this.historicMoment=e.historicMoment,this.spatialIndex=e.spatialIndex,this.spatialIndex.setEngine(this),this.timeInfo=e.timeInfo,this.cacheSpatialQueries&&(this._geometryQueryCache=new s(E+++"$$",j)),e.fields.forEach(function(e){t.fieldsMap.set(e.name.trim(),e),t.fieldsMap.set(e.name.trim().toLowerCase(),e)})}return e.prototype.destroy=function(){this.clearCache(),this._geometryQueryCache&&this._geometryQueryCache.destroy(),this.fieldsMap.clear()},Object.defineProperty(e.prototype,"fullExtent",{get:function(){var e=this.spatialIndex.fullBounds;return e?{xmin:e[0],ymin:e[1],xmax:e[2],ymax:e[3],spatialReference:Q(this.spatialReference)}:null},enumerable:!0,configurable:!0}),e.prototype.clearCache=function(){this._geometryQueryCache&&this._geometryQueryCache.clear(),this._allItems=null},e.prototype.executeQuery=function(e){var t=this;void 0===e&&(e=new I);var r=e.clone();return this._normalizeQuery(r).then(function(e){return t._checkQuerySupport(e)}).then(function(e){return t._executeGeometryQuery(e)}).then(function(e){return e.executeObjectIdsQuery(r)}).then(function(e){return e.executeAttributesQuery(r)}).catch(function(e){if(e===R)return new x.default([],t);throw e}).then(function(e){return e.createQueryResponse(r)})},e.prototype.executeQueryForCount=function(e){var t=this;void 0===e&&(e=new I);var r=e.clone();return r.returnGeometry=!1,r.returnCentroid=!1,r.outSpatialReference=null,this._normalizeQuery(r).then(function(e){return t._checkQuerySupport(e)}).then(function(e){return t._executeGeometryQuery(e)}).then(function(e){return e.executeObjectIdsQuery(r)}).then(function(e){return e.executeAttributesQuery(r)}).then(function(e){return e.size}).catch(function(e){if(e===R)return 0;throw e})},e.prototype.executeQueryForExtent=function(e){var t=this;void 0===e&&(e=new I);var r=e.clone(),i=r.outSpatialReference;return this._normalizeQuery(r).then(function(e){return t._checkQuerySupport(e)}).then(function(){return r.returnGeometry=!0,r.returnCentroid=!1,r.outSpatialReference=null,r}).then(function(e){return t._executeGeometryQuery(e)}).then(function(e){return e.executeObjectIdsQuery(r)}).then(function(e){return e.executeAttributesQuery(r)}).then(function(e){var r=e.size;if(!r)return{count:r,extent:null};var n={xmin:Number.POSITIVE_INFINITY,ymin:Number.POSITIVE_INFINITY,xmax:Number.NEGATIVE_INFINITY,ymax:Number.NEGATIVE_INFINITY,spatialReference:Q(t.spatialReference)};t.spatialIndex.forEachBounds(e.items,function(e){n.xmin=Math.min(e[0],n.xmin),n.ymin=Math.min(e[1],n.ymin),n.xmax=Math.max(e[2],n.xmax),n.ymax=Math.max(e[3],n.ymax)});var o=m.project(n,e.spatialReference,i);if(o.spatialReference=Q(i&&i.toJSON()||t.spatialReference),o.xmax-o.xmin==0){var u=h.getMetersPerUnitForSR(o.spatialReference);o.xmin-=u,o.xmax+=u}if(o.ymax-o.ymin==0){var u=h.getMetersPerUnitForSR(o.spatialReference);o.ymin-=u,o.ymax+=u}return{count:r,extent:o}}).catch(function(e){if(e===R)return{count:0,extent:null};throw e})},e.prototype.executeQueryForIds=function(e){var t=this;void 0===e&&(e=new I);var r=e.clone();return r.returnGeometry=!1,r.returnCentroid=!1,r.outSpatialReference=null,this._normalizeQuery(r).then(function(e){return t._checkQuerySupport(e)}).then(function(e){return t._executeGeometryQuery(e)}).then(function(e){return e.executeObjectIdsQuery(r)}).then(function(e){return e.executeAttributesQuery(r)}).then(function(e){for(var t=e.items,r=[],i=0;i<t.length;i++)r[i]=t[i].objectId;return r}).catch(function(e){if(e===R)return[];throw e})},e.prototype.executeTileQuery=function(e,t){var r=this,i=t.returnGeometry,o=t.returnCentroid,u=t.pixelBuffer,a=new n.default,s=[],c=u*e.resolution,l=p.pad(e.bounds,c,p.create());if(b(s,a,this,this.spatialIndex,l,i,o,{originPosition:"upperLeft",scale:[e.resolution,e.resolution],translate:[e.bounds[0],e.bounds[3]]}),"esriGeometryPoint"===this.geometryType||o){var f=y.getInfo(this.spatialReference);if(f){var h=f.valid,d=h[0],m=h[1];if(l[0]<d){var g=p.fromValues(m-c,l[1],m,l[3]);b(s,a,this,this.spatialIndex,g,i,o,{originPosition:"upperLeft",scale:[e.resolution,e.resolution],translate:[m,e.bounds[3]]})}if(l[2]>m){var x=p.fromValues(d,l[1],d+c,l[3]);b(s,a,this,this.spatialIndex,x,i,o,{originPosition:"upperLeft",scale:[e.resolution,e.resolution],translate:[d-m+e.bounds[0],e.bounds[3]]})}}}return s.sort(function(e,t){return e.attributes[r.objectIdField]-t.attributes[r.objectIdField]}),{features:s,objectIds:a}},e.prototype.executeTileQueryForIds=function(e,t){var r=t.pixelBuffer,i=r*e.resolution,n=p.pad(e.bounds,i,p.create()),o=[];return this.spatialIndex.forEachFeatureInBounds(n,function(e){return o.push(e.objectId)}),o},e.prototype.executeQueryForLatestObservations=function(e){var t=this;return this.timeInfo?this.executeQuery(e).then(function(e){return t._filterLatest(e,t.timeInfo)}):void F.error(new u("invalid-query","Unable to make time-based query as the underlying service does include TimeInfo"))},e.prototype._filterLatest=function(e,t){for(var n=t.trackIdField,o=t.startTimeField,u=t.endTimeField,a=u||o,s=new i.default,c=[],l=0,p=e.features;l<p.length;l++){var f=p[l],h=f.attributes[n],y=f.attributes[a];(!s.has(h)||s.get(h).attributes[a]<y)&&s.set(h,f)}return s.forEach(function(e){return c.push(e)}),r({},e,{features:c})},e.prototype._getAll=function(){if(!this._allItems){var e=[];this.spatialIndex.forEachFeature(function(t){return e.push(t)}),this._allItems=new x.default(e,this)}return this._allItems},e.prototype._normalizeQuery=function(e){var t=this,r=this.definitionExpression,i=e.where,n=e.geometry,o=e.outFields,u=e.orderByFields,a=e.groupByFieldsForStatistics,s=e.outStatistics;if(e.where=i=i&&i.trim(),(!i||/^1 *= *1$/.test(i)||r&&r===i)&&(e.where=null),o)for(var l=0;l<o.length;l++)o[l]=o[l].trim();if(u)for(var l=0;l<u.length;l++)u[l]=u[l].trim();if(a)for(var l=0;l<a.length;l++)a[l]=a[l].trim();if(s)for(var l=0;l<s.length;l++)s[l].onStatisticField&&(s[l].onStatisticField=s[l].onStatisticField.trim());return n?(e.outSpatialReference||(e.outSpatialReference=n.spatialReference),this._getInputGeometry(e).then(function(t){return e.geometry=t}).then(function(e){return m.checkProjectionSupport(e.spatialReference,t.spatialReference)}).then(function(){return f.normalizeCentralMeridian(e.geometry)}).then(function(e){return m.project(e[0].toJSON(),e[0].spatialReference,t.spatialReference)}).then(function(r){if(!r)throw R;return r.spatialReference=t.spatialReference,e.read({geometry:r})})):c.resolve(e)},e.prototype._executeGeometryQuery=function(e){var t=this,r=e.geometry,i=e.outSpatialReference,n=e.spatialRelationship,o=y.isValid(i)&&!y.equals(this.spatialReference,i),u=o?JSON.stringify({geometry:r,spatialRelationship:n,outSpatialReference:i}):JSON.stringify({geometry:r,spatialRelationship:n});if(this.cacheSpatialQueries){var a=this._geometryQueryCache.get(u);if(void 0!==a)return c.resolve(a)}var s=null;if(r){var l=this._searchSpatialIndex(this._getQueryBBoxes(r));if(!l.length){var p=new x.default([],this);return this.cacheSpatialQueries&&this._geometryQueryCache.put(u,p,p.size||1),c.resolve(p)}s="envelope-intersects"===e.spatialRelationship||"esriGeometryPoint"===this.geometryType&&v.canQueryWithRBush(r)?c.resolve(new x.default(l,this)):v.getSpatialQueryOperator(n,r,this.geometryType).then(function(e){if(e){var r=l.filter(function(r){return e(S.getGeometry(t,r))});return new x.default(r,t)}})}else s=c.resolve(this._getAll());return s.then(function(r){return o&&(e.returnGeometry||e.returnCentroid)?r.project(i).then(function(e){return t.cacheSpatialQueries&&t._geometryQueryCache.put(u,e,e.size||1),e}):(t.cacheSpatialQueries&&t._geometryQueryCache.put(u,r,r.size||1),r)})},e.prototype._getInputGeometry=function(e){var t=e.geometry,r=e.distance,i=e.units;if(null==r)return c.resolve(t);var n=t.spatialReference,u=i||h.getUnitString(n),a=n&&(n.isGeographic||n.isWebMercator),s=null;return s=a?c.resolve(t):m.checkProjectionSupport(n,o.SpatialReference.WGS84).then(function(){return l.project(t,o.SpatialReference.WGS84)}),s.then(function(e){return v.getGeodesicBufferOperator().then(function(t){return t(e,r,u)})})},e.prototype._getQueryBBoxes=function(e){if("point"===e.type)return[p.fromValues(e.x,e.y,e.x,e.y)];var t=v.canQueryWithRBush(e)?e:e.extent;switch(t.type){case"extent":return[p.fromExtent(t)];case"polygon":return t.rings.map(function(e){return p.fromValues(e[0][0],e[0][1],e[2][0],e[2][1])})}},e.prototype._searchSpatialIndex=function(e){for(var t=[],r=0,i=e;r<i.length;r++){var n=i[r];this.spatialIndex.forEachFeatureInBounds(n,function(e){w.has(e)||(t.push(e),w.add(e))})}return w.clear(),t},e.prototype._checkQuerySupport=function(e){return e.distance<0||null!=e.geometryPrecision||e.multipatchOption||e.pixelSize||e.relationParameter||e.text||e.timeExtent?c.reject(new u("feature-store:unsupported-query","Unsupported query options",{query:e})):c.all([this._checkAttributesQuerySupport(e),this._checkStatisticsQuerySupport(e),v.checkSpatialQuerySupport(e,this.geometryType,this.spatialReference),m.checkProjectionSupport(this.spatialReference,e.outSpatialReference)]).then(function(){return e})},e.prototype._checkAttributesQuerySupport=function(e){var t=e.outFields,r=e.orderByFields,i=e.returnDistinctValues;if(r&&r.length>0){var n=r.map(function(e){return e.indexOf(" ASC")>-1?e.split(" ASC")[0]:e.indexOf(" DESC")>-1?e.split(" DESC")[0]:e});d.validateFields(this.fieldsMap,n,"orderByFields contains missing fields")}if(t&&t.length>0)d.validateFields(this.fieldsMap,t,"outFields contains missing fields");else if(i)throw new u("feature-store:unsupported-query","outFields should be specified for returnDistinctValues",{query:e});d.validateWhere(this.fieldsMap,e.where)},e.prototype._checkStatisticsQuerySupport=function(e){var t=e.outStatistics,r=e.groupByFieldsForStatistics,i=e.having,n=r&&r.length,o=t&&t.length;if(i){if(!n||!o)return c.reject(new u("feature-store:unsupported-query","outStatistics and groupByFieldsForStatistics should be specified with having",{query:e}));d.validateHaving(this.fieldsMap,i,t)}if(o){if(t.some(function(e){return"exceedslimit"===e.statisticType}))return;var a=t.map(function(e){return e.onStatisticField});d.validateFields(this.fieldsMap,a,"onStatisticFields contains missing fields"),n&&d.validateFields(this.fieldsMap,r,"groupByFieldsForStatistics contains missing fields");for(var s=0,l=t;s<l.length;s++){var p=l[s],f=p.onStatisticField,h=p.statisticType;if("exceedslimit"===h)return c.reject(new u("feature-store:unsupported-query","statistic type exceedslimit is not supported",{definition:p,query:e}));if((!n||"count"!==h)&&f&&d.hasInvalidFieldType(f,this.fieldsMap))return c.reject(new u("feature-store:unsupported-query","outStatistics contains non-numeric fields",{definition:p,query:e}))}}},e}();t.default=C});