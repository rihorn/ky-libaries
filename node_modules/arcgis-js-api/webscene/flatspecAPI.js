// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.10/esri/copyright.txt for details.

define(["require","exports","../core/tsSupport/generatorHelper","../core/tsSupport/awaiterHelper","../Basemap","../Ground","../WebScene","../core/compilerUtils","../core/JSONSupport","../core/MultiOriginJSONSupport","../core/accessorSupport/ensureType","../core/accessorSupport/extensions/serializableProperty/type","../layers/GroupLayer","../layers/mixins/OperationalLayer"],function(e,t,n,r,a,u,s,o,i,p,l,c,y,h){function f(e){return r(this,void 0,void 0,function(){var t,r;return n(this,function(n){switch(n.label){case 0:return t=new D,[4,j({typeName:"json",type:e},t)];case 1:return n.sent(),r=t.flatProperties,r.sort(function(e,t){return e.path.localeCompare(t.path)}),[2,r]}})})}function d(e){return r(this,void 0,void 0,function(){var t;return n(this,function(n){switch(n.label){case 0:return t=new D({classPaths:{},cacheEnabled:!1}),[4,j({typeName:"json",type:e},t)];case 1:return n.sent(),[2,t.classPaths]}})})}function v(e,t){return r(this,void 0,void 0,function(){var r;return n(this,function(n){switch(n.label){case 0:switch(r=e.typeName){case"array":return[3,1];case"union":return[3,3];case"json":return[3,5];case"native":return[3,7];case"enum":return[3,9]}return[3,11];case 1:return[4,P(e,t)];case 2:return n.sent(),[3,12];case 3:return[4,S(e,t)];case 4:return n.sent(),[3,12];case 5:return[4,j(e,t)];case 6:return n.sent(),[3,12];case 7:return[4,b(e,t)];case 8:return n.sent(),[3,12];case 9:return[4,g(e,t)];case 10:return n.sent(),[3,12];case 11:o.neverReached(e),n.label=12;case 12:return[2]}})})}function b(e,t){return r(this,void 0,void 0,function(){return n(this,function(n){return t.addProperty({path:t.pathString,type:M(e),default:e.default}),[2]})})}function m(e){var t=e.slice();return t.sort(),t}function g(e,t){return r(this,void 0,void 0,function(){var r;return n(this,function(n){return r=e.values.slice(),e.nullable&&r.push(null),t.addProperty({path:t.pathString,type:M(e),enum:m(r).map(function(e){return"string"==typeof e?'"'+e+'"':""+e}).join("|"),default:e.default}),[2]})})}function P(e,t){return r(this,void 0,void 0,function(){return n(this,function(n){switch(n.label){case 0:return t.pushPath(t.popPath()+"[]"),[4,v(e.elementType,t)];case 1:return n.sent(),[2]}})})}function w(e){return z[e]||e}function S(e,t){return r(this,void 0,void 0,function(){var r,a,u,s,o,i,p;return n(this,function(n){switch(n.label){case 0:r=t.pathString,a=t.popPath(),u=[],s=0,o=e.types,n.label=1;case 1:return s<o.length?(i=o[s],"native"!==i.type.typeName?[3,2]:(u.push(i.type),[3,4])):[3,5];case 2:return t.pushPath(a+"<"+w(i.value)+">"),[4,v(i.type,t)];case 3:n.sent(),t.popPath(),n.label=4;case 4:return s++,[3,1];case 5:return u.length&&(p=u.map(M),e.nullable&&p.push("null"),p.sort(),t.addProperty({type:p.join("|"),path:r,default:e.default})),t.pushPath(a),[2]}})})}function N(e,t,o){return r(this,void 0,void 0,function(){return n(this,function(n){switch(n.label){case 0:return e.type!==s||"layers"!==t?[3,2]:[4,T("web-scene/operational-layers")];case 1:return[2,n.sent()];case 2:return e.type!==a||"baseLayers"!==t?[3,4]:[4,T("web-scene/basemap")];case 3:return[2,n.sent()];case 4:return e.type!==u||"layers"!==t?[3,6]:[4,T("web-scene/ground")];case 5:return[2,n.sent()];case 6:return e.type!==y||"layers"!==t?[3,8]:[4,T("web-scene/operational-layers",function(e){return e!==y})];case 7:return[2,n.sent()];case 8:return[2,O(o)]}})})}function j(e,t){return r(this,void 0,void 0,function(){var r,a,u,s,o,i,p,l,c,y,h,f,d,v,b,m,g,P,w,S;return n(this,function(n){switch(n.label){case 0:if(r=e.type.__accessorMetadata__,a=e.type.prototype.declaredClass.replace(/\./g,"/"),u=r&&r.properties,a&&t.classPaths&&(t.classPaths[t.pathString]=a),!u)return t.addProperty({path:t.pathString,type:"unknown"}),[2];if(s=t.seen.get(e.type)){for(o=0,i=s;o<i.length;o++)p=i[o],t.pushPath(p.path),t.addProperty({path:t.pathString,type:p.type,default:p.default}),t.popPath();return[2]}l=t.flatProperties.length,c=t.pathString,y=[];for(h in u)y.push(h);f=0,n.label=1;case 1:return f<y.length?(d=y[f],v=u[d],(b=q(v))&&b.enabled?(m=b.target,"string"!=typeof m&&null!=m?[3,4]:[4,N(e,d,v)]):[3,6]):[3,7];case 2:return g=n.sent(),g?[4,k(g,"string"==typeof m?m:d,t)]:[3,6];case 3:return n.sent(),[3,6];case 4:return[4,C(m,t)];case 5:n.sent(),n.label=6;case 6:return f++,[3,1];case 7:if(t.flatProperties.length===l)return t.addProperty({path:t.pathString,type:"unknown"}),[2];for(P=[],w=l;w<t.flatProperties.length;w++)S=t.flatProperties[w],P.push({path:S.path.slice(c.length+1),type:S.type,default:S.default});return t.addSeen(e.type,P),[2]}})})}function k(e,t,a){return r(this,void 0,void 0,function(){return n(this,function(n){switch(n.label){case 0:return a.pushPath(t),[4,v(e,a)];case 1:return n.sent(),a.popPath(),[2]}})})}function C(e,t){return r(this,void 0,void 0,function(){var r,a,u;return n(this,function(n){for(r in e)a=e[r],u=void 0,u=a.types?R(a.types):A(a.type),u.default=a.default,k(u,r,t);return[2]})})}function T(e,t){return r(this,void 0,void 0,function(){var r,a,u,s,o,i,p,l;return n(this,function(n){switch(n.label){case 0:r=h.supportedTypes[e],a={typeName:"union",key:"layerType",types:[]},u=[];for(s in r)u.push(s);o=0,n.label=1;case 1:return o<u.length?(i=u[o],[4,h.typeModuleMap[i]()]):[3,4];case 2:if(!(p=n.sent()))return[3,3];if(t&&!t(p))return[3,3];a.types.push({type:{typeName:"json",type:p},value:i}),n.label=3;case 3:return o++,[3,1];case 4:return 0===a.types.length?[2,null]:(l={typeName:"array",elementType:1===a.types.length?a.types[0].type:a},[2,l])}})})}function M(e){switch(e.typeName){case"array":return M(e.elementType)+"[]";case"union":var t=e.types.map(function(e){return M(e.type)});return e.nullable&&t.push("null"),""+t.join(" | ");case"native":switch(e.type){case Number:return"number";case l.Integer:return"integer";case String:return"string";case Boolean:return"boolean";default:return"unknown"}case"json":return e.type.prototype.declaredClass;case"enum":return"string";default:o.neverReached(e)}}function x(e){var t=e.prototype.itemType&&e.prototype.itemType.Type;if(!t)return{typeName:"array",elementType:{typeName:"native",type:null}};if("function"==typeof t)return{typeName:"array",elementType:A(t)};if(t.typeMap){var n=[];for(var r in t.typeMap){var a=t.typeMap[r];n.push({type:A(a),value:I(a)?null:r})}return{typeName:"array",elementType:{typeName:"union",key:"string"==typeof t.key?t.key:"type",types:n}}}}function O(e){return e.types?R(e.types):_(e)}function R(e){if(Array.isArray(e))return{typeName:"array",elementType:R(e[0])};var t=[];for(var n in e.typeMap){var r=e.typeMap[n];t.push({type:A(r),value:I(r)?null:n})}return 1===t.length?t[0].type:{typeName:"union",key:"string"==typeof e.key?e.key:"type",types:t}}function _(e){var t=L(e),n=q(e),r=t&&t.type,a=A(r||e.type);return t&&void 0!==t.default&&"function"!=typeof t.default&&(a.default=t.default),n.allowNull&&(a.nullable=!0),a}function A(e){return e?Array.isArray(e)?"string"==typeof e[0]||"number"==typeof e[0]?{typeName:"enum",values:e}:e.length>1?{typeName:"union",key:null,types:e.map(function(e){return{type:A(e),value:null}})}:{typeName:"array",elementType:A(e[0])}:c.isCollection(e)?x(e):I(e)?{typeName:"native",type:e}:B(e)?{typeName:"json",type:e}:{typeName:"native",type:null}:{typeName:"native",type:null}}function B(e){var t=e._meta&&e._meta.bases;return!!t&&(-1!==t.indexOf(i)||-1!==t.indexOf(p))}function I(e){return e===String||e===Boolean||e===Number||e===l.Integer}function L(e){if(!e.json)return null;var t=e.json.origins,n=e.json,r=t&&t["web-scene"],a=t&&t["web-document"];return r||a||n||null}function q(e){if(!e.json)return null;var t=e.json.origins,n=e.json.write,r=t&&t["web-scene"]&&t["web-scene"].write,a=t&&t["web-document"]&&t["web-document"].write;return r||a||n||null}Object.defineProperty(t,"__esModule",{value:!0}),t.scan=f,t.collectClassPaths=d;var z={"unique-value":"uniqueValue","class-breaks":"classBreaks","point-3d":"PointSymbol3D","line-3d":"LineSymbol3D","mesh-3d":"MeshSymbol3D","polygon-3d":"PolygonSymbol3D","label-3d":"LabelSymbol3D","web-style":"styleSymbolReference",text:"Text",object:"Object",icon:"Icon",fill:"Fill",extrude:"Extrude",line:"Line",path:"Path","point-cloud-class-breaks":"pointCloudClassBreaksRenderer","point-cloud-rgb":"pointCloudRGBRenderer","point-cloud-stretch":"pointCloudStretchRenderer","point-cloud-unique-value":"pointCloudUniqueValueRenderer","fixed-size":"pointCloudFixedSizeAlgorithm",splat:"pointCloudSplatAlgorithm",bitfield:"pointCloudBitfieldFilter",return:"pointCloudReturnFilter",value:"pointCloudValueFilter","stay-above":"stayAbove",color:"colorInfo",opacity:"transparencyInfo",size:"sizeInfo",rotation:"rotationInfo"},D=function(){function e(e){this.flatProperties=[],this.path=[],this.seen=new Map,e&&e.classPaths&&(this.classPaths=e.classPaths),this.cacheEnabled=!(!e||!e.cacheEnabled)}return e.prototype.addProperty=function(e){this.flatProperties.push(e)},e.prototype.addSeen=function(e,t){this.cacheEnabled&&this.seen.set(e,t)},e.prototype.pushPath=function(e){this.path.push(e)},e.prototype.popPath=function(){return this.path.pop()},Object.defineProperty(e.prototype,"pathString",{get:function(){return this.path.join(".")},enumerable:!0,configurable:!0}),e}()});