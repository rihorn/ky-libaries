// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.10/esri/copyright.txt for details.

define(["require","exports","../../../core/libs/gl-matrix-2/gl-matrix","../GeometryUtils","./rendererUtils","../../webgl/VertexArrayObject"],function(t,e,r,i,o,a){return function(){function t(t){this._viewProjMat=r.mat4f32.create(),this._offsetVector=r.vec3f32.create(),this._patternMatrix=r.mat3f32.create(),this._color=r.vec4f32.create(),this._outlineColor=r.vec4f32.create(),this._initialized=!1,this._fillProgramOptions={id:!1,dd:!1,pattern:!1},this._outlineProgramOptions={id:!1,dd:!1},this._programCache=t}return t.prototype.dispose=function(){},t.prototype.render=function(t,e,a,n,l,s,f,u,_,m,h){if(0!==e.triangleElementCount){this._initialized||this._initialize(t);var c=f.getPaintValue("fill-pattern",a),d=void 0!==c,p=f.hasDataDrivenColor?[1,1,1,1]:f.getPaintValue("fill-color",a),g=f.hasDataDrivenOpacity?1:f.getPaintValue("fill-opacity",a),v=g*p[3]*h;this._color[0]=v*p[0],this._color[1]=v*p[1],this._color[2]=v*p[2],this._color[3]=v;var y,x=3===l;x&&(y=o.int32To4Bytes(e.layerID));var V=s.tileTransform.transform,D=s.coordRange/512,b=f.getPaintValue("fill-translate",a);if(0!==b[0]||0!==b[1]){r.mat4.copy(this._viewProjMat,s.tileTransform.transform);var A=b[0],O=b[1],P=0,C=0,M=(1<<s.key.level)/Math.pow(2,a)*D;if(1===f.getPaintValue("fill-translate-anchor",a)){var j=-i.C_DEG_TO_RAD*n,z=Math.sin(j),U=Math.cos(j);P=M*(A*U-O*z),C=M*(A*z+O*U)}else P=M*A,C=M*O;this._offsetVector[0]=P,this._offsetVector[1]=C,this._offsetVector[2]=0,r.mat4.translate(this._viewProjMat,this._viewProjMat,this._offsetVector),V=this._viewProjMat}this._drawFill(t,e,a,l,s,f,u,V,m,h,x,y);if(f.getPaintValue("fill-antialias",a)&&!d&&e.outlineElementCount>0&&(1===l||3===l)){var w=f.hasDataDrivenOutline;if(f.outlineUsesFillColor){if(1!==this._color[3])return;this._outlineColor[0]=this._color[0],this._outlineColor[1]=this._color[1],this._outlineColor[2]=this._color[2],this._outlineColor[3]=this._color[3]}else{var B=f.hasDataDrivenOutlineColor?[1,1,1,1]:f.getPaintValue("fill-outline-color",a),E=g*B[3]*h;this._outlineColor[0]=E*B[0],this._outlineColor[1]=E*B[1],this._outlineColor[2]=E*B[2],this._outlineColor[3]=E}var F=.75/m,I=this._getOutlineVAO(t,s,w);if(I){t.bindVAO(I);var T=(x?1:0)<<1|(w?1:0),R=this._outlineProgramOptions;R.id=x,R.dd=w;var k=this._programCache.getProgram(2,T,R);t.bindProgram(k),k.setUniformMatrix4fv("u_transformMatrix",V),k.setUniformMatrix4fv("u_extrudeMatrix",_),k.setUniform2fv("u_normalized_origin",s.tileTransform.displayCoord),k.setUniform1f("u_depth",f.z+1/65536),k.setUniform1f("u_outline_width",F),k.setUniform4fv("u_color",this._outlineColor),x&&k.setUniform4f("u_id",y[0],y[1],y[2],y[3]),t.drawElements(4,e.outlineElementCount,5125,12*e.outlineElementStart),t.bindVAO()}}}},t.prototype._initialize=function(t){return!!this._initialized||(this._fillVertexAttributes={geometry:[{name:"a_pos",count:2,type:5122,offset:0,stride:4,normalized:!1,divisor:0}]},this._fillVertexAttributesDD={geometry:[{name:"a_pos",count:2,type:5122,offset:0,stride:8,normalized:!1,divisor:0},{name:"a_color",count:4,type:5121,offset:4,stride:8,normalized:!0,divisor:0}]},this._outlineVertexAttributes={geometry:[{name:"a_pos",count:2,type:5122,offset:0,stride:8,normalized:!1,divisor:0},{name:"a_offset",count:2,type:5120,offset:4,stride:8,normalized:!1,divisor:0},{name:"a_xnormal",count:2,type:5120,offset:6,stride:8,normalized:!1,divisor:0}]},this._outlineVertexAttributesDD={geometry:[{name:"a_pos",count:2,type:5122,offset:0,stride:12,normalized:!1,divisor:0},{name:"a_offset",count:2,type:5120,offset:4,stride:12,normalized:!1,divisor:0},{name:"a_xnormal",count:2,type:5120,offset:6,stride:12,normalized:!1,divisor:0},{name:"a_color",count:4,type:5121,offset:8,stride:12,normalized:!0,divisor:0}]},this._initialized=!0,!0)},t.prototype._drawFill=function(t,e,i,o,a,n,l,s,f,u,_,m){var h=n.getPaintValue("fill-pattern",i),c=void 0!==h,d=n.hasDataDrivenOpacity?1:u*n.getPaintValue("fill-opacity",i),p=n.hasDataDrivenColor?[1,1,1,1]:n.getPaintValue("fill-color",i),g=d*p[3]*u;this._color[0]=g*p[0],this._color[1]=g*p[1],this._color[2]=g*p[2],this._color[3]=g;var v=n.hasDataDrivenFill,y=c||g<1||v;if((!y||0!==o)&&(y||1!==o)){var x=this._getFillVAO(t,a,v);if(x){t.bindVAO(x);var V=(_?1:0)<<2|(v?1:0)<<1|(c?1:0),D=this._fillProgramOptions;D.id=_,D.dd=v,D.pattern=c;var b=this._programCache.getProgram(1,V,D);if(t.bindProgram(b),c){var A=l.getMosaicItemPosition(h,!0);if(!A)return t.bindVAO(),void t.bindProgram();var O=a.coordRange/512,P=O/Math.pow(2,Math.round(i)-a.key.level)/f;r.mat3.identity(this._patternMatrix);var C=1/(A.size[0]*P),M=1/(A.size[1]*P);this._patternMatrix[0]=C,this._patternMatrix[4]=M,l.bind(t,9729,A.page,5),b.setUniformMatrix3fv("u_pattern_matrix",this._patternMatrix),b.setUniform2f("u_pattern_tl",A.tl[0],A.tl[1]),b.setUniform2f("u_pattern_br",A.br[0],A.br[1]),b.setUniform1i("u_texture",5)}b.setUniformMatrix4fv("u_transformMatrix",s),b.setUniform2fv("u_normalized_origin",a.tileTransform.displayCoord),b.setUniform1f("u_depth",n.z+1/65536),b.setUniform4fv("u_color",this._color),_&&b.setUniform4f("u_id",m[0],m[1],m[2],m[3]),t.drawElements(4,e.triangleElementCount,5125,12*e.triangleElementStart),t.bindVAO()}}},t.prototype._getFillVAO=function(t,e,r){if(r){if(e.fillDDVertexArrayObject)return e.fillDDVertexArrayObject;var i=e.fillDDVertexBuffer,o=e.fillIndexBuffer;return i&&o?(e.fillDDVertexArrayObject=new a(t,this._programCache.getProgramAttributes(1),this._fillVertexAttributesDD,{geometry:i},o),e.fillDDVertexArrayObject):null}if(e.fillVertexArrayObject)return e.fillVertexArrayObject;var i=e.fillVertexBuffer,o=e.fillIndexBuffer;return i&&o?(e.fillVertexArrayObject=new a(t,this._programCache.getProgramAttributes(1),this._fillVertexAttributes,{geometry:i},o),e.fillVertexArrayObject):null},t.prototype._getOutlineVAO=function(t,e,r){if(r){if(e.outlineDDVertexArrayObject)return e.outlineDDVertexArrayObject;var i=e.outlineDDVertexBuffer,o=e.outlineIndexBuffer;return i&&o?(e.outlineDDVertexArrayObject=new a(t,this._programCache.getProgramAttributes(2),this._outlineVertexAttributesDD,{geometry:i},o),e.outlineDDVertexArrayObject):null}if(e.outlineVertexArrayObject)return e.outlineVertexArrayObject;var i=e.outlineVertexBuffer,o=e.outlineIndexBuffer;return i&&o?(e.outlineVertexArrayObject=new a(t,this._programCache.getProgramAttributes(2),this._outlineVertexAttributes,{geometry:i},o),e.outlineVertexArrayObject):null},t}()});