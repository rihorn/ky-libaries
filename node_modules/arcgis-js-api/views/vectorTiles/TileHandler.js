// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.10/esri/copyright.txt for details.

define(["require","exports","../../request","../../core/has","../../core/ItemCache","../../core/promiseUtils","../../core/requireUtils","../../core/workers","../2d/tiling/TileKey","./GeometryUtils","./GlyphMosaic","./GlyphSource","./SpriteMosaic","./SpriteSource","./TileIndex","./VectorTileDisplayObject","module"],function(e,t,i,n,o,r,s,a,l,c,u,h,p,d,f,y,_){var g=new o(10),v=new Map;return function(){function t(e,t,i,n){this.devicePixelRatio=t,this.allowUpdates=i,this._spriteMosaic=null,this._glyphMosaic=null,this._connection=null,this._tileIndex=null,this._updateQueue=new Map,this._ongoingRequests=new Map,this._vectorTileLayer=e,this._container=n}return t.prototype.destroy=function(){this.stop(),this._vectorTileLayer=null,this._spriteMosaic&&(this._spriteMosaic.dispose(),this._spriteMosaic=null),this._glyphMosaic&&(this._glyphMosaic.dispose(),this._glyphMosaic=null)},Object.defineProperty(t.prototype,"initialized",{get:function(){return this._broadcastPromise&&this._broadcastPromise.isFulfilled()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"spriteMosaic",{get:function(){return this._spriteMosaic},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"glyphMosaic",{get:function(){return this._glyphMosaic},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"ongoingRequestCount",{get:function(){return this._ongoingRequests.size},enumerable:!0,configurable:!0}),t.prototype.start=function(){var t=this;this.stop();var i=this._vectorTileLayer.styleRepository,o=new d(i.sprite,this.devicePixelRatio),l=o.load().then(function(){t._spriteMosaic=new p(1024,1024,250),t._spriteMosaic.setSpriteSource(o),n("stable-symbol-rendering")&&t._spriteMosaic.preloadSpriteItems()}),c=new h(i.glyphs);this._glyphMosaic=new u(1024,1024,c);var f,y=this._fetchTileMap(this._vectorTileLayer.tileIndexUrl),g=a.open(s.getAbsMid("./WorkerTileHandler",e,_),{client:this}).then(function(e){t._connection=e}),v=r.create(function(e){f=e},function(e){l.isFulfilled()||l.cancel(),y.isFulfilled()||y.cancel(),g.isFulfilled()||g.cancel()});return r.all([l,g]).then(function(){var e=t._connection.broadcast("setLayers",i.styleJSON);e.push(y),r.all(e).then(function(){f()})}),this._broadcastPromise=v,this._broadcastPromise},t.prototype.stop=function(){this._broadcastPromise&&!this._broadcastPromise.isFulfilled()&&this._broadcastPromise.cancel(),this._updateQueue.forEach(function(e){return e.cancel()}),this._ongoingRequests.forEach(function(e){return e.cancel()}),this._connection&&(this._connection.close(),this._connection=null)},t.prototype.updateStyle=function(){this._updateQueue.forEach(function(e){return e.cancel()}),this._updateQueue.clear(),this._ongoingRequests.forEach(function(e){return e.cancel()}),this._ongoingRequests.clear();var e,t=this._vectorTileLayer.styleRepository,i=r.create(function(t){e=t});return r.all(this._connection.broadcast("updateStyle",t.styleJSON)).then(function(){return e()}),this._broadcastPromise=i,i},t.prototype.updateTile=function(e,t){var i=this;if(!this.allowUpdates)return r.resolve(null);if(!this._broadcastPromise.isFulfilled()||!this._connection)return r.reject(new Error("no connection"));var n=Math.round(c.degToByte(t.state.rotation));if(e.rotation===n)return r.resolve(null);var o,s=e.key;return this._updateQueue.has(s.id)&&(o=this._updateQueue.get(s.id),o.cancel(),this._updateQueue.delete(s.id)),e.rotation=n,o=e.client.invoke("updateSymbols",{key:e.id,rotation:n}).then(function(t){return i._updateQueue.delete(s.id),e.updateSymbolData(t),t}).catch(function(e){"cancel"!==e.dojoType&&i._updateQueue.delete(s.id)}),this._updateQueue.set(e.id,o),o},t.prototype.updateTileData=function(e){for(var t,i=e.tileId,n=this._container.children,o=0;o<n.length;o++)if(t=n[o],t.id===i){t.updateTileData(e.tileData);break}},t.prototype.getVectorTile=function(e,t,i,n){var o=this;void 0===n&&(n=0);var r=new l(e,t,i,0);return this.getRefKey(r).then(function(e){var t=new y(r,e,o._vectorTileLayer.tileInfo,o._vectorTileLayer.styleRepository,0);return e?o.getTileData(t.key,0).then(function(e){return t.setData(e.tileData,e.client),t}):(t.setData(null,null),t)})},t.prototype.getTileData=function(e,t){var i=this;return this._broadcastPromise.isFulfilled()&&this._connection?this.getRefKey(e).then(function(n){if(!n)return r.resolve(null);var o=Math.round(c.degToByte(t));return i._getTileData(i._connection,e,n,o).then(function(e){return e&&e.tileData?e:r.reject(null)})}):r.reject(new Error("no connection"))},t.prototype.getRefKey=function(e){return this._tileIndex?this._tileIndex.dataKey(e):r.resolve(e)},t.prototype.getSprites=function(e){return this._spriteMosaic.getSpriteItems(e)},t.prototype.getGlyphs=function(e){return this._glyphMosaic.getGlyphItems(e.tileID,e.font,e.codePoints)},t.prototype.getStyleRepository=function(){return this._vectorTileLayer.styleRepository},t.prototype.getTileIndex=function(){return this._tileIndex},t.prototype._getTileData=function(e,t,i,n){var o=this,s=this._ongoingRequests.get(t.id);if(s)return s;var a=this._vectorTileLayer.getTileUrl(i.level,i.row,i.col),l=this._connection.getAvailableClient();return s=l.invoke("getTile",{key:t.id,refKey:i.id,url:a,rotation:n,cacheTile:this.allowUpdates}).then(function(e){return o._ongoingRequests.delete(t.id),{tileData:e,client:l}}).catch(function(e){return o._ongoingRequests.delete(t.id),l.invoke("destructTileData",t.id),r.reject(e)}),this._ongoingRequests.set(t.id,s),s},t.prototype._fetchTileMap=function(e){var t=this;if(this._vectorTileLayer.capabilities.operations.supportsTileMap&&this._vectorTileLayer.tilemapCache)return this._tileIndex=new f(this._vectorTileLayer.tilemapCache),r.resolve();if(!e)return r.resolve();var n=g.get(e);if(void 0!==n)return this._tileIndex=n,r.resolve();if(v.has(e))return v.get(e).then(function(e){t._tileIndex=new f(e.data)});var o=i(e,{responseType:"json"});return o.then(function(i){t._tileIndex=new f(i.data),v.delete(e),g.put(e,t._tileIndex)}),v.set(e,o),o},t}()});