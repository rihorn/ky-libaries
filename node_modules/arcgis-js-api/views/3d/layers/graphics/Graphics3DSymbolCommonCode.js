// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.10/esri/copyright.txt for details.

define(["require","exports","../../../../core/compilerUtils","../../../../core/libs/gl-matrix-2/gl-matrix","../../../../geometry/support/coordsUtils","../../../../geometry/support/triangulationUtils","../../../../layers/graphics/dehydratedFeatures","../../../../symbols/callouts/calloutUtils","./graphicUtils","../../support/projectionUtils","../../webgl-engine/lib/Object3D"],function(e,t,r,n,a,o,i,u,l,s,c){function f(e,t,r,n,a,o,i,u,l,s,f,v){var d=r?r.length:0,p=e.clippingExtent;if(j(t,_,e.elevationProvider.spatialReference),p&&!G(_,p))return null;j(t,_,e.renderSpatialReference);for(var g=e.localOriginFactory.getOrigin(_),h=!!f,E=new c({castShadow:!1,metadata:{layerUid:l,graphicUid:s,usesVerticalDistanceToGround:h},idHint:u}),b=0;b<d;b++){var y=a?a[b]:I;E.addGeometry(r[b],n[b],y,o,g,v)}return{object:E,terrainElevation:m(E,t,i,e.renderSpatialReference,e.elevationProvider,e.renderCoordsHelper).terrainElevation}}function v(e,t,r){var n=e.elevationContext,a=r.spatialReference;j(t,_,a),n.centerPointInElevationSR=i.makeDehydratedPoint(_[0],_[1],t.hasZ?_[2]:0,a)}function d(e){switch(e.type){case"point":return e;case"polygon":case"extent":return l.computeCentroid(e);case"polyline":var t=e.paths[0];if(!t||0===t.length)return null;var r=a.getPointOnPath(t,a.getPathLength(t)/2);return i.makeDehydratedPoint(r[0],r[1],r[2],e.spatialReference);case"mesh":return e.extent.center}return null}function p(e,t,n,a,o){var i=t.z||0,u=n.featureExpressionInfoContext;switch(n.mode){case"on-the-ground":var l=e.getElevation(t,"ground")||0;return o&&(o.verticalDistanceToGround=0,o.terrainElevation=l),l;case"relative-to-ground":var s=e.getElevation(t,"ground")||0,l=n.calculateOffsetRenderUnits(a);return null==u&&(l+=i),o&&(o.verticalDistanceToGround=l,o.terrainElevation=s),l+s;case"relative-to-scene":var s=e.getElevation(t,"scene")||0,l=n.calculateOffsetRenderUnits(a);return o&&(o.verticalDistanceToGround=l,o.terrainElevation=s),l+s;case"absolute-height":var l=n.calculateOffsetRenderUnits(a);if(null==u&&(l+=i),o){var s=e.getElevation(t,"ground")||0;o.verticalDistanceToGround=l-s,o.terrainElevation=s}return l;default:r.neverReached(n.mode)}return 0}function g(e,t,r,n,a,o,i,u){var l=u.mode,s=0,c=0,f=0,v=u.calculateOffsetRenderUnits(i),d=u.featureExpressionInfoContext;k.spatialReference=e.spatialReference,r*=3,a*=3;for(var p=0;p<o;++p){switch(k.x=t[r+0],k.y=t[r+1],k.z=t[r+2],l){case"on-the-ground":s=e.getElevation(k)||0,c=s,f+=s;break;case"relative-to-ground":s=e.getElevation(k)||0,c=s+v,null==d&&(c+=k.z),f+=s;break;case"relative-to-scene":s=e.getElevation(k,"scene")||0,c=s+v,f+=s;break;case"absolute-height":c=v,null==d&&(c+=k.z)}n[a+0]=t[r+0],n[a+1]=t[r+1],n[a+2]=c,r+=3,a+=3}return f/=o,{terrainElevation:f}}function m(e,t,r,n,a,o){var i,u=0;if(e.metadata.usesVerticalDistanceToGround)u=p(a,t,r,o,B),l.updateVertexAttributeAuxpos1w(e,B.verticalDistanceToGround),i=B.terrainElevation;else{var c="absolute-height"!==r.mode;u=p(a,t,r,o,c?B:null),c&&(i=B.terrainElevation)}var f=e.getObjectTransformation();return _[0]=t.x,_[1]=t.y,_[2]=u,s.computeLinearTransformation(t.spatialReference,_,f,n)?e.setObjectTransformation(f):console.warn("Could not locate symbol object properly, it might be misplaced"),{terrainElevation:i}}function h(e,t){return void 0===t&&(t=0),isFinite(e[t])?e[t]:null}function E(e,t){var r=o.pathsToTriangulationInfo(e,t);return{vertexData:r.position,polygons:r.polygons,outlines:r.outlines}}function b(e,t,r,n,a){t*=3,n*=3;for(var o=0;o<a;++o)r[n++]=e[t++],r[n++]=e[t++],r[n++]=e[t++]}function y(e,t,r,n){var a=Math.floor(t+(r-1)/2);n[0]=e[3*a+0],n[1]=e[3*a+1],n[2]=e[3*a+2]}function x(e,t,r,n){t*=3;for(var a=0;a<r;++a)e[t++]-=n[0],e[t++]-=n[1],e[t++]-=n[2]}function D(e,t,r,n){t*=3;for(var a=0;a<r;++a)e[t+2]=n,t+=3}function A(e,t,r,n){t*=3;for(var a=0;a<r;++a)e[t+2]+=n,t+=3}function O(e,t,r,n){t*=3;for(var a=0;a<r;++a)e[t+2]*=n,t+=3}function U(e,t,r){var n=[];t*=3;for(var a=0;a<r;++a)n.push([e[t++],e[t++],e[t++]]);return n}function T(e,t,r,n,a,o,i){return s.bufferToBuffer(e,r,t,n,o,a,i)}function j(e,t,r){s.pointToVector(e,t,r)}function V(e,t,r,n,a,o,i){var u=a.spatialReference,l=E(e,t),s=l.vertexData,c=s.length/3,f=new Float64Array(s.length),v=!0;r.equals(u)?b(s,0,f,0,s.length):v=T(s,0,r,f,0,u,c);var d=g(a,f,0,s,0,c,o,i);return u.equals(n)||T(s,0,u,s,0,n,c),{geometryData:l,vertexData:s,eleVertexData:f,terrainElevation:d.terrainElevation,projectionSuccess:v}}function P(e,t,r){var n=E(e,!1),a=n.vertexData,o=a.length/3,i=!0;return t.equals(r)||(i=s.bufferToBuffer(a,t,0,a,r,0,o)),{geometryData:n,vertexData:a,projectionSuccess:i}}function R(e,t,r,n){n[0]=Number.MAX_VALUE,n[1]=Number.MAX_VALUE,n[2]=Number.MAX_VALUE,n[3]=-Number.MAX_VALUE,n[4]=-Number.MAX_VALUE,n[5]=-Number.MAX_VALUE,t*=3;for(var a=0;a<r;++a){var o=e[t++],i=e[t++],u=e[t++];o<n[0]&&(n[0]=o),i<n[1]&&(n[1]=i),u<n[2]&&(n[2]=u),o>n[3]&&(n[3]=o),i>n[4]&&(n[4]=i),u>n[5]&&(n[5]=u)}return n}function G(e,t){return!(e[0]>t[3]||e[0]<t[0]||e[1]>t[4]||e[1]<t[1])}function C(e,t){return!(t[0]>e[3]||t[3]<e[0]||t[1]>e[4]||t[4]<e[1])}function S(e,t){return!!t&&!C(e,t)}function w(e){return"relative-to-ground"===e||"relative-to-scene"===e}function L(e){return"absolute-height"!==e}function M(e,t,r,n){if(!1===t.needsOffsetAdjustment||!1===t.supportsOffsetAdjustment)return!1;if("on-the-ground"===e.mode)return!1;if(0===e.meterUnitOffset){if(!0===t.needsOffsetAdjustment)return!0;if(u.isCalloutSupport(n)&&n.hasVisibleVerticalOffset())return!1;if("relative-to-ground"===e.mode&&(!r.hasZ||e.featureExpressionInfoContext))return!0;if("relative-to-scene"===e.mode)return!0}return!1}Object.defineProperty(t,"__esModule",{value:!0});var _=n.vec3f64.create(),I=n.mat4f64.create(),k=i.makeDehydratedPoint(0,0,0,null);t.createStageObjectForPoint=f,t.extendPointGraphicElevationContext=v,t.placePointOnGeometry=d,t.computeElevation=p,t.getSingleSizeDriver=h,t.copyPathData=E,t.copyVertices=b,t.chooseOrigin=y,t.subtractCoordinates=x,t.setZ=D,t.offsetZ=A,t.scaleZ=O,t.flatArrayToArrayOfArrays=U,t.reproject=T,t.reprojectPoint=j,t.getGeometryVertexData3D=V,t.getGeometryVertexDataDraped=P,t.computeBoundingBox=R,t.pointInBox2D=G,t.boxesIntersect2D=C,t.boundingBoxClipped=S,t.needsElevationUpdates2D=w,t.needsElevationUpdates3D=L,t.needsOffsetAdjustment=M;var B={verticalDistanceToGround:0,terrainElevation:0}});