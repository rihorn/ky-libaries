// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.10/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/extendsHelper","../../../../core/tsSupport/generatorHelper","../../../../core/tsSupport/awaiterHelper","dojo/sniff","dojo/errors/CancelError","../../../../request","../../../../core/Error","../../../../core/lang","../../../../core/Logger","../../../../core/promiseUtils","../../../../core/Version","../../../../geometry/support/aaBoundingBox","../../support/imageUtils","../../webgl-engine/lib/Geometry","../../webgl-engine/lib/GeometryData","../../webgl-engine/lib/Texture","../../webgl-engine/materials/DefaultMaterial"],function(e,r,t,n,a,i,s,o,u,l,c,p,f,d,m,g,v,x,y){function b(e,r){return a(this,void 0,void 0,function(){var t;return n(this,function(n){switch(n.label){case 0:return[4,h(e,r.streamDataSupplier)];case 1:return t=n.sent(),[4,A(t,r)];case 2:return[2,n.sent()]}})})}function h(e,r){if(r){var t=r.request(e,"json");return p.create(function(e,r){t.then(function(r,t){e(t)},function(e){r(e instanceof s?e:w(e))})},function(){r.cancelRequest(t)})}var n=o(e);return p.create(function(e,r){n.then(function(r){e(r.data)},function(e){r(e instanceof s?e:w(e))})},function(){n.cancel()})}function w(e){return new u("","Request for object resource failed: "+e)}function U(e){var r=e.params,t=r.topology,n=!0;switch(r.vertexAttributes||(P.warn("Geometry must specify vertex attributes"),n=!1),r.topology){case"PerAttributeArray":break;case"Indexed":case null:case void 0:var a=r.faces;if(a){if(r.vertexAttributes)for(var i in r.vertexAttributes){var s=a[i];s&&s.values?(null!=s.valueType&&"UInt32"!==s.valueType&&(P.warn("Unsupported indexed geometry indices type '"+s.valueType+"', only UInt32 is currently supported"),n=!1),null!=s.valuesPerElement&&1!==s.valuesPerElement&&(P.warn("Unsupported indexed geometry values per element '"+s.valuesPerElement+"', only 1 is currently supported"),n=!1)):(P.warn("Indexed geometry does not specify face indices for '"+i+"' attribute"),n=!1)}}else P.warn("Indexed geometries must specify faces"),n=!1;break;default:P.warn("Unsupported topology '"+t+"'"),n=!1}e.params.material||(P.warn("Geometry requires material"),n=!1);var o=e.params.vertexAttributes;for(var u in o){o[u].values||(P.warn("Geometries with externally defined attributes are not yet supported"),n=!1)}return n}function A(e,r){return a(this,void 0,void 0,function(){var t,a,s,o,u,c,p,d,m,x,b,h,w,A,P,O,q,B,C,k,D,S,G,R,V,H,_,z,F,L,J,K;return n(this,function(n){switch(n.label){case 0:return t=[],a=[],s=[],o=[],u=f.Version.parse(e.version||"1.0","wosr"),E.validate(u),c="meshsymbol_"+e.model.name,p=e.textureDefinitions,[4,j(c,p,r)];case 1:d=n.sent();for(m in d)o.push(d[m].engineTexObj);for(x=e.model.geometries,b=e.materialDefinitions,h=0,w=0;w<x.length;w++)if(A=x[w],U(A)){P=T(A),O=A.params.vertexAttributes,q={};for(B in O)C=O[B],k=C.values,q[B]={data:k,size:C.valuesPerElement};if(D={},"PerAttributeArray"===A.params.topology){S=q.position.data.length/q.position.size,G=M(S);for(R in q)D[R]=G}else{V=A.params.faces;for(H in V)D[H]=new Uint32Array(V[H].values)}_=P.texture?d[P.texture]:null,z=s[P.material]?s[P.material][P.texture]:null,z||(F=P.material.substring(P.material.lastIndexOf("/")+1),L=b[F].params,1===L.transparency&&(L.transparency=0),J={ambient:L.diffuse,diffuse:L.diffuse,specular:[0,0,0],opacity:1-(L.transparency||0),transparent:L.transparency>0,textureAlphaCutoff:.33,textureId:_?_.engineTexObj.id:void 0,textureInitTransparent:!0,doubleSided:!0,cullFace:"none",flipV:!1,colorMixMode:L.externalColorMixMode||"tint"},i("enable-feature:jkieboom/alpha-channel-usage")&&(!_||"transparency"!==_.alphaChannelUsage&&"maskAndTransparency"!==_.alphaChannelUsage||(J.transparent=!0)),r&&r.materialParamsMixin&&l.mixin(J,r.materialParamsMixin),z=new y(J,c),s[P.material]||(s[P.material]={}),s[P.material][P.texture]=z),a.push(z),K=new g(new v(q,D),c),h+=D.position?D.position.length:0,t.push(K)}return[2,{stageResources:{textures:o,materials:a,geometries:t},pivotOffset:e.model.pivotOffset,boundingBox:I(t),numberOfVertices:h,lodThreshold:null}]}})})}function I(e){var r=d.empty();return e.forEach(function(e){var t=e.boundingInfo;d.expand(r,t.getBBMin()),d.expand(r,t.getBBMax())}),r}function j(e,r,t){return a(this,void 0,void 0,function(){var a,s,o,u,l,c,f,d;return n(this,function(n){switch(n.label){case 0:a=[],s=function(n){var s=r[n],o=s.images[0].data;if(!o)return P.warn("Externally referenced texture data is not yet supported"),"continue";var u=s.encoding+";base64,"+o,l="/textureDefinitions/"+n,c={noUnpackFlip:!0,wrap:{s:10497,t:10497}};i("enable-feature:jkieboom/alpha-channel-usage")&&(c.wrap={s:33071,t:33071});var f=t&&t.disableTextures?p.resolve(null):m.requestImage(u);a.push(f.then(function(r){return{refId:l,engineTexObj:new x(r,e,c),alphaChannelUsage:"rgba"===s.channels?s.alphaChannelUsage||"transparency":"none"}}))};for(o in r)s(o);return[4,p.all(a)];case 1:for(u=n.sent(),l={},c=0,f=u;c<f.length;c++)d=f[c],l[d.refId]=d;return[2,l]}})})}function T(e){var r=e.params;return{id:1,material:r.material,texture:r.texture,region:r.texture}}function M(e){for(var r=new Uint32Array(e),t=0;t<e;t++)r[t]=t;return r}Object.defineProperty(r,"__esModule",{value:!0});var P=c.getLogger("esri.views.3d.layers.graphics.objectResourceUtils");r.load=b,r.createStageResources=A;var E=new f.Version(1,2,"wosr")});