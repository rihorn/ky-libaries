// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.10/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/extendsHelper","../../../../core/libs/gl-matrix-2/gl-matrix","../../../../geometry/Point","./Graphics3DObject3DGraphicLayer","./Graphics3DSymbolCommonCode","./Graphics3DSymbolLayer","./graphicUtils","../../support/projectionUtils","../../webgl-engine/Stage","../../webgl-engine/lib/Geometry","../../webgl-engine/lib/GeometryUtil","../../webgl-engine/lib/Object3D","../../webgl-engine/lib/Util","../../webgl-engine/materials/DefaultMaterial"],function(e,t,r,i,a,n,o,s,l,p,c,h,d,g,y,u){function m(e,t,r,i){for(var a=e.stageObject,n=a.getGeometryRecords(),s=n.length,l="absolute-height"!==t.mode,p=0,c=0;c<s;c++){var h=n[c].geometry,d=[n[c].transformation[12],n[c].transformation[13],n[c].transformation[14]],g=h.data.getVertexAttr(),y=g[_.POSITION].data,u=g.zOffset.data,m=g.mapPos.data,v=m.length/3;f(y.length/3==v*S+2,"unexpected tube geometry");var D=0,P=0;b.spatialReference=r.spatialReference;for(var C=0,A=0;A<v;A++){b.x=m[3*A],b.y=m[3*A+1],b.z=m[3*A+2];var G=o.computeElevation(r,b,t,i,l?E:null);l&&(C+=E.terrainElevation);var z=S;0!==A&&A!==v-1||z++;for(var w=0;w<z;w++)x[0]=y[D]+d[0],x[1]=y[D+1]+d[1],x[2]=y[D+2]+d[2],i.setAltitude(G+u[P],x),y[D]=x[0]-d[0],y[D+1]=x[1]-d[1],y[D+2]=x[2]-d[2],D+=3,P+=1;h.invalidateBoundingInfo()}a.geometryVertexAttrsUpdated(c),p+=C/v}return p/s}var f=y.assert,v=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return r(t,e),t.prototype._prepareResources=function(){if(!this._isPropertyDriven("size")){var e=l.validateSymbolLayerSize(this._getSymbolSize());if(e)return this._logWarning(e),void this.reject()}var t=this._getStageIdHint(),r=this._getMaterialOpacityAndColor(),a=i.vec3f64.fromArray(r),n=r[3],o={diffuse:a,ambient:a,opacity:n,transparent:n<1||this._isPropertyDriven("opacity"),vertexColors:this._isPropertyDriven("color")||this._isPropertyDriven("opacity"),slicePlaneEnabled:this._context.slicePlaneEnabled};this._material=new u(o,t+"_3dlinemat"),this._context.stage.add(c.ModelContentType.MATERIAL,this._material),this.resolve()},t.prototype.destroy=function(){e.prototype.destroy.call(this),this.isFulfilled()||this.reject(),this._material&&(this._context.stage.remove(c.ModelContentType.MATERIAL,this._material.id),this._material=null)},t.prototype.createGraphics3DGraphic=function(e){var t=e.graphic;if("polyline"!==t.geometry.type)return this._logWarning("unsupported geometry type for path symbol: "+t.geometry.type),null;if(!this._validateGeometry(t.geometry))return null;var r="graphic"+t.uid,i=this.getGraphicElevationContext(t),a=e.renderingInfo;return this._createAs3DShape(t,a,i,r,t.uid)},t.prototype.layerOpacityChanged=function(){var e=this._getMaterialOpacity(),t=e<1||this._isPropertyDriven("opacity");return this._material.setParameterValues({opacity:e,transparent:t}),!0},t.prototype.layerElevationInfoChanged=function(e,t){return this.updateGraphics3DGraphicElevationInfo(e,t,o.needsElevationUpdates3D)},t.prototype.slicePlaneEnabledChanged=function(e,t){return this._material.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled}),!0},t.prototype._getPathSize=function(e){var t;return t=e.size&&this._isPropertyDriven("size")?o.getSingleSizeDriver(e.size):this._getSymbolSize(),t/=this._context.renderCoordsHelper.unitInMeters},t.prototype._getSymbolSize=function(){return this.symbol.size||1},t.prototype._createAs3DShape=function(e,t,r,a,s){var l=e.geometry,c=l.paths,y=[],u=[],f=[],v=i.vec3f64.create(),_=this._context.renderSpatialReference,x=_===p.SphericalECEFSpatialReference,b=new Array(6),E=this._getPathSize(t),D=o.getGeometryVertexData3D(c,l.hasZ,l.spatialReference,this._context.renderSpatialReference,this._context.elevationProvider,this._context.renderCoordsHelper,r);if(this._logGeometryCreationWarnings(D,c,"paths","PathSymbol3DLayer"),c.length>0){for(var P=D.geometryData.outlines,C=D.eleVertexData,A=D.vertexData,G=0;G<P.length;++G){var z=P[G];if(!(z.count<=1)){var w=z.index,I=z.count;if(!this._context.clippingExtent||(o.computeBoundingBox(C,w,I,b),!o.boundingBoxClipped(b,this._context.clippingExtent))){o.chooseOrigin(A,w,I,v),o.subtractCoordinates(A,w,I,v);var O=new Float64Array(C.buffer,3*w*C.BYTES_PER_ELEMENT,3*I),R=o.flatArrayToArrayOfArrays(A,w,I),T=d.createTubeGeometry(R,.5*E,S,x,v);if(T.getVertexAttr().mapPos={size:3,data:O,offsetIdx:0,strideIdx:3},this._material.getParams().vertexColors){var U=this._getVertexOpacityAndColor(t);T=d.addVertexColors(T,U)}var V=new h(T,a+"path"+G);V.singleUse=!0,y.push(V),u.push(this._material);var M=i.mat4f64.create();i.mat4.translate(M,M,v),f.push(M)}}}if(y.length>0){var L=new g({geometries:y,materials:u,transformations:f,castShadow:!0,metadata:{layerUid:this._context.layer.uid,graphicUid:s},idHint:a}),j=m,B=new n(this,L,y,null,null,j,r);return B.alignedTerrainElevation=D.terrainElevation,B.needsElevationUpdates=o.needsElevationUpdates3D(r.mode),B}}return null},t}(s),_=y.VertexAttrConstants,x=i.vec3f64.create(),b=new a,E={verticalDistanceToGround:0,terrainElevation:0},S=10;return v});