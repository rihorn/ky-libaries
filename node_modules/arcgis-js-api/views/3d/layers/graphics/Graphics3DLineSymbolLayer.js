// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.10/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/extendsHelper","../../../../core/screenUtils","../../../../core/libs/gl-matrix-2/gl-matrix","../../../../geometry/Polygon","../../../../geometry/support/aaBoundingBox","./ElevationAligners","./Graphics3DDrapedGraphicLayer","./Graphics3DObject3DGraphicLayer","./Graphics3DSymbolCommonCode","./Graphics3DSymbolLayer","./graphicUtils","./lineUtils","../../webgl-engine/Stage","../../webgl-engine/lib/Geometry","../../webgl-engine/lib/Object3D","../../webgl-engine/lib/RenderGeometry"],function(e,t,r,i,n,a,o,l,s,p,h,c,u,y,g,d,m,_){function v(e){return null!=e.size?i.pt2px(e.size):1}return function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return r(t,e),t.prototype._prepareResources=function(){var e=this.symbol,t=this._isPropertyDriven("size")||this._isPropertyDriven("color")||this._isPropertyDriven("opacity"),r={idHint:this._getStageIdHint(),width:v(e),color:this._getMaterialOpacityAndColor(),slicePlaneEnabled:this._context.slicePlaneEnabled};if(!this._isPropertyDriven("size")){var i=u.validateSymbolLayerSize(r.width);if(i)return this._logWarning(i),void this.reject()}if(t||r.width>=1.5)this._isPropertyDriven("size")&&(r.width=0),this._material=y.createRibbonMaterial(r);else{if(!(r.width>0))return void this.reject();this._material=y.createNativeMaterial(r)}this._context.stage.add(g.ModelContentType.MATERIAL,this._material),this.resolve()},t.prototype.destroy=function(){e.prototype.destroy.call(this),this.isFulfilled()||this.reject(),this._material&&(this._context.stage.remove(g.ModelContentType.MATERIAL,this._material.id),this._material=null)},t.prototype.createGraphics3DGraphic=function(e){var t=e.renderingInfo,r=e.graphic,n=r.geometry;if("polyline"!==n.type&&"polygon"!==n.type&&"extent"!==n.type)return this._logWarning("unsupported geometry type for line symbol: "+n.type),null;if(!this._validateGeometry(n))return null;var a="polygon"===n.type||"extent"===n.type?"rings":"paths",o="graphic"+r.uid,l=this._getVertexOpacityAndColor(t,Float32Array,255),s=0;t.size&&this._isPropertyDriven("size")&&(s=h.getSingleSizeDriver(t.size),s=i.pt2px(s));var p=this.getGraphicElevationContext(r);return"on-the-ground"===p.mode?this._createAsOverlay(r,a,l,s,p,o):this._createAs3DShape(r,a,l,s,p,o,r.uid)},t.prototype.layerOpacityChanged=function(){var e=this._material.getColor(),t=[e[0],e[1],e[2],this._getMaterialOpacity()],r={color:t};return this._material.setParameterValues(r),!0},t.prototype.layerElevationInfoChanged=function(e,t,r){var i=this._elevationContext.mode;if(null==r||null==i)return!1;if("on-the-ground"===r&&"on-the-ground"===i)return!0;if(r!==i&&("on-the-ground"===r||"on-the-ground"===i))return!1;var n=h.needsElevationUpdates2D(i);return this.updateGraphics3DGraphicElevationInfo(e,t,function(){return n})},t.prototype.slicePlaneEnabledChanged=function(e,t){var r={slicePlaneEnabled:this._context.slicePlaneEnabled};return this._material.setParameterValues(r),!0},t.prototype._getOutlineGeometry=function(e,t){return t},t.prototype._getGeometry=function(e){var t=e.geometry;return"extent"===t.type&&(t=a.fromExtent(t)),t},t.prototype._createAs3DShape=function(e,t,r,i,a,o,s){var c=this._getGeometry(e),u=c[t],g=this._getOutlineGeometry(c,u),_=[],v=[],f=[],x=n.vec3f64.create(),E=new Array(6),b=h.getGeometryVertexData3D(g,c.hasZ,c.spatialReference,this._context.renderSpatialReference,this._context.elevationProvider,this._context.renderCoordsHelper,a);if(this._logGeometryCreationWarnings(b,u,t,"LineSymbol3DLayer"),g.length>0){for(var D=b.geometryData.outlines,G=b.eleVertexData,P=b.vertexData,w=0;w<D.length;++w){var C=D[w];if(!(C.count<=1)){var S=C.index,A=C.count;if(!this._context.clippingExtent||(h.computeBoundingBox(G,S,A,E),!h.boundingBoxClipped(E,this._context.clippingExtent))){h.chooseOrigin(P,S,A,x),h.subtractCoordinates(P,S,A,x);var L=new Float64Array(G.buffer,3*S*G.BYTES_PER_ELEMENT,3*A),O=new Float64Array(P.buffer,3*S*P.BYTES_PER_ELEMENT,3*A),R=y.createPolylineGeometry(O,L,"rings"===t,r,i),M=new d(R,o+"path"+w);M.singleUse=!0,_.push(M),v.push(this._material);var B=n.mat4f64.create();n.mat4.translate(B,B,x),f.push(B)}}}if(_.length>0){var T=new m({geometries:_,materials:v,transformations:f,castShadow:!1,metadata:{layerUid:this._context.layer.uid,graphicUid:s},idHint:o}),z=l.perVertexElevationAligner,U=new p(this,T,_,null,null,z,a);return U.alignedTerrainElevation=b.terrainElevation,U.needsElevationUpdates=h.needsElevationUpdates2D(a.mode),U}}return null},t.prototype._createAsOverlay=function(e,t,r,i,a,l){var p=this._getGeometry(e);this._material.renderPriority=this._symbolLayerOrder;var c=p[t],u=this._getOutlineGeometry(p,c),g=[],d=new Array(6),m=o.empty(),v=n.vec3f64.create(),f=h.getGeometryVertexDataDraped(u,p.spatialReference,this._context.overlaySR);if(this._logGeometryCreationWarnings(f,c,t,"LineSymbol3DLayer"),u.length>0){for(var x=f.vertexData,E=f.geometryData.outlines,b=0;b<E.length;++b){var D=E[b],G=D.index,P=D.count;if(h.computeBoundingBox(x,G,P,d),!h.boundingBoxClipped(d,this._context.clippingExtent)){o.expand(m,d),h.chooseOrigin(x,G,P,v),h.subtractCoordinates(x,G,P,v),h.setZ(x,G,P,this._getDrapedZ());var w=new Float64Array(x.buffer,3*G*x.BYTES_PER_ELEMENT,3*P),C=n.mat4f64.create();n.mat4.translate(C,C,v);var S=y.createPolylineGeometry(w,null,"rings"===t,r,i),A=new _(S);A.material=this._material,A.center=[.5*(d[0]+d[3]),.5*(d[1]+d[4]),0],A.bsRadius=.5*Math.sqrt((d[3]-d[0])*(d[3]-d[0])+(d[4]-d[1])*(d[4]-d[1])),A.transformation=C,A.name=l,A.uniqueName=l+"#"+S.id,g.push(A)}}return new s(this,g,m)}return null},t}(c)});