// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.10/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/extendsHelper","../../../../core/lang","../../../../core/libs/gl-matrix-2/gl-matrix","../../../../geometry/Point","./Graphics3DObject3DGraphicLayer","./Graphics3DSymbolCommonCode","./Graphics3DSymbolLayer","./graphicUtils","./symbolComplexity","../support/FastSymbolUpdates","../../support/projectionUtils","../../webgl-engine/Stage","../../webgl-engine/lib/Geometry","../../webgl-engine/lib/GeometryUtil","../../webgl-engine/lib/Object3D","../../webgl-engine/lib/pathGeometryUtils","../../webgl-engine/lib/Util","../../webgl-engine/materials/PathMaterial"],function(e,t,a,r,i,n,o,s,l,p,h,c,d,u,y,m,v,g,f,_){function b(e,t,a,r){var i=e.stageObject,n=i.getMetadata().pathGeometryBuilder;if(!n)throw new Error("pathgeometry metadata expected");var o=i.getGeometryRecords(),l=o.length;P.spatialReference=a.spatialReference;for(var p="absolute-height"!==t.mode,h=0,c=0;c<l;c++){for(var d=o[c].geometry,u=n[d.id],y=u.path.offset,m=d.data.getVertexAttr(),v=m[C.POSITION].data,g=0,f=0;f<u.path.vertices.length;f++){var _=u.path.vertices[f];P.x=_.mapPos[0],P.y=_.mapPos[1],P.z=_.mapPos[2],_.elevation=s.computeElevation(a,P,t,r,p?E:null),p&&(g+=E.terrainElevation)}for(var b=0;b<u.numVerticesTotal;++b){var _=u.path.vertices[u.pathVertexData[b]];S[0]=v[3*b+0]+y[0],S[1]=v[3*b+1]+y[1],S[2]=v[3*b+2]+y[2],r.setAltitude(_.elevation,S),v[3*b+0]=S[0]-y[0],v[3*b+1]=S[1]-y[1],v[3*b+2]=S[2]-y[2]}d.invalidateBoundingInfo(),i.geometryVertexAttrsUpdated(c),h+=g/u.path.vertices.length}return h/l}var x=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return a(t,e),t.prototype._prepareResources=function(){if(!this._isPropertyDriven("size")){var e=p.validateSymbolLayerSize(this._getSymbolSize());if(e)return this._logWarning(e),void this.reject()}var t=this._getStageIdHint(),a=this._getMaterialOpacityAndColor(),n=i.vec3f32.fromValues(a[0],a[1],a[2]),o=a[3],s={diffuse:n,ambient:n,opacity:o,transparent:o<1||this._isPropertyDriven("opacity"),vertexColors:this._isPropertyDriven("color")||this._isPropertyDriven("opacity"),slicePlaneEnabled:this._context.slicePlaneEnabled};this._vvConvertOptions={modelSize:[1,1,1],symbolSize:[1,1,1],unitInMeters:this._context.renderCoordsHelper.unitInMeters,transformation:{anchor:[0,0,0],scale:[1,1,1],rotation:[0,0,0]},supportedTypes:{size:!0,color:!0,rotation:!1}},this._fastUpdates=c.initFastSymbolUpdatesState(this._context.renderer,this._vvConvertOptions),r.mixin(s,this._fastUpdates.materialParameters),this._pathMaterial=new _(s,t+"_pathmat"),this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size?this._pathMaterial.setParameterValues({size:1}):this._pathMaterial.setParameterValues({size:this._getSymbolSize()/this._context.renderCoordsHelper.unitInMeters}),this._context.stage.add(u.ModelContentType.MATERIAL,this._pathMaterial),this._profile=g.Profile.tube(D),this._extruder=new g.SimpleExtruder,this.resolve()},t.prototype.destroy=function(){e.prototype.destroy.call(this),this.isFulfilled()||this.reject(),this._pathMaterial&&(this._context.stage.remove(u.ModelContentType.MATERIAL,this._pathMaterial.id),this._pathMaterial=null)},t.prototype.createGraphics3DGraphic=function(e){var t=e.graphic;if("polyline"!==t.geometry.type)return this._logWarning("unsupported geometry type for path symbol: "+t.geometry.type),null;if(!this._validateGeometry(t.geometry))return null;var a="graphic"+t.uid,r=this.getGraphicElevationContext(t),i=e.renderingInfo;return this._createAs3DShape(t,i,r,a,t.uid)},t.prototype.layerOpacityChanged=function(){var e=this._getMaterialOpacity(),t=e<1||this._isPropertyDriven("opacity");return this._pathMaterial.setParameterValues({opacity:e,transparent:t}),!0},t.prototype.layerElevationInfoChanged=function(e,t,a){var r=this;return e.forEach(function(e){var a=t(e);if(a){var i=e.graphic,n=r.getGraphicElevationContext(i);a.needsElevationUpdates=s.needsElevationUpdates3D(n.mode),a.elevationContext.set(n)}}),!0},t.prototype.slicePlaneEnabledChanged=function(e,t){return this._pathMaterial.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled}),!0},t.prototype.applyRendererDiff=function(e,t){for(var a in e.diff)switch(a){case"visualVariables":if(!c.updateFastSymbolUpdatesState(this._fastUpdates,t,this._vvConvertOptions))return!1;var i={};r.mixin(i,this._fastUpdates.materialParameters),this._pathMaterial.setParameterValues(i);break;default:return!1}return!0},t.prototype.computeComplexity=function(){return{primitivesPerFeature:-4,primitivesPerCoordinate:this._profile.vertices.length/3*2,memory:h.defaultSymbolLayerMemoryComplexity(this.symbolContainer,this.symbol)}},t.prototype._getSymbolSize=function(){return this.symbol.size||1},t.prototype._createAs3DShape=function(e,t,a,r,n){var l={},p=e.geometry,h=p.paths,c=[],u=[],f=[],_=i.vec3f32.create(),x=this._context.renderSpatialReference,C=x===d.SphericalECEFSpatialReference,S=new Array(6),P=s.getGeometryVertexData3D(h,p.hasZ,p.spatialReference,this._context.renderSpatialReference,this._context.elevationProvider,this._context.renderCoordsHelper,a);if(this._logGeometryCreationWarnings(P,h,"paths","PathSymbol3DLayer"),h.length>0){for(var E=P.geometryData.outlines,D=P.eleVertexData,M=P.vertexData,U=0;U<E.length;++U){var V=E[U],w=V.index,G=V.count;if(!(G<2)&&(!this._context.clippingExtent||(s.computeBoundingBox(D,w,G,S),!s.boundingBoxClipped(S,this._context.clippingExtent)))){s.chooseOrigin(M,w,G,_),s.subtractCoordinates(M,w,G,_);var A=i.mat4f64.create();i.mat4.translate(A,A,_);var z=new g.Path(M,D,w,G,C,_),O=new g.Builder(z,this._profile,this._extruder);this._fastUpdates.enabled&&O.setVisualVariableValue(this.getFastUpdateAttrValues(e));var I=O.createGeometryData();if(this._pathMaterial.getParams().vertexColors){var R=this._getVertexOpacityAndColor(t);I=m.addVertexColors(I,R)}var T=new y(I,r+"path"+U);l[T.id]=O,T.singleUse=!0,c.push(T),u.push(this._pathMaterial),f.push(A)}}var B={layerUid:this._context.layer.uid,graphicUid:n,pathGeometryBuilder:l};if(c.length>0){var F=new v({geometries:c,materials:u,transformations:f,castShadow:!0,metadata:B,idHint:r}),L=b,j=new o(this,F,c,null,null,L,a);return j.alignedTerrainElevation=P.terrainElevation,j.needsElevationUpdates=s.needsElevationUpdates3D(a.mode),j}}return null},t}(l),C=f.VertexAttrConstants,S=i.vec3f64.create(),P=new n,E={verticalDistanceToGround:0,terrainElevation:0},D=10;return x});