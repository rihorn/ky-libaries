// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.10/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/extendsHelper","../../../../core/tsSupport/generatorHelper","../../../../core/Handles","../../../../core/Logger","../../../../core/now","../../../../core/PooledArray","../../../../core/watchUtils","../../../../core/libs/gl-matrix-2/gl-matrix","../../../../geometry/support/aaBoundingRect","./deconflictorDebug","../../support/debugFlags","../../support/earthUtils","../../support/geometryUtils","../../support/mathUtils","../../support/geometryUtils/sphere","../../webgl-engine/lib/screenSizePerspectiveUtils","../../webgl-engine/lib/Util","../../webgl-engine/materials/HUDMaterial","../../webgl-engine/materials/internal/MaterialUtil"],function(e,i,t,r,s,a,n,c,o,h,l,p,u,f,v,d,g,b,m,y,G){function w(e){var i,t,s,a;return r(this,function(r){switch(r.label){case 0:i=[];for(t in e)i.push(t);s=0,r.label=1;case 1:return s<i.length?(a=i[s],[4,e[a]]):[3,4];case 2:r.sent(),r.label=3;case 3:return s++,[3,1];case 4:return[2]}})}Object.defineProperty(i,"__esModule",{value:!0});var x,P=a.getLogger("esri.views.3d.graphics.Deconflictor"),D=h.vec4f64.create(),C=h.vec4f64.create(),S=h.vec4f64.create(),V=h.vec4f64.create(),M=h.vec3f64.fromValues(0,0,0),I=v.sphere.create(),B=v.ray.create(),R=h.vec3f64.create(),E=l.create(),A=l.create(),F=0,T=200,L=1e3,N=function(){function e(){this.xMin=0,this.xMax=0,this.yMin=0,this.yMax=0,this.posView=0,this.culled=!1,this.visible=!1,this.pooled=!1}return e}(),O=function(){function e(e,i,t){void 0===t&&(t={}),this.graphics3DGraphic=e,this.slicePlaneEnabled=i,this.info=t}return e}(),z=function(){function e(e,i){void 0===i&&(i=new Map),this.graphics3DCore=e,this.graphics=i}return e}();!function(e){e[e.Idle=0]="Idle",e[e.ProcessGraphics=1]="ProcessGraphics",e[e.ProcessLabels=2]="ProcessLabels",e[e.CleanGraphics=3]="CleanGraphics",e[e.CleanLabels=4]="CleanLabels",e[e.SortGraphics=5]="SortGraphics",e[e.SortLabels=6]="SortLabels",e[e.DeconflictGraphics=7]="DeconflictGraphics",e[e.DeconflictLabels=8]="DeconflictLabels"}(x||(x={}));var X=function(){function e(e){var i,t,r=this;this.handles=new s,this.delayedRunInterval=T,this.nextRunTimestamp=Number.POSITIVE_INFINITY,this.state=x.Idle,this.contexts=[],this.graphics=null,this.iterators=null,this.accBinsNumX=15,this.accBinsNumY=20,this.accBinsSizeX=0,this.accBinsSizeY=0,this.accBins=null,this.accNumTests=0,this.iconMarginFactor=-.1,this.slicePlaneViewSpace=null,this.view=e,this.graphics=(i={},i[0]={active:{},visible:new c,remove:new c},i[1]={active:{},visible:new c,remove:new c},i),this.iterators=(t={},t[0]={active:null,visible:null,remove:null,sort:null},t[1]={active:null,visible:null,remove:null,sort:null},t),this.handles.add([e.watch("state.camera",function(){r.updateSlicePlane(),r.setDirty(F)}),e.watch("map.ground.opacity",function(e,i){1!==e&&1!==i||r.setDirty(F)}),o.init(e,"qualityProfile",function(e){r.delayedRunInterval="low"===e?L:T}),o.init(e,"slicePlane",function(){return r.updateSlicePlane()})]),this.frameWorker=e.resourceController.registerFrameWorker(function(e){return r.run(e)},function(e){return r.shouldRun(e)})}return e.prototype.updateSlicePlane=function(){var e=this.view&&this.view.slicePlane;if(!e)return void(this.slicePlaneViewSpace&&(this.slicePlaneViewSpace=null,this.slicePlaneChanged()));this.slicePlaneViewSpace||(this.slicePlaneViewSpace=v.boundedPlane.create());var i=this.view.state.camera,t=i.viewMatrix;v.boundedPlane.transform(e,t,this.slicePlaneViewSpace),this.slicePlaneChanged()},e.prototype.slicePlaneChanged=function(){for(var e=0,i=this.contexts;e<i.length;e++){if(i[e].graphics3DCore.symbolCreationContext.slicePlaneEnabled){this.setDirty();break}}},e.prototype.destroy=function(){this.handles.destroy(),this.handles=null,this.frameWorker&&(this.frameWorker.remove(),this.frameWorker=null),this.graphics[0].active=null,this.graphics[0].visible.clear(),this.graphics[0].remove.clear(),this.graphics[1].active=null,this.graphics[1].visible.clear(),this.graphics[1].remove.clear(),this.graphics=null,this.iterators=null,this.view=null},e.prototype.addGraphicsOwner=function(e){var i=this,t=new z(e);this.contexts.push(t),this.setDirty(F);var r=new Y;return r.addGraphic=function(e){i.addGraphic(t,e)},r.removeGraphic=function(e){i.removeGraphic(t,e)},r.labelingInfoChange=function(){i.layerPropertyChanged(t,"labelingInfo")},r.featureReductionChange=function(){i.layerPropertyChanged(t,"featureReduction")},r.slicePlaneEnabledChange=function(){i.layerPropertyChanged(t,"slicePlaneEnabled")},r.clear=function(){t.graphics.forEach(function(e){i.removeGraphic(t,e.graphics3DGraphic)})},r},e.prototype.removeGraphicsOwner=function(e){var i=this,t=this.findDeconflictionContext(e);if(-1!==t){var r=this.contexts.splice(t,1)[0];r.graphics.forEach(function(e){i.removeGraphic(r,e.graphics3DGraphic)}),this.setDirty(F)}},e.prototype.setInitialIconVisibilityFlag=function(e,i){var t=!this.isFeatureReductionEnabled(e);i.setVisibilityFlag(2,t)},Object.defineProperty(e.prototype,"isDirty",{get:function(){return this.state!==x.Idle||this.nextRunTimestamp!==1/0},enumerable:!0,configurable:!0}),e.prototype.setDirty=function(e){void 0===e&&(e=this.delayedRunInterval),this.nextRunTimestamp>n()&&(this.nextRunTimestamp=n()+e)},e.prototype.shouldRun=function(e){return this.view.ready&&null!=this.view.state&&(this.nextRunTimestamp!==1/0&&this.nextRunTimestamp<=n()||this.state!==x.Idle)},e.prototype.run=function(e){switch(p.prepare(this.view),this.state){case x.Idle:this.nextRunTimestamp=1/0,this.camera=this.view.state.camera;var i=this.camera.fullWidth,t=this.camera.fullHeight;this.initBins(i,t),this.resetIterators();case x.ProcessGraphics:if(this.state=x.ProcessGraphics,!this.processActiveGraphics(0,e))return;case x.ProcessLabels:if(this.state=x.ProcessLabels,!this.processActiveGraphics(1,e))return;case x.CleanGraphics:if(this.state=x.CleanGraphics,!this.cleanVisibleGraphics(0,e))return;case x.CleanLabels:if(this.state=x.CleanLabels,!this.cleanVisibleGraphics(1,e))return;case x.SortGraphics:if(this.state=x.SortGraphics,!this.sortVisibleGraphics(0,e))return;case x.SortLabels:if(this.state=x.SortLabels,!this.sortVisibleGraphics(1,e))return;case x.DeconflictGraphics:if(this.state=x.DeconflictGraphics,!this.deconflictVisibleGraphics(0,e))return;p.drawAccelerationStruct(this,this.graphics[0].visible);case x.DeconflictLabels:if(this.state=x.DeconflictLabels,!this.deconflictVisibleGraphics(1,e))return;p.drawAccelerationStruct(this,this.graphics[1].visible);default:this.state=x.Idle}},e.prototype.findDeconflictionContext=function(e){for(var i=0;i<this.contexts.length;i++)if(this.contexts[i].graphics3DCore===e)return i;return-1},e.prototype.layerPropertyChanged=function(e,i){switch(i){case"featureReduction":var t=!!this.isFeatureReductionEnabled(e.graphics3DCore);this.setGraphicsVisibilityFlags(e,!t&&void 0),this.modifyGraphics(e,t,0);break;case"labelingInfo":var t=this.isLabelDeconflictionEnabled(e.graphics3DCore);this.modifyGraphics(e,t,1);break;case"slicePlaneEnabled":var r=e.graphics3DCore.symbolCreationContext.slicePlaneEnabled;e.graphics.forEach(function(e){e.slicePlaneEnabled=r}),this.setDirty(F)}},e.prototype.modifyGraphics=function(e,i,t){var r=(i?this.addToActiveGraphics:this.removeFromActiveGraphics).bind(this);e.graphics.forEach(function(e){r(e,t)}),this.setDirty(F)},e.prototype.addGraphic=function(e,i){var t=i.graphic.uid,r=new O(i,e.graphics3DCore.symbolCreationContext.slicePlaneEnabled);e.graphics.set(t,r),this.isFeatureReductionEnabled(e.graphics3DCore)&&this.addToActiveGraphics(r,0),this.isLabelDeconflictionEnabled(e.graphics3DCore)&&this.addToActiveGraphics(r,1),this.setDirty()},e.prototype.removeGraphic=function(e,i){var t=i.graphic.uid,r=e.graphics.get(t);r&&(this.removeFromActiveGraphics(r,0),this.removeFromActiveGraphics(r,1),e.graphics.delete(t),this.setDirty())},e.prototype.addToActiveGraphics=function(e,i){e.info[i]=new N;var t=e.graphics3DGraphic.graphic.uid;this.graphics[i].active[t]=e},e.prototype.removeFromActiveGraphics=function(e,i){this.removeFromVisibleGraphics(e,i),this.resetGraphicVisibility(e,i),delete e.info[i];var t=e.graphics3DGraphic.graphic.uid;delete this.graphics[i].active[t]},e.prototype.addToVisibleGraphics=function(e,i){var t=e.info[i];t&&!t.pooled&&(this.graphics[i].visible.push(e),t.pooled=!0)},e.prototype.removeFromVisibleGraphics=function(e,i){var t=e.info[i];t&&t.pooled&&(this.graphics[i].remove.push(e),t.pooled=!1)},e.prototype.processActiveGraphics=function(e,i){for(var t=this.getOrCreateActiveGraphicsIterator(e),r="global"===this.view.viewingMode&&1===this.view.map.ground.opacity&&this.camera&&this.camera.relativeElevation>0;!i.done();){var s=t.next();if(s.done)return this.resetActiveGraphicsIterator(e),!0;var a=s.value,n=a&&a.info[e];n&&(this.collectGraphics3DGraphics(a,e,r),n.culled?this.removeFromVisibleGraphics(a,e):this.addToVisibleGraphics(a,e))}return!1},e.prototype.cleanVisibleGraphics=function(e,i){for(var t=this.graphics[e],r=this.getOrCreateRemoveGraphicsIterator(e,i);!i.done();){if(r.next().done)return t.remove.clear(),this.resetRemoveGraphicsIterator(e),!0}return!1},e.prototype.sortVisibleGraphics=function(e,i){for(var t=this.getOrCreateSortGraphicsIterator(e,function(i,t){return i.info[e]&&t.info[e]?t.info[e].posView-i.info[e].posView:Number.MAX_VALUE},i);!i.done();){if(t.next().done)return this.resetSortGraphicsIterator(e),!0}return!1},e.prototype.deconflictVisibleGraphics=function(e,i){for(var t=this.getOrCreateVisibleGraphicsIterator(e),r=1===e;!i.done();){var s=t.next();if(s.done)return this.resetVisibleGraphicsIterator(e),!0;var a=s.value,n=a.info[e];if(n&&!n.culled){var c=a.graphics3DGraphic,o=r&&!1===c.areVisibilityFlagsSet(2),h=!o&&!this.doesIntersectExistingPoly(a,e);n.visible=h,h&&this.addToBins(a,e),this.setGraphicVisibility(a,e,h),p.drawPoly(n,h?"green":"red")}}return!1},e.prototype.resetIterators=function(){this.iterators[0].active=null,this.iterators[0].visible=null,this.iterators[0].remove=null,this.iterators[0].sort=null,this.iterators[1].active=null,this.iterators[1].visible=null,this.iterators[1].remove=null,this.iterators[1].sort=null},e.prototype.getOrCreateActiveGraphicsIterator=function(e){var i=this.graphics[e],t=this.iterators[e];return t.active||(t.active=w(i.active)),t.active},e.prototype.resetActiveGraphicsIterator=function(e){this.iterators[e].active=null},e.prototype.getOrCreateVisibleGraphicsIterator=function(e){var i=this.graphics[e],t=this.iterators[e];return t.visible||(t.visible=i.visible.iterableForEach()),t.visible},e.prototype.resetVisibleGraphicsIterator=function(e){this.iterators[e].visible=null},e.prototype.getOrCreateRemoveGraphicsIterator=function(e,i){var t=this.graphics[e],r=this.iterators[e];return r.remove||(r.remove=t.visible.iterableRemoveMany(t.remove.data,function(){return i.done()})),r.remove},e.prototype.resetRemoveGraphicsIterator=function(e){this.iterators[e].remove=null},e.prototype.getOrCreateSortGraphicsIterator=function(e,i,t){var r=this.graphics[e],s=this.iterators[e];return s.sort||(s.sort=r.visible.iterableSort(i,function(){return t.done()})),s.sort},e.prototype.resetSortGraphicsIterator=function(e){this.iterators[e].sort=null},e.prototype.collectGraphics3DGraphics=function(e,i,t){var r=e.graphics3DGraphic;if(!r.destroyed){var s=1===i,a=s?r._labelGraphics:r._graphics,n=s?0:this.iconMarginFactor,c=e.info[i];if(!r.areVisibilityFlagsSet(0))return void(c.culled=!0);if(a&&a.length){for(var o,p,w=l.empty(E),x=0,F=a;x<F.length;x++){var T=F[x];if(T&&"object3d"===T.type){var L=T.stageObject,N=L?L.getNumGeometryRecords():0;if(!(N<1)){var O=L.getGeometryRecord(0),z=O.material;if(z instanceof y)if(N>1)P.warn("Graphic objects with more than 1 geometry record are not supported");else{var X=this.camera,Y=O.geometry.data,W=Y.getVertexAttr();if(t&&(I.radius=f.earthRadius,h.vec3.sub(B.direction,L.getCenter(),this.camera.eye),h.vec3.copy(B.origin,this.camera.eye),g.intersectRay(I,B,R))){var _=Math.abs(Math.tan(h.vec3.angle(L.getCenter(),B.direction))),j=1-_/this.view.width,H=Math.pow(j,4),q=h.vec3.sqrDist(this.camera.eye,R),J=h.vec3.sqrDist(this.camera.eye,L.getCenter());if(H*J>q)return void(c.culled=!0)}if(!p){var K=L.getCenter(),Q=O.origin.vec3;G.transformToWorld(K,Q,D),G.transformToView(D,Q,X.viewMatrix,C);var Z=W[m.VertexAttrConstants.NORMAL].data;if(z.applyVerticalOffsetTransformation(C,Z,L.objectTransformation,X,U),e.slicePlaneEnabled&&this.slicePlaneViewSpace&&v.boundedPlane.extrusionContainsPoint(this.slicePlaneViewSpace,C))return void(c.culled=!0);var $=W[m.VertexAttrConstants.AUXPOS1].data,ee="screen"!==z.getParams().centerOffsetUnits,ie=ee?$:M;G.transformToProjection(C,X.projectionMatrix,ie,S),p=G.transformToNDC(S,V),ee||(p[0]+=$[0]/X.fullWidth*2,p[1]+=$[1]/X.fullHeight*2);var te=p[0]<-1||p[1]<-1||p[2]<-1||p[0]>=1||p[1]>=1;if(te)break;o=C[2],!u.DISABLE_DECONFLICTOR_VISIBILITY_OFFSET&&c.visible&&(o*=.7)}var re=T.getScreenSize(k);b.applyPrecomputedScaleFactorVec2(re,U.factor,re);var se=l.offset(z.calculateRelativeScreenBounds(re,U.scaleAlignment,A),d.lerp(0,X.fullWidth,.5+.5*p[0]),d.lerp(0,X.fullHeight,.5+.5*p[1]));if(0!==n){var ae=n*Math.min(l.width(se),l.height(se));se[0]-=ae,se[1]-=ae,se[2]+=ae,se[3]+=ae}l.expand(w,se)}}}}null!=o?(c.xMin=w[0],c.yMin=w[1],c.xMax=w[2],c.yMax=w[3],c.posView=o,c.culled=!1):c.culled=!0}}},e.prototype.doesIntersectExistingPoly=function(e,i){for(var t=e.graphics3DGraphic.graphic.uid,r=e.info[i],s=Math.floor(r.xMin/this.accBinsSizeX);s<=Math.floor(r.xMax/this.accBinsSizeX);s++)if(!(s<0||s>=this.accBinsNumX))for(var a=Math.floor(r.yMin/this.accBinsSizeY);a<=Math.floor(r.yMax/this.accBinsSizeY);a++)if(!(a<0||a>=this.accBinsNumY))for(var n=this.accBins[s][a],c=0;c<n.length;c++){var o=n.data[c],h=o.info[i];if(h&&h.visible&&(o.graphics3DGraphic.graphic.uid!==t&&(this.accNumTests++,!(h.xMin>r.xMax||h.xMax<r.xMin||h.yMin>r.yMax||h.yMax<r.yMin))))return!0}return!1},e.prototype.initBins=function(e,i){if(null==this.accBins){this.accBins=[];for(var t=0;t<this.accBinsNumX;t++){this.accBins.push([]);for(var r=this.accBins[this.accBins.length-1],s=0;s<this.accBinsNumY;s++)r.push(new c)}}for(var t=0;t<this.accBinsNumX;t++)for(var s=0;s<this.accBinsNumY;s++)this.accBins[t][s].clear();this.accBinsSizeX=e/this.accBinsNumX,this.accBinsSizeY=i/this.accBinsNumY,this.accNumTests=0},e.prototype.addToBins=function(e,i){for(var t=e.info[i],r=Math.floor(t.xMin/this.accBinsSizeX);r<=Math.floor(t.xMax/this.accBinsSizeX);r++)if(!(r<0||r>=this.accBinsNumX))for(var s=Math.floor(t.yMin/this.accBinsSizeY);s<=Math.floor(t.yMax/this.accBinsSizeY);s++)s<0||s>=this.accBinsNumY||this.accBins[r][s].push(e)},e.prototype.isFeatureReductionEnabled=function(e){var i=e.layer;return!(!i||!i.featureReduction||"selection"!==i.featureReduction.type)},e.prototype.isLabelDeconflictionEnabled=function(e){return e.labelsEnabled},e.prototype.setGraphicsVisibilityFlags=function(e,i){var t=e.graphics3DCore,r=t.graphics3DGraphics;r&&r.forEach(function(e){return e.setVisibilityFlag(2,i)})},e.prototype.setGraphicVisibility=function(e,i,t){var r=e.graphics3DGraphic;r.destroyed||(r.setVisibilityFlag(2,t,i),1===i&&void 0!==t&&this.view.labeler.setLabelGraphicVisibility(r,t))},e.prototype.resetGraphicVisibility=function(e,i){this.setGraphicVisibility(e,i,void 0)},e}();i.Deconflictor=X;var Y=function(){function e(){}return e}();i.GraphicsOwner=Y;var U={factor:{scale:0,factor:0,minPixelSize:0,paddingPixels:0},scaleAlignment:0,minPixelSizeAlignment:0},k=h.vec2f64.create()});