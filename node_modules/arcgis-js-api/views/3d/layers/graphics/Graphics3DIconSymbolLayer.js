// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.10/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/assignHelper","../../../../core/tsSupport/extendsHelper","dojo/errors/CancelError","../../../../Color","../../../../core/Error","../../../../core/has","../../../../core/lang","../../../../core/promiseUtils","../../../../core/screenUtils","../../../../core/urlUtils","../../../../core/libs/gl-matrix-2/gl-matrix","../../../../symbols/support/utils","./ElevationAligners","./Graphics3DDrapedGraphicLayer","./Graphics3DObject3DGraphicLayer","./Graphics3DSymbolCommonCode","./Graphics3DSymbolLayer","./graphicUtils","./SignedDistanceFunctions","../support/FastSymbolUpdates","../../support/projectionUtils","../../webgl-engine/Stage","../../webgl-engine/lib/Geometry","../../webgl-engine/lib/GeometryUtil","../../webgl-engine/lib/RenderGeometry","../../webgl-engine/lib/Texture","../../webgl-engine/materials/HUDMaterial"],function(e,t,i,r,a,s,n,o,l,u,c,h,d,p,_,f,m,g,v,y,S,b,x,z,R,P,C,I,M){function V(e){return"cross"===e||"x"===e}function O(e){var t,i=w,r=i*L;switch("primitive:"===e.substring(0,10)&&(e=e.substring(10)),e){case j.PRIM_CIRCLE:t=S.computeSignedDistancefieldCicle(i,r);break;case j.PRIM_SQUARE:t=S.computeSignedDistancefieldSquare(i,r,!1);break;case j.PRIM_KITE:t=S.computeSignedDistancefieldSquare(i,r,!0);break;case j.PRIM_CROSS:t=S.computeSignedDistancefieldCrossAndX(i,r,!1);break;case j.PRIM_X:t=S.computeSignedDistancefieldCrossAndX(i,r,!0)}return new I(t,"sdf_"+e,{mipmap:!1,wrap:{s:33071,t:33071},width:w,height:w,components:4})}var E=d.mat4f64.create(),U=d.vec3f64.fromValues(0,0,1),A=[0,0,0,0],D=d.vec3f64.fromValues(0,0,0),T=d.vec3f64.fromValues(1,1,1),G=["center","bottom","top","left","right","bottom-left","bottom-right","top-left","top-right"],w=128,L=.5,F=[L/2,L/2,1-L/2,1-L/2],j={PRIM_CIRCLE:"circle",PRIM_SQUARE:"square",PRIM_CROSS:"cross",PRIM_X:"x",PRIM_KITE:"kite"},q=[w*L,w*L],B=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!0},t}return r(t,e),t.prototype._prepareResources=function(){var e=this.symbol,t=Math.round(null!=e.size?c.pt2px(e.size):16);this._size=null,this._symbolTextureRatio=1,this._primitive=null;var i=this._getStageIdHint();if(!this._isPropertyDriven("size")){var r=y.validateSymbolLayerSize(t);if(r)return this._logWarning(r),void this.reject()}this._isPropertyDriven("size")&&t<64&&(t=64);var a=e.resource||{primitive:"circle",href:void 0},s={anchorPos:this._getAnchorPos(e)},n=this.symbolContainer;if(this._hasVisibleVerticalOffset(n)){var o=n.verticalOffset,l=o.screenLength,u=o.minWorldLength,h=o.maxWorldLength;s.verticalOffset={screenLength:c.pt2px(l),minWorldLength:u||0,maxWorldLength:null!=h?h:1/0}}if(this._context.screenSizePerspectiveEnabled&&(s.screenSizePerspective=this._context.sharedResources.screenSizePerspectiveSettings),a.href)this._outlineSize=this._getOutlineSize(e,null),s.color=this._getFillColor(e,null),s.outlineColor=this._getOutlineColor(e),s.outlineSize=this._outlineSize,s.textureIsSignedDistanceField=!1,this._prepareImageResources(t,s,i);else{var d=a.primitive||"circle",p="primitive:"+d;if(this._primitive=d,this._outlineSize=this._getOutlineSize(e,d),s.color=this._getFillColor(e,d),s.outlineColor=this._getOutlineColor(e),s.outlineSize=this._outlineSize,V(d)&&0===s.outlineSize)return void this.reject();this.texture=this._context.sharedResources.textures.acquire(p,O),this._textureURI=p,s.textureIsSignedDistanceField=!0,s.distanceFieldBoundingBox=F,s.textureId=this.texture.id,this._size=[t,t],this._symbolTextureRatio=1/L,this._createMaterialsAndAddToStage(s,this._context.stage,i),this.resolve()}},t.prototype._getOutlineSize=function(e,t){var i=0;return i=e.outline&&null!=e.outline.size?c.pt2px(e.outline.size):V(t)?1.5:0,Math.max(i,0)},t.prototype._getOutlineColor=function(e){var t=this._getLayerOpacity();if(e.outline){if(null!=e.outline.color){var i=s.toUnitRGB(e.outline.color),r=e.outline.color.a*t;return[i[0],i[1],i[2],r]}return[0,0,0,t]}return[0,0,0,t]},t.prototype._getFillColor=function(e,t){return V(t)?A:this._getMaterialOpacityAndColor()},t.prototype._getAnchorPos=function(e){return G.indexOf(e.anchor)>-1?e.anchor:"center"},t.prototype._prepareImageResources=function(e,t,i){var r=this,s=function(a){if(!r.isRejected()){var s=a.params,n=s.width/s.height;r._size=e?n>1?[e,Math.round(e/n)]:[Math.round(e*n),e]:[s.width,s.height],t.textureId=a.id,r._createMaterialsAndAddToStage(t,r._context.stage,i),r.resolve()}},l=p.getIconHref(this.symbolContainer,this.symbol);if(!o("esri-canvas-svg-support")&&h.isSVG(l)){var c="IconSymbol3DLayer failed to load (SVG symbols are not supported in IE11)";return this._logWarning(c),void this.reject(new n("SVG Not Supported",c))}u.when(this._context.sharedResources.textures.acquire(l,e)).then(s,function(e){if(e instanceof a)r.reject();else{var t="IconSymbol3DLayer failed to load (Request for icon resource failed: "+l+")";r._logWarning(t),r.reject(new n("Request Failed",t))}}),this._textureURI=l},t.prototype._createMaterialsAndAddToStage=function(e,t,r){this._fastUpdates=b.initFastSymbolUpdatesState(this._context.renderer,this._fastVisualVariableConvertOptions()),this._fastUpdates.enabled&&l.mixin(e,this._fastUpdates.materialParameters);var a=i({},e);a.verticalOffset=null,a.screenSizePerspective=null,a.occlusionTest=!1,a.slicePlaneEnabled=!1,a.shaderPolygonOffset=0,this._drapedMaterial=new M(a,r+"_iconDraped"),t.add(z.ModelContentType.MATERIAL,this._drapedMaterial),e.occlusionTest=!0,e.slicePlaneEnabled=this._context.slicePlaneEnabled,this._material=new M(e,r+"_icon"),t.add(z.ModelContentType.MATERIAL,this._material)},t.prototype.destroy=function(){e.prototype.destroy.call(this),this.isFulfilled()||this.reject(),this._material&&(this._context.stage.remove(z.ModelContentType.MATERIAL,this._material.id),this._material=null),this._drapedMaterial&&(this._context.stage.remove(z.ModelContentType.MATERIAL,this._drapedMaterial.id),this._drapedMaterial=null),this._textureURI&&(this._context.sharedResources.textures.release(this._textureURI),this._textureURI=null)},t.prototype._getScaleFactor=function(e){if(this._isPropertyDriven("size")&&e.size){for(var t=0;t<3;t++){var i=e.size[t];i&&"symbolValue"!==i&&"proportional"!==i&&(e.size[t]=c.pt2px(i))}var r=this._size[0]>this._size[1]?this._size[0]:this._size[1];if("symbolValue"===e.size[0])return 1;if(isFinite(+e.size[0]))return+e.size[0]/r;if(isFinite(+e.size[2]))return+e.size[2]/r}return 1},t.prototype.createGraphics3DGraphic=function(e){var t=e.renderingInfo,i=e.graphic;if(!this._validateGeometry(i.geometry))return null;var r=g.placePointOnGeometry(i.geometry);if(!r)return this._logWarning("unsupported geometry type for icon symbol: "+i.geometry.type),null;var a="graphic"+i.uid,s=this._getVertexOpacityAndColor(t),n=1;this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size||(n=this._getScaleFactor(t)),n*=this._symbolTextureRatio;var o=[this._size[0]*n,this._size[1]*n],l=this.getGraphicElevationContext(i);return"on-the-ground"===l.mode?this._createAsOverlay(i,r,s,o,l,a,i.uid):this._createAs3DShape(i,r,s,o,l,a,i.uid)},t.prototype.layerOpacityChanged=function(){var e=this._getFillColor(this.symbol,this._primitive);this._drapedMaterial.setParameterValues({color:e}),this._material.setParameterValues({color:e});var t=this._getOutlineColor(this.symbol);return this._drapedMaterial.setParameterValues({outlineColor:t}),this._material.setParameterValues({outlineColor:t}),!0},t.prototype.layerElevationInfoChanged=function(e,t,i){var r=this._elevationContext.mode;if("on-the-ground"===i&&"on-the-ground"===r)return!0;if(i!==r&&("on-the-ground"===i||"on-the-ground"===r))return!1;var a=g.needsElevationUpdates2D(r)||"absolute-height"===r;return this.updateGraphics3DGraphicElevationInfo(e,t,function(){return a})},t.prototype.slicePlaneEnabledChanged=function(e,t){return this._material.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled}),!0},t.prototype.applyRendererDiff=function(e,t){for(var i in e.diff)switch(i){case"visualVariables":if(!b.updateFastSymbolUpdatesState(this._fastUpdates,t,this._fastVisualVariableConvertOptions()))return!1;this._material.setParameterValues(this._fastUpdates.materialParameters),this._drapedMaterial.setParameterValues(this._fastUpdates.materialParameters);break;default:return!1}return!0},t.prototype.setDrawOrder=function(e,t,i){this.updateSymbolLayerOrder(e,t),this._drapedMaterial&&(this._drapedMaterial.renderPriority=e,i.add(this._drapedMaterial.id))},t.prototype._defaultElevationInfoNoZ=function(){return W},t.prototype._createAs3DShape=function(e,t,i,r,a,s,n){var o=this,l=this.getFastUpdateAttrValues(e),u=l?function(e){return b.evaluateModelTransform(o._fastUpdates.materialParameters,l,e)}:null,c=P.createPointGeometry(U,null,i,r,k,null,l),h=new R(c,s),d=[h],p=g.createStageObjectForPoint(this._context,t,d,[this._material],null,null,a,s,this._context.layer.uid,n,!0,u);if(null===p)return null;var f=_.perObjectElevationAligner,v=new m(this,p.object,d,null,null,f,a);return v.alignedTerrainElevation=p.terrainElevation,v.needsElevationUpdates=g.needsElevationUpdates2D(a.mode)||"absolute-height"===a.mode,v.getScreenSize=this._createScreenSizeGetter(r,u),v.calculateRelativeScreenBounds=function(e){return o._material.calculateRelativeScreenBounds(v.getScreenSize(),1,e)},g.extendPointGraphicElevationContext(v,t,this._context.elevationProvider),v},t.prototype._createAsOverlay=function(e,t,i,r,a,s,n){var o=this;this._drapedMaterial.renderPriority=this._symbolLayerOrder;var l=d.vec3f64.create();x.pointToVector(t,l,this._context.overlaySR),l[2]=this._getDrapedZ();var u=this._context.clippingExtent;if(u&&!g.pointInBox2D(l,u))return null;var c=this.getFastUpdateAttrValues(e),h=c?function(e){return b.evaluateModelTransform(o._fastUpdates.materialParameters,c,e)}:null,p=P.createPointGeometry(U,l,i,r,null,null,c),_=new C(p);_.material=this._drapedMaterial,_.center=l,_.bsRadius=0,_.transformation=E,_.name=s,_.uniqueName=s+"#"+p.id;var m=new f(this,[_],null);return m.getScreenSize=this._createScreenSizeGetter(r,h),m.calculateRelativeScreenBounds=function(e){return o._drapedMaterial.calculateRelativeScreenBounds(m.getScreenSize(),1,e)},m},t.prototype._createScreenSizeGetter=function(e,t){var i=this._outlineSize+2;if(this._fastUpdates.enabled){var r=e[0]/this._symbolTextureRatio,a=e[1]/this._symbolTextureRatio;return function(e){void 0===e&&(e=d.vec2f64.create());var s=t(E);return e[0]=s[0]*r+i,e[1]=s[5]*a+i,e}}var s=e[0]/this._symbolTextureRatio+i,n=e[1]/this._symbolTextureRatio+i;return function(e){return void 0===e&&(e=d.vec2f64.create()),e[0]=s,e[1]=n,e}},t.prototype._fastVisualVariableConvertOptions=function(){var e=this._size[0]>this._size[1]?this._size[0]:this._size[1],t=d.vec3f64.fromValues(e,e,e),i=c.px2pt(1),r=e*i;return{modelSize:t,symbolSize:d.vec3f64.fromValues(r,r,r),unitInMeters:i,transformation:{anchor:D,scale:T,rotation:D}}},t.prototype._hasVisibleVerticalOffset=function(e){return this.symbolContainer&&"point-3d"===this.symbolContainer.type&&this.symbolContainer.hasVisibleVerticalOffset()},t.PRIMITIVE_SIZE=q,t.VALID_ANCHOR_STRINGS=G,t}(v),W={mode:"relative-to-ground",offset:0},k=d.vec4f64.fromValues(0,0,0,1);return B});