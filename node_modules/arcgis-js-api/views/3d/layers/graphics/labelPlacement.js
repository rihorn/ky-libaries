// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.10/esri/copyright.txt for details.

define(["require","exports","../../../../core/compilerUtils","../../../../core/Logger","../../../../core/scheduling","../../../../core/libs/gl-matrix-2/gl-matrix","../../../../geometry/support/aaBoundingBox","./graphicUtils","../../webgl-engine/materials/HUDMaterial"],function(e,t,r,a,n,l,c,i,o){function s(e){var t=y(e);if(!t)return null;var r=f(e,t),a=e.graphics3DGraphic._graphics[0],n=a.graphics3DSymbolLayer,c=n.getGraphicElevationContext(e.graphics3DGraphic.graphic),i="draped"===a.type,o=r.anchor,s=!!t.hasLabelVerticalOffset,h=t.verticalOffset,p=i?void 0:c.hasOffsetAdjustment,m={anchor:o,needsOffsetAdjustment:p,verticalOffset:h,screenOffset:l.vec2f64.create(),centerOffset:l.vec4f64.fromValues(0,0,0,-1),centerOffsetUnits:"world",translation:l.vec3f64.create(),elevationOffset:0,hasLabelVerticalOffset:s};return b(m,r,e),m}function f(e,t){if(t.anchor)return t;var r=e.labelClass.labelPlacement,a=z[r],n=a||p(e);return r&&!a&&m("warn","the requested label placement '"+r+"' is not currently supported in SceneView"),h(n,e)}function h(e,t){var r=t.graphics3DGraphic.graphic.geometry.type,a=t.labelClass.labelPlacement;switch(r){case"polyline":case"polygon":case"extent":case"multipoint":if(a)return m("warn","the requested label placement '"+e.placement+"' is currently unsupported for '"+r+"' geometries in SceneView"),z["center-center"]}return e}function p(e){var t=e.graphics3DGraphic.graphic.geometry.type;switch(t){case"polyline":case"polygon":case"extent":case"multipoint":return{placement:"center-center",normalizedOffset:null,anchor:"center"};case"point":case"mesh":return z["above-center"];default:r.neverReached(t)}}function m(e,t){null==P&&(w.log(e,t),P=n.schedule(function(){P.remove(),P=null}))}function b(e,t,r){switch(r.graphics3DGraphic.graphic.geometry.type){case"point":u(e,t,r);break;case"mesh":d(e,t,r)}}function u(e,t,r){var a=r.graphics3DGraphic,n=a.graphics3DSymbol,l=i.getGraphics3DSymbol(n),c=l.symbol.symbolLayers.getItemAt(0);switch(a.getCenterObjectSpace(e.translation),c.type){case"icon":case"text":g(e,t,r);break;case"object":d(e,t,r)}}function g(e,t,r){var a=r.graphics3DGraphic,n=a._graphics[0],l=n.getScreenSize();if(a.isDraped())e.hasLabelVerticalOffset||"center"===e.anchor||(z[r.labelClass.labelPlacement]&&m("warn","the requested placement '"+t.placement+"' is currently unsupported for draped graphics"),e.anchor="center");else{var c=v(r);C[0]=l[0]/2*(t.normalizedOffset[0]-c[0]),C[1]=l[1]/2*(t.normalizedOffset[1]-c[1]),e.screenOffset[0]=C[0],e.hasLabelVerticalOffset?(e.centerOffset[1]=C[1],e.centerOffsetUnits="screen"):e.screenOffset[1]=C[1]}}function v(e,t){void 0===t&&(t=V);var r=e.graphics3DGraphic,a=r._graphics[0],n=a.stageObject.getGeometryRecords()[0].material;if(n instanceof o){var l=n.getParams().anchorPos;t[0]=2*(l[0]-.5),t[1]=2*(l[1]-.5)}else t[0]=0,t[1]=0;return t}function d(e,t,r){var a=r.graphics3DGraphic._graphics[0],n=a.getBoundingBoxObjectSpace(G),c=l.vec3f64.fromValues(n[3]-n[0],n[4]-n[1],n[5]-n[2]),i=Math.max(c[0],c[1]);e.centerOffset[0]=1.1*i/2*t.normalizedOffset[0];var o=c[2]/2*t.normalizedOffset[1]+e.translation[2];e.translation[2]=o*(1.1-1),e.elevationOffset=o;var s=l.vec3.length(c);e.centerOffset[2]=1.1*s/2*t.normalizedOffset[2]}function O(e){switch(e){case"above-center":return!0;default:return!1}}function y(e){var t=e.labelClass.labelPlacement,r=e.labelSymbol,a=e.graphics3DGraphic,n=i.getGraphics3DSymbol(a.graphics3DSymbol),l=n.symbol,c=z[t]||p(e);return"point-3d"===l.type&&l.supportsCallout()&&l.hasVisibleVerticalOffset()&&!a.isDraped()?{placement:null,hasLabelVerticalOffset:!1,verticalOffset:L(l.verticalOffset),anchor:null,normalizedOffset:null}:!r||!r.hasVisibleVerticalOffset()||"point-3d"===l.type&&l.supportsCallout()&&l.verticalOffset&&!a.isDraped()?{placement:null,verticalOffset:null,anchor:null,normalizedOffset:null,hasLabelVerticalOffset:!1}:O(c.placement)?{placement:"above-center",verticalOffset:L(r.verticalOffset),anchor:"bottom",normalizedOffset:[0,c.normalizedOffset[1],0],hasLabelVerticalOffset:!0}:(m("error","Callouts and vertical offset on labels are currently only supported with 'above-center' label placement (not with "+t+" placement)"),null)}function L(e){return{screenLength:e.screenLength,minWorldLength:e.minWorldLength,maxWorldLength:e.maxWorldLength}}Object.defineProperty(t,"__esModule",{value:!0});var w=a.getLogger("esri.views.3d.layers.graphics.labelPlacement"),P=null;t.get=s;var z={"above-center":{placement:"above-center",normalizedOffset:[0,1,0],anchor:"bottom"},"above-left":{placement:"above-left",normalizedOffset:[-1,1,0],anchor:"bottom-right"},"above-right":{placement:"above-right",normalizedOffset:[1,1,0],anchor:"bottom-left"},"below-center":{placement:"below-center",normalizedOffset:[0,-1,2],anchor:"top"},"below-left":{placement:"below-left",normalizedOffset:[-1,-1,0],anchor:"top-right"},"below-right":{placement:"below-right",normalizedOffset:[1,-1,0],anchor:"top-left"},"center-center":{placement:"center-center",normalizedOffset:[0,0,1],anchor:"center"},"center-left":{placement:"center-left",normalizedOffset:[-1,0,0],anchor:"right"},"center-right":{placement:"center-right",normalizedOffset:[1,0,0],anchor:"left"}},S={"above-center":["default","esriServerPointLabelPlacementAboveCenter"],"above-left":["esriServerPointLabelPlacementAboveLeft"],"above-right":["esriServerPointLabelPlacementAboveRight"],"below-center":["esriServerPointLabelPlacementBelowCenter"],"below-left":["esriServerPointLabelPlacementBelowLeft"],"below-right":["esriServerPointLabelPlacementBelowRight"],"center-center":["esriServerPointLabelPlacementCenterCenter"],"center-left":["esriServerPointLabelPlacementCenterLeft"],"center-right":["esriServerPointLabelPlacementCenterRight"]};for(var D in S)!function(e){var t=S[e],r=z[e];t.forEach(function(e){z[e]=r})}(D);Object.freeze&&(Object.freeze(z),Object.keys(z).forEach(function(e){Object.freeze(z[e]),Object.freeze(z[e].normalizedOffset)}));var C=[0,0],V=[0,0],G=c.create()});