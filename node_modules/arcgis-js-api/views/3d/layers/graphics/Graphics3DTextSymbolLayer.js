// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.10/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/extendsHelper","../../../../Color","../../../../core/screenUtils","../../../../core/libs/gl-matrix-2/gl-matrix","../../../../symbols/callouts/calloutUtils","./ElevationAligners","./Graphics3DObject3DGraphicLayer","./Graphics3DSymbolCommonCode","./Graphics3DSymbolLayer","./graphicUtils","../../webgl-engine/lib/Geometry","../../webgl-engine/lib/GeometryUtil","../../webgl-engine/lib/TextTexture","../../webgl-engine/materials/HUDMaterial"],function(e,t,n,i,o,r,a,l,s,c,h,f,p,d,u,g){function v(e,t,n){e&&e.forEach(function(e){var i=t(e);i&&n(i,e.graphic)})}var y=[1,1,1,1],m=[0,0,1],x={mode:"relative-to-ground",offset:0},b=[0,0,0,1];return function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!1},t}return n(t,e),t.prototype._prepareResources=function(){if(!this._isPropertyDriven("size")){var e=f.validateSymbolLayerSize(this._getTextSize());if(e)return this._logWarning(e),void this.reject()}this._anchor="center",this.resolve()},t.prototype.destroy=function(){e.prototype.destroy.call(this),this.isFulfilled()||this.reject()},t.prototype.createGraphics3DGraphic=function(e,t,n,i){void 0===t&&(t={});var o=e.graphic,r=c.placePointOnGeometry(o.geometry);if(!r)return this._logWarning("unsupported geometry type for text symbol: "+o.geometry.type),null;var a=t.text||this.symbol.text;if(!a||a.length<1)return null;null!=t.needsOffsetAdjustment&&(this._elevationOptions.needsOffsetAdjustment=t.needsOffsetAdjustment);var l=this.getGraphicElevationContext(o,t.elevationOffset||0),s=this._context.layer.id+"_label_"+o.uid,h="polyline"===o.geometry.type;return this._createAs3DShape(this.symbol,r,a,l,s,o.uid,t,n,i,h)},t.prototype.getGraphicElevationContext=function(t,n){void 0===n&&(n=0);var i=e.prototype.getGraphicElevationContext.call(this,t);return i.addOffsetRenderUnits(n),i},t.prototype.layerOpacityChanged=function(){return this._logWarning("layer opacity change not yet implemented in Graphics3DTextSymbolLayer"),!1},t.prototype.layerElevationInfoChanged=function(e,t){var n=this;return v(e,t,function(e,t){n.updateGraphicElevationContext(t,e)}),!0},t.prototype.slicePlaneEnabledChanged=function(e,t){var n=this;return v(e,t,function(e){for(var t=0,i=e.stageObject.geometryRecords;t<i.length;t++){i[t].material.setParameterValues({slicePlaneEnabled:n._context.slicePlaneEnabled})}}),!0},t.prototype.updateGraphicElevationContext=function(e,t){var n=this.getGraphicElevationContext(e,t.metadata.elevationOffset);t.elevationContext.set(n),t.needsElevationUpdates=c.needsElevationUpdates2D(n.mode)||"absolute-height"===n.mode},t.prototype._defaultElevationInfoNoZ=function(){return x},t.prototype._createAs3DShape=function(e,t,n,h,f,v,x,O,S,_){var E=x.centerOffset||b,G=x.screenOffset||[0,0],P=x.debugDrawBorder||!1,C=x.translation||[0,0,0],w=x.anchor||this._anchor||"center";this._anchor=w;var z,D=e.material?i.toUnitRGBA(e.material.color):y,U=e.halo&&e.halo.color&&e.halo.size>0,j=U?i.toUnitRGBA(e.halo.color):y,A=U?o.pt2px(e.halo.size):0,L=this._getTextSize(e),T=new u(n,{size:L,color:D,font:{family:e.font&&e.font.family?e.font.family:"sans-serif",weight:e.font&&e.font.weight?e.font.weight:"normal",style:e.font&&e.font.style?e.font.style:"normal"},halo:{size:A,color:j}},f);O?z=x:a.isCalloutSupport(this.symbolContainer)&&this.symbolContainer.hasVisibleVerticalOffset()&&(z=this.symbolContainer);var W={textureId:S?S.textureId:T.id,texCoordScale:S?[1,1]:T.texcoordScale,occlusionTest:!0,screenOffset:G,anchorPos:w,polygonOffset:!0,color:[1,1,1,1],centerOffsetUnits:x.centerOffsetUnits,debugDrawBorder:P,drawInSecondSlot:!0};if(z&&z.verticalOffset){var R=z.verticalOffset,I=R.screenLength,B=R.minWorldLength,H=R.maxWorldLength;W.verticalOffset={screenLength:o.pt2px(I),minWorldLength:B||0,maxWorldLength:null!=H?H:1/0}}if(this._context.screenSizePerspectiveEnabled){var M=this._context.sharedResources,V=M.screenSizePerspectiveSettings,F=M.screenSizePerspectiveSettingsLabels;W.screenSizePerspective=F.overridePadding(A),W.screenSizePerspectiveAlignment=V}_&&(W.shaderPolygonOffset=1e-4),W.slicePlaneEnabled=this._context.slicePlaneEnabled;var N=null,q=JSON.stringify(W);null!=O?null==(N=O.getMaterial(q))&&(N=new g(W,f),O.addMaterial(q,N)):N=new g(W,f);var J=[N],Z=d.createPointGeometry(m,C,void 0,S?[0,0]:[T.textWidth,T.textHeight],E,S?[0,0]:null),k=[new p(Z,f)],K=this._context.layer.uid,Q=c.createStageObjectForPoint(this._context,t,k,J,null,null,h,f,K,v,!0);if(null===Q)return null;var X=l.perObjectElevationAligner,Y=new s(this,Q.object,k,null==O?J:null,S?null:[T],X,h);return Y.alignedTerrainElevation=Q.terrainElevation,Y.needsElevationUpdates=c.needsElevationUpdates2D(h.mode)||"absolute-height"===h.mode,Y.getScreenSize=function(e){return void 0===e&&(e=r.vec2f64.create()),e[0]=S?T.textWidth:T.width,e[1]=S?T.textHeight:T.height,e},Y.metadata={labelText:n,elevationOffset:x.elevationOffset||0},c.extendPointGraphicElevationContext(Y,t,this._context.elevationProvider),Y},t.prototype._getTextSize=function(e){return o.pt2px((e||this.symbol).size)||12},t}(h)});