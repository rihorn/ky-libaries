// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.10/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/declareExtendsHelper","../../../../core/tsSupport/decorateHelper","../../../../core/tsSupport/generatorHelper","../../../../core/tsSupport/awaiterHelper","../../../../geometry","../../../../renderers","../../../../symbols","../../../../core/Accessor","../../../../core/arrayUtils","../../../../core/compilerUtils","../../../../core/Error","../../../../core/Handles","../../../../core/iteratorUtils","../../../../core/Logger","../../../../core/now","../../../../core/ObjectPool","../../../../core/PooledArray","../../../../core/promiseUtils","../../../../core/watchUtils","../../../../core/accessorSupport/decorators","../../../../core/libs/gl-matrix-2/gl-matrix","../../../../geometry/support/aaBoundingBox","../../../../geometry/support/aaBoundingRect","../../../../layers/Layer","../../../../layers/graphics/dehydratedFeatures","../../../../renderers/support/diffUtils","../../../../renderers/support/rendererConversion","../../../../symbols/support/symbolConversion","./ElevationQuery","./featureExpressionInfoUtils","./Graphics3DGraphic","./Graphics3DOwner","./Graphics3DSymbolFactory","./Graphics3DWebStyleSymbol","./graphicUtils","./symbolComplexity","../../support/mathUtils","../../support/projectionUtils","../../support/PropertiesPool","../../webgl-engine/Stage","../../webgl-engine/lib/GridLocalOriginFactory","../../webgl-engine/lib/Layer"],function(e,t,i,r,a,n,s,o,l,h,p,d,c,y,u,m,g,b,f,v,S,w,C,x,G,D,U,P,E,R,O,_,I,F,V,L,M,A,z,T,W,B,q,j){var k=new s.Point,H=C.vec3f64.create(),N=x.create(),Q=m.getLogger("esri.views.3d.layers.graphics.Graphics3DCore"),Y=function(e){function t(t){var i=e.call(this)||this;return i.propertiesPool=new W.PropertiesPool({computedExtent:s.Extent},i),i.computedExtent=null,i.symbolCreationContext=new F.Graphics3DSymbolCreationContext,i.graphics=new Map,i.stageLayer=null,i.stage=null,i.graphicsDrapedUids=new Set,i.graphicsBySymbol=new Map,i.symbolConversionCache=new Map,i.symbols=new Map,i.graphicsWithoutSymbol={},i.graphicsWaitingForSymbol=new Set,i.lastFastUpdate=null,i.handles=new y,i.viewSR=null,i.elevationAlignment=null,i.scaleVisibility=null,i.spatialIndex=null,i.deconfliction=null,i.labeling=null,i.highlights=null,i.viewElevationProvider=null,i.sharedSymbolResourcesOwnerHandle=null,i.whenGraphics3DGraphicRequests={},i.pendingUpdates=new Map,i.pendingAdds=0,i.pendingRemoves=0,i.pendingUpdatesPool=new f({allocator:function(e){return e||{add:null,remove:null}},deallocator:function(e){return e.add=null,e.remove=null,e}}),i.symbolWarningLogged=!1,i.geometryWarningLogged=!1,i._whenSymbolRemoved=[],i.asyncUpdates=!1,i.elevationFeatureExpressionEnabled=!0,i.owner=null,i.layer=null,i.hasDraped=!1,i.graphicSymbolSupported=!0,i._usedMemory=0,i.numberOfGraphics=0,i._visible=void 0,i._startCreateGraphics=!1,i.maxPendingUpdates=0,i}i(t,e),h=t,Object.defineProperty(t.prototype,"updating",{get:function(){return!!(this.graphicsWaitingForSymbol.size>0||this.needsIdleUpdate()||this.elevationAlignment&&this.elevationAlignment.updating||this.scaleVisibility&&this.scaleVisibility.updating)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"updatingRemaining",{get:function(){return this.updating?this.pendingUpdates.size:0},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"updatingTotal",{get:function(){return this.updating?this.maxPendingUpdates:0},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"displayFeatureLimit",{get:function(){var e=this.owner&&this.owner.view&&this.owner.view.qualitySettings,t=e?e.graphics3D.minTotalNumberOfFeatures:0,i=e?e.graphics3D.maxTotalNumberOfFeatures:0,r=e?e.graphics3D.maxTotalNumberOfPrimitives:0,a=this.maxSymbolComplexity,n=Math.max(t,Math.min(i,Math.ceil(r/Math.max(1,a?a.primitivesPerFeature:1)))),s=this._get("displayFeatureLimit");return s&&s.minimumTotalNumberOfFeatures===t&&s.maximumTotalNumberOfFeatures===i&&s.maximumTotalNumberOfPrimitives===r&&s.maximumSymbolComplexity===a&&s.maximumNumberOfFeatures===n?s:{minimumTotalNumberOfFeatures:t,maximumTotalNumberOfFeatures:i,maximumTotalNumberOfPrimitives:r,maximumSymbolComplexity:a,maximumNumberOfFeatures:n}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"maxSymbolComplexity",{get:function(){for(var e=null,t=this.getSymbolComplexities(),i=0,r=t;i<r.length;i++){var a=r[i];e?0===e.primitivesPerCoordinate&&a.primitivesPerFeature>e.primitivesPerFeature?e=a:0!==e.primitivesPerCoordinate&&a.primitivesPerCoordinate>e.primitivesPerCoordinate&&(e=a):e=a}var n=this._get("maxSymbolComplexity");return!e||n&&n.primitivesPerFeature===e.primitivesPerFeature&&n.primitivesPerCoordinate===e.primitivesPerCoordinate?n:e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"usedMemory",{get:function(){return this._usedMemory},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"usedMemoryPerGraphic",{get:function(){return this._usedMemory&&this.numberOfGraphics?this._usedMemory/this.numberOfGraphics:this.maxSymbolComplexity?this.maxSymbolComplexity.memory.bytesPerFeature:0},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"unprocessedMemoryEstimate",{get:function(){return Math.max(0,(this.pendingAdds-this.pendingRemoves)*this.usedMemoryPerGraphic)},enumerable:!0,configurable:!0}),t.prototype.getSymbolComplexities=function(){return this.layer.renderer?this.getSymbolComplexitiesUsedOrRenderer(this.layer.renderer):this.getSymbolComplexitiesUsed()},t.prototype.getConvertedSymbol=function(e){if("web-style"===e.type)return e.clone();var t=this.symbolConversionCache.get(e.id);if(void 0!==t)return t;var i=R.to3D(e,!0,!1,this.hasLabelingContext(e)),r=i.symbol||null;return r||i.error&&Q.error(i.error.message),this.symbolConversionCache.set(e.id,r),r},t.prototype.getSymbolComplexitiesUsedOrRenderer=function(e){var t=e.getSymbols();if(!t||!t.length)return[];for(var i=[],r=0,a=t;r<a.length;r++){var n=a[r],s=this.symbols.get(n.id);if(s)i.push(s.complexity);else{var o=this.getConvertedSymbol(n);o&&i.push(A.defaultSymbolComplexity(o))}}return i},t.prototype.getSymbolComplexitiesUsed=function(){var e=[];return this.symbols.forEach(function(t){t&&e.push(t.complexity)}),e},t.prototype.initialize=function(){this.viewSR=this.owner.view.spatialReference},t.prototype.setup=function(e){var t=this;this._set("elevationAlignment",e.elevationAlignment),this._set("scaleVisibility",e.scaleVisibility),this._set("spatialIndex",e.spatialIndex),this._set("deconfliction",e.deconfliction),this._set("labeling",e.labeling),this._set("highlights",e.highlights);var i=this.owner.view;this.viewElevationProvider=new O.ViewElevationProvider(this.viewSR,i),this.initializeStage(i,this.layer.uid),this.symbolCreationContext.sharedResources=i.sharedSymbolResources,this.sharedSymbolResourcesOwnerHandle=i.sharedSymbolResources.addGraphicsOwner(this.owner),this.symbolCreationContext.renderer=this.layer.renderer,this.symbolCreationContext.stage=this.stage,this.symbolCreationContext.streamDataSupplier=i.sharedSymbolResources.streamDataSupplier,this.symbolCreationContext.renderSpatialReference=i.renderSpatialReference,this.symbolCreationContext.renderCoordsHelper=i.renderCoordsHelper,this.symbolCreationContext.layer=this.layer,this.symbolCreationContext.layerView=this.owner,this.symbolCreationContext.layerOrder=0,this.symbolCreationContext.localOriginFactory=new q,this.symbolCreationContext.elevationProvider=i.elevationProvider;var r=_.extractExpressionInfo(this.layer.elevationInfo,this.elevationFeatureExpressionEnabled);this.symbolCreationContext.featureExpressionInfoContext=_.createContext(r,this.viewSR,Q),i.deconflictor.addGraphicsOwner(this),this.symbolCreationContext.screenSizePerspectiveEnabled=i.screenSizePerspectiveEnabled&&this.layer.screenSizePerspectiveEnabled,this.symbolCreationContext.slicePlaneEnabled=!!this.owner.slicePlaneEnabled,this.handles.add(this.owner.watch("suspended",function(){return t.updateLayerVisibility()}));var a="layer"in this.owner?["layer.screenSizePerspectiveEnabled,view.screenSizePerspectiveEnabled"]:"view.screenSizePerspectiveEnabled";this.handles.add([this.owner.watch(a,function(){var e=i.screenSizePerspectiveEnabled&&t.layer.screenSizePerspectiveEnabled;e!==t.symbolCreationContext.screenSizePerspectiveEnabled&&(t.symbolCreationContext.screenSizePerspectiveEnabled=e,t.recreateAllGraphics())}),this.owner.watch("slicePlaneEnabled",function(e){return t.slicePlaneEnabledChange(!!e)}),this.owner.watch("layer.featureReduction",function(){t.deconfliction.featureReductionChange()})]),this.handles.add(S.when(i.basemapTerrain,"tilingScheme",function(e){e.spatialReference.equals(t.symbolCreationContext.overlaySR)||(t.symbolCreationContext.overlaySR=t.basemapTerrain.spatialReference),t.handles.has("loaded-graphics")?t.recreateAllGraphics():t.handles.add(S.on(t.owner,"loadedGraphics","change",function(e){return t.graphicsCollectionChanged(e)},function(){return t.recreateAllGraphics()}),"loaded-graphics")})),this.validateRenderer(this.layer.renderer),this.notifyChange("maxSymbolComplexity")},t.prototype.destroy=function(){this.owner.view.deconflictor.removeGraphicsOwner(this),this.owner.view.labeler.removeGraphicsOwner(this),this.clear(),this.stage&&(this.stage.removeFromViewContent([this.stageLayer.id]),this.stage.remove(B.ModelContentType.LAYER,this.stageLayer.id),this.stageLayer=null,this.stage=null),this.handles.destroy(),this.handles=null,this.viewSR=null,this._set("owner",null);for(var e in this.whenGraphics3DGraphicRequests)this.whenGraphics3DGraphicRequests[e].reject(new c("graphic:layer-destroyed","Layer has been destroyed"));this.whenGraphics3DGraphicRequests=null,this.sharedSymbolResourcesOwnerHandle&&(this.sharedSymbolResourcesOwnerHandle.remove(),this.sharedSymbolResourcesOwnerHandle=null),this.propertiesPool&&(this.propertiesPool.destroy(),this.propertiesPool=null),this.pendingUpdatesPool=null,this.symbolConversionCache.clear()},t.prototype.clear=function(){this.graphics.forEach(function(e){return e.destroy()}),this.spatialIndex&&this.spatialIndex.clear(),this.graphics.clear(),this.numberOfGraphics=0,this._usedMemory=0,this.updateLayerVisibility(),this.symbols.forEach(function(e){e&&e.destroy()}),this.symbols.clear(),this.graphicsBySymbol.clear(),this.graphicsWithoutSymbol={},this.graphicsWaitingForSymbol.clear(),this.pendingUpdates.clear(),this.pendingUpdatesPool.clear(),this.maxPendingUpdates=0,this.pendingAdds=0,this.pendingRemoves=0,this._set("hasDraped",!1),this.notifyChange("updating"),this.notifyChange("updatingTotal"),this.notifyChange("updatingRemaining")},t.prototype.initializeStage=function(e,t){this.stage=e._stage,this.stageLayer=new j(t,{isPickable:!this.owner.suspended},t),this.stage.add(B.ModelContentType.LAYER,this.stageLayer),this.stage.addToViewContent([this.stageLayer.id])},t.prototype.setDrawingOrder=function(e){this.symbolCreationContext.layerOrder=e;var t=new Set;this.symbols.forEach(function(i){i&&i.setDrawOrder(e,t)}),t.size>0&&this.stage.getDrapedTextureRenderer().updateRenderOrder(t)},t.prototype.updateLayerVisibility=function(){var e=!!this.owner.suspended,t=this.numberOfGraphics>this.displayFeatureLimit.maximumNumberOfFeatures*Z,i=!e&&!t;i!==this._visible&&(this._visible=i,i?(this.stageLayer.isPickable=!0,this.updateAllGraphicsVisibility()):(this.stageLayer.isPickable=!1,this.hideAllGraphics()),this.updateStageLayerVisibility())},t.prototype.updateStageLayerVisibility=function(){this.stageLayer.isVisible=this._visible&&(null==this.layer.opacity||this.layer.opacity>0)},Object.defineProperty(t.prototype,"graphics3DGraphics",{get:function(){return this.graphics},enumerable:!0,configurable:!0}),t.prototype.getGraphics3DGraphicById=function(e){return this.graphics.get(e)},Object.defineProperty(t.prototype,"graphics3DGraphicsByObjectID",{get:function(){var e=this.owner.layer&&this.owner.layer.objectIdField;if(!e)return null;var t=new Map;return this.graphics.forEach(function(i){if(i){var r=i.graphic,a=r.attributes&&r.attributes[e];null!=a&&t.set(a,i)}}),t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"labelsEnabled",{get:function(){return!(!this.labeling||!this.labeling.layerLabelsEnabled())},enumerable:!0,configurable:!0}),t.prototype.updateLabelingInfo=function(e){return this.deconfliction&&this.deconfliction.labelingInfoChange(),this.labeling&&this.labeling.labelingInfoChange(e)},t.prototype.updateVisibilityInfo=function(){return this.deconfliction&&this.deconfliction.labelingInfoChange(),this.labeling&&this.labeling.visibilityInfoChange()},Object.defineProperty(t.prototype,"symbolUpdateType",{get:function(){var e=this;if(this.pendingUpdates.size>0)return"unknown";var t=0,i=0;return u.everyMap(this.symbols,function(r,a){if(r){var n=r.getFastUpdateStatus();if(n.loading>0)return!1;e.graphicsBySymbol.has(a)&&(i+=n.fast,t+=n.slow)}})?i>=0&&0===t?"fast":t>=0&&0===i?"slow":"mixed":"unknown"},enumerable:!0,configurable:!0}),t.prototype.needsIdleUpdate=function(){return this.pendingUpdates.size>0||!!this.lastFastUpdate&&g()-this.lastFastUpdate>500},t.prototype.idleUpdate=function(e){var t=this.needsIdleUpdate();this._applyPendingUpdates(e),!e.done()&&this.lastFastUpdate&&(this.lastFastUpdate=null),t!==this.needsIdleUpdate()&&this.notifyChange("updating")},t.prototype.whenGraphics3DGraphic=function(e){var t=this.graphics.get(e.uid);if(t)return v.resolve(t);var i=this.whenGraphics3DGraphicRequests[e.uid];if(i)return i.promise;var r=v.createDeferred();return this.whenGraphics3DGraphicRequests[e.uid]=r,r.promise},t.prototype.boundsForGraphics3DGraphic=function(e,t){return n(this,void 0,void 0,function(){var i,r,n,s,o,l,h,p,d,c;return a(this,function(a){switch(a.label){case 0:return i=this.owner.view.spatialReference,r=this.owner.view.renderSpatialReference,n=this.owner.view.basemapTerrain.spatialReference,s=function(e,t,a){return T.bufferToBuffer(e,r,t,e,i,t,a)},o=function(e,t,r){return T.bufferToBuffer(e,n,t,e,i,t,r)},l=this.viewElevationProvider?{service:this.viewElevationProvider,useViewElevation:t&&t.useViewElevation,minDemResolution:t&&t.minDemResolution,minDemResolutionForPoints:this.owner.view.resolution}:null,[4,e.getProjectedBoundingBox(s,o,l)];case 1:return(h=a.sent())?(p=h.boundingBox,h.requiresDrapedElevation&&(d=this.symbolCreationContext.elevationProvider)&&(x.center(p,H),k.x=H[0],k.y=H[1],k.z=void 0,k.spatialReference=i,c=d.getElevation(k)||0,p[2]=Math.min(p[2],c),p[5]=Math.max(p[5],c)),[2,{boundingBox:p,screenSpaceObjects:h.screenSpaceObjects}]):[2,null]}})})},t.prototype.whenGraphicBounds=function(e,t){var i=this;return S.whenOnce(this.owner,"loadedGraphics").then(function(){var t=i.owner.layer&&i.owner.layer.objectIdField,r=i.owner.loadedGraphics.find(function(i){return i===e||t&&i.attributes&&e.attributes&&i.attributes[t]===e.attributes[t]});if(r)return i.whenGraphics3DGraphic(r);throw new c("internal:graphic-not-part-of-view","Graphic is not part of this view")}).then(function(e){return i.boundsForGraphics3DGraphic(e,t)})},t.prototype.graphicsCollectionChanged=function(e){this._startCreateGraphics&&(this.add(e.added),this.remove(e.removed))},t.prototype.graphicUpdateHandler=function(e){var t=this.graphics.get(e.graphic.uid);if(t)switch(e.property){case"visible":this.graphicUpdateVisible(t,e);break;case"geometry":case"attributes":case"symbol":this.recreateGraphic(t);break;default:d.neverReached(e)}},t.prototype.graphicUpdateVisible=function(e,t){var i=e.setVisibilityFlag(0,t.newValue);i&&this.labeling&&(this.lastFastUpdate=g(),this.owner.view.labeler.setDirty()),i&&this.owner.view.deconflictor.setDirty()},t.prototype.recreateGraphic=function(e){var t=e.graphic,i=[t];this.remove(i),this.add(i)},t.prototype._beginGraphicUpdate=function(e){this.graphicsWaitingForSymbol.add(e.uid),1===this.graphicsWaitingForSymbol.size&&this.notifyChange("updating"),this._get("symbolsUpdating")||this._set("symbolsUpdating",!0)},t.prototype._endGraphicUpdate=function(e){e&&(this.graphicsWaitingForSymbol.delete(e.uid),0===this.graphicsWaitingForSymbol.size&&(this._cleanupSymbols(),this.notifyChange("updating"),this._get("symbolsUpdating")&&(this.owner.view.flushDisplayModifications(),this._set("symbolsUpdating",!1))))},t.prototype.expandComputedExtent=function(e){var t=N,i=e.spatialReference;U.computeAABB(e,t);var r=this.viewSR,a=h.tmpVec;if(i.equals(r)||T.xyzToVector(t[0],t[1],0,i,a,r)&&(t[0]=a[0],t[1]=a[1],T.xyzToVector(t[3],t[4],0,i,a,r),t[3]=a[0],t[4]=a[1]),z.isFinite(t[0])&&z.isFinite(t[3])&&z.isFinite(t[1])&&z.isFinite(t[4])){var n=this.computedExtent,s=null,o=z.isFinite(t[2])&&z.isFinite(t[5]),l=o&&(!n||null==n.zmin||t[2]<n.zmin),p=o&&(!n||null==n.zmax||t[5]>n.zmax);if(n){(t[0]<n.xmin||t[1]<n.ymin||t[3]>n.xmax||t[4]>n.ymax||l||p)&&(s=this.propertiesPool.get("computedExtent"),s.xmin=Math.min(t[0],n.xmin),s.ymin=Math.min(t[1],n.ymin),s.xmax=Math.max(t[3],n.xmax),s.ymax=Math.max(t[4],n.ymax),s.spatialReference=r)}else s=this.propertiesPool.get("computedExtent"),s.xmin=t[0],s.ymin=t[1],s.xmax=t[3],s.ymax=t[4],s.spatialReference=r;s&&(l&&(s.zmin=t[2]),p&&(s.zmax=t[5]),this._set("computedExtent",s))}},t.prototype.updateHasDraped=function(){var e=this.graphicsDrapedUids.size>0;this._set("hasDraped",e)},t.prototype.elevationInfoChange=function(){var e=this,t=_.extractExpressionInfo(this.layer.elevationInfo,this.elevationFeatureExpressionEnabled);this.symbolCreationContext.featureExpressionInfoContext=_.createContext(t,this.viewSR,Q),this.labeling&&this.labeling.elevationInfoChange(),this.layer.renderer!==this.symbolCreationContext.renderer&&this.rendererChange(this.layer.renderer),this.forEachGraphics3DSymbol(function(t,i,r){if(t.layerPropertyChanged("elevationInfo",i))for(var a in i)for(var n=i[a],s=n.graphic,o=n._labelGraphics,l=0;l<o.length;l++){var h=o[l],p=h.graphics3DSymbolLayer;p.updateGraphicElevationContext(s,h)}else e._recreateSymbol(r)}),this.elevationAlignment&&this.elevationAlignment.elevationInfoChange()},t.prototype.clearSymbolsAndGraphics=function(){this.clear(),this.labeling&&this.labeling.reset(),this.deconfliction&&this.deconfliction.clear(),this.elevationAlignment&&this.elevationAlignment.clear(),this.stageLayer&&this.stageLayer.invalidateSpatialQueryAccelerator()},t.prototype.startCreateGraphics=function(){this._startCreateGraphics=!0,this.recreateAllGraphics()},t.prototype.recreateAllGraphics=function(){this._startCreateGraphics&&(this.clearSymbolsAndGraphics(),this._set("computedExtent",null),this.symbolCreationContext.screenSizePerspectiveEnabled=this.owner.view.screenSizePerspectiveEnabled&&this.layer.screenSizePerspectiveEnabled,this.symbolCreationContext.slicePlaneEnabled=!!this.owner.slicePlaneEnabled,this.owner.loadedGraphics&&this.owner.view.basemapTerrain.tilingScheme&&this.add(this.owner.loadedGraphics.toArray()))},t.prototype._recreateSymbol=function(e){var t=this,i=this.graphicsBySymbol.get(e),r=[],a=[];i.forEach(function(e,i){var n=e.usedMemory;e.isDraped()&&t.graphicsDrapedUids.delete(i),t.labeling&&t.labeling.removeGraphic(e),t.deconfliction&&t.deconfliction.removeGraphic(e),t.spatialIndex&&r.push(e),a.push(e.graphic),e.destroy(),t.removeGraphics3DGraphic(i,n),t.updateLayerVisibility()}),r.length>0&&this.spatialIndex.removeMany(r),this.graphicsBySymbol.set(e,new Map);var n=this.symbols.get(e);n&&n.destroy(),this.symbols.delete(e),this.updateHasDraped(),this.add(a)},t.prototype.add=function(e){if(!this.owner.view.basemapTerrain||!this.owner.view.basemapTerrain.tilingScheme)return void Q.error("#add()","Cannot add graphics before terrain surface has been initialized");this.asyncUpdates?this._addDelayed(e):this._addImmediate(e),this.notifyChange("updating")},t.prototype._addImmediate=function(e){var t=this;this.geometryWarningLogged=!1,this.symbolWarningLogged=!1,J.clear();for(var i=0,r=e;i<r.length;i++){var a=r[i];this._startAddGraphic(a,J)}J.forEach(function(e){return t._finishAddGraphics(e)}),J.clear(),this.updateHasDraped(),this._cleanupSymbols(),this.owner.view.labeler.setDirty(),this._cleanupSymbols()},t.prototype._addDelayed=function(e){for(var t=0,i=e;t<i.length;t++){var r=i[t],a=r.uid,n=this.pendingUpdates.get(a);if(n)n.add||this.pendingAdds++,n.add=r;else{var s=this.pendingUpdatesPool.pushNew();s.add=r,this.pendingAdds++,this.pendingUpdates.set(a,s)}}this.maxPendingUpdates=Math.max(this.maxPendingUpdates,this.pendingUpdates.size),this.notifyChange("updatingTotal"),this.notifyChange("updatingRemaining")},t.prototype.remove=function(e){this.asyncUpdates?this._removeDelayed(e):this._removeImmediate(e),this.notifyChange("updating")},t.prototype._removeImmediate=function(e){for(var t=0,i=e;t<i.length;t++){var r=i[t];this._removeGraphic(r)}this.updateHasDraped(),this._cleanupSymbols(),this.owner.view.labeler.setDirty()},t.prototype._removeDelayed=function(e){for(var t=0,i=e;t<i.length;t++){var r=i[t],a=r.uid,n=this.pendingUpdates.get(a);if(n)n.add&&(n.remove?n.add=null:this.pendingUpdates.delete(a),this.pendingAdds--);else{var s=this.pendingUpdatesPool.pushNew();s.remove=r,this.pendingUpdates.set(a,s),this.pendingRemoves++}}0===this.pendingUpdates.size&&this._finishPendingUpdates(),this.maxPendingUpdates=Math.max(this.maxPendingUpdates,this.pendingUpdates.size),this.notifyChange("updatingTotal"),this.notifyChange("updatingRemaining")},t.prototype._finishPendingUpdates=function(){this.pendingUpdatesPool.clear(),this.maxPendingUpdates=0,this._cleanupSymbols(),(this.pendingAdds||this.pendingRemoves)&&Q.warn("pendingAdds/Removes in inconsistent state!"),this.pendingAdds=0,this.pendingRemoves=0},t.prototype._applyPendingUpdates=function(e){var t=this;if(!e.done()){this.geometryWarningLogged=!1,this.symbolWarningLogged=!1;var i=0;J.clear(),u.everyMap(this.pendingUpdates,function(r,a){if(e.done())return!1;r.remove&&(t.pendingRemoves--,t._removeGraphic(r.remove)),r.add&&(t.pendingAdds--,t._startAddGraphic(r.add,J)&&i++),t.pendingUpdates.delete(a),i>1e3&&(J.forEach(function(e){return t._finishAddGraphics(e)}),J.clear(),i=0)}),J.forEach(function(e){return t._finishAddGraphics(e)}),J.clear(),0===this.pendingUpdates.size&&this._finishPendingUpdates(),this.notifyChange("updatingTotal"),this.notifyChange("updatingRemaining"),this.updateHasDraped()}},t.prototype._startAddGraphic=function(e,t){this.graphicsWithoutSymbol[e.uid]=e;var i=this._getRenderingInfo(e,Q);if(!i)return!1;var r=i.symbol,a=this.getOrCreateGraphics3DSymbol(r,i.renderer);if(!a)return!1;this.expandComputedExtent(e.geometry),this._beginGraphicUpdate(e);var n={graphic:e,renderingInfo:i,layer:this.layer},s=a.symbol.id,o=t.get(s);if(o)o.graphics.push(n);else{var l=X.acquire();l.clear(),l.push(n),t.set(s,{asyncSymbol:a,graphics:l})}return!0},t.prototype._finishAddGraphics=function(e){var t=this,i=!1,r=function(t){t===e.asyncSymbol.symbol.id&&(i=!0)};this._whenSymbolRemoved.push(r),e.asyncSymbol.then(function(){p.removeUnordered(t._whenSymbolRemoved,r),K.clear();for(var a=0;a<e.graphics.length;a++){var n=e.graphics.data[a],s=n.graphic;if(!i&&!e.asyncSymbol.destroyed){if(t.graphicsWaitingForSymbol.has(s.uid)){var o=t.createGraphics3DGraphic(e.asyncSymbol,n);t.spatialIndex&&o&&K.push(o)}t._endGraphicUpdate(s)}--e.asyncSymbol.referenced}K.length>0&&(t.spatialIndex.addMany(K.data,K.length),K.clear()),e.graphics.clear(),X.release(e.graphics),t.labeling&&(t.lastFastUpdate=g(),t.owner.view.labeler.setDirty())},function(){p.removeUnordered(t._whenSymbolRemoved,r);if(!i&&!e.asyncSymbol.destroyed)for(var a=0;a<e.graphics.length;a++)t._endGraphicUpdate(e.graphics.data[a].graphic);e.graphics.clear(),X.release(e.graphics)})},t.prototype._removeGraphic=function(e){var t=e.uid,i=this.graphics.get(t);if(i){var r=i.usedMemory;i.isDraped()&&this.graphicsDrapedUids.delete(t),this.deconfliction&&this.deconfliction.removeGraphic(i),this.labeling&&this.labeling.removeGraphic(i),this.spatialIndex&&this.spatialIndex.remove(i);var a=i.graphics3DSymbol.symbol.id;this.graphicsBySymbol.get(a).delete(t),delete this.graphicsWithoutSymbol[t],this.removeGraphics3DGraphic(t,r),i.destroy()}else delete this.graphicsWithoutSymbol[t],this.graphicsWaitingForSymbol.delete(t)},t.prototype.hasLabelingContext=function(e){if(e instanceof l.LabelSymbol3D||e instanceof l.TextSymbol){var t=this.symbolCreationContext.layer;return!!t.labelingInfo&&t.labelingInfo.some(function(t){return t.symbol===e})}return!1},t.prototype.hasValidSymbolCreationContext=function(e){return!(e instanceof l.LabelSymbol3D&&!this.hasLabelingContext(e))||(Q.error("LabelSymbol3D is only valid as part of a LabelClass. Using LabelSymbol3D as a renderer symbol is not supported."),!1)},t.prototype._getRenderingInfo=function(e,t){if(!e.geometry)return t&&!this.geometryWarningLogged&&(this.geometryWarningLogged=!0,t.warn("Graphic in layer "+this.layer.id+" has no geometry and will not render")),null;if(!this.graphicSymbolSupported&&e.symbol)return t&&!this.symbolWarningLogged&&(this.symbolWarningLogged=!0,t.warn("Graphic in layer "+this.layer.id+" is not allowed to have a symbol, use a renderer instead")),null;var i=this.owner.getRenderingInfo&&this.owner.getRenderingInfo(e);return i&&i.symbol?i:(t&&!this.symbolWarningLogged&&(this.symbolWarningLogged=!0,t.warn("Graphic in layer "+this.layer.id+" has no symbol and will not render")),null)},t.prototype.createGraphics3DSymbol=function(e,t){var i=this;if(!this.hasValidSymbolCreationContext(e))return null;var r=this.getConvertedSymbol(e);if(!r)return null;var a;if(t&&"backgroundFillSymbol"in t&&t.backgroundFillSymbol){var n=R.to3D(t.backgroundFillSymbol,!1,!0);n.symbol&&"web-style"!==n.symbol.type&&(a=n.symbol.symbolLayers)}var s=V.make(r,this.symbolCreationContext,a);return s.then(function(){return i.notifyChange("maxSymbolComplexity")}),s},t.prototype.getOrCreateGraphics3DSymbol=function(e,t){var i=this,r=this.symbols.get(e.id);return void 0===r&&(r=e instanceof l.WebStyleSymbol?new L(e,function(e){return i.createGraphics3DSymbol(e,t)}):this.createGraphics3DSymbol(e,t),this.symbols.set(e.id,r)),r&&++r.referenced,r},t.prototype.addGraphics3DGraphic=function(e){this._usedMemory+=e.usedMemory,this.graphics.set(e.graphic.uid,e),this.numberOfGraphics++,this.updateLayerVisibility()},t.prototype.removeGraphics3DGraphic=function(e,t){this._usedMemory-=t,this.graphics.delete(e),this.numberOfGraphics--,this.updateLayerVisibility()},t.prototype.createGraphics3DGraphic=function(e,t){var i=t.graphic;if(delete this.graphicsWithoutSymbol[i.uid],!this.symbols.has(e.symbol.id))return void this.add([i]);if(!this.graphics.has(i.uid)){var r=e.createGraphics3DGraphic(t),a=e.symbol.id;this.addGraphics3DGraphic(r),this.graphicsBySymbol.has(a)||this.graphicsBySymbol.set(a,new Map),this.graphicsBySymbol.get(a).set(i.uid,r),r.initialize(this.stageLayer,this.stage);r.isDraped()&&(this.graphicsDrapedUids.add(i.uid),this._set("hasDraped",!0)),r.centroid=null,"point"!==i.geometry.type&&r instanceof I&&(r.centroid=M.computeCentroid(i.geometry,this.viewSR));var n=this.scaleVisibility&&this.scaleVisibility.scaleRangeActive();this.deconfliction&&this.deconfliction.addGraphic(r),this.labeling&&this.labeling.addGraphic(r),n&&this.scaleVisibility.updateGraphicScaleVisibility(r);var s=!!i.visible&&!this.owner.suspended;r.setVisibilityFlag(0,s),this.owner.view.deconflictor.setInitialIconVisibilityFlag(this,r);var o=this.whenGraphics3DGraphicRequests[i.uid];return o&&(delete this.whenGraphics3DGraphicRequests[i.uid],o.resolve(r)),this.highlights&&this.highlights.graphicCreated(r),r}},t.prototype.rendererChange=function(e){var t=this.symbolCreationContext.renderer;if(e!==t){this.validateRenderer(e),this.symbolConversionCache.clear();var i=P.diff(t,e);this.updateUnchangedSymbolMappings(i,e,t),this.symbolCreationContext.renderer=e,i&&("complete"===i.type?this.recreateAllGraphics():"partial"===i.type&&(this.applyRendererDiff(i,e,t)?this.volatileGraphicsUpdated():this.recreateAllGraphics()),this.notifyChange("maxSymbolComplexity"))}},t.prototype.diffHasSymbolChange=function(e){for(var t in e.diff)switch(t){case"visualVariables":case"defaultSymbol":case"uniqueValueInfos":break;case"authoringInfo":case"fieldDelimiter":delete e.diff[t];break;default:return!0}return!1},t.prototype.applySymbolSetDiff=function(e,t,i,r){var a=this;e=e||[],t=t||[];for(var n=[],s=this,o=0,l=t;o<l.length;o++){var h=l[o];!function(t){var r=s.graphicsBySymbol.get(t.id);r&&r.forEach(function(s,o){var l=s.graphic,h=a.layer instanceof D?a.layer:null;if(t!==i.defaultSymbol||i.getSymbol(U.hydrateGraphic(l,h))!==i.defaultSymbol){var p=s.usedMemory;s.isDraped()&&a.graphicsDrapedUids.delete(o),e.length||i.defaultSymbol?n.push(l):a.graphicsWithoutSymbol[o]=l;var d=a.graphics.get(o);a.highlights&&a.highlights.graphicDeleted(d),a.labeling&&a.labeling.removeGraphic(d),s.destroy(),r.delete(o),a.removeGraphics3DGraphic(o,p),a.updateLayerVisibility()}});for(var o=0,l=s._whenSymbolRemoved;o<l.length;o++){(0,l[o])(t.id)}}(h)}if(e.length||n.length){for(var p in this.graphicsWithoutSymbol)n.push(this.graphicsWithoutSymbol[p]);this.graphicsWithoutSymbol={},this.add(n)}this.updateHasDraped(),this._cleanupSymbols(),this.owner.view.labeler.setDirty()},t.prototype.applyUniqueValueRendererDiff=function(e,t,i){var r=e.diff.defaultSymbol,a=e.diff.uniqueValueInfos;if(r||a){var n=a?a.added.map(function(e){return e.symbol}):[],s=a?a.removed.map(function(e){return e.symbol}):[];if(a)for(var o=0;o<a.changed.length;o++)n.push(a.changed[o].newValue.symbol),s.push(a.changed[o].oldValue.symbol);return r?(i.defaultSymbol&&s.push(i.defaultSymbol),t.defaultSymbol&&n.push(t.defaultSymbol)):i.defaultSymbol&&n.length&&s.push(t.defaultSymbol),this.applySymbolSetDiff(n,s,t,i),delete e.diff.defaultSymbol,delete e.diff.uniqueValueInfos,!0}return!1},t.prototype.calculateUnchangedSymbolMapping=function(e,t,i){if(t instanceof o.UniqueValueRenderer&&i instanceof o.UniqueValueRenderer&&(!e||"partial"===e.type)){var r=e&&e.diff,a=r&&r.defaultSymbol,n=r&&r.uniqueValueInfos,s=void 0;return s=n?n.unchanged.map(function(e){return{oldId:e.oldValue.symbol.id,newId:e.newValue.symbol.id}}):i.uniqueValueInfos.map(function(e,i){return{oldId:e.symbol.id,newId:t.uniqueValueInfos[i].symbol.id}}),!a&&i.defaultSymbol&&s.push({oldId:i.defaultSymbol.id,newId:t.defaultSymbol.id}),s}return[]},t.prototype.updateUnchangedSymbolMappings=function(e,t,i){for(var r=this.calculateUnchangedSymbolMapping(e,t,i),a=0,n=r;a<n.length;a++){var s=n[a],o=s.oldId,l=s.newId;if(o&&o!==l){var h=this.graphicsBySymbol.get(o);this.graphicsBySymbol.delete(o),void 0!==h&&this.graphicsBySymbol.set(l,h);var p=this.symbols.get(o);this.symbols.delete(o),void 0!==p&&(this.symbols.set(l,p),p.symbol.id=l)}}},t.prototype.applyRendererDiff=function(e,t,i){var r=this;return!this.diffHasSymbolChange(e)&&(!!(t instanceof o.UniqueValueRenderer&&i instanceof o.UniqueValueRenderer&&this.applyUniqueValueRendererDiff(e,t,i)&&0===Object.keys(e.diff).length)||u.everyMap(this.graphicsBySymbol,function(i,a){var n=r.symbols.get(a);if(n&&!n.applyRendererDiff(e,t))return!1}))},t.prototype.opacityChange=function(){this.forEachGraphics3DSymbol(function(e){return e.layerPropertyChanged("opacity")}),this.updateStageLayerVisibility()},t.prototype.slicePlaneEnabledChange=function(e){e!==this.symbolCreationContext.slicePlaneEnabled&&(this.symbolCreationContext.slicePlaneEnabled=e,this.stageLayer.isSliceable=e,this.forEachGraphics3DSymbol(function(e,t){return e.layerPropertyChanged("slicePlaneEnabled",t)}),this.deconfliction&&this.deconfliction.slicePlaneEnabledChange(),this.labeling&&this.labeling.slicePlaneEnabledChange())},t.prototype.setClippingExtent=function(e,t){var i=this.symbolCreationContext.clippingExtent,r=G.create();return T.extentToBoundingRect(e,r,t)?this.symbolCreationContext.clippingExtent=[r[0],r[1],-1/0,r[2],r[3],1/0]:this.symbolCreationContext.clippingExtent=null,!p.equals(this.symbolCreationContext.clippingExtent,i)},t.prototype.forEachGraphics3DGraphic=function(e){var t=this;if(this.owner.loadedGraphics){var i=!1;this.owner.loadedGraphics.forEach(function(r){var a=t.getGraphics3DGraphicById(r.uid);a&&e(a,r)&&(i=!0)}),i&&(this.owner.view.deconflictor.setDirty(),
this.owner.view.labeler.setDirty())}},t.prototype.forEachGraphics3DSymbol=function(e){var t=this;this.graphicsBySymbol.forEach(function(i,r){var a=t.symbols.get(r);a&&e(a,i,r)})},t.prototype.updateAllGraphicsVisibility=function(){var e=this;this.forEachGraphics3DGraphic(function(t,i){var r=t.setVisibilityFlag(0,i.visible),a=!1;return e.scaleVisibility&&(a=e.scaleVisibility.updateGraphicScaleVisibility(t)),r||a})},t.prototype.hideAllGraphics=function(){this.forEachGraphics3DGraphic(function(e){return e.setVisibilityFlag(0,!1)})},t.prototype.validateRenderer=function(e){var t=E.validateTo3D(e);if(t){var i="Renderer for layer '"+(this.layer.title?this.layer.title+", ":"")+", id:"+this.layer.id+"' is not supported in a SceneView";Q.warn(i,t.message)}},t.prototype.volatileGraphicsUpdated=function(){this.labeling&&(this.lastFastUpdate=g(),this.labeling.reset()),this.stageLayer.invalidateSpatialQueryAccelerator(),this.stageLayer.shaderTransformationChanged(),this.notifyChange("updating")},t.prototype._cleanupSymbols=function(){var e=this;if(!(this.graphicsWaitingForSymbol.size>0)){var t=!1;this.symbols.forEach(function(i,r){if(i&&!(i.referenced>0)){var a=e.graphicsBySymbol.get(r);a&&0!==a.size||(e.graphicsBySymbol.delete(r),e.symbols.delete(r),i&&i.destroy(),t=!0)}}),t&&this.notifyChange("maxSymbolComplexity")}},t.prototype.snapshotInternals=function(){var e=this;return{graphics:p.keysOfMap(this.graphics).sort(),symbols:p.keysOfMap(this.symbols).sort(),graphicsBySymbol:p.keysOfMap(this.graphicsBySymbol).sort().map(function(t){return{symbolId:t,graphics:p.keysOfMap(e.graphicsBySymbol.get(t)).sort()}}),graphicsWithoutSymbol:Object.keys(this.graphicsWithoutSymbol).sort(),graphicsDrapedUids:p.keysOfSet(this.graphicsDrapedUids).sort(),pendingUpdates:this.pendingUpdates}},Object.defineProperty(t.prototype,"debug",{get:function(){return{symbols:this.symbols}},enumerable:!0,configurable:!0}),t.prototype.getStats=function(){return{coreVisible:this.graphics.size,coreMissing:Object.keys(this.graphicsWithoutSymbol).length,corePending:this.pendingUpdates.size}};var h;return t.tmpVec=C.vec3f64.create(),r([w.property({readOnly:!0})],t.prototype,"computedExtent",void 0),r([w.property({readOnly:!0})],t.prototype,"elevationAlignment",void 0),r([w.property({readOnly:!0})],t.prototype,"scaleVisibility",void 0),r([w.property({readOnly:!0})],t.prototype,"spatialIndex",void 0),r([w.property({readOnly:!0})],t.prototype,"deconfliction",void 0),r([w.property({readOnly:!0})],t.prototype,"labeling",void 0),r([w.property({readOnly:!0})],t.prototype,"highlights",void 0),r([w.property()],t.prototype,"asyncUpdates",void 0),r([w.property({constructOnly:!0})],t.prototype,"elevationFeatureExpressionEnabled",void 0),r([w.property({constructOnly:!0})],t.prototype,"owner",void 0),r([w.property({constructOnly:!0})],t.prototype,"layer",void 0),r([w.property({constructOnly:!0})],t.prototype,"basemapTerrain",void 0),r([w.property({readOnly:!0})],t.prototype,"hasDraped",void 0),r([w.property({readOnly:!0})],t.prototype,"symbolsUpdating",void 0),r([w.property({constructOnly:!0})],t.prototype,"graphicSymbolSupported",void 0),r([w.property({readOnly:!0,dependsOn:["elevationAlignment.updating","scaleVisibility.updating"]})],t.prototype,"updating",null),r([w.property({readOnly:!0})],t.prototype,"updatingRemaining",null),r([w.property({readOnly:!0})],t.prototype,"updatingTotal",null),r([w.property({readOnly:!0,dependsOn:["owner.view.qualitySettings.graphics3D.maxTotalNumberOfPrimitives","owner.view.qualitySettings.graphics3D.maxTotalNumberOfFeatures","maxSymbolComplexity"]})],t.prototype,"displayFeatureLimit",null),r([w.property({readOnly:!0})],t.prototype,"maxSymbolComplexity",null),t=h=r([w.subclass("esri.views.3d.layers.graphics.Graphics3DCore")],t)}(w.declared(h)),J=new Map,K=new f,X=new b(f),Z=(function(){function e(){this.add=null,this.remove=null}}(),10);return Y});