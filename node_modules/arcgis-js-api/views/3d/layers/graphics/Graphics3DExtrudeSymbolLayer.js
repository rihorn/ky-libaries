// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.10/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/extendsHelper","../../../../core/compilerUtils","../../../../core/libs/earcut/earcut","../../../../core/libs/gl-matrix-2/gl-matrix","../../../../geometry/Polygon","../../../../layers/graphics/dehydratedFeatures","./Graphics3DObject3DGraphicLayer","./Graphics3DSymbolCommonCode","./Graphics3DSymbolLayer","./graphicUtils","../support/edgeUtils","../../support/projectionUtils","../../webgl-engine/Stage","../../webgl-engine/lib/Geometry","../../webgl-engine/lib/GeometryData","../../webgl-engine/lib/Object3D","../../webgl-engine/lib/Util","../../webgl-engine/materials/DefaultMaterial"],function(e,t,r,a,n,i,o,s,l,c,p,h,g,d,u,v,y,f,m,_){function E(e,t,r,a,n,i,o,s,l,c,p,h,g,d){var u=r.length/3,v=0;p+=2*a.count,b(e,t,a.index,a.count,r,0,u,n,i,o,s,l,c,p,h,g,d),l+=2*a.count,p+=2*u,p-=2*a.count+2*u,S(n,i,s,o,v,a.pathLengths[0],a.count,l,c,p,h),l+=4*a.pathLengths[0],p+=2*a.pathLengths[0],v+=a.pathLengths[0];for(var y=1;y<a.pathLengths.length;++y)S(n,i,s,o,v,a.pathLengths[y],a.count,l,c,p,h),l+=4*a.pathLengths[y],p+=2*a.pathLengths[y],v+=a.pathLengths[y]}function b(e,t,r,a,n,o,s,l,c,p,h,g,d,u,v,y,f){i.vec3.copy(C,y);for(var m=v>0?1:-1,_=3*r,E=g,b=3*E,x=g+a,S=3*x,A=0;A<a;++A)f&&(C[0]=e[_+0],C[1]=e[_+1],C[2]=e[_+2],i.vec3.normalize(C,C)),l[b+0]=e[_+0],l[b+1]=e[_+1],l[b+2]=e[_+2],c[b+0]=t[_+0],c[b+1]=t[_+1],c[b+2]=t[_+2],p[b+0]=-m*C[0],p[b+1]=-m*C[1],p[b+2]=-m*C[2],h[E]=0,l[S+0]=e[_+0]+v*C[0],l[S+1]=e[_+1]+v*C[1],l[S+2]=e[_+2]+v*C[2],c[S+0]=t[_+0],c[S+1]=t[_+1],c[S+2]=t[_+2],p[S+0]=m*C[0],p[S+1]=m*C[1],p[S+2]=m*C[2],h[x]=v,b+=3,S+=3,_+=3,E+=1,x+=1;_=3*o,b=3*u,S=3*(u+s);b=3*(u+s),S=3*u;var w=P,O=D;v<0&&(w=D,O=P);for(var A=0;A<s;++A)d[b+0]=n[_+w[0]],d[b+1]=n[_+w[1]],d[b+2]=n[_+w[2]],d[S+0]=n[_+O[0]]+a,d[S+1]=n[_+O[1]]+a,d[S+2]=n[_+O[2]]+a,b+=3,S+=3,_+=3}function x(e,t,r,a,n,i,o){a[i]=a[o],o*=3,i*=3,e[i+0]=e[o+0],e[i+1]=e[o+1],e[i+2]=e[o+2],t[i+0]=t[o+0],t[i+1]=t[o+1],t[i+2]=t[o+2],r[i+0]=n[0],r[i+1]=n[1],r[i+2]=n[2]}function S(e,t,r,a,n,i,o,s,l,c,p){var h=n,g=n+1,d=n+o,u=n+o+1,v=s,y=s+1,f=s+2*i,m=s+2*i+1;p<0&&(h=n+o+1,u=n),c*=3;for(var _=0;_<i;++_)_===i-1&&(p>0?(g=n,u=n+o):(g=n,h=n+o)),A(e,h,g,d,R),x(e,t,a,r,R,v,h),x(e,t,a,r,R,y,g),x(e,t,a,r,R,f,d),x(e,t,a,r,R,m,u),l[c++]=v,l[c++]=f,l[c++]=m,l[c++]=v,l[c++]=m,l[c++]=y,h++,g++,d++,u++,v+=2,y+=2,f+=2,m+=2}function A(e,t,r,a,n){t*=3,r*=3,a*=3,i.vec3.set(T,e[t++],e[t++],e[t++]),i.vec3.set(V,e[r++],e[r++],e[r++]),i.vec3.set(G,e[a++],e[a++],e[a++]),i.vec3.subtract(I,V,T),i.vec3.subtract(j,G,T),i.vec3.cross(n,j,I),i.vec3.normalize(n,n)}function w(e,t,r,a){L.spatialReference=r.spatialReference;for(var n=e.getGeometryRecords(),i=n.length,o="absolute-height"!==t.mode,s=0,l=0;l<i;l++){var p=n[l].geometry,h=n[l].transformation;F[0]=h[12],F[1]=h[13],F[2]=h[14],p.invalidateBoundingInfo();for(var g=p.data.getVertexAttr(),d=g[m.VertexAttrConstants.POSITION].data,u=g[m.VertexAttrConstants.SIZE].data,v=g.mapPos.data,y=d.length/3,f=0,_=0,E=!1,b=0,x=0;x<y;x++){L.x=v[_],L.y=v[_+1],L.z=v[_+2],U[0]=d[f],U[1]=d[f+1],U[2]=d[f+2];var S=c.computeElevation(r,L,t,a,o?M:null);o&&(b+=M.terrainElevation),O[0]=d[f]+F[0],O[1]=d[f+1]+F[1],O[2]=d[f+2]+F[2],a.setAltitude(S+u[f/3],O),d[f]=O[0]-F[0],d[f+1]=O[1]-F[1],d[f+2]=O[2]-F[2];var A=.01/a.unitInMeters;(Math.abs(U[0]-d[f])>A||Math.abs(U[1]-d[f+1])>A||Math.abs(U[2]-d[f+2])>A)&&(E=!0),_+=3,f+=3}E&&e.geometryVertexAttrsUpdated(l),s+=b/y}return s/i}var O=i.vec3f64.create(),C=i.vec3f64.create(),P=[0,2,1],D=[0,1,2],L=s.makeDehydratedPoint(0,0,0,null),M={verticalDistanceToGround:0,terrainElevation:0},z=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._edgeStageObjects=new Set,t}return r(t,e),t.prototype._prepareResources=function(){if(!this._isPropertyDriven("size")){var e=h.validateSymbolLayerSize(this._getSymbolSize());if(e)return this._logWarning(e),void this.reject()}var t=this._getStageIdHint(),r=this._getMaterialOpacityAndColor(),a=i.vec3f64.fromArray(r),n=r[3],o={diffuse:a,ambient:a,opacity:n,transparent:n<1||this._isPropertyDriven("opacity"),vertexColors:!0,slicePlaneEnabled:this._context.slicePlaneEnabled};this._material=new _(o,t+"_3dlinemat"),this._context.stage.add(u.ModelContentType.MATERIAL,this._material),this.resolve()},t.prototype.destroy=function(){e.prototype.destroy.call(this),this.isFulfilled()||this.reject(),this._material&&this._context.stage.remove(u.ModelContentType.MATERIAL,this._material.id)},t.prototype.createGraphics3DGraphic=function(e){var t=e.renderingInfo,r=e.graphic,a=r.geometry;if("polygon"!==a.type&&"extent"!==a.type)return this._logWarning("unsupported geometry type for extrude symbol: "+a.type),null;if(!this._validateGeometry(a))return null;var n="polygon"===a.type||"extent"===a.type?"rings":"paths",i="graphic"+r.uid,o=this._getVertexOpacityAndColor(t,Float32Array,255),s=this.getGraphicElevationContext(r);return this._createAs3DShape(r,n,t,o,s,i,r.uid)},t.prototype.layerOpacityChanged=function(){var e=this._getMaterialOpacity(),t=e<1||this._isPropertyDriven("opacity");if(this._material.setParameterValues({opacity:e,transparent:t}),this._edgeStageObjects.size>0){var r=this._context.stage.view.getEdgeView(),a=this._getLayerOpacity();this._edgeStageObjects.forEach(function(e){r.updateAllComponentOpacities(e,[a])})}return!0},t.prototype.layerElevationInfoChanged=function(e,t){return this.updateGraphics3DGraphicElevationInfo(e,t,c.needsElevationUpdates3D)},t.prototype.slicePlaneEnabledChanged=function(e,t){var r=this;if(this._material.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled}),this._edgeStageObjects.size>0){var n=this._context.stage.view.getEdgeView(),i=this._createEdgeMaterial(n);if(a.isSome(i)){var o=[i];this._edgeStageObjects.forEach(function(e){n.updateAllComponentMaterials(e,o,{slicePlaneEnabled:r._context.slicePlaneEnabled},!1)})}}return!0},t.prototype._getExtrusionSize=function(e){var t;return t=e.size&&this._isPropertyDriven("size")?c.getSingleSizeDriver(e.size,2):this._getSymbolSize(),t/=this._context.renderCoordsHelper.unitInMeters},t.prototype._getSymbolSize=function(){return this.symbol.size||1},t.prototype._createAs3DShape=function(e,t,r,s,p,h,g){var u=this,y=e.geometry;"extent"===y.type&&(y=o.fromExtent(y));var m=y[t],_=[],b=[],x=[],S=i.vec3f64.create(),A=new Array(6),O=this._context.renderSpatialReference===d.SphericalECEFSpatialReference,C=this._getExtrusionSize(r),P=i.vec3f64.create();O||this._context.renderCoordsHelper.worldUpAtPosition(null,P);var D=c.getGeometryVertexData3D(m,y.hasZ,y.spatialReference,this._context.renderSpatialReference,this._context.elevationProvider,this._context.renderCoordsHelper,p);if(this._logGeometryCreationWarnings(D,m,t,"ExtrudeSymbol3DLayer"),m.length>0){for(var L=D.geometryData.polygons,M=D.eleVertexData,z=D.vertexData,R=z.length/3,T=new Float64Array(3*R*6),V=new Float64Array(3*R*6),G=new Float64Array(3*R*6),I=new Float64Array(1*R*6),j=0,U=this,F=0;F<L.length;++F)!function(e){var t=L[e],r=t.count,a=t.index;if(U._context.clippingExtent&&(c.computeBoundingBox(M,a,r,A),c.boundingBoxClipped(A,U._context.clippingExtent)))return"continue";var o=new Float64Array(M.buffer,3*a*T.BYTES_PER_ELEMENT,3*r),l=t.holeIndices.map(function(e){return e-a}),p=n(o,l,3);if(p.length>0){c.chooseOrigin(z,a,r,S);var g=3*r*2+2*p.length,d=new Uint32Array(g),u=6*r,y=new Float64Array(T.buffer,3*j*T.BYTES_PER_ELEMENT,3*u),f=new Float64Array(V.buffer,3*j*V.BYTES_PER_ELEMENT,3*u),m=new Float64Array(G.buffer,3*j*G.BYTES_PER_ELEMENT,3*u),w=new Float64Array(I.buffer,1*j*I.BYTES_PER_ELEMENT,1*u);E(z,M,p,t,y,m,f,w,0,d,0,C,P,O),c.subtractCoordinates(y,0,u,S),j+=6*r;var D=U._createExtrudeGeometry(d,{positions:y,elevation:m,normals:f,heights:w},s),R=new v(D,h+"path"+e);R.singleUse=!0,_.push(R),b.push(U._material);var F=i.mat4f64.create();i.mat4.translate(F,F,S),x.push(F)}}(F);if(_.length>0){var N=new f({geometries:_,materials:b,transformations:x,castShadow:!0,metadata:{layerUid:this._context.layer.uid,graphicUid:g},idHint:h}),B=function(e){var t=u._context.stage.view.getEdgeView();if(t){t.removeObject(e),u._edgeStageObjects.delete(e);var r=u._createEdgeMaterial(t);a.isSome(r)&&(u._edgeStageObjects.add(e),t.addObject(e,[r],{slicePlaneEnabled:u._context.slicePlaneEnabled}))}};B(N);var H=function(e,t,r,a){var n=w(e.stageObject,t,r,a);return B(N),n},Y=new l(this,N,_,null,null,H,p);return Y.alignedTerrainElevation=D.terrainElevation,Y.needsElevationUpdates=c.needsElevationUpdates3D(p.mode),Y}return null}return null},t.prototype._createExtrudeGeometry=function(e,t,r){for(var a=e.length,n=e,i=new Uint32Array(a),o=0;o<a;o++)i[o]=0;var s={},l={};return s[m.VertexAttrConstants.POSITION]=n,s[m.VertexAttrConstants.NORMAL]=n,s[m.VertexAttrConstants.COLOR]=i,l[m.VertexAttrConstants.POSITION]={size:3,data:t.positions},l[m.VertexAttrConstants.NORMAL]={size:3,data:t.normals},l[m.VertexAttrConstants.COLOR]={size:4,data:r},l[m.VertexAttrConstants.SIZE]={size:1,data:t.heights},t.elevation&&(l.mapPos={size:3,data:t.elevation},s.mapPos=n),new y(l,s)},t.prototype._createEdgeMaterial=function(e){var t={opacity:this._getLayerOpacity()};return g.createMaterial(e,this.symbol,t)},t}(p),R=i.vec3f64.create(),T=i.vec3f64.create(),V=i.vec3f64.create(),G=i.vec3f64.create(),I=i.vec3f64.create(),j=i.vec3f64.create(),U=i.vec3f64.create(),F=i.vec3f64.create();return z});