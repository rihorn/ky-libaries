// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.10/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/extendsHelper","dojo/errors/CancelError","../../../../Color","../../../../core/asyncUtils","../../../../core/lang","../../../../core/screenUtils","../../../../core/libs/gl-matrix-2/gl-matrix","../../../../geometry/support/aaBoundingBox","../../../../symbols/ObjectSymbol3DLayer","./ElevationAligners","./Graphics3DLodInstanceGraphicLayer","./Graphics3DSymbolCommonCode","./Graphics3DSymbolLayer","./graphicUtils","./lodResourceUtils","./objectResourceUtils","./primitiveObjectSymbolUtils","./symbolComplexity","../support/FastSymbolUpdates","../../support/projectionUtils","../../webgl-engine/Stage","../../webgl-engine/lib/Util","../../webgl-engine/lib/lodRendering/LodRenderer","../../webgl-engine/lib/lodRendering/LodResources","../../webgl-engine/materials/DefaultMaterial"],function(e,t,r,i,o,s,a,n,l,c,p,d,u,h,m,f,_,y,v,b,g,x,R,S,P,E,C){var U=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._instanceIndexToGraphicUid=new Map,t}return r(t,e),Object.defineProperty(t.prototype,"lodRenderer",{get:function(){return this._lodRenderer},enumerable:!0,configurable:!0}),t.prototype._prepareResources=function(){var e=this.symbol,t=this._getStageIdHint();if(this._optionalFields=[],!this._isPropertyDriven("size")){var r=f.validateSymbolLayerSize(this.symbol);if(r)return this._logWarning(r),void this.reject()}if(e.resource&&e.resource.href)this._prepareModelResources(e.resource.href,t);else{var i=e.resource?e.resource.primitive:"sphere";this._preparePrimitiveResources(i,t)}},t.prototype._preparePrimitiveResources=function(e,t){if(!v.isValidPrimitive(e))return this._logWarning("Unknown object symbol primitive: "+e),void this.reject();var r=this.symbol;this._resourceBoundingBox=c.create(v.primitiveBoundingBox(e)),this._resourceSize=l.vec3f64.fromArray(c.size(this._resourceBoundingBox)),this._symbolSize=l.vec3f64.fromArray(f.computeSizeWithResourceSize(this._resourceSize,r));var i=this._getMaterialOpacity(),s={specular:[0,0,0],opacity:i,transparent:i<1||this._isPropertyDriven("opacity"),instanced:["transformation"],ambient:L,diffuse:L,slicePlaneEnabled:this._context.slicePlaneEnabled},p=this.symbolContainer;if("point-3d"===p.type&&p.verticalOffset){var d=p.verticalOffset,u=d.screenLength,h=d.minWorldLength,m=d.maxWorldLength;s.verticalOffset={screenLength:n.pt2px(u),minWorldLength:h||0,maxWorldLength:null!=m?m:1/0},s.castShadows=!1}if(this._context.screenSizePerspectiveEnabled&&(s.screenSizePerspective=this._context.sharedResources.screenSizePerspectiveSettings),this._isPropertyDriven("color"))s.externalColor=z;else{var _=r.material?o.toUnitRGBA(r.material.color):z;s.externalColor=_}this._fastUpdates=g.initFastSymbolUpdatesState(this._context.renderer,this._fastVisualVariableConvertOptions()),this._fastUpdates.enabled?(a.mixin(s,this._fastUpdates.materialParameters),s.instanced.push("featureAttribute"),this._optionalFields.push("featureAttribute")):this._hasPerInstanceColor()&&(s.instanced.push("color"),this._optionalFields.push("color"));var y=new C(s,t+"_objectmat");if(this._lodResources=v.primitiveLodResources(e,y,t),this._originalOpacities=E.materialsFromLodResources(this._lodResources).map(function(){return 1}),!this._lodResources)return this._logWarning("Unknown object symbol primitive: "+e),void this.reject();this.finalizeSymbolResources(),this.initializeLodRenderer(),this.complexity=this.computeComplexity(),this.resolve()},t.prototype._prepareModelResources=function(e,t){var r=this,o=["transformation"],p={instanced:o,slicePlaneEnabled:this._context.slicePlaneEnabled},d={materialParamsMixin:p,idHint:t,streamDataSupplier:this._context.streamDataSupplier};this._fastUpdates=g.initFastSymbolUpdatesState(this._context.renderer,this._fastVisualVariableConvertOptions()),this._fastUpdates.enabled?(a.mixin(d.materialParamsMixin,this._fastUpdates.materialParameters),o.push("featureAttribute"),this._optionalFields.push("featureAttribute")):this._hasPerInstanceColor()&&(o.push("color"),this._optionalFields.push("color"));var u=this.symbolContainer;if("point-3d"===u.type&&u.verticalOffset){var h=u.verticalOffset,m=h.screenLength,v=h.minWorldLength,b=h.maxWorldLength;d.materialParamsMixin.verticalOffset={screenLength:n.pt2px(m),minWorldLength:v||0,maxWorldLength:null!=b?b:1/0},d.materialParamsMixin.castShadows=!1}this._symbolLoaderPromise=s.safeCast(y.fetch(e,d)),this._symbolLoaderPromise.then(function(e){if(r._symbolLoaderPromise=null,!r.isRejected()){var t=_.makeLodResources(e.lods);_.fillEstimatedMinScreenSpaceRadius(t),t.levels.sort(function(e,t){return e.minScreenSpaceRadius-t.minScreenSpaceRadius}),t.levels[0].minScreenSpaceRadius=Math.min(2,t.levels[0].minScreenSpaceRadius),r._lodResources=t;var i=r._context,o=r.symbol.material,s=r._getExternalColorParameters(o),a=r._getMaterialOpacity(),n=r._isPropertyDriven("opacity"),p=E.materialsFromLodResources(r._lodResources);r._originalOpacities=p.map(function(e){return e.getParameterValues().opacity||1}),p.forEach(function(e){var t=e.getParameterValues();e.setParameterValues(s);var r=t.opacity*a,o=r<1||n||t.transparent;e.setParameterValues({opacity:r,transparent:o}),i.screenSizePerspectiveEnabled&&e.setParameterValues({screenSizePerspective:i.sharedResources.screenSizePerspectiveSettings})}),r._resourceBoundingBox=e.referenceBoundingBox,r._resourceSize=l.vec3f64.fromArray(c.size(r._resourceBoundingBox)),r._pivotOffset=l.vec3f64.fromArray(r._lodResources.levels[0].pivotOffset),r._symbolSize=l.vec3f64.fromArray(f.computeSizeWithResourceSize(r._resourceSize,r.symbol)),g.updateFastSymbolUpdatesState(r._fastUpdates,r._context.renderer,r._fastVisualVariableConvertOptions())&&p.forEach(function(e){return e.setParameterValues(r._fastUpdates.materialParameters)}),r.finalizeSymbolResources(),r.initializeLodRenderer(),r.complexity=r.computeComplexity(),r.resolve()}},function(e){if(r._symbolLoaderPromise=null,!r.isFulfilled()){if(!(e instanceof i)){var t="ObjectSymbol3DLayer failed to load";e&&e.message&&(t+=" ("+e.message+")"),r._logWarning(t)}r.reject()}})},t.prototype.finalizeSymbolResources=function(){var e=this._context.stage;this._materials=E.materialsFromLodResources(this._lodResources),this._materials.forEach(function(t){e.add(R.ModelContentType.MATERIAL,t)}),this._textures=E.texturesFromLodResources(this._lodResources),this._textures.forEach(function(t){e.add(R.ModelContentType.TEXTURE,t)}),this._geometries=E.geometriesFromLodResources(this._lodResources),this._geometries.forEach(function(t){e.add(R.ModelContentType.GEOMETRY,t)})},t.prototype.initializeLodRenderer=function(){var e=this,t=this._context.stage,r=function(t){return{layerUid:e._context.layer.uid,graphicUid:e._instanceIndexToGraphicUid.get(t)}},i=this._fastUpdates.enabled?{applyTransform:function(t,r,i){t.getFeatureAttribute(r,M),l.mat4.copy(i,g.evaluateModelTransform(e._fastUpdates.materialParameters,M,i))},scaleFactor:function(t,r){return t.getFeatureAttribute(r,M),g.evaluateModelTransformScaleFactor(e._fastUpdates.materialParameters,M)}}:null;this._lodRenderer=new P.LodRenderer(this._lodResources,this._optionalFields,r,i),this._lodRenderer.slicePlaneEnabled=this._context.slicePlaneEnabled,t.addRenderPlugin(this._lodRenderer.slots,this._lodRenderer)},t.prototype._getExternalColorParameters=function(e){var t={};return this._isPropertyDriven("color")?t.externalColor=z:e&&e.color?t.externalColor=o.toUnitRGBA(e.color):(t.externalColor=z,t.colorMixMode="ignore"),t},t.prototype.destroy=function(){e.prototype.destroy.call(this),this.isFulfilled()||this.reject(),this._symbolLoaderPromise&&this._symbolLoaderPromise.cancel();var t=this._context.stage;this._lodRenderer&&(t.removeRenderPlugin(this._lodRenderer),this._lodRenderer.destroy()),this._materials&&this._materials.forEach(function(e){return t.remove(R.ModelContentType.MATERIAL,e.id)}),this._textures&&this._textures.forEach(function(e){return t.remove(R.ModelContentType.TEXTURE,e.id)}),this._geometries&&this._geometries.forEach(function(e){return t.remove(R.ModelContentType.GEOMETRY,e.id)})},t.prototype.createGraphics3DGraphic=function(e){var t=e.graphic;if(!this._validateGeometry(t.geometry))return null;var r=h.placePointOnGeometry(t.geometry);if(!r)return this._logWarning("unsupported geometry type for icon symbol: "+t.geometry.type),null;var i="graphic"+t.uid,o=this.getGraphicElevationContext(t),s=e.renderingInfo;return this._createAs3DShape(t,r,s,o,i,t.uid)},t.prototype.notifyDestroyGraphicLayer=function(e){this._instanceIndexToGraphicUid.delete(e.instanceIndex)},t.prototype.graphicLayerToGraphicId=function(e){return 0},t.prototype.layerOpacityChanged=function(){var e=this,t=this._isPropertyDriven("opacity");return this._materials.forEach(function(r,i){var o=e._getMaterialOpacity()*e._originalOpacities[i];r.setParameterValues({opacity:o,transparent:o<1||t})}),!0},t.prototype.layerElevationInfoChanged=function(e,t){return this.updateGraphics3DGraphicElevationInfo(e,t,h.needsElevationUpdates3D)},t.prototype.slicePlaneEnabledChanged=function(e,t){var r=this;return this._lodRenderer.slicePlaneEnabled=this._context.slicePlaneEnabled,this._materials.forEach(function(e){e.setParameterValues({slicePlaneEnabled:r._context.slicePlaneEnabled})}),!0},t.prototype.applyRendererDiff=function(e,t){var r=this;for(var i in e.diff)switch(i){case"visualVariables":if(!g.updateFastSymbolUpdatesState(this._fastUpdates,t,this._fastVisualVariableConvertOptions()))return!1;this._materials.forEach(function(e){return e.setParameterValues(r._fastUpdates.materialParameters)}),this._lodRenderer.notifyShaderTransformationChanged();break;default:return!1}return!0},t.prototype.computeComplexity=function(){return this._lodResources?{primitivesPerFeature:E.geometriesFromLodLevelResources(this._lodResources.levels[0]).reduce(function(e,t){return e+t.data.getIndices(S.VertexAttrConstants.POSITION).length},0)/3,primitivesPerCoordinate:0,memory:b.defaultSymbolLayerMemoryComplexity(this.symbolContainer,this.symbol)}:e.prototype.computeComplexity.call(this)},t.prototype._createAs3DShape=function(e,t,r,i,o,s){var a=this.getFastUpdateAttrValues(e),n=!this._fastUpdates.enabled&&this._hasPerInstanceColor()?f.mixinColorAndOpacity(r.color,r.opacity):null,c=this._context.clippingExtent;if(x.pointToVector(t,B,this._context.elevationProvider.spatialReference),c&&!h.pointInBox2D(B,c))return null;x.pointToVector(t,B,this._context.renderSpatialReference);var p="absolute-height"!==i.mode,m=h.computeElevation(this._context.elevationProvider,t,i,this._context.renderCoordsHelper,p?V:null),_=l.mat4.identity(T);this._applyObjectRotation(r,_),this._applyObjectRotation(this.symbol,_),this._applyObjectScale(r,_),this._applyAnchor(_),B[0]=t.x,B[1]=t.y,B[2]=m;var y=A;x.computeLinearTransformation(t.spatialReference,B,y,this._context.renderSpatialReference)||console.warn("Could not locate symbol object properly, it might be misplaced");var v=this._lodRenderer.instanceData,b=v.addInstance();this._instanceIndexToGraphicUid.set(b,s),v.setLocalTransform(b,_,!1),v.setGlobalTransform(b,y),a&&v.setFeatureAttribute(b,a),n&&v.setColor(b,n);var g=d.perLodInstanceElevationAligner,R=new u(this,b,g,i);return p&&(R.alignedTerrainElevation=V.terrainElevation),R.needsElevationUpdates=h.needsElevationUpdates3D(i.mode),h.extendPointGraphicElevationContext(R,t,this._context.elevationProvider),R},t.prototype._applyObjectScale=function(e,t){if(!this._fastUpdates.enabled||!this._fastUpdates.requiresShaderTransformation){var r=this._isPropertyDriven("size")&&e.size?e.size:this._symbolSize,i=f.computeObjectScale(r,this._symbolSize,this._resourceSize,this._context.renderCoordsHelper.unitInMeters);1===i[0]&&1===i[1]&&1===i[2]||l.mat4.scale(t,t,i)}},t.prototype._applyObjectRotation=function(e,t){if(!(this._fastUpdates.enabled&&this._fastUpdates.requiresShaderTransformation&&e instanceof p))return f.computeObjectRotation(e.heading,e.tilt,e.roll,t)},t.prototype._computeAnchor=function(){var e=l.vec3f64.create();switch(this.symbol.anchor){case"center":l.vec3.copy(e,c.center(this._resourceBoundingBox)),l.vec3.negate(e,e);break;case"top":var t=c.center(this._resourceBoundingBox);l.vec3.set(e,-t[0],-t[1],-this._resourceBoundingBox[5]);break;case"bottom":var t=c.center(this._resourceBoundingBox);l.vec3.set(e,-t[0],-t[1],-this._resourceBoundingBox[2]);break;case"relative":var t=c.center(this._resourceBoundingBox),r=c.size(this._resourceBoundingBox),i=this.symbol.anchorPosition,o=i?l.vec3f64.fromValues(i.x,i.y,i.z):O;l.vec3.multiply(e,r,o),l.vec3.add(e,e,t),l.vec3.negate(e,e);break;case"origin":default:this._pivotOffset?l.vec3.negate(e,this._pivotOffset):l.vec3.copy(e,O)}return e},t.prototype._applyAnchor=function(e){if(!this._fastUpdates.enabled||!this._fastUpdates.requiresShaderTransformation){var t=this._computeAnchor();t&&l.mat4.translate(e,e,t)}},t.prototype._hasPerInstanceColor=function(){return this._isPropertyDriven("color")||this._isPropertyDriven("opacity")},t.prototype._fastVisualVariableConvertOptions=function(){var e=this._resourceBoundingBox?l.vec3f64.fromArray(c.size(this._resourceBoundingBox)):L,t=this._resourceBoundingBox?this._computeAnchor():O,r=this._context.renderCoordsHelper.unitInMeters,i=f.computeObjectScale(this._symbolSize,this._symbolSize,this._resourceSize,r),o=l.vec3f64.fromValues(this.symbol.tilt||0,this.symbol.roll||0,this.symbol.heading||0);return{modelSize:e,symbolSize:this._symbolSize||L,unitInMeters:r,transformation:{anchor:t,scale:i,rotation:o}}},t}(m),L=l.vec3f64.fromValues(1,1,1),z=l.vec4f64.fromValues(1,1,1,1),O=l.vec3f64.fromValues(0,0,0),B=l.vec3f64.create(),T=l.mat4f64.create(),A=l.mat4f64.create(),M=l.vec4f64.create(),V={verticalDistanceToGround:0,terrainElevation:0};return U});