// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.10/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/declareExtendsHelper","../../../../core/tsSupport/decorateHelper","../../../../Color","../../../../core/Accessor","../../../../core/Handles","../../../../core/promiseUtils","../../../../core/screenUtils","../../../../core/accessorSupport/decorators","../../../../layers/support/LabelClass","../../../../symbols/callouts/calloutUtils","./Graphics3DCalloutSymbolLayerFactory","./graphicUtils","./labelPlacement","../../support/debugFlags","../../webgl-engine/Stage","../../webgl-engine/lib/Layer","../../webgl-engine/lib/MaterialCollection","../../webgl-engine/lib/TextTexture","../../webgl-engine/lib/TextTextureAtlas"],function(e,t,a,l,i,s,r,n,o,c,h,b,p,u,d,f,y,g,C,x,v){Object.defineProperty(t,"__esModule",{value:!0});var m=function(e){function t(t){var a=e.call(this)||this;return a.labelStageLayer=null,a.labels={},a.labelsToAdd={},a.labelsToRemove={},a.labelingContexts=[],a.idHint="__labeler",a.dirty=!1,a}a(t,e),s=t,t.prototype.setup=function(){var e=this;this.handles||(this.handles=new r,this.handles.add([this.view.watch("state.camera",function(){return e.setDirty()})])),this.labelStageLayer||(this.labelStageLayer=new g(this.idHint,{isPickable:!1},this.idHint+"_labels"),this.view._stage.add(y.ModelContentType.LAYER,this.labelStageLayer),this.view._stage.addToViewContent([this.labelStageLayer.id]),this.textTextureAtlas=new v(this.idHint+"_atlas",this.view),this.hudMaterialCollection=new C(this.view._stage),this.calloutMaterialCollection=new C(this.view._stage)),this.handles.add(this.view.resourceController.registerIdleFrameWorker({needsUpdate:function(){return e.needsIdleUpdate()},idleFrame:function(t){return e.idleUpdate(t)}}))},t.prototype.dispose=function(){this.handles&&(this.handles.destroy(),this.handles=null),this.labelStageLayer&&(this.view._stage.removeFromViewContent([this.labelStageLayer.id]),this.view._stage.remove(y.ModelContentType.LAYER,this.labelStageLayer.id),this.labelStageLayer=null,this.textTextureAtlas.dispose(),this.textTextureAtlas=null,this.hudMaterialCollection.dispose(),this.hudMaterialCollection=null,this.calloutMaterialCollection.dispose(),this.calloutMaterialCollection=null),this.labelingContexts=[],this.labels={},this.labelsToAdd={},this.labelsToRemove={}},t.prototype.isActiveLabelingContext=function(e){return e.active&&this.labelsEnabled(e)},t.prototype.activateLabelingContext=function(e){for(var t in e.labels){var a=e.labels[t];this.labels[t]=a,a.graphics3DGraphic.setVisibilityFlag(0,!0,1)}e.active=!0},t.prototype.deactivateLabelingContext=function(e){for(var t in e.labels){var a=e.labels[t];a.graphics3DGraphic.setVisibilityFlag(0,!1,1),a.rendered&&(this.labelsToRemove[t]=e.labels[t]),delete this.labels[t],delete this.labelsToAdd[t]}e.active=!1},t.prototype.addLabelTextureToAtlas=function(e){for(var t=0,a=0;a<e.graphics3DGraphic._labelGraphics.length;a++){var l=e.graphics3DGraphic._labelGraphics[a];if(l._labelClass){var i=e.textTextures[t];t++,i&&this.textTextureAtlas.addTextTexture(i,l.stageObject)}}e.rendered=!0},t.prototype.removeLabelTextureFromAtlas=function(e){for(var t=e.graphics3DGraphic,a=0;a<t._labelGraphics.length;a++)e.textTextures[a]&&this.textTextureAtlas.removeTextTexture(e.textTextures[a],t._labelGraphics[a].stageObject);e.rendered=!1},t.prototype.needsIdleUpdate=function(){return this.isDirty},t.prototype.idleUpdate=function(e){if(this.view.ready){for(var t=!!e,a=!1,l=!1,i=0,s=this.labelingContexts;i<s.length;i++){var r=s[i];if(this.isActiveLabelingContext(r)){if(!this.hasValidLabelClassContext(r)){if(this.hasInvalidLabelClassContext(r)){this.deactivateLabelingContext(r);continue}if(this.createLabelClassContext(r),this.hasPendingLabelClassContext(r)){a=!0;continue}if(!this.hasValidLabelClassContext(r))continue}for(var n in r.labelsToInitialize){if(t&&e.done())return;var o=r.labelsToInitialize[n];!o.hasGraphics3DResources&&this.createGraphics3DResources(o)&&(this.labels[n]=o,l=!0),o.hasGraphics3DResources&&!o.hasTextTextureResources&&o.visible&&this.createTextTextureResources(o),(o.visible&&o.hasTextTextureResources||!o.visible&&o.hasGraphics3DResources)&&delete r.labelsToInitialize[n]}}}t&&l&&this.view.deconflictor.setDirty();for(var n in this.labelsToRemove)this.removeLabelTextureFromAtlas(this.labelsToRemove[n]),delete this.labelsToRemove[n];for(var n in this.labelsToAdd)this.addLabelTextureToAtlas(this.labelsToAdd[n]),delete this.labelsToAdd[n];a||(this.dirty=!1)}},t.prototype.hasPendingLabelClassContext=function(e){return e.labelClassPromise&&!e.labelClassPromise.isResolved()},t.prototype.hasValidLabelClassContext=function(e){return e.labelClassContexts&&e.labelClassContexts.length},t.prototype.hasInvalidLabelClassContext=function(e){return null===e.labelClassContexts},t.prototype.createLabelClassContext=function(e){return e.labelClassPromise?e.labelClassPromise:(e.labelClassPromise=e.layer.when(function(){e.scaleVisibility&&e.scaleVisibility.updateScaleRangeActive();var t=e.graphics3DCore,a=t.layer.labelingInfo&&t.layer.labelingInfo.filter(function(e){return!!e.symbol});if(!a||0===a.length)return null;var l=new Array(a.length),i=a.map(function(e,a){var i=e.symbol,s=u.getGraphics3DSymbol(t.getOrCreateGraphics3DSymbol(i)),r=null;return b.isCalloutSupport(i)&&i.hasVisibleCallout()&&(r=p.make(i,t.symbolCreationContext)),l[a]={labelClass:e,graphics3DSymbol:s,graphics3DCalloutSymbolLayer:r,options:e.getOptions(),calloutSymbolLayerIndex:0},s});return n.all(i).then(function(){return l})}).then(function(t){t&&(e.labelClassContexts=t)}).catch(function(){e.labelClassContexts=null}),e.labelClassPromise)},t.prototype.destroyLabelClassContext=function(e){for(var t=0,a=e.labelClassContexts;t<a.length;t++){var l=a[t];--l.graphics3DSymbol.referenced,l.graphics3DSymbol=null}e.labelClassContexts=[],e.labelClassPromise=null},t.prototype.createLabelText=function(e,t,a,l){if(!h.evaluateWhere(t.where,e.attributes))return null;var i=t.getLabelExpression();return i.expression?h.buildLabelText(i.expression,e,l.fields,a):null},t.prototype.createTextSymbolGraphic=function(e,t,a,l,i){var r={text:e,centerOffset:a.centerOffset,translation:a.translation,elevationOffset:a.elevationOffset,screenOffset:a.screenOffset,anchor:a.anchor,needsOffsetAdjustment:a.needsOffsetAdjustment,centerOffsetUnits:a.centerOffsetUnits,verticalOffset:a.verticalOffset,debugDrawBorder:f.LABELS_SHOW_BORDER};return s.tmpGraphicCreationContext.graphic=t,s.tmpGraphicCreationContext.renderingInfo=null,s.tmpGraphicCreationContext.layer=l,i.createGraphics3DGraphic(s.tmpGraphicCreationContext,r,this.hudMaterialCollection,this.textTextureAtlas)},t.prototype.createLineCalloutGraphic=function(e,t,a,l,i){return s.tmpGraphicCreationContext.graphic=e,s.tmpGraphicCreationContext.renderingInfo={symbol:t,needsOffsetAdjustment:l.needsOffsetAdjustment,translation:l.translation,elevationOffset:l.elevationOffset,screenOffset:l.screenOffset,centerOffset:l.centerOffset,centerOffsetUnits:l.centerOffsetUnits,materialCollection:this.calloutMaterialCollection},s.tmpGraphicCreationContext.layer=i,a.createGraphics3DGraphic(s.tmpGraphicCreationContext)},t.prototype.createGraphics3DResources=function(e){var t=e.graphics3DGraphic;if(t.destroyed)return!1;var a=e.labelingContext,l=!1,i=t.graphic,s=a.labelClassContexts,r=a.layer,n=this.labelsEnabled(a);if(!s||0===s.length||!t._graphics[0])return!1;for(var o=0,c=s;o<c.length;o++){var h=c[o],b=h.labelClass,p=h.options,u=this.createLabelText(i,b,p,r);if(u){var f=h.graphics3DSymbol,y=null;f.symbol&&"label-3d"===f.symbol.type&&(y=f.symbol);var g=f.childGraphics3DSymbols[0],C=d.get({graphics3DGraphic:t,labelSymbol:y,labelClass:h.labelClass});if(g&&C){var x=this.createTextSymbolGraphic(u,i,C,r,g);if(!x)return!1;if(x._labelClass=b,t.addLabelGraphic(x,this.labelStageLayer,this.view._stage),a.spatialIndex&&a.spatialIndex.add(t),t.setVisibilityFlag(0,n,1),t.setVisibilityFlag(1,void 0,1),t.setVisibilityFlag(2,!1,1),l=!0,h.graphics3DCalloutSymbolLayer&&C.hasLabelVerticalOffset){var v=this.createLineCalloutGraphic(i,y,h.graphics3DCalloutSymbolLayer,C,r);v&&(h.calloutSymbolLayerIndex=t._labelGraphics.length,t.addLabelGraphic(v,this.labelStageLayer,this.view._stage))}break}}}return a.scaleVisibility&&l&&a.scaleVisibility.updateGraphicLabelScaleVisibility(t),e.hasGraphics3DResources=!0,!0},t.prototype.destroyGraphics3DResources=function(e){e.graphics3DGraphic.clearLabelGraphics(),e.hasGraphics3DResources=!1},t.prototype.createTextTextureResources=function(e){var t=e.labelingContext,a=e.graphics3DGraphic,l=t.labelClassContexts,s=t.layer,r=a.graphic;if(l&&0!==l.length&&a._graphics[0]){for(var n=0,c=l;n<c.length;n++){var h=c[n],b=h.labelClass,p=h.options,u=this.createLabelText(r,b,p,s)||r.symbol&&r.symbol.text;if(u&&!(u.length<1)){var d=h.graphics3DSymbol.childGraphics3DSymbols[0],f=d.symbol,y=f.material?i.toUnitRGBA(f.material.color):T,g=f.halo&&f.halo.color&&f.halo.size>0,C=g?i.toUnitRGBA(f.halo.color):T,v=g?o.pt2px(f.halo.size):0,m=o.pt2px(f.size)||12,L=s.id+"_label_"+r.uid,G=new x(u,{size:m,color:y,font:{family:f.font&&f.font.family?f.font.family:"sans-serif",weight:f.font&&f.font.weight?f.font.weight:"normal",style:f.font&&f.font.style?f.font.style:"normal"},halo:{size:v,color:C}},L);e.textTextures.push(G)}}e.hasTextTextureResources=!0}},t.prototype.destroyTextTextureResources=function(e){e.textTextures=[],e.hasTextTextureResources=!1},t.prototype.addGraphic=function(e,t){var a={hasGraphics3DResources:!1,hasTextTextureResources:!1,visible:!1,rendered:!1,labelingContext:e,graphics3DGraphic:t,textTextures:[]},l=t.graphic.uid;e.labels[l]=a,this.isActiveLabelingContext(e)&&this.hasValidLabelClassContext(e)&&this.createGraphics3DResources(a)?this.labels[l]=a:e.labelsToInitialize[l]=a;var i=e.graphics3DCore.asyncUpdates;this.setDirty(i),this.view.deconflictor.setDirty()},t.prototype.removeGraphic=function(e,t){var a=t.graphic.uid,l=e.labels[a];if(l){this.labels[a]&&(this.removeLabelTextureFromAtlas(l),delete this.labels[a],delete this.labelsToAdd[a],delete this.labelsToRemove[a]),l.hasTextTextureResources&&this.destroyTextTextureResources(l),l.hasGraphics3DResources&&this.destroyGraphics3DResources(l),delete e.labels[a],delete e.labelsToInitialize[a];var i=e.graphics3DCore.asyncUpdates;this.setDirty(i),this.view.deconflictor.setDirty()}},t.prototype.labelsEnabled=function(e){return!0===e.layer.labelsVisible&&null!=e.layer.labelingInfo&&e.layer.labelingInfo.length>0},t.prototype.labelingInfoChange=function(e,t){if(t){for(var a=0,l=t;a<l.length;a++){var i=l[a],s=e.labels[i];s&&(this.removeGraphic(e,s.graphics3DGraphic),this.addGraphic(e,s.graphics3DGraphic))}return n.create(function(e){return!0})}return this.visibilityInfoChange(e),this.resetLabels(e),this.createLabelClassContext(e)},t.prototype.layerPropertyChanged=function(e,t){for(var a=0,l=t.labelClassContexts;a<l.length;a++){var i=l[a];!function(a){var l=new Map;for(var i in t.labels){var s=t.labels[i],r=s.graphics3DGraphic;l.set(r.graphic.uid,r)}var n=function(e){return e._labelGraphics[0]};if(a.graphics3DSymbol.childGraphics3DSymbols[0].layerPropertyChanged(e,l,n),a.graphics3DCalloutSymbolLayer){var o=function(e){return e._labelGraphics[a.calloutSymbolLayerIndex]};a.graphics3DCalloutSymbolLayer.layerPropertyChanged(e,l,o)}}(i)}},t.prototype.visibilityInfoChange=function(e){var t=e.layer.labelsVisible;t&&!e.active&&this.activateLabelingContext(e),!t&&e.active&&this.deactivateLabelingContext(e);var a=e.graphics3DCore.asyncUpdates;this.setDirty(a)},t.prototype.resetLabels=function(e){for(var t in e.labels){var a=e.labels[t];this.labels[t]&&(this.removeLabelTextureFromAtlas(a),delete this.labels[t],delete this.labelsToAdd[t],delete this.labelsToRemove[t]),a.hasTextTextureResources&&this.destroyTextTextureResources(a),a.hasGraphics3DResources&&this.destroyGraphics3DResources(a),a.visible=!1,a.rendered=!1,e.labelsToInitialize[t]=a}this.destroyLabelClassContext(e),this.labelStageLayer.invalidateSpatialQueryAccelerator();var l=e.graphics3DCore.asyncUpdates;this.setDirty(l),this.view.deconflictor.setDirty()},t.prototype.findLabelingContext=function(e){for(var t=0,a=this.labelingContexts;t<a.length;t++){var l=a[t];if(l.graphics3DCore===e)return l}return null},t.prototype.addGraphicsOwner=function(e,t,a){var l=this;if(!this.findLabelingContext(e)){var i={graphics3DCore:e,layer:e.layer,scaleVisibility:t,spatialIndex:a,active:e.layer.labelsVisible,labelClassPromise:null,labelClassContexts:[],labels:{},labelsToInitialize:{}};return this.labelingContexts.push(i),this.setDirty(),{addGraphic:function(e){return l.addGraphic(i,e)},removeGraphic:function(e){return l.removeGraphic(i,e)},layerLabelsEnabled:function(){return l.labelsEnabled(i)},labelingInfoChange:function(e){return l.labelingInfoChange(i,e)},elevationInfoChange:function(){return l.layerPropertyChanged("elevationInfo",i)},slicePlaneEnabledChange:function(){return l.layerPropertyChanged("slicePlaneEnabled",i)},visibilityInfoChange:function(){return l.visibilityInfoChange(i)},reset:function(){return l.resetLabels(i)}}}},t.prototype.removeGraphicsOwner=function(e){var t=this.findLabelingContext(e);if(t){var a=this.labelingContexts.indexOf(t);this.labelingContexts.splice(a,1);for(var l in t.labels)this.removeGraphic(t,t.labels[l].graphics3DGraphic);this.setDirty()}},t.prototype.setLabelGraphicVisibility=function(e,t){var a=e.graphic.uid,l=this.labels[a];if(l){t&&!l.rendered?(this.labelsToAdd[a]=l,l.hasTextTextureResources||(l.labelingContext.labelsToInitialize[a]=l)):!t&&l.rendered&&(this.labelsToRemove[a]=l),l.visible=t;var i=l.labelingContext.graphics3DCore.asyncUpdates;this.setDirty(i)}},Object.defineProperty(t.prototype,"labelStageLayerId",{get:function(){return this.labelStageLayer.id},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isDirty",{get:function(){return this.dirty||this.textTextureAtlas&&this.textTextureAtlas.isDirty},enumerable:!0,configurable:!0}),t.prototype.setDirty=function(e){void 0===e&&(e=!0),this.dirty=!0,e||this.idleUpdate()},Object.defineProperty(t.prototype,"updating",{get:function(){return this.labelingContexts.some(function(e){return e.labelClassPromise&&!e.labelClassPromise.isResolved()})},enumerable:!0,configurable:!0});var s;return t.tmpGraphicCreationContext={graphic:null,renderingInfo:null,layer:null},l([c.property({constructOnly:!0})],t.prototype,"view",void 0),l([c.property({type:Boolean,readOnly:!0})],t.prototype,"updating",null),t=s=l([c.subclass()],t)}(c.declared(s));t.Labeler=m;var T=[0,0,0,1]});