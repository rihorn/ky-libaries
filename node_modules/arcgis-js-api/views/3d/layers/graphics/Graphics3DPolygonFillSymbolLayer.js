// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.10/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/extendsHelper","../../../../Color","../../../../core/screenUtils","../../../../core/libs/earcut/earcut","../../../../core/libs/gl-matrix-2/gl-matrix","../../../../geometry/Polygon","../../../../geometry/support/aaBoundingBox","./ElevationAligners","./Graphics3DDrapedGraphicLayer","./Graphics3DObject3DGraphicLayer","./Graphics3DSymbolCommonCode","./Graphics3DSymbolLayer","./graphicUtils","./lineUtils","../../webgl-engine/Stage","../../webgl-engine/lib/Geometry","../../webgl-engine/lib/GeometryData","../../webgl-engine/lib/Object3D","../../webgl-engine/lib/RenderGeometry","../../webgl-engine/lib/Util","../../webgl-engine/materials/ColorMaterial"],function(t,e,r,i,a,n,o,l,s,u,c,p,h,d,y,m,g,_,f,v,x,E,O){var b=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e._elevationOptions={supportsOffsetAdjustment:!1,supportsOnTheGround:!0},e}return r(e,t),e.prototype._prepareResources=function(){this._prepareFillResources(),this._prepareOutlineResources(),this.resolve()},e.prototype._prepareFillResources=function(){var t=this._getStageIdHint(),e=this._getMaterialOpacityAndColor(),r={color:e,transparent:e[3]<1||this._isPropertyDriven("opacity"),polygonOffset:!1,vertexColors:!0,slicePlaneEnabled:this._context.slicePlaneEnabled};this._material=new O(r,t+"_colormat"),this._context.stage.add(g.ModelContentType.MATERIAL,this._material)},e.prototype._prepareOutlineResources=function(){var t=this.symbol.outline;if(this._hasOutline=!!(t&&t.size&&t.size>0&&t.color),this._hasOutline){var e={idHint:this._getStageIdHint()+"_outline",color:this._getOutlineColor(),width:a.pt2px(t.size),slicePlaneEnabled:this._context.slicePlaneEnabled};this._outlineMaterial=e.width>=1.5?m.createRibbonMaterial(e):m.createNativeMaterial(e),this._context.stage.add(g.ModelContentType.MATERIAL,this._outlineMaterial)}},e.prototype.destroy=function(){t.prototype.destroy.call(this),this.isFulfilled()||this.reject(),this._material&&(this._context.stage.remove(g.ModelContentType.MATERIAL,this._material.id),this._material=null),this._outlineMaterial&&(this._context.stage.remove(g.ModelContentType.MATERIAL,this._outlineMaterial.id),this._outlineMaterial=null)},e.prototype.createGraphics3DGraphic=function(t){var e=t.graphic,r=e.geometry.type;if("polyline"!==r&&"polygon"!==r&&"extent"!==r)return this._logWarning("unsupported geometry type for fill symbol: "+r),null;if(!this._validateGeometry(e.geometry))return null;var i="graphic"+e.uid,a=this._getVertexOpacityAndColor(t.renderingInfo,Uint8Array,255),n=this.getGraphicElevationContext(e);return"on-the-ground"===n.mode?this._createAsOverlay(e,a,n,i):this._createAs3DShape(e,a,n,i,e.uid)},e.prototype.layerOpacityChanged=function(){var t=this._material.getColor(),e=this._getMaterialOpacity();if(this._material.setColor([t[0],t[1],t[2],e]),this._material.setTransparent(e<1||this._isPropertyDriven("opacity")),this._outlineMaterial){var r=this._outlineMaterial.getColor(),i=[r[0],r[1],r[2],this._getOutlineOpacity()],a={color:i};this._outlineMaterial.setParameterValues(a)}return!0},e.prototype.layerElevationInfoChanged=function(t,e,r){var i=this._elevationContext.mode;if(null==r||null==i)return!1;if("on-the-ground"===r&&"on-the-ground"===i)return!0;if(r!==i&&("on-the-ground"===r||"on-the-ground"===i))return!1;var a=h.needsElevationUpdates2D(i);return this.updateGraphics3DGraphicElevationInfo(t,e,function(){return a})},e.prototype.slicePlaneEnabledChanged=function(t,e){if(this._material.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled}),this._outlineMaterial){var r={slicePlaneEnabled:this._context.slicePlaneEnabled};this._outlineMaterial.setParameterValues(r)}return!0},e.prototype.setDrawOrder=function(t,e,r){this.updateSymbolLayerOrder(t,e),this._material&&(this._material.renderPriority=t+e/2,r.add(this._material.id)),this._outlineMaterial&&(this._outlineMaterial.renderPriority=t,r.add(this._outlineMaterial.id))},e.prototype._createAs3DShape=function(t,e,r,i,a){var n=this._getPolyGeometry(t),o=n.rings,l=this._getOutlineGeometry(n,o),s=h.getGeometryVertexData3D(l,n.hasZ,n.spatialReference,this._context.renderSpatialReference,this._context.elevationProvider,this._context.renderCoordsHelper,r);A.idHint=i,A.color=e,A.data=s;var c;if(this._hasOutline){c=new(0,s.vertexData.constructor)(s.vertexData)}if(A.outNum=0,A.outGeometries=[],A.outTransforms=[],A.outMaterials=[],this._createAs3DShapeFill(A),A.data.vertexData=c,this._createAs3DShapeOutline(A),this._logGeometryCreationWarnings(A.data,o,"rings","FillSymbol3DLayer"),0===A.outNum)return null;var d=new v({geometries:A.outGeometries,materials:A.outMaterials,transformations:A.outTransforms,castShadow:!1,metadata:{layerUid:this._context.layer.uid,graphicUid:a},idHint:i}),y=u.perVertexElevationAligner,m=new p(this,d,A.outGeometries,null,null,y,r);return m.alignedTerrainElevation=s.terrainElevation,m.needsElevationUpdates=h.needsElevationUpdates2D(r.mode),m},e.prototype._createAs3DShapeFill=function(t){for(var e=t.data.geometryData.polygons,r=t.data.eleVertexData,i=t.data.vertexData,a=this,l=0;l<e.length;++l)!function(l){var s=e[l],u=s.count,c=s.index;if(a._context.clippingExtent&&(h.computeBoundingBox(r,c,u,D),h.boundingBoxClipped(D,a._context.clippingExtent)))return"continue";var p=new Float64Array(r.buffer,3*c*r.BYTES_PER_ELEMENT,3*u),d=new Float64Array(i.buffer,3*c*i.BYTES_PER_ELEMENT,3*u),y=s.holeIndices.map(function(t){return t-c}),m=n(p,y,3);if(0===m.length)return"continue";h.chooseOrigin(i,c,u,G),h.subtractCoordinates(i,c,u,G);var g=a._createFillGeometry(m,0,d,p,t.color),f=new _(g,t.idHint);f.singleUse=!0;var v=o.mat4f64.create();o.mat4.translate(v,v,G),t.outGeometries.push(f),t.outMaterials.push(a._material),t.outTransforms.push(v),t.outNum++}(l)},e.prototype._createAs3DShapeOutline=function(t){if(this._hasOutline)for(var e=t.data.geometryData.outlines,r=t.data.eleVertexData,i=t.data.vertexData,a=0;a<e.length;++a){var n=e[a],l=n.index,s=n.count;if(!this._context.clippingExtent||(h.computeBoundingBox(r,l,s,D),!h.boundingBoxClipped(D,this._context.clippingExtent))){h.chooseOrigin(i,l,s,G),h.subtractCoordinates(i,l,s,G);var u=new Float64Array(r.buffer,3*l*r.BYTES_PER_ELEMENT,3*s),c=new Float64Array(i.buffer,3*l*i.BYTES_PER_ELEMENT,3*s),p=m.createPolylineGeometry(c,u,!1,M,0),d=new _(p,t.idHint+"outline"+a);d.singleUse=!0;var y=o.mat4f64.create();o.mat4.translate(y,y,G),t.outGeometries.push(d),t.outMaterials.push(this._outlineMaterial),t.outTransforms.push(y),t.outNum++}}},e.prototype._createAsOverlay=function(t,e,r,i){var a=this._getPolyGeometry(t),n=a.rings,o=this._getOutlineGeometry(a,n);this._material.renderPriority=this._symbolLayerOrder+this._symbolLayerOrderDelta/2,this._hasOutline&&(this._outlineMaterial.renderPriority=this._symbolLayerOrder);var l=h.getGeometryVertexDataDraped(o,a.spatialReference,this._context.overlaySR);A.idHint=i,A.color=e,A.data=l;var u;if(this._hasOutline){u=new(0,l.vertexData.constructor)(l.vertexData)}return A.outNum=0,A.outGeometries=[],A.outBoundingBox=s.empty(),this._createAsOverlayFill(A),A.data.vertexData=u,this._createAsOverlayOutline(A),this._logGeometryCreationWarnings(A.data,n,"rings","FillSymbol3DLayer"),A.outNum>0?new c(this,A.outGeometries,A.outBoundingBox):null},e.prototype._createAsOverlayFill=function(t){for(var e=t.data.vertexData,r=t.data.geometryData.polygons,i=this,a=0;a<r.length;++a)!function(a){var l=r[a],u=l.count,c=l.index,p=new Float64Array(e.buffer,3*c*e.BYTES_PER_ELEMENT,3*u),d=l.holeIndices.map(function(t){return t-c}),y=n(p,d,3);if(0===y.length)return"continue";if(h.computeBoundingBox(e,c,u,D),h.boundingBoxClipped(D,i._context.clippingExtent))return"continue";s.expand(t.outBoundingBox,D),h.chooseOrigin(e,c,u,G),h.subtractCoordinates(e,c,u,G),h.setZ(e,c,u,i._getDrapedZ());var m=o.mat4f64.create();o.mat4.translate(m,m,G);var g=i._createFillGeometry(y,c,e,null,t.color),_=new x(g);_.material=i._material;var f=D;_.center=[.5*(f[0]+f[3]),.5*(f[1]+f[4]),0],_.bsRadius=.5*Math.sqrt((f[3]-f[0])*(f[3]-f[0])+(f[4]-f[1])*(f[4]-f[1])),_.transformation=m,_.name=t.idHint,_.uniqueName=t.idHint+"#"+g.id,t.outGeometries.push(_),t.outNum++}(a)},e.prototype._createAsOverlayOutline=function(t){if(this._hasOutline)for(var e=t.data.vertexData,r=t.data.geometryData.outlines,i=0;i<r.length;++i){var a=r[i],n=a.index,l=a.count;if(h.computeBoundingBox(e,n,l,D),!h.boundingBoxClipped(D,this._context.clippingExtent)){s.expand(t.outBoundingBox,D),h.chooseOrigin(e,n,l,G),h.subtractCoordinates(e,n,l,G),h.setZ(e,n,l,this._getDrapedZ());var u=new Float64Array(e.buffer,3*n*e.BYTES_PER_ELEMENT,3*l),c=o.mat4f64.create();o.mat4.translate(c,c,G);var p=m.createPolylineGeometry(u,null,!0,M,0),d=new x(p);d.material=this._outlineMaterial;var y=D;d.center=[.5*(y[0]+y[3]),.5*(y[1]+y[4]),0],d.bsRadius=.5*Math.sqrt((y[3]-y[0])*(y[3]-y[0])+(y[4]-y[1])*(y[4]-y[1])),d.transformation=c,d.name=t.idHint+"outline",d.uniqueName=t.idHint+"outline#"+p.id,t.outGeometries.push(d),t.outNum++}}},e.prototype._getOutlineGeometry=function(t,e){return e},e.prototype._getOutlineOpacity=function(){return this._getLayerOpacity()*this.symbol.outline.color.a},e.prototype._getOutlineColor=function(){var t=this.symbol.outline.color,e=this._getOutlineOpacity();return y.mixinColorAndOpacity(i.toUnitRGB(t),e)},e.prototype._getPolyGeometry=function(t){var e=t.geometry;return"extent"===e.type?l.fromExtent(e):e},e.prototype._createFillGeometry=function(t,e,r,i,a){for(var n=t.length,o=new Uint32Array(n),l=new Uint32Array(n),s=0;s<n;s++)o[s]=t[s]+e,l[s]=0;var u={},c={};return u[E.VertexAttrConstants.POSITION]=o,u[E.VertexAttrConstants.COLOR]=l,c[E.VertexAttrConstants.POSITION]={size:3,data:r},c[E.VertexAttrConstants.COLOR]={size:4,data:a},i&&(c.mapPos={size:3,data:i},u.mapPos=o),new f(c,u)},e}(d),D=s.create(),G=o.vec3f64.create(),M=new Float32Array([255,255,255,255]),A={idHint:null,color:null,data:null,outNum:0,outBoundingBox:null,outGeometries:null,outMaterials:null,outTransforms:null};return b});