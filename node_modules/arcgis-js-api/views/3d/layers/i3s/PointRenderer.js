// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.10/esri/copyright.txt for details.

define(["require","exports","../../../../core/libs/gl-matrix-2/gl-matrix","../../../../geometry/support/aaBoundingBox","../../support/geometryUtils","../../support/orientedBoundingBox","../../webgl-engine/lib/ProgramRepository","../../webgl-engine/materials/internal/MaterialUtil","../../webgl-engine/shaders/PointRendererPrograms","../../../webgl/BufferObject","../../../webgl/VertexArrayObject"],function(e,t,i,r,n,s,a,o,l,c,d){function p(e){return e?256:64}function u(e,t,i,r,n){if(i.drawScreenSpace)return i.fixedSize*t*r;var s=p(n)*t*r;return i.drawFixedSize?Math.min(i.fixedSize/2,s):i.screenMinSize>0?Math.min(Math.max(i.screenMinSize*t*r,e/2),s):Math.min(e/2,s)}function h(e,t,i,r,n){return i.drawScreenSpace?0:u(e,t,i,r,n)}function m(e,t,r){return null==r&&(r=i.vec3f64.create()),r[0]=e.origin[0]+e.coordinates[3*t],r[1]=e.origin[1]+e.coordinates[3*t+1],r[2]=e.origin[2]+e.coordinates[3*t+2],r}var f=i.mat4f64.create(),g={positions:[{name:"aPosition",count:3,type:5126,offset:0,stride:12,normalized:!1}],colors:[{name:"aColor",count:3,type:5121,offset:0,stride:3,normalized:!0}]},_=function(){function e(){this.didRender=!1,this.needsRender=!0,this.layerUid="",this._useFixedSizes=!1,this._scaleFactor=1,this._minSizePx=0,this._useRealWorldSymbolSizes=!1,this._size=0,this._sizePx=0,this._slicePlaneEnabled=!1,this._clipBox=r.create(r.POSITIVE_INFINITY),this._programRep=null,this._needsPrograms=!0,this._programWorld=null,this._programScreen=null,this._programWorldDepth=null,this._programScreenDepth=null,this.tempMatrix4=i.mat4f32.create(),this.tempVec3=i.vec3f32.create(),this.nodes=[]}return e.prototype.initializeRenderContext=function(e){var t=e.rctx;this._programRep=new a(t),this.needsRender=!0,this._needsPrograms=!0},e.prototype.uninitializeRenderContext=function(e){this._programRep.dispose(),this._programRep=null,this._programWorld=null,this._programScreen=null,this._programWorldDepth=null,this._programScreenDepth=null},e.prototype.intersect=function(e,t,a,o,l){var c=i.vec3f64.create(),d=i.vec3f64.create(),p=i.vec3f64.create(),g=i.vec3f64.create(),_=n.plane.create(),v=e.camera.perPixelRatio,S=e.camera.near,b=this._getSizeParams();i.vec3.subtract(d,o,a);var P=1/i.vec3.length(d);i.vec3.scale(d,d,P),i.vec3.negate(p,d),i.vec4.set(_,d[0],d[1],d[2],-i.vec3.dot(d,a));var x={},y={},z=r.create(),R=r.create(this._clipBox);r.offset(R,-a[0],-a[1],-a[2],R);for(var M=0,I=this.nodes;M<I.length;M++){var w=I[M],U=w.splatSize*this._scaleFactor,F=s.minimumDistancePlane(w.obb,_),E=s.maximumDistancePlane(w.obb,_);F-=h(U,F+S,b,v,w.isLeaf),E-=h(U,E+S,b,v,w.isLeaf);var V=E<0,O=null!=x.dist&&null!=y.dist&&x.dist<F*P&&y.dist>E*P;if(!V&&!O){var q=u(U,E+S,b,v,w.isLeaf);if(s.intersectLine(w.obb,a,d,q)){var W=q*q;s.toAaBoundingBox(w.obb,z),r.offset(z,-a[0],-a[1],-a[2],z);var j=!r.contains(R,z);i.vec3.subtract(g,w.origin,a);for(var B=w.coordinates.length/3,D=0;D<B;D++)if(c[0]=g[0]+w.coordinates[3*D],c[1]=g[1]+w.coordinates[3*D+1],c[2]=g[2]+w.coordinates[3*D+2],!j||r.containsPoint(R,c)){var N=i.vec3.dot(c,d),L=i.vec3.squaredLength(c)-N*N;if(!(L>W)){var C=N+S,T=h(U,C,b,v,w.isLeaf);if(!(N-T<0)){C-=T;var A=u(U,C,b,v,w.isLeaf);if(!(L>A*A)){var H=this.layerUid+"/"+w.id+"/"+D,Y=(N-T)*P;if(null==x.dist||Y<x.dist){var k=x;(null==t||t(a,o,Y))&&(k.point=m(w,D,k.point),k.dist=Y,k.normal=p,k.pointId=H,k.layerUid=this.layerUid)}if(null==y.dist||Y>y.dist){var k=y;(null==t||t(a,o,Y))&&(k.point=m(w,D,k.point),k.dist=Y,k.normal=p,k.pointId=H,k.layerUid=this.layerUid)}}}}}}}}if(null!=x.dist){var G=e.minResult;if(null==G.dist||x.dist<G.dist){var J={type:"external",point:x.point,metadata:{pointId:x.pointId,layerUid:x.layerUid}};G.set(J,x.pointId,x.dist,x.normal,f,void 0),G.setIntersector("PointRenderer")}}if(null!=y.dist){var K=e.maxResult;if(null==K.dist||y.dist>K.dist){var J={type:"external",point:y.point,metadata:{pointId:y.pointId,layerUid:y.layerUid}};K.set(J,y.pointId,y.dist,y.normal,f,void 0),K.setIntersector("PointRenderer")}}},e.prototype.render=function(e){if(0!==e.pass&&1!==e.pass)return!1;for(var t=1===e.pass,n=e.rctx,s=0,a=this.nodes;s<a.length;s++){var l=a[s];null==l.vao&&this._initNode(e,l)}this._selectPrograms();var c=this._getSizeParams(),d=t?c.drawScreenSpace?this._programScreenDepth:this._programWorldDepth:c.drawScreenSpace?this._programScreen:this._programWorld;if(null==d||0===this.nodes.length)return!0;var u=this._clipBox,h=!r.equals(u,r.POSITIVE_INFINITY,function(e,t){return e===t});h||(i.vec3.set(this.tempVec3,-1/0,-1/0,-1/0),d.setUniform3fv("uClipMin",this.tempVec3),i.vec3.set(this.tempVec3,1/0,1/0,1/0),d.setUniform3fv("uClipMax",this.tempVec3)),n.setDepthTestEnabled(!0),n.bindProgram(d),d.setUniformMatrix4fv("uProjectionMatrix",e.camera.projectionMatrix),t&&d.setUniform2f("nearFar",e.camera.near,e.camera.far),c.drawFixedSize&&d.setUniform2f("uPointScale",c.fixedSize,e.camera.fullHeight);for(var m=this._slicePlaneEnabled?e.sliceHelper&&e.sliceHelper.plane:null,f=0,g=this.nodes;f<g.length;f++){var l=g[f];if(d.setUniform2f("uScreenMinMaxSize",c.screenMinSize,p(l.isLeaf)),!c.drawFixedSize){var _=l.splatSize*this._scaleFactor;d.setUniform2f("uPointScale",_,e.camera.fullHeight)}var v=l.origin;h&&(i.vec3.set(this.tempVec3,u[0]-v[0],u[1]-v[1],u[2]-v[2]),d.setUniform3fv("uClipMin",this.tempVec3),i.vec3.set(this.tempVec3,u[3]-v[0],u[4]-v[1],u[5]-v[2]),d.setUniform3fv("uClipMax",this.tempVec3)),i.mat4.identity(this.tempMatrix4),i.mat4.translate(this.tempMatrix4,this.tempMatrix4,v),i.mat4.multiply(this.tempMatrix4,e.camera.viewMatrix,this.tempMatrix4),d.setUniformMatrix4fv("uModelViewMatrix",this.tempMatrix4),m&&o.bindSlicePlane(v,m,d),n.bindVAO(l.vao),n.drawArrays(0,0,l.coordinates.length/3)}return!0},Object.defineProperty(e.prototype,"useFixedSizes",{get:function(){return this._useFixedSizes},set:function(e){this._useFixedSizes!==e&&(this._useFixedSizes=e,this._requestRender())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"scaleFactor",{get:function(){return this._scaleFactor},set:function(e){this._scaleFactor!==e&&(this._scaleFactor=e,this._requestRender())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"minSizePx",{get:function(){return this._minSizePx},set:function(e){this._minSizePx!==e&&(this._minSizePx=e,this._requestRender())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"useRealWorldSymbolSizes",{get:function(){return this._useRealWorldSymbolSizes},set:function(e){this._useRealWorldSymbolSizes!==e&&(this._useRealWorldSymbolSizes=e,this._requestRender())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"size",{get:function(){return this._size},set:function(e){this._size!==e&&(this._size=e,this._requestRender())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"sizePx",{get:function(){return this._sizePx},set:function(e){this._sizePx!==e&&(this._sizePx=e,this._requestRender())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"clippingBox",{set:function(e){r.set(this._clipBox,e||r.POSITIVE_INFINITY)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"slicePlaneEnabled",{get:function(){return this._slicePlaneEnabled},set:function(e){this._slicePlaneEnabled!==e&&(this._slicePlaneEnabled=e,this._requestRender(),this._needsPrograms=!0)},enumerable:!0,configurable:!0}),e.prototype.addNode=function(e){this.nodes.push(e),this._requestRender()},e.prototype.removeNode=function(e){var t=null;return this.nodes=this.nodes.filter(function(i){return i.id!==e||(t=i,i.vao&&(i.vao.dispose(!0),i.vao=null),!1)}),this._requestRender(),t},e.prototype.removeAll=function(){this.nodes.forEach(function(e){e.vao&&(e.vao.dispose(!0),e.vao=null)}),this.nodes=[],this._requestRender()},e.prototype._initNode=function(e,t){var i=e.rctx;t.vao=new d(i,l.program.attributes,g,{positions:c.createVertex(i,35044,t.coordinates),colors:c.createVertex(i,35044,t.rgb)})},e.prototype._requestRender=function(){this.didRender=!1,this.needsRender=!0},e.prototype._getSizeParams=function(){var e=this._useFixedSizes,t=e&&!this._useRealWorldSymbolSizes,i=t?this._sizePx:this._size,r=this._minSizePx;return e&&(r=0),{drawScreenSpace:t,drawFixedSize:e,fixedSize:i,screenMinSize:r}},e.prototype._selectPrograms=function(){this._needsPrograms&&(this._needsPrograms=!1,this._programWorld=this._programRep.getProgram(l.program,{slicePlaneEnabled:this._slicePlaneEnabled}),this._programScreen=this._programRep.getProgram(l.program,{drawScreenSize:!0,slicePlaneEnabled:this._slicePlaneEnabled}),this._programWorldDepth=this._programRep.getProgram(l.program,{depthPass:!0,slicePlaneEnabled:this._slicePlaneEnabled}),this._programScreenDepth=this._programRep.getProgram(l.program,{drawScreenSize:!0,depthPass:!0,slicePlaneEnabled:this._slicePlaneEnabled}))},e}();return function(e){function t(e){return e.hasOwnProperty("splatSize")}e.isInstanceOfNode=t}(_||(_={})),_});