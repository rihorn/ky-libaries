// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.10/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/assignHelper","../../../../core/PooledArray","../../../../core/urlUtils","./I3SUtil","../../support/orientedBoundingBox"],function(e,t,i,r,s,n,o){var a=["version","level","sharedResource","attributeData","geometryData","textureData","lodSelection"],d=function(){function e(e,t,i,n,o,a,d,h,l,p,_,m){var c=this;this.rootId=i,this.progressiveLoadPenalty=n,this.nodeIndex=o,this.streamDataSupplier=a,this.viewportQueries=d,this.logger=h,this._isLoaded=l,this._isSelected=p,this._enable=_,this._needsUpdate=m,this._dirty=!0,this._loadingNodes=new Set,this._indexMissing=1,this._nodesMissing=0,this._maxUnloadedPrio=Number.NEGATIVE_INFINITY,this._maxProcessingPrio=Number.POSITIVE_INFINITY,this._nodeTraversalState={},this._version=0,this._featureEstimate={estimate:0,leafsReached:!1},this._unloadedMemoryEstimate=0,this._missing=new r,this._prefetch=new r,this._updates=new u,this.ignoreServiceOBB=!1,this._maxLodLevel=this.viewportQueries.maxLodLevel,this.rootUrl=s.makeAbsolute(t,e),this.traverseVisible(function(e,t){return c.nodeTraversalState(t)})}return e.prototype.requestReload=function(){this._dirty=!0,this._indexMissing=1,++this._version},e.prototype.update=function(e){var t=this;if(this._dirty){this._indexMissing=0,this._nodesMissing=0,this._maxUnloadedPrio=Number.NEGATIVE_INFINITY,this._maxProcessingPrio=Number.NEGATIVE_INFINITY,this._missing.clear(),this._prefetch.clear(),this._updates.reset(e);var r=!0,s=new h,n=new h,o=function(o,a,d){if(t._updateNodeFeatureEstimate(a,n),!a)return++t._indexMissing,t._loadingNodes.has(o.id)||t._missing.push(i({},o,{baseUrl:d})),void(t._maxProcessingPrio=Math.max(t._maxProcessingPrio,t.entryPriority(o)));if(0===t._missing.length&&a.children)for(var u=0,h=a.children;u<h.length;u++){var l=h[u];t.nodeIndex[l.id]||t._loadingNodes.has(l.id)||t._prefetch.push(i({},l,{baseUrl:a.baseUrl}))}if(!a.failed&&a.featureData&&0!==a.featureData.length){if(t._isLoaded(a))return s.known+=a.memory,++s.knownNodes,t._isSelected(a)?a.children&&(r=!1):(s.unremoved+=a.memory,r=!1),void(t._needsUpdate(a)&&(t._maxProcessingPrio=Math.max(t._maxProcessingPrio,t.entryPriority(a)),t._updates.update.push(a)));if(a.memory&&(s.known+=a.memory,++s.knownNodes),t._isSelected(a)){if(++t._nodesMissing,a.children&&(r=!1),a.memory?(s.missing+=a.memory,s.known+=a.memory,++s.knownNodes):++s.missingNodes,e.indexOf(a.id)>=0)return t._maxProcessingPrio=Math.max(t._maxProcessingPrio,t.entryPriority(a)),void(t._updates.cancel=t._updates.cancel.filter(function(e){return e!==a.id}));t._enable(a)||(t._maxProcessingPrio=Math.max(t._maxProcessingPrio,t.entryPriority(a)),t._updates.add.push(a))}}};this.traverseVisible(o),this._unloadedMemoryEstimate=s.missing-s.unremoved,s.knownNodes>3&&s.missingNodes>0&&(this._unloadedMemoryEstimate+=s.known/s.knownNodes*s.missingNodes),this._unloadedMemoryEstimate=.8*Math.max(0,this._unloadedMemoryEstimate),this._featureEstimate.estimate=this._computeFeatureEstimate(n),this._featureEstimate.leafsReached=r,this._dirty=this._indexMissing>0||this._nodesMissing>0||this._updates.add.length>0||this._updates.update.length>0||this._updates.cancel.length>0}},e.prototype.checkFeatureTarget=function(e,t){for(var i=this.viewportQueries.updateScreenSpaceErrorBias(t),r=t,s=t,n=i,o=10;o--;){var a=new h;this._updateFeatureEstimate(r,a);if(this._computeFeatureEstimate(a)<=e){if(r>=t||a.missingNodes>0||0===o)break;n=r,r=.5*(r+s)}else s=r,r=.5*(r+n)}return++this._version,this.viewportQueries.updateScreenSpaceErrorBias(i),Math.min(t,r)},e.prototype._updateFeatureEstimate=function(e,t){var i=this;++this._version,this.viewportQueries.updateScreenSpaceErrorBias(e),this.traverseVisible(function(e,r){return i._updateNodeFeatureEstimate(r,t)})},e.prototype._updateNodeFeatureEstimate=function(e,t){if(e&&!e.failed&&e.featureData&&0!==e.featureData.length)return this._isLoaded(e)?(t.known+=e.numFeatures,++t.knownNodes,void(this._isSelected(e)||(t.unremoved+=e.numFeatures))):void(this._isSelected(e)&&(e.numFeatures?(t.missing+=e.numFeatures,t.known+=e.numFeatures,++t.knownNodes):++t.missingNodes))},e.prototype._computeFeatureEstimate=function(e){var t=e.known-e.unremoved;return e.knownNodes>3&&e.missingNodes>0&&(t+=e.known/e.knownNodes*e.missingNodes),Math.max(0,t)},e.prototype.load=function(e){var t=this;return n.buildTopNodeMap(this._missing,e,function(e){return t.entryPriority(e)}),!(this._missing.length<=0)&&(this._maxUnloadedPrio=this.entryPriority(this._missing.front()),this._missing.forEach(function(e){return t._loadNode(e)}),this._missing.clear(),!0)},e.prototype.prefetch=function(e){var t=this;return n.buildTopNodeMap(this._prefetch,e,function(e){return t.entryPriority(e)}),!(this._prefetch.length<=0)&&(this._prefetch.forEach(function(e){return t._loadNode(e)}),this._prefetch.clear(),!0)},e.prototype.isLoading=function(){return this._indexMissing>0},e.prototype.getIndexLoading=function(){return this._loadingNodes.size},e.prototype.getIndexMissing=function(){return this._indexMissing},e.prototype.getUnloadedMemoryEstimate=function(){return this._unloadedMemoryEstimate},e.prototype.getNodesMissing=function(){return this._nodesMissing},e.prototype.getUpdates=function(e){var t=this;return n.buildTopNodeMap(this._updates.add,e,function(e){return t.entryPriority(e)},this._maxUnloadedPrio),n.buildTopNodeMap(this._updates.update,Number.POSITIVE_INFINITY,function(e){return t.entryPriority(e)}),this._updates},e.prototype.getFeatureEstimate=function(){return this._featureEstimate},e.prototype.nodeTraversalState=function(e){if(!e)return null;var t=this._nodeTraversalState[e.id];if(t&&t.version===this._version)return t;var i=this.viewportQueries.getLodLevel(e),r=this.viewportQueries.hasLOD(e),s=!0;if(r)if(e.parentNode){var n=this.nodeIndex[e.parentNode.id];if(null==n)return null;var o=this._nodeTraversalState[n.id];s=o&&i>o.lodLevel}else s=i>0;return t?(t.lodLevel=i,t.isChosen=s,t.version=this._version,t):(this._nodeTraversalState[e.id]={nodeHasLOD:r,lodLevel:i,isChosen:s,version:this._version},this._nodeTraversalState[e.id])},e.prototype._loadNode=function(e){var t=this;this._loadingNodes.add(e.id);var i=s.makeAbsolute(e.href,e.baseUrl);this.streamDataSupplier.request(i,"json").then(function(e,i){var r=i,s={id:r.id,mbs:r.mbs,parentNode:r.parentNode,children:r.children,featureData:r.featureData};a.forEach(function(e){s[e]=r.hasOwnProperty(e)?r[e]:null}),r.hasOwnProperty("obb")&&!t.ignoreServiceOBB&&(s.obb=o.clone(r.obb),s.hasServiceOBB=!0,t.viewportQueries.updateNode(s.id)),t.nodeIndex[s.id]=s,s.baseUrl=e,s.featureData&&1===s.featureData.length&&s.featureData[0].featureRange&&(s.numFeatures=s.featureData[0].featureRange[1]-s.featureData[0].featureRange[0]+1),t.nodeTraversalState(s),t._loadingNodes.delete(s.id),t._dirty=!0},function(r){t.loadErrorCallback(i),t._loadingNodes.delete(e.id),t._dirty=!0})},e.prototype.entryPriority=function(e){if(null==e.mbs&&e.id===this.rootId)return 1/0;var t=0,i=this.nodeIndex[e.id];if(null!=i&&null!=i.parentNode){var r=this._nodeTraversalState[i.parentNode.id];null!=r&&(t=r.lodLevel)}for(var s=this.progressiveLoadPenalty,n=i;n;n=n.parentNode?this.nodeIndex[n.parentNode.id]:null)if(this._isLoaded(n)){s=0;break}var o=this.viewportQueries.distToPOI(e);return-o-t*(o+this.progressiveLoadPenalty)+s},e.prototype.traverseVisible=function(e){var t=this.nodeIndex[this.rootId];if(!t)return void e({id:this.rootId,mbs:null,href:this.rootUrl},null,"");this._traverse({id:this.rootId,mbs:t.mbs,href:this.rootUrl},t,e,"")},e.prototype._traverse=function(e,t,i,r){if(!t.children||0===t.children.length)return void(this.viewportQueries.isGeometryVisible(t)&&i(e,t,r));if(this.viewportQueries.isNodeVisible(t)){i(e,t,r);var s=this.nodeTraversalState(t);if(!s.nodeHasLOD||s.lodLevel!==this._maxLodLevel)for(var n=0,o=t.children;n<o.length;n++){var a=o[n],d=this.nodeIndex[a.id];d?this._traverse(a,d,i,t.baseUrl):this.viewportQueries.isNodeVisible(a)&&i(a,null,t.baseUrl)}}},e.prototype.loadErrorCallback=function(e){this.logger.warn("Error loading node: "+e)},e.prototype.updateStats=function(e){if(this._nodesMissing&&(e.nodes+=" + "+Math.round(this._nodesMissing)),this._indexMissing&&(e.index+=" + "+this._indexMissing),e.prio=this._maxProcessingPrio,this._featureEstimate.estimate){var t=this._featureEstimate.estimate-e.features;t>0?e.features+=" + "+t:t<0&&(e.features+=" - "+-t)}},e.prototype.getPriority=function(){return Math.max(this._maxProcessingPrio,this._maxUnloadedPrio)},e}(),u=function(){function e(){this.update=new r,this.add=new r,this.cancel=[]}return e.prototype.reset=function(e){this.add.clear(),this.update.clear(),this.cancel=e},e}(),h=function(){function e(){this.known=0,this.knownNodes=0,this.missing=0,this.missingNodes=0,this.unremoved=0}return e}();return d});