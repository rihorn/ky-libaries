// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.10/esri/copyright.txt for details.

define(["require","exports","../../../../core/libs/gl-matrix-2/gl-matrix","./I3SBinaryReader","../../support/meshProcessing","../../webgl-engine/lib/Util"],function(e,r,t,n,a,i){function o(e,r,t,n,a){void 0===n&&(n=[]),void 0===a&&(a=[]);var i=e.params.vertexAttributes,o=i.position.count;if(!d(t[0].stride))throw l("Layout stride must use "+Uint32Array.BYTES_PER_ELEMENT+"-byte words");var v=t[0].stride/Uint32Array.BYTES_PER_ELEMENT,y=new Uint32Array(v*o);t=t.slice(0).sort(function(e,r){return e.offset-r.offset});for(var m=0,h=t;m<h.length;m++){var A=h[m];!function(e){if(-1!==a.indexOf(e.name))return"continue";var t=i[e.name],v=c(e.type),m=void 0,h=!1;if(null==t){var A=n.filter(function(r){return r.name===e.name})[0];if(!A)throw l("Geometry definition is missing attribute");t={valueType:u(e.type),byteOffset:0,count:o,valuesPerElement:e.count};for(var T=0;T<w.length;T++)w[T]=A.byteValue;m=w.buffer,h=!0}else m=r;if(u(e.type)!==t.valueType)throw l("Geometry definition type must match attribute type");if(!E(t.byteOffset)||!E(e.offset))throw l(e.name+" offset must use "+Uint32Array.BYTES_PER_ELEMENT+"-byte words");if(!d(t.valuesPerElement*v.BYTES_PER_ELEMENT)||!d(e.count*v.BYTES_PER_ELEMENT))throw l(e.name+" data must use "+Uint32Array.BYTES_PER_ELEMENT+"-byte words");var I=new Uint32Array(m),U=t.byteOffset/Uint32Array.BYTES_PER_ELEMENT,_=t.valuesPerElement*v.BYTES_PER_ELEMENT/Uint32Array.BYTES_PER_ELEMENT,b=e.offset/Uint32Array.BYTES_PER_ELEMENT,p=e.stride/Uint32Array.BYTES_PER_ELEMENT;h?f(I[0],_,y,b,p,o):s(I,U,_,y,b,p,o)}(A)}return y.buffer}function s(e,r,t,n,a,i,o){switch(t){case 1:for(var s=0;s<o;s++)n[a]=e[r],r+=1,a+=i;break;case 2:for(var s=0;s<o;s++)n[a]=e[r],n[a+1]=e[r+1],r+=2,a+=i;break;case 3:for(var s=0;s<o;s++)n[a]=e[r],n[a+1]=e[r+1],n[a+2]=e[r+2],r+=3,a+=i;break;case 4:for(var s=0;s<o;s++)n[a]=e[r],n[a+1]=e[r+1],n[a+2]=e[r+2],n[a+3]=e[r+3],r+=4,a+=i;break;default:throw l("Unhandled stride size "+t)}}function f(e,r,t,n,a,i){switch(r){case 1:for(var o=0;o<i;o++)t[n]=e,n+=a;break;case 2:for(var o=0;o<i;o++)t[n]=e,t[n+1]=e,n+=a;break;case 3:for(var o=0;o<i;o++)t[n]=e,t[n+1]=e,t[n+2]=e,n+=a;break;case 4:for(var o=0;o<i;o++)t[n]=e,t[n+1]=e,t[n+2]=e,t[n+3]=e,n+=a;break;default:throw l("Unhandled stride size "+r)}}function c(e){switch(e){case 5120:return Int8Array;case 5126:return Float32Array;case 5124:return Int32Array;case 5122:return Int16Array;case 5121:return Uint8Array;case 5125:return Uint32Array;case 5123:return Uint16Array}throw new Error("Unhandled data type: "+e)}function u(e){switch(e){case 5120:return"Int8";case 5126:return"Float32";case 5124:return"Int32";case 5122:return"Int16";case 5121:return"UInt8";case 5125:return"UInt32";case 5123:return"UInt16"}throw new Error("Unhandled data type: "+e)}function E(e){return e%Uint32Array.BYTES_PER_ELEMENT==0}function d(e){return e>0&&e%Uint32Array.BYTES_PER_ELEMENT==0}function l(e){return new Error("I3SGeometryUtil processing failed: "+e)}function v(e,r,t,a,i){if("none"===e)y(i);else{var o=n.createTypedView(t,r.params.vertexAttributes.normal),s="earth-centered"===e?a:null;m(o,i.normals,s)}}function y(e){var r=e.normals,n=e.positions,a=e.normalInd,o=e.positionInd;i.assert(e.normalInd.length===e.positionInd.length);for(var s=t.vec3f32.create(),f=t.vec3f32.create(),c=t.vec2f32.create(),u=n.data,E=n.offsetIdx,d=n.strideIdx,l=r.data,v=r.offsetIdx,y=r.strideIdx,m=0;m<o.length;m+=3){var h=o[m],w=E+d*h,A=u[w],T=u[w+1],I=u[w+2];h=o[m+1],w=E+d*h,s[0]=u[w]-A,s[1]=u[w+1]-T,s[2]=u[w+2]-I,h=o[m+2],w=E+d*h,f[0]=u[w]-A,f[1]=u[w+1]-T,f[2]=u[w+2]-I,t.vec3.cross(s,s,f),i.encodeNormal(s,c);for(var U=0;U<3;U++){var _=a[m+U],b=v+y*_;l[b]=i.encodeInt16(c[0]),l[b+1]=i.encodeInt16(c[1])}}}function m(e,r,t){var n=e.length/3,a=r.data,o=r.offsetIdx,s=r.strideIdx;if(null!=t)for(var f=t,c=f[0],u=f[1],E=f[2],d=f[4],l=f[5],v=f[6],y=f[8],m=f[9],h=f[10],w=0;w<n;w++){var A=e[3*w],U=e[3*w+1],_=e[3*w+2];T[0]=c*A+u*U+E*_,T[1]=d*A+l*U+v*_,T[2]=y*A+m*U+h*_,i.encodeNormal(T,I),a[o+w*s]=i.encodeInt16(I[0]),a[o+w*s+1]=i.encodeInt16(I[1])}else for(var w=0;w<n;w++)T[0]=e[3*w],T[1]=e[3*w+1],T[2]=e[3*w+2],i.encodeNormal(T,I),a[o+w*s]=i.encodeInt16(I[0]),a[o+w*s+1]=i.encodeInt16(I[1])}function h(e,r,t){var n=r[0];if(null==n||"position"!==n.name||5126!==n.type)return null;for(var i=new Float32Array(e),o=n.stride/4,s=3*i.length/o,f=new Float32Array(s),c=0;c<s/3;c++)f[3*c]=i[c*o+n.offset],f[3*c+1]=i[c*o+n.offset+1],f[3*c+2]=i[c*o+n.offset+2];var u,E=a.deduplicate(f.buffer,3),d=E.uniqueCount<A;if(t){u=new(d?Uint16Array:Uint32Array)(t.length);for(var c=0;c<t.length;c++)u[c]=E.indices[t[c]]}else u=d?new Uint16Array(E.indices):E.indices;return{data:new Float32Array(E.buffer),indices:u}}Object.defineProperty(r,"__esModule",{value:!0});var w=new Uint8Array(64);r.interleaveGeometryBuffer=o,r.processAndInterleaveNormals=v;var A=65536;r.extractPositionData=h;var T=t.vec3f32.create(),I=t.vec2f32.create()});