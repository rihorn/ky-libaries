// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.10/esri/copyright.txt for details.

define(["require","exports","../../../../core/arrayUtils","../../../../geometry/support/aaBoundingRect","../../../../layers/graphics/dehydratedFeatures","./FeatureTileFetcher3D"],function(e,t,r,i,s,u){function n(e,t,r){if(!t||!e||r!==t.length||r>e.length)return!1;for(var i=0;i<r;++i)if(e[i]!==t[i])return!1;return!0}var a=function(){function e(t){this.descriptor=t,this.fetchRequest=null,this.fetchStatus=0,this._features=null,this._numVertices=0,this.featureLimit=0,this.featuresMissing=!0,this._shuffled=!1,this._numFeatures=e.UNKNOWN_COUNT,this._emptyFeatureRatio=0,this.displayingFeatures=null,this.alive=!0,this.filtered=!1}return Object.defineProperty(e.prototype,"perTileMaximumNumberOfFeaturesExceeded",{get:function(){return!this.filtered&&(this.featuresMissing||this.features&&this.featureLimit!==this.features.length)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"features",{get:function(){return this._features},enumerable:!0,configurable:!0}),e.prototype.setFeatures=function(e,t){this._features=e,this._shuffled=!1,e&&e.length>0?(this._emptyFeatureRatio=t/(e.length+t),this._numVertices=e.reduce(function(e,t){return e+s.numVertices(t.geometry)},0)):(this._emptyFeatureRatio=0,this._numVertices=0)},Object.defineProperty(e.prototype,"emptyFeatureRatio",{get:function(){return this._emptyFeatureRatio},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"numFeatures",{get:function(){return this._numFeatures!==e.UNKNOWN_COUNT?this._numFeatures:this._features?this._features.length:0},set:function(e){this._numFeatures=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"numVertices",{get:function(){return this._numVertices},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"hasPreciseFeatureCount",{get:function(){return this._numFeatures!==e.UNKNOWN_COUNT},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"id",{get:function(){return this.descriptor.id},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"estimatedSize",{get:function(){var e=0;if(this._features)for(var t=0,r=this._features;t<r.length;t++){var i=r[t];e+=s.estimateSize(i)}return e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"estimatedUnusedSize",{get:function(){var e=0;if(this._features)for(var t=this.featureLimit;t<this._features.length;++t)e+=s.estimateSize(this._features[t]);return e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"isFetching",{get:function(){return 2===this.fetchStatus||3===this.fetchStatus},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"isRefetching",{get:function(){return 3===this.fetchStatus},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"needsFetching",{get:function(){return 0===this.fetchStatus||1===this.fetchStatus},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"needsRefetching",{get:function(){return 1===this.fetchStatus},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"isFetched",{get:function(){return 4===this.fetchStatus||5===this.fetchStatus},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"needsDisplayUpdate",{get:function(){return!!this._features&&!n(this._features,this.displayingFeatures,this.featureLimit)},enumerable:!0,configurable:!0}),e.prototype.intersects=function(e){return!e||!this.descriptor.extent||(i.fromExtent(e,f),i.intersects(this.descriptor.extent,f))},e.prototype.intersection=function(e,t){return e||this.descriptor.extent?(e?(i.fromExtent(e,t),this.descriptor.extent&&i.intersection(t,this.descriptor.extent,t)):i.set(t,this.descriptor.extent),t):(i.set(t,i.POSITIVE_INFINITY),t)},e.prototype._shuffle=function(e){this._features.sort(function(t,r){return u.getFeatureId(t,e)-u.getFeatureId(r,e)}),r.shuffle(this._features,16438),this._shuffled=!0},e.prototype.reduceFeatures=function(e,t){if(e<=0)return!1;var r=!1;return this._features?(this.featureLimit=Math.ceil(this.numFeatures*e),this.featureLimit>this._features.length&&(this.featureLimit=this._features.length,4===this.fetchStatus&&this._features.length>0&&(this.fetchStatus=1,r=!0)),!this._shuffled&&e<1&&this._shuffle(t)):this.featureLimit=0,r},Object.defineProperty(e.prototype,"cacheItem",{get:function(){return{features:this.features,numFeatures:this._numFeatures,emptyFeatureRatio:this._emptyFeatureRatio,fetchStatus:this.fetchStatus,featuresMissing:this.featuresMissing}},enumerable:!0,configurable:!0}),e.prototype.loadCache=function(e){this.fetchRequest=null,this._features=e.features,this._numFeatures=e.numFeatures,this._emptyFeatureRatio=e.emptyFeatureRatio,this.fetchStatus=e.fetchStatus,this.featuresMissing=e.featuresMissing},e}();!function(e){e.UNKNOWN_COUNT=-1}(a||(a={}));var f=i.create();return a});