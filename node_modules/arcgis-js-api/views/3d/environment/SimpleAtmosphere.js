// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.10/esri/copyright.txt for details.

define(["require","exports","../../../core/watchUtils","../../../core/libs/gl-matrix-2/gl-matrix","./atmosphereUtils","./resources/SimpleAtmosphereTexture","../support/earthUtils","../support/imageUtils","../support/mathUtils","../support/buffer/glUtil","../support/buffer/InterleavedLayout","../webgl-engine/lib/glUtil3D","../webgl-engine/lib/Util","../webgl-engine/shaders/SimpleAtmospherePrograms","../../webgl/BufferObject","../../webgl/programUtils","../../webgl/Texture","../../webgl/Util","../../webgl/VertexArrayObject"],function(e,t,r,a,i,n,s,o,d,l,h,c,u,f,p,m,g,_,v){function x(e,t,r,i,n){var s=a.vec3.length(e),o=Math.sqrt(s*s-i*i),d=i*o/s,l=Math.sqrt(i*i-d*d),h=n.silCircleV1,c=n.silCircleV2;return a.vec3.scale(n.silCircleCenter,e,l/s),a.vec3.cross(h,e,t),a.vec3.squaredLength(h)<1&&a.vec3.cross(h,e,r),a.vec3.scale(h,h,d/a.vec3.length(h)),a.vec3.cross(c,h,e),a.vec3.scale(c,c,d/a.vec3.length(c)),d}function y(e,t,r,i){return a.vec3.add(R,i.silCircleCenter,i.silCircleV2),a.vec3.scale(M,R,w),a.mat4.lookAt(F,t,R,r),u.project(R,F,e.projectionMatrix,e.viewport),u.project(M,F,e.projectionMatrix,e.viewport),a.vec3.distance(R,M)/e.height}function C(e,t,r){return e*e/(Math.sqrt(e*e-t*t)*Math.sqrt(e*e-r*r)+t*r)}var b=-i.INNER_ATMOSPHERE_DEPTH,D=(s.earthRadius+b)/s.earthRadius,V=(s.earthRadius+0)/s.earthRadius,w=(s.earthRadius+3e5)/s.earthRadius,P=function(e){return 1-511/512},U=d.makePiecewiseLinearFunction([[50,.1015625],[500,.21875],[5e3,.51171875],[5e4,.4140625]]),A=function(){function e(e){this.needsRender=!1,this.didRender=!0,this.slot=16,this._renderData={texV:a.vec2f64.create(),silCircleCenter:a.vec3f64.create(),silCircleV1:a.vec3f64.create(),silCircleV2:a.vec3f64.create(),altitudeFade:0,innerScale:0,undergroundFadeAlpha:0},this._fadeVaoCount=0,this.view=e}return e.prototype.when=function(e){return this._readyPromise.then(e)},e.prototype.initializeRenderContext=function(e){var t=this,a=e.rctx;this._cameraChangeHandle=r.init(this.view,"state.camera",function(){return t.needsRender=!0},!0),this._program=m.createProgram(a,f.colorPass),this._fadeProgram=m.createProgram(a,f.fadePass),this._vao=this._createRibbon(a),this._vaoCount=_.vertexCount(this._vao,"geometry"),this._fadeVao=c.createQuadVAO(a),this._fadeVaoCount=_.vertexCount(this._fadeVao,"geometry"),this._readyPromise=o.requestImage(n).then(function(e){t._texture=new g(a,{pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!0},e),t.needsRender=!0})},e.prototype.uninitializeRenderContext=function(e){this.destroy()},e.prototype.destroy=function(){this._cameraChangeHandle&&(this._cameraChangeHandle.remove(),this._cameraChangeHandle=null),this._texture&&(this._texture.dispose(),this._texture=null),this._program&&(this._program.dispose(),this._program=null),this._fadeProgram&&(this._fadeProgram.dispose(),this._fadeProgram=null),this._fadeVao&&(this._fadeVao.dispose(),this._fadeVao=null),this._readyPromise&&(this._readyPromise.cancel(),this._readyPromise=null)},e.prototype.render=function(e){if(e.slot!==this.slot||0!==e.pass)return!1;if(null==this._texture)return!1;this._update(e.camera);var t=e.rctx,r=this._program;return t.setDepthTestEnabled(!0),t.setDepthFunction(515),t.setBlendingEnabled(!0),t.setDepthWriteEnabled(!1),t.setBlendFunctionSeparate(770,771,1,771),this._renderData.undergroundFadeAlpha<1&&(t.bindProgram(r),r.setUniformMatrix4fv("proj",e.camera.projectionMatrix),r.setUniformMatrix4fv("view",e.camera.viewMatrix),r.setUniform3fv("silCircleCenter",this._renderData.silCircleCenter),r.setUniform3fv("silCircleV1",this._renderData.silCircleV1),r.setUniform3fv("silCircleV2",this._renderData.silCircleV2),r.setUniform2fv("texV",this._renderData.texV),t.bindTexture(this._texture,0),r.setUniform1i("tex",0),r.setUniform3fv("lightDirection",e.lightingData.direction),r.setUniform1f("altitudeFade",this._renderData.altitudeFade),r.setUniform1f("innerScale",this._renderData.innerScale),t.bindVAO(this._vao),t.drawArrays(4,0,this._vaoCount)),this._renderData.undergroundFadeAlpha>0&&(t.bindProgram(this._fadeProgram),this._fadeProgram.setUniform1f("undergroundFadeAlpha",this._renderData.undergroundFadeAlpha),this._fadeProgram.setUniform3fv("lightDirection",e.lightingData.direction),this._fadeProgram.setUniform3fv("cameraPosition",e.camera.eye),t.bindVAO(this._fadeVao),t.drawArrays(5,0,this._fadeVaoCount)),t.setBlendingEnabled(!1),t.setDepthWriteEnabled(!0),t.setDepthFunction(513),this.needsRender=!1,!0},e.prototype._update=function(e){var t=a.vec3f64.create(),r=s.earthRadius,n=a.vec3.length(e.eye),o=n-r;if(o<0){var l=Math.min(-o/5e3,1);this._renderData.undergroundFadeAlpha=l}else this._renderData.undergroundFadeAlpha=0;var h=Math.max(50,o),c=r+b;this._renderData.innerScale=C(r+h,r,c)-1,this._renderData.altitudeFade=i.computeInnerAltitudeFade(o),a.vec3.scale(t,e.eye,(r+50)/n),x(t,e.center,e.up,r,this._renderData);var u=y(e,t,e.up,this._renderData),f=P(),p=U(o),m=0+1*f,g=0+u*p*1;if(o>50){x(e.eye,e.center,e.up,r,this._renderData);var _=y(e,e.eye,e.up,this._renderData),v=d.clamp((_-1.5)/(u-1.5),0,1);m=0+v*f*1,g=0+1*d.lerp(1,u*p,v)}a.vec2.set(this._renderData.texV,m,g)},e.prototype._createRibbon=function(e){var t=new Float32Array(1155),r=new Uint32Array(1920);t[0]=0,t[1]=0,t[2]=-1;for(var a=0;a<128;a++){var i=9*a+3;t[i+0]=a,t[i+1]=D,t[i+2]=-1,t[i+3]=a,t[i+4]=V,t[i+5]=0,t[i+6]=a,t[i+7]=w,t[i+8]=1;var n=3*a+1,s=127===a?1:n+3,o=15*a;r[o+0]=n,r[o+1]=n+1,r[o+2]=s+1,r[o+3]=s+1,r[o+4]=s,r[o+5]=n,r[o+6]=n+1,r[o+7]=n+2,r[o+8]=s+2,r[o+9]=s+2,r[o+10]=s+1,r[o+11]=n+1,r[o+12]=n,r[o+13]=s,r[o+14]=0}for(var d=E.createBuffer(r.length),h=d.position,a=0;a<r.length;++a){var c=3*r[a];h.set(a,0,t[c]),h.set(a,1,t[c+1]),h.set(a,2,t[c+2])}return new v(e,f.colorPass.attributes,{geometry:l.glLayout(E)},{geometry:p.createVertex(e,35044,d.buffer)})},e}(),F=a.mat4f64.create(),R=a.vec3f64.create(),M=a.vec3f64.create(),E=h.newLayout().vec3f("position");return A});