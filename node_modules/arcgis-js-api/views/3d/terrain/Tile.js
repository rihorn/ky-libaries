// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.10/esri/copyright.txt for details.

define(["require","exports","../../../core/arrayUtils","../../../core/libs/gl-matrix-2/gl-matrix","../../../geometry/support/aaBoundingRect","../support/mathUtils","../support/buffer/typedArrayUtil","./ElevationData","./ElevationTileAgent","./MapTileAgent","./TerrainConst","./terrainUtils","./TileAgent","./TilePerLayerInfo","./tileUtils","../../vectorTiles/VectorTileDisplayObject","../../webgl/Texture"],function(e,t,i,a,n,r,s,l,o,d,h,p,u,g,c,y,f){function v(e){return e===h.LayerClass.ELEVATION?o.Pool.acquire():d.Pool.acquire()}function A(e){e instanceof o?o.Pool.release(e):e instanceof d&&d.Pool.release(e)}var m=p.weakAssert,E=a.vec3f64.create(),T=a.vec3f64.create(),L=a.vec4f64.create(),U=a.vec3f64.create(),I=u.AGENT_DONE;return function(){function e(e){this.lij=[0,0,0],this.extent=n.create(),this.elevationBounds=a.vec2f64.create(),this.children=[null,null,null,null],this.layerInfo=new Array(h.LayerClass.COUNT),this.extentWGS84Rad=n.create(),this.centerAtSeaLevel=a.vec3f64.create(),this.center=a.vec3f64.create(),this.tileUp=U,this.isWithinClippingArea=!0,this.intersectsClippingArea=!0,this.clippingArea=null,this._maxTesselation=0,this.screenDepth=0,this.renderOrder=0,this.edgeLen=0,this.edgeLen2=0,this.radius=0,this._memoryUsed=0,this.numSubdivisionsAtLevel=e}return Object.defineProperty(e.prototype,"memoryUsed",{get:function(){return this._memoryUsed},enumerable:!0,configurable:!0}),e.prototype.init=function(e,t,i,n){this.lij[0]=e[0],this.lij[1]=e[1],this.lij[2]=e[2],n.getExtent(e[0],e[1],e[2],this.extent,this.extentWGS84Rad),this.isWithinClippingArea=!0,this.intersectsClippingArea=!0,this.clippingArea=null,this.edgeLen=0,this.edgeLen2=0,this.radius=0,this.vlevel=e?e[0]:0,t&&t.elevationBounds?a.vec2.copy(this.elevationBounds,t.elevationBounds):a.vec2.set(this.elevationBounds,0,0),this.pendingUpdates=0,this.renderData=null,this.screenDepth=0,this.visible=!1,this.parent=t,this.parentSurface=i;for(var r=0;r<4;r++)this.children[r]=null;for(var s=0;s<h.LayerClass.COUNT;s++)if(i){var l=i.numLayers(s),o=void 0;this.layerInfo[s]?(o=this.layerInfo[s],o.length=l):(o=new Array(l),this.layerInfo[s]=o);for(var d=0;d<l;d++)o[d]=g.makeEmptyLayerInfo(s,o[d]),s===h.LayerClass.ELEVATION&&this.findElevationBoundsForLayer(d,-1)}else this.layerInfo[s]=null;this.computeElevationBounds(),this._maxTesselation=Math.min(n.pixelSize[0],h.MAX_TILE_TESSELATION)},e.prototype.dispose=function(){for(var e=0;e<h.LayerClass.COUNT;e++)for(var t=this.layerInfo[e],i=0,a=t;i<a.length;i++){var n=a[i];n.dispose()}this.updateMemoryUsed()},e.prototype.updateMemoryUsed=function(){var e=this.parentSurface.tilingScheme.pixelSize,t=e[0]*e[1]*4;this._memoryUsed=0;for(var i=0,a=this.layerInfo[h.LayerClass.MAP];i<a.length;i++){var n=a[i],r=n.data;r instanceof f?this._memoryUsed+=1.3*r.descriptor.width*r.descriptor.height*4:r instanceof HTMLImageElement?this._memoryUsed+=t:r instanceof y&&(this._memoryUsed+=r.getGpuMemoryUsage()+r.getCpuMemoryUsage())}for(var s=0,l=this.layerInfo[h.LayerClass.ELEVATION];s<l.length;s++){var n=l[s];this._memoryUsed+=n.data?t:0}if(this.renderData){this._memoryUsed+=this.renderData.estimateGeometryMemoryUsage();var o=this.renderData.texture?this.renderData.texture.descriptor:null;o&&(this._memoryUsed+=1.3*o.width*o.height*4)}},e.prototype.updateScreenDepth=function(e){a.vec3.copy(L,this.center),L[3]=1,a.vec4.transformMat4(L,L,e),this.screenDepth=L[2]/L[3]},e.prototype.shouldSplit=function(e,t){var i=this.lij[0];a.vec3.subtract(E,this.center,t);var n=a.vec3.squaredLength(E),s=e[4];if(n<this.edgeLen2&&i<s)return h.TileUpdateTypes.SPLIT;var l=e[1],o=2*Math.sqrt(n),d=e[0],p=d*o,u=this.edgeLen/p;if(u<l)return this.vlevel!==this.lij[0]?(this.vlevel=this.lij[0],h.TileUpdateTypes.VSPLITMERGE):h.TileUpdateTypes.NONE;if(i>=s){var g=i+Math.ceil(-r.log2(l/u));return g!==this.vlevel?(this.vlevel=g,h.TileUpdateTypes.VSPLITMERGE):h.TileUpdateTypes.NONE}if(i>6){a.vec3.scale(T,this.tileUp,a.vec3.dot(this.tileUp,E)),a.vec3.subtract(T,T,E);var c=a.vec3.squaredLength(T);if(c>this.radius*this.radius){a.vec3.scale(T,T,this.radius/Math.sqrt(c)),a.vec3.add(T,T,this.center),a.vec3.subtract(T,t,T);var y=this.elevationBounds[1]-this.elevationBounds[0],f=Math.min(1,(Math.abs(a.vec3.dot(T,this.tileUp))+.5*y+this.curvatureHeight)/a.vec3.length(T)),v=e[3],A=e[5],m=.1/A,L=e[2],U=L*o;if(f*(this.edgeLen/U)<m*v)return h.TileUpdateTypes.NONE}}return h.TileUpdateTypes.SPLIT},e.prototype.decodeElevationData=function(e){var t;if(s.isArrayBuffer(e))try{t=l.createFromLERC(this.lij,this.extent,e,h.noDataValueOpt)}catch(e){console.warn("Error decoding raw data: %s",e.message)}else t=l.createFromFetchTileResult(this.lij,this.extent,e);return t},e.prototype.getWGS84Extent=function(){var e=this.extentWGS84Rad;return n.fromValues(r.rad2deg(e[0]),r.rad2deg(e[1]),r.rad2deg(e[2]),r.rad2deg(e[3]))},e.prototype.load=function(e){for(var t=0;t<h.LayerClass.COUNT;t++)this.layerInfo[t]&&this._createOrUpdateAgents(0,t);e.loadTile(this)},e.prototype.unload=function(e){this.renderData&&e.unloadTile(this);for(var t=0;t<h.LayerClass.COUNT;t++)for(var i=this.layerInfo[t],a=0;a<i.length;a++){var n=i[a];n.loadingAgent&&n.loadingAgent!==I&&(n.loadingAgent.dispose(),A(n.loadingAgent),n.loadingAgent=null),n.pendingUpdates=0}this.pendingUpdates&=~h.TileUpdateTypes.UPDATE_GEOMETRY,this.pendingUpdates&=~h.TileUpdateTypes.UPDATE_TEXTURE},e.prototype.updateClippingStatus=function(e){if(i.equals(e,this.clippingArea))return!1;var t=this.intersectsClippingArea,a=this.isWithinClippingArea;e?(this.intersectsClippingArea=this.intersectsExtent(e),this.isWithinClippingArea=this.isWithinExtent(e)):(this.intersectsClippingArea=!0,this.isWithinClippingArea=!0),this.clippingArea=e;var n=a&&this.isWithinClippingArea,r=!(a||t||this.isWithinClippingArea||this.intersectsClippingArea);return!this.renderData||n||r||this.updateGeometry(),!0},e.prototype.updateVisibility=function(e){var t=this.isVisible(e)&&this.intersectsClippingArea;if(t!==this.visible){this.visible=t;for(var i=this.layerInfo[0],a=0;a<i.length;a++){var n=i[a];n.loadingAgent&&n.loadingAgent!==I&&n.loadingAgent.setSuspension(!t)}}return t},e.prototype.getLayerInfo=function(e,t){return this.layerInfo[t][e]},e.prototype.hasLayerData=function(e,t){var i=this.layerInfo[t][e];return i&&i.data&&!i.dataInvalidated},e.prototype.hasDataAvailable=function(e,t,i){var a=this.layerInfo[i][t].tilemap;return!a||"unavailable"!==a.getAvailability(e.lij[1],e.lij[2])},e.prototype.requestLayerData=function(e,t,i){h.TILE_LOADING_DEBUGLOG&&console.log("tile %s layer %d/%d requested by tile %s",this.lij.toString(),t,e,i.tile.lij.toString());var a=this.layerInfo[t][e];if(a.waitingAgents.indexOf(i)>-1)return console.warn("agent already requested this piece of map data (tile %s, agent tile %s, layer: %d/%d)",this.lij.toString(),i.tile.lij.toString(),t,e),!0;if(a.waitingAgents.push(i),a.data&&!a.dataInvalidated)return console.warn("agent requested existing data (tile %s, agent tile %s, layer: %d/%d)",this.lij.toString(),i.tile.lij.toString(),t,e),setTimeout(i.dataArrived.bind(i,this),0),!0;if(a.pendingUpdates&h.TileUpdateTypes.DECODE_ELEVATION||a.requestPromise)return!0;var n=this.parentSurface.requestTileData(this,e,t);if(!n||n.isFulfilled())return!1;var r=function(){a.requestPromise===n&&(a.requestPromise=null)};return a.requestPromise=n,n.then(r,r),!0},e.prototype.descendants=function(e){e||(e=[]);for(var t=0;t<4;t++){var i=this.children[t];i&&(i.descendants(e),e.unshift(this.children[t]))}return e},e.prototype.hasLij=function(e){return this.lij[0]===e[0]&&this.lij[1]===e[1]&&this.lij[2]===e[2]},e.prototype.findByLij=function(e){if(this.hasLij(e))return this;for(var t=0;t<4;t++){var i=this.children[t];if(i){var a=i.findByLij(e);if(a)return a}}return null},e.prototype.unrequestLayerData=function(e,t,a){h.TILE_LOADING_DEBUGLOG&&console.log("tile %s layer %d/%d canceled by tile %s",this.lij.toString(),t,e,a.tile.lij.toString());var n=this.layerInfo[t][e],r=n.waitingAgents,s=null!=i.removeUnordered(r,a);if(m(s,"agent has not requested this piece of map data"),r.length<1){var l=n.requestPromise,o=!1;if(t===h.LayerClass.MAP){var d=this.parentSurface.layerViewByIndex(e,h.LayerClass.MAP);o=p.isVectorTileLayerView(d)}o||m(l||n.rawData,"no pending operations on layerInfo that agents were waiting for"),l&&!l.isFulfilled()&&(l.cancel(),n.requestPromise=null),h.TILE_LOADING_DEBUGLOG&&console.log("tile %s layer %d/%d request/loading canceled",this.lij.toString(),t,e),this.updateMemoryUsed()}},e.prototype.dataArrived=function(e,t,i){var a=this.layerInfo[t][e];a.data=i,a.dataInvalidated=!1;for(var n=0;n<a.waitingAgents.length;n++)a.waitingAgents[n].dataArrived(this);a.waitingAgents.length=0,this.updateMemoryUsed()},e.prototype.dataMissing=function(e,t,i){i.notInTilemap||console.error("Tile %s layer %d/%d error",this.lij.toString(),t,e);var a=this.layerInfo[t][e];a.dataMissing=!0;for(var n=0;n<a.waitingAgents.length;n++)a.waitingAgents[n].dataMissing(this);a.waitingAgents.length=0,this.updateMemoryUsed()},e.prototype.updateTexture=function(e){void 0===e&&(e=!1),this.renderData&&(e?this.parentSurface.renderer.updateTileTexture(this):(this.pendingUpdates=this.pendingUpdates|h.TileUpdateTypes.UPDATE_TEXTURE,this.parentSurface.setPendingUpdates()))},e.prototype.invalidateLayerData=function(e,t){this.layerInfo[t][e].invalidateSourceData(),this.restartAgents(t)},e.prototype.computeElevationBounds=function(){a.vec2.set(this.elevationBounds,Number.MAX_VALUE,-Number.MAX_VALUE);for(var e=this.layerInfo[h.LayerClass.ELEVATION],t=!1,i=0;i<e.length;i++){var n=e[i];n.elevationBounds&&(this.elevationBounds[0]=Math.min(this.elevationBounds[0],n.elevationBounds[0]),this.elevationBounds[1]=Math.max(this.elevationBounds[1],n.elevationBounds[1]),t=!0)}t||a.vec2.set(this.elevationBounds,0,0),this.updateRadiusAndCenter()},e.prototype.updateRadiusAndCenter=function(){var e=.5*(this.elevationBounds[0]+this.elevationBounds[1]);a.vec3.scale(T,this.tileUp,e),a.vec3.add(this.center,this.centerAtSeaLevel,T)},e.prototype.findElevationBoundsForLayer=function(e,t){var i=this.layerInfo[h.LayerClass.ELEVATION][e];if(!i.elevationBounds||i.elevationBounds[2]<t){var n=this.parentSurface.layerViewByIndex(e,h.LayerClass.ELEVATION);if(c.fallsWithinLayer(this,n.layer,!1)){var r=L,s=!1;if(i.data){var l=i.data;a.vec2.copy(r,l.bounds),r[2]=this.lij[0],s=!0}else{for(var o=this.parent,d=0,p=null,l=i.data;o&&(!l||d<h.ELEVATION_DESIRED_RESOLUTION_LEVEL)&&(d=this.vlevel-o.lij[0],p=l||p,!(!(l=o.layerInfo[h.LayerClass.ELEVATION][e].data)&&p&&d>=h.ELEVATION_DESIRED_RESOLUTION_LEVEL));)o=o.parent;l=l||p,l&&(l.computeMinMaxValue(this.lij[0],this.lij[1],this.lij[2],r),r[0]!==1/0&&(r[2]=l.level,s=!0))}s&&(i.elevationBounds?a.vec3.copy(i.elevationBounds,r):i.elevationBounds=[r[0],r[1],r[2]])}}},e.prototype.updateGeometry=function(){this.pendingUpdates=this.pendingUpdates|h.TileUpdateTypes.UPDATE_GEOMETRY,this.parentSurface.setPendingUpdates()},e.prototype.modifyLayers=function(e,t,i){for(var a=this.layerInfo[i],n=0;n<a.length;n++){var r=a[n];r.loadingAgent&&r.loadingAgent!==I&&(r.loadingAgent.dispose(),A(r.loadingAgent),r.loadingAgent=null),r.waitingAgents.length=0}if(i===h.LayerClass.MAP)for(var n=0;n<a.length;++n)void 0===e[n]&&a[n].dispose();for(var s=t.length,l=new Array(s),n=0;n<s;n++){var o=t[n];l[n]=o>-1?a[o]:g.makeEmptyLayerInfo(i)}this.layerInfo[i]=l,this.updateMemoryUsed()},e.prototype.restartAgents=function(e){if(this.renderData)if(this._createOrUpdateAgents(0,e),e===h.LayerClass.ELEVATION){this.updateGeometry();for(var t=this.layerInfo[e],i=0;i<t.length;i++)t[i].pendingUpdates|=h.TileUpdateTypes.UPDATE_GEOMETRY;this.parentSurface.setPendingUpdates()}else this.updateTexture(!0)},e.prototype.updateAgents=function(e){if(this.renderData){for(var t=this.layerInfo[e],i=0;i<t.length;i++){var a=t[i];a.loadingAgent===I&&(a.loadingAgent=null)}this._createOrUpdateAgents(0,e)}},e.prototype.removeLayerAgent=function(e,t){var i=this.layerInfo[t][e];i.loadingAgent&&i.loadingAgent!==I&&i.loadingAgent.dispose(),i.loadingAgent=null},e.prototype.agentDone=function(e,t){var i=this.layerInfo[t],a=i[e];a.loadingAgent=I,a.data||a.upsampleFromTile||e<i.length-1&&this._createOrUpdateAgents(e+1,t)},e.prototype._createOrUpdateAgents=function(e,t){for(var i=t!==h.LayerClass.ELEVATION&&!this.visible,a=this.layerInfo[t],n=e;n<a.length;++n){var r=a[n],s=!1,l=this.parentSurface.layerViewByIndex(n,t);if(r.loadingAgent)r.loadingAgent!==I&&(s=r.loadingAgent.update());else if(c.fallsWithinLayer(this,l.layer,!1)){var o=v(t);s=o.init(this,n,t,i),s?r.loadingAgent=o:(o.dispose(),A(o),r.loadingAgent=I)}if(s&&l.isOpaque)return}},e.prototype.geometryState=function(e){var t,a,n,s=this._getElevationInfo(e?e.samplerData:null),l=this.lij[0];if(s.samplerData){t=this.vlevel-l,a=Math.max(l-s.maxTileLevel,h.ELEVATION_DESIRED_RESOLUTION_LEVEL-t);var o=this._maxTesselation;n=r.clamp(1+(o>>a),2,o+1)}else n=l<8?this.numSubdivisionsAtLevel[l]+1:2;var d=this.clippingArea;return this.intersectsClippingArea&&!this.isWithinClippingArea||(d=null),e?(e.needsUpdate=!1,e.numVertsPerRow!==n&&(e.numVertsPerRow=n,e.needsUpdate=!0),s.changed&&(e.samplerData=s.samplerData,e.needsUpdate=!0),i.equals(e.clippingArea,d)||(e.clippingArea=d,e.needsUpdate=!0)):e={numVertsPerRow:n,samplerData:s.samplerData,needsUpdate:!0,clippingArea:d},e},e.prototype._getElevationInfo=function(e){for(var t=this.layerInfo[h.LayerClass.ELEVATION],i=t.length,a=new Array(i),n=0,r=0,s=!1,l=0;l<i;l++){var o=t[l];if(o.upsampleFromTile){var d=o.upsampleFromTile.tile,p=d.layerInfo[h.LayerClass.ELEVATION][l].data;e&&e[n]===p.samplerData||(s=!0),a[n++]=p.samplerData,r=Math.max(r,d.lij[0])}else if(o.data){var u=this.parentSurface.layerViewByIndex(l,h.LayerClass.ELEVATION);if(c.fallsWithinLayer(this,u.layer,!1)){var p=o.data;e&&e[n]===p.samplerData||(s=!0),a[n++]=p.samplerData,r=this.lij[0]}}}return e&&e.length!==n&&(s=!0),n>0?a.length=n:a=null,{changed:s,samplerData:a,maxTileLevel:r}},e.prototype.isWithinExtent=function(e){var t=this.extent;return t[0]>=e[0]&&e[2]>=t[2]&&t[1]>=e[1]&&e[3]>=t[3]},e.prototype.intersectsExtent=function(e){var t=this.extent;return t[2]>=e[0]&&e[2]>=t[0]&&t[3]>=e[1]&&e[3]>=t[1]},e}()});