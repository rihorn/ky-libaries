// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.10/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/extendsHelper","../../../Color","../../../core/ObjectPool","../../../core/PooledArray","../../../core/promiseUtils","../../../core/libs/gl-matrix-2/gl-matrix","../../../geometry/support/aaBoundingBox","../support/imageUtils","./ResourceCounter","./TerrainConst","./TileGeometryFactory","./TileRenderData","./TileRenderer","./tileUtils","../webgl-engine/lib/DefaultVertexAttributeLocations","../webgl-engine/lib/DefaultVertexBufferLayouts","../webgl-engine/lib/glUtil3D","../webgl-engine/lib/screenSizePerspectiveUtils","../webgl-engine/lib/tracer","../webgl-engine/lib/Util","../webgl-engine/materials/internal/MaterialUtil","../webgl-engine/shaders/TerrainRendererPrograms","../../webgl/BufferObject","../../webgl/Util","../../webgl/VertexArrayObject"],function(e,t,r,i,n,s,a,l,o,d,h,c,u,p,f,g,v,m,b,y,T,R,x,S,_,w,O){function P(e){return function(t,r){var i=t.screenDepth,n=r.screenDepth;return i<n?-e:i>n?e:0}}function D(e){var t=P(e);return function(r,i){return 0===r.tiles.length?-e:0===i.tiles.length?e:t(r.tiles.data[0],i.tiles.data[0])}}function E(e,t,r){var i=e[0]*t[2]+t[0],n=e[1]*t[3]+t[1],s=e[2]*t[2],a=e[3]*t[3];l.vec4.set(r,i,n,s,a)}var k=R.assert,I=l.mat4f64.create(),B=l.vec3f64.create(),U=l.vec2f64.create(),M=o.create(),N=l.vec4f64.create(),A=l.vec4f64.create(),L=l.vec4f64.create(),z=function(){function e(){this.extent=l.vec4f64.create(),this.minLevel=0,this.maxLevel=0,this.callback=null}return e}(),Q=function(){function e(e,t){this.initialized=!1,this.rctx=null,this.renderDataPool=new n(p.TileRenderData),this.perOriginTileData=new s({allocator:function(e){return e||{root:null,origin:null,tiles:new s}},deallocator:function(e){return e.root=null,e.origin=null,e.tiles.clear(),e}}),this.perOriginTileDataDirty=!0,this.tileIterator=new g.IteratorPreorder,this.highestVisibleLODTile=null,this.visible=!0,this.debugScreenSizePerspective=!1,this.wireframe=x.copyParameters(V),this._opaque=!0,this._skirtScale=1,this._drawBorders=!1,this._disableRendering=!1,this._cullBackFaces=!1,this._renderOrder=1,this._velvetOverground=!0,this._hasOverlays=!1,this._slicePlaneEnabled=!1,this.castShadows=!0,this.receiveShadows=!1,this.emptyTex=null,this.tileRenderer=null,this.backgroundPromise=null,this.tileBackgroundInitialized=!1,this.stencilEnabledLayerExtents=[],this.numTrianglesRendered=0,this.numTilesRendered=0,this.numTilesCulled=0,this.numOriginsRendered=0,this.resourceCounter=new h,this.clippingExtent=null,this.loaded=null,this._loaded=!1,this.needsRender=!0,this.didRender=!1,this.needsHighlight=!1,this.visibleScaleRangeQueries=new s({initialSize:10}),this.visibleScaleRangeQueriesInvPtr=0,this.visibleScaleRangeQueryQueue=new s({initialSize:30}),this.visibleScaleRangeQueryPool=new n(z,!1),this.manifold=e,this.tileSize=t||256}return e.prototype.destroy=function(e){this.uninstall(e),this.backgroundPromise&&(this.backgroundPromise.cancel(),this.backgroundPromise=null)},e.prototype.install=function(e){e.addRenderPlugin([3,8],this),this.drapedRenderer=e.getDrapedTextureRenderer()},e.prototype.uninstall=function(e){e.removeRenderPlugin(this)},Object.defineProperty(e.prototype,"disableRendering",{set:function(e){this._disableRendering=!!e,this.setNeedsRender()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"opaque",{set:function(e){this._opaque=e,this.setNeedsRender()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"skirtScale",{set:function(e){this._skirtScale=e,this.setNeedsRender()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"drawBorders",{set:function(e){this._drawBorders!==e&&(this._drawBorders=e,this._updatePrograms())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"cullBackFaces",{set:function(e){this._cullBackFaces=e,this.setNeedsRender()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"renderOrder",{set:function(e){this._renderOrder=e,this.setNeedsRender()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"velvetOverground",{set:function(e){this._velvetOverground!==e&&(this._velvetOverground=e,this._updatePrograms())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"slicePlaneEnabled",{get:function(){return this._slicePlaneEnabled},set:function(e){this._slicePlaneEnabled!==e&&(this._slicePlaneEnabled=e,this._updatePrograms())},enumerable:!0,configurable:!0}),e.prototype.setRootTiles=function(e){this.rootTiles=e,this.setNeedsRender()},e.prototype.setNeedsHighlight=function(e){this.needsHighlight=e,this.setNeedsRender()},e.prototype.setStencilEnabledLayerExtents=function(e){this.stencilEnabledLayerExtents=e,this.setNeedsRender()},e.prototype.setTileSize=function(e){this.tileSize=e,this.tileRenderer&&(this.tileRenderer.tileSize=e),this.setNeedsRender()},e.prototype.loadTile=function(e){k(null===e.renderData),e.renderData=this.renderDataPool.acquire(),e.renderData.init();var t=this.getLocalOriginOfTile(e);e.createGeometry(e.renderData.updateGeometryState(e),t,"debug"===this.wireframe.mode),e.renderData.localOrigin=t,this._updateTileGeometryBuffers(e),this.tileBackgroundInitialized&&this.tileRenderer.updateTileTexture(e)},e.prototype.queryVisibleLevelRange=function(e,t,r,i){var n=this.visibleScaleRangeQueryPool.acquire();l.vec4.copy(n.extent,e),n.minLevel=t||-Number.MAX_VALUE,n.maxLevel=null!=r?r:Number.MAX_VALUE,n.callback=i,this.visibleScaleRangeQueryQueue.push(n),this.setNeedsRender()},e.prototype.updateTileTexture=function(e){this.tileRenderer&&this.tileBackgroundInitialized&&this.tileRenderer.updateTileTexture(e)},e.prototype.updateTileGeometry=function(e){e.renderData.updateGeometryState(e);for(var t=e.renderData.geometryState,r=e.layerInfo[c.LayerClass.ELEVATION],i=0;i<r.length;i++)r[i].pendingUpdates&=~c.TileUpdateTypes.UPDATE_GEOMETRY;return!!t.needsUpdate&&(e.renderData.vao&&this._releaseTileGeometry(e),e.createGeometry(t,e.renderData.localOrigin,"debug"===this.wireframe.mode),this._updateTileGeometryBuffers(e),!0)},e.prototype.unloadTile=function(e){this._releaseTileGeometry(e),e.renderData.texture&&e.renderData.texture.dispose(),this.renderDataPool.release(e.renderData),e.renderData=null,e.updateMemoryUsed()},e.prototype.getLocalOriginOfTile=function(e){if(e.lij[0]>=10){for(;e.lij[0]>7;)e=e.parent;return e.centerAtSeaLevel}if("spherical"===this.manifold)return B;for(;e.parent;)e=e.parent;return e.centerAtSeaLevel},e.prototype.setVisibility=function(e){this.visible=e,this.setNeedsRender()},e.prototype.getStats=function(){return{numTilesRendered:this.numTilesRendered,numTilesCulled:this.numTilesCulled,numTrianglesRendered:this.numTrianglesRendered,numOriginsRendered:this.numOriginsRendered}},e.prototype.getWireframeEnabled=function(){return"shader"===this.wireframe.mode},e.prototype.setDebugScreenSizePerspective=function(e){e!==this.debugScreenSizePerspective&&(this.debugScreenSizePerspective=e,this._updatePrograms())},e.prototype.setWireframe=function(e){var t=this;!1!==e&&!0!==e||(e={mode:e?"shader":"none"});var r=this.wireframe;if(void 0!==e.mode&&r.mode!==e.mode){var i="debug"===r.mode,n="debug"===e.mode;r.mode=e.mode,this._updatePrograms(),i!==n&&this.rootTiles&&g.traverseTilesPreorder(this.rootTiles,function(e){e.renderData&&(e.renderData.vao&&t._releaseTileGeometry(e),e.createGeometry(e.renderData.updateGeometryState(e),e.renderData.localOrigin,n),t._updateTileGeometryBuffers(e))})}for(var s in e)r.hasOwnProperty(s)&&(r[s]=e[s]),this.setNeedsRender();r.resolution&&(r.resolution=Math.min(r.resolution,this.tileSize),r.resolution=1<<Math.round(Math.log(r.resolution)/Math.LN2))},e.prototype.setNeedsRender=function(){this.needsRender=!0,this.didRender=!1,this.perOriginTileDataDirty=!0},e.prototype.resetNeedsRender=function(){this.didRender&&(this.needsRender=0!==this.visibleScaleRangeQueryQueue.length,this.didRender=!1)},e.prototype.isOpaqueExcludingSlice=function(){var e=this.wireframe,t="shader"===e.mode&&(e.wireOpacity<1||e.surfaceOpacity<1);return this._opaque&&!t},e.prototype.isOpaque=function(){return this.isOpaqueExcludingSlice()&&!this._slicePlaneEnabled},e.prototype.updateTileBackground=function(e){this.backgroundPromise&&this.backgroundPromise.cancel(),this.backgroundPromise="string"==typeof e?d.requestImage(e).catch(function(){return null}):null!=e?a.resolve(i.toUnitRGBA(e)):a.resolve(null),this._renderTileBackground()},e.prototype.initializeRenderContext=function(e){var t=this,r=this.rctx=e.rctx,i=this.programRep=e.programRep,n=function(e){a.when(e).then(function(){t.initialized=!0,t.setNeedsRender()}).catch(n)};n(this._renderTileBackground()),this.programs={color:null,normal:null,depth:null,depthShadowMap:null,highlight:null},this._updatePrograms(),this.tileRenderer=new f(r,this.tileSize,i,this.resourceCounter,this.setNeedsRender.bind(this)),this._renderTileBackground(),this.emptyTex=b.createEmptyTexture(r)},e.prototype.uninitializeRenderContext=function(e){null!=this.emptyTex&&(this.emptyTex.dispose(),this.emptyTex=null),this.tileRenderer&&(this.tileRenderer.dispose(),this.tileRenderer=null)},e.prototype.render=function(e){var t=e.rctx,r=t.gl;if(!this.initialized||this._disableRendering||!this.visible||!this.rootTiles||!this.tileBackgroundInitialized)return!1;var i=this.isOpaque()?3:8;if(e.slot!==i)return!1;T.trace("# BEGIN RENDER TERRAIN");var n=e.pass;t.setFaceCullingEnabled(this._cullBackFaces);var s=1===e.lightingData.helper.globalFactor;return 0===n?this._renderMaterialPass(e,this._updatePerOriginTileData()):3===n&&this.castShadows&&s?this._renderDepthPass(e,this.programs.depthShadowMap,this._updatePerOriginTileData()):1===n?this._renderDepthPass(e,this.programs.depth,this._updatePerOriginTileData()):2===n?this._renderNormalPass(e,this._updatePerOriginTileData()):4===n&&this.needsHighlight&&(this._renderHighlightPass(e,this._updatePerOriginTileData()),t.clear(r.DEPTH_BUFFER_BIT)),this._cullBackFaces&&t.setFaceCullingEnabled(!1),T.trace("# END RENDER TERRAIN"),!0},e.prototype.intersect=function(e,t,r,i,n){if(this.rootTiles&&(!e.isSelection||this.isOpaqueExcludingSlice())&&e.enableTerrain){var s=H,a=F;l.vec3.subtract(s,i,r),l.vec3.set(a,1/s[0],1/s[1],1/s[2]);var d=e.minResult,h=e.maxResult,c=this.clippingExtent,u=this.tileIterator;u.reset(this.rootTiles);for(var p=this;!u.done;)!function(){var n=u.next();if(null===n.renderData)return"continue";if(e.enableInvisibleTerrain){if(!n.visible&&c&&!n.intersectsExtent(c))return"continue"}else if(!n.visible)return"continue";var f=n.renderData.geometryInfo,v=n.renderData.localOrigin,m=G;l.vec3.subtract(m,r,v);var b=-p._skirtScale*f.skirtLength;if(0!==b){var y=n.tileUp;o.offset(f.boundingBox,b*y[0],b*y[1],b*y[2],M),o.expandWithBuffer(M,f.boundingBox,0,2)}var T=0!==b?M:f.boundingBox;if(!x.intersectAabbInvDir(T,m,a,e.tolerance))return"continue";var R=function(a,o,c){if(a>=0&&(e.enableBackfacesTerrain||l.vec3.dot(o,s)<0)&&(e.enableInvisibleTerrain||!e.isSelection||null==t||t(r,i,a))){var u=void 0;(void 0===d.dist||a<d.dist)&&(u=g.tile2str(n),d.set(void 0,u,a,o,I,void 0),d.setIntersector("TerrainRenderer")),(void 0===h.dist||a>h.dist)&&(u=g.tile2str(n),h.set(void 0,u,a,o,I,void 0),h.setIntersector("TerrainRenderer"))}},S=j;l.vec3.subtract(S,i,v);var _=f.indices,w={data:f.vertexAttributes,size:3,offsetIdx:0,strideIdx:5},O=f.numWithoutSkirtIndices/3;if(x.intersectTriangles(m,S,0,O,_,w,null,R),0!==b){var P="spherical"===p.manifold?function(e){return l.vec3.scale(e,e,b/l.vec3.length(e))}:function(e){return l.vec3.set(e,0,0,b)},D=_.length/3;g.intersectSkirts(m,S,O,D,_,w,null,P,R)}}()}},e.prototype._renderTileBackground=function(){var e=this;if(this.rctx&&this.backgroundPromise&&this.tileRenderer)return this.backgroundPromise.then(function(t){e.tileRenderer&&(e.tileBackgroundInitialized=!0,e.tileRenderer.setBackground(t),e.rootTiles&&g.traverseTilesPreorder(e.rootTiles,function(t){e.tileRenderer.updateTileTexture(t)}))})},e.prototype._updatePrograms=function(){var e="spherical"===this.manifold,t=e?"global":"local",r="shader"===this.wireframe.mode,i=this.programRep;this.programs.color=i.getProgram(S.colorPass,{viewingMode:t,mode:r||this._drawBorders?"wireframe":"normal",spherical:e,overlay:this._hasOverlays,atmosphere:e&&this._velvetOverground,wireframeTexture:r,tileBorders:this._drawBorders,receiveShadows:this.receiveShadows,screenSizePerspective:this.debugScreenSizePerspective,slice:this._slicePlaneEnabled}),this.programs.normal=i.getProgram(S.normalPass,{viewingMode:t,spherical:e,alphaZero:!0}),this.programs.depth=i.getProgram(S.depthPass,{viewingMode:t,spherical:e,shadowMap:!1}),this.programs.depthShadowMap=i.getProgram(S.depthPass,{viewingMode:t,spherical:e,shadowMap:!0}),this.programs.highlight=i.getProgram(S.highlightPass,{viewingMode:t,spherical:e}),this.setNeedsRender()},e.prototype._renderMaterialPass=function(e,t){var r=this,i=e.shadowMap&&e.shadowMap.enabled,n=e.rctx;this.receiveShadows!==i&&(this.receiveShadows=i,this._updatePrograms());var s=!this.drapedRenderer.isEmpty();s!==this._hasOverlays&&(this._hasOverlays=s,this._updatePrograms());var a=e.camera;n.setDepthTestEnabled(!0);var o=this.wireframe,d=this.programs.color;n.bindProgram(d),("shader"===o.mode||this._drawBorders)&&(d.setUniform1f("wireframe.width",this.wireframe.width),d.setUniform1f("wireframe.falloff",Math.min(o.width,o.falloff)),d.setUniform1f("wireframe.wireOpacity",o.wireOpacity),d.setUniform1f("wireframe.surfaceOpacity",o.surfaceOpacity),d.setUniform4fv("wireframe.color",o.color)),e.shadowMap&&e.shadowMap.bind(d),e.ssaoHelper&&e.ssaoHelper.setUniforms(d),d.setUniform1i("tex",0),d.setUniform1i("overlay0Tex",1),d.setUniform1i("overlay1Tex",2),d.setUniformMatrix4fv("viewNormal",a.viewInverseTransposeMatrix),d.setUniformMatrix4fv("proj",a.projectionMatrix),e.lightingData.helper.setUniforms(d,!0);var h=a.viewMatrix;l.vec3.set(C,h[12],h[13],h[14]),l.vec3.normalize(C,C),d.setUniform3fv("viewDirection",C),this.numTilesRendered=0,this.numTilesCulled=0,this.numTrianglesRendered=0,this.numOriginsRendered=0,this._prepareScaleRangeQueries(),this.isOpaque()?this._renderTiles(e,d,t):e.offscreenRenderingHelper.renderToTargets(function(){return r._renderTiles(e,d,t)},e.offscreenRenderingHelper.tmpColor,e.offscreenRenderingHelper.mainDepth,[0,0,0,0]),this._processScaleRangeQueries(),this.numTilesRendered>0&&!this._loaded&&(this._loaded=!0,this.loaded&&this.loaded())},e.prototype._renderDepthPass=function(e,t,r){var i=e.rctx,n=e.camera;i.bindProgram(t),i.setBlendingEnabled(!1),i.setDepthTestEnabled(!0),t.setUniformMatrix4fv("model",I),t.setUniformMatrix4fv("viewNormal",n.viewInverseTransposeMatrix),U[0]=n.near,U[1]=n.far,t.setUniform2fv("nearFar",U),this._renderTilesAuxiliary(e,t,r,!1)},e.prototype._renderNormalPass=function(e,t){var r=e.rctx,i=e.camera,n=this.programs.normal;r.bindProgram(n),r.setBlendingEnabled(!1),r.setDepthTestEnabled(!0),n.setUniformMatrix4fv("viewNormal",i.viewInverseTransposeMatrix),this._renderTilesAuxiliary(e,n,t,!1)},e.prototype._renderHighlightPass=function(e,t){var r=e.rctx,i=this.programs.highlight;r.bindProgram(i),r.setBlendingEnabled(!1),r.setDepthTestEnabled(!0);var n=e.offscreenRenderingHelper;r.bindTexture(n.depthTexture,3),i.setUniform1i("depthTex",3),i.setUniform4f("highlightViewportPixelSz",0,0,1/n.width,1/n.height),this._renderTilesAuxiliary(e,i,t,!0)},e.prototype._updatePerOriginTileData=function(){var e=this.perOriginTileData;if(!this.perOriginTileDataDirty)return e;if(this.highestVisibleLODTile=null,e.clear(),this._renderCollectOrigins(e),0!==this._renderOrder){for(var t=P(this._renderOrder),r=0;r<e.length;r++)this._sortFrontToBack(e.data[r].tiles,t);var i=D(this._renderOrder);this._sortFrontToBack(e,i)}return this.perOriginTileDataDirty=!1,e},e.prototype._renderCollectOrigins=function(e){for(var t=this.rootTiles,r="spherical"===this.manifold,i=0;i<t.length;i++){var n=t[i],s=e.pushNew();s.root=n,s.origin=r?B:n.centerAtSeaLevel,s.tiles.clear(),this._renderCollectOriginsForRoot(e,s)}},e.prototype._renderCollectOriginsForRoot=function(e,t){var r=this.tileIterator;for(r.resetOne(t.root);!r.done;){var i=r.next(),n=i.renderData;if(!n||i.visible){var s=e.back();if(7===i.lij[0]&&(s!==t&&0===s.tiles.length||(s=e.pushNew(),s.tiles.clear()),s.root=i,s.origin=i.centerAtSeaLevel),n){i.lij[0]>=10?e.back().tiles.push(i):t.tiles.push(i),(!this.highestVisibleLODTile||i.vlevel>this.highestVisibleLODTile.vlevel)&&(this.highestVisibleLODTile=i),r.skipSubtree()}}else this.numTilesCulled++,r.skipSubtree()}},e.prototype._sortFrontToBack=function(e,t){e.sort(t)},e.prototype._scaleQueriesForTile=function(e){for(var t=e.extent,r=e.lij[0],i=0;i<this.visibleScaleRangeQueriesInvPtr;){var n=this.visibleScaleRangeQueries.data[i],s=n.extent;r>=n.minLevel&&r<=n.maxLevel&&s[0]<=t[2]&&s[2]>=t[0]&&s[1]<=t[3]&&s[3]>=t[1]?(this.visibleScaleRangeQueries.swapElements(i,this.visibleScaleRangeQueriesInvPtr-1),this.visibleScaleRangeQueriesInvPtr--):i++}},e.prototype._updateStencilReadStateForTile=function(e,t){if(e.stencilRenderingHelper&&e.stencilRenderingHelper.enabled){for(var r=this.stencilEnabledLayerExtents,i=!1,n=0;n<r.length;n++)if(t.intersectsExtent(r[n])){i=!0;break}i?e.stencilRenderingHelper.enableStencilRead():e.stencilRenderingHelper.disableStencilRead()}},e.prototype._renderTilesAuxiliary=function(e,t,r,i){var n=e.rctx,s=n.gl,a=e.camera,l=a.viewMatrix;t.setUniformMatrix4fv("proj",a.projectionMatrix),t.setUniform1f("skirtScale",this._skirtScale),i&&(t.setUniform1i("overlay0Tex",1),t.setUniform1i("overlay1Tex",2));for(var o=0;o<r.length;o++){var d=r.data[o];t.setUniform3fv("origin",d.origin),x.bindView(d.origin,l,t);for(var h=0;h<d.tiles.length;h++){var c=d.tiles.data[h],u=c.renderData;i&&(this._bindOverlayTextures(t,u.overlays,!0),t.setUniform1f("overlayOpacity",u.overlayOpacity)),this._updateStencilReadStateForTile(e,c),n.bindVAO(u.vao),w.assertCompatibleVertexAttributeLocations(u.vao,t);var p=0!==this._skirtScale?u.vao.indexBuffer.size:u.geometryInfo.numWithoutSkirtIndices;n.drawElements(s.TRIANGLES,p,u.vao.indexBuffer.indexType,0)}}n.bindVAO(null),e.stencilRenderingHelper&&e.stencilRenderingHelper.disableStencilRead()},e.prototype._renderTiles=function(e,t,r){var i=e.rctx,n=i.gl,s=e.camera,a=s.viewMatrix;if(this.debugScreenSizePerspective&&this.pointsOfInterest){var l=y.getSettings("spherical"===this.manifold?"global":"local");l.update({distance:this.pointsOfInterest.centerOnSurfaceFrequent.distance,fovY:s.fovY}),x.bindScreenSizePerspective(l,e,t,"screenSizePerspective")}t.setUniform1f("skirtScale",this._skirtScale);for(var o=0;o<r.length;o++){var d=r.data[o];t.setUniform3fv("origin",d.origin),x.bindView(d.origin,a,t);var h=e.sliceHelper&&e.sliceHelper.plane;h&&x.bindSlicePlane(d.origin,h,t),e.shadowMap&&e.shadowMap.bindView(t,d.origin),this.numOriginsRendered++;var c=d.tiles;if(0!==c.length){var u="debug"===this.wireframe.mode?n.LINES:n.TRIANGLES,p=this.highestVisibleLODTile,f=void 0,v=void 0;p?(f=p.vlevel,v=this.tileSize/this.wireframe.resolution):(f=16,v=this.tileSize/64);for(var m=0;m<c.length;m++){var b=c.data[m],R=b.renderData;this._updateStencilReadStateForTile(e,b),T.trace("# RENDER TILE "+g.tile2str(b)+", screenDepth:"+b.screenDepth),E(R.geometryInfo.uvOffsetAndScale,R.texOffsetAndScale,L),t.setUniform4fv("texOffsetAndScale",L);var S=R.textureReference||R.texture;if(i.bindTexture(S,0),t.setUniform1f("opacity",R.opacity),this._bindOverlayTextures(t,R.overlays,!1),t.setUniform1f("overlayOpacity",R.overlayOpacity),"shader"===this.wireframe.mode||this._drawBorders){var _=v*(1<<f-b.vlevel);t.setUniform1f("wireframe.subdivision",_)}var O=0!==this._skirtScale?R.vao.indexBuffer.size:R.geometryInfo.numWithoutSkirtIndices;i.bindVAO(R.vao),w.assertCompatibleVertexAttributeLocations(R.vao,t),i.drawElements(u,O,R.vao.indexBuffer.indexType,0),b.renderOrder=this.numTilesRendered,this.numTilesRendered++,this.numTrianglesRendered+=O/3,this._scaleQueriesForTile(b)}}}i.bindVAO(null),e.stencilRenderingHelper&&e.stencilRenderingHelper.disableStencilRead()},e.prototype._bindOverlayTextures=function(e,t,r){for(var i=0;i<2;i++){var n=2*i,s=t[i],a=r?s.highlightRenderTargetId:s.renderTargetId;if(a){var l=this.drapedRenderer.getRenderTargetTexture(a);N[n]=s.texOffset[0],N[n+1]=s.texOffset[1],A[n]=s.texScale[0],A[n+1]=s.texScale[1],this.rctx.bindTexture(l,1+i)}else N[n]=0,N[n+1]=0,A[n]=0,A[n+1]=0,this.rctx.bindTexture(this.emptyTex,1+i)}e.setUniform4fv("overlayTexOffset",N),e.setUniform4fv("overlayTexScale",A)},e.prototype._updateTileGeometryBuffers=function(e){var t=this.rctx,r=t.gl,i=e.renderData,n=i.geometryInfo.vertexAttributes,s=i.geometryInfo.indices;i.vao=new O(t,v.Default3D,{geometry:m.Pos3Tex},{geometry:_.createVertex(t,r.STATIC_DRAW,n)},_.createIndex(t,r.STATIC_DRAW,s)),this.setNeedsRender()},e.prototype._releaseTileGeometry=function(e){var t=e.renderData;t.vao.dispose(!0),t.vao=null,u.releaseGeometry(t.geometryInfo),this.setNeedsRender()},e.prototype._prepareScaleRangeQueries=function(){for(var e=this.visibleScaleRangeQueries,t=this.visibleScaleRangeQueryQueue;e.length<e.data.length&&t.length>0;){var r=t.pop();e.push(r)}this.visibleScaleRangeQueriesInvPtr=e.length},e.prototype._processScaleRangeQueries=function(){for(var e=this.visibleScaleRangeQueries,t=this.visibleScaleRangeQueryPool,r=0;r<e.length;r++){var i=e.data[r];t.release(i),i.callback(r>=this.visibleScaleRangeQueriesInvPtr),i.callback=null}e.clear()},e}(),V={mode:"none",width:1.5,falloff:1.5,wireOpacity:1,surfaceOpacity:0,color:[1,1,1,0],resolution:64},C=l.vec3f64.create(),H=l.vec3f64.create(),F=l.vec3f64.create(),G=l.vec3f64.create(),j=l.vec3f64.create();return Q});