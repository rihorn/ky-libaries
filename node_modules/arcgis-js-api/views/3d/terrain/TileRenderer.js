// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.10/esri/copyright.txt for details.

define(["require","exports","../../../core/libs/gl-matrix-2/gl-matrix","./TerrainConst","../webgl-engine/lib/DefaultVertexAttributeLocations","../webgl-engine/lib/DefaultVertexBufferLayouts","../webgl-engine/lib/glUtil3D","../webgl-engine/shaders/MiscPrograms","../../vectorTiles/tileRendererHelper3D","../../vectorTiles/VectorTileDisplayObject","../../webgl/BufferObject","../../webgl/FramebufferObject","../../webgl/Texture","../../webgl/Util","../../webgl/VertexArrayObject"],function(e,t,a,r,i,s,n,o,l,d,u,c,p,h,f){function x(e){return e instanceof HTMLImageElement||e instanceof HTMLCanvasElement}var _=new Array(20),b=[0,0];return function(){function e(e,t,a,r,l){this._backgroundTex=null,this._blackTex=null,this.tileSize=256,this._context=e,this.tileSize=t,this._resourceCounter=r,this._setNeedsRender=l,e.capabilities.textureFilterAnisotropic&&(this._maxAnisotropy=Math.min(8,e.parameters.maxMaxAnisotropy));var d=new Float32Array(20);d[0]=-1,d[1]=-1,d[2]=0,d[3]=0,d[4]=0,d[5]=1,d[6]=-1,d[7]=0,d[8]=1,d[9]=0,d[10]=-1,d[11]=1,d[12]=0,d[13]=0,d[14]=1,d[15]=1,d[16]=1,d[17]=0,d[18]=1,d[19]=1,this._vaoQuad=new f(e,i.Default3D,{geometry:s.Pos3Tex},{geometry:u.createVertex(e,35044,d)}),this._blendLayersProgram=a.getProgram(o.blendLayers),this._blackTex=n.createColorTexture(this._context,[0,0,0,1])}return e.prototype.dispose=function(){this._fbo&&(this._fbo.dispose(),this._fbo=null),this._vtFBO&&(this._vtFBO.dispose(),this._vtFBO=null),this._vaoQuad&&(this._vaoQuad.dispose(),this._vaoQuad=null),this._backgroundTex&&(this._backgroundTex.dispose(),this._backgroundTex=null),this._blackTex&&(this._blackTex.dispose(),this._blackTex=null),this._blendLayersProgram&&(this._blendLayersProgram.dispose(),this._blendLayersProgram=null),this._context&&(this._context=null)},e.prototype.updateTileTexture=function(e){for(var t=r.LayerClass.MAP,i=e.layerInfo[t],s=0;s<i.length;s++)i[s].pendingUpdates&=~r.TileUpdateTypes.UPDATE_TEXTURE;if(e.renderData){for(var n=e.renderData,o=e.parentSurface,l=o.baseOpacity,d=0,u=!1,c=i.length-1,h=i.length,f=0;f<i.length;f++){var b=i[f],m=o.layerViewByIndex(f,t),g=m.fullOpacity;if(_[f]=g,this._isBaseLayer(m.layer)&&h>=i.length&&(h=f),(b.data||b.upsampleFromTile)&&(d++,m.isOpaque&&1===g)){u=!0,c=f;break}}if(0===d&&this._backgroundTex)n.opacity=l,n.textureReference=this._backgroundTex,a.vec4.set(n.texOffsetAndScale,0,0,1,1);else if(1===d&&u){var b=i[c],T=void 0,y=void 0;b.data?(T=b,a.vec4.set(n.texOffsetAndScale,0,0,1,1)):(y=b.upsampleFromTile,T=y.tile.layerInfo[t][c],a.vec4.set(n.texOffsetAndScale,y.offset[0],y.offset[1],y.scale,y.scale)),n.opacity=l,T&&(x(T.data)&&(T.data=this._buildTexture(T.data),y?y.tile.updateMemoryUsed():e.updateMemoryUsed()),T.data instanceof p&&(n.textureReference=T.data))}else n.opacity=this._composeMapLayers(e,i,c,h,u,_),n.textureReference=null,a.vec4.set(n.texOffsetAndScale,0,0,1,1);this._setNeedsRender()}},e.prototype.setBackground=function(e){x(e)?this._backgroundTex=this._buildTexture(e):this._backgroundTex=n.createColorTexture(this._context,e||[0,0,0,0])},e.prototype._buildTexture=function(e){var t,a={target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,maxAnisotropy:this._maxAnisotropy,flipped:!0,hasMipmap:!0},r=this._context;if(e)try{t=new p(r,a,e)}catch(e){t=n.createEmptyTexture(r),console.warn("TileRenderer: failed to execute 'texImage2D', cross-origin image may not be loaded.")}else a.width=a.height=this.tileSize,t=new p(r,a);return r.bindTexture(t),t.generateMipmap(),t},e.prototype._bindFBO=function(e,t,a,r){return e&&e.width===t&&e.height===a||(e&&e.dispose(),e=c.create(this._context,{colorTarget:0,depthStencilTarget:r?1:0,width:t,height:a})),this._context.bindFramebuffer(e),e},e.prototype._drawRasterData=function(e,t,a,r){void 0===r&&(r=1);var i=this._context,s=this._blendLayersProgram,n=this._vaoQuad;i.bindProgram(s),i.bindVAO(n),h.assertCompatibleVertexAttributeLocations(n,s),i.bindTexture(e,0),s.setUniform1i("tex",0),s.setUniform1f("scale",t),s.setUniform2f("offset",a[0],a[1]),s.setUniform1f("opacity",r),i.drawArrays(5,0,h.vertexCount(n,"geometry"))},e.prototype._composeMapLayers=function(e,t,a,i,s,n){e.renderData.texture||(e.renderData.texture=this._buildTexture(),e.updateMemoryUsed());var o=r.LayerClass.MAP,u=e.renderData.texture,c=this._context;this._fbo=this._bindFBO(this._fbo,u.descriptor.width,u.descriptor.height,!1);var h=c.gl;c.setViewport(0,0,this.tileSize,this.tileSize),c.setClearColor(0,0,0,0),c.setClearDepth(1),c.clear(h.COLOR_BUFFER_BIT),c.setDepthTestEnabled(!1),c.setBlendFunction(1,771),c.setBlendEquation(32774),c.setBlendingEnabled(!0),!s&&this._backgroundTex&&this._drawRasterData(this._backgroundTex,1,b);for(var f=e.parentSurface.baseOpacity,_=!1,m=a;m>=0;m--){var g=t[m],T=g,y=e.lij,v=b,F=1;if(!g.data&&g.upsampleFromTile){var w=g.upsampleFromTile;y=w.tile.lij,T=w.tile.layerInfo[o][m],v=[w.offset[0],w.offset[1]],F=w.scale}if(T){if(m<i&&f<1&&!_&&(c.setBlendFunction(0,770),this._drawRasterData(this._blackTex,1,b,f),c.setBlendFunction(1,771),_=!0),T.data instanceof d){var B=e.parentSurface.layerViewByIndex(m,o);this._vtFBO=this._bindFBO(this._vtFBO,this.tileSize,this.tileSize,!0),c.setClearColor(1,1,1,0),c.clear(h.COLOR_BUFFER_BIT|h.DEPTH_BUFFER_BIT),l(this._context,y,T.data,B.renderer,B.schemaHelper,u.descriptor.width,u.descriptor.height),T.data.dispose(),T.data=this._buildTexture(),c.bindTexture(T.data),h.copyTexImage2D(c.gl.TEXTURE_2D,0,T.data.descriptor.pixelFormat,0,0,this.tileSize,this.tileSize,0),T.data.generateMipmap(),c.bindFramebuffer(this._fbo),T===g?e.updateMemoryUsed():g.upsampleFromTile.tile.updateMemoryUsed()}else x(T.data)&&(T.data=this._buildTexture(T.data),T===g?e.updateMemoryUsed():g.upsampleFromTile.tile.updateMemoryUsed());T.data instanceof p&&this._drawRasterData(T.data,F,v,n[m])}}return c.bindTexture(u),h.copyTexImage2D(c.gl.TEXTURE_2D,0,u.descriptor.pixelFormat,0,0,u.descriptor.width,u.descriptor.height,0),u.generateMipmap(),c.bindFramebuffer(null),c.setBlendFunctionSeparate(770,771,1,771),c.setBlendingEnabled(!1),this._resourceCounter.incrementNumTileTexturesComposited(),_?1:f},e.prototype._isBaseLayer=function(e){return e.parent&&"esri.Basemap"===e.parent.declaredClass&&e.parent.baseLayers.indexOf(e)>-1},e}()});