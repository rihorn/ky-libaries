// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.10/esri/copyright.txt for details.

define(["require","exports","../../../../../core/tsSupport/declareExtendsHelper","../../../../../core/tsSupport/decorateHelper","../../../../../core/clock","../../../../../core/Collection","../../../../../core/compilerUtils","../../../../../core/Handles","../../../../../core/Logger","../../../../../core/scheduling","../../../../../core/watchUtils","../../../../../core/accessorSupport/decorators","../../../../../core/libs/gl-matrix-2/gl-matrix","../../../../../layers/Layer","../../../../../layers/buildingSublayers/BuildingComponentSublayer","./sliceToolConfig","./sliceToolUtils","../../../support/geometryUtils","../../../support/stack","../../../webgl-engine/lib/Geometry","../../../webgl-engine/lib/GeometryUtil","../../../webgl-engine/lib/Layer","../../../webgl-engine/lib/Object3D","../../../webgl-engine/materials/ColorMaterial","../../../webgl-engine/materials/NativeLineMaterial","../../../webgl-engine/materials/RibbonLineMaterial","../../../webgl-engine/materials/SlicePlaneMaterial","../../../webgl-engine/parts/Model","../../../../interactive/InteractiveToolBase","../../../../interactive/interactiveToolUtils"],function(e,t,i,a,r,s,n,o,l,c,d,u,h,p,_,f,y,v,R,m,g,H,T,E,P,S,b,w,I,O){function L(e){return"mouse"!==e.pointerType||0===e.button}var A=s.ofType({key:function(e){return e instanceof p?"layer":e instanceof _?"building-component-sublayer":null},base:null,typeMap:{layer:p,"building-component-sublayer":_},castable:!1}),C=l.getLogger("esri.views.3d.interactive.analysisTools.slice.SliceTool"),D=function(e){function t(t,i){void 0===i&&(i=r.default);var a=e.call(this,t)||this;return a._clock=i,a.cursor=null,a.layersMode="none",a.excludedLayers=new A,a.disableEngineLayers=!1,a._handles=new o,a._viewHandles=new o,a._frameTask=null,a._ignoreClickEventId=null,a._prevPointerMoveTimeout=null,a._activePointerId=null,a._editingEnabled=!0,a.inputState=null,a._startPlane=v.boundedPlane.create(),a._previewPlane=null,a._activeKeyModifiers={},a._lastCursorPosition={x:0,y:0},a._baseOpacity=1,a._hoveredResizeHandleIdx=null,a._isShiftRestartHandleHovered=!1,a._isRotateHeadingHandleHovered=!1,a._resizeHandles=[{transform:h.mat4f64.create(),position:h.vec3f64.create(),scale:1,direction:[1,0],visible:!1},{transform:h.mat4f64.create(),position:h.vec3f64.create(),scale:1,direction:[1,1],visible:!1},{transform:h.mat4f64.create(),position:h.vec3f64.create(),scale:1,direction:[0,1],visible:!1},{transform:h.mat4f64.create(),position:h.vec3f64.create(),scale:1,direction:[-1,1],visible:!1},{transform:h.mat4f64.create(),position:h.vec3f64.create(),scale:1,direction:[-1,0],visible:!1},{transform:h.mat4f64.create(),position:h.vec3f64.create(),scale:1,direction:[-1,-1],visible:!1},{transform:h.mat4f64.create(),position:h.vec3f64.create(),scale:1,direction:[0,-1],visible:!1},{transform:h.mat4f64.create(),position:h.vec3f64.create(),scale:1,direction:[1,-1],visible:!1}],a._shiftRestartHandle={transform:h.mat4f64.create(),position:h.vec3f64.create(),visible:!1,forceHide:!1,floating:!1},a._rotateHeadingHandle={transform:h.mat4f64.create(),position:h.vec3f64.create(),visible:!1,forceHide:!1},a._areEngineLayersCreated=!1,a._outlineResources=null,a._gridResources=null,a._shiftRestartResources=null,a._resizeHandleResources=null,a._rotateHeadingHandleResources=null,a}i(t,e),s=t,t.prototype.initialize=function(){var e=this;this._handles.add([d.init(this,"state",function(){"slicing"===e.state?O.setActive(e,!0):"sliced"===e.state&&O.setActive(e,!1)}),this.excludedLayers.on("before-add",function(t){var i=t.item;null==i?t.preventDefault():i instanceof _||!y.isAlwaysDrapedLayer(i)?e.excludedLayers.includes(i)&&t.preventDefault():(C.error("excludedLayers","Layer '"+i.title+", id:"+i.id+"' of type '"+i.type+"' can not be individually excluded from slicing. Use 'excludeGroundSurface' instead."),t.preventDefault())})])},t.prototype.destroy=function(){this.detach(),this._handles.destroy(),this._handles=null,this._viewHandles.destroy(),this._viewHandles=null,this._removeFrameTask(),this._clearPointerMoveTimeout()},Object.defineProperty(t.prototype,"state",{get:function(){var e=!!this.plane,t=!!this.inputState;return e?e&&t?"slicing":e&&!t?"sliced":"ready":"ready"},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isSupported",{get:function(){return"3d"===this.get("view.type")},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"plane",{set:function(e){this._set("plane",e),this.visible&&(this._updateLayerViews(),this.view.slicePlane=e,this._updateEngineLayers(),e&&this._unsetOtherToolPlanes())},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"excludeGroundSurface",{set:function(e){this._set("excludeGroundSurface",e),this._updateLayerViews()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"editable",{set:function(e){this._set("editable",e),this._updateEngineLayers()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"_internallyEditable",{get:function(){return this.editable&&this._editingEnabled&&"none"===this.layersMode},enumerable:!0,configurable:!0}),t.prototype.show=function(){var e=this,t=this.view;this._viewHandles.add([t.on("pointer-down",function(t){e._shouldHandlePointerEvent(t)&&(e._onPointerDown(t)&&t.stopPropagation(),e._activePointerId=t.pointerId)}),t.on("pointer-drag",function(t){e._shouldHandlePointerEvent(t)&&e._onPointerDrag(t)&&t.stopPropagation()}),t.on("pointer-move",function(t){e._onPointerMove(t)&&t.stopPropagation(),e._updateMouseCursor()}),t.on("pointer-up",function(t){e._shouldHandlePointerEvent(t)&&(e._onPointerUp(t)&&t.stopPropagation(),e._activePointerId=null)}),t.on("click",function(t){L(t)&&e._onClick(t)&&t.stopPropagation()}),t.on("double-click",function(t){L(t)&&e._onDoubleClick(t)&&t.stopPropagation()}),t.on("drag",function(t){e.inputState&&t.stopPropagation()}),t.on("key-down",function(t){e._onKeyDown(t)&&t.stopPropagation()}),t.on("key-up",function(t){e._onKeyUp(t)&&t.stopPropagation()}),t.allLayerViews.on("change",function(){e._updateLayerViews()}),this.excludedLayers.on("change",function(t){e._updateLayerViews()})],"general"),this._createEngineLayers(),this._updateEngineLayers(),this._updateMouseCursor(),this._updateLayerViews(),this.view.slicePlane=this.plane,this._viewHandles.has("camera")||this.disableEngineLayers||this._viewHandles.add(this.view.state.watch("camera",function(){e._updateEngineLayers(),e._updateMouseCursor()}),"camera")},t.prototype.hide=function(){this._removeEngineLayers(),this._updateMouseCursor(),this._updateLayerViews(),this.view.slicePlane=null,this._viewHandles.removeAll(),this._clearPointerMoveTimeout()},t.prototype.reset=function(){this.plane=null,this._set("layersMode","none")},t.prototype.newSlice=function(){this.reset(),this._unsetOtherToolPlanes(),O.setActive(this,!0)},t.prototype.clearSlice=function(){this.reset()},t.prototype.enterExcludeLayerMode=function(){this._set("layersMode","exclude"),O.setActive(this,!0)},t.prototype.exitExcludeLayerMode=function(){this._set("layersMode","none"),O.setActive(this,!1)},t.prototype.deactivate=function(){this._updateMouseCursor(!1),this._set("layersMode","none"),"sliced"!==this.state&&(this.plane=null)},t.prototype.disableEditing=function(){this._editingEnabled=!1,this._updateEngineLayers()},t.prototype.enableEditing=function(){this._editingEnabled=!0,this._updateEngineLayers()},t.prototype._createEngineLayers=function(){var e=this;if(!this._areEngineLayersCreated&&!this.disableEngineLayers){this._areEngineLayersCreated=!0;var t=[[-1,-1,0],[1,-1,0],[1,1,0],[-1,1,0],[-1,-1,0]],i=new m(g.createPolylineGeometry(t),"slice-outline"),a=f.PLANE_OUTLINE_COLOR.slice(),r=new S({color:a,writeDepth:!1,width:f.PLANE_OUTLINE_WIDTH},"slice-outline");r.renderOccluded=!0;var s=new H("slice-outline",{isPickable:!1},"slice-outline"),n=new T({idHint:"slice-outline"}),o=function(t){n.removeAllGeometries(),t&&(a[3]=f.PLANE_OUTLINE_COLOR[3]*e._baseOpacity,r.setParameterValues({color:a}),n.addGeometry(i,r,t))};s.addObject(n),this._outlineResources={layer:s,objects:[n],materials:[r],resetGeometry:o},this._addResourcesToStage(this._outlineResources);var l=new m(g.createSquareGeometry(),"slice-grid"),c=f.PLANE_BACKGROUND_COLOR.slice(),d=new b({backgroundColor:c,gridColor:f.GRID_COLOR,gridWidth:4},"slice-grid");d.renderOccluded=!0;var s=new H("slice-grid",{isPickable:!1},"slice-grid"),u=new T({idHint:"slice-grid"}),p=[0,0,0,0],o=function(t){if(u.removeAllGeometries(),t){c[3]=f.PLANE_BACKGROUND_COLOR[3]*e._baseOpacity;var i=e.inputState&&"resize"===e.inputState.type,a=i?f.GRID_COLOR:p;d.setParameterValues({backgroundColor:c,gridColor:a}),u.addGeometry(l,d,t)}};s.addObject(u),this._gridResources={layer:s,objects:[u],materials:[d],resetGeometry:o},this._addResourcesToStage(this._gridResources);var _=[h.vec3f64.fromValues(0,0,-f.SHIFT_RESTART_ARROW_LENGTH/2),h.vec3f64.fromValues(0,0,f.SHIFT_RESTART_ARROW_LENGTH/2)],v=y.addArrowTips(_,!0),R=function(e,t){return y.createArrowGeometry(_,_,{tubeRadius:f.SHIFT_RESTART_TUBE_RADIUS,tipRadius:f.SHIFT_RESTART_TIP_RADIUS,tipLength:f.SHIFT_RESTART_TIP_LENGTH,tubeFocusMultiplier:f.SHIFT_RESTART_TUBE_FOCUS_MULTIPLIER,tipFocusMultiplier:f.SHIFT_RESTART_TIP_FOCUS_MULTIPLIER,padding:e,bothEnds:!0,flat:null,focusTipLength:!0,addCap:t})},w=R(0,!1),I=R(f.SHIFT_RESTART_ARROW_OUTLINE_WIDTH,!0),O=new E({color:f.SHIFT_RESTART_ARROW_TIP_COLOR},"slice-shift"),L=new E({color:f.SHIFT_RESTART_ARROW_TIP_COLOR,transparent:!0,writeDepth:!1,testDepth:!1,cullFace:"back",order:4},"slice-shift"),A=new E({color:f.SHIFT_RESTART_ARROW_CAP_COLOR,transparent:!0,writeDepth:!1,testDepth:!1,cullFace:"back",order:2},"slice-shift"),C=new E({color:f.SHIFT_RESTART_TUBE_COLOR,transparent:!0,writeDepth:!1,testDepth:!1,cullFace:"back",order:3},"slice-shift"),D=new E({color:f.SHIFT_RESTART_OUTLINE_COLOR,transparent:!0,writeDepth:!1,testDepth:!1,cullFace:"front",order:1},"slice-shift"),G=new m(g.createPolylineGeometry([[0,0,0],[-f.SHIFT_RESTART_OFFSET_DISTANCE,0,0]]),"slice-rotate-heading"),M=new m(g.createPolylineGeometry([[0,0,0],[-f.SHIFT_RESTART_OFFSET_DISTANCE,0,0]]),"slice-rotate-heading"),F=new P({color:f.SHIFT_RESTART_CALLOUT_COLOR},"slice-rotate-heading");F.renderOccluded=!0;var k=new T({idHint:"slice-shift"}),s=new H("slice-shift",{isPickable:!1},"slice-shift"),z=h.mat4f64.create(),o=function(t,i){k.removeAllGeometries(),t&&(i?(w.focused.forEach(function(e){var i=e.part,a=e.geometry,r=e.transform,s="tip"===i?L:"cap"===i?A:C;k.addGeometry(a,s,h.mat4.multiply(z,t,r)),k.addGeometry(a,O,h.mat4.multiply(z,t,r))}),I.focused.forEach(function(e){var i=e.geometry,a=e.transform;k.addGeometry(i,D,h.mat4.multiply(z,t,a))}),e._shiftRestartHandle.floating||k.addGeometry(M,F,t)):(w.normal.forEach(function(e){var i=e.part,a=e.geometry,r=e.transform,s="tip"===i?L:"cap"===i?A:C;k.addGeometry(a,s,h.mat4.multiply(z,t,r)),k.addGeometry(a,O,h.mat4.multiply(z,t,r))}),I.normal.forEach(function(e){var i=e.geometry,a=e.transform;k.addGeometry(i,D,h.mat4.multiply(z,t,a))}),e._shiftRestartHandle.floating||k.addGeometry(G,F,t)))};s.addObject(k),this._shiftRestartResources={layer:s,objects:[k],materials:[L,C,D],intersectPath:v,resetGeometry:o},this._addResourcesToStage(this._shiftRestartResources);var t=[[1,0,0],[0,0,0],[0,1,0]],N=new m(g.createPolylineGeometry(t),"slice-resize"),U=new m(g.createPolylineGeometry([[1,0,0],[-1,0,0]]),"slice-resize"),s=new H("slice-resize",{isPickable:!1},"slice-resize"),x=this._resizeHandles.map(function(){return new T({idHint:"slice-resize"})}),V=f.HANDLE_COLOR.concat([1]),j=this._resizeHandles.map(function(e){var t=y.isDiagonalResizeHandle(e),i=new S({color:V,width:t?f.RESIZE_HANDLE_CORNER_WIDTH:f.RESIZE_HANDLE_EDGE_WIDTH},"slice-resize");return i.renderOccluded=!0,i}),W=new P({color:V},"slice-resize");W.renderOccluded=!0;for(var B=x.map(function(t,i){return function(a,r){if(t.removeAllGeometries(),a){var s=y.isDiagonalResizeHandle(e._resizeHandles[i]),n=s?N:U,o=(s?f.RESIZE_HANDLE_CORNER_WIDTH:f.RESIZE_HANDLE_EDGE_WIDTH)*(r?f.DISPLAY_FOCUS_MULTIPLIER:1);if(1===o)t.addGeometry(n,W,a);else{var l=j[i];l.setParameterValues({width:o}),t.addGeometry(n,l,a)}}}}),K=0,Z=x;K<Z.length;K++){var Y=Z[K];s.addObject(Y)}this._resizeHandleResources={layer:s,objects:x,materials:j.concat([W]),resetGeometries:B},this._addResourcesToStage(this._resizeHandleResources);var q=.1*Math.PI,J=1.7*Math.PI,Q=f.ROTATE_HEADING_DISC_RADIUS,X=Q*f.ROTATE_HEADING_DISC_RADIUS_FOCUS_MULTIPLIER,$=f.ROTATE_HEADING_DISC_ARROW_RADIUS,ee=f.ROTATE_HEADING_DISC_ARROW_RADIUS*f.ROTATE_HEADING_DISC_RADIUS_FOCUS_MULTIPLIER,te=f.ROTATE_HEADING_OFFSET_DISTANCE,ie=function(e){for(var t=[],i=0;i<32;i++){var a=Math.PI+q+(J-q)*i/31;t.push(h.vec3f64.fromValues(te+e*Math.cos(a),e*Math.sin(a),0))}return t},ae=ie($),re=ie(ee),v=y.addArrowTips(ae,!1),se=y.createArrowGeometry(ae,re,{tubeRadius:f.ROTATE_HEADING_TUBE_RADIUS,tipRadius:f.ROTATE_HEADING_TIP_RADIUS,tipLength:f.ROTATE_HEADING_TIP_LENGTH,tubeFocusMultiplier:f.ROTATE_HEADING_TUBE_FOCUS_MULTIPLIER,tipFocusMultiplier:f.ROTATE_HEADING_TIP_FOCUS_MULTIPLIER,padding:0,bothEnds:!1,flat:{thickness:2},focusTipLength:!0,addCap:!0}),ne=new E({color:f.ROTATE_HEADING_ARROW_COLOR,transparent:!0,writeDepth:!1,testDepth:!1,cullFace:"back",order:2},"slice-rotate-heading"),oe=new E({color:f.ROTATE_HEADING_ARROW_COLOR},"slice-rotate-heading"),le=new m(g.createPolylineGeometry([[0,0,0],[te-Q,0,0]]),"slice-rotate-heading"),ce=new m(g.createPolylineGeometry([[0,0,0],[te-X,0,0]]),"slice-rotate-heading"),de=new P({color:f.ROTATE_HEADING_CALLOUT_COLOR},"slice-rotate-heading");de.renderOccluded=!0;var ue=h.vec3f64.fromValues(0,0,1),he=h.vec3f64.fromValues(te,0,0),pe=new m(g.createCylinderGeometry(1,Q,32,ue,he),"slice-rotate-heading"),_e=new m(g.createCylinderGeometry(1,X,32,ue,he),"slice-rotate-heading"),fe=new E({color:f.ROTATE_HEADING_DISC_COLOR,transparent:!0,writeDepth:!1,testDepth:!1,cullFace:"back",order:1},"slice-rotate-heading");fe.renderOccluded=!0;var s=new H("slice-rotate-heading",{isPickable:!1},"slice-rotate-heading"),ye=new T({idHint:"slice-rotate-heading"}),ve=h.mat4f64.create(),o=function(e,t){ye.removeAllGeometries(),e&&(t?(se.focused.forEach(function(t){var i=t.geometry,a=t.transform;ye.addGeometry(i,ne,h.mat4.multiply(ve,e,a)),ye.addGeometry(i,oe,h.mat4.multiply(ve,e,a))}),ye.addGeometry(ce,de,e),ye.addGeometry(_e,fe,e)):(se.normal.forEach(function(t){var i=t.geometry,a=t.transform;ye.addGeometry(i,ne,h.mat4.multiply(ve,e,a)),ye.addGeometry(i,oe,h.mat4.multiply(ve,e,a))}),ye.addGeometry(le,de,e),ye.addGeometry(pe,fe,e)))};s.addObject(ye),this._rotateHeadingHandleResources={layer:s,objects:[ye],materials:[ne,de,fe],intersectPath:v,resetGeometry:o},this._addResourcesToStage(this._rotateHeadingHandleResources)}},t.prototype._updateEngineLayers=function(){if(this._areEngineLayersCreated){this._outlineResources.resetGeometry(),this._gridResources.resetGeometry(),this._shiftRestartResources.resetGeometry(),this._resizeHandleResources.resetGeometries.forEach(function(e){return e()}),this._rotateHeadingHandleResources.resetGeometry(),y.hideHandles(this._shiftRestartHandle,this._rotateHeadingHandle,this._resizeHandles);var e=this.plane||n.isSome(this._previewPlane)&&this._previewPlane,t=e===this._previewPlane;if(e){var i=y.calculateBoundedPlaneTranslateRotate(e,F),a=h.vec3.set(R.sv3d.get(),h.vec3.length(e.basis1),h.vec3.length(e.basis2),1);h.mat4.fromScaling(k,a);var r=h.mat4.multiply(k,i,k),s=this.view._stage.getCamera(),o=y.calculateScreenSpaceBasisLength2(e.origin,e.basis1,s),l=y.calculateScreenSpaceBasisLength2(e.origin,e.basis2,s),c=Math.max(o,l);if(this._gridResources.resetGeometry(r),t)return void this._outlineResources.resetGeometry(r);this._internallyEditable&&c>f.SHIFT_MIN_BASIS_SCREEN_LEN2&&(y.updateShiftRestartHandle(this._shiftRestartHandle,i,e,this.view.renderCoordsHelper,s),y.updateShiftRestartObject(this._shiftRestartResources.resetGeometry,this._shiftRestartHandle,this._isShiftRestartHandleFocused())),this._internallyEditable&&c>f.PLANE_MIN_BASIS_SCREEN_LEN2?(y.updateResizeHandles(i,e,this._resizeHandles),y.updateResizeHandleObjects(this._resizeHandleResources.resetGeometries,this._resizeHandles,this._focusedResizeHandleIdx())):this._outlineResources.resetGeometry(r),this._internallyEditable&&c>f.ROTATE_MIN_BASIS_SCREEN_LEN2&&(y.updateRotateHeadingHandle(i,e,this.view.renderCoordsHelper,s,this._rotateHeadingHandle,this._isRotateHeadingHandleFocused()),y.updateRotateHeadingObject(this._rotateHeadingHandleResources.resetGeometry,this._rotateHeadingHandle,this._isRotateHeadingHandleFocused()))}}},t.prototype._removeEngineLayers=function(){this._areEngineLayersCreated&&(this._areEngineLayersCreated=!1,this._removeResourcesFromStage(this._outlineResources),this._outlineResources=null,this._removeResourcesFromStage(this._gridResources),this._gridResources=null,this._removeResourcesFromStage(this._shiftRestartResources),this._shiftRestartResources=null,this._removeResourcesFromStage(this._resizeHandleResources),this._resizeHandleResources=null,this._removeResourcesFromStage(this._rotateHeadingHandleResources),this._rotateHeadingHandleResources=null)},t.prototype._updateLayerViews=function(){var e=this.view.tools.some(function(e){return e instanceof s&&!!e.plane}),t=[],i=function(e){"layers"in e?e.layers.forEach(i):t.push(e)};this.excludedLayers.forEach(i),this.view.allLayerViews.forEach(function(i){"slicePlaneEnabled"in i&&(i.slicePlaneEnabled=e&&t.indexOf(i.layer)<0),"componentLayerViews"in i&&i.componentLayerViews.forEach(function(i){i.slicePlaneEnabled=e&&t.indexOf(i.layer)<0})}),this.view.basemapTerrain.slicePlaneEnabled=e&&!this.excludeGroundSurface},t.prototype._onPointerDown=function(e){var t=this;if("exclude"===this.layersMode||!this._internallyEditable)return!1;var i=!1,a=this.view._stage.getCamera(),r=this._calculatePickRay(e),s=function(e,t,i){var a=y.createShiftPlane(t,i.plane,r.direction,v.plane.create()),s=h.vec3f64.create();return v.plane.intersectRay(a,r,s),{type:"shift",creating:e,shiftPlane:a,depth:0,startPoint:s}};if(this.plane)if(y.intersectsShiftRestartHandle(this._shiftRestartHandle,this._shiftRestartResources.intersectPath,{camera:a,pointerType:e.pointerType,ray:r}))v.boundedPlane.copy(this.plane,this._startPlane),this.inputState=s(!1,this._shiftRestartHandle.position,this.plane),i=!0;else if(y.intersectsRotateHeadingHandle(this._rotateHeadingHandle,this._rotateHeadingHandleResources.intersectPath,{camera:a,pointerType:e.pointerType,ray:r})){var n=y.createRotatePlane(this.plane,this.view.renderCoordsHelper,v.plane.create()),o=h.vec3f64.create();v.plane.intersectRay(n,r,o)&&(v.boundedPlane.copy(this.plane,this._startPlane),this.inputState={type:"rotate-heading",rotatePlane:n,startPoint:o},i=!0)}else{for(var l=function(i,s){if(y.intersectsResizeHandle(i,t.plane,{camera:a,pointerType:e.pointerType,ray:r})){var n=R.sv3d.get();if(v.plane.intersectRay(t.plane.plane,r,n))return v.boundedPlane.copy(t.plane,t._startPlane),t.inputState={type:"resize",activeHandleIdx:s,startPoint:h.vec3f64.clone(n)},!0}return!1},c=0;c<this._resizeHandles.length&&!i;c++){var d=this._resizeHandles[c];y.isDiagonalResizeHandle(d)&&l(d,c)&&(i=!0)}for(var c=0;c<this._resizeHandles.length&&!i;c++){var d=this._resizeHandles[c];!y.isDiagonalResizeHandle(d)&&l(d,c)&&(i=!0)}}if(!i&&!this.inputState&&!this.plane&&this.active){var u=this.plane||v.boundedPlane.create();this._pickPlane(e,!1,this._activeKeyModifiers,u)&&(v.boundedPlane.copy(u,this._startPlane),this.inputState=s(!0,u.origin,u),this.plane=u,i=!0)}return i&&this._updateMouseCursor(),i},t.prototype._onPointerDrag=function(e){var t=this.inputState;if(!t)return!1;if(!this.plane)return!1;if("end"===e.action)return this._finishInput(e);var i=this._calculatePickRay(e),a=this.view._stage.getCamera();switch(t.type){case"shift":if(v.plane.intersectRay(t.shiftPlane,i,G)){var r=Math.min((1-Math.abs(h.vec3.dot(this.plane.plane,i.direction)))/.001,1),s=-v.plane.signedDistance(this._startPlane.plane,G),o=-v.plane.signedDistance(this._startPlane.plane,t.startPoint);t.depth=t.depth*(1-r)+s*r-o,h.vec3.copy(M,this._startPlane.origin);var l=h.vec3.copy(R.sv3d.get(),this._startPlane.plane);h.vec3.scale(l,l,-t.depth),h.vec3.add(l,l,M),v.boundedPlane.fromValues(l,this.plane.basis1,this.plane.basis2,this.plane),this.plane=this.plane}break;case"resize":var c=R.sv3d.get();if(v.plane.intersectRay(this.plane.plane,i,c)){var d=this._resizeHandles[t.activeHandleIdx];this.plane=y.resizePlane(d,t.startPoint,c,a,this._startPlane,this.plane)}break;case"rotate-heading":var u=R.sm4d.get(),c=R.sv3d.get();if(v.plane.intersectRay(t.rotatePlane,i,c)){y.calculateInputRotationTransform(t.startPoint,c,this.plane.origin,t.rotatePlane,u);var p=h.vec3.transformMat4(R.sv3d.get(),this._startPlane.basis1,u),_=h.vec3.transformMat4(R.sv3d.get(),this._startPlane.basis2,u);v.boundedPlane.fromValues(this.plane.origin,p,_,this.plane),this.plane=this.plane}break;default:n.neverReached(t)}return!0},t.prototype._onPointerMove=function(e){return this._lastCursorPosition.x=e.x,this._lastCursorPosition.y=e.y,(this._shiftRestartHandle.forceHide||this._rotateHeadingHandle.forceHide)&&(this._shiftRestartHandle.forceHide=!1,this._rotateHeadingHandle.forceHide=!1,this._updateEngineLayers()),this._resetPointerMoveTimeout(),"touch"!==e.pointerType&&(this._updatePreviewPlane(e,this._activeKeyModifiers),!!this.plane&&(!!this._internallyEditable&&(this._updateHovered(e)&&(this._updateEngineLayers(),this._updateMouseCursor()),null!=this._hoveredResizeHandleIdx||this._isShiftRestartHandleHovered||this._isRotateHeadingHandleHovered)))},t.prototype._onPointerUp=function(e){return!!this._finishInput(e)&&(this._ignoreClickEventId=e.eventId,!0)},t.prototype._onClick=function(e){var t=this;return"exclude"===this.layersMode?(this.view.hitTest(e).then(function(e){var i=e.results[0],a=i&&i.graphic,r=i&&i.mapPoint;if(a){var s=a.sourceLayer;s&&t.excludedLayers.push(s)}else r&&(t.excludeGroundSurface=!0)}),this._set("layersMode","none"),O.setActive(this,!1),!0):!!this.inputState||this._ignoreClickEventId===e.eventId},t.prototype._onDoubleClick=function(e){return this._ignoreClickEventId===e.eventId},t.prototype._onKeyDown=function(e){return"Escape"===e.key&&this.plane&&this.active?(this.plane=null,!0):(e.key===f.forceVerticalModifier||e.key===f.forceHorizontalModifier)&&(this._activeKeyModifiers[e.key]=!0,n.isSome(this._previewPlane)&&this._updatePreviewPlane(this._lastCursorPosition,this._activeKeyModifiers),!0)},t.prototype._onKeyUp=function(e){return!(e.key!==f.forceVerticalModifier&&e.key!==f.forceHorizontalModifier||!this._activeKeyModifiers[e.key])&&(delete this._activeKeyModifiers[e.key],n.isSome(this._previewPlane)&&this._updatePreviewPlane(this._lastCursorPosition,this._activeKeyModifiers),!0)},t.prototype._finishInput=function(e){var t=this.inputState;return this.inputState=null,!(!t||!this.plane)&&(v.boundedPlane.copy(this.plane,this._startPlane),this._updateHovered(e),this._updateEngineLayers(),this._updateMouseCursor(),!0)},t.prototype._updatePreviewPlane=function(e,t){var i=this,a=this._previewPlane;if(this._previewPlane=null,!this.plane&&this.active){var r=n.isSome(a)?a:v.boundedPlane.create();if(a=n.isSome(a)?v.boundedPlane.copy(a,z):null,this._pickPlane(e,!0,t,r)){var s=f.PREVIEW_FADE_DOT_THRESHOLD,o=!1;n.isSome(a)&&(o=h.vec3.dot(a.plane,r.plane)<s||h.vec3.dot(h.vec3.normalize(R.sv3d.get(),a.basis1),h.vec3.normalize(R.sv3d.get(),r.basis1))<s),o&&(this._baseOpacity=0),this._previewPlane=r}}n.isSome(this._previewPlane)&&n.isNone(this._frameTask)&&0===this._baseOpacity?this._frameTask=c.addFrameTask({update:function(e){var t=e.deltaTime;i._baseOpacity=Math.min(i._baseOpacity+t/(1e3*f.PREVIEW_FADE_DURATION_SECONDS),1),i._updateEngineLayers(),1===i._baseOpacity&&i._removeFrameTask()}}):n.isNone(this._frameTask)&&(this._updateEngineLayers(),this._removeFrameTask())},t.prototype._removeFrameTask=function(){n.isSome(this._frameTask)&&(this._frameTask.remove(),this._frameTask=null)},t.prototype._updateHovered=function(e){var t=this,i=this._hoveredResizeHandleIdx,a=this._isShiftRestartHandleHovered,r=this._isRotateHeadingHandleHovered;this._hoveredResizeHandleIdx=null,this._isShiftRestartHandleHovered=!1,this._isRotateHeadingHandleHovered=!1;var s=e.pointerType,n=function(){return!t._isAnyHandleFocused()&&"touch"!==s},o=this._calculatePickRay(e),l=this.view._stage.getCamera();if(n()&&(this._isShiftRestartHandleHovered=y.intersectsShiftRestartHandle(this._shiftRestartHandle,this._shiftRestartResources.intersectPath,{camera:l,pointerType:s,ray:o})),n()&&(this._isRotateHeadingHandleHovered=y.intersectsRotateHeadingHandle(this._rotateHeadingHandle,this._rotateHeadingHandleResources.intersectPath,{camera:l,pointerType:s,ray:o})),n())for(var c=0;c<this._resizeHandles.length;c++){var d=this._resizeHandles[c];if(y.intersectsResizeHandle(d,this.plane,{camera:l,pointerType:s,ray:o})){this._hoveredResizeHandleIdx=c;break}}return this._hoveredResizeHandleIdx!==i||this._isShiftRestartHandleHovered!==a||this._isRotateHeadingHandleHovered!==r},t.prototype._focusedResizeHandleIdx=function(){return this.inputState&&"resize"===this.inputState.type?this.inputState.activeHandleIdx:this._hoveredResizeHandleIdx},t.prototype._isShiftRestartHandleFocused=function(){return!(!this.inputState||"shift"!==this.inputState.type)||this._isShiftRestartHandleHovered},t.prototype._isRotateHeadingHandleFocused=function(){return!(!this.inputState||"rotate-heading"!==this.inputState.type)||this._isRotateHeadingHandleHovered},t.prototype._calculatePickRay=function(e){var t=h.vec2f64.fromValues(e.x,this.view.height-e.y),i=v.ray.create();return v.ray.fromScreen(this.view.state.camera,t,i),h.vec3.normalize(i.direction,i.direction),i},t.prototype._pickSelector=function(e){var t=h.vec2f64.fromValues(e.x,this.view.height-e.y);return this.view.sceneIntersectionHelper.intersectToolSelectorScreen(t)},t.prototype._pickPlane=function(e,t,i,a){var r=this._pickSelector(e).minResult,s=R.sv3d.get();if(!r.getIntersectionPoint(s))return!1;var n=r.getTransformedNormal(R.sv3d.get()),o=this.view._stage.getCamera();h.vec3.dot(n,o.viewForward)>0&&h.vec3.scale(n,n,-1);var l=y.calculatePlaneHalfSize(s,o),c=(t?1:-1)*l*f.INITIAL_DEPTH_OFFSET_FRAC,d=h.vec3.scale(R.sv3d.get(),n,c);h.vec3.add(d,d,s);var u=i[f.forceVerticalModifier]?"vertical":i[f.forceHorizontalModifier]?"horizontal":null;return y.createPlane(d,n,0,l,l,o,u,this.view.renderCoordsHelper,a),!0},t.prototype._addResourcesToStage=function(e){var t=this;e.materials.forEach(function(e){return t.view._stage.add(w.ContentType.MATERIAL,e)}),e.objects.forEach(function(e){return t.view._stage.add(w.ContentType.OBJECT,e)}),this.view._stage.add(w.ContentType.LAYER,e.layer),this.view._stage.addToViewContent([e.layer.id])},t.prototype._removeResourcesFromStage=function(e){var t=this;this.view._stage.remove(w.ContentType.LAYER,e.layer.id),this.view._stage.removeFromViewContent([e.layer.id]),e.objects.forEach(function(e){return t.view._stage.remove(w.ContentType.OBJECT,e.id)}),e.materials.forEach(function(e){return t.view._stage.remove(w.ContentType.MATERIAL,e.id)})},t.prototype._updateMouseCursor=function(e){void 0===e&&(e=this.active),this._set("cursor",null),this._isAnyHandleFocused()?this._set("cursor","slicing"===this.state?"grabbing":"pointer"):e&&this._set("cursor","crosshair")},t.prototype._isAnyHandleFocused=function(){return null!=this._focusedResizeHandleIdx()||this._isShiftRestartHandleFocused()||this._isRotateHeadingHandleFocused()},t.prototype._clearPointerMoveTimeout=function(){this._prevPointerMoveTimeout&&(this._prevPointerMoveTimeout.remove(),this._prevPointerMoveTimeout=null)},t.prototype._resetPointerMoveTimeout=function(){var e=this;this._clearPointerMoveTimeout(),this._prevPointerMoveTimeout=this._clock.setTimeout(function(){e._shiftRestartHandle.forceHide=!0,e._isShiftRestartHandleHovered=!1,e._rotateHeadingHandle.forceHide=!0,e._isRotateHeadingHandleHovered=!1,e._updateEngineLayers(),e._updateMouseCursor()},f.POINTER_MOVE_TIMER_MS)},t.prototype._shouldHandlePointerEvent=function(e){return L(e)&&(n.isNone(this._activePointerId)||this._activePointerId===e.pointerId)},t.prototype._unsetOtherToolPlanes=function(){var e=this;this.view.tools.forEach(function(t){t!==e&&t instanceof s&&(t._set("plane",null),t._updateEngineLayers())})};var s;return a([u.property({constructOnly:!0})],t.prototype,"view",void 0),a([u.property({dependsOn:["plane","inputState"],readOnly:!0})],t.prototype,"state",null),a([u.property({dependsOn:["view.type"],readOnly:!0})],t.prototype,"isSupported",null),a([u.property({readOnly:!0})],t.prototype,"cursor",void 0),a([u.property({value:null})],t.prototype,"plane",null),a([u.property({readOnly:!0})],t.prototype,"layersMode",void 0),a([u.property({readOnly:!0})],t.prototype,"excludedLayers",void 0),a([u.property({type:Boolean,value:!1})],t.prototype,"excludeGroundSurface",null),a([u.property({value:!0})],t.prototype,"editable",null),a([u.property()],t.prototype,"inputState",void 0),t=s=a([u.subclass("esri.views.3d.interactive.analysisTools.slice.SliceTool")],t)}(u.declared(I)),G=h.vec3f64.create(),M=h.vec3f64.create(),F=h.mat4f64.create(),k=h.mat4f64.create(),z=v.boundedPlane.create();return D});