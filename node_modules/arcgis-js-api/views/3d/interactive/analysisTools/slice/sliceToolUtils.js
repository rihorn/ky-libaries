// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.10/esri/copyright.txt for details.

define(["require","exports","../../../../../core/compilerUtils","../../../../../core/libs/gl-matrix-2/gl-matrix","./sliceToolConfig","../../../support/geometryUtils","../../../support/stack","../../../webgl-engine/lib/Geometry","../../../webgl-engine/lib/GeometryData","../../../webgl-engine/lib/GeometryUtil","../../../webgl-engine/lib/Util"],function(e,t,a,i,s,r,n,o,c,v,l){function d(e,t,a,s,o,c,v,l,d){return u(t,l.worldUpAtPosition(e,n.sv3d.get()),c,v,d.basis1,d.basis2),i.vec3.scale(d.basis1,d.basis1,s),i.vec3.scale(d.basis2,d.basis2,o),i.vec3.copy(d.origin,t),i.vec3.scale(d.origin,d.origin,-a),i.vec3.add(d.origin,d.origin,e),r.boundedPlane.fromValues(d.origin,d.basis1,d.basis2,d)}function u(e,t,r,o,c,v){var l=t,d=i.vec3.dot(e,l),u=Math.abs(d)>s.VERTICAL_DOT_THRESHOLD?"vertical":"horizontal",g=n.sv3d.get(),m=n.sv3d.get(),f=function(){i.vec3.cross(g,l,r.viewUp),i.vec3.cross(m,l,g)},p=function(e){i.vec3.cross(m,e,l),i.vec3.copy(g,l)};if(a.isSome(o)&&o!==u)switch(o){case"vertical":f();break;case"horizontal":p(r.viewUp);break;default:a.neverReached(o)}else switch(u){case"vertical":f();break;case"horizontal":p(e);break;default:a.neverReached(u)}var b=i.vec3.cross(n.sv3d.get(),g,m);i.vec3.dot(b,r.viewForward)>0&&i.vec3.scale(m,m,-1),i.vec3.normalize(c,g),i.vec3.normalize(v,m)}function g(e,t,a,o,c,v){var l=i.vec3.copy(n.sv3d.get(),v.origin),d=i.vec3.copy(n.sv3d.get(),v.basis1),u=i.vec3.copy(n.sv3d.get(),v.basis2),g=i.vec3.copy(n.sv3d.get(),c.origin);i.vec3.add(g,g,i.vec3.scale(n.sv3d.get(),c.basis1,e.direction[0]<0?1:-1)),i.vec3.add(g,g,i.vec3.scale(n.sv3d.get(),c.basis2,e.direction[1]<0?1:-1));var m=i.vec3.length(c.basis1),f=i.vec3.length(c.basis2),p=i.vec3.subtract(n.sv3d.get(),a,g),b=i.vec3.subtract(n.sv3d.get(),t,g),h=0,P=0;if(G(e)){var y=O(c),I=O(v);h=m-.5*e.direction[0]*i.vec3.dot(c.basis1,b)/m,P=f-.5*e.direction[1]*i.vec3.dot(c.basis2,b)/f;var S=I/y;h*=S,P*=S}var R=.5*e.direction[0]*i.vec3.dot(c.basis1,p)/m,_=.5*e.direction[1]*i.vec3.dot(c.basis2,p)/f,T=h+R,E=P+_,A=i.vec3.scale(n.sv3d.get(),c.basis1,T/m),w=i.vec3.scale(n.sv3d.get(),c.basis2,E/f);return T>0&&U(v.origin,A,o)>s.PLANE_MIN_BASIS_SCREEN_LEN2&&i.vec3.copy(d,A),E>0&&U(v.origin,w,o)>s.PLANE_MIN_BASIS_SCREEN_LEN2&&i.vec3.copy(u,w),i.vec3.copy(l,g),i.vec3.add(l,l,i.vec3.scale(n.sv3d.get(),d,e.direction[0]<0?-1:1)),i.vec3.add(l,l,i.vec3.scale(n.sv3d.get(),u,e.direction[1]<0?-1:1)),r.boundedPlane.fromValues(l,d,u,v)}function m(e,t){return s.INITIAL_PLANE_HALF_SIZE_VIEW_PROPORTION*Math.min(t.width,t.height)*t.computePixelSizeAt(e)}function f(e,t,a,s){var o=i.vec3.cross(n.sv3d.get(),t,a);return i.vec3.cross(o,o,t),r.plane.fromPositionAndNormal(e,o,s)}function p(e,t){return b(e.basis1,e.basis2,e.origin,t)}function b(e,t,a,s){var r=i.vec3.normalize(n.sv3d.get(),e),o=i.vec3.normalize(n.sv3d.get(),t),c=i.vec3.cross(n.sv3d.get(),r,o);return s[0]=r[0],s[1]=r[1],s[2]=r[2],s[3]=0,s[4]=o[0],s[5]=o[1],s[6]=o[2],s[7]=0,s[8]=c[0],s[9]=c[1],s[10]=c[2],s[11]=0,s[12]=a[0],s[13]=a[1],s[14]=a[2],s[15]=1,s}function h(e,t,a){e.visible=!1,t.visible=!1,a.forEach(function(e){return e.visible=!1})}function P(e,t,a){var s=t.worldUpAtPosition(e.origin,n.sv3d.get()),o=V(e,s),c=M(s,e),v=i.vec3.copy(n.sv3d.get(),o?1===c?e.basis1:e.basis2:e.plane);return r.plane.fromPositionAndNormal(e.origin,v,a)}function y(e,t,a,o,c){if(e.forceHide)return void(e.visible=!1);e.floating=!1;var v=o.worldUpAtPosition(a.origin,n.sv3d.get()),l=V(a,v),d=M(v,a),u=z(a),g=l&&2!==d?u.basis2Positive:u.basis1Positive;i.mat4.rotateZ(e.transform,t,g.rotationIdx*Math.PI/2);var m=i.vec3.subtract(n.sv3d.get(),g.position,a.origin);i.vec3.normalize(m,m);var f=i.vec3.scale(n.sv3d.get(),m,c.computePixelSizeAt(g.position)*s.SHIFT_RESTART_OFFSET_DISTANCE);i.vec3.add(f,f,g.position);var p=c.projectPoint(f,n.sv3d.get()),b=I(c,p);r.ray.fromScreen(c,p,B),i.vec3.normalize(B.direction,B.direction);var h=n.sv3d.get();b&&r.boundedPlane.intersectRay(a,B,h)&&(e.floating=!0,f=h);var P=c.computePixelSizeAt(f);i.mat4.scale(e.transform,e.transform,i.vec3.set(n.sv3d.get(),P,P,P)),e.transform[12]=f[0],e.transform[13]=f[1],e.transform[14]=f[2],e.position=i.vec3f64.clone(f),e.visible=!0}function I(e,t){var a=e.viewport,i=a[0],s=a[1],r=a[2],n=a[3],o=Math.min(r,n)/16,c=!1;return t[0]<i+o?(t[0]=i+o,c=!0):t[0]>i+r-o&&(t[0]=i+r-o,c=!0),t[1]<s+o?(t[1]=s+o,c=!0):t[1]>s+n-o&&(t[1]=s+n-o,c=!0),c}function S(e,t,a){t.visible&&e(t.transform,a)}function R(e,t,a){var s=i.vec3.length(t.basis1),r=i.vec3.length(t.basis2),o=L(t),c=O(t);a.forEach(function(a){a.visible=!0,i.vec3.add(a.position,i.vec3.scale(n.sv3d.get(),t.basis1,a.direction[0]),i.vec3.scale(n.sv3d.get(),t.basis2,a.direction[1])),i.vec3.add(a.position,t.origin,a.position);var v=0;if(G(a))1===a.direction[0]&&-1===a.direction[1]?v=Math.PI/2:1===a.direction[0]&&1===a.direction[1]?v=Math.PI:-1===a.direction[0]&&1===a.direction[1]&&(v=3*Math.PI/2),a.scale=c;else{var l=0!==a.direction[0]?1:2,d=1===l?r:s;v=1===l?Math.PI/2:0,a.scale=d-o}i.mat4.identity(a.transform),i.mat4.rotateZ(a.transform,a.transform,v),i.mat4.scale(a.transform,a.transform,i.vec3.set(n.sv3d.get(),a.scale,a.scale,a.scale)),i.mat4.multiply(a.transform,e,a.transform),a.transform[12]=a.position[0],a.transform[13]=a.position[1],a.transform[14]=a.position[2]})}function _(e,t,a){for(var i=0;i<t.length;i++){var s=t[i],r=e[i],n=i===a;r(s.transform,n)}}function T(e,t,a,s,r,o){if(r.forceHide)return void(r.visible=!1);var c=a.worldUpAtPosition(t.origin,n.sv3d.get()),v=V(t,c),l=M(c,t),d=z(t),u=v&&2!==l?d.basis2Negative:d.basis1Negative;i.mat4.identity(r.transform),i.mat4.rotateZ(r.transform,r.transform,u.rotationIdx*Math.PI/2),v&&i.mat4.rotateX(r.transform,r.transform,Math.PI/2),i.mat4.multiply(r.transform,e,r.transform);var g=u.position,m=s.computePixelSizeAt(g);i.mat4.scale(r.transform,r.transform,i.vec3.set(n.sv3d.get(),m,m,m)),r.transform[12]=g[0],r.transform[13]=g[1],r.transform[14]=g[2],r.position=i.vec3f64.clone(g),r.visible=!0}function E(e,t,a){t.visible&&e(t.transform,a)}function A(e,t,a){if(!e.visible)return!1;for(var o=N(e.position,s.SHIFT_RESTART_TIP_RADIUS,a.camera,a.pointerType),c=i.vec3.transformMat4(n.sv3d.get(),t[0],e.transform),v=1;v<t.length;v++){var l=i.vec3.transformMat4(n.sv3d.get(),t[v],e.transform),d=r.lineSegment.closestRayDistance2(r.lineSegment.fromPoints(c,l,Z),a.ray);if(null!=d&&d<o*o)return!0;c=l}return!1}function w(e,t,a){if(!e.visible)return!1;var o=i.vec3.length(t.basis1),c=i.vec3.length(t.basis2),v=L(t),l=e.position,d=N(l,s.RESIZE_HANDLE_INPUT_RADIUS,a.camera,a.pointerType);if(G(e)){var u=n.sv3d.get(),g=n.sv3d.get();x(t,e,u,g);var m=r.lineSegment.closestRayDistance2(r.lineSegment.fromPoints(l,u,Z),a.ray),f=r.lineSegment.closestRayDistance2(r.lineSegment.fromPoints(l,g,Z),a.ray);return null!=m&&m<d*d||null!=f&&f<d*d}var p=0!==e.direction[0]?1:2,b=1===p?t.basis2:t.basis1,h=1===p?c:o,P=i.vec3.scale(n.sv3d.get(),b,1-v/h),u=i.vec3.add(n.sv3d.get(),l,P),g=i.vec3.subtract(n.sv3d.get(),l,P),y=r.lineSegment.closestRayDistance2(r.lineSegment.fromPoints(u,g,Z),a.ray);return null!=y&&y<d*d}function H(e,t,a){if(!e.visible)return!1;for(var o=N(e.position,s.ROTATE_HEADING_TIP_RADIUS,a.camera,a.pointerType),c=i.vec3.transformMat4(n.sv3d.get(),t[0],e.transform),v=1;v<t.length;v++){var l=i.vec3.transformMat4(n.sv3d.get(),t[v],e.transform),d=r.lineSegment.closestRayDistance2(r.lineSegment.fromPoints(c,l,Z),a.ray);if(null!=d&&d<o*o)return!0;c=l}return!1}function N(e,t,a,i){return t*("mouse"===i?s.MOUSE_INPUT_FOCUS_MULTIPLIER:s.TOUCH_INPUT_FOCUS_MULTIPLIER)*a.computePixelSizeAt(e)}function M(e,t){return Math.abs(i.vec3.dot(t.basis1,e))>Math.abs(i.vec3.dot(t.basis2,e))?1:2}function z(e){return{basis1Positive:{position:i.vec3.add(n.sv3d.get(),e.origin,e.basis1),rotationIdx:0},basis2Positive:{position:i.vec3.add(n.sv3d.get(),e.origin,e.basis2),rotationIdx:1},basis1Negative:{position:i.vec3.subtract(n.sv3d.get(),e.origin,e.basis1),rotationIdx:2},basis2Negative:{position:i.vec3.subtract(n.sv3d.get(),e.origin,e.basis2),rotationIdx:3}}}function D(e,t,a,s,r){var o=i.vec3.subtract(n.sv3d.get(),e,a),c=s,v=i.vec3.cross(n.sv3d.get(),c,o),l=b(o,v,a,n.sm4d.get());i.mat4.invert(l,l);var d=i.vec3.transformMat4(n.sv3d.get(),t,l),u=Math.atan2(d[1],d[0]);return i.mat4.rotate(r,i.mat4.identity(r),u,c)}function U(e,t,a){var s=a.projectPoint(i.vec3.add(n.sv3d.get(),e,t),n.sv3d.get()),r=a.projectPoint(i.vec3.subtract(n.sv3d.get(),e,t),n.sv3d.get());return i.vec3.squaredLength(i.vec3.subtract(s,s,r))}function L(e){var t=i.vec3.length(e.basis1),a=i.vec3.length(e.basis2);return s.RESIZE_HANDLE_EDGE_PADDING_FRAC*Math.min(t,a)}function O(e){return L(e)}function x(e,t,a,s){i.vec3.normalize(a,e.basis1),i.vec3.scale(a,a,-t.direction[0]*t.scale),i.vec3.add(a,a,t.position),i.vec3.normalize(s,e.basis2),i.vec3.scale(s,s,-t.direction[1]*t.scale),i.vec3.add(s,s,t.position)}function G(e){return 0!==e.direction[0]&&0!==e.direction[1]}function C(e,t,s){var r=function(r){var c=(r?t:e).slice(0),l=i.vec3.subtract(n.sv3d.get(),c[0],c[1]);i.vec3.normalize(l,l);var d=i.vec3.subtract(n.sv3d.get(),c[c.length-1],c[c.length-2]);if(i.vec3.normalize(d,d),s.padding>0){var u=i.vec3.scale(i.vec3f64.create(),d,-s.padding);if(c[c.length-1]=i.vec3.add(u,u,c[c.length-1]),s.bothEnds){var g=i.vec3.scale(i.vec3f64.create(),l,-s.padding);c[0]=i.vec3.add(g,g,c[0])}}var m=r?s.tipFocusMultiplier:1,f=s.tipLength*(s.focusTipLength?m:1),p=s.tipRadius*m,b=i.mat4.identity(n.sm4d.get());if(s.padding>0){var h=f/4,P=i.vec3.set(n.sv3d.get(),0,h,0),y=1+s.padding/h;i.mat4.translate(b,b,P),i.mat4.scale(b,b,i.vec3.set(n.sv3d.get(),y,y,y)),i.mat4.translate(b,b,i.vec3.scale(P,P,-1/y))}var I=i.mat4.identity(i.mat4f64.create()),S=i.vec3f64.fromValues(0,1,0),R=i.mat4.fromQuat(i.mat4f64.create(),i.quat.rotationTo(n.sq4d.get(),S,d));R[12]=c[c.length-1][0],R[13]=c[c.length-1][1],R[14]=c[c.length-1][2],i.mat4.multiply(R,R,b);var _,T,E=new o(k(s.tubeRadius*(r?s.tubeFocusMultiplier:1)+s.padding,s.flat,c),"arrow-tube"),A=[{part:"tube",geometry:E,transform:I}];if(a.isSome(s.flat)?_=new o(F(f,p,s.flat.thickness),"arrow-tip"):(_=new o(v.createConeGeometry(f,p,24,!1,!1,!0),"arrow-tip"),T=new o(v.createConeGeometry(f,p,24,!1,!0,!1),"arrow-cap")),A.push({part:"tip",geometry:_,transform:R}),T&&A.push({part:"cap",geometry:T,transform:R}),s.bothEnds){var w=i.mat4.fromQuat(i.mat4f64.create(),i.quat.rotationTo(n.sq4d.get(),S,l));w[12]=c[0][0],w[13]=c[0][1],w[14]=c[0][2],i.mat4.multiply(w,w,b),A.push({part:"tip",geometry:_,transform:w}),T&&A.push({part:"cap",geometry:T,transform:w})}return A};return{normal:r(!1),focused:r(!0)}}function k(e,t,i){var s=[];if(a.isSome(t))s.push([e,t.thickness/2],[-e,t.thickness/2],[-e,-t.thickness/2],[e,-t.thickness/2]);else for(var r=0;r<12;r++){var n=r/12*2*Math.PI;s.push([Math.cos(n)*e,Math.sin(n)*e])}return v.createPathExtrusionGeometry(s,i,[],[],!1)}function F(e,t,a){for(var i,s,r=new Float32Array(18),n=[[-t,0,a/2],[t,0,a/2],[0,e,a/2],[-t,0,-a/2],[t,0,-a/2],[0,e,-a/2]],o=[0,1,2,3,0,2,2,5,3,1,4,5,5,2,1,1,0,3,3,4,1,4,3,5],v=0;v<6;v++)r[3*v]=n[v][0],r[3*v+1]=n[v][1],r[3*v+2]=n[v][2];var d=(i={},i[l.VertexAttrConstants.POSITION]=new Uint32Array(o),i),u=(s={},s[l.VertexAttrConstants.POSITION]={size:3,data:r},s);return new c(u,d)}function j(e,t){var a=i.vec3.subtract(i.vec3f64.create(),e[e.length-1],e[e.length-2]);if(i.vec3.normalize(a,a),i.vec3.scale(a,a,s.ROTATE_HEADING_TIP_LENGTH),i.vec3.add(a,a,e[e.length-1]),t){var r=i.vec3.subtract(i.vec3f64.create(),e[0],e[1]);return i.vec3.normalize(r,r),i.vec3.scale(r,r,s.ROTATE_HEADING_TIP_LENGTH),i.vec3.add(r,r,e[0]),[r].concat(e,[a])}return e.concat([a])}function V(e,t){return Math.abs(i.vec3.dot(e.plane,t))<=s.PERPENDICULAR_GROUND_DOT_THRESHOLD}function q(e){switch(e.type){case"building-scene":case"csv":case"feature":case"geo-rss":case"graphics":case"group":case"integrated-mesh":case"kml":case"map-notes":case"point-cloud":case"scene":case"stream":case"unknown":case"unsupported":case null:return!1;case"base-dynamic":case"base-elevation":case"base-tile":case"bing-maps":case"elevation":case"imagery":case"map-image":case"open-street-map":case"tile":case"vector-tile":case"web-tile":case"wms":case"wmts":return!0;default:return a.neverReached(e.type),!1}}Object.defineProperty(t,"__esModule",{value:!0}),t.createPlane=d,t.normalToBases=u,t.resizePlane=g,t.calculatePlaneHalfSize=m,t.createShiftPlane=f,t.calculateBoundedPlaneTranslateRotate=p,t.hideHandles=h,t.createRotatePlane=P,t.updateShiftRestartHandle=y,t.updateShiftRestartObject=S,t.updateResizeHandles=R,t.updateResizeHandleObjects=_,t.updateRotateHeadingHandle=T,t.updateRotateHeadingObject=E,t.intersectsShiftRestartHandle=A,t.intersectsResizeHandle=w,t.intersectsRotateHeadingHandle=H,t.calculateInputRotationTransform=D,t.calculateScreenSpaceBasisLength2=U,t.calculateResizeHandlePadding=L,t.calculateDiagonalResizeHandleScale=O,t.calculateDiagonalResizeHandleEndPositions=x,t.isDiagonalResizeHandle=G,t.createArrowGeometry=C,t.addArrowTips=j,t.isAlwaysDrapedLayer=q;var Z=r.lineSegment.create(),B=r.ray.create()});