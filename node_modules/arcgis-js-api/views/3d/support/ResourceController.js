// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.10/esri/copyright.txt for details.

define(["require","exports","../../../core/Handles","../../../core/now","../../../core/scheduling","./MemoryController","./StreamDataLoader","./StreamDataSupplier","../webgl-engine/lib/Util"],function(e,t,r,i,o,n,s,a,d){function l(){var e={};for(var t in h.ClientType)e[h.ClientType[t]]=0;return e[h.ClientType.TERRAIN]=15,e[h.ClientType.SCENE]=20,e[h.ClientType.SYMBOLOGY]=5,new s(e)}var h=function(){function e(t,s,a){void 0===s&&(s=o),void 0===a&&(a=i);var d=this;this._view=t,this._budget=null,this._memoryController=null,this._streamDataLoader=l(),this._frameWorkers=[],this._nextFrameWorker=0,this._idleWorkers=[],this._nextIdleWorker=0,this._idleUpdatesStartFired=!1,this._forceFrameWorker=!1,this._lastTargetChangeTime=0,this._handles=new r,this._frameTask=null,this.idleTimeout=300,this.idleBudget=100,this._budget=new e.Budget(a),this._lastTargetChangeTime=a(),this._memoryController=new n(this._view),this._debug={memoryController:this._memoryController,idleOff:!1},this._handles.add(this._view.watch("state.camera",function(){return d.cameraChangedHandler()},!0)),this._frameTask=s.addFrameTask({update:function(e){return d.frameUpdate(e)}})}return e.prototype.destroy=function(){this._frameTask&&(this._frameTask.remove(),this._frameTask=null),this._handles.remove(),this._streamDataLoader&&(this._streamDataLoader.destroy(),this._streamDataLoader=null)},Object.defineProperty(e.prototype,"enableBudget",{set:function(e){this._budget.enabled=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"updating",{get:function(){return this._memoryController.updating},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"maxGpuMemory",{set:function(e){this._memoryController.setMaxGpuMemory(e)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"additionalCacheMemory",{set:function(e){this._memoryController.setAdditionalCacheMemory(e)},enumerable:!0,configurable:!0}),e.prototype.setMemoryDirty=function(){this._memoryController.setDirty()},Object.defineProperty(e.prototype,"memoryFactor",{get:function(){return this._memoryController.getMemoryFactor()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"usedMemory",{get:function(){return this._memoryController.getUsedMemory()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"memoryEvents",{get:function(){return this._memoryController.events},enumerable:!0,configurable:!0}),e.prototype.getMemCache=function(e,t){return this._memoryController.getMemCache(e,t)},e.prototype.getStreamDataSupplier=function(e,t){return new a(e,this._streamDataLoader,t)},e.prototype.registerIdleFrameWorker=function(e){var t=this;d.assert(!e.idleFrame||e.needsUpdate,"needsUpdate has to be specified if idleFrame is specified");var r={callbacks:e};return this.addIdleFrameWorker(r),{remove:function(){t.removeIdleFrameWorker(r)}}},e.prototype.registerFrameWorker=function(e,t){var r=this;t=t||function(){return!0};var i={callback:e,needsUpdate:t};return this.addFrameWorker(i),{remove:function(){return r.removeFrameWorker(i)}}},e.prototype.addIdleFrameWorker=function(e){this._idleWorkers.push(e),this.isIdle()&&this._idleUpdatesStartFired&&e.callbacks.idleBegin&&e.callbacks.idleBegin()},e.prototype.removeIdleFrameWorker=function(e){var t=this._idleWorkers,r=t.indexOf(e);d.assert(r>=0,"worker not registered"),this._idleUpdatesStartFired&&e.callbacks.idleEnd&&e.callbacks.idleEnd(),t.splice(r,1),this._nextIdleWorker>=t.length&&(this._nextIdleWorker=0)},e.prototype.addFrameWorker=function(e){this._frameWorkers.push(e)},e.prototype.removeFrameWorker=function(e){var t=this._frameWorkers,r=t.indexOf(e);d.assert(r>=0,"worker not registerted"),t.splice(r,1),this._nextFrameWorker>=this._frameWorkers.length&&(this._nextFrameWorker=0)},e.prototype.cameraChangedHandler=function(){this._lastTargetChangeTime=this._budget.now(),this.setMemoryDirty(),this._idleUpdatesStartFired&&(this._idleUpdatesStartFired=!1,this.callIdleFrameWorkersEnd())},e.prototype.frameUpdate=function(e){var t=e.frameDuration>1.5*e.tickTime?e.tickTime:5;t=this.isIdle()?0:t;var r=e.frameDuration-e.elapsedFrameTime-t,i=this.idleBudget-e.elapsedFrameTime;this._debug.idleOff&&(i=r);var o=Math.max(this.isIdle()?i:r,5);if(this._budget.reset(o),this._view.stateManager&&this._view.stateManager.step(e.deltaTime/1e3),o<t&&!this._forceFrameWorker)return void(this._forceFrameWorker=!0);this._forceFrameWorker=!1,this._memoryController.update();for(var n=!1,s=0;s<this._frameWorkers.length;++s){var a=(this._nextFrameWorker+s)%this._frameWorkers.length;if(n&&this._budget.remaining()<t)return void(this._nextFrameWorker=a%this._frameWorkers.length);var d=this._frameWorkers[a];this._budget.resetProgress(),d.needsUpdate(this._budget)&&(n=!0,d.callback(this._budget))}this.isIdle()&&!this._budget.done()&&(this._idleUpdatesStartFired||(this._idleUpdatesStartFired=!0,this.callIdleFrameWorkersBegin()),this.callIdleFrameWorkers())},e.prototype.isIdle=function(){return this._budget.now()-this._lastTargetChangeTime>this.idleTimeout},e.prototype.callIdleFrameWorkersBegin=function(){this._idleWorkers.forEach(function(e){e.callbacks.idleBegin&&e.callbacks.idleBegin()})},e.prototype.callIdleFrameWorkersEnd=function(){this._idleWorkers.forEach(function(e){e.callbacks.idleEnd&&e.callbacks.idleEnd()})},e.prototype.callIdleFrameWorkers=function(){for(var e=0;e<this._idleWorkers.length;++e){var t=(this._nextIdleWorker+e)%this._idleWorkers.length;if(this._budget.done())return void(this._nextIdleWorker=t);var r=this._idleWorkers[t];r.callbacks.needsUpdate&&r.callbacks.needsUpdate()&&(this._budget.resetProgress(),r.callbacks.idleFrame(this._budget))}},Object.defineProperty(e.prototype,"debug",{get:function(){return this._debug},enumerable:!0,configurable:!0}),e}();return function(e){!function(e){e.TERRAIN="terrain",e.SCENE="scene",e.SYMBOLOGY="symbology"}(e.ClientType||(e.ClientType={}));var t=function(){function e(e){this._nowFunc=e,this.enabled=!0,this.begin=0,this.budget=0,this._didWork=!1}return e.prototype.now=function(){return this._nowFunc()},e.prototype.reset=function(e){this.begin=this.now(),this.budget=this.enabled?e:Number.MAX_VALUE,this._didWork=!1},e.prototype.done=function(){return this.enabled&&this.elapsed()>=this.budget},e.prototype.doneWithProgress=function(){return this.done()&&this._didWork},e.prototype.remaining=function(){return this.enabled?Math.max(this.budget-this.elapsed(),0):Number.POSITIVE_INFINITY},e.prototype.elapsed=function(){return this.now()-this.begin},e.prototype.run=function(e){return!this.done()&&(e(),!0)},e.prototype.runWithProgress=function(e){return!this.doneWithProgress()&&(!0===e()&&(this._didWork=!0),!0)},e.prototype.resetProgress=function(){this._didWork=!1},e.prototype.madeProgress=function(){this._didWork=!0},Object.defineProperty(e.prototype,"hasProgressed",{get:function(){return this._didWork},enumerable:!0,configurable:!0}),e}();e.Budget=t}(h||(h={})),h});