// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.10/esri/copyright.txt for details.

define(["require","exports","../../../core/libs/gl-matrix-2/gl-matrix"],function(e,r,c){function t(e,r){var t=e.data,i=e.strideIdx,s=t.length/i;if(!(s<=0)){var o=new Q(e);c.vec3.add(P,o.minProj,o.maxProj),c.vec3.scale(P,P,.5),c.vec3.subtract(j,o.maxProj,o.minProj);var n=b(j),f=new R;f.quality=n,s<14&&(e={data:new Float64Array(o.buffer,112,42),size:3,offsetIdx:0,strideIdx:3});var m=c.vec3f64.create(),x=c.vec3f64.create(),I=c.vec3f64.create(),y=c.vec3f64.create(),V=c.vec3f64.create(),z=c.vec3f64.create(),N=c.vec3f64.create();switch(a(o,e,N,m,x,I,y,V,z,f,r)){case 1:return void u(P,j,r);case 2:return void h(e,y,r)}v(e,N,m,x,I,y,V,z,f,r),l(e,f.b0,f.b1,f.b2,G,L);var q=c.vec3f64.create();c.vec3.subtract(q,L,G),f.quality=b(q),f.quality<n?d(f.b0,f.b1,f.b2,G,L,q,r):u(P,j,r)}}function a(e,r,t,a,v,o,f,m,u,h,l){return i(e,a,v),c.vec3.squaredDistance(a,v)<x?1:(c.vec3.subtract(f,a,v),c.vec3.normalize(f,f),s(r,a,f,o)<x?2:(c.vec3.subtract(m,v,o),c.vec3.normalize(m,m),c.vec3.subtract(u,o,a),c.vec3.normalize(u,u),c.vec3.cross(t,m,f),c.vec3.normalize(t,t),n(r,t,f,m,u,h),0))}function v(e,r,t,a,v,i,s,f,m,u){o(e,r,t,a,v,I,y),void 0!==I[0]&&(c.vec3.subtract(V,I,t),c.vec3.normalize(V,V),c.vec3.subtract(z,I,a),c.vec3.normalize(z,z),c.vec3.subtract(N,I,v),c.vec3.normalize(N,N),c.vec3.cross(q,z,i),c.vec3.normalize(q,q),c.vec3.cross(w,N,s),c.vec3.normalize(w,w),c.vec3.cross(p,V,f),c.vec3.normalize(p,p),n(e,q,i,z,V,m),n(e,w,s,N,z,m),n(e,p,f,V,N,m)),void 0!==y[0]&&(c.vec3.subtract(V,y,t),c.vec3.normalize(V,V),c.vec3.subtract(z,y,a),c.vec3.normalize(z,z),c.vec3.subtract(N,y,v),c.vec3.normalize(N,N),c.vec3.cross(q,z,i),c.vec3.normalize(q,q),c.vec3.cross(w,N,s),c.vec3.normalize(w,w),c.vec3.cross(p,V,f),c.vec3.normalize(p,p),n(e,q,i,z,V,m),n(e,w,s,N,z,m),n(e,p,f,V,N,m))}function i(e,r,t){for(var a=c.vec3.squaredDistance(e.maxVert[0],e.minVert[0]),v=0,i=1;i<7;++i){var s=c.vec3.squaredDistance(e.maxVert[i],e.minVert[i]);s>a&&(a=s,v=i)}c.vec3.copy(r,e.minVert[v]),c.vec3.copy(t,e.maxVert[v])}function s(e,r,t,a){for(var v=e.data,i=e.offsetIdx,s=e.strideIdx,o=Number.NEGATIVE_INFINITY,n=0,f=i;f<v.length;f+=s){c.vec3.set(A,v[f]-r[0],v[f+1]-r[1],v[f+2]-r[2]);var m=t[0]*A[0]+t[1]*A[1]+t[2]*A[2],u=t[0]*t[0]+t[1]*t[1]+t[2]*t[2],h=A[0]*A[0]+A[1]*A[1]+A[2]*A[2],l=h-m*m/u;l>o&&(o=l,n=f)}return c.vec3.set(a,v[n],v[n+1],v[n+2]),o}function o(e,r,t,a,v,i,s){m(e,r,M,s,i);var o=c.vec3.dot(t,r);M[1]-x<=o&&(i[0]=void 0),M[0]+x>=o&&(s[0]=void 0)}function n(e,r,t,a,v,i){if(!(c.vec3.squaredLength(r)<x)){c.vec3.cross(T,t,r),c.vec3.cross(g,a,r),c.vec3.cross(E,v,r),f(e,r,M),_[1]=M[0],F[1]=M[1],Y[1]=F[1]-_[1];for(var s=[t,a,v],o=[T,g,E],n=0;n<3;++n){f(e,s[n],M),_[0]=M[0],F[0]=M[1],f(e,o[n],M),_[2]=M[0],F[2]=M[1],Y[0]=F[0]-_[0],Y[2]=F[2]-_[2];var m=b(Y);m<i.quality&&(c.vec3.copy(i.b0,s[n]),c.vec3.copy(i.b1,r),c.vec3.copy(i.b2,o[n]),i.quality=m)}}}function f(e,r,c){var t=e.data,a=e.offsetIdx,v=e.strideIdx;c[0]=Number.POSITIVE_INFINITY,c[1]=Number.NEGATIVE_INFINITY;for(var i=a;i<t.length;i+=v){var s=t[i]*r[0]+t[i+1]*r[1]+t[i+2]*r[2];c[0]=Math.min(c[0],s),c[1]=Math.max(c[1],s)}}function m(e,r,t,a,v){var i=e.data,s=e.offsetIdx,o=e.strideIdx;c.vec3.set(a,i[s],i[s+1],i[s+2]),c.vec3.copy(v,a),t[0]=c.vec3.dot(O,r),t[1]=t[0];for(var n=s+o;n<i.length;n+=o){var f=i[n]*r[0]+i[n+1]*r[1]+i[n+2]*r[2];f<t[0]&&(t[0]=f,c.vec3.set(a,i[n],i[n+1],i[n+2])),f>t[1]&&(t[1]=f,c.vec3.set(v,i[n],i[n+1],i[n+2]))}}function u(e,r,t){c.vec3.copy(t.center,e),c.vec3.scale(t.halfSize,r,.5),c.quat.identity(t.quaternion)}function h(e,r,t){c.vec3.copy(S,r),Math.abs(r[0])>Math.abs(r[1])&&Math.abs(r[0])>Math.abs(r[2])?S[0]=0:Math.abs(r[1])>Math.abs(r[2])?S[1]=0:S[2]=0,c.vec3.squaredLength(S)<x&&(S[0]=S[1]=S[2]=1),c.vec3.cross(B,r,S),c.vec3.normalize(B,B),c.vec3.cross(D,r,B),c.vec3.normalize(D,D),l(e,r,B,D,G,L),c.vec3.subtract(k,L,G),d(r,B,D,G,L,k,t)}function l(e,r,c,t,a,v){f(e,r,M),a[0]=M[0],v[0]=M[1],f(e,c,M),a[1]=M[0],v[1]=M[1],f(e,t,M),a[2]=M[0],v[2]=M[1]}function d(e,r,t,a,v,i,s){H[0]=e[0],H[1]=e[1],H[2]=e[2],H[3]=r[0],H[4]=r[1],H[5]=r[2],H[6]=t[0],H[7]=t[1],H[8]=t[2],c.quat.fromMat3(s.quaternion,H),c.vec3.add(J,a,v),c.vec3.scale(J,J,.5),c.vec3.scale(s.center,e,J[0]),c.vec3.scale(C,r,J[1]),c.vec3.add(s.center,s.center,C),c.vec3.scale(C,t,J[2]),c.vec3.add(s.center,s.center,C),c.vec3.scale(s.halfSize,i,.5)}function b(e){return e[0]*e[1]+e[0]*e[2]+e[1]*e[2]}Object.defineProperty(r,"__esModule",{value:!0});var x=1e-6,P=c.vec3f64.create(),j=c.vec3f64.create();r.computeOBB=t;var I=c.vec3f64.create(),y=c.vec3f64.create(),V=c.vec3f64.create(),z=c.vec3f64.create(),N=c.vec3f64.create(),q=c.vec3f64.create(),w=c.vec3f64.create(),p=c.vec3f64.create(),A=c.vec3f64.create(),M=c.vec2f64.create(),T=c.vec3f64.create(),g=c.vec3f64.create(),E=c.vec3f64.create(),F=c.vec3f64.create(),_=c.vec3f64.create(),Y=c.vec3f64.create(),O=c.vec3f64.create(),S=c.vec3f64.create(),B=c.vec3f64.create(),D=c.vec3f64.create(),G=c.vec3f64.create(),L=c.vec3f64.create(),k=c.vec3f64.create(),C=c.vec3f64.create(),H=c.mat3f32.create(),J=c.vec3f64.create(),K=7,Q=function(){function e(e){this.minVert=new Array(K),this.maxVert=new Array(K);var r=64*K;this.buffer=new ArrayBuffer(r);var t=0;this.minProj=new Float64Array(this.buffer,t,K),t+=8*K,this.maxProj=new Float64Array(this.buffer,t,K),t+=8*K;for(var a=0;a<K;++a)this.minVert[a]=c.vec3f64.createView(this.buffer,t),t+=24;for(var a=0;a<K;++a)this.maxVert[a]=c.vec3f64.createView(this.buffer,t),t+=24;for(var a=0;a<K;++a)this.minProj[a]=Number.POSITIVE_INFINITY,this.maxProj[a]=Number.NEGATIVE_INFINITY;for(var v=new Array(K),i=new Array(K),s=e.data,o=e.offsetIdx,n=e.strideIdx,a=o;a<s.length;a+=n){var f=s[a];f<this.minProj[0]&&(this.minProj[0]=f,v[0]=a),f>this.maxProj[0]&&(this.maxProj[0]=f,i[0]=a),f=s[a+1],f<this.minProj[1]&&(this.minProj[1]=f,v[1]=a),f>this.maxProj[1]&&(this.maxProj[1]=f,i[1]=a),f=s[a+2],f<this.minProj[2]&&(this.minProj[2]=f,v[2]=a),f>this.maxProj[2]&&(this.maxProj[2]=f,i[2]=a),f=s[a]+s[a+1]+s[a+2],f<this.minProj[3]&&(this.minProj[3]=f,v[3]=a),f>this.maxProj[3]&&(this.maxProj[3]=f,i[3]=a),f=s[a]+s[a+1]-s[a+2],f<this.minProj[4]&&(this.minProj[4]=f,v[4]=a),f>this.maxProj[4]&&(this.maxProj[4]=f,i[4]=a),f=s[a]-s[a+1]+s[a+2],f<this.minProj[5]&&(this.minProj[5]=f,v[5]=a),f>this.maxProj[5]&&(this.maxProj[5]=f,i[5]=a),f=s[a]-s[a+1]-s[a+2],f<this.minProj[6]&&(this.minProj[6]=f,v[6]=a),f>this.maxProj[6]&&(this.maxProj[6]=f,i[6]=a)}for(var a=0;a<K;++a){var m=v[a];c.vec3.set(this.minVert[a],s[m],s[m+1],s[m+2]),m=i[a],c.vec3.set(this.maxVert[a],s[m],s[m+1],s[m+2])}}return e}(),R=function(){function e(){this.b0=c.vec3f64.fromValues(1,0,0),this.b1=c.vec3f64.fromValues(0,1,0),this.b2=c.vec3f64.fromValues(0,0,1),this.quality=0}return e}()});