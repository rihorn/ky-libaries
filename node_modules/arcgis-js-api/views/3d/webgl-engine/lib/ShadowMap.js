// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.10/esri/copyright.txt for details.

define(["require","exports","../../../../core/libs/gl-matrix-2/gl-matrix","../../support/mathUtils","./Camera","./DefaultVertexAttributeLocations","./DefaultVertexBufferLayouts","./glUtil3D","./Util","../shaders/MiscPrograms","../../../webgl/BufferObject","../../../webgl/FramebufferObject","../../../webgl/Texture","../../../webgl/Util","../../../webgl/VertexArrayObject"],function(e,t,a,r,s,c,i,o,n,h,v,f,d,u,p){function l(e,t,r,s,c,i,o,h){a.vec2.set(I,0,0);for(var v=0;v<4;++v)a.vec2.add(I,I,e[v]);a.vec2.scale(I,I,.25),a.vec2.set(L,0,0);for(var v=4;v<8;++v)a.vec2.add(L,L,e[v]);a.vec2.scale(L,L,.25),a.vec2.lerp(W[0],e[4],e[5],.5),a.vec2.lerp(W[1],e[5],e[6],.5),a.vec2.lerp(W[2],e[6],e[7],.5),a.vec2.lerp(W[3],e[7],e[4],.5);for(var f=0,d=a.vec2.squaredDistance(W[0],I),v=1;v<4;++v){var u=a.vec2.squaredDistance(W[v],I);u<d&&(d=u,f=v)}a.vec2.subtract(q,W[f],e[f+4]);var p=q[0];q[0]=-q[1],q[1]=p,a.vec2.subtract(G,L,I),a.vec2.lerp(q,q,G,r),a.vec2.normalize(q,q);var l,m;l=m=a.vec2.dot(a.vec2.subtract(Q,e[0],I),q);for(var v=1;v<8;++v){var x=a.vec2.dot(a.vec2.subtract(Q,e[v],I),q);x<l?l=x:x>m&&(m=x)}a.vec2.copy(s,I),a.vec2.scale(Q,q,l-t),a.vec2.add(s,s,Q);for(var b=-1,y=1,g=0,M=0,v=0;v<8;++v){a.vec2.subtract(k,e[v],s),a.vec2.normalize(k,k);var T=q[0]*k[1]-q[1]*k[0];T>0?T>b&&(b=T,g=v):T<y&&(y=T,M=v)}n.verify(b>0,"leftArea"),n.verify(y<0,"rightArea"),a.vec2.scale(z,q,l),a.vec2.add(z,z,I),a.vec2.scale(H,q,m),a.vec2.add(H,H,I),X[0]=-q[1],X[1]=q[0];var w=n.rayRay2D(s,e[M],H,a.vec2.add(Q,H,X),1,c),D=n.rayRay2D(s,e[g],H,Q,1,i),R=n.rayRay2D(s,e[g],z,a.vec2.add(Q,z,X),1,o),C=n.rayRay2D(s,e[M],z,Q,1,h);n.verify(w,"rayRay"),n.verify(D,"rayRay"),n.verify(R,"rayRay"),n.verify(C,"rayRay")}function m(e,t){return 3*t+e}function x(e,t){return a.vec2.set(Y,e[t],e[t+3]),Y}function b(e,t,r,s,c){a.vec2.subtract(J,r,s),a.vec2.scale(J,J,.5),K[0]=J[0],K[1]=J[1],K[2]=0,K[3]=J[1],K[4]=-J[0],K[5]=0,K[6]=J[0]*J[0]+J[1]*J[1],K[7]=J[0]*J[1]-J[1]*J[0],K[8]=1,K[m(0,2)]=-a.vec2.dot(x(K,0),e),K[m(1,2)]=-a.vec2.dot(x(K,1),e);var i=a.vec2.dot(x(K,0),r)+K[m(0,2)],o=a.vec2.dot(x(K,1),r)+K[m(1,2)],n=a.vec2.dot(x(K,0),s)+K[m(0,2)],h=a.vec2.dot(x(K,1),s)+K[m(1,2)];i=-(i+n)/(o+h),K[m(0,0)]+=K[m(1,0)]*i,K[m(0,1)]+=K[m(1,1)]*i,K[m(0,2)]+=K[m(1,2)]*i,i=1/(a.vec2.dot(x(K,0),r)+K[m(0,2)]),o=1/(a.vec2.dot(x(K,1),r)+K[m(1,2)]),K[m(0,0)]*=i,K[m(0,1)]*=i,K[m(0,2)]*=i,K[m(1,0)]*=o,K[m(1,1)]*=o,K[m(1,2)]*=o,K[m(2,0)]=K[m(1,0)],K[m(2,1)]=K[m(1,1)],K[m(2,2)]=K[m(1,2)],K[m(1,2)]+=1,i=a.vec2.dot(x(K,1),t)+K[m(1,2)],o=a.vec2.dot(x(K,2),t)+K[m(2,2)],n=a.vec2.dot(x(K,1),r)+K[m(1,2)],h=a.vec2.dot(x(K,2),r)+K[m(2,2)],i=-.5*(i/o+n/h),K[m(1,0)]+=K[m(2,0)]*i,K[m(1,1)]+=K[m(2,1)]*i,K[m(1,2)]+=K[m(2,2)]*i,i=a.vec2.dot(x(K,1),t)+K[m(1,2)],o=a.vec2.dot(x(K,2),t)+K[m(2,2)],n=-o/i,K[m(1,0)]*=n,K[m(1,1)]*=n,K[m(1,2)]*=n,c[0]=K[0],c[1]=K[1],c[2]=0,c[3]=K[2],c[4]=K[3],c[5]=K[4],c[6]=0,c[7]=K[5],c[8]=0,c[9]=0,c[10]=1,c[11]=0,c[12]=K[6],c[13]=K[7],c[14]=0,c[15]=K[8]}for(var y=function(){function e(){this.camera=new s,this.lightMat=a.mat4f64.create()}return e}(),g=function(){function e(e,t){this.doShadowMapMipmapsWork=!1,this.textureRes=4096,this.numCascades=1,this.maxNumCascades=2,this.cascadeDistances=[0,0,0,0,0],this.cascades=[],this.programRep=e,this.rctx=t,this.emptyTexture=o.createEmptyTexture(t);for(var a=0;a<4;++a)this.cascades.push(new y)}return e.prototype.dispose=function(){this.emptyTexture.dispose(),this.emptyTexture=null},Object.defineProperty(e.prototype,"textureResolution",{get:function(){return this.textureRes},set:function(e){this.textureRes=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"maxCascades",{get:function(){return this.maxNumCascades},set:function(e){this.maxNumCascades=r.clamp(Math.floor(e),1,4)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"enabled",{get:function(){return!!this.depthTexture},set:function(e){e?this.enable():this.disable()},enumerable:!0,configurable:!0}),e.prototype.getDepthTexture=function(){return this.depthTexture},e.prototype.getCascades=function(){for(var e=0;e<this.numCascades;++e)_[e]=this.cascades[e];return _.length=this.numCascades,_},e.prototype.prepare=function(e,t,s,c){n.assert(this.enabled),a.mat4.multiply(T,e.projectionMatrix,e.viewMatrix);var i=c.near,o=c.far;i<2&&(i=2),o<2&&(o=2),i>=o&&(i=2,o=4),this.numCascades=Math.min(1+Math.floor(n.logWithBase(o/i,4)),this.maxNumCascades);for(var h=Math.pow(o/i,1/this.numCascades),v=0;v<this.numCascades+1;++v)this.cascadeDistances[v]=i*Math.pow(h,v);a.mat4.invert(w,T),a.mat4.lookAt(F,[0,0,0],[-t[0],-t[1],-t[2]],[0,1,0]);for(var f=e.viewMatrix,d=e.projectionMatrix,v=0;v<this.numCascades;++v){var u=this.cascades[v],p=-this.cascadeDistances[v],m=-this.cascadeDistances[v+1],x=(d[10]*p+d[14])/Math.abs(d[11]*p+d[15]),y=(d[10]*m+d[14])/Math.abs(d[11]*m+d[15]);n.assert(x<y);for(var g=0;g<8;++g){var C=g%4==0||g%4==3?-1:1,_=g%4==0||g%4==1?-1:1,N=g<4?x:y;a.vec4.set(D,C,_,N,1),a.vec4.transformMat4(R[g],D,w);for(var S=0;S<3;++S)R[g][S]/=R[g][3]}a.vec3.negate(V,R[0]),a.mat4.translate(M,F,V),u.camera.viewMatrix=M;for(var g=0;g<8;++g)a.vec3.transformMat4(R[g],R[g],u.camera.viewMatrix);a.vec3.copy(A,R[0]),a.vec3.copy(O,R[0]);for(var g=1;g<8;++g)for(var S=0;S<3;++S)A[S]=Math.min(A[S],R[g][S]),O[S]=Math.max(O[S],R[g][S]);A[2]-=200,O[2]+=200,u.camera.near=-O[2],u.camera.far=-A[2];i=1/R[0][3],o=1/R[4][3],n.assert(i<o);var I=i+Math.sqrt(i*o),L=Math.sin(r.acos(f[2]*t[0]+f[6]*t[1]+f[10]*t[2]));I/=L,l(R,I,L,U,E,j,P,B),b(U,E,P,B,u.camera.projectionMatrix),u.camera.projectionMatrix[10]=2/(A[2]-O[2]),u.camera.projectionMatrix[14]=-(A[2]+O[2])/(A[2]-O[2]),a.mat4.multiply(u.lightMat,u.camera.projectionMatrix,u.camera.viewMatrix);var W=this.textureRes/2;u.camera.viewport[0]=v%2==0?0:W,u.camera.viewport[1]=0===Math.floor(v/2)?0:W,u.camera.viewport[2]=W,u.camera.viewport[3]=W}this.lastOrigin=null,this.cascadeDistances[this.numCascades]=100*o;var q=this.rctx,G=q.gl;q.bindFramebuffer(this.fbo),q.bindTexture(null,7),q.setClearColor(1,1,1,1),q.clear(G.COLOR_BUFFER_BIT|G.DEPTH_BUFFER_BIT),q.setBlendingEnabled(!1)},e.prototype.finish=function(e){n.assert(this.enabled),this.rctx.bindFramebuffer(e),this.doShadowMapMipmapsWork&&this.depthTexture.generateMipmap()},e.prototype.bind=function(e){var t=this.rctx,a=this.enabled;t.bindTexture(a?this.depthTexture:this.emptyTexture,7),t.bindProgram(e),e.setUniform1i("depthTex",7),e.setUniform1f("depthHalfPixelSz",a?.5/this.textureRes:-1),e.setUniform1i("shadowMapNum",this.numCascades),e.setUniform4f("shadowMapDistance",this.cascadeDistances[0],this.cascadeDistances[1],this.cascadeDistances[2],this.cascadeDistances[3])},e.prototype.bindAll=function(e){for(var t=e.getProgramsUsingUniform("shadowMapDistance"),a=0;a<t.length;a++)this.bind(t[a])},e.prototype.bindView=function(e,t){if(this.enabled){var r=this.lastOrigin;if(!(r&&r[0]===t[0]&&r[1]===t[1]&&r[2]===t[2])){this.lastOrigin=this.lastOrigin||a.vec3f64.create(),a.vec3.copy(this.lastOrigin,t);for(var s=0;s<this.numCascades;++s){a.mat4.translate(N,this.cascades[s].lightMat,t);for(var c=0;c<16;++c)S[16*s+c]=N[c]}}e.setUniformMatrix4fv("shadowMapMatrix",S)}},e.prototype.drawDebugQuad=function(e){n.assert(this.enabled);var t=this.rctx,a=t.gl;if(!this.debugQuadVAO){var r=new Float32Array([0,0,0,0,256,0,1,0,0,256,0,1,256,256,1,1]);this.debugQuadVAO=new p(t,c.Default3D,{geometry:i.Pos2Tex},{geometry:v.createVertex(t,a.STATIC_DRAW,r)})}var s=this.programRep.getProgram(h.showDepth),o=this.debugQuadVAO;t.setDepthTestEnabled(!1),t.bindProgram(s),s.setUniformMatrix4fv("proj",e),s.setUniform1i("depthTex",0),t.bindTexture(this.depthTexture,0),t.bindVAO(o),u.assertCompatibleVertexAttributeLocations(o,s),t.drawArrays(a.TRIANGLE_STRIP,0,u.vertexCount(o,"geometry")),t.setDepthTestEnabled(!0)},e.prototype.enable=function(){if(!this.enabled){var e=this.rctx.gl,t={target:e.TEXTURE_2D,pixelFormat:e.RGBA,dataType:e.UNSIGNED_BYTE,wrapMode:e.CLAMP_TO_EDGE,samplingMode:e.NEAREST,flipped:!0,width:this.textureRes,height:this.textureRes};this.depthTexture=new d(this.rctx,t),this.fbo=f.createWithAttachments(this.rctx,this.depthTexture,{colorTarget:0,depthStencilTarget:1,width:this.textureRes,height:this.textureRes})}},e.prototype.disable=function(){this.enabled&&this.fbo&&(this.fbo.dispose(),this.fbo=null,this.depthTexture=null)},e}(),M=a.mat4f64.create(),T=a.mat4f64.create(),w=a.mat4f64.create(),D=a.vec4f64.create(),R=[],C=0;C<8;++C)R.push(a.vec4f64.create());var A=a.vec3f64.create(),O=a.vec3f64.create(),U=a.vec2f64.create(),E=a.vec2f64.create(),j=a.vec2f64.create(),P=a.vec2f64.create(),B=a.vec2f64.create(),F=a.mat4f64.create(),V=a.vec3f64.create(),_=[],N=a.mat4f64.create(),S=new Float32Array(64),I=a.vec2f64.create(),L=a.vec2f64.create(),W=[a.vec2f64.create(),a.vec2f64.create(),a.vec2f64.create(),a.vec2f64.create()],q=a.vec2f64.create(),G=a.vec2f64.create(),Q=a.vec2f64.create(),k=a.vec2f64.create(),z=a.vec2f64.create(),H=a.vec2f64.create(),X=a.vec2f64.create(),Y=a.vec2f64.create(),J=a.vec2f64.create(),K=a.mat3f64.create();return g});