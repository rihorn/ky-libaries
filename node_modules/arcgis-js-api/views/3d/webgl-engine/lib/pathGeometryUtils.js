// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.10/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/assignHelper","../../../../core/tsSupport/extendsHelper","../../../../core/libs/gl-matrix-2/gl-matrix","../../support/geometryUtils","../../support/mathUtils","./GeometryData","./GeometryUtil","./Util"],function(t,e,i,r,s,a,n,o,h,c){function u(t,e,i){return t[0]=Math.min(Math.max(t[0],e[0]),i[0]),t[1]=Math.min(Math.max(t[1],e[1]),i[1]),t[2]=Math.min(Math.max(t[2],e[2]),i[2]),t}var v;!function(t){var e=function(){function t(t){this.pos=t,this.mapPos=s.vec3f32.create(),this.vRight=s.vec3f32.create(),this.vLeft=s.vec3f32.create(),this.frame={forward:s.vec3f32.create(),up:s.vec3f32.create(),right:s.vec3f32.create()},this.rotationAxis=s.vec3f32.create(),this.angle=0}return t.prototype.profileSpaceToVertexSpace=function(t,e){t[0]=e[0]*this.frame.right[0]+e[1]*this.frame.up[0],t[1]=e[0]*this.frame.right[1]+e[1]*this.frame.up[1],t[2]=e[0]*this.frame.right[2]+e[1]*this.frame.up[2]},t}();t.PathVertex=e;var v=function(){function t(){this.vertices=[],this.vertexIndices=[],this.normals=null,this.normalIndices=null,this.uvs=null,this.uvIndices=null}return t.prototype.addVertex=function(t){return this.vertices.push(s.vec2f32.clone(t)),this.vertices.length-1},t.prototype.addNormal=function(t){return this.normals||(this.normals=[],this.normalIndices=[]),this.normals.push(s.vec2f32.clone(t)),this.normals.length-1},t.prototype.addUV=function(t){return this.uvs||(this.uvs=[],this.uvIndices=[]),this.uvs.push(t),this.uvs.length-1},t.prototype.addSegment=function(t,e,i,r,s,a){void 0===i&&(i=null),void 0===r&&(r=null),void 0===s&&(s=null),void 0===a&&(a=null),this.vertexIndices.push(t),this.vertexIndices.push(e),null!==i&&null!==r&&(this.normalIndices.push(i),this.normalIndices.push(r)),null!==s&&null!==a&&(this.uvIndices.push(s),this.uvIndices.push(a))},Object.defineProperty(t.prototype,"numSegments",{get:function(){return this.vertexIndices.length/2},enumerable:!0,configurable:!0}),t.prototype.hasNormals=function(){return null!=this.normals},t.prototype.hasUV=function(){return null!=this.uvs},t.prototype.normalize=function(){for(var t=0,e=0,i=this.vertices;e<i.length;e++){var r=i[e];t=Math.max(t,s.vec2.length(r))}for(var a=1/t,n=0,o=this.vertices;n<o.length;n++){var r=o[n];s.vec2.scale(r,r,a)}},t.tube=function(e){void 0===e&&(e=20);for(var i=new t,r=0;r<e;++r){var a=2*r*Math.PI/e;i.addVertex(s.vec2f32.fromValues(1*Math.cos(a),1*Math.sin(a))),i.addUV(r/e)}i.addUV(1);for(var r=0;r<e-1;++r)i.addSegment(r,r+1,null,null,r,r+1);return i.addSegment(e-1,0,null,null,e-1,e),i},t.line=function(e,i){var r=new t,a=i[0]-e[0],n=i[1]-e[1];return r.addVertex(e),r.addVertex(i),r.addNormal(s.vec2f32.fromValues(-n,a)),r.addUV(0),r.addUV(1),r.addSegment(0,1,0,0,0,1),r},t.point=function(e){var i=new t;return i.addVertex(e),i},t.wall=function(e,i){void 0===e&&(e=.2),void 0===i&&(i=1);var r=new t;return r.addVertex(s.vec2f32.fromValues(.5*-e,0)),r.addVertex(s.vec2f32.fromValues(.5*e,0)),r.addVertex(s.vec2f32.fromValues(.5*e,i)),r.addVertex(s.vec2f32.fromValues(.5*-e,i)),r.addNormal(s.vec2f32.fromValues(0,-1)),r.addNormal(s.vec2f32.fromValues(1,0)),r.addNormal(s.vec2f32.fromValues(0,1)),r.addNormal(s.vec2f32.fromValues(-1,0)),r.addUV(0),r.addUV(1),r.addSegment(0,1,0,0,0,1),r.addSegment(1,2,1,1,0,1),r.addSegment(2,3,2,2,0,1),r.addSegment(3,0,3,3,0,1),r},t.strip=function(){return this.line(s.vec2f32.fromValues(-1,0),s.vec2f32.fromValues(1,0))},t.fence=function(){return this.line(s.vec2f32.fromValues(0,0),s.vec2f32.fromValues(0,1))},t}();t.Profile=v;var I=function(){function t(t,i,r,o,c,u){this.vertices=[],this.offset=s.vec3f32.create(),s.vec3.copy(this.offset,u);for(var v=r;v<r+o;++v){var l=new e(s.vec3f32.fromValues(t[3*v+0],t[3*v+1],t[3*v+2]));s.vec3.set(l.mapPos,i[3*v+0],i[3*v+1],i[3*v+2]),this.vertices.push(l)}var f,m,p=s.vec3f32.create(),x=s.vec3f32.create(),_=s.vec3f32.create(),V=s.vec3f32.create(),g=s.vec3f32.create(),I=s.vec3f64.create(),y=s.vec3f32.create(),D=s.vec3f32.create(),N=s.vec3f32.create(),A=s.vec3f32.create(),C=a.plane.create(),S=this.vertices[0];s.vec3.set(y,0,1,0),s.vec3.subtract(x,this.vertices[1].pos,S.pos),f=0,m=s.vec3.length(x),s.vec3.normalize(x,x),c?(s.vec3.add(I,S.pos,this.offset),s.vec3.normalize(_,I)):s.vec3.set(_,0,0,1),h.makeOrthoBasisDirUpFallback(x,_,y,y,g,_,.99619469809),s.vec3.copy(V,_),s.vec3.copy(A,g),s.vec3.copy(S.vRight,x),s.vec3.copy(S.vLeft,p),s.vec3.copy(S.frame.forward,x),s.vec3.copy(S.frame.up,_),s.vec3.copy(S.frame.right,g),S.vLeftLength=f,S.vRightLength=m,S.index=0,s.vec3.cross(S.rotationAxis,S.vLeft,S.vRight),s.vec3.normalize(S.rotationAxis,S.rotationAxis),S.angle=0;for(var U=1;U<o;++U){S=this.vertices[U],s.vec3.copy(p,x),f=m,U<o-1&&(s.vec3.subtract(x,this.vertices[U+1].pos,S.pos),m=s.vec3.length(x),s.vec3.normalize(x,x)),s.vec3.add(D,p,x),s.vec3.normalize(D,D),s.vec3.add(N,this.vertices[U-1].pos,V),a.plane.fromPositionAndNormal(this.vertices[U].pos,D,C);a.plane.intersectRay(C,a.ray.wrap(N,p),I)?(s.vec3.subtract(I,I,this.vertices[U].pos),s.vec3.normalize(_,I),s.vec3.cross(g,D,_),s.vec3.normalize(g,g)):h.makeOrthoBasisDirUpFallback(D,V,A,y,g,_,.99619469809),s.vec3.copy(V,_),s.vec3.copy(A,g),s.vec3.copy(S.vRight,x),s.vec3.copy(S.vLeft,p),s.vec3.copy(S.frame.forward,D),s.vec3.copy(S.frame.up,_),s.vec3.copy(S.frame.right,g),S.vLeftLength=f,S.vRightLength=m,S.index=U,s.vec3.cross(S.rotationAxis,S.vLeft,S.vRight),s.vec3.normalize(S.rotationAxis,S.rotationAxis),s.vec3.negate(d,S.vLeft),S.angle=Math.PI-n.acos(s.vec3.dot(d,S.vRight))}}return t}();t.Path=I;var y=function(){function t(){}return t}();t.Extruder=y;var D=function(){function t(){}return t.prototype.numVertices=function(t){return t.vertices.length},t.prototype.extrude=function(t,e,i){for(var r=0;r<e.vertices.length;++r){var s=e.vertices[r];s.profileSpaceToVertexSpace(m,t),i(s.pos,m,r)}},t}();t.SimpleExtruder=D;var N=function(){function t(t){void 0===t&&(t=1),this._segmentsPerRadian=t/Math.PI}return t.prototype.getNumSegments=function(t){return Math.ceil(t*this._segmentsPerRadian)},t.prototype.numVertices=function(t){for(var e=2,i=1;i<t.vertices.length-1;++i)e+=this.getNumSegments(t.vertices[i].angle)+1;return e},t.prototype.extrude=function(t,e,i){e.vertices[0].profileSpaceToVertexSpace(m,t),i(e.vertices[0].pos,m,0),s.vec3.copy(x,m);for(var r=1;r<e.vertices.length-1;++r){var a=e.vertices[r];a.profileSpaceToVertexSpace(m,t);var n=this.getNumSegments(a.angle);if(s.mat4.identity(g),s.mat4.rotate(g,g,.5*-a.angle,a.rotationAxis),s.vec3.transformMat4(_,m,g),s.vec3.dot(_,a.vRight)>=0){for(var o=0;o<n+1;++o)i(a.pos,m,r);s.vec3.copy(x,m)}else{s.mat4.identity(g),s.mat4.rotate(g,g,a.angle/n,a.rotationAxis),i(a.pos,_,r),s.vec3.copy(V,_);for(var o=0;o<n;++o)s.vec3.transformMat4(V,V,g),i(a.pos,V,r);s.vec3.copy(x,V)}}var h=e.vertices.length-1;e.vertices[h].profileSpaceToVertexSpace(m,t),i(e.vertices[h].pos,m,h)},t}();t.RoundExtruder=N;var A=function(t){function e(){return t.call(this,1)||this}return r(e,t),e}(N);t.BevelExtruder=A;var C=function(){function t(t,e,i){this.vvData=null,this._extrusionVertexCount=0,this._extrusionNormalCount=0,this._numExtrusionVertices=0,this.numVerticesTotal=0,this.numNormalsTotal=0,this.numUVTotal=0,this._capNormalsOffset=0,this._profile=e,this._profile.normalize(),this.path=t,this._extruder=i,this._numExtrusionVertices=i.numVertices(t),this.numVerticesTotal=e.vertices.length*this._numExtrusionVertices,this._profile.hasNormals()?this.numNormalsTotal=this._profile.normals.length*this._numExtrusionVertices:this.numNormalsTotal=this.numVerticesTotal,this.numNormalsTotal+=2,this.originData=new Float32Array(3*this.numVerticesTotal),this.directionData=new Float32Array(4*this.numVerticesTotal),this.normalData=new Float32Array(3*this.numNormalsTotal),this.pathVertexData=new Float32Array(1*this.numVerticesTotal),this._profile.hasUV()&&(this.numUVTotal=this._profile.uvs.length,this.uvData=new Float32Array(2*this.numUVTotal)),this.buildGeometry(),this.buildTopology()}return t.prototype.setVisualVariableValue=function(t){this.vvData||(this.vvData=new Float32Array(4*this.path.vertices.length));for(var e=0;e<this.path.vertices.length;++e)this.vvData[4*e+0]=t[0],this.vvData[4*e+1]=t[1]},t.queryVertexPosition=function(t,e){s.vec3.copy(t,e.direction),e.vvSizeEnabled?(s.vec3.copy(p,e.vvSizeFactor),s.vec3.scale(p,p,e.auxpos2X),s.vec3.add(p,p,e.vvSizeOffset),u(p,e.vvSizeMinSize,e.vvSizeMaxSize),s.vec3.multiply(t,t,p)):s.vec3.scale(t,t,e.size),s.vec3.add(t,t,e.origin)},t.prototype.emitVertex=function(t,e,i){this.originData[3*this._extrusionVertexCount+0]=t[0],this.originData[3*this._extrusionVertexCount+1]=t[1],this.originData[3*this._extrusionVertexCount+2]=t[2],this.directionData[4*this._extrusionVertexCount+0]=e[0],this.directionData[4*this._extrusionVertexCount+1]=e[1],this.directionData[4*this._extrusionVertexCount+2]=e[2],this.directionData[4*this._extrusionVertexCount+3]=i/(this.path.vertices.length-1),this.pathVertexData[this._extrusionVertexCount]=i,++this._extrusionVertexCount},t.prototype.emitNormal=function(t,e,i){s.vec3.normalize(p,e),this.normalData[3*this._extrusionNormalCount+0]=p[0],this.normalData[3*this._extrusionNormalCount+1]=p[1],this.normalData[3*this._extrusionNormalCount+2]=p[2],++this._extrusionNormalCount},t.prototype.buildGeometry=function(){var t=this.emitVertex.bind(this),e=this.emitNormal.bind(this);this._extrusionVertexCount=0,this._extrusionNormalCount=0;for(var i=0;i<this._profile.vertices.length;++i)this._extruder.extrude(this._profile.vertices[i],this.path,t);if(this._profile.hasNormals())for(var r=0;r<this._profile.normals.length;++r)this._extruder.extrude(this._profile.normals[r],this.path,e);else for(var r=0;r<this._extrusionVertexCount;++r)s.vec3.set(p,this.directionData[4*r+0],this.directionData[4*r+1],this.directionData[4*r+2]),s.vec3.normalize(p,p),this.normalData[3*this._extrusionNormalCount+0]=p[0],this.normalData[3*this._extrusionNormalCount+1]=p[1],this.normalData[3*this._extrusionNormalCount+2]=p[2],++this._extrusionNormalCount;this._capNormalsOffset=this._extrusionNormalCount;var a=this.path.vertices[0],n=this.path.vertices[this.path.vertices.length-1];if(this.normalData[3*this._extrusionNormalCount+0]=-a.vRight[0],this.normalData[3*this._extrusionNormalCount+1]=-a.vRight[1],this.normalData[3*this._extrusionNormalCount+2]=-a.vRight[2],++this._extrusionNormalCount,this.normalData[3*this._extrusionNormalCount+0]=n.vRight[0],this.normalData[3*this._extrusionNormalCount+1]=n.vRight[1],this.normalData[3*this._extrusionNormalCount+2]=n.vRight[2],++this._extrusionNormalCount,this._profile.hasUV())for(var r=0;r<this._profile.uvs.length;++r)this.uvData[2*r+0]=this._profile.uvs[r],this.uvData[2*r+1]=0},t.prototype.buildTopology=function(){var t=this._profile.numSegments,e=this._numExtrusionVertices-1,i=t*e,r=2*i,s=3*r;this._profile.vertices.length>2&&(s+=2*(this._profile.vertices.length-2)*3),this._vertexIndices=new Uint32Array(s),this._normalIndices=new Uint32Array(s),this._pathVertexIndices=new Uint32Array(s),this._profile.hasUV()&&(this._uvIndices=new Uint32Array(s));for(var a=0,n=0;n<t;++n){var o=this._profile.vertexIndices[2*n],h=this._profile.vertexIndices[2*n+1],c=o,u=h,v=0,l=0;this._profile.hasNormals()&&(c=this._profile.normalIndices[2*n],u=this._profile.normalIndices[2*n+1]),this._profile.hasUV()&&(v=this._profile.uvIndices[2*n],l=this._profile.uvIndices[2*n+1]);for(var f=0;f<e;++f){var m=o*this._numExtrusionVertices+f,p=o*this._numExtrusionVertices+f+1,d=h*this._numExtrusionVertices+f+1,x=h*this._numExtrusionVertices+f,_=c*this._numExtrusionVertices+f,V=c*this._numExtrusionVertices+f+1,g=u*this._numExtrusionVertices+f+1,I=u*this._numExtrusionVertices+f,y=v,D=v,N=l,A=l;this._vertexIndices[3*a+0]=m,this._vertexIndices[3*a+1]=p,this._vertexIndices[3*a+2]=d,this._pathVertexIndices[3*a+0]=this.pathVertexData[m],this._pathVertexIndices[3*a+1]=this.pathVertexData[p],this._pathVertexIndices[3*a+2]=this.pathVertexData[d],this._normalIndices[3*a+0]=_,this._normalIndices[3*a+1]=V,this._normalIndices[3*a+2]=g,this._vertexIndices[3*a+3]=m,this._vertexIndices[3*a+4]=d,this._vertexIndices[3*a+5]=x,this._pathVertexIndices[3*a+3]=this.pathVertexData[m],this._pathVertexIndices[3*a+4]=this.pathVertexData[d],this._pathVertexIndices[3*a+5]=this.pathVertexData[x],this._normalIndices[3*a+3]=_,this._normalIndices[3*a+4]=g,this._normalIndices[3*a+5]=I,this._profile.hasUV()&&(this._uvIndices[3*a+0]=y,this._uvIndices[3*a+1]=D,this._uvIndices[3*a+2]=N,this._uvIndices[3*a+3]=y,this._uvIndices[3*a+4]=N,this._uvIndices[3*a+5]=A),a+=2}}if(this._profile.vertices.length>2)for(var C=this._profile.vertices.length-2,o=0,S=o*this._numExtrusionVertices+0,U=(o+1)*this._numExtrusionVertices-1,f=0;f<C;++f){var h=f+1,O=h*this._numExtrusionVertices+0,z=(h+1)*this._numExtrusionVertices-1,T=f+2,E=T*this._numExtrusionVertices+0,w=(T+1)*this._numExtrusionVertices-1;this._vertexIndices[3*a+0]=S,this._vertexIndices[3*a+1]=O,this._vertexIndices[3*a+2]=E,this._normalIndices[3*a+0]=this._capNormalsOffset+0,this._normalIndices[3*a+1]=this._capNormalsOffset+0,this._normalIndices[3*a+2]=this._capNormalsOffset+0,this._pathVertexIndices[3*a+0]=this.pathVertexData[S],this._pathVertexIndices[3*a+1]=this.pathVertexData[O],this._pathVertexIndices[3*a+2]=this.pathVertexData[E],++a,this._vertexIndices[3*a+0]=w,this._vertexIndices[3*a+1]=z,this._vertexIndices[3*a+2]=U,this._normalIndices[3*a+0]=this._capNormalsOffset+1,this._normalIndices[3*a+1]=this._capNormalsOffset+1,this._normalIndices[3*a+2]=this._capNormalsOffset+1,this._pathVertexIndices[3*a+0]=this.pathVertexData[w],this._pathVertexIndices[3*a+1]=this.pathVertexData[z],this._pathVertexIndices[3*a+2]=this.pathVertexData[U],++a}},t.prototype.createBakedGeometryData=function(e){for(var r=new Float32Array(3*this.numVerticesTotal),a=new Float32Array(4*this.numVerticesTotal),n=i({},e,{origin:f,direction:m,auxpos2X:0}),h=0;h<this.numVerticesTotal;++h)s.vec3.set(n.origin,this.originData[3*h+0],this.originData[3*h+1],this.originData[3*h+2]),s.vec3.set(n.direction,this.directionData[4*h+0],this.directionData[4*h+1],this.directionData[4*h+2]),e.vvSizeEnabled&&(n.auxpos2X=this.vvData[4*this._pathVertexIndices[h]+0]),t.queryVertexPosition(l,n),r[3*h+0]=l[0],r[3*h+1]=l[1],r[3*h+2]=l[2];var u={};u[c.VertexAttrConstants.POSITION]=this._vertexIndices,u[c.VertexAttrConstants.NORMAL]=this._normalIndices,u[c.VertexAttrConstants.AUXPOS1]=this._vertexIndices;var v={};return v[c.VertexAttrConstants.POSITION]={size:3,data:r},v[c.VertexAttrConstants.NORMAL]={size:3,data:this.normalData},v[c.VertexAttrConstants.AUXPOS1]={size:4,data:a},new o(v,u,o.DefaultOffsets,"triangle")},t.prototype.createGeometryData=function(){var t={};t[c.VertexAttrConstants.POSITION]=this._vertexIndices,t[c.VertexAttrConstants.AUXPOS1]=this._vertexIndices,t[c.VertexAttrConstants.NORMAL]=this._normalIndices;var e={};return e[c.VertexAttrConstants.POSITION]={size:3,data:this.originData},e[c.VertexAttrConstants.AUXPOS1]={size:4,data:this.directionData},e[c.VertexAttrConstants.NORMAL]={size:3,data:this.normalData},this._profile.hasUV()&&(t[c.VertexAttrConstants.UV0]=this._uvIndices,e[c.VertexAttrConstants.UV0]={size:2,data:this.uvData}),this.vvData&&(t[c.VertexAttrConstants.AUXPOS2]=this._pathVertexIndices,e[c.VertexAttrConstants.AUXPOS2]={size:4,data:this.vvData}),new o(e,t,o.DefaultOffsets,"triangle")},t}();t.Builder=C}(v||(v={}));var l=s.vec3f32.create(),f=s.vec3f32.create(),m=s.vec3f32.create(),p=s.vec3f32.create(),d=s.vec3f32.create(),x=s.vec3f32.create(),_=s.vec3f32.create(),V=s.vec3f32.create(),g=s.mat4f32.create();return v});