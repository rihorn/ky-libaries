// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.10/esri/copyright.txt for details.

define(["require","exports","../../../../core/libs/gl-matrix-2/gl-matrix","../../support/debugFlags","./DefaultVertexAttributeLocations","./DefaultVertexBufferLayouts","./glUtil3D","./Util","../shaders/HighlightPrograms","../../../webgl/BufferObject","../../../webgl/FramebufferObject","../../../webgl/Util","../../../webgl/VertexArrayObject"],function(e,t,i,r,a,o,l,s,n,p,h,u,d){var g=5;return function(){function e(e,t){this._grid={coverageMipmap:null,vao:null,verticalCellCount:0,horizontalCellCount:0,cellPixelSize:0,mipmapLevels:0,viewportWidth:0,viewportHeight:0},this.quadVAO=null,this.blur0Fbo=null,this.blur1Fbo=null,this._rctx=t,this.viewportToRestore=i.vec4f64.create(),this.defaultOptions={color:i.vec4f32.fromValues(1,0,1,1),haloOpacity:1,fillOpacity:.2,haloOpacityOccluded:.25,fillOpacityOccluded:.05},this.blurProgram=e.getProgram(n.blurPass,{gaussianSamples:g}),this.blurGridProgram=e.getProgram(n.blurPass,{gaussianSamples:g,gridOptimization:!0}),this.applyProgram=e.getProgram(n.applyPass),this.applyGridProgram=e.getProgram(n.applyPass,{gridOptimization:!0}),this.applyGridDebugProgram=e.getProgram(n.applyPass,{gridOptimization:!0,gridDebug:!0}),this.downsampleProgram=e.getProgram(n.downsamplePass)}return Object.defineProperty(e.prototype,"enabled",{get:function(){return null!==this.blur0Fbo},set:function(e){e?this.enable():this.disable()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"profilingCallback",{get:function(){return r.HIGHLIGHTS_PROFILE_TO_CONSOLE?function(e){return console.log(e)}:null},enumerable:!0,configurable:!0}),e.prototype.setDefaultOptions=function(e){this.defaultOptions=e},e.prototype.render=function(e,t){var a=!r.HIGHLIGHTS_GRID_OPTIMIZATION_DISABLED,o=r.HIGHLIGHTS_VISUALIZE_BLOCKS,l=e.camera,n=e.fbo,p=this._rctx;s.assert(this.enabled),i.vec4.copy(this.viewportToRestore,l.fullViewport);var h=t.width,d=t.height,g=Math.ceil(h/1),c=Math.ceil(d/1);this.blur0Fbo.resize(g,c),this.blur1Fbo.resize(g,c),p.bindVAO(this.quadVAO),p.setDepthWriteEnabled(!1),p.setDepthTestEnabled(!1),p.setBlendingEnabled(!1);var m=null,b=null,f=null,v=null;if(a){var O=this._grid;this._gridUpdateResources(t,32),this._gridComputeMipmap(),f=O.vao,v=4,m=this.blurGridProgram,p.bindProgram(m),p.bindTexture(O.coverageMipmap[O.mipmapLevels].colorTexture,1),m.setUniform1i("coverageTex",1)}else f=this.quadVAO,v=5,m=this.blurProgram,p.bindProgram(m);if(p.bindVAO(f),p.bindFramebuffer(this.blur0Fbo),p.setViewport(0,0,g,c),p.setClearColor(0,0,0,0),p.clear(p.gl.COLOR_BUFFER_BIT),m.setUniform1i("tex",0),p.bindTexture(t.colorTexture,0),m.setUniform2f("blurSize",1/g,0),p.drawArrays(v,0,u.vertexCount(f,"geometry")),p.bindFramebuffer(this.blur1Fbo),p.clear(p.gl.COLOR_BUFFER_BIT),p.bindTexture(this.blur0Fbo.colorTexture,0),m.setUniform2f("blurSize",0,1/c),p.drawArrays(v,0,u.vertexCount(f,"geometry")),p.bindFramebuffer(n),p.setBlendingEnabled(!0),p.setBlendFunctionSeparate(770,771,1,771),p.setViewport(this.viewportToRestore[0],this.viewportToRestore[1],this.viewportToRestore[2],this.viewportToRestore[3]),a){b=o?this.applyGridDebugProgram:this.applyGridProgram,p.bindProgram(b),b.setUniform1i("coverageTex",2);var x=this._grid.coverageMipmap[this._grid.mipmapLevels].colorTexture;p.bindTexture(x,2)}else b=this.applyProgram,p.bindProgram(b);b.setUniform1i("tex",0),p.bindTexture(this.blur1Fbo.colorTexture,0),b.setUniform1i("origin",1),p.bindTexture(t.colorTexture,1);var y=e.pixelRatio||1;b.setUniform4fv("color",this.defaultOptions.color),b.setUniform1f("outlineSize",8.6*y),b.setUniform1f("blurSize",.4*y),b.setUniform4f("opacities",this.defaultOptions.haloOpacity,this.defaultOptions.haloOpacityOccluded,this.defaultOptions.fillOpacity,this.defaultOptions.fillOpacityOccluded),p.drawArrays(v,0,u.vertexCount(f,"geometry")),p.bindVAO(null),p.setDepthWriteEnabled(!0),p.setDepthTestEnabled(!0),p.setBlendingEnabled(!1)},e.prototype.enable=function(){if(!this.enabled){this.quadVAO=l.createQuadVAO(this._rctx);var e={colorTarget:0,depthStencilTarget:0,width:0,height:0},t={target:3553,pixelFormat:6408,dataType:5121,samplingMode:9729,wrapMode:33071,width:0,height:0};this.blur0Fbo=h.createWithAttachments(this._rctx,t,e),this.blur1Fbo=h.createWithAttachments(this._rctx,t,e)}},e.prototype.disable=function(){this.enabled&&(this.quadVAO.dispose(!0),this.blur1Fbo.dispose(),this.blur0Fbo.dispose(),this.quadVAO=null,this.blur0Fbo=null,this.blur1Fbo=null)},e.prototype._gridUpdateResources=function(e,t){var i=this._rctx,r=this._grid,l=!1;if(null===r.coverageMipmap&&(r.coverageMipmap=[e],l=!0),r.viewportWidth===e.width&&r.viewportHeight===e.height||(l=!0,r.viewportWidth=e.width,r.viewportHeight=e.height),r.coverageMipmap[0]=e,r.cellPixelSize!==t&&(r.cellPixelSize=t,l=!0),l){for(var s=1;s<r.coverageMipmap.length;s++)r.coverageMipmap[s].dispose();r.mipmapLevels=Math.ceil(Math.log(r.cellPixelSize)*Math.LOG2E),r.coverageMipmap.length=r.mipmapLevels+1;for(var s=0;s<r.mipmapLevels;s++){var n=r.coverageMipmap[s],u={target:3553,pixelFormat:6407,dataType:33635,samplingMode:9729,wrapMode:33071,width:Math.ceil(n.width/2),height:Math.ceil(n.height/2)},g={colorTarget:0,depthStencilTarget:0,width:Math.ceil(n.width/2),height:Math.ceil(n.height/2)},c=h.createWithAttachments(i,u,g);r.coverageMipmap[s+1]=c}}var m=Math.ceil(e.height/r.cellPixelSize),b=Math.ceil(e.width/r.cellPixelSize);if(!r.vao||r.verticalCellCount!==m||r.horizontalCellCount!==b){r.verticalCellCount=m,r.horizontalCellCount=b;for(var f=m+1,v=b+1,O=1/m,x=1/b,y=new Float32Array(24*f*v),w=0,P=0;P<f;P++)for(var T=0;T<v;T++)y[w+0]=(T-.5)*x*2-1,y[w+1]=(P-.5)*O*2-1,y[w+2]=T*x,y[w+3]=P*O,y[w+4]=(T+.5)*x*2-1,y[w+5]=(P-.5)*O*2-1,y[w+6]=T*x,y[w+7]=P*O,y[w+8]=(T-.5)*x*2-1,y[w+9]=(P+.5)*O*2-1,y[w+10]=T*x,y[w+11]=P*O,y[w+12]=(T-.5)*x*2-1,y[w+13]=(P+.5)*O*2-1,y[w+14]=T*x,y[w+15]=P*O,y[w+16]=(T+.5)*x*2-1,y[w+17]=(P-.5)*O*2-1,y[w+18]=T*x,y[w+19]=P*O,y[w+20]=(T+.5)*x*2-1,y[w+21]=(P+.5)*O*2-1,y[w+22]=T*x,y[w+23]=P*O,w+=24;r.vao&&r.vao.dispose(!0),r.vao=new d(i,a.Default3D,{geometry:o.Pos2Tex},{geometry:p.createVertex(i,35044,y)})}},e.prototype._gridComputeMipmap=function(){var e=this._rctx,t=this._grid,i=this.downsampleProgram;e.bindVAO(this.quadVAO);for(var r=0;r<t.mipmapLevels;r++){e.bindFramebuffer(t.coverageMipmap[r+1]),e.bindTexture(t.coverageMipmap[r].colorTexture,0);var a=t.coverageMipmap[r+1].width,o=t.coverageMipmap[r+1].height;e.bindProgram(i),i.setUniform1i("tex",0),i.setUniform2f("invFramebufferDim",1/a,1/o),e.setViewport(0,0,a,o),e.drawArrays(5,0,u.vertexCount(this.quadVAO,"geometry"))}},e}()});