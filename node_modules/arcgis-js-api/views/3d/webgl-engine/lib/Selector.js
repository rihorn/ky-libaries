// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.10/esri/copyright.txt for details.

define(["require","exports","../../../../core/has","../../../../core/libs/gl-matrix-2/gl-matrix","./Object3D","./PerformanceTimer"],function(t,e,r,n,i,s){var o=n.mat4f64.create(),a=n.vec3f64.create(),c=n.vec3f64.create(),f=n.vec3f64.create(),h=r("dojo-debug-messages"),p=function(){function t(t){this.minResult=new m,this.maxResult=new m,this._transform=n.mat4f64.create(),this._transformInverse=new u({value:this._transform},n.mat4.invert,n.mat4f64.create),this._transformInverseTranspose=new u(this._transformInverse,n.mat4.transpose,n.mat4f64.create),this._transformTranspose=new u({value:this._transform},n.mat4.transpose,n.mat4f64.create),this._transformInverseRotation=new u({value:this._transform},n.mat3.normalFromMat4,n.mat3f64.create),this.enableHUDSelection=!0,this.enableTerrain=!0,this.enableInvisibleTerrain=!1,this.enableBackfacesTerrain=!0,this._p0=n.vec3f64.create(),this._p1=n.vec3f64.create(),this.performanceInfo={queryDuration:0,numObjectsTested:0},this.viewingMode=t||"global",h&&(this._timer=new s(1))}return Object.defineProperty(t.prototype,"p0",{get:function(){return this._p0},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"p1",{get:function(){return this._p1},enumerable:!0,configurable:!0}),t.prototype.init=function(t,e,r,n,i,s,o,a){this.minResult.init(e,r),this.maxResult.init(e,r),this._numObjectsTested=0,this.hudResults=[],this.run(t,e,r,n,i,s,o,a)},t.prototype.run=function(t,e,r,i,s,o,a,c){var p=this;if(this.point=i,this.camera=s,this.isSelection=a,n.vec3.copy(this._p0,e),n.vec3.copy(this._p1,r),this.filterPredicate=c,null==o&&(o=1e-5),this.tolerance=o,h&&this._timer.start(),t&&t.length>0){e&&r&&n.vec3.subtract(f,r,e);for(var m=function(t){p.intersectObject(t)},u=0,l=t;u<l.length;u++){var v=l[u],y=v.getSpatialQueryAccelerator?v.getSpatialQueryAccelerator():void 0;if(y)y.forEachAlongRay(this._p0,f,m),a&&y.forEachDegenerateObject(m);else for(var d=v.getObjects(),_=0,g=d;_<g.length;_++){var b=g[_];m(b)}}}h&&(this._timer.stop(),this.performanceInfo.queryDuration=this._timer.getLast(),this.performanceInfo.numObjectsTested=this._numObjectsTested)},Object.defineProperty(t.prototype,"transform",{get:function(){return this._transform},enumerable:!0,configurable:!0}),t.prototype.setTransform=function(t){n.mat4.copy(this._transform,t),this.invalidateLazyTransform()},Object.defineProperty(t.prototype,"transformInverse",{get:function(){return this._transformInverse.value},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"transformInverseTranspose",{get:function(){return this._transformInverseTranspose.value},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"transformInverseRotation",{get:function(){return this._transformInverseRotation.value},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"transformTranspose",{get:function(){return this._transformTranspose.value},enumerable:!0,configurable:!0}),t.prototype.invalidateLazyTransform=function(){this._transformInverse.invalidate(),this._transformInverseTranspose.invalidate(),this._transformTranspose.invalidate(),this._transformInverseRotation.invalidate()},t.prototype.intersectObject=function(t){var e=this;this._numObjectsTested++;for(var r,i=t.id,s=t.getGeometryRecords(),f=t.objectTransformation,h=0;h<s.length;h++){var p=s[h],u=p.geometry,l=p.material,v=p.instanceParameters;v.hidden||(r=u.id,n.mat4.copy(this._transform,f),n.mat4.multiply(this._transform,this._transform,p.getShaderTransformation()),this.invalidateLazyTransform(),n.vec3.transformMat4(a,this.p0,this.transformInverse),n.vec3.transformMat4(c,this.p1,this.transformInverse),l.intersect(u,v,this._transform,this,a,c,function(n,s,a,c,f,h){if(n>=0){if(null!=e.filterPredicate&&!e.filterPredicate(e._p0,e._p1,n))return;if(f){var p=new m;p.init(e._p0,e._p1),p.set(t,i,n,s,o,c,h,r,a),e.hudResults.push(p)}else(null==e.minResult.priority||c>=e.minResult.priority)&&(null==e.minResult.dist||n<e.minResult.dist)&&e.minResult.set(t,i,n,s,e._transform,c,null,r,a),(null==e.maxResult.priority||c>=e.maxResult.priority)&&(null==e.maxResult.dist||n>e.maxResult.dist)&&e.maxResult.set(t,i,n,s,e._transform,c,null,r,a)}},p.shaderTransformation))}},t.DEFAULT_TOLERANCE=1e-5,t}(),m=function(){function t(t,e){this._p0=n.vec3f64.create(),this._p1=n.vec3f64.create(),this._normal=n.vec3f64.create(),this._transformation=n.mat4f64.create(),this.init(t,e)}return Object.defineProperty(t.prototype,"p0",{get:function(){return this._p0},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"p1",{get:function(){return this._p1},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"hasIntersectionPoint",{get:function(){return null!=this.dist},enumerable:!0,configurable:!0}),t.prototype.getIntersectionPoint=function(t){return!!this.hasIntersectionPoint&&(n.vec3.lerp(t,this.p0,this.p1,this.dist),!0)},t.prototype.getTransformedNormal=function(t){return n.vec3.copy(l,this._normal),l[3]=0,n.vec4.transformMat4(l,l,this._transformation),n.vec3.copy(t,l),n.vec3.normalize(t,t),t},t.prototype.set=function(t,e,r,s,o,a,c,f,h){t instanceof i&&(t={type:"stage",obj:t}),this.dist=r,n.vec3.copy(this._normal,s),n.mat4.copy(this._transformation,o),this.target=t,this.name=e,this.priority=a,this.center=c?n.vec3f64.clone(c):null,this.geometryId=f,this.triangleNr=h},t.prototype.copyFrom=function(t){n.vec3.copy(this._p0,t._p0),n.vec3.copy(this._p1,t._p1),this.dist=t.dist,this.target=t.target,this.name=t.name,this.priority=t.priority,this.center=t.center?n.vec3f64.clone(t.center):null,this.geometryId=t.geometryId,this.triangleNr=t.triangleNr,this.intersector=t.intersector,n.vec3.copy(this._normal,t._normal),n.mat4.copy(this._transformation,t._transformation)},t.prototype.setIntersector=function(t){this.intersector=t},t.prototype.init=function(t,e){this.dist=void 0,this.target=void 0,this.name=void 0,this.priority=void 0,this.center=null,this.geometryId=null,this.triangleNr=null,this.intersector="Stage",t?n.vec3.copy(this._p0,t):n.vec3.set(this._p0,0,0,0),e?n.vec3.copy(this._p1,e):n.vec3.set(this._p1,0,0,0)},t}(),u=function(){function t(t,e,r){this.original=t,this.update=e,this.dirty=!0,this.transform=r()}return t.prototype.invalidate=function(){this.dirty=!0},Object.defineProperty(t.prototype,"value",{get:function(){return this.dirty&&(this.update(this.transform,this.original.value),this.dirty=!1),this.transform},enumerable:!0,configurable:!0}),t}(),l=n.vec4f64.create();return p});