// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.10/esri/copyright.txt for details.

define(["require","exports","../../../../core/iteratorUtils","../../../../core/libs/gl-matrix-2/gl-matrix","../../support/buffer/glUtil","./ComponentUtils","./DefaultVertexAttributeLocations","./Float32ArrayList","./FxaaRenderPass","./HighlightTextureHelper","./InstanceBufferData","./IntervalUtilities","./LinearDepthTextureHelper","./NormalTextureHelper","./RenderContext","./RenderPluginManager","./SmaaRenderPass","./StencilRenderingHelper","./Util","./edgeRendering/EdgeView","../lighting/SceneLighting","../materials/HUDMaterial","../../../webgl/BufferObject","../../../webgl/Profiling","../../../webgl/Texture","../../../webgl/Util","../../../webgl/VertexArrayObject"],function(e,t,r,a,n,i,s,o,d,l,h,f,g,u,p,c,m,_,v,y,b,x,D,R,I,P,C){function w(e){if(e.instanceParameters.hidden)return[];var t=e.instanceParameters.componentVisibilities,r=e.componentOffsets;return i.generateVisibleIndexRanges(t,r)}function H(e){if(e.instanceParameters.hidden)return null;var t=e.instanceParameters.componentVisibilities,r=e.instanceParameters.componentHighlights,a=e.componentOffsets;return i.generateHighlightedIndexRanges(t,r,a)}function T(e,t,r){var n=e.origin.vec3;v.setMatrixTranslation3(E,-n[0],-n[1],-n[2]),a.mat4.multiply(t,E,e.transformation),a.mat4.invert(r,t),a.mat4.transpose(r,r)}function O(e,t,r){for(var a in e){var n=e[a];t(a,n),n.origin2data.forEach(function(e,t){r(t,e)})}}function M(e){return S(e.data)>=1}function S(e){return!1===e.preinterleaved?v.getFirstObjectValue(e.indices).length:e.indexCount}var V=a.mat4f64.create(),A=1535,B=function(){function e(e,t,r,a,n){this._lighting=new b.SceneLighting,this._mat2DataMerged={},this._mat2DataInstanced={},this._mat2DataPreinterleaved={},this._renderOrder=[],this._renderContext=new p,this._isRendering=!1,this._highlights=[],this._threshold=A,this._needsRender=!0,this._fallbackDepthStencilTexture=null,this._stats=new N,this._edgeView=null,this.ssaoEnabled=!1,this.renderOptions={antialiasing:"smaa",earlyOcclusionPixelDraw:!1},this._programRep=e,this._materialRep=t,this._orderedRendering=n,this._rctx=a,this._fxaaPass=new d(a),this._smaaPass=new m(a),this._renderContext.rctx=a,this._renderContext.lightingData=this._lighting.getOld(),a.setDepthTestEnabled(!0),a.setFaceCullingEnabled(!0),a.setBlendingEnabled(!1),a.setBlendFunctionSeparate(770,771,1,771),this._bindParameters={view:null,proj:null,viewInvTransp:null,fovY:0,nearFar:null,lightingData:null,viewport:null,framebufferTex:null,shadowMappingEnabled:!1,ssaoEnabled:!1,origin:null,pixelRatio:null,slicePlane:null},this._linearDepthTextureHelper=new g(a),this._normalTextureHelper=new u(a),this._highlightTextureHelper=new l(a),this._stencilRenderingHelper=new _(a),this._renderPlugins=new c.RenderPluginManager({rctx:a,gl:a.gl,programRep:e,textureRep:r,materialRep:t}),this._initializeFramebufferTexture()}return e.prototype._initializeFramebufferTexture=function(){var e=this._rctx.gl,t=this._rctx.contextAttributes,r=t.alpha?e.RGBA:e.RGB,a=new I(this._rctx,{target:3553,pixelFormat:r,dataType:5121,samplingMode:9728,wrapMode:33071,width:4,height:4});this._framebuffer={format:r,texture:a}},e.prototype.dispose=function(){var e=this,t=function(t){e._releaseMaterials(t)},r=function(e,t){t.type===G.Preinterleaved?t.instances.forEach(function(e){return e.vao.dispose(!0)}):t.vao.dispose(!0)};O(this._mat2DataMerged,t,r),O(this._mat2DataInstanced,t,r),O(this._mat2DataPreinterleaved,t,r),this._mat2DataMerged=null,this._mat2DataInstanced=null,this._mat2DataPreinterleaved=null,this._framebuffer.texture.dispose(),this._framebuffer.texture=null,this._linearDepthTextureHelper.enabled=!1,this._normalTextureHelper.enabled=!1,this._stencilRenderingHelper.enabled=!1,this._fallbackDepthStencilTexture&&(this._fallbackDepthStencilTexture.dispose(),this._fallbackDepthStencilTexture=null),this._highlightTextureHelper&&(this._highlightTextureHelper.dispose(),this._highlightTextureHelper=null)},Object.defineProperty(e.prototype,"isLoadingResources",{get:function(){return"smaa"===this.renderOptions.antialiasing&&this._smaaPass.isLoadingResources},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"edgeView",{get:function(){var e=this;return null==this._edgeView&&(this._edgeView=new y.EdgeView(this._rctx,this._programRep,{setNeedsRender:function(){e._needsRender=!0}}),this._edgeView.initialize()),this._edgeView},enumerable:!0,configurable:!0}),e.prototype.setLighting=function(e){this._lighting.set(e)},Object.defineProperty(e.prototype,"renderPlugins",{get:function(){return this._renderPlugins},enumerable:!0,configurable:!0}),e.prototype.resetNeedsRender=function(){this._needsRender=!1,this._renderPlugins.resetNeedsRender()},e.prototype.needsRender=function(){return this._needsRender||this._renderPlugins.needsRender()},e.prototype.getCombinedStats=function(){var e=this;this._stats.VBOallocatedSize=0,this._stats.VBOoptimalSize=0,this._stats.VBOusedSize=0;var t=function(){},r=function(t,r){r.type===G.Preinterleaved?r.instances.forEach(function(t){var r=t.vao.size;e._stats.VBOallocatedSize+=r/4,e._stats.VBOusedSize+=r/4,e._stats.VBOoptimalSize+=r/4}):(e._stats.VBOallocatedSize+=r.buffer.getArray().length,e._stats.VBOusedSize+=r.buffer.getSize(),e._stats.VBOoptimalSize+=r.optimalCount)};return O(this._mat2DataMerged,t,r),O(this._mat2DataInstanced,t,r),O(this._mat2DataPreinterleaved,t,r),this._stats.VBOallocatedSize*=4/1024,this._stats.VBOusedSize*=4/1024,this._stats.VBOoptimalSize*=4/1024,this._stats},e.prototype.getFramebufferTexture=function(e){switch(e){case"linearDepth":return this._linearDepthTextureHelper.framebuffer.colorTexture;case"normals":return this._normalTextureHelper.framebuffer.colorTexture}return null},e.prototype._addHighlight=function(e){var t=this._getInstance(e);if(null===t)return void console.error("No instance found for RenderGeometry {name: '"+e.name+"', uniqueName: '"+e.uniqueName+"'}");this._highlights.push(t),this._orderedRendering&&this._sortHighlightsByRenderOrder(),this._needsRender=!0,this.onHasHighlightsChanged&&this.onHasHighlightsChanged(this.hasHighlights)},e.prototype._removeHighlight=function(e){var t=this._highlights.length;this._highlights=this._highlights.filter(function(t){return t.uniqueName!==e.uniqueName}),t!==this._highlights.length&&(this.onHasHighlightsChanged&&this.onHasHighlightsChanged(this.hasHighlights),this._needsRender=!0)},Object.defineProperty(e.prototype,"hasHighlights",{get:function(){return this._highlights.length>0},enumerable:!0,configurable:!0}),e.prototype._renderHUDVisibility=function(e){var t=this,r=x.shouldRenderVisibilityDuringRenderPass(e.pass),a=e.offscreenRenderingHelper&&e.offscreenRenderingHelper.enabled,n=!1;return r&&a&&e.offscreenRenderingHelper.renderHUDVisibility(function(){n=t._renderInternalSlot(14,e)}),n},e.prototype.renderGeometrySlotsPt1=function(e){this._renderPlugins.render(1,e),this._renderInternalSlot(2,e),this._renderPlugins.render(3,e),this._renderInternalSlot(4,e),this._renderPlugins.render(5,e),e.ssaoHelper&&e.ssaoHelper.bindAll(this._programRep),this._renderPlugins.render(16,this._renderContext),this._renderInternalSlot(6,e),this.renderOptions.earlyOcclusionPixelDraw&&(this._renderHUDVisibility(e),this._renderInternalSlot(21,this._renderContext)),this._renderPlugins.render(7,e),e.ssaoHelper&&e.ssaoHelper.bindAll(this._programRep)},e.prototype.renderTransparentTerrain=function(e){return this._renderPlugins.render(8,e)},e.prototype.renderGeometrySlots=function(e){this.renderGeometrySlotsPt1(e),this.renderTransparentTerrain(e)},e.prototype.renderHUD=function(e){this._bindParameters.renderTransparentlyOccludedHUD=e,this._renderInternalSlot(22,this._renderContext),this._renderInternalSlot(19,this._renderContext),this._renderInternalSlot(20,this._renderContext)},e.prototype._renderHighlights=function(e,t){if(!!t&&t.enabled&&(this.hasHighlights||this._renderPlugins.needsHighlight())){var r=null;t.profilingCallback&&(r=R.startMeasurement(this._renderContext.rctx));var a=e.camera,n=e.fbo;this._highlightTextureHelper.prepareHighlightPass(a),this.renderGeometryPass(4,e,null,null,this._renderContext.sliceHelper);var i=this._rctx.gl;this._rctx.clear(i.DEPTH_BUFFER_BIT),this.renderHUD("both"),this._highlightTextureHelper.finish(n);var s=this._highlightTextureHelper.framebuffer;t.render(e,s),null!==r&&t.profilingCallback&&r.stop(function(e){t.profilingCallback&&t.profilingCallback(e)})}},e.prototype._needsRenderOccluded=function(e){for(var t in this._mat2DataInstanced){var r=this._mat2DataInstanced[t],a=r[0];if(a&&a.renderOccluded&&a.beginSlot(e)&&a.isVisible())return!0}return!1},e.prototype._renderOccluded=function(e,t,r){if(t&&r&&r.enabled){var a=this._needsRenderOccluded(4)||this._needsRenderOccluded(6)||this._needsRenderOccluded(9);if(t.enabled=a,a){var n=this._renderContext;t.setupFBOs(e),t.prepareColorPass(),n.pass=0,n.renderOccludedOnly=!0,this._renderInternalSlot(4,n),this._renderInternalSlot(6,n),this._renderInternalSlot(9,n),n.renderOccludedOnly=!1,t.finish(r.framebuffer),t.apply()}}},e.prototype._renderUnordered=function(e,t,r){var a=this,n=this._rctx;this._isRendering=!0,this._stats.reset();var i=e.camera,s=e.fbo,o=e.pixelRatio;this._updateGlobalUniforms(i.projectionMatrix),this._renderContext.pass=0,this._renderContext.camera=i,this._renderContext.pixelRatio=o,this._renderContext.shadowMap=t,this._renderContext.sliceHelper=r.slice,this._renderContext.ssaoHelper=r.ssao,this._renderContext.offscreenRenderingHelper=r.offscreenRendering,this._renderContext.stencilRenderingHelper=this._stencilRenderingHelper,this._renderContext.depth=this._linearDepthTextureHelper.framebuffer,this._renderContext.normals=this._normalTextureHelper.framebuffer,this._renderContext.highlight=this._highlightTextureHelper.framebuffer,this._renderContext.options=this.renderOptions,r.offscreenRendering.enabled=!0,r.offscreenRendering.initializeFrame(i,s),this._renderPlugins.render(0,this._renderContext),this.renderGeometrySlotsPt1(this._renderContext),this._edgeView&&this.edgeView.shouldRender()&&r.offscreenRendering.renderSeparateAndComposite(function(){a._edgeView.render(a._bindParameters)},void 0,"alpha");var d={hudVisibility:!1,transparentTerrain:!1};this.renderOptions.earlyOcclusionPixelDraw||(d.hudVisibility=this._renderHUDVisibility(this._renderContext),this._renderInternalSlot(21,this._renderContext)),d.transparentTerrain=this.renderTransparentTerrain(this._renderContext),d.transparentTerrain&&d.hudVisibility&&(r.offscreenRendering.compositeTransparentTerrainOntoHUDVisibility(),r.offscreenRendering.renderToTargets(function(){return a.renderHUD("occluded")},r.offscreenRendering.mainColor,r.offscreenRendering.tmpDepth,void 0,!0)),d.transparentTerrain&&r.offscreenRendering.compositeTransparentTerrainOntoMain(),r.offscreenRendering.renderToTargets(function(){a._renderInternalSlot(9,a._renderContext),a._renderPlugins.render(17,a._renderContext),a._renderPlugins.render(18,a._renderContext),a._renderOccluded(i,r.renderOccluded,r.offscreenRendering),r.slice&&r.slice.isEnabled&&(a._renderInternalSlot(10,a._renderContext),a._renderInternalSlot(11,a._renderContext),a._renderInternalSlot(12,a._renderContext),a._renderInternalSlot(13,a._renderContext))},r.offscreenRendering.mainColor,r.offscreenRendering.mainDepth);var l=this.renderOptions.antialiasing;"smaa"===l&&this._smaaPass.loadResources(function(){a._needsRender=!0}),"smaa"===l&&this._smaaPass.enable()?(this._fxaaPass.disable(),this._smaaPass.render({colorTexture:r.offscreenRendering.colorTexture},s)):"fxaa"===l&&this._fxaaPass.enable()?(this._smaaPass.disable(),this._fxaaPass.render({colorTexture:r.offscreenRendering.colorTexture},s)):(r.offscreenRendering.composite(),this._fxaaPass.disable(),this._smaaPass.disable()),n.bindFramebuffer(s),this._renderContext.framebufferTex=r.offscreenRendering.colorTexture,this.renderHUD("notOccluded"),this._renderHighlights(e,r.highlight);this._isRendering=!1},e.prototype._renderGeometryPassOrderedHighlight=function(e){this._renderInternalHighlights()},e.prototype._renderGeometryPassOrderedMaterial=function(e){for(var t=null,r=0;r<this._renderOrder.length;r++){var a=this._renderOrder[r][1];if(a.instanced){var n=a.instanced||a.merged,i=n[e.pass];i&&i.isVisible()&&(this._renderInternalInstanced(n,i,this._bindParameters,1/0),t=null)}if(a.merged){var n=a.merged,i=n[e.pass];if(i&&i.isVisible()){var s=i.getProgram();s!==t&&(s.setUniformMatrix4fv("model",V),s.hasUniform("modelNormal")&&s.setUniformMatrix4fv("modelNormal",V)),t=s,this._renderInternalMerged(n,i,this._bindParameters,1/0)}}}},e.prototype._renderGeometryPassOrdered=function(e){var t=e.camera;this._bindParameters.view=t.viewMatrix,this._bindParameters.proj=t.projectionMatrix,this._bindParameters.viewInvTransp=t.viewInverseTransposeMatrix,z[0]=t.near,z[1]=t.far,this._bindParameters.nearFar=z,this._bindParameters.lightingData=e.lightingData,this._bindParameters.viewport=t.fullViewport,this._bindParameters.framebufferTex=this._framebuffer.texture,this._bindParameters.pixelRatio=e.pixelRatio,this._bindParameters.slicePlane=e.sliceHelper&&e.sliceHelper.plane,e.isHighlightPass?this._renderGeometryPassOrderedHighlight(e):this._renderGeometryPassOrderedMaterial(e)},e.prototype._renderOrdered=function(e,t){this._stats.reset(),this.renderGeometryPass(e,t)},e.prototype.prepareRender=function(e){this._renderPlugins.prepareRender(e),this._renderContext.rctx.setDepthFunction(513)},e.prototype.render=function(e,t){this._orderedRendering?this._renderOrdered(0,e):this._renderUnordered(e,t.shadowMap,t)},e.prototype.renderAuxiliaryBuffers=function(e,t){var r=t.ssao,a=t.slice,n=t.shadowMap,i=this.ssaoEnabled||this._renderPlugins.needsLinearDepth(),s=e.camera,o=e.fbo;this._linearDepthTextureHelper.enabled=i,i&&(this._linearDepthTextureHelper.setupFBOs(s),this._linearDepthTextureHelper.prepareDepthPass(),this.renderGeometryPass(1,e,n,r,a),this._linearDepthTextureHelper.finish(o)),this._normalTextureHelper.enabled=this.ssaoEnabled,this.ssaoEnabled&&(this._normalTextureHelper.setupFBOs(s),this._normalTextureHelper.prepareNormalPass(),this.renderGeometryPass(2,e,n,r,a),this._normalTextureHelper.finish(o),r.computeSSAO(s,o,this._linearDepthTextureHelper.framebuffer,this._normalTextureHelper.framebuffer)),r.bindAll(this._programRep)},e.prototype.renderGeometryPass=function(e,t,r,a,n){this._isRendering=!0;var i=t.camera,s=t.pixelRatio;this._updateGlobalUniforms(i.projectionMatrix),this._renderContext.pass=e,this._renderContext.camera=i,this._renderContext.pixelRatio=s,this._renderContext.shadowMap=r,this._renderContext.ssaoHelper=a,this._renderContext.depth=this._linearDepthTextureHelper.framebuffer,this._renderContext.normals=this._normalTextureHelper.framebuffer,this._renderContext.sliceHelper=n,this._orderedRendering?this._renderGeometryPassOrdered(this._renderContext):this._renderGeometryPassUnordered(this._renderContext),this._isRendering=!1},e.prototype._renderGeometryPassUnordered=function(e){this.renderGeometrySlots(e)},e.prototype._renderInternalHighlights=function(e){void 0===e&&(e=null);for(var t=!1,r=0;r<this._highlights.length;++r){var a=this._highlights[r],n=a.matData[4];n&&(null===e||n.beginSlot(e))&&n.isVisible()&&(t=this._renderInternalHighlight(a,this._bindParameters,4)||t)}return t},e.prototype._renderInternalSlotOccluded=function(e,t){var r=!1;for(var a in this._mat2DataInstanced){var n=this._mat2DataInstanced[a],i=n[t.pass];i&&i.renderOccluded&&i.beginSlot(e)&&i.isVisible()&&(r=this._renderInternalInstanced(n,i,this._bindParameters,e)||r)}return r},e.prototype._renderInternalSlotMaterial=function(e,t){var r=!1;for(var a in this._mat2DataInstanced){var n=this._mat2DataInstanced[a],i=n[t.pass];i&&i.beginSlot(e)&&i.isVisible()&&(r=this._renderInternalInstanced(n,i,this._bindParameters,e)||r)}for(var s=this._programRep.getProgramsUsingUniform("model"),o=this._programRep.getProgramsUsingUniform("modelNormal"),d=0;d<s.length;d++){var l=s[d];l.setUniformMatrix4fv("model",V),o.indexOf(l)>-1&&l.setUniformMatrix4fv("modelNormal",V)}for(var a in this._mat2DataMerged){var n=this._mat2DataMerged[a],i=n[t.pass];i&&i.beginSlot(e)&&i.isVisible()&&(r=this._renderInternalMerged(n,i,this._bindParameters,e)||r)}for(var a in this._mat2DataPreinterleaved){var n=this._mat2DataPreinterleaved[a],i=n[t.pass];i&&i.beginSlot(e)&&i.isVisible()&&(r=this._renderInternalPreinterleaved(n,i,this._bindParameters,e)||r)}return 2===e&&this._stencilRenderingHelper.finish(),r},e.prototype._renderInternalSlotHighlights=function(e,t){return this._renderInternalHighlights(e)},e.prototype._renderInternalSlot=function(e,t){this._bindParameters.view=t.camera.viewMatrix,this._bindParameters.proj=t.camera.projectionMatrix,this._bindParameters.viewInvTransp=t.camera.viewInverseTransposeMatrix,this._bindParameters.cameraAboveGround=t.camera.aboveGround,this._bindParameters.fovY=t.camera.fovY,z[0]=t.camera.near,z[1]=t.camera.far;var r=this._renderContext.offscreenRenderingHelper;return this._bindParameters.nearFar=z,this._bindParameters.lightingData=t.lightingData,this._bindParameters.viewport=t.camera.fullViewport,this._bindParameters.framebufferTex=r?r.colorTexture:null,this._bindParameters.shadowMap=t.shadowMap,this._bindParameters.shadowMappingEnabled=!!t.shadowMap&&t.shadowMap.enabled,this._bindParameters.ssaoEnabled=!!t.ssaoHelper&&t.ssaoHelper.enabled,this._bindParameters.pixelRatio=t.pixelRatio,this._bindParameters.slicePlane=t.sliceHelper&&t.sliceHelper.plane,this._bindParameters.hudVisibilityTexture=r?r.hudVisibilityTexture:null,t.isHighlightPass?this._renderInternalSlotHighlights(e,t):t.renderOccludedOnly?this._renderInternalSlotOccluded(e,t):this._renderInternalSlotMaterial(e,t)},e.prototype._renderInternalInstanced=function(e,t,r,a){var n=this,i=this._rctx,s=i.gl,o=!1,d=t.getDrawMode(),l=i.capabilities.instancing,h=!1;return e.origin2data.forEach(function(e){r.origin=e.origin,2===a&&(n._stencilRenderingHelper.enabled=!0,n._stencilRenderingHelper.prepareStencilWritePass());var f=!1;if(t.instanced)for(var g in e.perGeometryDataInfo){var u=e.perGeometryDataInfo[g];o||(t.bind(i,r),o=!0),i.bindVAO(u.vao);var p=t.getProgram();P.assertCompatibleVertexAttributeLocations(u.vao,p),f||(t.bindView(i,r),f=!0);var c=u.to-u.from,m=u.refCount;d===s.TRIANGLES&&(n._stats.trianglesRendered+=m*c/3),l.drawArraysInstanced(d,u.from,c,m),h=!0,n._stats.drawCallsAngleInstanced++,n._stats.instancesDrawnAngle+=m}else e.instances.forEach(function(a){var l=a.displayedIndexRange;l&&0===l.length||(o||(t.bind(i,r),o=!0),f||(i.bindVAO(e.vao),t.bindView(i,r),f=!0),t.bindInstance(i,a),n._stats.drawCallsInstanced++,d===s.TRIANGLES&&(n._stats.trianglesRendered+=(a.to-a.from)/3),l?n._drawArraysFaceRange(l,a.from,d):i.drawArrays(d,a.from,a.to-a.from),h=!0)})}),i.bindVAO(null),o&&t.release(i,r),h},e.prototype._renderInternalHighlight=function(e,t,r){var a=this._rctx,n=a.gl,i=e.matData[r],s=i.getDrawMode(),o=e.instance,d=o.highlightedIndexRange,l=this._renderContext.offscreenRenderingHelper,h=(l?l.depthTexture:null)||this._getFallbackDepthTexture(),f=i.getProgram(),g=a.capabilities.instancing;t.origin=e.originData.origin;var u=!1;if(i.instanced&&e.type===G.Instanced){var p=e.instancedVAO;i.bind(a,t),a.bindVAO(p),P.assertCompatibleVertexAttributeLocations(p,f),i.bindView(a,t);for(var c=0;c<d.length;c++){var m=d[c],_=m.range?m.range[0]+o.from:o.from,v=m.range?m.range[1]-m.range[0]+1:o.to-o.from;a.bindTexture(h,5),f.setUniform1i("depthTex",5),f.setUniform4f("highlightViewportPixelSz",0,0,1/this._bindParameters.viewport[2],1/this._bindParameters.viewport[3]),g.drawArraysInstanced(s,_,v,1),s===n.TRIANGLES&&(this._stats.trianglesRendered+=1*v/3),this._stats.drawCallsHighlight++,u=!0}}else if(e.type===G.Instanced&&i.instanced)console.error("_renderInternalHighlight: incompatible instance type");else{i.bind(a,t),i.bindView(a,t);var y=null;switch(e.type){case G.Merged:var b=e.originData;a.bindVAO(b.vao),f.setUniformMatrix4fv("model",V);break;case G.Instanced:var b=e.originData;a.bindVAO(b.vao),i.bindInstance(a,o);break;case G.Preinterleaved:var b=e.originData,p=b.instances.get(e.uniqueName).vao;a.bindVAO(p),i.bindInstance(a,o),y=p.indexBuffer&&p.indexBuffer.indexType}for(var c=0;c<d.length;c++){var m=d[c],_=m.range?m.range[0]+o.from:o.from,v=m.range?m.range[1]-m.range[0]+1:o.to-o.from;if(a.bindTexture(h,5),i.getProgram().setUniform1i("depthTex",5),f.setUniform4f("highlightViewportPixelSz",0,0,1/this._bindParameters.viewport[2],1/this._bindParameters.viewport[3]),y){var x=P.getBytesPerElement(y);a.drawElements(s,v,y,_*x)}else a.drawArrays(s,_,v);s===n.TRIANGLES&&(this._stats.trianglesRendered+=v/3),this._stats.drawCallsHighlight++,u=!0}}return a.bindVAO(null),i.release(a,t),u},e.prototype._drawArraysFaceRange=function(e,t,r){for(var a=this._rctx,n=0,i=e;n<i.length;n++){var s=i[n];a.drawArrays(r,s[0]+t,s[1]-s[0]+1)}this._stats.drawCallsFragmented+=e.length-1},e.prototype._drawElementsFaceRange=function(e,t,r,a){for(var n=this._rctx,i=P.getBytesPerElement(a),s=0,o=e;s<o.length;s++){var d=o[s],l=d[1]-d[0]+1,h=d[0]+t;n.drawElements(r,l,a,h*i)}this._stats.drawCallsFragmented+=e.length-1},e.prototype._renderInternalMerged=function(e,t,r,a){var n=this,i=this._rctx,s=i.gl,o=!1,d=!1;return e.origin2data.forEach(function(e){if(r.origin=e.origin,2===a&&(n._stencilRenderingHelper.enabled=!0,n._stencilRenderingHelper.prepareStencilWritePass()),!e.displayedIndexRange||0!==e.displayedIndexRange.length){d||(t.bind(i,r),d=!0);var l=t.getProgram();i.bindVAO(e.vao),P.assertCompatibleVertexAttributeLocations(e.vao,l),t.bindView(i,r),n._stats.drawCallsMerged++;var h=t.getDrawMode();h===s.TRIANGLES&&(n._stats.trianglesRendered+=e.vao.vertexBuffers.geometry.size/3),e.displayedIndexRange?n._drawArraysFaceRange(e.displayedIndexRange,0,h):i.drawArrays(h,0,P.vertexCount(e.vao,"geometry")),o=!0}}),d&&t.release(i,r),o},e.prototype._renderInternalPreinterleaved=function(e,t,r,a){var n=this,i=this._rctx,s=i.gl,o=!1,d=!1,l=t.getDrawMode();return e.origin2data.forEach(function(e){r.origin=e.origin;var h=!1;2===a&&(n._stencilRenderingHelper.enabled=!0,n._stencilRenderingHelper.prepareStencilWritePass()),e.instances.forEach(function(e){var a=e.instance,f=e.vao,g=a.displayedIndexRange;if(!g||0!==g.length){d||(t.bind(i,r),d=!0);var u=t.getProgram();P.assertCompatibleVertexAttributeLocations(f,u),i.bindVAO(f),h||(t.bindView(i,r),h=!0),t.bindInstance(i,a),n._stats.drawCallsPreinterleaved++,l===s.TRIANGLES&&(n._stats.trianglesRendered+=(a.to-a.from)/3);var p=f.indexBuffer&&f.indexBuffer.indexType;if(g)p?n._drawElementsFaceRange(g,a.from,l,p):n._drawArraysFaceRange(g,a.from,l);else if(p){var c=P.getBytesPerElement(p);i.drawElements(l,a.to-a.from,p,a.from*c)}else i.drawArrays(l,a.from,a.to-a.from);o=!0}})}),i.bindVAO(null),d&&t.release(i,r),o},e.prototype._updateGlobalUniforms=function(e){for(var t=this._programRep.getProgramsUsingUniform("proj"),r=0;r<t.length;r++)t[r].setUniformMatrix4fv("proj",e);if(this._lighting){t=this._programRep.getProgramsUsingUniform("lightingMainDirection");for(var r=0;r<t.length;r++)this._lighting.setUniforms(t[r]);t=this._programRep.getProgramsUsingUniform("lightDirection");for(var r=0;r<t.length;r++)this._lighting.setUniforms(t[r])}},e.prototype.print=function(){var e=Object.keys(this._mat2DataMerged).length,t=Object.keys(this._mat2DataInstanced).length,r=Object.keys(this._mat2DataPreinterleaved).length;console.log("number of materials (merged/instanced/preinterleaved): "+e+"/"+t+"/"+r);var a=0;O(this._mat2DataMerged,function(){},function(e,t){a+=t.instances.size});var n=0;O(this._mat2DataInstanced,function(){},function(e,t){n+=t.instances.size});var i=0;O(this._mat2DataPreinterleaved,function(){},function(e,t){i+=t.instances.size}),console.log("number of instances (merged/instanced/preinterleaved): "+a+"/"+n+"/"+i)},e.prototype.isEmpty=function(){for(var e in this._mat2DataInstanced){var t=this._mat2DataInstanced[e];if(!r.everyMap(t.origin2data,function(e){return 0===e.instances.size}))return!1}for(var e in this._mat2DataMerged){var t=this._mat2DataMerged[e];if(!r.everyMap(t.origin2data,function(e){return 0===e.instances.size}))return!1}for(var e in this._mat2DataPreinterleaved){var t=this._mat2DataPreinterleaved[e];if(!r.everyMap(t.origin2data,function(e){return 0===e.instances.size}))return!1}return!0},e.prototype.modify=function(e,t,r,a){this._isRendering&&console.warn("Renderer.modify called while rendering");var n=[],i=[],s=[];this._classifyRenderGeometry(e,n,i,s);var o=[],d=[],l=[];this._classifyRenderGeometry(t,o,d,l);var h={};r&&this._performUpdates(r,h);var f=[];this._modifyMerged(n,o,f,h),this._modifyInstanced(i,d,f),this._modifyPreinterleaved(s,l,f),this._updateMergedFaceranges(h),this._releaseMaterials(f);var g=this._highlights.length;t&&t.length>0&&g>0&&(this._highlights=this._highlights.filter(function(e){return!t.some(function(t){return t.uniqueName===e.uniqueName})}),g!==this._highlights.length&&this.onHasHighlightsChanged&&this.onHasHighlightsChanged(this.hasHighlights)),this._updateHighlightVAOs(),a&&this._modifyMaterials(a),this._needsRender=!0},e.prototype._classifyRenderGeometry=function(e,t,r,a){for(var n=0,i=e;n<i.length;n++){var s=i[n];if(M(s))switch(this._getType(s)){case G.Merged:t.push(s);break;case G.Instanced:r.push(s);break;case G.Preinterleaved:a.push(s)}}},e.prototype._performUpdates=function(e,t){for(var r=0,a=e;r<a.length;r++){var n=a[r],i=n.updateType,s=n.renderGeometry,o=this._getType(s)===G.Merged;if(M(s)){if(2&i&&this._updateFaceranges(s,t),32&i){var d=this._getInstance(s);d&&this._updateHighlightFaceranges(s,d.instance)}4&i||o&&16&i?this._updateVertexAttributes(s,!o):!o&&16&i&&this._updateInstanceTransformation(s)}}},e.prototype._updateFaceranges=function(e,t){var r,a=e.material,n=a.id,i=e.origin.id,s=this._getType(e);if(s===G.Preinterleaved){var o=this._getOriginData(s,n,i);r=o.instances.get(e.uniqueName).instance}else{var o=this._getOriginData(s,n,i);r=o.instances.get(e.uniqueName),r&&s===G.Merged&&(t[this._modifiedMergedFacerangesKey(n,i)]=o)}r&&(r.displayedIndexRange=w(e),this._updateHighlightFaceranges(e,r))},e.prototype._updateHighlightFaceranges=function(e,t){if(t){var r=t.highlightedIndexRange,a=H(e);t.highlightedIndexRange=a,a&&!r?this._addHighlight(e):!a&&r&&this._removeHighlight(e)}},e.prototype._updateMergedFaceranges=function(e){for(var t in e)!function(t){var r=e[t];r.displayedIndexRange=[];var a=!0;r.instances.forEach(function(e){e.displayedIndexRange?(r.displayedIndexRange.push.apply(r.displayedIndexRange,f.offsetIntervals(e.displayedIndexRange,e.from)),a=!1):r.displayedIndexRange.push([e.from,e.to-1])}),r.displayedIndexRange=a?null:f.mergeIntervals(r.displayedIndexRange)}(t)},e.prototype._updateVertexAttributes=function(e,t){var r=e.material,a=r.bufferWriter,n=r.id,i=e.origin.id,s=a.vertexBufferLayout.stride/4,o=this._getType(e);if(o===G.Preinterleaved)return void console.error("Updating Preinterleaved geometry not supported");var d,l,h=this._getOriginData(o,n,i),f=h.instances.get(e.uniqueName),g=h.buffer.getArray(),u=h.vao;t||(T(e,L,q),d=L,l=q),a.write({transformation:d,invTranspTransformation:l},e.data,e.instanceParameters,a.vertexBufferLayout.createView(g.buffer),f.from),v.assert(f.from+a.elementCount(e.data)===f.to,"material VBO layout has changed"),u.vertexBuffers.geometry.setSubData(g,f.from*s*4,f.from*s*4,f.to*s*4)},e.prototype._updateInstanceTransformation=function(e){var t=this._getType(e),r=e.material.id,a=e.origin.id;if(t===G.Preinterleaved){var n=this._getOriginData(t,r,a),i=n.instances.get(e.uniqueName).instance;T(e,i.transformation,i.transformationNormal)}else{var n=this._getOriginData(t,r,a),i=n.instances.get(e.uniqueName),s=n.perGeometryDataInfo[e.data.id],o=s.instanceBufferData;if(T(e,i.transformation,i.transformationNormal),o){var d=o.getSlot(e.idx);o.fill(d,0,i.transformation),o.fill(d,16,i.transformationNormal);var l=o.getOffset(d),h=4*l,f=P.getStride(s.vao.layout.instance);s.vao.vertexBuffers.instance.setSubData(o.getArray(),h,h,h+f)}}},e.prototype._modifyMerged=function(e,t,r,a){var n=this._compMatToDelta(e,t,G.Merged),i=this._mat2DataMerged;for(var s in n){var o=n[s];for(var d in o){var l=o[d],h=l.optimalCount,f=l.sparseCount,g=l.material,u=g.bufferWriter,p=u.vertexBufferLayout,c=p.stride/4,m=i[s];null==m&&(v.assert(h>0),m=this._initializeMatData(g),i[s]=m,this._orderedRendering&&this._insertIntoRenderOrder(m,g.renderPriority,"merged"));var _=m.origin2data.get(d);null==_&&(v.assert(h>0),_=this._createMergedData(p,h,l.origin),m.origin2data.set(d,_));if(0===h)_.vao.dispose(!0),_.vao=null,m.origin2data.delete(d),0===m.origin2data.size&&(r.push(s),delete i[s],this._orderedRendering&&this._removeFromRenderOrder(m,"merged"));else{var y=h<l.sparseCount/2,b=y?h:f,x=F,D=_.buffer.getSize(),R=_.buffer.getArray(),I=_.buffer.resize(b);y||I?this._rebuildMerged(_,l.toRemove,c,R,x):l.toRemove.length>0?(this._removeMergedByErasing(_,l.toRemove,c,x),l.toAdd.length>0&&(x.end=D)):(x.begin=D,x.end=D);var P=E;v.setMatrixTranslation3(P,-l.origin[0],-l.origin[1],-l.origin[2]),this._appendMerged(_,g,l.toAdd,c,P,x);var C=_.vao.vertexBuffers.geometry;if(C.byteSize!==_.buffer.getArray().buffer.byteLength)C.setData(_.buffer.getArray());else{var w=x.begin,H=x.end;if(w<H){var T=_.buffer.getArray(),O=4*w,M=4*H;C.setSubData(T,O,O,M)}}(x.updatedDisplayedIndexRange||_.displayedIndexRange)&&(a[this._modifiedMergedFacerangesKey(s,d)]=_)}}}},e.prototype._createMergedData=function(e,t,r){return{type:G.Merged,instances:new Map,vao:new C(this._rctx,s.Default3D,{geometry:n.glLayout(e)},{geometry:D.createVertex(this._rctx,35044)}),buffer:new o(t),optimalCount:0,origin:r}},e.prototype._rebuildMerged=function(e,t,r,a,n){for(var i=0;i<t.length;++i){var s=e.instances.get(t[i].uniqueName);e.optimalCount-=(s.to-s.from)*r,e.instances.delete(t[i].uniqueName)}var o=0,d=e.buffer.getArray();n.begin=0,n.end=0;var l=-1,h=-1,f=0;e.instances.forEach(function(e){var t=e.from*r,n=e.to*r,i=n-t;l!==h&&h!==t?(d.set(a.subarray(l,h),f),f+=h-l,l=t):-1===l&&(l=t),h=n,e.from=o/r,o+=i,e.to=o/r}),l!==h&&d.set(a.subarray(l,h),f),n.end=o},e.prototype._removeMergedByErasing=function(e,t,r,a){if(0!==t.length){a.begin=1/0,a.end=-1/0;for(var n=-1,i=-1,s=0,o=t;s<o.length;s++){var d=o[s],l=d.uniqueName,h=e.instances.get(l),f=h.from*r,g=h.to*r;n!==i&&i!==f?(e.buffer.erase(n,i),n=f):-1===n&&(n=f),i=g,e.instances.delete(l),e.optimalCount-=g-f,f<a.begin&&(a.begin=f),g>a.end&&(a.end=g)}n!==i&&e.buffer.erase(n,i)}},e.prototype._appendMerged=function(e,t,r,n,i,s){s.updatedDisplayedIndexRange=!1;for(var o=t.bufferWriter,d=0,l=r;d<l.length;d++){var h=l[d],f=h.data;a.mat4.multiply(L,i,h.transformation),a.mat4.invert(q,L),a.mat4.transpose(q,q);var g=s.end;o.write({transformation:L,invTranspTransformation:q},f,h.instanceParameters,o.vertexBufferLayout.createView(e.buffer.getArray().buffer),s.end/n);var u=o.elementCount(f)*n,p=g+u;v.assert(null==e.instances.get(h.uniqueName));var c=w(h),m=new U(h.name,g/n,p/n,c,void 0,void 0,h.idx);e.instances.set(h.uniqueName,m),this._updateHighlightFaceranges(h,m),c&&(s.updatedDisplayedIndexRange=!0),e.optimalCount+=u,s.end+=u}},e.prototype._modifyInstanced=function(e,t,r){var i=this._rctx,d=G.Instanced,l=this._compMatToDelta(e,t,d),f=this._mat2DataInstanced;for(var g in l){var u=l[g],p=this;for(var c in u)!function(e){var t=u[e];if(0===t.optimalCount){var l=f[g];return l.origin2data.get(e).vao.dispose(!0),l.origin2data.delete(e),0===l.origin2data.size&&(r.push(g),delete f[g],p._orderedRendering&&p._removeFromRenderOrder(l,"instanced")),"continue"}var c=t.material,m=c.bufferWriter,_=f[g];if(null==_){var y=c.renderPriority;_=p._initializeMatData(c),f[g]=_,p._orderedRendering&&p._insertIntoRenderOrder(_,y,"instanced")}var b=m.vertexBufferLayout,x=_[0].instanced?m.instanceBufferLayout:void 0,R=x&&x.fields.get("instanceColor"),I=x&&x.fields.get("instanceFeatureAttribute"),P=b.stride/4,H=_.origin2data.get(e);null==H&&(H={type:d,instances:new Map,vao:new C(i,s.Default3D,{geometry:n.glLayout(b)},{geometry:D.createVertex(i,35044)}),buffer:new o(t.optimalCount),optimalCount:0,perGeometryDataInfo:{},origin:t.origin},
_.origin2data.set(e,H));var T=H.buffer.getSize(),O=H.buffer.getArray(),M=t.optimalCount<t.sparseCount/2,S=H.buffer.resize(M?t.optimalCount:t.sparseCount);for(var V in t.perGeometryDelta){var A=H.perGeometryDataInfo[V];if(A&&A.instanceBufferData){var B=t.perGeometryDelta[V].removeCount;B>0&&A.instanceBufferData.prepareFree(B)}}var G=t.toRemove;if(M||S){for(var N=0;N<G.length;++N){var F=G[N];H.instances.delete(F.uniqueName);var V=F.data.id,A=H.perGeometryDataInfo[V],z=A;0==--z.refCount&&null==t.dataId2refCount[V]?(H.optimalCount-=(z.to-z.from)*P,delete H.perGeometryDataInfo[V]):A.instanceBufferData&&A.instanceBufferData.free(F.idx)}T=0;var L=H.buffer.getArray(),q={};for(var k in H.perGeometryDataInfo){var z=H.perGeometryDataInfo[k];v.assert(null==q[z.from]),q[z.from]=z}for(var j in q){var z=q[j],W=z.from*P,K=z.to*P;L.set(O.subarray(W,K),T),z.from=T/P,T+=K-W,z.to=T/P}H.instances.forEach(function(e){e.from=H.perGeometryDataInfo[e.dataId].from,e.to=H.perGeometryDataInfo[e.dataId].to})}else for(var N=0;N<G.length;++N){var F=G[N];H.instances.delete(F.uniqueName);var V=F.data.id,A=H.perGeometryDataInfo[V];if(0==--A.refCount&&null==t.dataId2refCount[V]){var W=A.from*P,K=A.to*P;H.buffer.erase(W,K),H.optimalCount-=K-W,delete H.perGeometryDataInfo[V]}else A.instanceBufferData&&A.instanceBufferData.free(F.idx)}v.setMatrixTranslation3(E,-t.origin[0],-t.origin[1],-t.origin[2]);for(var V in t.perGeometryDelta){var A=H.perGeometryDataInfo[V];if(A&&A.instanceBufferData){var Y=t.perGeometryDelta[V].addCount;Y>0&&A.instanceBufferData.prepareAllocate(Y)}}for(var J=t.toAdd,N=0;N<J.length;++N){var F=J[N],Q=F.data,V=Q.id,A=H.perGeometryDataInfo[V];if(null==A){m.write({},Q,void 0,m.vertexBufferLayout.createView(H.buffer.getArray().buffer),T/P);var X=m.elementCount(Q)*P,W=T/P;T+=X;var K=T/P;if(H.optimalCount+=X,A={refCount:1,from:W,to:K,vao:null,instanceBufferData:null},x){var Z=x.stride/4;A.vao=new C(i,s.Default3D,{geometry:n.glLayout(b),instance:n.glLayout(x,{divisor:1})},{geometry:H.vao.vertexBuffers.geometry,instance:D.createVertex(i,35044)}),A.instanceBufferData=new h(Z,t.perGeometryDelta[V].addCount)}H.perGeometryDataInfo[V]=A}else++A.refCount;v.assert(A.from*P<=H.buffer.getSize()&&A.to*P<=H.buffer.getSize());var $=a.mat4f64.create();a.mat4.multiply($,E,F.transformation);var ee=w(F),te=new U(F.name,A.from,A.to,ee,$,F.instanceParameters,F.idx,V);H.instances.set(F.uniqueName,te),p._updateHighlightFaceranges(F,te);var re=A.instanceBufferData;if(re){var ae=re.allocate(F.idx);re.fill(ae,0,te.transformation),re.fill(ae,16,te.transformationNormal),R&&re.fill(ae,R.offset/4,F.instanceParameters.color),I&&re.fill(ae,I.offset/4,F.instanceParameters.featureAttribute)}}v.assert(H.optimalCount===t.optimalCount);var ne=new Float32Array(H.buffer.getArray().buffer,0,H.buffer.getSize());H.vao.vertexBuffers.geometry.setData(ne);for(var V in H.perGeometryDataInfo){var ie=H.perGeometryDataInfo[V];if(ie.vao){var se=ie.vao.vertexBuffers.instance;if(se){var oe=t.perGeometryDelta[V];if(oe.addCount+oe.removeCount>0){var de=ie.instanceBufferData.compact();se.setData(de)}}}}}(c)}},e.prototype._modifyPreinterleaved=function(e,t,r){for(var i=this._rctx,o=G.Preinterleaved,d=this._mat2DataPreinterleaved,l=0,h=e;l<h.length;l++){var f=h[l],g=f.material,u=g.bufferWriter,p=g.id,c=f.origin.id,m=f.origin.vec3,_=d[p];null==_&&(_=this._initializeMatData(g),d[p]=_);var y=_.origin2data.get(c);null==y&&(y={type:o,origin:m,count:0,instances:new Map},_.origin2data.set(c,y)),v.setMatrixTranslation3(E,-m[0],-m[1],-m[2]);var b=a.mat4f64.create();a.mat4.multiply(b,E,f.transformation);var x=w(f),R=f.data;if(R.preinterleaved)if(null!=R.vertexData){var I=R.indexCount,P=R.id,H=new U(f.name,0,I,x,b,f.instanceParameters,f.idx,P),T=R.indexData?D.createIndex(i,35044,R.indexData):null,O=u.vertexBufferLayout,M=new C(i,s.Default3D,{geometry:n.glLayout(O)},{geometry:D.createVertex(i,35044)},T);M.vertexBuffers.geometry.setData(R.vertexData),R.indexData=null,R.vertexData=null,y.count+=1,y.instances.set(f.uniqueName,{instance:H,vao:M}),this._updateHighlightFaceranges(f,H)}else v.assert(!1,"Trying to re-add preinterleaved geometry data which is no longer available.");else v.assert(!1,"Non-interleaved render geometry processed as pre-interleaved")}for(var S=0,V=t;S<V.length;S++){var f=V[S],A=f.origin,g=f.material,p=g.id,c=A.id,B=f.uniqueName,_=d[p],N=_.origin2data.get(c);N.instances.get(B).vao.dispose(),N.instances.delete(B),N.count-=1,0===N.count&&_.origin2data.delete(c),0===_.origin2data.size&&(r.push(p),delete d[p])}},e.prototype._compMatToDelta=function(e,t,r){var a={};return this._updateMatToDelta(e,!0,r,a),this._updateMatToDelta(t,!1,r,a),a},e.prototype._updateMatToDelta=function(e,t,r,a){for(var n=r===G.Instanced,i=0,s=e;i<s.length;i++){var o=s[i],d=o.origin,l=o.material,h=l.bufferWriter,f=l.id,g=n?this._mat2DataInstanced[f]:this._mat2DataMerged[f],u=g&&g.origin2data.get(d.id),p=a[f];null==p&&(p={},a[f]=p);var c=p[d.id];if(null==c){if(c={optimalCount:null==u?0:u.optimalCount,sparseCount:null==u?0:u.buffer.getSize(),material:l,toAdd:[],toRemove:[],perGeometryDelta:null,origin:d.vec3},n){var m={};if(void 0!==u)for(var _ in u.perGeometryDataInfo)m[_]=u.perGeometryDataInfo[_].refCount;c.dataId2refCount=m,c.perGeometryDelta={}}p[d.id]=c}var v=h.vertexBufferLayout.stride/4,y=h.elementCount(o.data)*v;if(n){var b=o.data.id,x=c.perGeometryDelta[b];x||(x={addCount:0,removeCount:0},c.perGeometryDelta[b]=x),t?(x.addCount++,null==c.dataId2refCount[b]&&(c.dataId2refCount[b]=0),1==++c.dataId2refCount[b]&&(c.optimalCount+=y,c.sparseCount+=y),c.toAdd.push(o)):(x.removeCount++,0==--c.dataId2refCount[b]&&(delete c.dataId2refCount[b],c.optimalCount-=y),c.toRemove.push(o))}else t?(c.optimalCount+=y,c.sparseCount+=y,c.toAdd.push(o)):(c.optimalCount-=y,c.toRemove.push(o))}},e.prototype._getType=function(e){if(e.data.preinterleaved)return G.Preinterleaved;var t=!1,r=S(e.data);return t=t||!1===e.material.canBeMerged,t=t||e.material.instanced,t=t||!0===e.material.renderOccluded,e.singleUse||(t=t||r>this._threshold),t?G.Instanced:G.Merged},e.prototype._getTargetMat2Data=function(e){switch(e){case G.Merged:return this._mat2DataMerged;case G.Instanced:return this._mat2DataInstanced;case G.Preinterleaved:return this._mat2DataPreinterleaved}},e.prototype._getOriginData=function(e,t,r){return this._getTargetMat2Data(e)[t].origin2data.get(r)},e.prototype._modifiedMergedFacerangesKey=function(e,t){return e+"_"+t},e.prototype._insertIntoRenderOrder=function(e,t,r){for(var a=e[0].materialId,n=this._renderOrder.length,i=0;i<n&&this._renderOrder[i][0]>=t;){var s=this._renderOrder[i][1];if(s.id===a)return v.assert(!s[r],"matData for type already exists"),void(s[r]=e);i++}var o={id:a,instanced:null,merged:null};o[r]=e,this._renderOrder.splice(i,0,[t,o])},e.prototype._removeFromRenderOrder=function(e,t){for(var r=e[0].materialId,a=0;this._renderOrder[a][1].id!==r;)a++;var n=this._renderOrder[a][1];n[t]=null,n.instanced||n.merged||this._renderOrder.splice(a,1)},e.prototype._sortHighlightsByRenderOrder=function(){this._highlights.sort(function(e,t){var r=e.matData[0].renderPriority,a=t.matData[0].renderPriority;return r>a?-1:a>r?1:0})},e.prototype._updateRenderOrder=function(e,t){for(var r=t.length,a=0;a<r&&t[a][1].id!==e;)a++;if(a<r){var n=t[a][1],i=n.merged||n.instanced,s=i[0].renderPriority,o=t[a][0];if(s!==t[a][0]){t[a][0]=s;var d=s>o?-1:1;for(a+=d;a>-1&&a<r&&d*t[a][0]>d*s;){var l=t[a];t[a]=t[a-d],t[a-d]=l,a+=d}}}},e.prototype._modifyMaterials=function(e){var t=this;e.forEach(function(e){t._materialRep.updateMaterialParameters(e)})},e.prototype.modifyRenderOrder=function(e){var t=this;this._orderedRendering&&(e.forEach(function(e){t._updateRenderOrder(e,t._renderOrder)}),this._sortHighlightsByRenderOrder(),this._needsRender=!0)},e.prototype._initializeMatData=function(e){var t={origin2data:new Map};return t[0]=this._materialRep.aquire(e),t[3]=this._materialRep.aquireDepthShadowMap(e),t[2]=this._materialRep.aquireNormal(e),t[1]=this._materialRep.aquireDepth(e),t[4]=this._materialRep.aquireHighlight(e),t},e.prototype._releaseMaterials=function(e){if(Array.isArray(e))for(var t=e,r=0;r<t.length;r++)this._materialRep.release(t[r]),this._materialRep.releaseDepthShadowMap(t[r]),this._materialRep.releaseNormal(t[r]),this._materialRep.releaseDepth(t[r]),this._materialRep.releaseHighlight(t[r]);else this._materialRep.release(e),this._materialRep.releaseDepthShadowMap(e),this._materialRep.releaseNormal(e),this._materialRep.releaseDepth(e),this._materialRep.releaseHighlight(e)},e.prototype._getInstance=function(e){var t=e.material,r=e.uniqueName,a=t.id,n=this._getType(e),i=this._getTargetMat2Data(n),s=e.origin.id,o=i[a];if(!o)return null;var d=o.origin2data.get(s);if(!d)return null;var l;return l=d.type===G.Preinterleaved?d.instances.get(r).instance:d.instances.get(r),l?{type:n,uniqueName:r,instance:l,matData:o,originData:d,instancedVAO:null,instancedVAOBaseInstance:null}:null},e.prototype._createBaseInstanceVAO=function(e){var t=this._rctx,r=e.instance,a=e.originData;if(e.type===G.Instanced&&a.perGeometryDataInfo){var n=a.perGeometryDataInfo[r.dataId],i=n.instanceBufferData;if(i){var s=n.vao,o=i.getSlot(r.idx);if(e.instancedVAOBaseInstance!==o){var d=P.setBaseInstanceOffset(s.layout,o);e.instancedVAO=new C(t,s.locations,d,s.vertexBuffers,s.indexBuffer),e.instancedVAOBaseInstance=o}}}},e.prototype._updateHighlightVAOs=function(){for(var e=0;e<this._highlights.length;++e){var t=this._highlights[e];this._createBaseInstanceVAO(t)}},e.prototype._getFallbackDepthTexture=function(){return this._fallbackDepthStencilTexture||(this._fallbackDepthStencilTexture=new I(this._rctx,{target:3553,pixelFormat:6408,dataType:5121,samplingMode:9728,width:1,height:1},new Uint8Array([255,255,255,255]))),this._fallbackDepthStencilTexture},e}();!function(e){var t=function(){function e(){this.reset()}return e.prototype.reset=function(){this.trianglesRendered=0,this.drawCallsInstanced=0,this.drawCallsAngleInstanced=0,this.drawCallsMerged=0,this.drawCallsPreinterleaved=0,this.drawCallsFragmented=0,this.drawCallsHighlight=0,this.instancesDrawnAngle=0,this.VBOallocatedSize=0,this.VBOoptimalSize=0,this.VBOusedSize=0},e}();e.RenderStats=t}(B||(B={}));var G,N=B.RenderStats,U=function(){function e(e,t,r,n,i,s,o,d){this.name=e,this.from=t,this.to=r,this.displayedIndexRange=n,this.transformation=i,this.instanceParameters=s,this.idx=o,this.dataId=d,null!=i&&(this.transformationNormal=a.mat4f64.create(),a.mat4.copy(this.transformationNormal,i),a.mat4.invert(this.transformationNormal,this.transformationNormal),a.mat4.transpose(this.transformationNormal,this.transformationNormal))}return e}();!function(e){e[e.Merged=0]="Merged",e[e.Instanced=1]="Instanced",e[e.Preinterleaved=2]="Preinterleaved"}(G||(G={}));var F={updatedDisplayedIndexRange:!1,begin:0,end:0},z=a.vec2f64.create(),E=a.mat4f64.create(),L=a.mat4f64.create(),q=a.mat4f64.create();return B});