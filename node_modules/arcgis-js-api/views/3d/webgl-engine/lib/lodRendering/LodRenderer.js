// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.10/esri/copyright.txt for details.

define(["require","exports","../../../../../core/tsSupport/extendsHelper","../../../../../core/libs/gl-matrix-2/gl-matrix","../../../../../geometry/support/aaBoundingBox","../../../support/debugFlags","../../../support/buffer/glUtil","../Camera","../DefaultVertexAttributeLocations","./InstanceData","./InstanceOctree","./LevelSelector","./RenderInstanceData","./utils","../../materials/DefaultMaterial","../../materials/internal/MaterialUtil","../../../../webgl/BufferObject","../../../../webgl/Util","../../../../webgl/VertexArrayObject"],function(e,t,n,a,r,i,s,o,l,c,u,d,h,f,p,g,v,b,m){function y(e){D=e}function _(e,t,n,a){f.encodeDoubleVec3(e.modelOrigin,t,n.modelOriginHi,n.modelOriginLo,a),n.model.copyFrom(a,e.model,t),n.modelNormal.copyFrom(a,e.modelNormal,t),e.color&&n.color&&n.color.copyFrom(a,e.color,t),e.featureAttribute&&n.featureAttribute&&n.featureAttribute.copyFrom(a,e.featureAttribute,t)}Object.defineProperty(t,"__esModule",{value:!0});var I=b.assert,D=function(e){var t=e.baseBoundingSphere.radius,n=e.levels.map(function(e){return e.minScreenSpaceRadius});return new d.LevelSelector(t,n)};t.setLevelSelectorFactory=y;var R=function(){function e(e,t){this.glMaterials={};var n=e.rctx,a=t.geometry,r=t.material,i=a.data.toRenderData();this.materialRep=e.materialRep,r.setParameterValues({instancedDoublePrecision:!0});var o=r.bufferWriter,c=o.vertexBufferLayout,u=o.elementCount(i),d=o.allocate(u);o.write({},i,void 0,d,0),this.geometry=a,this.material=r,this.glMaterials=f.acquireGLMaterials(r,this.materialRep),this.vertexBufferLayout=c,this.vbo=v.createVertex(n,35044,d.buffer),this.vao=new m(n,l.Default3D,{geometry:s.glLayout(c)},{geometry:this.vbo}),this.vertexCount=u}return e.prototype.destroy=function(){f.releaseGLMaterials(this.material,this.materialRep),this.vbo.dispose(),this.vao.dispose()},Object.defineProperty(e.prototype,"boundingInfo",{get:function(){return this.geometry.boundingInfo},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"triangleCount",{get:function(){return this.vertexCount/3},enumerable:!0,configurable:!0}),e.prototype.intersect=function(e,t,n,a,r,i){var s=this.geometry.id,o=r.toString();this.material.intersect(this.geometry,null,e.transform,e,n,a,function(n,a,l,c,u,d){if(n>=0){if(null!=t&&!t(e.p0,e.p1,n))return;var h={type:"external",metadata:i(r)};(null==e.minResult.priority||c>=e.minResult.priority)&&(null==e.minResult.dist||n<e.minResult.dist)&&(e.minResult.set(h,o,n,a,e.transform,c,null,s,l),e.minResult.setIntersector("LodRenderer")),(null==e.maxResult.priority||c>=e.maxResult.priority)&&(null==e.maxResult.dist||n>e.maxResult.dist)&&(e.maxResult.set(h,o,n,a,e.transform,c,null,s,l),e.minResult.setIntersector("LodRenderer"))}},null)},e}();t.LodComponentData=R;var C=function(){function e(e,t){var n=this;this.components=[],this.minScreenSpaceRadius=t.minScreenSpaceRadius,t.components.forEach(function(t){n.components.push(new R(e,t))})}return e.prototype.destroy=function(){this.components.forEach(function(e){e.destroy()})},e.prototype.intersect=function(e,t,n,a,r,i){this.components.forEach(function(s){s.intersect(e,t,n,a,r,i)})},Object.defineProperty(e.prototype,"boundingBox",{get:function(){if(!this._boundingBox){var e=r.empty();this.components.forEach(function(t){r.expand(e,t.boundingInfo.bbMin),r.expand(e,t.boundingInfo.bbMax)}),this._boundingBox=e}return this._boundingBox},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"boundingSphere",{get:function(){if(!this._boundingSphere){var e=this.boundingBox,t=a.vec3f64.create();r.center(e,t),this._boundingSphere={center:t,radius:.5*r.diameter(e)}}return this._boundingSphere},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"triangleCount",{get:function(){return this.components.reduce(function(e,t){return e+t.triangleCount},0)},enumerable:!0,configurable:!0}),e}();t.LodLevelData=C;var x=function(){function e(e,n,a,r){var i=this;this._levels=[],this._renderInstanceData=[],this._highlightRenderInstanceData=[],this._instanceIndex=0,this._slicePlaneEnabled=!1,this._enableLevelSelection=!0,this._lastCamera=new o,this._updateCyclesWithStaticCamera=-1,this._needFullCycle=!1,this.didRender=!1,this._symbol=e,this._optionalFields=n,this._instanceToMetadata=a,this._instanceBufferLayout=p.getInstanceBufferLayout({instancedDoublePrecision:!0,instanced:n}),this._glInstanceBufferLayout=s.glLayout(this._instanceBufferLayout,{divisor:1}),this._instanceData=new c.InstanceData(this._optionalFields,r),this._instanceData.on("instance-added",function(e){i.requestUpdateCycle()}),this._instanceData.on("instance-removed",function(e){i.requestUpdateCycle()}),this._instanceData.on("instance-transform-changed",function(e){i.requestUpdateCycle()}),this._instanceData.on("instance-visibility-changed",function(e){i.requestUpdateCycle(!0)}),this._instanceData.on("instance-highlight-changed",function(e){i.requestUpdateCycle(!0)}),this._enableLevelSelection=this._symbol.levels.length>1,t.lodRenderers.push(this)}return e.prototype.destroy=function(){t.lodRenderers.splice(t.lodRenderers.indexOf(this),1)},Object.defineProperty(e.prototype,"levels",{get:function(){return this._levels},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"baseBoundingBox",{get:function(){return this._levels[this._levels.length-1].boundingBox},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"baseBoundingSphere",{get:function(){return this._levels[this._levels.length-1].boundingSphere},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"baseMaterial",{get:function(){return this._levels[this._levels.length-1].components[0].material},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"slicePlaneEnabled",{get:function(){return this._slicePlaneEnabled},set:function(e){this._slicePlaneEnabled=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"instanceData",{get:function(){return this._instanceData},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"memoryUsage",{get:function(){var e={cpu:0,gpu:0};return this._renderInstanceData.forEach(function(t){var n=t.memoryUsage;e.cpu+=n.cpu,e.gpu+=n.gpu}),this._highlightRenderInstanceData.forEach(function(t){var n=t.memoryUsage;e.cpu+=n.cpu,e.gpu+=n.gpu}),e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"renderStats",{get:function(){var e=this,t=this._instanceData.size,n=[];return this._levels.forEach(function(t,a){var r=e._renderInstanceData[a],i=e._highlightRenderInstanceData[a],s=r.size+i.size,o=t.triangleCount;n.push({renderedInstances:s,renderedTriangles:s*o,trianglesPerInstance:o})}),{totalInstances:t,renderedInstances:n.reduce(function(e,t){return e+t.renderedInstances},0),renderedTriangles:n.reduce(function(e,t){return e+t.renderedTriangles},0),levels:n}},enumerable:!0,configurable:!0}),e.prototype.initializeRenderContext=function(e){var t=this,n=e.rctx;this._symbol.levels.forEach(function(a){t._levels.push(new C(e,a)),t._renderInstanceData.push(new h.RenderInstanceData(n,t._instanceBufferLayout)),t._highlightRenderInstanceData.push(new h.RenderInstanceData(n,t._instanceBufferLayout))}),this._levelSelector=D(this)},e.prototype.uninitializeRenderContext=function(e){this._levels.forEach(function(e){e.destroy()}),this._renderInstanceData.forEach(function(e){e.destroy()}),this._highlightRenderInstanceData.forEach(function(e){e.destroy()})},Object.defineProperty(e.prototype,"slots",{get:function(){return[5,7]},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"needsHighlight",{get:function(){return this._highlightRenderInstanceData.reduce(function(e,t){return e+t.size},0)>0},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"needsRender",{get:function(){return this.needsUpdates()},enumerable:!0,configurable:!0}),e.prototype.resetNeedsRender=function(){this.didRender&&(this.didRender=!1)},e.prototype.prepareRender=function(e){this.runUpdates(e)},e.prototype.render=function(e){var t=e.rctx,n=5===e.slot?4:7===e.slot?6:null;if(n){if(!this.baseMaterial.isVisible())return!1;var a={view:e.camera.viewMatrix,proj:e.camera.projectionMatrix,origin:[0,0,0],viewInvTransp:e.camera.viewInverseTransposeMatrix,lightingData:e.lightingData,viewport:e.camera.viewport,fovY:e.camera.fovY,nearFar:[e.camera.near,e.camera.far],framebufferTex:e.offscreenRenderingHelper?e.offscreenRenderingHelper.colorTexture:null,shadowMap:e.shadowMap,shadowMappingEnabled:!!e.shadowMap&&e.shadowMap.enabled,ssaoEnabled:!!e.ssaoHelper&&e.ssaoHelper.enabled,pixelRatio:e.pixelRatio,slicePlane:e.sliceHelper&&e.sliceHelper.plane,cameraAboveGround:e.camera.aboveGround,hudVisibilityTexture:e.offscreenRenderingHelper?e.offscreenRenderingHelper.hudVisibilityTexture:null};t.bindVAO();for(var r=0;r<this._levels.length;++r){var i=e.isHighlightPass?this._highlightRenderInstanceData[r]:this._renderInstanceData[r];this.renderLevel(e,n,a,i,r)}return!0}},e.prototype.intersect=function(e,t,n,r,i){var s=this;if(this.baseMaterial.isVisible()){var o=a.vec3f64.create();a.vec3.subtract(o,r,n);var l=function(i){s._instanceData.getCombinedModelTransform(i,L),e.setTransform(L),a.vec3.transformMat4(O,n,e.transformInverse),a.vec3.transformMat4(T,r,e.transformInverse);var o=s._instanceData.getState(i),l=s._instanceData.getLodLevel(i);I(o&c.StateFlags.ACTIVE,"invalid instance state"),I(l>=0&&l<s._levels.length,"invaid lod level"),s._levels[l].intersect(e,t,O,T,i,s._instanceToMetadata)};this.baseMaterial.getParameterValues().verticalOffset?this.octree.forEach(l):this.octree.forEachAlongRay(n,o,l)}},e.prototype.queryDepthRange=function(e){return this.queryDepthRangeOctree(e)},e.prototype.notifyShaderTransformationChanged=function(){this.invalidateOctree()},e.prototype.requestUpdateCycle=function(e){void 0===e&&(e=!1),this._updateCyclesWithStaticCamera=-1,e&&(this._needFullCycle=!0)},e.prototype.needsUpdates=function(){return this._instanceData.size>0&&this._updateCyclesWithStaticCamera<1},e.prototype.runUpdates=function(e){if(!i.LOD_INSTANCE_RENDERER_DISABLE_UPDATES){if(this._enableLevelSelection){var t=e.equivalent(this._lastCamera);this._lastCamera.copyFrom(e),t||this.requestUpdateCycle()}var n=this._needFullCycle?this._instanceData.size:2e3;this._needFullCycle=!1,this.updateInstances(e,n)}},Object.defineProperty(e.prototype,"octree",{get:function(){return this._octree||(this._octree=this.buildOctree()),this._octree},enumerable:!0,configurable:!0}),e.prototype.invalidateOctree=function(){this._octree=null},e.prototype.buildOctree=function(){for(var e=new u.InstanceOctree(this._instanceData,this.baseBoundingSphere),t=this._instanceData,n=t.view?t.view.state:null,a=0;a<this._instanceData.capacity;++a){n.get(a)&c.StateFlags.ACTIVE&&e.addInstance(a)}return e},e.prototype.queryDepthRangeOctree=function(e){var t=e.eye,n=e.viewForward,r=this.octree.findClosest(n,"front-to-back",e.frustum),i=this.octree.findClosest(n,"back-to-front",e.frustum);if(null!=r&&null!=i){this._instanceData.view.boundingSphere.getVec(r,E),a.vec3.subtract(E,E,t);var s=a.vec3.dot(E,n)-E[3];this._instanceData.view.boundingSphere.getVec(i,E),a.vec3.subtract(E,E,t);var o=a.vec3.dot(E,n)+E[3];return{near:Math.max(e.near,s),far:Math.min(e.far,o)}}return{near:1/0,far:-1/0}},e.prototype.startUpdateCycle=function(){this._updateCyclesWithStaticCamera++,this._renderInstanceData.forEach(function(e){e.startUpdateCylce()}),this._highlightRenderInstanceData.forEach(function(e){e.startUpdateCylce()})},e.prototype.updateInstances=function(e,t){var n=this._enableLevelSelection,a=this._levelSelector;a.updateCamera(e),this._renderInstanceData.forEach(function(e){e.beginUpdate()}),this._highlightRenderInstanceData.forEach(function(e){e.beginUpdate()});var r=this._instanceData,i=this._instanceData.view,s=r.size,o=r.capacity,l=this._instanceIndex;t=Math.min(s,t);for(var u=0;u<t;++u){0===l&&this.startUpdateCycle();var d=i.state.get(l),h=0;if(d&c.StateFlags.ALLOCATED){var f=i.lodLevel.get(l);if(d&c.StateFlags.ACTIVE&&this._renderInstanceData[f].freeTail(),d&c.StateFlags.HIGHLIGHT_ACTIVE&&this._highlightRenderInstanceData[f].freeTail(),d&c.StateFlags.REMOVE)r.freeInstance(l);else if(d&c.StateFlags.VISIBLE){var p=0;if(n&&(i.modelOrigin.getVec(l,S),p=a.selectLevel(S,r.getCombinedScaleFactor(l))),h=d&~(c.StateFlags.ACTIVE|c.StateFlags.HIGHLIGHT_ACTIVE|c.StateFlags.TRANSFORM_CHANGED),p>=0){var g=this._renderInstanceData[p],v=g.allocateHead();if(_(i,l,g.view,v),h|=c.StateFlags.ACTIVE,d&c.StateFlags.HIGHLIGHT){var b=this._highlightRenderInstanceData[p],m=b.allocateHead();_(i,l,b.view,m),h|=c.StateFlags.HIGHLIGHT_ACTIVE}}i.state.set(l,h),i.lodLevel.set(l,p)}else h=d&~(c.StateFlags.ACTIVE|c.StateFlags.HIGHLIGHT_ACTIVE|c.StateFlags.TRANSFORM_CHANGED),i.state.set(l,h);if(this._octree){var y=!!(d&c.StateFlags.ACTIVE),I=!!(h&c.StateFlags.ACTIVE);!y&&I?this._octree.addInstance(l):y&&!I?this._octree.removeInstance(l):y&&I&&d&c.StateFlags.TRANSFORM_CHANGED&&(this._octree.removeInstance(l),this._octree.addInstance(l))}l=(l+1)%o}else l=(l+1)%o,t++}this._instanceIndex=l,this._renderInstanceData.forEach(function(e){e.endUpdate()}),this._highlightRenderInstanceData.forEach(function(e){e.endUpdate()})},e.prototype.renderLevel=function(e,t,n,a,r){var i=this;this._levels[r].components.forEach(function(s){i.renderComponent(e,t,n,a,s,r)})},e.prototype.renderComponent=function(e,t,n,a,r,s){var o=r.glMaterials[e.pass];if(o&&o.beginSlot(t)&&o.isVisible&&0!==a.size){var c=e.rctx,u=c.capabilities.instancing,d=o.getDrawMode();n.origin=[0,0,0],2===t&&(e.stencilRenderingHelper.enabled=!0,e.stencilRenderingHelper.prepareStencilWritePass()),o.bind(c,n),c.bindVAO(r.vao);var h=o.getProgram();if(b.assertCompatibleVertexAttributeLocations(r.vao,h),e.isHighlightPass){var f=e.offscreenRenderingHelper?e.offscreenRenderingHelper.depthTexture:null;c.bindTexture(f,5),h.setUniform1i("depthTex",5),h.setUniform4f("highlightViewportPixelSz",0,0,1/n.viewport[2],1/n.viewport[3])}o.bindView(c,n),i.LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL&&0===e.pass&&(h.setUniform4fv("externalColor",M[Math.min(s,M.length-1)]),h.setUniform1i("colorMixMode",g.colorMixModes.replace));var p=a.capacity,v=a.headIndex,m=a.tailIndex,y=a.firstIndex,_=this._glInstanceBufferLayout,D=function(e,t){b.bindVertexBufferLayout(c,l.Default3D,a.buffer,_,e),u.drawArraysInstanced(d,0,r.vertexCount,t-e),b.unbindVertexBufferLayout(c,l.Default3D,a.buffer,_)};r.material.getParams().transparent&&null!=y?v>m?(I(y>=m&&y<=v,"invalid firstIndex"),D(y,v),D(m,y)):v<m&&(y<=v?(I(y>=0&&y<=v,"invalid firstIndex"),D(y,v),D(m,p),D(0,y)):(I(y>=m&&y<=p,"invalid firstIndex"),D(y,p),D(0,v),D(m,y))):v>m?D(m,v):v<m&&(D(0,v),D(m,p)),c.bindVAO(null),o.release(c,n)}},e}();t.LodRenderer=x,t.lodRenderers=[];var S=a.vec3f64.create(),E=a.vec4f64.create(),L=a.mat4f64.create(),O=a.vec3f64.create(),T=a.vec3f64.create(),M=[[1,0,1,1],[0,0,1,1],[0,1,0,1],[1,1,0,1],[1,0,0,1]]});