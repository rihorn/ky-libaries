// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.10/esri/copyright.txt for details.

define(["require","exports","../../../../../core/tsSupport/extendsHelper","../../../../../core/libs/gl-matrix-2/gl-matrix","../../../support/Evented","../../../support/mathUtils","../../../support/buffer/BufferView","../../../support/buffer/InterleavedLayout","../../../../webgl/Util"],function(t,e,i,r,o,a,n,s,f){function l(t){var e=s.newLayout().mat4f64("localTransform").mat4f64("globalTransform").vec4f64("boundingSphere").vec3f64("modelOrigin").mat3f("model").mat3f("modelNormal").f32("modelScaleFactor");return t.indexOf("color")>=0&&(e=e.vec4f("color")),t.indexOf("featureAttribute")>=0&&(e=e.vec4f("featureAttribute")),e=e.u8("state").u8("lodLevel").alignTo(4)}Object.defineProperty(e,"__esModule",{value:!0});var c,u=f.assert;!function(t){t[t.ALLOCATED=1]="ALLOCATED",t[t.ACTIVE=2]="ACTIVE",t[t.VISIBLE=4]="VISIBLE",t[t.HIGHLIGHT=8]="HIGHLIGHT",t[t.HIGHLIGHT_ACTIVE=16]="HIGHLIGHT_ACTIVE",t[t.REMOVE=32]="REMOVE",t[t.TRANSFORM_CHANGED=64]="TRANSFORM_CHANGED"}(c=e.StateFlags||(e.StateFlags={}));var h=function(){function t(t){this.localTransform=t.getField("localTransform",n.BufferViewMat4f64),this.globalTransform=t.getField("globalTransform",n.BufferViewMat4f64),this.modelOrigin=t.getField("modelOrigin",n.BufferViewVec3f64),this.model=t.getField("model",n.BufferViewMat3f),this.modelNormal=t.getField("modelNormal",n.BufferViewMat3f),this.modelScaleFactor=t.getField("modelScaleFactor",n.BufferViewFloat),this.boundingSphere=t.getField("boundingSphere",n.BufferViewVec4f64),this.color=t.getField("color",n.BufferViewVec4f),this.featureAttribute=t.getField("featureAttribute",n.BufferViewVec4f),this.state=t.getField("state",n.BufferViewUint8),this.lodLevel=t.getField("lodLevel",n.BufferViewUint8)}return t}();e.View=h;var p=function(t){function e(e,i){var r=t.call(this)||this;return r._capacity=0,r._size=0,r._next=0,r._layout=l(e),r._shaderTransformation=i,r}return i(e,t),Object.defineProperty(e.prototype,"capacity",{get:function(){return this._capacity},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"size",{get:function(){return this._size},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"buffer",{get:function(){return this._buffer.buffer},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"view",{get:function(){return this._view},enumerable:!0,configurable:!0}),e.prototype.addInstance=function(){this._size+1>this._capacity&&this.grow();var t=this.findSlot();return this._view.state.set(t,c.ALLOCATED),this._size++,this.emit("instance-added",{index:t}),t},e.prototype.removeInstance=function(t){var e=this._view.state;u(t>=0&&t<this._capacity&&e.get(t)&c.ALLOCATED,"invalid instance handle"),this.getStateFlag(t,c.ACTIVE)?this.setStateFlags(t,c.REMOVE):this.freeInstance(t),this.emit("instance-removed",{index:t})},e.prototype.freeInstance=function(t){var e=this._view.state;u(t>=0&&t<this._capacity&&e.get(t)&c.ALLOCATED,"invalid instance handle"),e.set(t,0),this._size--},e.prototype.setLocalTransform=function(t,e,i){void 0===i&&(i=!0),this._view.localTransform.setMat(t,e),i&&this.updateModelTransform(t)},e.prototype.getLocalTransform=function(t,e){this._view.localTransform.getMat(t,e)},e.prototype.setGlobalTransform=function(t,e,i){void 0===i&&(i=!0),this._view.globalTransform.setMat(t,e),i&&this.updateModelTransform(t)},e.prototype.getGlobalTransform=function(t,e){this._view.globalTransform.getMat(t,e)},e.prototype.updateModelTransform=function(t){var e=this._view,i=m,o=v;e.localTransform.getMat(t,_),e.globalTransform.getMat(t,y);var n=r.mat4.multiply(y,y,_);r.vec3.set(i,n[12],n[13],n[14]),e.modelOrigin.setVec(t,i),r.mat3.fromMat4(o,n),e.model.setMat(t,o),e.modelScaleFactor.set(t,a.maxScale(n)),r.mat3.invert(o,o),r.mat3.transpose(o,o),e.modelNormal.setMat(t,o),this.setStateFlags(t,c.TRANSFORM_CHANGED),this.emit("instance-transform-changed",{index:t})},e.prototype.getModelTransform=function(t,e){var i=this._view;i.model.getMat(t,v),i.modelOrigin.getVec(t,m),e[0]=v[0],e[1]=v[1],e[2]=v[2],e[3]=0,e[4]=v[3],e[5]=v[4],e[6]=v[5],e[7]=0,e[8]=v[6],e[9]=v[7],e[10]=v[8],e[11]=0,e[12]=m[0],e[13]=m[1],e[14]=m[2],e[15]=1},e.prototype.applyShaderTransformation=function(t,e){this._shaderTransformation&&this._shaderTransformation.applyTransform(this,t,e)},e.prototype.getCombinedModelTransform=function(t,e){return this.getModelTransform(t,e),this._shaderTransformation&&this._shaderTransformation.applyTransform(this,t,e),e},e.prototype.getCombinedLocalTransform=function(t,e){return this._view.localTransform.getMat(t,e),this._shaderTransformation&&this._shaderTransformation.applyTransform(this,t,e),e},e.prototype.getCombinedScaleFactor=function(t){var e=this._view.modelScaleFactor.get(t);return this._shaderTransformation&&(e*=this._shaderTransformation.scaleFactor(this,t)),e},e.prototype.getModel=function(t,e){this._view.model.getMat(t,e)},e.prototype.getScaleFactor=function(t){return this._view.modelScaleFactor.get(t)},e.prototype.setFeatureAttribute=function(t,e){this._view.featureAttribute.setVec(t,e)},e.prototype.getFeatureAttribute=function(t,e){this._view.featureAttribute.getVec(t,e)},e.prototype.setColor=function(t,e){this._view.color.setVec(t,e)},e.prototype.getColor=function(t,e){this._view.color.getVec(t,e)},e.prototype.setVisible=function(t,e){e!==this.getVisible(t)&&(this.setStateFlag(t,c.VISIBLE,e),this.emit("instance-visibility-changed",{index:t}))},e.prototype.getVisible=function(t){return this.getStateFlag(t,c.VISIBLE)},e.prototype.setHighlight=function(t,e){e!==this.getHighlight(t)&&(this.setStateFlag(t,c.HIGHLIGHT,e),this.emit("instance-highlight-changed",{index:t}))},e.prototype.getHighlight=function(t){return this.getStateFlag(t,c.HIGHLIGHT)},e.prototype.getState=function(t){return this._view.state.get(t)},e.prototype.getLodLevel=function(t){return this._view.lodLevel.get(t)},e.prototype.countFlags=function(t){for(var e=0,i=0;i<this._capacity;++i){this.getState(i)&t&&++e}return e},e.prototype.setStateFlags=function(t,e){var i=this._view.state;e=i.get(t)|e,i.set(t,e)},e.prototype.clearStateFlags=function(t,e){var i=this._view.state;e=i.get(t)&~e,i.set(t,e)},e.prototype.setStateFlag=function(t,e,i){i?this.setStateFlags(t,e):this.clearStateFlags(t,e)},e.prototype.getStateFlag=function(t,e){return!!(this._view.state.get(t)&e)},e.prototype.grow=function(){var t=Math.max(g,Math.floor(this._capacity*d)),e=this._layout.createBuffer(t);if(this._buffer){var i=new Uint8Array(this._buffer.buffer);new Uint8Array(e.buffer).set(i)}this._capacity=t,this._buffer=e,this._view=new h(this._buffer)},e.prototype.findSlot=function(){for(var t=this._view.state,e=this._next;t.get(e)&c.ALLOCATED;)e=(e+1)%this._capacity;return this._next=(e+1)%this._capacity,e},e}(o.Evented);e.InstanceData=p;var g=1024,d=2,m=r.vec3f64.create(),v=r.mat3f64.create(),_=r.mat4f64.create(),y=r.mat4f64.create()});