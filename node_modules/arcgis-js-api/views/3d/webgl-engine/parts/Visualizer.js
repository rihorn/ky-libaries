// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.10/esri/copyright.txt for details.

define(["require","exports","../../../../core/TimeProfiler","../../../../core/libs/gl-matrix-2/gl-matrix","../../support/debugFlags","../lib/depthRange","../lib/depthRangeUtils","../lib/HighlightHelper","../lib/OffscreenRenderingHelper","../lib/Renderer","../lib/RenderOccludedHelper","../lib/ShadowMap","../lib/SliceHelper","../lib/SSAOHelper","../lib/Util"],function(e,s,r,t,a,i,n,o,h,d,p,l,u,c,_){var g=_.assert;return function(){function e(e,s,r,t,a){this._drawShadowMapDebugQuad=!1,this._drawSSAOMapDebugQuad=!1,this._needsRender=!0,this._content=new Map,this._stage=e,this._rctx=a,this._renderer=new d(s,r,t,this._rctx,!1),this._programRep=s,this._helpers={shadowMap:new l(s,this._rctx),ssao:new c(s,this._rctx,this.setNeedsRender.bind(this)),highlight:new o(s,this._rctx),renderOccluded:new p(s,this._rctx),slice:new u,offscreenRendering:new h(s,this._rctx)}}return Object.defineProperty(e.prototype,"isLoadingResources",{get:function(){return this._renderer.isLoadingResources},enumerable:!0,configurable:!0}),e.prototype.getCombinedStats=function(){return this._renderer.getCombinedStats()},e.prototype.dispose=function(){this._renderer.dispose(),this._helpers.shadowMap.enabled=!1,this._helpers.shadowMap.dispose(),this._helpers.ssao.enabled=!1,this._helpers.ssao.dispose(),this._helpers.highlight.enabled=!1,this._helpers.renderOccluded.enabled=!1,this._helpers.offscreenRendering.enabled=!1},e.prototype.setLighting=function(e){this._renderer.setLighting(e)},e.prototype.setRenderParams=function(e){void 0!==e.shadowMapResolution&&!1===this._helpers.shadowMap.enabled&&(this._helpers.shadowMap.textureResolution=e.shadowMapResolution),void 0!==e.shadowMap&&(this._helpers.shadowMap.enabled=e.shadowMap),void 0!==e.shadowMapMaxCascades&&(this._helpers.shadowMap.maxCascades=e.shadowMapMaxCascades),this._helpers.highlight.enabled=!0,void 0!==e.ssao&&(this._helpers.ssao.enabled=e.ssao),void 0!==e.ssaoAttenuation&&(this._helpers.ssao.attenuation=e.ssaoAttenuation),void 0!==e.ssaoRadius&&(this._helpers.ssao.radius=e.ssaoRadius),void 0!==e.ssaoFilterRadius&&console.error("The property ssaoFilterRadius is no longer supported as a render parameter."),void 0!==e.ssaoSamples&&(this._helpers.ssao.samples=e.ssaoSamples),void 0!==e.drawShadowMapDebugQuad&&(this._drawShadowMapDebugQuad=e.drawShadowMapDebugQuad),void 0!==e.drawSSAODebugQuad&&(this._drawSSAOMapDebugQuad=e.drawSSAODebugQuad),this._renderer.ssaoEnabled=this._helpers.ssao.enabled,void 0!==e.offscreenRendering&&(this._helpers.offscreenRendering.enabled=e.offscreenRendering),e.background&&(this._helpers.offscreenRendering.background=e.background),void 0!==e.antialiasingEnabled&&(this._renderer.renderOptions.antialiasing=e.antialiasingEnabled?"smaa":"none"),void 0!==e.earlyOcclusionPixelDraw&&(this._renderer.renderOptions.earlyOcclusionPixelDraw=e.earlyOcclusionPixelDraw),void 0!==e.defaultHighlightOptions&&this._helpers.highlight.setDefaultOptions(e.defaultHighlightOptions),void 0!==e.slicePlane&&(this._helpers.slice.plane=e.slicePlane),this._needsRender=!0},e.prototype.getRenderParams=function(){var e={};return e.shadowMap=this._helpers.shadowMap.enabled,e.shadowMapResolution=this._helpers.shadowMap.textureResolution,e.shadowMapMaxCascades=this._helpers.shadowMap.maxCascades,this._helpers.ssao.isSupported&&(e.ssao=this._helpers.ssao.enabled,e.ssaoAttenuation=this._helpers.ssao.attenuation,e.ssaoRadius=this._helpers.ssao.radius,e.ssaoFilterRadius=this._helpers.ssao.filterRadius,e.ssaoSamples=this._helpers.ssao.samples),e},e.prototype.getFramebufferTexture=function(e){switch(e){case"color":return this._helpers.offscreenRendering.colorTexture;case"hudVisibility":return this._helpers.offscreenRendering.hudVisibilityTexture;case"shadowMap":return this._helpers.shadowMap.getDepthTexture()}return this._renderer.getFramebufferTexture(e)},e.prototype.modify=function(e,s,r,t){this._renderer.modify(e,s,r,t);for(var a=0;a<s.length;++a)this._content.delete(s[a].uniqueName);for(var a=0;a<e.length;++a)this._content.set(e[a].uniqueName,e[a]);for(var a=0;a<r.length;++a)g(this._content.get(r[a].renderGeometry.uniqueName)===r[a].renderGeometry)},e.prototype.getContent=function(){return this._content},e.prototype.getProjectionMatrix=function(e,s,r,a,i){var n=_.fovx2fovy(s,e[2],e[3]);t.mat4.perspective(i,180*n/Math.PI,e[2]/e[3],r,a)},Object.defineProperty(e.prototype,"renderPlugins",{get:function(){return this._renderer.renderPlugins},enumerable:!0,configurable:!0}),e.prototype.resetNeedsRender=function(){this._needsRender=!1,this._renderer.resetNeedsRender()},e.prototype.needsRender=function(){return this._needsRender||this._renderer.needsRender()},e.prototype.setNeedsRender=function(){this._needsRender=!0},e.prototype.render=function(e){var s=e.camera,i=e.fbo,n=e.lightDirection,o=s.viewport,h=this._helpers.slice.plane;if(e.disableSlice&&(this._helpers.slice.plane=null),this._renderer.prepareRender(s),this._helpers.shadowMap.enabled){a.ENABLE_PROFILE_DEPTH_RANGE&&r.begin("depthRange");var d=this.computeDepthRange(s);a.ENABLE_PROFILE_DEPTH_RANGE&&r.end("depthRange"),this._helpers.shadowMap.prepare(s,n,this._content,d);for(var p=this._helpers.shadowMap.getCascades(),l=0;l<p.length;++l){var u=p[l];u.camera.setGLViewport(this._rctx),e.camera=u.camera,this._renderer.renderGeometryPass(3,e,null,null,this._helpers.slice)}e.camera=s,this._helpers.shadowMap.finish(i),s.setGLViewport(this._rctx)}if(this._helpers.shadowMap.bindAll(this._programRep),this._renderer.renderAuxiliaryBuffers(e,this._helpers),this._renderer.render(e,this._helpers),this._drawShadowMapDebugQuad&&this._helpers.shadowMap.enabled){var c=t.mat4.ortho(t.mat4f64.create(),o[0],o[2],o[1],o[3],-1,1);this._helpers.shadowMap.drawDebugQuad(c)}if(this._drawSSAOMapDebugQuad&&this._helpers.ssao.enabled){var c=t.mat4.ortho(t.mat4f64.create(),o[0],o[2],o[1],o[3],-1,1);this._helpers.ssao.drawQuad(c)}this._helpers.slice.plane=h},e.prototype.getEdgeView=function(){return this._renderer.edgeView},e.prototype.computeDepthRange=function(e){var s=n.depthRangeFromScene(e,this._content,this._stage.getLayers());return i.union(s,this.renderPlugins.queryDepthRange(e)),s.near=Math.max(e.near,s.near),s.far=Math.min(e.far,s.far),s},e}()});