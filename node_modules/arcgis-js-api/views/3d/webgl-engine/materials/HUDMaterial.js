// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.10/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/extendsHelper","../../../../core/libs/gl-matrix-2/gl-matrix","../../../../core/libs/gl-matrix-2/types/mat4","../../../../geometry/support/aaBoundingRect","../../support/buffer/InterleavedLayout","../lib/ComponentUtils","../lib/GLMaterialTexture","../lib/Material","../lib/screenSizePerspectiveUtils","../lib/Util","./internal/bufferWriters","./internal/MaterialUtil","../shaders/HUDPrograms"],function(e,t,r,n,i,s,o,a,c,l,f,v,u,p,d){function m(e,t){return void 0===t&&(t=b),e.textureIsSignedDistanceField?h(e.anchorPos,e.distanceFieldBoundingBox,t):n.vec2.copy(t,e.anchorPos),t}function g(e,t,r,i){return void 0===i&&(i=b),n.vec2.copy(i,e.anchorPos),i[0]*=-t[0],i[1]*=-t[1],i[0]+=e.screenOffset[0]*r,i[1]+=e.screenOffset[1]*r,i}function h(e,t,r){r[0]=e[0]*(t[2]-t[0])+t[0],r[1]=e[1]*(t[3]-t[1])+t[1]}function S(e){var t=e[0],r=e[1],n=e[2],i=e[3],s=e[4],o=e[5],a=e[6],c=e[7],l=e[8],f=1/Math.sqrt(t*t+r*r+n*n),v=1/Math.sqrt(i*i+s*s+o*o),u=1/Math.sqrt(a*a+c*c+l*l);return e[0]=t*f,e[1]=r*f,e[2]=n*f,e[3]=i*v,e[4]=s*v,e[5]=o*v,e[6]=a*u,e[7]=c*u,e[8]=l*u,e}var P={"bottom-left":n.vec2f64.fromValues(0,0),bottom:n.vec2f64.fromValues(.5,0),"bottom-right":n.vec2f64.fromValues(1,0),left:n.vec2f64.fromValues(0,.5),center:n.vec2f64.fromValues(.5,.5),right:n.vec2f64.fromValues(1,.5),"top-left":n.vec2f64.fromValues(0,1),top:n.vec2f64.fromValues(.5,1),"top-right":n.vec2f64.fromValues(1,1)},x=function(e){function t(t,r){var n=e.call(this,r)||this;return n._textureDirty=!1,n.params=p.copyParameters(t,L),"string"==typeof n.params.anchorPos&&(n.params.anchorPos=P[n.params.anchorPos]),n.bufferWriter=new H(n),n}return r(t,e),t.prototype.dispose=function(){},t.prototype.getParameterValues=function(){return this.params},t.prototype.setParameterValues=function(e){for(var t in e)"textureId"===t&&v.assert(!!this.params.textureId,"Can only change texture of material that already has a texture"),this.params[t]=e[t];this.notifyDirty("matChanged")},t.prototype.getParams=function(){return this.params},t.prototype.intersect=function(e,t,r,i,s,o,c,l){if(i.isSelection&&i.enableHUDSelection&&!a.isAllHidden(t.componentVisibilities,e.data.componentOffsets)){var u=e.data,p=this.params,d=1,g=1;if(n.mat3.fromMat4(T,r),l){var h=l(R);d=h[0],g=h[5],S(T)}var P=u.getVertexAttr()[v.VertexAttrConstants.POSITION],x=u.getVertexAttr()[v.VertexAttrConstants.SIZE],A=u.getVertexAttr()[v.VertexAttrConstants.NORMAL];v.assert(P.size>=3);for(var O=i.point,y=i.camera,b=m(p),I=0;I<P.data.length/P.size;I++){var D=I*P.size;n.vec3.set(V,P.data[D],P.data[D+1],P.data[D+2]),n.vec3.transformMat4(V,V,r);var B=I*x.size;F[0]=x.data[B]*d,F[1]=x.data[B+1]*g,n.vec3.transformMat4(V,V,y.viewMatrix);var L=I*A.size;if(n.vec3.set(C,A.data[L],A.data[L+1],A.data[L+2]),this.applyVerticalOffsetTransformation(V,C,T,y,z),y.applyProjection(V,U),U[0]>-1){var N=Math.floor(U[0]),H=Math.floor(U[1]);f.applyPrecomputedScaleFactorVec2(F,z.factor,F);var X=N-E-(b[0]>0?F[0]*b[0]:0),j=X+F[0]+2*E,q=H-E-(b[1]>0?F[1]*b[1]:0),G=q+F[1]+2*E;if(p.textureIsSignedDistanceField){var Z=p.outlineSize/2,_=p.distanceFieldBoundingBox;X+=F[0]*_[0],q+=F[1]*_[1],j-=F[0]*(1-_[2]),G-=F[1]*(1-_[3]),X-=Z,j+=Z,q-=Z,G+=Z}if(O[0]>X&&O[0]<j&&O[1]>q&&O[1]<G){var W=i.p0,k=i.p1;n.vec3.transformMat4(M,V,n.mat4.invert(w,y.viewMatrix)),U[0]=O[0],U[1]=O[1],y.unprojectPoint(U,V);var J=n.vec3f64.create();n.vec3.subtract(J,k,W);var K=1/n.vec3.length(J);n.vec3.scale(J,J,K);c(n.vec3.distance(W,V)*K,J,-1,1,!0,M)}}}}},t.prototype.normalAndViewAngle=function(e,t,r,i){return void 0===i&&(i=D),n.vec3.transformMat3(i.normal,e,t),n.vec3.transformMat4(i.normal,i.normal,r.viewInverseTransposeMatrix),i.cosAngle=n.vec3.dot(I,B),i},t.prototype.updateScaleInfo=function(e,t,r){var n=this.params;n.screenSizePerspective?e.factor=f.precomputeScaleFactor(D.cosAngle,r,n.screenSizePerspective,e.factor):(e.factor.scale=1,e.factor.factor=0,e.factor.minPixelSize=0,e.factor.paddingPixels=0),n.screenSizePerspectiveAlignment?(e.scaleAlignment=f.precomputeScale(D.cosAngle,r,n.screenSizePerspectiveAlignment),e.minPixelSizeAlignment=n.screenSizePerspectiveAlignment.parameters.minPixelSize):(e.scaleAlignment=e.factor.scale,e.minPixelSizeAlignment=e.factor.minPixelSize)},t.prototype.applyVerticalOffsetTransformation=function(e,t,r,s,o,a){var c=this.params;if(i.isMat4(r)&&(r=n.mat3.fromMat4(T,r)),!c.verticalOffset||!c.verticalOffset.screenLength){if(o&&(c.screenSizePerspective||c.screenSizePerspectiveAlignment)){var l=this.normalAndViewAngle(t,r,s),f=n.vec3.length(e);this.updateScaleInfo(o,l.cosAngle,f)}else o&&(o.factor.scale=1,o.scaleAlignment=1);return a?n.vec3.copy(a,e):e}var v=this.normalAndViewAngle(t,r,s),u=n.vec3.length(e),d=c.screenSizePerspectiveAlignment||c.screenSizePerspective,m=p.verticalOffsetAtDistance(s,u,c.verticalOffset,v.cosAngle,d);return o&&this.updateScaleInfo(o,v.cosAngle,u),n.vec3.add(a||e,e,n.vec3.scale(v.normal,v.normal,m))},t.prototype.getGLMaterials=function(){return{color:O,depthShadowMap:void 0,normal:void 0,depth:void 0,highlight:y}},t.prototype.getAllTextureIds=function(){return[this.params.textureId]},t.prototype.setTextureDirty=function(){this._textureDirty=!0},t.prototype.calculateRelativeScreenBounds=function(e,t,r){return void 0===r&&(r=s.create()),g(this.params,e,t,r),r[2]=r[0]+e[0],r[3]=r[1]+e[1],r},t.prototype.calculateAnchorPosForRendering=function(e){return m(this.params,e)},t.shouldRenderVisibilityDuringRenderPass=function(e){return 0===e||4},t}(l),A=function(e){function t(t,r,n){var i=e.call(this,t,r,n,t.getParams().textureId)||this;return i.params=p.copyParameters(t.getParams()),i.selectProgram(),i.selectSlot(),i}return r(t,e),t.prototype.selectSlot=function(){this.mainSlot=this.params.drawInSecondSlot?20:19},t.prototype.beginSlot=function(e){return e===this.mainSlot},t.prototype.getProgram=function(){return this.program},t.prototype.updateParameters=function(){this.params=p.copyParameters(this.material.getParameterValues()),this.updateTexture(this.params.textureId),this.selectProgram(),this.selectSlot()},t.prototype.bindRender=function(e,t){var r=this.params,n=this.getProgram();this.bindTexture(e,n),n.setUniform1i("hudVisibilityTexture",1),e.bindTexture(t.hudVisibilityTexture,1),e.setActiveTexture(0),n.setUniform1f("uRenderTransparentlyOccludedHUD","occluded"===t.renderTransparentlyOccludedHUD?1:"notOccluded"===t.renderTransparentlyOccludedHUD?0:.75);var i=t.pixelRatio||1;n.setUniform4fv("overrideColor",r.color),n.setUniform1f("pixelRatio",i),r.textureIsSignedDistanceField&&(n.setUniform4fv("outlineColor",r.outlineColor),n.setUniform1f("outlineSize",r.outlineSize*i)),r.vvSizeEnabled&&(n.setUniform3fv("vvSizeMinSize",r.vvSizeMinSize),n.setUniform3fv("vvSizeMaxSize",r.vvSizeMaxSize),n.setUniform3fv("vvSizeOffset",r.vvSizeOffset),n.setUniform3fv("vvSizeFactor",r.vvSizeFactor)),r.vvColorEnabled&&(n.setUniform1fv("vvColorValues",r.vvColorValues),n.setUniform4fv("vvColorColors",r.vvColorColors)),n.setUniform2fv("texScale",r.texCoordScale),n.setUniform2f("screenOffset",2*r.screenOffset[0]*i,2*r.screenOffset[1]*i),n.setUniform2fv("anchorPos",m(r)),r.polygonOffset&&(e.setPolygonOffsetFillEnabled(!0),e.setPolygonOffset(0,-4)),e.setBlendingEnabled(!0),e.setBlendFunction(1,771)},t.prototype.bindProjection=function(e,t){this.material._textureDirty&&(this.renderTexture(e),this.material._textureDirty=!1);var r=t.cameraAboveGround?1:-1,n=this.getProgram(),i=this.params;e.bindProgram(n),n.setUniform1f("cameraGroundRelative",r),n.setUniform1f("polygonOffset",i.shaderPolygonOffset),n.setUniform4fv("viewport",t.viewport),p.bindVerticalOffset(i.verticalOffset,t,n),n.setUniformMatrix4fv("viewNormal",t.viewInvTransp),i.screenSizePerspective&&(p.bindScreenSizePerspective(i.screenSizePerspective,t,n,"screenSizePerspective"),p.bindScreenSizePerspective(i.screenSizePerspectiveAlignment||i.screenSizePerspective,t,n,"screenSizePerspectiveAlignment"))},t.prototype.releaseRender=function(e){e.setPolygonOffsetFillEnabled(!1),e.setBlendFunction(770,771),e.setBlendingEnabled(!1)},t.prototype.bindView=function(e,t){var r=t.origin,n=this.getProgram();p.bindView(r,t.view,n),p.bindCamPos(r,t.viewInvTransp,n),this.params.slicePlaneEnabled&&p.bindSlicePlane(t.origin,t.slicePlane,n)},t.prototype.bindInstance=function(e,t){var r=this.getProgram();r.setUniformMatrix4fv("model",t.transformation),r.setUniformMatrix4fv("modelNormal",t.transformationNormal)},t.prototype.getDrawMode=function(){return 4},t}(c),O=function(e){function t(t,r,n){var i=e.call(this,t,r,n)||this;return i.isOcclusionSlot=!1,i}return r(t,e),t.prototype.selectProgram=function(){var e=this.params;this.programOcclusionTestPixel=this.programRep.getProgram(d.occlusionPass,{verticalOffset:!!e.verticalOffset,screenSizePerspective:!!e.screenSizePerspective,centerOffsetUnitsScreen:"screen"===e.centerOffsetUnits,slice:e.slicePlaneEnabled}),this.program=this.programRep.getProgram(d.colorPass,{occlTest:e.occlusionTest,sdf:e.textureIsSignedDistanceField,vvSize:!!e.vvSizeEnabled,vvColor:!!e.vvColorEnabled,verticalOffset:!!e.verticalOffset,screenSizePerspective:!!e.screenSizePerspective,centerOffsetUnitsScreen:"screen"===e.centerOffsetUnits,debugDrawBorder:!!e.debugDrawBorder,slice:e.slicePlaneEnabled})},t.prototype.getDrawMode=function(){return this.isOcclusionSlot?0:4},t.prototype.release=function(e){e.setDepthFunction(513),this.isOcclusionSlot||this.releaseRender(e)},t.prototype.bind=function(e,t){this.bindProjection(e,t);var r=this.getProgram();if(e.setDepthTestEnabled(!0),e.setDepthFunction(515),this.isOcclusionSlot){r.setUniform4f("color",1,1,1,1);var n=t.pixelRatio||1;r.setUniform1f("pixelRatio",n)}else this.bindRender(e,t),this.bindTexture(e,r)},t.prototype.getProgram=function(){return this.isOcclusionSlot?this.programOcclusionTestPixel:this.program},t.prototype.getPrograms=function(){return[this.programOcclusionTestPixel,this.program]},t.prototype.beginSlot=function(e){return this.params.occlusionTest?(this.isOcclusionSlot=14===e,14===e||e===this.mainSlot):(this.isOcclusionSlot=!1,e===this.mainSlot)},t}(A),y=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return r(t,e),t.prototype.selectProgram=function(){var e=this.params;this.program=this.programRep.getProgram(d.highlightPass,{occlTest:e.occlusionTest,sdf:e.textureIsSignedDistanceField,vvSize:!!e.vvSizeEnabled,vvColor:!!e.vvColorEnabled,verticalOffset:!!e.verticalOffset,screenSizePerspective:!!e.screenSizePerspective,centerOffsetUnitsScreen:"screen"===e.centerOffsetUnits,binaryHighlightOcclusion:e.binaryHighlightOcclusion,slice:e.slicePlaneEnabled})},t.prototype.bind=function(e,t){this.bindProjection(e,t),this.bindRender(e,t)},t.prototype.release=function(e){this.releaseRender(e)},t}(A),z={factor:{scale:0,factor:0,minPixelSize:0,paddingPixels:0},scaleAlignment:0,minPixelSizeAlignment:0},b=n.vec2f64.create(),V=n.vec3f64.create(),C=n.vec3f64.create(),U=n.vec3f64.create(),I=n.vec3f64.create(),M=n.vec3f64.create(),T=n.mat3f64.create(),w=n.mat4f64.create(),D={normal:I,cosAngle:0},R=n.mat4f64.create();n.mat4.identity(R);var E=1,F=[0,0],B=n.vec3f64.fromValues(0,0,1),L={texCoordScale:[1,1],occlusionTest:!0,binaryHighlightOcclusion:!0,drawInSecondSlot:!1,color:[1,1,1,1],outlineColor:[1,1,1,1],outlineSize:0,textureIsSignedDistanceField:!1,distanceFieldBoundingBox:null,vvSizeEnabled:!1,vvSizeMinSize:[1,1,1],vvSizeMaxSize:[100,100,100],vvSizeOffset:[0,0,0],vvSizeFactor:[1,1,1],vvColorEnabled:!1,vvColorValues:[0,0,0,0,0,0,0,0],vvColorColors:[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],screenOffset:[0,0],verticalOffset:null,screenSizePerspective:null,screenSizePerspectiveAlignment:null,slicePlaneEnabled:!1,anchorPos:P.center,shaderPolygonOffset:1e-5,polygonOffset:!1,textureId:null,centerOffsetUnits:"world",debugDrawBorder:!1},N=o.newLayout().vec3f(v.VertexAttrConstants.POSITION).vec3f(v.VertexAttrConstants.NORMAL).vec2f(v.VertexAttrConstants.UV0).vec4u8(v.VertexAttrConstants.COLOR).vec2f(v.VertexAttrConstants.SIZE).vec4f(v.VertexAttrConstants.AUXPOS1).vec4f(v.VertexAttrConstants.AUXPOS2),H=function(){function e(e){this.material=e,this.vertexBufferLayout=N}return e.prototype.allocate=function(e){return this.vertexBufferLayout.createBuffer(e)},e.prototype.elementCount=function(e){return 6*e.indices[v.VertexAttrConstants.POSITION].length},e.prototype.write=function(e,t,r,n,i){u.writePosition(t.indices[v.VertexAttrConstants.POSITION],t.vertexAttr[v.VertexAttrConstants.POSITION].data,e.transformation,n.position,i,6),u.writeNormal(t.indices[v.VertexAttrConstants.NORMAL],t.vertexAttr[v.VertexAttrConstants.NORMAL].data,e.invTranspTransformation,n.normal,i,6);var s=t.vertexAttr[v.VertexAttrConstants.UV0].data,o=void 0,a=void 0,c=void 0,l=void 0;if(null==s||s.length<4){var f=this.material.getParameterValues();o=0,a=0,c=f.texCoordScale[0],l=f.texCoordScale[1]}else o=s[0],a=s[1],c=s[2],l=s[3];c=Math.min(1.99999,c+1),l=Math.min(1.99999,l+1);for(var p=t.indices[v.VertexAttrConstants.POSITION].length,d=n.uv0,m=i,g=0;g<p;++g)d.set(m,0,o),d.set(m,1,a),m+=1,d.set(m,0,c),d.set(m,1,a),m+=1,d.set(m,0,c),d.set(m,1,l),m+=1,d.set(m,0,c),d.set(m,1,l),m+=1,d.set(m,0,o),d.set(m,1,l),m+=1,d.set(m,0,o),d.set(m,1,a),m+=1;u.writeColor(t.indices[v.VertexAttrConstants.COLOR],t.vertexAttr[v.VertexAttrConstants.COLOR].data,4,n.color,i,6);for(var h=t.indices[v.VertexAttrConstants.SIZE],S=t.vertexAttr[v.VertexAttrConstants.SIZE].data,P=h.length,x=n.size,m=i,g=0;g<P;++g)for(var A=S[2*h[g]],O=S[2*h[g]+1],y=0;y<6;++y)x.set(m,0,A),x.set(m,1,O),m+=1;t.indices[v.VertexAttrConstants.AUXPOS1]&&t.vertexAttr[v.VertexAttrConstants.AUXPOS1]&&u.writeBufferVec4(t.indices[v.VertexAttrConstants.AUXPOS1],t.vertexAttr[v.VertexAttrConstants.AUXPOS1].data,n.auxpos1,i,6),t.indices[v.VertexAttrConstants.AUXPOS2]&&t.vertexAttr[v.VertexAttrConstants.AUXPOS2]&&u.writeBufferVec4(t.indices[v.VertexAttrConstants.AUXPOS2],t.vertexAttr[v.VertexAttrConstants.AUXPOS2].data,n.auxpos2,i,6)},e}();return x});