// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.10/esri/copyright.txt for details.

define(["require","exports","../../../../../core/libs/gl-matrix-2/gl-matrix","../../../../../geometry/support/aaBoundingBox","../../../support/mathUtils","../../lib/ComponentUtils","../../lib/doublePrecisionUtils","../../lib/screenSizePerspectiveUtils","../../lib/Util"],function(e,n,t,r,i,a,o,c,s){function f(e,n,t,r,i,o,c){s.assert("triangle"===e.data.primitiveType);var f=n&&n.componentVisibilities,u=r.tolerance;e.componentCount>1?l(e,f,i,o,u,c):f&&!a.getVisibility(f,0)||v(e.boundingInfo,i,o,u,c)}function v(e,n,t,i,a){var o=d(n,t,N);if(r.setMin(C,e.getBBMin()),r.setMax(C,e.getBBMax()),g(C,n,o,i)){var c=e.getPrimitiveIndices(),s=e.getIndices(),f=e.getPosition(),l=c?c.length:s.length/3;if(l>G){var m=e.getChildren();if(void 0!==m){for(var p=0;p<8;++p)void 0!==m[p]&&v(m[p],n,t,i,a);return}}u(n,t,0,l,s,f,c,a)}}function l(e,n,t,i,o,c){var s=d(t,i,N),f=e.boundingInfo;if(r.setMin(C,f.getBBMin()),r.setMax(C,f.getBBMax()),g(C,t,s,o))for(var v=e.data,l=e.componentCount,m=v.getIndices(V.POSITION),p=v.getAttribute(V.POSITION),h=v.componentOffsets,b=0;b<l;b++)if(!n||a.getVisibility(n,b)){var M=e.getComponentAABB(b,C);if(g(M,t,s,o)){var x=h[b]/3,P=h[b+1]/3;u(t,i,x,P,m,p,void 0,c)}}}function u(e,n,t,r,i,a,o,c){for(var s=a.data,f=a.offsetIdx,v=a.strideIdx,l=e[0],u=e[1],d=e[2],g=n[0],p=n[1],h=n[2],b=g-l,M=p-u,x=h-d,P=t;P<r;P++){var S=o?o[P]:P,O=f+v*i[3*S],L=f+v*i[3*S+1],U=f+v*i[3*S+2],B=s[O],I=s[O+1],y=s[O+2],A=s[L],w=s[L+1],W=s[L+2],T=s[U],D=s[U+1],E=s[U+2],C=A-B,V=w-I,N=W-y,Y=T-B,j=D-I,H=E-y,R=M*H-j*x,_=x*Y-H*b,k=b*j-Y*M,G=C*R+V*_+N*k,F=l-B,J=u-I,K=d-y,Q=J*N-V*K,X=K*C-N*F,Z=F*V-C*J;if(G>z){var $=F*R+J*_+K*k;if($<0||$>G)continue;var ee=b*Q+M*X+x*Z;if(ee<0||$+ee>G)continue}else{if(!(G<-z))continue;var $=F*R+J*_+K*k;if($>0||$<G)continue;var ee=b*Q+M*X+x*Z;if(ee>0||$+ee<G)continue}var ne=(Y*Q+j*X+H*Z)/G;if(ne>=0){c(ne,m(C,V,N,Y,j,H,q),S)}}}function m(e,n,r,i,a,o,c){return t.vec3.set(Y,e,n,r),t.vec3.set(j,i,a,o),t.vec3.cross(c,Y,j),t.vec3.normalize(c,c),c}function d(e,n,r){return t.vec3.set(r,1/(n[0]-e[0]),1/(n[1]-e[1]),1/(n[2]-e[2]))}function g(e,n,t,r){var i=(e[0]-r-n[0])*t[0],a=(e[3]+r-n[0])*t[0],o=Math.min(i,a),c=Math.max(i,a),s=(e[1]-r-n[1])*t[1],f=(e[4]+r-n[1])*t[1];if(o=Math.max(o,Math.min(s,f)),c=Math.min(c,Math.max(s,f)),o>c)return!1;var v=(e[2]-r-n[2])*t[2],l=(e[5]+r-n[2])*t[2];return o=Math.max(o,Math.min(v,l)),c=Math.min(c,Math.max(v,l)),o<=c}function p(e,n,r){return t.vec4.set(r,e[0]-n[0],e[1]-n[1],e[2]-n[2],1)}function h(e,n,r,i){return t.mat4.translate(E,r,n),r=E,t.vec4.transformMat4(i,e,r)}function b(e,n,r,i){return i[0]=e[0]+r[0],i[1]=e[1]+r[1],i[2]=e[2]+r[2],i[3]=e[3],t.vec4.transformMat4(i,i,n)}function M(e,n){return t.vec4.scale(n,e,1/Math.abs(e[3]))}function x(e,n,t,r,i){return c.scale(e,r,t,i)}function P(e,n,t,r,a){var o=t.screenLength||0;a&&(o=x(o,e,n,r,a));var c=o*Math.tan(.5*e.fovY)/(.5*e.fullHeight);return i.clamp(c*n,t.minWorldLength||0,null!=t.maxWorldLength?t.maxWorldLength:1/0)}function S(e,n,t){if(void 0!==e)return n.aquire(e,t)}function O(e,n){void 0!==e&&n.release(e)}function L(e,n,r){t.mat4.translate(H,n,e),r.setUniform3fv("localOrigin",e),r.setUniformMatrix4fv("view",H)}function U(e,n,t){t.setUniform3f("camPos",n[3]-e[0],n[7]-e[1],n[11]-e[2])}function B(e,n){o.encodeDoubleArraySplit(e,R,_,3),n.setUniform3fv("viewOriginHi",R),n.setUniform3fv("viewOriginLo",_)}function I(e,n,r){t.vec3.subtract(k,n.origin,e),r.setUniform3fv("slicePlaneOrigin",k),r.setUniform3fv("slicePlaneBasis1",n.basis1),r.setUniform3fv("slicePlaneBasis2",n.basis2)}function y(e,n,t){if(e){var r=A(e,n.fovY,n.viewport[3]),i=n.pixelRatio||1;t.setUniform4f("verticalOffset",r.screenLength*i,r.perDistance,r.minWorldLength,r.maxWorldLength)}}function A(e,n,t,r){return void 0===r&&(r=F),r.screenLength=e.screenLength,r.perDistance=Math.tan(.5*n)/(.5*t),r.minWorldLength=e.minWorldLength,r.maxWorldLength=e.maxWorldLength,r}function w(e,n,t,r){if(void 0===r&&(r="screenSizePerspectiveAlignment"),e){var i=e.parameters,a=n.pixelRatio||1,o=e.paddingPixelsOverride;t.setUniform4f(r,i.divisor,i.offset,i.minPixelSize*a,o)}}function W(e,n){var t=n?W(n):{};for(var r in e){var i=e[r];i&&i.forEach&&(i=D(i)),null==i&&r in t||(t[r]=i)}return t}function T(e,n){var t=!1;for(var r in n){var i=n[r];void 0!==i&&(t=!0,Array.isArray(i)?e[r]=i.slice():e[r]=i)}return t}function D(e){var n=[];return e.forEach(function(e){return n.push(e)}),n}Object.defineProperty(n,"__esModule",{value:!0});var E=t.mat4f64.create(),C=r.create(),V=s.VertexAttrConstants;n.IDENTITY=t.mat4f64.create(),n.intersectTriangleGeometry=f;var N=t.vec3f64.create(),z=Math.pow(2,-52),q=t.vec3f64.create();n.intersectTriangles=u;var Y=t.vec3f64.create(),j=t.vec3f64.create();n.computeNormal=m,n.intersectAabbInvDir=g,n.transformToWorld=p,n.transformToView=h,n.transformToProjection=b,n.transformToNDC=M,n.applyScreenSizePerspectiveScale=x,n.verticalOffsetAtDistance=P,n.aquireIfNotUndefined=S,n.releaseIfNotUndefined=O;var H=t.mat4f32.create();n.bindView=L,n.bindCamPos=U;var R=t.vec3f64.create(),_=t.vec3f64.create();n.bindViewOriginDouble=B;var k=t.vec3f64.create();n.bindSlicePlane=I,n.bindVerticalOffset=y,n.bindScreenSizePerspective=w,n.copyParameters=W,n.updateParameters=T;!function(e){function n(e,n){for(var t=[],r=0;r<2;r++)for(var a=0;a<2;a++){var o=i({shadowMappingEnabled:1===r,ssaoEnabled:1===a}),c=i({shadowMappingEnabled:1===r,ssaoEnabled:1===a&&e.receiveSSAO});t[o]=t[c]||n({receiveShadows:1===r,receiveSSAO:1===a&&e.receiveSSAO})}return{programs:t.filter(function(e){return null!=e}),byParameter:t}}function t(e,n){return e.byParameter[i(n)]}function r(e){return e.programs}function i(e){return(e.shadowMappingEnabled?1:0)|(e.ssaoEnabled?2:0)}e.create=n,e.lookup=t,e.programs=r}(n.BindParametersMap||(n.BindParametersMap={})),n.colorMixModes={multiply:1,ignore:2,replace:3,tint:4};var G=1e3,F={screenLength:0,perDistance:0,minWorldLength:0,maxWorldLength:0}});