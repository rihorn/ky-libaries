// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.10/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/extendsHelper","../../../../core/Logger","../../../../core/libs/gl-matrix-2/gl-matrix","../../support/geometryUtils","../../support/buffer/InterleavedLayout","../lib/ComponentUtils","../lib/GLMaterial","../lib/Material","../lib/Util","./internal/MaterialUtil","../shaders/RibbonLinePrograms"],function(e,t,r,n,i,a,s,o,p,l,c,f,m){var u=n.getLogger("esri.views.3d.webgl-engine.materials.RibbonLineMaterial"),g=function(e){function t(t,r){var n=e.call(this,r)||this;return n.params=f.copyParameters(t,d),"miter"!==n.params.join&&(n.params.miterLimit=0),n.numVertsAtJoin="wall"===n.params.type?2:4,n.numVertsAtCap=2,n.canBeMerged="screen"===n.params.type&&null==n.params.stippleLength,n.bufferWriter="wall"===n.params.type?new L:new P(n.canBeMerged),n}return r(t,e),t.prototype.getColor=function(){return this.params.color},t.prototype.dispose=function(){},t.prototype.getParams=function(){return this.params},t.prototype.getParameterValues=function(){var e=f.copyParameters(this.params);return e.miterLimit="miter"===e.join?e.miterLimit:0,e},t.prototype.setParameterValues=function(e){for(var t in e)c.assert("type"!==t,"RibbonLineMaterial: type cannot be changed after creation"),c.assert("stippleLength"!==t||null!=e[t]==(null!=this.params[t]),"RibbonLineMaterial: stippleLength on/off cannot be changed after creation"),this.params[t]=e[t];"miter"!==this.params.join&&(this.params.miterLimit=0),this.notifyDirty("matChanged")},t.prototype.intersect=function(e,t,r,n,s,p,l,f){if(n.isSelection&&!o.isAllHidden(t.componentVisibilities,e.data.componentOffsets)){if(!c.isTranslationMatrix(r))return void u.error("intersection assumes a translation-only matrix");var m=e.data,g=m.getVertexAttr()[c.VertexAttrConstants.POSITION].data,h=m.getVertexAttr()[c.VertexAttrConstants.SIZE],v=h&&h.data[0],d=n.camera,y=n.point,P=v+this.params.width,b=P/2+4;i.vec3.set(B[0],y[0]-b,y[1]+b,0),i.vec3.set(B[1],y[0]+b,y[1]+b,0),i.vec3.set(B[2],y[0]+b,y[1]-b,0),i.vec3.set(B[3],y[0]-b,y[1]-b,0);for(var L=0;L<4;L++)d.unprojectPoint(B[L],R[L]);a.plane.fromPoints(d.eye,R[0],R[1],T),a.plane.fromPoints(d.eye,R[1],R[2],N),a.plane.fromPoints(d.eye,R[2],R[3],j),a.plane.fromPoints(d.eye,R[3],R[0],F);for(var V=Number.MAX_VALUE,L=0;L<g.length-5;L+=3)if(A[0]=g[L]+r[12],A[1]=g[L+1]+r[13],A[2]=g[L+2]+r[14],C[0]=g[L+3]+r[12],C[1]=g[L+4]+r[13],C[2]=g[L+5]+r[14],!(a.plane.signedDistance(T,A)<0&&a.plane.signedDistance(T,C)<0||a.plane.signedDistance(N,A)<0&&a.plane.signedDistance(N,C)<0||a.plane.signedDistance(j,A)<0&&a.plane.signedDistance(j,C)<0||a.plane.signedDistance(F,A)<0&&a.plane.signedDistance(F,C)<0)){if(d.projectPoint(A,S),d.projectPoint(C,I),S[2]<0&&I[2]>0){i.vec3.subtract(w,A,C);var x=d.frustum,W=-a.plane.signedDistance(x.planes[4],A),J=W/i.vec3.dot(w,x.planes[4]);i.vec3.scale(w,w,J),i.vec3.add(A,A,w),d.projectPoint(A,S)}else if(S[2]>0&&I[2]<0){i.vec3.subtract(w,C,A);var x=d.frustum,W=-a.plane.signedDistance(x.planes[4],C),J=W/i.vec3.dot(w,x.planes[4]);i.vec3.scale(w,w,J),i.vec3.add(C,C,w),d.projectPoint(C,I)}else if(S[2]<0&&I[2]<0)continue;var q=c.pointLineSegmentDistanceSquared2D(S,I,y);q<V&&(V=q,i.vec3.copy(D,A),i.vec3.copy(U,C))}var X=n.p0,Z=n.p1;if(V<b*b){var z=Number.MAX_VALUE;if(a.lineSegment.closestLineSegmentPoint(a.lineSegment.fromPoints(D,U,E),a.lineSegment.fromPoints(X,Z,M),O)){i.vec3.subtract(O,O,X);var G=i.vec3.length(O);i.vec3.scale(O,O,1/G),z=G/i.vec3.distance(X,Z)}l(z,O)}}},t.prototype.getGLMaterials=function(){return{color:h,depthShadowMap:void 0,normal:void 0,depth:void 0,highlight:v}},t.prototype.getAllTextureIds=function(){return[]},t}(l),h=function(e){function t(t,r){var n=e.call(this,t,r)||this;return n.updateParameters(),n}return r(t,e),t.prototype.updateParameters=function(){this.params=this.material.getParameterValues(),this.selectProgram()},t.prototype.beginSlot=function(e){return e===(this.params.writeDepth?6:9)},t.prototype.getProgram=function(){return this.program},t.prototype.selectProgram=function(){this.program=this.programRep.getProgram(m.colorPass,{screenScale:"screen"===this.params.type,wall:"wall"===this.params.type,stipple:null!=this.params.stippleLength,slice:this.params.slicePlaneEnabled})},t.prototype.bind=function(e,t){var r=this,n=r.program,i=r.params;if(e.bindProgram(n),n.setUniform4fv("eColor",i.color),n.setUniform1f("miterLimit",i.miterLimit),n.setUniform1f("nearPlane",t.nearFar[0]),"screen"===i.type?(n.setUniform2fv("screenSize",[t.viewport[2],t.viewport[3]]),n.setUniform1f("extLineWidth",i.width*t.pixelRatio)):n.setUniform1f("extLineWidth",i.width),null!=i.stippleLength){var a=i.stippleLength?1/(2*i.stippleLength):0;n.setUniform1f("stippleLengthDoubleInv",a)}i.polygonOffset&&(e.setPolygonOffsetFillEnabled(!0),e.setPolygonOffset(0,-4)),e.setFaceCullingEnabled(!1),e.setBlendingEnabled(!0),e.setBlendFunctionSeparate(770,771,1,771),e.setDepthTestEnabled(!0),e.setDepthWriteEnabled(i.color[3]>=1&&i.writeDepth)},t.prototype.release=function(e){this.params.polygonOffset&&e.setPolygonOffsetFillEnabled(!1),e.setBlendingEnabled(!1),e.setDepthWriteEnabled(!0)},t.prototype.bindView=function(e,t){var r=this.program,n=this.params;f.bindView(t.origin,t.view,r),n.slicePlaneEnabled&&f.bindSlicePlane(t.origin,t.slicePlane,r)},t.prototype.bindInstance=function(e,t){this.program.setUniformMatrix4fv("model",t.transformation)},t.prototype.getDrawMode=function(){return 5},t}(p),v=function(e){function t(t,r){var n=e.call(this,t,r)||this;return n.updateParameters(),n}return r(t,e),t.prototype.updateParameters=function(){this.params=this.material.getParameterValues(),this.selectProgram()},t.prototype.beginSlot=function(e){return 4===e},t.prototype.getProgram=function(){return this.program},t.prototype.selectProgram=function(){this.program=this.programRep.getProgram(m.highlightPass,{screenScale:"screen"===this.params.type,wall:"wall"===this.params.type,stipple:null!=this.params.stippleLength,slice:this.params.slicePlaneEnabled})},t.prototype.bind=function(e,t){var r=this,n=r.program,i=r.params;if(e.bindProgram(n),n.setUniform4fv("eColor",i.color),n.setUniform1f("miterLimit",i.miterLimit),n.setUniform1f("nearPlane",t.nearFar[0]),"screen"===i.type?(n.setUniform2fv("screenSize",[t.viewport[2],t.viewport[3]]),n.setUniform1f("extLineWidth",i.width*t.pixelRatio)):n.setUniform1f("extLineWidth",i.width),null!=i.stippleLength){var a=i.stippleLength?1/(2*i.stippleLength):0;n.setUniform1f("stippleLengthDoubleInv",a)}i.polygonOffset&&(e.setPolygonOffsetFillEnabled(!0),e.setPolygonOffset(0,-4)),e.setFaceCullingEnabled(!1),e.setDepthTestEnabled(!0),e.setDepthWriteEnabled(i.color[3]>=1)},t.prototype.release=function(e){this.params.polygonOffset&&e.setPolygonOffsetFillEnabled(!1),e.setDepthWriteEnabled(!0)},t.prototype.bindView=function(e,t){var r=this.program,n=this.params;f.bindView(t.origin,t.view,r),n.slicePlaneEnabled&&f.bindSlicePlane(t.origin,t.slicePlane,r)},t.prototype.bindInstance=function(e,t){this.program.setUniformMatrix4fv("model",t.transformation)},t.prototype.getDrawMode=function(){return 5},t}(p),d={color:[1,1,1,1],width:0,type:"screen",join:"miter",miterLimit:5,writeDepth:!0,polygonOffset:!1,stippleLength:null,slicePlaneEnabled:!1},y=s.newLayout().vec3f(c.VertexAttrConstants.POSITION).vec2f(c.VertexAttrConstants.UV0).vec3f(c.VertexAttrConstants.AUXPOS1).vec3f(c.VertexAttrConstants.AUXPOS2).vec4f(c.VertexAttrConstants.COLOR).f32(c.VertexAttrConstants.SIZE),P=function(){function e(e){this.canBeMerged=e,this.vertexBufferLayout=y,this.numVertsAtJoin=4,this.numVertsAtCap=2}return e.prototype.allocate=function(e){return y.createBuffer(e)},e.prototype.elementCount=function(e){var t=e.indices[c.VertexAttrConstants.POSITION].length/2+1,r=(t-2)*this.numVertsAtJoin+2*this.numVertsAtCap;return this.canBeMerged&&(r+=2),r},e.prototype.write=function(e,t,r,n,i){var a=t.vertexAttr[c.VertexAttrConstants.POSITION].data,s=t.indices&&t.indices[c.VertexAttrConstants.POSITION];s&&s.length!==2*(a.length/3-1)&&console.warn("RibbonLineMaterial does not support indices");var o=t.vertexAttr[c.VertexAttrConstants.COLOR]?t.vertexAttr[c.VertexAttrConstants.COLOR].data:V,p=t.vertexAttr[c.VertexAttrConstants.SIZE]?t.vertexAttr[c.VertexAttrConstants.SIZE].data:x,l=a.length/3,f=e.transformation,m=n.position.typedBuffer,u=0,g=this.vertexBufferLayout.stride/4,h=i*g,v=h;this.canBeMerged&&(h+=g);var d=a[0],y=a[1],P=a[2];if(f){var b=d,L=y,A=P;d=f[0]*b+f[4]*L+f[8]*A+f[12],y=f[1]*b+f[5]*L+f[9]*A+f[13],P=f[2]*b+f[6]*L+f[10]*A+f[14]}var C=a[3],w=a[4],O=a[5];if(f){var b=C,L=w,A=O;C=f[0]*b+f[4]*L+f[8]*A+f[12],w=f[1]*b+f[5]*L+f[9]*A+f[13],O=f[2]*b+f[6]*L+f[10]*A+f[14]}for(var S=d,I=y,D=P,U=0;U<l;U++){var E=3*U;if(U<l-1&&(C=a[E+3],w=a[E+4],O=a[E+5],f)){var b=C,L=w,A=O;C=f[0]*b+f[4]*L+f[8]*A+f[12],w=f[1]*b+f[5]*L+f[9]*A+f[13],O=f[2]*b+f[6]*L+f[10]*A+f[14]}u+=Math.sqrt((S-d)*(S-d)+(I-y)*(I-y)+(D-P)*(D-P)),m[h++]=S,m[h++]=I,m[h++]=D,m[h++]=u,m[h++]=0===U?-1.2:-1,m[h++]=d,m[h++]=y,m[h++]=P,m[h++]=C,m[h++]=w,m[h++]=O,m[h++]=o[0],m[h++]=o[1],m[h++]=o[2],m[h++]=o[3],m[h++]=p[0],m[h++]=S,m[h++]=I,m[h++]=D,m[h++]=u,m[h++]=0===U?1.2:1,m[h++]=d,m[h++]=y,m[h++]=P,m[h++]=C,m[h++]=w,m[h++]=O,m[h++]=o[0],m[h++]=o[1],m[h++]=o[2],m[h++]=o[3],m[h++]=p[0],U>0&&U<l-1&&(m[h++]=S,m[h++]=I,m[h++]=D,m[h++]=u,m[h++]=-1.2,m[h++]=d,m[h++]=y,m[h++]=P,m[h++]=C,m[h++]=w,m[h++]=O,m[h++]=o[0],m[h++]=o[1],m[h++]=o[2],m[h++]=o[3],m[h++]=p[0],m[h++]=S,m[h++]=I,m[h++]=D,m[h++]=u,m[h++]=1.2,m[h++]=d,m[h++]=y,m[h++]=P,m[h++]=C,m[h++]=w,m[h++]=O,m[h++]=o[0],m[h++]=o[1],m[h++]=o[2],m[h++]=o[3],m[h++]=p[0]),d=S,y=I,P=D,S=C,I=w,D=O}if(this.canBeMerged){for(var U=v;U<v+g;U++)m[U]=m[U+g];for(var M=h-g,U=0;U<g;U++)m[h++]=m[M++]}},e}(),b=s.newLayout().vec3f(c.VertexAttrConstants.POSITION).vec2f(c.VertexAttrConstants.UV0),L=function(){function e(){this.vertexBufferLayout=b,this.numVertsAtJoin=2,this.numVertsAtCap=2,this.tmpCurrent=i.vec3f64.create(),this.tmpLast=i.vec3f64.create()}return e.prototype.allocate=function(e){return y.createBuffer(e)},e.prototype.elementCount=function(e){return(e.indices[c.VertexAttrConstants.POSITION].length/2+1-2)*this.numVertsAtJoin+2*this.numVertsAtCap},e.prototype.write=function(e,t,r,n,a){var s=t.vertexAttr[c.VertexAttrConstants.POSITION].data,o=t.indices&&t.indices[c.VertexAttrConstants.POSITION];o&&o.length!==2*(s.length/3-1)&&console.warn("RibbonLineMaterial does not support indices");var p=s.length/3,l=e.transformation,f=0,m=this.tmpCurrent,u=this.tmpLast;i.vec3.set(m,s[0],s[1],s[2]);for(var g=a,h=0;h<p;h++){var v=3*h;i.vec3.copy(u,m),i.vec3.set(m,s[v],s[v+1],s[v+2]),l&&i.vec3.transformMat4(m,m,l),f+=i.vec3.squaredDistance(u,m),n.position.setVec(g,m),n.uv0.set(g,0,f),n.uv0.set(g,1,-1),++g,n.position.setVec(g,m),n.uv0.set(g,0,f),n.uv0.set(g,1,1),++g}},e}(),V=[255,255,255,255],x=[0,0,0,0],A=i.vec3f64.create(),C=i.vec3f64.create(),w=i.vec3f64.create(),O=i.vec3f64.create(),S=i.vec3f64.create(),I=i.vec3f64.create(),D=i.vec3f64.create(),U=i.vec3f64.create(),E=a.lineSegment.create(),M=a.lineSegment.create(),B=[i.vec3f64.create(),i.vec3f64.create(),i.vec3f64.create(),i.vec3f64.create()],R=[i.vec3f64.create(),i.vec3f64.create(),i.vec3f64.create(),i.vec3f64.create()],T=a.plane.create(),N=a.plane.create(),j=a.plane.create(),F=a.plane.create();return g});