// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.10/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/extendsHelper","../../../../core/Logger","../../../../core/libs/gl-matrix-2/gl-matrix","../../support/geometryUtils","../../support/buffer/InterleavedLayout","../lib/ComponentUtils","../lib/GLMaterial","../lib/Material","../lib/Util","./internal/bufferWriters","./internal/MaterialUtil","../shaders/NativeLinePrograms"],function(e,t,r,n,a,i,o,s,c,l,p,f,u,m){var g,d=n.getLogger("esri.views.3d.webgl-engine.materials.NativeLineMaterial"),v=function(e){function t(t,r){var n=e.call(this,r)||this;return n.bufferWriter=new S,n.canBeMerged=!0,n.params=u.copyParameters(t,y),n}return r(t,e),t.prototype.setParameterValues=function(e){var t=this.params;for(var r in e)t[r]=e[r];this.notifyDirty("matChanged")},t.prototype.getColor=function(){return this.params.color},t.prototype.getParameterValues=function(){return u.copyParameters(this.params)},t.prototype.intersect=function(e,t,r,n,o,c,l,f){if(n.isSelection&&!s.isAllHidden(t.componentVisibilities,e.data.componentOffsets)){if(!p.isTranslationMatrix(r))return void d.error("intersection assumes a translation-only matrix");var u=e.data.getVertexAttr().position.data,m=n.camera,g=n.point;a.vec3.set(U[0],g[0]-2,g[1]+2,0),a.vec3.set(U[1],g[0]+2,g[1]+2,0),a.vec3.set(U[2],g[0]+2,g[1]-2,0),a.vec3.set(U[3],g[0]-2,g[1]-2,0);for(var v=0;v<4;v++)m.unprojectPoint(U[v],B[v]);i.plane.fromPoints(m.eye,B[0],B[1],C),i.plane.fromPoints(m.eye,B[1],B[2],N),i.plane.fromPoints(m.eye,B[2],B[3],T),i.plane.fromPoints(m.eye,B[3],B[0],j);for(var h=Number.MAX_VALUE,v=0;v<u.length-5;v+=3)if(x[0]=u[v]+r[12],x[1]=u[v+1]+r[13],x[2]=u[v+2]+r[14],D[0]=u[v+3]+r[12],D[1]=u[v+4]+r[13],D[2]=u[v+5]+r[14],!(i.plane.signedDistance(C,x)<0&&i.plane.signedDistance(C,D)<0||i.plane.signedDistance(N,x)<0&&i.plane.signedDistance(N,D)<0||i.plane.signedDistance(T,x)<0&&i.plane.signedDistance(T,D)<0||i.plane.signedDistance(j,x)<0&&i.plane.signedDistance(j,D)<0)){if(m.projectPoint(x,L),m.projectPoint(D,M),L[2]<0&&M[2]>0){a.vec3.subtract(V,x,D);var P=m.frustum,y=-i.plane.signedDistance(P.planes[4],x),b=y/a.vec3.dot(V,P.planes[4]);a.vec3.scale(V,V,b),a.vec3.add(x,x,V),m.projectPoint(x,L)}else if(L[2]>0&&M[2]<0){a.vec3.subtract(V,D,x);var P=m.frustum,y=-i.plane.signedDistance(P.planes[4],D),b=y/a.vec3.dot(V,P.planes[4]);a.vec3.scale(V,V,b),a.vec3.add(D,D,V),m.projectPoint(D,M)}else if(L[2]<0&&M[2]<0)continue;var S=p.pointLineSegmentDistanceSquared2D(L,M,g);S<h&&(h=S,a.vec3.copy(A,x),a.vec3.copy(I,D))}var q=n.p0,F=n.p1;if(h<4){var G=Number.MAX_VALUE;if(i.lineSegment.closestLineSegmentPoint(i.lineSegment.fromPoints(A,I,E),i.lineSegment.fromPoints(q,F,O),w)){a.vec3.subtract(w,w,q);var H=a.vec3.length(w);a.vec3.scale(w,w,1/H),G=H/a.vec3.distance(q,F)}l(G,w)}}},t.prototype.getGLMaterials=function(){return{color:h,depthShadowMap:void 0,normal:void 0,depth:void 0,highlight:P}},t.prototype.getAllTextureIds=function(){return[]},t}(l),h=function(e){function t(t,r,n){var a=e.call(this,t,r)||this;return a.updateParameters(),a}return r(t,e),t.prototype.updateParameters=function(){this.params=this.material.getParameterValues(),this.selectProgram()},t.prototype.selectProgram=function(){this.program=this.programRep.getProgram(m.colorPass,{slice:this.params.slicePlaneEnabled})},t.prototype.beginSlot=function(e){return 4===e},t.prototype.getProgram=function(){return this.program},t.prototype.bind=function(e,t){var r=this.program,n=this.params;e.bindProgram(r),r.setUniform4fv("color",n.color),e.setBlendingEnabled(n.color[3]<1),e.setBlendFunctionSeparate(770,771,1,771),e.setDepthTestEnabled(!0)},t.prototype.release=function(e){this.params.color[3]<1&&e.setBlendingEnabled(!1)},t.prototype.bindView=function(e,t){var r=this.program,n=this.params;u.bindView(t.origin,t.view,r),n.slicePlaneEnabled&&u.bindSlicePlane(t.origin,t.slicePlane,r)},t.prototype.bindInstance=function(e,t){this.program.setUniformMatrix4fv("model",t.transformation)},t.prototype.getDrawMode=function(){return 1},t}(c),P=function(e){function t(t,r,n){var a=e.call(this,t,r)||this;return a.updateParameters(),a}return r(t,e),t.prototype.updateParameters=function(){this.params=this.material.getParameterValues(),this.selectProgram()},t.prototype.beginSlot=function(e){return 4===e},t.prototype.getProgram=function(){return this.program},t.prototype.selectProgram=function(){this.program=this.programRep.getProgram(m.highlightPass,{slice:this.params.slicePlaneEnabled})},t.prototype.bind=function(e,t){e.bindProgram(this.program),e.setDepthTestEnabled(!0)},t.prototype.release=function(e){},t.prototype.bindView=function(e,t){var r=this.program,n=this.params;u.bindView(t.origin,t.view,r),n.slicePlaneEnabled&&u.bindSlicePlane(t.origin,t.slicePlane,r)},t.prototype.bindInstance=function(e,t){this.program.setUniformMatrix4fv("model",t.transformation)},t.prototype.getDrawMode=function(){return 1},t}(c),y={color:[1,1,1,1],slicePlaneEnabled:!1},b=o.newLayout().vec3f(p.VertexAttrConstants.POSITION),S=function(){function e(){this.vertexBufferLayout=b}return e.prototype.allocate=function(e){return this.vertexBufferLayout.createBuffer(e)},e.prototype.elementCount=function(e){return e.indices[p.VertexAttrConstants.POSITION].length},e.prototype.write=function(e,t,r,n,a){var i=t.vertexAttr[p.VertexAttrConstants.POSITION].data,o=i,s=e.transformation;if(s){(!g||g.length<i.length)&&(g=new Float32Array(i.length)),o=g;for(var c=0;c<i.length;c+=3){var l=i[c],u=i[c+1],m=i[c+2];o[c]=s[0]*l+s[4]*u+s[8]*m+s[12],o[c+1]=s[1]*l+s[5]*u+s[9]*m+s[13],o[c+2]=s[2]*l+s[6]*u+s[10]*m+s[14]}}var d=t.indices[p.VertexAttrConstants.POSITION];f.writeBufferVec3(d,o,n.position,a)},e}(),x=a.vec3f64.create(),D=a.vec3f64.create(),V=a.vec3f64.create(),w=a.vec3f64.create(),L=a.vec3f64.create(),M=a.vec3f64.create(),A=a.vec3f64.create(),I=a.vec3f64.create(),E=i.lineSegment.create(),O=i.lineSegment.create(),U=[a.vec3f64.create(),a.vec3f64.create(),a.vec3f64.create(),a.vec3f64.create()],B=[a.vec3f64.create(),a.vec3f64.create(),a.vec3f64.create(),a.vec3f64.create()],C=i.plane.create(),N=i.plane.create(),T=i.plane.create(),j=i.plane.create();return v});