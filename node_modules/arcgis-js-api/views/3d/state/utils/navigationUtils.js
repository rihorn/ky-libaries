// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.10/esri/copyright.txt for details.

define(["require","exports","../../../../core/libs/gl-matrix-2/gl-matrix","../../support/earthUtils","../../support/geometryUtils","../../support/mathUtils","../../support/stack","../../support/geometryUtils/coordinateSystem","../../webgl-engine/lib/Camera"],function(e,t,r,a,c,n,o,i,s){function v(e,t,r){return r[0]=t[0]/e.fullWidth,r[1]=t[1]/e.fullHeight,r}function l(e,t,a,n){var i=c.ray.fromScreenAtEye(t,a,ve),s=c.sphere.intersectRay(e,i,n),v=c.sphere.closestPointOnSilhouette(e,i,o.sv3d.get());return!(!s||r.vec3.squaredDistance(v,i.origin)<r.vec3.squaredDistance(n,i.origin))||(r.vec3.copy(n,v),!1)}function d(e,t,a){var c=o.sv3d.get(),n=o.sv3d.get(),i=o.sv3d.get();r.vec3.copy(n,e),r.vec3.copy(i,t);var s=r.vec3.dot(n,a),v=r.vec3.dot(i,a);r.vec3.scale(c,a,s),r.vec3.subtract(n,n,c),r.vec3.normalize(n,n),r.vec3.scale(c,a,v),r.vec3.subtract(i,i,c),r.vec3.normalize(i,i);var l=r.vec3.dot(n,i);r.vec3.cross(c,a,n);var d=r.vec3.dot(i,c);return Math.atan2(d,l)}function u(e){for(;e>Math.PI;)e-=2*Math.PI;for(;e<-Math.PI;)e+=2*Math.PI;return e}function h(e,t,a){var c=o.sm4d.get();r.mat4.identity(c),r.mat4.rotate(c,c,a[3],a),r.vec3.subtract(e.eye,e.eye,t),r.vec3.transformMat4(e.eye,e.eye,c),r.vec3.add(e.eye,e.eye,t),r.vec3.subtract(e.center,e.center,t),r.vec3.transformMat4(e.center,e.center,c),r.vec3.add(e.center,e.center,t),r.vec3.transformMat4(e.up,e.up,c),e.markViewDirty()}function f(e,t,r,a){return c.plane.intersectRay(e,c.ray.fromScreen(t,r,ve),a)}function m(e,t,a,c){var n=o.sv3d.get(),i=1-a;r.vec3.subtract(n,t,e.eye);var s=r.vec3.length(n),v=s*(1-i);i>=0&&v<c&&(v=c,i=-(v-s)/s),Math.abs(s-v)<1e-6||(r.vec3.scale(n,n,i),r.vec3.add(e.eye,e.eye,n),r.vec3.lerp(e.center,e.center,t,i))}function p(e,t,a){r.vec2.set(O,t.padding[3]+t.width/2,t.padding[2]+t.height/2),c.sphere.intersectScreen(e,t,O,t.center),t.markViewDirty();var n=t.distance,i=n*a;if(!(Math.abs(n-i)<1e-6)){var s=r.vec3.scale(o.sv3d.get(),t.viewForward,i);r.vec3.subtract(t.eye,t.center,s),t.markViewDirty()}}function y(e,t,a){r.vec2.set(a,t.x,e.fullHeight-t.y)}function g(e,t,a){P(t,a),r.vec3.normalize(a,a),r.vec3.scale(a,a,e)}function P(e,t){r.vec3.set(t,0,0,0);for(var a=0,c=e;a<c.length;a++){var n=c[a];r.vec3.add(t,t,n)}r.vec3.scale(t,t,1/e.length)}function M(e,t,c){return Math.sin(e/r.vec3.length(t))*(c+a.earthRadius)}function b(e,t,r){return M(Math.PI/2,t,r)+(e-Math.PI/2)}function A(e,a,n,o){var i=r.vec3f64.create(),s=c.sphere.create(),v=!0;return e.intersectScreen(n,i)?s.radius=r.vec3.length(i):(a.aboveGround?s.radius=Math.max(r.vec3.length(a.center),.9*t.Earth.radius):s.radius=r.vec3.length(a.eye)-a.relativeElevation,o?z(s,a,n,i):v=c.sphere.intersectScreen(s,a,n,i)),{sphere:s,scenePickPoint:v?i:null}}function T(e,a,c){var o=r.vec3.length(e.eye),i=o-t.Earth.radius;if(Math.abs(i)>t.VerticalPanTresholds.Elevation)return k.Horizontal;var s=a.radius>o;return e.aboveGround===s?k.Vertical:(r.vec3.subtract(G,e.eye,c),r.vec3.normalize(G,G),Math.abs(.5*Math.PI-n.acos(r.vec3.dot(c,G)/r.vec3.length(c)))<t.VerticalPanTresholds.Angle?k.Vertical:k.Horizontal)}function S(e,t,a){r.vec3.subtract(C,a,t),r.vec3.subtract(e.eye,e.eye,C),r.vec3.subtract(e.center,e.center,C),e.markViewDirty()}function z(e,t,a,n){var o=c.ray.fromScreenAtEye(t,a,ve);return c.sphere.closestPointOnSilhouette(e,o,U),c.sphere.intersectRay(e,o,n)?!(r.vec3.squaredDistance(U,o.origin)<r.vec3.squaredDistance(n,o.origin))||(r.vec3.copy(n,U),!1):(r.vec3.subtract(N,t.eye,t.center),r.vec3.normalize(N,N),c.plane.fromNormalAndOffset(N,-r.vec3.dot(r.vec3.normalize(N,N),U),W),c.plane.intersectRay(W,o,n),!1)}function w(e,a,c,o,i,s){var v;if(r.vec3.cross(ie,e,a),r.vec3.subtract(ne,e,a),r.vec3.length(e)<=i||!o.aboveGround){r.vec3.cross(c,ne,o.eye);var l=r.vec3.dot(e,a)/(r.vec3.length(e)*r.vec3.length(a)),d=Math.cos(n.clamp(n.cyclicalPI.normalize(n.deg2rad(s)),0,t.TiltThresholdPanningSpeed));v=-n.acos(l)-Math.max(0,r.vec3.length(a)-i)/(d*i)}else r.vec3.subtract(Z,o.eye,o.center),r.vec3.cross(c,ne,Z),v=-r.vec3.length(ne)/i;return r.vec3.normalize(c,c),r.vec3.scale(c,c,r.vec3.length(ie)),v}function x(e,r,a,c){var o,i=Math.cos(n.clamp(n.cyclicalPI.normalize(n.deg2rad(c)),0,t.TiltThresholdPanningSpeed));return o=r>a?-(r-a)/(i*a):r<-a?Math.PI-(r+a)/(i*a):n.acos(r/a),((e>a?-(e-a)/(i*a):e<-a?Math.PI-(e+a)/(i*a):n.acos(e/a))-o)*a}function D(e,t,a,c,n,o,i,s,v,l){var d=x(e[2],t[2],i.radius,v),u=l?x(e[0],t[0],i.radius,180):t[0]-e[0],h=Math.sin(s)*u-Math.cos(s)*d,f=Math.cos(s)*u+Math.sin(s)*d;r.vec3.normalize(ce,n);var m=l?h/Math.sqrt(Math.abs(Math.pow(i.radius,2)-Math.pow(r.vec3.dot(a,ce),2))):h/i.radius,p=f/Math.sqrt(Math.abs(Math.pow(i.radius,2)-Math.pow(r.vec3.dot(a,c),2)));r.vec2.set(o,m,p)}function I(e,t,a,c,n,o,s,v,l,d){r.vec3.cross(ie,e,t),i.coordinateSystemFromOneAxisAndNormalVector(o.up,o.eye,J,K,L),i.coordinateSystemFromOneAxisAndNormalVector([0,0,1],o.eye,_,j,B),r.vec3.copy(a,j),r.vec3.copy(c,_),r.vec3.normalize(a,a),r.vec3.scale(a,a,r.vec3.length(ie)),i.vectorCoordinates(e,r.vec3.normalize(K,K),r.vec3.normalize(L,L),r.vec3.normalize(J,J),Q),i.vectorCoordinates(t,K,L,J,X),D(Q,X,e,_,j,n,s,v,l,d)}function V(e,t,a,c,n,o,i){r.mat4.identity(ee),r.mat4.identity(te),r.mat4.identity(re),r.mat4.rotate(ee,ee,n,c),r.mat4.rotate(te,te,i,o),r.mat4.multiply(re,ee,te),r.vec3.subtract(t,e,a),r.vec3.transformMat4(t,t,re),r.vec3.add(t,t,a)}function H(e,t,a,c,n,o){r.mat4.identity(ee),r.mat4.identity(te),r.mat4.identity(re),r.mat4.rotate(ee,ee,c,a),r.mat4.rotate(te,te,o,n),r.mat4.multiply(re,ee,te),r.vec3.subtract(e.eye,e.eye,t),r.vec3.transformMat4(e.eye,e.eye,re),r.vec3.add(e.eye,e.eye,t),r.vec3.subtract(e.center,e.center,t),r.vec3.transformMat4(e.center,e.center,re),r.vec3.add(e.center,e.center,t),r.vec3.subtract(e.up,e.up,t),r.vec3.transformMat4(e.up,e.up,re),r.vec3.add(e.up,e.up,t),e.markViewDirty()}function R(e,r,a,c,n,o,i,s){var v=Math.abs(o)>Math.PI-n||Math.abs(o)<n,l=Math.abs(e[2])<a*c||Math.abs(r)>a;return!!(v&&l&&s.aboveGround&&i<t.PreservingHeadingThreshold.Tilt)}function q(e,t,r,a,n,o){if(o)c.axisAngle.fromPoints(r,a,$),h(t,e.center,$);else{var i=w(r,a,se,t,e.radius,n);h(t,e.center,c.axisAngle.wrapAxisAngle(se,i))}}function E(e,t,a,c,n,o,i){var s=i?20:1;r.vec3.copy(ae,c),oe.copyFrom(t);for(var v,l=0;l<s&&r.vec3.squaredDistance(a,ae)>1e-12&&(v=r.vec3.squaredDistance(a,ae),I(a,ae,j,_,Y,oe,e,n,o,i),H(oe,e.center,_,Y[1],j,Y[0]),V(ae,ae,e.center,_,Y[1],j,Y[0]),r.vec3.squaredDistance(a,ae)<v||0===l);l++)t.copyFrom(oe)}function F(e,a,c,o,i,s,v){R(c,r.vec3.dot(a.up,c),e.radius,t.PreservingHeadingThreshold.Pole,t.PreservingHeadingThreshold.Angle,-n.cyclicalPI.normalize(n.deg2rad(i)),s,a)?E(e,a,c,o,-n.cyclicalPI.normalize(n.deg2rad(i)),s,v):q(e,a,c,o,s,v)}Object.defineProperty(t,"__esModule",{value:!0}),t.Earth=c.sphere.fromValues(a.earthRadius,r.vec3f64.create()),t.normalizeCoordinate=v,t.sphereOrSilhouettePointFromScreenPoint=l,t.rotationFromPointsAroundAxis=d,t.normalizeRotationDelta=u,t.applyRotation=h,t.intersectPlaneFromScreenPoint=f,t.applyZoomToPoint=m,t.applyZoomOnSphere=p;var O=r.vec2f64.create();t.navPointToScreenPoint=y,t.centroidOnSphere=g,t.centroid=P,t.onSurfaceTiltToEyeTiltGlobal=M,t.offSurfaceTiltToEyeTiltGlobal=b;var k;!function(e){e[e.Vertical=0]="Vertical",e[e.Horizontal=1]="Horizontal"}(k=t.PanMode||(t.PanMode={})),t.VerticalPanTresholds={Elevation:3e4,Angle:n.deg2rad(8)},t.PreservingHeadingThreshold={Pole:.95,Angle:n.deg2rad(18),Tilt:80},t.TiltThresholdPanningSpeed=n.deg2rad(80),t.pickPointAndInitSphere=A,t.decidePanMode=T;var G=r.vec3f64.create();t.applyPanPlanar=S;var C=r.vec3f64.create();t.sphereOrPlanePointFromScreenPoint=z;var U=r.vec3f64.create(),N=r.vec3f64.create(),W=c.plane.create();t.rotationAngleAndAxisDirectRotation=w;var Z=r.vec3f64.create();t.lengthFromPoints=x,t.rotationAnglesHeadingPreserving=D,t.rotationAnglesAndAxesHeadingPreserving=I,t.rotatePointAroundTwoAxes=V,t.applyRotationWithTwoAxes=H,t.preserveHeadingThreshold=R,t.applyPanSphericalDirectRotation=q,t.applyPanSphericalPreserveHeading=E,t.panToPosition=F;var _=r.vec3f64.create(),j=r.vec3f64.create(),B=r.vec3f64.create(),J=r.vec3f64.create(),K=r.vec3f64.create(),L=r.vec3f64.create(),Q=r.vec3f64.create(),X=r.vec3f64.create(),Y=r.vec2f64.create(),$=c.axisAngle.create(),ee=r.mat4f64.create(),te=r.mat4f64.create(),re=r.mat4f64.create(),ae=r.vec3f64.create(),ce=r.vec3f64.create(),ne=r.vec3f64.create(),oe=new s,ie=r.vec3f64.create(),se=r.vec3f64.create(),ve={origin:r.vec3f64.create(),direction:r.vec3f64.create()}});