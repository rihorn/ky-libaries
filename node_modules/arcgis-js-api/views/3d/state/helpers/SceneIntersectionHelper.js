// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.10/esri/copyright.txt for details.

define(["require","exports","../../../../core/libs/gl-matrix-2/gl-matrix","../../support/geometryUtils","../../support/stack","../../webgl-engine/lib/Selector","../../webgl-engine/lib/SelectorUtils"],function(e,t,i,r,n,o,a){function c(e,t){if(!e)return!1;var i=e.minResult;return!!i&&i.getIntersectionPoint(t)}Object.defineProperty(t,"__esModule",{value:!0});var s=function(){function e(e,t,i){this.viewingMode=e,this.layerProvider=t,this.viewPropertyProvider=i,this.tmpSelector=new o(this.viewingMode),this.tmpRay=r.ray.create(),this.externalIntersectionHandlers=new Set,this.intersectionTolerance=o.DEFAULT_TOLERANCE,this.validateHUDSelector=new o(this.viewingMode),this.validateHUDSelector.enableHUDSelection=!1}return e.prototype.intersectScreen=function(e,t,i){return this.intersectRay(this.getPickRay(e,this.tmpRay),t,i)},e.prototype.intersectScreenFreePointFallback=function(e,t,i){return this.intersectRayFreePointFallback(this.getPickRay(e,this.tmpRay),t,i)},e.prototype.intersectRay=function(e,t,i){return i=this.computeIntersection(e,null,null,!1,i||this.tmpSelector),c(i,t)},e.prototype.intersectRayFreePointFallback=function(e,t,i){return this.intersectRay(e,t,i)||this.intersectRayFreePointLocal(e,t)},e.prototype.intersectSelectorScreen=function(e,t,i,r){return void 0===r&&(r=!1),this.computeIntersection(this.getPickRay(e,this.tmpRay),e,i,r,t)},e.prototype.intersectToolSelectorScreen=function(e,t){var i=this.getPickRay(e,this.tmpRay),r=this.computeIntersection(i,e,null,!0,t),n=r.minResult;return this.viewPropertyProvider.hasOpaqueTerrain()||n.hasIntersectionPoint&&"TerrainRenderer"!==n.intersector||(r=this.computeIntersection(i,e,null,!1,t)),r},e.prototype.setTolerance=function(e){void 0===e&&(e=o.DEFAULT_TOLERANCE),this.intersectionTolerance=e},e.prototype.addIntersectionHandler=function(e){this.externalIntersectionHandlers.add(e)},e.prototype.removeIntersectionHandler=function(e){this.externalIntersectionHandlers.delete(e)},e.prototype.getPickRay=function(e,t){void 0===t&&(t=r.ray.create());var i=this.viewPropertyProvider.camera();return r.ray.fromScreen(i,e,t)},e.prototype.intersectRayFreePointLocal=function(e,t){if("local"!==this.viewingMode)return!1;var r=this.viewPropertyProvider.extent(),o={x:r.xmax-r.xmin,y:r.ymax-r.ymin,z:8*Math.max(r.xmax-r.xmin,r.ymax-r.ymin)},a=Math.max(o.x,o.y,o.z);if(0===a)return i.vec3.add(t,e.origin,i.vec3.normalize(n.sv3d.get(),e.direction)),!0;var c=this.viewPropertyProvider.camera(),s=Math.max(0,r.xmin-c.eye[0],c.eye[0]-r.xmax),l=Math.max(0,r.ymin-c.eye[1],c.eye[1]-r.ymax),u=Math.sqrt(s*s+l*l),h=Math.abs(c.relativeElevation)+Number.MIN_VALUE,d=Math.pow(Math.max(0,Math.log(a/h)),2),v=a/Math.max(1,d);v=Math.max(v,Math.min(u,a));var p=i.vec3.scale(n.sv3d.get(),e.direction,v/i.vec3.length(e.direction));return i.vec3.add(t,e.origin,p),!0},e.prototype.computeIntersection=function(e,t,r,c,s){var l=this,u=this.viewPropertyProvider.camera(),h=n.sv3d.get();u.projectPoint(e.origin,h),t?i.vec2.copy(t,h):t=h;var d=[],v=[];this.layerProvider.forEachLayer(function(e){e.isPickable&&(e.isSliceable?v:d).push(e)}),r&&(d=d.filter(function(e){return r.has(e.id)}),v=v.filter(function(e){return r.has(e.id)})),s=s||new o(this.viewingMode);var p=e.origin,y=i.vec3.add(n.sv3d.get(),e.origin,e.direction);s.init(d,p,y,t,u,this.intersectionTolerance,c,null);var m=this.viewPropertyProvider.slicePlane(),P=m?a.sliceFilterPredicate(m):null;if(s.run(v,p,y,t,u,this.intersectionTolerance,c,P),this.externalIntersectionHandlers.forEach(function(e){var i=e.slicePlaneEnabled?P:null;e.intersect(s,i,p,y,t)}),s.hudResults.length){var f=s.hudResults;f.sort(function(e,t){return t.dist-e.dist});var g=f[f.length-1],x=n.sv3d.get(),R=n.sv3d.get(),M=n.sv3d.get();this.unprojectHUDResultHit(g.center,x,R,M);var S=i.vec3.distance(g.center,R)/i.vec3.distance(R,M)*.99;this.validateHUDSelector.init(d,R,M,x,u,this.intersectionTolerance,c,null),this.validateHUDSelector.run(v,R,M,x,u,this.intersectionTolerance,c,P),this.externalIntersectionHandlers.forEach(function(e){var t=e.slicePlaneEnabled?P:null;e.intersect(l.validateHUDSelector,t,R,M,x)});var w=this.validateHUDSelector.minResult;(null==w.dist||S<=w.dist)&&s.minResult.copyFrom(g)}return s},e.prototype.unprojectHUDResultHit=function(e,t,i,r){var o=this.viewPropertyProvider.camera();o.projectPoint(e,t),t[0]=Math.round(t[0]),t[1]=Math.round(t[1]);var a=n.sv3d.get();a[0]=t[0],a[1]=t[1],a[2]=0,o.unprojectPoint(a,i),a[2]=1,o.unprojectPoint(a,r)},e}();t.SceneIntersectionHelper=s});