// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.10/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/extendsHelper","../../../../core/compilerUtils","../../../../core/libs/gl-matrix-2/gl-matrix","../../camera/constraintUtils","../Constraints","./InteractiveController","../utils/navigationUtils","../utils/viewUtils","../../../3d/support/earthUtils","../../support/cameraUtils","../../support/cameraUtilsInternal","../../support/geometryUtils","../../support/mathUtils","../../support/stack","../../webgl-engine/lib/Camera","../../../navigation/gamepadUtils"],function(t,e,a,i,r,n,o,s,c,l,p,d,v,m,h,u,f,y){function g(t){t.zoom=0,t.ascend=0,t.pan.enabled=!1,r.mat4.identity(t.pan.matrix),t.rotate.enabled=!1,r.mat4.identity(t.rotate.matrix)}Object.defineProperty(e,"__esModule",{value:!0});var w=function(t){function e(e,a){var i=t.call(this)||this;return i.view=e,i.device=a,i.transformation={translation:[0,0,0],heading:0,tilt:0},i.constraintOptions={selection:15,interactionType:0,interactionStartCamera:new f,interactionFactor:0,interactionDirection:null,tiltMode:1},i}return a(e,t),e.prototype.handleEvent=function(t){var e=y.extractTransformation(t,this.view.navigation.gamepad,this.transformation);if("end"===t.action||y.isZeroTransformation(e))return void this.finishController()},e.prototype.onControllerStart=function(e){this.filteredSurfaceElevation=this.view.pointsOfInterest.cameraOnSurface.location.z,t.prototype.onControllerStart.call(this,e)},e.prototype.updateFilteredSurfaceElevation=function(t){var e=this.view.pointsOfInterest.cameraOnSurface.location.z;this.filteredSurfaceElevation+=1*(e-this.filteredSurfaceElevation)*t},e.prototype.stepController=function(e,a){this.updateFilteredSurfaceElevation(e),this.currentCamera.copyViewFrom(a),this.updateCameraCenter(),this.constraintOptions.interactionStartCamera.copyFrom(this.currentCamera),this.calculateControlTransformation(e,this.currentCamera,D),this.applyPan(D.pan),this.applyRotate(D.rotate),this.applyZoom(D.zoom),this.applyAscend(D.ascend),this.constraintOptions.interactionType=0,this.constraintOptions.selection=8,n.applyAll(this.view,this.currentCamera,this.constraintOptions),t.prototype.stepController.call(this,e,a)},e.prototype.applyRotate=function(t){if(t.enabled){var e=this.currentCamera,a=e.center,i=e.up,o=e.eye;r.vec3.subtract(a,a,o),r.vec3.transformMat4(a,a,t.matrix),r.vec3.add(a,a,o),r.vec3.transformMat4(i,i,t.matrix),e.markViewDirty(),this.constraintOptions.interactionType=3,this.constraintOptions.selection=7,n.applyAll(this.view,e,this.constraintOptions)}},e.prototype.applyPan=function(t){if(t.enabled){var e=this.currentCamera,a=e.center,i=e.eye,o=e.up;r.vec3.transformMat4(i,i,t.matrix),r.vec3.transformMat4(a,a,t.matrix);this.view.state.isGlobal&&r.vec3.transformMat4(o,o,t.matrix),e.markViewDirty(),this.constraintOptions.interactionType=4,this.constraintOptions.selection=15,n.applyAll(this.view,e,this.constraintOptions)}},e.prototype.applyZoom=function(t){if(t){var e=this.currentCamera,a=e.eye,i=e.viewForward;r.vec3.add(a,a,r.vec3.scale(u.sv3d.get(),i,t)),this.currentCamera.markViewDirty(),r.vec3.copy(M,i),r.vec3.negate(M,M),this.constraintOptions.interactionDirection=M,this.constraintOptions.interactionType=1,this.constraintOptions.selection=7,n.applyAll(this.view,this.currentCamera,this.constraintOptions),this.constraintOptions.interactionDirection=null}},e.prototype.applyAscend=function(t){if(t){var e=this.currentCamera,a=e.center,i=e.eye,o=this.view.renderCoordsHelper,s=o.worldUpAtPosition(i,u.sv3d.get());this.constraintOptions.interactionDirection=r.vec3.copy(M,s);if(this.view.state.isGlobal){var c=r.vec3.length(i),l=(c+t)/c;r.vec3.scale(i,i,l),r.vec3.scale(a,a,l)}else{var p=r.vec3.scale(u.sv3d.get(),s,t);r.vec3.add(i,i,p),r.vec3.add(a,a,p)}this.currentCamera.markViewDirty(),this.updateCameraCenter(),this.constraintOptions.interactionType=5,this.constraintOptions.selection=8,n.applyAll(this.view,this.currentCamera,this.constraintOptions)&&this.updateCameraCenter(),this.constraintOptions.selection=7,n.applyAll(this.view,this.currentCamera,this.constraintOptions),this.constraintOptions.interactionDirection=null}},e.prototype.calculateControlTransformation=function(t,e,a){g(a);var i=this.computeVelocities(t);this.view.state.isLocal?this.calculateControlTransformationLocal(i,e,a):this.calculateControlTransformationGlobal(i,e,a)},e.prototype.updateCameraCenter=function(){var t=this.currentCamera,e=t.ray,a=t.center,i=this.view.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude;this.view.renderCoordsHelper.intersectManifoldClosestSilhouette(e,i,a),this.currentCamera.markViewDirty()},e.prototype.calculateControlTransformationLocal=function(t,e,a){var n=e.viewRight,s=e.viewForward,c=this.transformation,p=this.view.navigation.gamepad,d=r.vec3.set(u.sv3d.get(),s[0],s[1],0);r.vec3.normalize(d,d);var v=c.translation[0]*t.pan;if(0!==v){var m=r.vec3.scale(u.sv3d.get(),n,v);r.mat4.translate(a.pan.matrix,a.pan.matrix,m),a.pan.enabled=!0}switch(p.mode){case"pan":var f=-c.translation[1]*t.pan;if(0!==f){var y=r.vec3.scale(u.sv3d.get(),d,f);r.mat4.translate(a.pan.matrix,a.pan.matrix,y),a.pan.enabled=!0}break;case"zoom":a.zoom=-c.translation[1]*t.zoom;break;default:i.neverReached(p.mode)}var g=c.translation[2]*t.ascend;a.ascend=g;var w=-c.heading*t.rotate;0!==w&&(r.mat4.rotate(a.rotate.matrix,a.rotate.matrix,w,this.view.renderCoordsHelper.worldUpAtPosition(e.eye,u.sv3d.get())),a.rotate.enabled=!0);var C=c.tilt*t.rotate,T=l.viewAngle(this.view.renderCoordsHelper,e.center,e.eye),b=h.clamp(T+C,o.TiltDefault.min,o.TiltDefault.max)-T;b&&(r.mat4.rotate(a.rotate.matrix,a.rotate.matrix,b,n),a.rotate.enabled=!0)},e.prototype.calculateControlTransformationGlobal=function(t,e,a){var i=e.eye,n=e.viewRight,o=this.transformation,s=this.view.navigation.gamepad,c=r.vec3.cross(u.sv3d.get(),n,i);r.vec3.normalize(c,c),r.vec3.negate(c,c);var l=o.translation[0]*t.pan;switch(0!==l&&(r.mat4.rotate(a.pan.matrix,a.pan.matrix,l,c),a.pan.enabled=!0),s.mode){case"pan":var p=o.translation[1]*t.pan;0!==p&&(r.mat4.rotate(a.pan.matrix,a.pan.matrix,p,n),a.pan.enabled=!0);break;case"zoom":a.zoom=-o.translation[1]*t.zoom}var d=this.view.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,v=o.translation[2]*t.ascend;a.ascend=v;var m=-o.heading*t.rotate;0!==m&&(r.mat4.rotate(a.rotate.matrix,a.rotate.matrix,m,i),a.rotate.enabled=!0);var h=o.tilt*t.rotate,f=this.clampTiltDeltaGlobalToValidRange(h,e.ray,d);0!==f&&(r.mat4.rotate(a.rotate.matrix,a.rotate.matrix,f,n),a.rotate.enabled=!0)},e.prototype.clampTiltDeltaGlobalToValidRange=function(t,e,a){var i=c.onSurfaceTiltToEyeTiltGlobal(o.TiltDefault.min,e.origin,a),n=0,s=0,d=u.sv3d.get();if(this.view.renderCoordsHelper.intersectManifold(e,a,d)){var v=l.viewAngle(this.view.renderCoordsHelper,d,e.origin);n=c.onSurfaceTiltToEyeTiltGlobal(v,e.origin,a),s=c.onSurfaceTiltToEyeTiltGlobal(o.TiltDefault.max,e.origin,a)}else{m.sphere.closestPointOnSilhouette(m.sphere.wrap(a+p.earthRadius),e,d);var v=h.acos(-r.vec3.dot(e.direction,r.vec3.normalize(d,d)));n=c.offSurfaceTiltToEyeTiltGlobal(v,e.origin,a),s=c.offSurfaceTiltToEyeTiltGlobal(o.TiltDefault.max,e.origin,a)}return h.clamp(n+t,i,s)-n},e.prototype.getPointAbsoluteSurfaceElevation=function(t,e,a){var i=this.view.renderCoordsHelper,n=i.getAltitude(t),o=Math.abs(n-e),s=e+o;return r.vec3.copy(a,t),i.setAltitude(s,a),s},e.prototype.clampedDistanceToSurface=function(t,e){var a=this.view.renderCoordsHelper,i=this.view.state.camera,n=d.headingTiltToDirectionUp(this.view,e,0,T,z).direction,o=a.intersectManifoldClosestSilhouette(m.ray.wrap(e,n),t,u.sv3d.get()),s=r.vec3.distance(e,o),c=a.intersectManifoldClosestSilhouette(m.ray.wrap(e,h.directionFromTo(u.sv3d.get(),e,i.center)),t,u.sv3d.get()),l=r.vec3.distance(e,c);return Math.min(s,l)},e.prototype.computeHeadingRotateRadius=function(t){var e=this.view,a=e.renderCoordsHelper,i=e.state,n=i.camera,o=i.isGlobal,s=a.intersectManifoldClosestSilhouette(n.ray,this.filteredSurfaceElevation,u.sv3d.get());if(o){var c=r.vec3.subtract(u.sv3d.get(),t,s),l=r.vec3.length(c);r.vec3.scale(c,c,1/l);var p=r.vec3.normalize(u.sv3d.get(),t),d=h.acos(r.vec3.dot(p,c));return l*Math.sin(Math.min(b,d))}var v=r.vec3.copy(u.sv3d.get(),t);return a.setAltitude(this.filteredSurfaceElevation,v),r.vec3.distance(s,v)},e.prototype.minimumAscendVelocity=function(){return this.view.state.constraints.collision.enabled?0:O},e.prototype.computeVelocities=function(t){var e=this.filteredSurfaceElevation,a=e+p.earthRadius,i=this.view.state,r=i.camera,n=i.isGlobal,o=u.sv3d.get(),s=this.getPointAbsoluteSurfaceElevation(r.eye,e,o),c=this.clampedDistanceToSurface(e,o),l=r.width/2,d=x*r.width,v=x*r.width,m=c*Math.tan(.5*r.fovX)/l,f=m/a,y=m/this.computeHeadingRotateRadius(o),g=n?f:m,w=g*d*t,C=s-e;return{pan:w,ascend:Math.max(this.minimumAscendVelocity()*t,Math.pow(2,d*t/l)*C-C),zoom:Math.pow(2,d*t/l)*c-c,rotate:h.clamp(y*v,S,A)*t}},e.activatesFor=function(t,e){var a=y.extractTransformation(e,t.navigation.gamepad,C);return!("end"===e.action||y.isZeroTransformation(a))},e}(s.InteractiveController);e.GamepadController=w;var C={translation:[0,0,0],heading:0,tilt:0},T=80,b=h.deg2rad(T),x=.75,O=5,S=h.deg2rad(30),A=h.deg2rad(80),D={zoom:0,ascend:0,pan:{enabled:!1,matrix:r.mat4f64.create()},rotate:{enabled:!1,matrix:r.mat4f64.create()}},M=r.vec3f64.create(),z=v.createDirectionUp()});