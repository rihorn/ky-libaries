// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.10/esri/copyright.txt for details.

define(["require","exports","../../../../core/Logger","./CIMSymbolDrawHelper","./SDFHelper","../../../vectorTiles/GeometryUtils"],function(e,r,a,d,k,f){Object.defineProperty(r,"__esModule",{value:!0});var s=a.getLogger("esri/views/2d/engine/webgl/CIMSymbolHelper"),t=function(){function e(){}return e.getEnvelope=function(e){if("CIMPointSymbol"!==e.type)return null;var r=new d.EnvDrawHelper;return r.drawSymbol(e,{type:"point",x:0,y:0}),r.envelope()},e.rasterize=function(e,r){var a=this.getEnvelope(r);if(!a||a.width<=0||a.height<=0)return[null,0,0,0,0];var t=96/72,o=(a.x+.5*a.width)*t,i=-(a.y+.5*a.height)*t;e.width=a.width*t+2,e.height=a.height*t+2;var s=e.getContext("2d"),n=d.Transformation.createScale(t,-t);n.translate(.5*e.width-o,.5*e.height-i);new d.CanvasDrawHelper(s,n).drawSymbol(r,{type:"point",x:0,y:0});for(var l,h=s.getImageData(0,0,e.width,e.height),S=new Uint8Array(h.data),c=0;c<S.length;c+=4)l=S[c+3]/255,S[c]=S[c]*l,S[c+1]=S[c+1]*l,S[c+2]=S[c+2]*l;return[S,e.width,e.height,o/e.width,i/e.height]},e.fromSimpleMarker=function(e){var r,a,t,o=50,i=e.style;if("circle"===i||"esriSMSCircle"===i){var s=Math.acos(.995),n=Math.ceil(f.C_PI/s/4);0===n&&(n=1),s=f.C_PI_BY_2/n,n*=4;var l=[];l.push([o,0]);for(var h=1;h<n;h++)l.push([o*Math.cos(h*s),-o*Math.sin(h*s)]);l.push([o,0]),r={rings:[l]},a={xmin:-o,ymin:-o,xmax:o,ymax:o}}else if("cross"===i||"esriSMSCross"===i){r={rings:[[[S=0,o],[S,S],[o,S],[o,-S],[S,-S],[S,-o],[-S,-o],[-S,-S],[-o,-S],[-o,S],[-S,S],[-S,o],[S,o]]]},a={xmin:-o,ymin:-o,xmax:o,ymax:o}}else if("diamond"===i||"esriSMSDiamond"===i)r={rings:[[[-o,0],[0,o],[o,0],[0,-o],[-o,0]]]},a={xmin:-o,ymin:-o,xmax:o,ymax:o};else if("square"===i||"esriSMSSquare"===i)r={rings:[[[-o,-o],[-o,o],[o,o],[o,-o],[-o,-o]]]},a={xmin:-o,ymin:-o,xmax:o,ymax:o};else if("x"===i||"esriSMSX"===i){var S;r={rings:[[[0,S=0],[o-S,o],[o,o-S],[S,0],[o,S-o],[o-S,-o],[0,-S],[S-o,-o],[-o,S-o],[-S,0],[-o,o-S],[S-o,o],[0,S]]]},a={xmin:-o,ymin:-o,xmax:o,ymax:o}}else if("triangle"===i||"esriSMSTriangle"===i){var c=57.735026918962575,d=-c,m=2/3*100,g=m-100;r={rings:[[[d,g],[0,m],[c,g],[d,g]]]},a={xmin:d,ymin:g,xmax:c,ymax:m}}if(r&&a){var y=[{type:"CIMSolidFill",enable:!0,color:e.color}];e.outline&&y.push({type:"CIMSolidStroke",enable:!0,width:e.outline.width,color:e.outline.color});var u={type:"CIMPolygonSymbol",symbolLayers:y};t={type:"CIMPointSymbol",symbolLayers:[{type:"CIMVectorMarker",enable:!0,rotation:e.angle,size:e.size,offsetX:e.xoffset,offsetY:e.yoffset,frame:a,markerGraphics:[{type:"CIMMarkerGraphic",geometry:r,symbol:u}]}]}}return t},e}();r.CIMSymbolHelper=t;var o=function(){function e(){}return e.rasterizeSimpleFill=function(e,r){"solid"!==r&&"none"!==r&&"esriSFSSolid"!==r&&"esriSFSNull"!==r||console.error("Unexpected: style does not require rasterization"),e.width=8,e.height=8;var a=e.getContext("2d");a.strokeStyle="#FFFFFF",a.beginPath(),"vertical"!==r&&"cross"!==r&&"esriSFSCross"!==r&&"esriSFSVertical"!==r||(a.moveTo(0,0),a.lineTo(0,8)),"horizontal"!==r&&"cross"!==r&&"esriSFSCross"!==r&&"esriSFSHorizontal"!==r||(a.moveTo(0,0),a.lineTo(8,0)),"forward-diagonal"!==r&&"diagonal-cross"!==r&&"esriSFSDiagonalCross"!==r&&"esriSFSForwardDiagonal"!==r||(a.moveTo(0,0),a.lineTo(8,8)),"backward-diagonal"!==r&&"diagonal-cross"!==r&&"esriSFSBackwardDiagonal"!==r&&"esriSFSDiagonalCross"!==r||(a.moveTo(8,0),a.lineTo(0,8)),a.stroke();for(var t,o=a.getImageData(0,0,e.width,e.height),i=new Uint8Array(o.data),s=0;s<i.length;s+=4)t=i[s+3]/255,i[s]=i[s]*t,i[s+1]=i[s+1]*t,i[s+2]=i[s+2]*t;return[i,e.width,e.height]},e.rasterizeSimpleLine=function(e,r,a){var t;switch(a){case"butt":t="Butt";break;case"square":t="Square";break;default:t="Round"}var o,i="Butt"===t;switch(r){case"dash":case"esriSLSDash":o=i?[4,3]:[3,4];break;case"dash-dot":case"esriSLSDashDot":o=i?[4,3,1,3]:[3,4,0,4];break;case"dot":case"esriSLSDot":o=i?[1,3]:[0,4];break;case"long-dash":case"esriSLSLongDash":o=i?[8,3]:[7,4];break;case"long-dash-dot":case"esriSLSLongDashDot":o=i?[8,3,1,3]:[7,4,0,4];break;case"long-dash-dot-dot":case"esriSLSDashDotDot":o=i?[8,3,1,3,1,3]:[7,4,0,4,0,4];break;case"short-dash":case"esriSLSShortDash":o=i?[4,1]:[3,2];break;case"short-dash-dot":case"esriSLSShortDashDot":o=i?[4,1,1,1]:[3,2,0,2];break;case"short-dash-dot-dot":case"esriSLSShortDashDotDot":o=i?[4,1,1,1,1,1]:[3,2,0,2,0,2];break;case"short-dot":case"esriSLSShortDot":o=i?[1,1]:[0,2];break;case"solid":case"esriSLSSolid":case"none":s.error("Unexpected: style does not require rasterization"),o=[0,0];break;default:s.error("Tried to rasterize SLS, but found an unexpected style: "+r+"!"),o=[0,0]}return this.rasterizeDash(e,o,t)},e.rasterizeDash=function(e,r,a){for(var t="Butt"===a,o="Square"===a,i=!t&&!o,s=0,n=0,l=r;n<l.length;n++){s+=l[n]}for(var h=15*s,S=31*h,c=new Float32Array(S),d=i?225:15,m=0;m<S;++m)c[m]=d;for(var g=0,y=0,u=!0,f=0,x=r;f<x.length;f++){g=y,y+=15*x[f];for(var v=g;v<y;){for(var p=0;p<31;){m=p*h+v;var M=i?(p-15)*(p-15):Math.abs(p-15);c[m]=u?t?Math.max(Math.max(g+7.5-v,M),Math.max(v-y+7.5,M)):M:i?Math.min((v-g)*(v-g)+M,(v-y)*(v-y)+M):o?Math.min(Math.max(v-g,M),Math.max(y-v,M)):Math.min(Math.max(v-g+7.5,M),Math.max(y+7.5-v,M)),p++}v++}u=!u}var b=c.length,w=new Uint8Array(4*b);for(m=0;m<b;++m){var D=(i?Math.sqrt(c[m]):c[m])/15;k.packFloat(D,w,4*m)}return[w,h,31]},e}();r.SymbolHelper=o});