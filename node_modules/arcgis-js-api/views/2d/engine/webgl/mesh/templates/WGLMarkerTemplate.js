// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.10/esri/copyright.txt for details.

define(["require","exports","../../../../../../core/tsSupport/extendsHelper","../../../../../../core/Logger","../../../../../../core/screenUtils","../../../../../../core/libs/gl-matrix-2/gl-matrix","../../color","../../definitions","../../enums","../../number","../../WGLDisplayRecord","./WGLMeshTemplate"],function(t,e,r,i,c,x,_,p,M,w,V,o){Object.defineProperty(e,"__esModule",{value:!0});var T=i.getLogger("esri.views.2d.engine.webgl.WGLMeshTemplate"),n=255,s=function(v){function d(t,e,r,i,o,s,h,n,p,u,a){var l=v.call(this)||this;l.geometryType=M.WGLGeometryType.MARKER;var f=x.vec2f32.create(),d=x.mat2df32.create();h=0===h?0:Math.max(h,2),n=0===n?0:Math.max(n,2);var c=a.sdf?.5:1;if(x.mat2d.translate(d,d,x.vec2f32.fromValues(c*r,c*-i)),o){x.mat2d.rotate(d,d,3.14159265359/180*o)}l._materialStore=t,l.vvFlags=e,l._materialId=t.createSpriteMaterial(a,l.geometryType,e),l._fillColor=s,l._outlineColor=p,l._sizeOutlineWidth=w.i8888to32(h,n,u,0);var _=Math.round(a.rect.x/4)-128,m=Math.round(a.rect.y/4)-128,y=_+Math.round(a.rect.width/4),g=m+Math.round(a.rect.height/4);return x.vec2.set(f,-.5*h,-.5*n),x.vec2.transformMat2d(f,f,d),l._offsetAndTexUpperLeft=w.i8888to32(f[0],f[1],_,m),x.vec2.set(f,.5*h,-.5*n),x.vec2.transformMat2d(f,f,d),l._offsetAndTexUpperRight=w.i8888to32(f[0],f[1],y,m),x.vec2.set(f,-.5*h,.5*n),x.vec2.transformMat2d(f,f,d),l._offsetAndTexBottomLeft=w.i8888to32(f[0],f[1],_,g),x.vec2.set(f,.5*h,.5*n),x.vec2.transformMat2d(f,f,d),l._offsetAndTexBottomRight=w.i8888to32(f[0],f[1],y,g),l.height=n,l.width=h,l.xOffset=r,l.yOffset=i,l}return r(d,v),d.fromPictureMarker=function(t,e,r,i,o){var s=Math.round(c.pt2px(r.width)),h=Math.round(c.pt2px(r.height)),n=p.PICTURE_FILL_COLOR;return new d(t,e,Math.round(c.pt2px(r.xoffset||0)),Math.round(c.pt2px(r.yoffset||0)),r.angle,n,s,h,0,0,i)},d.fromSimpleMarker=function(t,e,r,i,o){var s=_.premultiplyAlphaRGBA(r.color),h=Math.round(c.pt2px(r.size)),n=h,p=Math.round(c.pt2px(r.xoffset||0)),u=Math.round(c.pt2px(r.yoffset||0)),a=r.outline,l=0|(a&&a.color&&_.premultiplyAlphaRGBA(a.color)),f=0|(a&&a.width&&Math.round(c.pt2px(a.width)));return new d(t,e,p,u,r.angle,s,h,n,l,f,i)},d.prototype.writeMesh=function(t,e,r,i,o,s,h){var n=this._materialStore.get(this._materialId),p=e.indexVector,u=e.get("geometry"),a=e.get("visibility"),l=new V(i,this.geometryType,this._materialId),f=this._getOffset(u,n);switch(t.push(l),l.vertexFrom=f,l.indexFrom=p.length,r){case"esriGeometryPoint":var d=o.geometry,c=d.x,_=d.y;return this._writeVertices(l,u,a,i,this._getPos(c,_),n,h),void this._writeIndices(l,p,f);case"esriGeometryPolyline":var m=o.geometry.paths;return void this._writeMany(l,p,u,a,f,i,m[0],n,h);case"esriGeometryPolygon":var y=o.centroid;if(y){c=y.x,_=y.y;this._writeVertices(l,u,a,i,this._getPos(c,_),n,h),this._writeIndices(l,p,f)}else T.error("Tried to render polygon geometries as markers, but found no centroid!");return;case"esriGeometryMultipoint":var g=o.geometry.points;return void this._writeMany(l,p,u,a,f,i,g,n,h);case"esriGeometryEnvelope":default:T.error("Unable to handle geometryType: "+r)}},d.prototype._getPos=function(t,e){return w.i1616to32(t,e)},d.prototype._writeMany=function(t,e,r,i,o,s,h,n,p){for(var u=0,a=0,l=0,f=0,d=h;f<d.length;f++){var c=d[f],_=c[0],m=c[1];this._writeVertices(t,r,i,s,this._getPos(_+u,m+a),n,p),this._writeIndices(t,e,o+l),u+=_,a+=m,l+=4}},d.prototype._getOffset=function(t,e){var r=e.materialKeyInfo.hasVV()?10:6;return t.length/r},d.prototype._writeVertices=function(t,e,r,i,o,s,h){e.push(o),e.push(this._offsetAndTexUpperLeft),e.push(i),e.push(this._fillColor),e.push(this._outlineColor),e.push(this._sizeOutlineWidth),this._writeVV(e,h,s),r.push(n),e.push(o),e.push(this._offsetAndTexUpperRight),e.push(i),e.push(this._fillColor),e.push(this._outlineColor),e.push(this._sizeOutlineWidth),this._writeVV(e,h,s),r.push(n),e.push(o),e.push(this._offsetAndTexBottomLeft),e.push(i),e.push(this._fillColor),e.push(this._outlineColor),e.push(this._sizeOutlineWidth),this._writeVV(e,h,s),r.push(n),e.push(o),e.push(this._offsetAndTexBottomRight),e.push(i),e.push(this._fillColor),e.push(this._outlineColor),e.push(this._sizeOutlineWidth),this._writeVV(e,h,s),r.push(n),t.vertexCount+=4},d.prototype._writeVV=function(t,e,r){r.materialKeyInfo.hasVV()&&(t.push(e[M.VVType.SIZE]),t.push(e[M.VVType.COLOR]),t.push(e[M.VVType.OPACITY]),t.push(e[M.VVType.ROTATION]))},d.prototype._writeIndices=function(t,e,r){var i=r;e.push(i+0),e.push(i+1),e.push(i+2),e.push(i+1),e.push(i+3),e.push(i+2),t.indexCount+=6},d}(o.default);e.default=s});