// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.10/esri/copyright.txt for details.

define(["require","exports","../../../../../../core/tsSupport/extendsHelper","../../../../../../core/Error","../../../../../../core/Logger","../../../../../../core/libs/gl-matrix-2/gl-matrix","../../definitions","../../enums","../../number","../../TextShaping","../../Utils","../../collisions/Metric","./GlyphGroup","./util","./WGLTextTemplate","../../util/vvFlagUtils","../../../../../3d/support/mathUtils","../../../../../vectorTiles/GeometryUtils"],function(e,t,r,o,a,_,S,O,A,s,i,D,ue,L,n,E,P,g){Object.defineProperty(t,"__esModule",{value:!0});var h=a.getLogger("esri.views.2d.engine.webgl.WGLLabelTemplate"),v=255,d=A.i8888to32(255,255,255,255),y=_.vec2f32.create(),T=_.mat2df32.create();var c={xOffset:0,yOffset:0,width:0,height:0},x=function(e,t){return void 0===t&&(t="mapview-labeling"),h.error(new o(t,e))};var l=function(f){function m(e,t,r,o,a,s){var i=f.call(this,e,t,r)||this;i.geometryType=O.WGLGeometryType.LABEL,i._refTemplate=c;var n=function(e){switch(e){case"above-along":case"below-along":case"center-along":return 1;default:return 0}}(o),h=function(e){switch(e){case"above-left":return[-1,-1];case"above-center":case"above-along":return[0,-1];case"above-right":return[1,-1];case"center-left":return[-1,0];case"center-center":case"center-along":return[0,0];case"center-right":return[1,0];case"below-left":return[-1,1];case"below-center":case"below-along":return[0,1];case"below-right":return[1,1];case"always-horizontal":return[0,0];default:x("Found invalid placement type "+e)}}(o),l=h[0],p=h[1];i._justify=(-1*l+1)/2,i._xAlignD=l,i._yAlignD=p,i._xPlacementD=l,i._yPlacementD=p,i._minZoom=a,i._maxZoom=s,i.vvFlags|=n*O.WGLVVFlag.ROTATION;var u=r.font.decoration.toLowerCase();return"underline"===u?i._decorationTop=6:"line-through"===u&&(i._decorationTop=-5),i}return r(m,f),m.fromLabelClass=function(e,t,r,o,a){var s,i,n,h,l,p,u=r.symbol,f=(i=a,n=!!(s=r).minScale&&i.scaleToZoom(s.minScale)||0,P.clamp(n,0,25.5)),c=(l=a,p=!!(h=r).maxScale&&l.scaleToZoom(h.maxScale)||255,P.clamp(p,0,25.5));return new m(e,t,u,r.labelPlacement,f,c)},m.prototype.bindTextInfo=function(e,t,r){var o=this._computeShaping(e,this._justify).getShaping(t,r);isNaN(this._decorationTop)||s.addDecoration(o,this._decorationTop),this._shapedGlyphs=o,this._shapedBox=s.getBox(o)},m.prototype._computeShaping=function(e,t){return new s([e],S.TEXT_MAX_WIDTH,S.TEXT_LINE_HEIGHT,S.TEXT_SPACING,[0,0],.5,.5,t)},Object.defineProperty(m.prototype,"bounds",{get:function(){return this._bounds},enumerable:!0,configurable:!0}),m.prototype.bindReferenceTemplate=function(e){this._refTemplate=e||c},m.prototype._placeGlyphs=function(e,t,r,o){var a=this._size,s=this._haloSize,i=this._shapedBox,n=this._shapedGlyphs,h=this._computeGlyphTransform(i);if("esriGeometryPolyline"===e)for(var l=0;l<r.length;l++){b=r[l];for(var p=this._shapedBox.width*this._scale,u=function(e){return!(e%2)},f=b.order,c=f-(f-1)/2-1,m=c-(c-1)/2-1,_=m-(m-1)/2-1,g=-1===f?0:u(f)?o-.1:u(c)?o-1.1:u(m)?o-2.1:u(_)?o-3.1:0,v=Math.max(o+P.log2((p+48)/b.pathLen),Math.max(g,this._minZoom)),d=0,y=n;d<y.length;d++){G=y[d],M=this._materialStore.createGlyphMaterial(G.glyphMosaicItem,this.geometryType,this.vvFlags);b.place(G,e,t,h,M,a,s,i,o,v,this._maxZoom)}}else for(var T=0,x=r;T<x.length;T++)for(var b=x[T],w=0,L=n;w<L.length;w++){var G=L[w],M=this._materialStore.createGlyphMaterial(G.glyphMosaicItem,this.geometryType,this.vvFlags);b.place(G,e,t,h,M,a,s,i,o,this._minZoom,this._maxZoom)}},m.prototype.writeMesh=function(p,u,e,f,t,r,c,o,a){var m=this,s=this._computeAnchors(e,t);if(s.length&&this._shapedGlyphs.length){if(this._placeGlyphs(e,t,s,o),"esriGeometryPolyline"!==e){var i=s[0],n=this._shapedBox,h=this._computeGlyphTransform(n),l=this._createBounds(this._shapedBox,h),_=i.glyphs.get(0),g=_[0],v=g.anchorX,d=g.anchorY,y=Math.floor(10*g.minZoom),T=Math.floor(10*g.maxZoom),x=p.length;_.forEach(function(e){e.minZoom=25.5,e.maxZoom=25.5}),this._writeVertices(p,u,f,c,_,y,T);var b={from:x,count:p.length-x},w=new D.default(f,b,v,d,y),L=Math.max(this._refTemplate.height,this._refTemplate.width),G=E.getSizeFlagsMask(this.vvFlags,!1);return this.vvFlags&G?w.setVV(A.toFloat32(c[O.VVType.SIZE]),L,this._xPlacementD,this._yPlacementD):(w.offsetX=(L/2+S.COLLISION_PLACEMENT_PADDING)*this._xPlacementD,w.offsetY=(L/2+S.COLLISION_PLACEMENT_PADDING)*this._yPlacementD),w.bounds=l,a.push(w),void i.clear()}for(var M=function(e){var i=s[e],n=i.x,h=i.y,t=p.length,l=new D.default(f,{from:t,count:-1},n,h,25.5);i.glyphs.forEach(function(e){for(var t=0,r=e;t<r.length;t++){var o=r[t];if(o.minZoom=Math.max(i.minZoom,o.minZoom),o.bounds){var a=o.anchorX-n,s=o.anchorY-h;o.bounds.center[0]+=a,o.bounds.center[1]+=s,l.add(o.bounds)}}l.bounds&&m._writeHalos(p,u,f,c,e)}),i.glyphs.forEach(function(e){l.bounds&&m._writeText(p,u,f,c,e)}),l.range.count=p.length-t,l.bounds&&a.push(l),i.clear()},P=0;P<s.length;P++)M(P);this._computedGlyphs=[]}},m.prototype._outsideTile=function(e,t){return e<0||512<=e||t<0||512<=t},m.prototype._smoothVertices=function(e,t){if(!(t<=0)){var r=e.length;if(!(r<3)){var o=[],a=0;o.push(0);for(var s=1;s<r;s++)a+=L.dist(e[s],e[s-1]),o.push(a);t=Math.min(t,.2*a);var i=[];i.push(e[0][0]),i.push(e[0][1]);var n=e[r-1][0],h=e[r-1][1],l=L.sub([0,0],e[0],e[1]);L.normalize(l),e[0][0]+=t*l[0],e[0][1]+=t*l[1],L.sub(l,e[r-1],e[r-2]),L.normalize(l),e[r-1][0]+=t*l[0],e[r-1][1]+=t*l[1];for(s=1;s<r;s++)o[s]+=t;o[r-1]+=t;var p=.5*t;for(s=1;s<r-1;s++){for(var u=0,f=0,c=0,m=s-1;0<=m&&!(o[m+1]<o[s]-p);m--){var _=p+o[m+1]-o[s],g=o[m+1]-o[m],v=o[s]-o[m]<p?1:_/g;if(Math.abs(v)<1e-6)break;var d=v*_-.5*(w=v*v)*g,y=v*g/t,T=e[m+1],x=e[m][0]-T[0],b=e[m][1]-T[1];u+=y/d*(T[0]*v*_+.5*w*(_*x-g*T[0])-w*v*g*x/3),f+=y/d*(T[1]*v*_+.5*w*(_*b-g*T[1])-w*v*g*b/3),c+=y}for(m=s+1;m<r&&!(o[m-1]>o[s]+p);m++){_=p-o[m-1]+o[s],g=o[m]-o[m-1],v=o[m]-o[s]<p?1:_/g;if(Math.abs(v)<1e-6)break;var w;d=v*_-.5*(w=v*v)*g,y=v*g/t,T=e[m-1],x=e[m][0]-T[0],b=e[m][1]-T[1];u+=y/d*(T[0]*v*_+.5*w*(_*x-g*T[0])-w*v*g*x/3),f+=y/d*(T[1]*v*_+.5*w*(_*b-g*T[1])-w*v*g*b/3),c+=y}i.push(u/c),i.push(f/c)}i.push(n),i.push(h);for(s=0,m=0;s<r;s++)e[s][0]=i[m++],e[s][1]=i[m++]}}},m.prototype._computeLineAnchors=function(e,t,r){for(var o=t.paths,a=this._scale*this._shapedBox.width,s=a/2+r,i=a/2+16,n=this._shapedBox.width*this._scale,h=0;h<o.length;h++){var l=o[h],p=[];p.push(l[0]);for(var u=1;u<l.length;u++){var f=p[u-1],c=f[0],m=f[1];c+=l[u][0],m+=l[u][1],p.push([c,m])}this._smoothVertices(p,n);var _=[];_.push(p[0]);for(var g=1;g<p.length;g++){var v=p[g-1],d=v[0],y=v[1],T=p[g],x=T[0],b=T[1],w=Math.round(x-d),L=Math.round(b-y);_.push([w,L])}l=o[h]=_;var G=this._getPathLength(l);if(!(G<2*i))for(var M=G/2,P=0,S=l[0][0],O=l[0][1],A=1;A<l.length;A++){w=l[A][0],L=l[A][1];var D=Math.sqrt(w*w+L*L);if(0<=(P+=D)-M){var E=P-M,I=D-E,Z=I/D,F=S+w*Z,V=O+L*Z;if(!this._outsideTile(F,V)){var B=new ue.default(F,V,Z,h,A,S,O,D,G,-1);e.push(B)}var N=-1,z=0;for(z=I-s;0<=z;z-=s){var C=z/D,R=S+w*C,U=O+L*C;if(N++,!this._outsideTile(R,U)){B=new ue.default(R,U,C,h,A,S,O,D,G,N);e.push(B)}}P=z+s;for(var X=D-E,k=S,q=O,H=A-1;0!==H;H--){var W=l[H][0],j=l[H][1],Y=Math.sqrt(W*W+j*j);if(s<=P+Y){for(var J=s-P;J<Y;J+=s){var K=J/Y,Q=k-W*K,$=q-j*K;if(N++,J+X+i<M&&!this._outsideTile(Q,$)){B=new ue.default(Q,$,1-K,h,H,k-W,q-j,Y,G,N);e.push(B)}}P=Y-(J-s)}else P+=Y;X+=Y,k-=W,q-=j}var ee=-1;for(z=I+s;z<=D;z+=s){var te=z/D,re=S+w*te,oe=O+L*te;if(ee++,!this._outsideTile(re,oe)){B=new ue.default(re,oe,te,h,A,S,O,D,G,ee);e.push(B)}}k=S+w,q=O+L,P=D-(z-s),X=E;for(H=A+1;H<l.length;H++){var ae=l[H][0],se=l[H][1],ie=Math.sqrt(ae*ae+se*se);if(s<=P+ie){for(var ne=s-P;ne<ie;ne+=s){var he=ne/ie,le=k+ae*he,pe=q+se*he;if(ee++,ne+X+i<M&&!this._outsideTile(le,pe)){B=new ue.default(le,pe,he,h,H,k,q,ie,G,ee);e.push(B)}}P=ie-(ne-s)}else P+=ie;X+=ie,k+=ae,q+=se}break}S+=w,O+=L}}return e},m.prototype._computeAnchors=function(e,t){var r=[];switch(e){case"esriGeometryPoint":var o=t.geometry,a=o.x,s=o.y,i=new ue.default(a,s);return r.push(i),r;case"esriGeometryPolygon":if(t.centroid){var n=t.centroid;a=n.x,s=n.y,i=new ue.default(a,s);return r.push(i),r}x("Non-centroid polygon anchor placement not supported");break;case"esriGeometryPolyline":return this._computeLineAnchors(r,t.geometry,376);case"esriGeometryMultipoint":default:return x("Unable to handle geometryType: "+e),r}},m.prototype._getPathLength=function(e){for(var t=0,r=1;r<e.length;r++){var o=e[r][0],a=e[r][1];t+=Math.sqrt(o*o+a*a)}return t},m.prototype._computeGlyphTransform=function(e){var t=this._scale,r=this._angle*g.C_DEG_TO_RAD,o=e.x,a=e.y,s=e.width/2,i=e.height/2,n=o+s,h=a+i,l=this._xAlignD*(s*t),p=this._yAlignD*(i*t),u=l+(this._xOffset+this._refTemplate.xOffset)+n,f=p-(this._yOffset+this._refTemplate.yOffset)-h,c=_.mat2d.identity(T);return _.mat2d.translate(c,c,_.vec2.set(y,u,f)),_.mat2d.scale(c,c,_.vec2.set(y,t,t)),_.mat2d.rotate(c,c,r),c},m.prototype._getOffset=function(e){var t=i.C_LABEL_VERTEX_DEF[0].strideInBytes/4;return e.length/t},m.prototype._writeVertex=function(e,t,r,o,a,s,i,n){var h=t.get("geometry"),l=t.get("visibility"),p=t.get("visibilityRange"),u=n&&n[O.VVType.SIZE]||1,f=Math.min(Math.floor(Math.max(this._refTemplate.width,this._refTemplate.height)),255),c=this._xPlacementD+1,m=this._yPlacementD+1;this._refSymbolAndPlacementOffset=A.i8888to32(s.angle,f,c,m),h.push(o),h.push(a),h.push(s.vertexOffsetUpperLeft),h.push(s.texFontSizeUpperLeft),h.push(this._refSymbolAndPlacementOffset),h.push(u),l.push(v),h.push(o),h.push(a),h.push(s.vertexOffsetUpperRight),h.push(s.texFontSizeUpperRight),h.push(this._refSymbolAndPlacementOffset),h.push(u),l.push(v),h.push(o),h.push(a),h.push(s.vertexOffsetLowerLeft),h.push(s.texFontSizeLowerLeft),h.push(this._refSymbolAndPlacementOffset),h.push(u),l.push(v),h.push(o),h.push(a),h.push(s.vertexOffsetLowerRight),h.push(s.texFontSizeLowerRight),h.push(this._refSymbolAndPlacementOffset),h.push(u),l.push(v),p.push(d),p.push(d),e.vertexCount+=4},m}(n.default);t.default=l});