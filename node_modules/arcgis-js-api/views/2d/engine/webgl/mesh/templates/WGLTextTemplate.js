// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.10/esri/copyright.txt for details.

define(["require","exports","../../../../../../core/tsSupport/extendsHelper","../../../../../../core/Error","../../../../../../core/Logger","../../../../../../core/screenUtils","../../../../../../core/libs/gl-matrix-2/gl-matrix","../../color","../../definitions","../../enums","../../fontUtils","../../number","../../TextShapingNew","../../WGLDisplayRecord","../../collisions/BoundingBox","./ComputedGlyph","./WGLMeshTemplate","../../util/BidiText","../../../../layers/graphics/graphicsUtils","../../../../../vectorTiles/GeometryUtils"],function(e,t,r,G,o,s,T,n,w,a,h,d,l,x,V,c,i,u,f,_){Object.defineProperty(t,"__esModule",{value:!0});var I=o.getLogger("esri.views.2d.engine.webgl.WGLTextTemplate"),m=255,g=T.mat2df32.create(),y=T.vec2f32.create(),p=function(i){function p(e,t,r){var o=i.call(this)||this;return o.geometryType=a.WGLGeometryType.TEXT,o.vvFlags=0,o._xOffset=s.pt2px(r.xoffset),o._yOffset=s.pt2px(r.yoffset),o._decorationTop=h.getFontDecorationTop(r.font),o._color=0|(r.color&&n.premultiplyAlphaRGBA(r.color)),o._haloColor=0|(r.haloColor&&n.premultiplyAlphaRGBA(r.haloColor)),o._haloSize=Math.min(Math.floor(5*s.pt2px(s.toPt(r.haloSize||0))),127),o._size=Math.min(Math.round(s.pt2px(r.font.size)),127),o._scale=o._size/24,o._angle=r.angle||0,o._justify=f.getJustification(r.horizontalAlignment||"center"),o._xAlignD=f.getXAnchorDirection(r.horizontalAlignment||"center"),o._yAlignD=-f.getYAnchorDirection(r.verticalAlignment||"baseline"),o._baseline="baseline"===(r.verticalAlignment||"baseline"),o._materialStore=e,o.vvFlags=t,o.symbolId=r.id,o}return r(p,i),p.fromText=function(e,t,r,o,i){var s=new p(e,t,r),n=u.bidiText(r.text),a=n[0],h=n[1];return s.bindTextInfo(i,a,h),s._computeGlyphs(s._shapedGlyphs,s._shapedBox),s},p.prototype.bindTextInfo=function(e,t,r){var o=this._computeShaping(e,this._justify).getShaping(t,r);isNaN(this._decorationTop)||l.addDecoration(o,this._decorationTop),this._shapedGlyphs=o,this._shapedBox=l.getBox(o)},p.prototype.writeMesh=function(e,t,r,o,i,s,n){var a,h,p=this._computedGlyphs;switch(r){case"esriGeometryPoint":for(var l=i.geometry,c=l.x,u=l.y,f=0,_=p;f<_.length;f++){(V=_[f]).anchorX=c,V.anchorY=u}return void this._writeVertices(e,t,o,n,p,0,0);case"esriGeometryPolygon":if(i.centroid){for(var m=i.centroid,g=(c=m.x,u=m.y,0),y=p;g<y.length;g++){(V=y[g]).anchorX=c,V.anchorY=u}return void this._writeVertices(e,t,o,n,p,0,0)}case"esriGeometryMultipoint":c=0,u=0;for(var v=0,d=i.geometry.points;v<d.length;v++){var x=d[v];c+=x[0],u+=x[1];for(var T=0,w=p;T<w.length;T++){var V;(V=w[T]).anchorX=c,V.anchorY=u}this._writeVertices(e,t,o,n,p,0,0)}return;default:a="Unable to handle geometryType: "+r,void 0===h&&(h="mapview-processing"),I.error(new G(h,a))}},p.prototype._computeGlyphs=function(e,t){for(var r=new Array(e.length),o=this._computeGlyphTransform(t),i=0;i<e.length;i++){var s=e[i],n=s.x,a=s.y,h=s.codePoint,p=s.glyphMosaicItem,l=this._materialStore.createGlyphMaterial(p,this.geometryType,this.vvFlags);r[i]=c.default.from(n,a,0,0,-1,0,25,p,h,l,o,this._size,this._haloSize,!1,!0)}this._computedGlyphs=r},p.prototype._createBounds=function(e,t){var r,o,i=e.width/2,s=e.height/2,n=t[4],a=t[5];if(this._angle){var h=T.vec2f32.fromValues(-i,-s),p=T.vec2f32.fromValues(i,-s),l=T.vec2f32.fromValues(-i,s),c=T.vec2f32.fromValues(i,s);T.vec2.transformMat2d(h,h,t),T.vec2.transformMat2d(p,p,t),T.vec2.transformMat2d(l,l,t),T.vec2.transformMat2d(c,c,t);for(var u=1/0,f=1/0,_=0,m=0,g=0,y=[h,p,l,c];g<y.length;g++){var v=y[g];u=Math.min(v[0],u),_=Math.max(v[0],_),f=Math.min(v[1],f),m=Math.max(v[1],m)}r=_-u,o=m-f}else r=e.width*this._scale,o=e.height*this._scale;var d=r+w.COLLISION_BOX_PADDING,x=o+w.COLLISION_BOX_PADDING;return new V.default(n,a,d,x)},p.prototype._computeShaping=function(e,t){return new l([e],w.TEXT_MAX_WIDTH,w.TEXT_LINE_HEIGHT,w.TEXT_SPACING,[0,.5*-w.TEXT_LINE_HEIGHT],.5*(1-this._xAlignD),0,t)},p.prototype._computeGlyphTransform=function(e){var t=this._scale,r=this._angle*_.C_DEG_TO_RAD,o=T.mat2d.identity(g);T.mat2d.rotate(o,o,r),T.mat2d.translate(o,o,T.vec2.set(y,this._xOffset,-this._yOffset)),T.mat2d.scale(o,o,T.vec2.set(y,t,t));var i=this._baseline?25:e.y+(1-this._yAlignD)*e.height*.5;return T.mat2d.translate(o,o,T.vec2.set(y,-4,-4-i)),o},p.prototype._getOffset=function(e){var t=!!this.vvFlags?9:5;return e.length/t},p.prototype._writeVertices=function(e,t,r,o,i,s,n){this._writeHalos(e,t,r,o,i,s,n),this._writeText(e,t,r,o,i,s,n)},p.prototype._writeHalos=function(e,t,r,o,i,s,n){var a=t.indexVector,h=t.get("geometry"),p=this._getOffset(h),l=0;if(this._haloSize)for(var c=0;c<i.length;c++,l+=4){var u=i[c],f=d.i1616to32(2*u.anchorX+1,2*u.anchorY),_=i[c].materialId,m=this._materialStore.get(_),g=null==s?Math.floor(10*u.minZoom):s,y=null==n?Math.floor(10*u.maxZoom):n,v=new x(r,this.geometryType,_,g,y);v.vertexFrom=p+l,v.indexFrom=a.length,this._writeVertex(v,t,r,f,this._haloColor,u,m,o),this._writeIndices(v,a,p+l),e.push(v)}},p.prototype._writeText=function(e,t,r,o,i,s,n){for(var a=t.indexVector,h=t.get("geometry"),p=this._getOffset(h),l=0,c=0;c<i.length;c++,l+=4){var u=i[c],f=d.i1616to32(2*u.anchorX,2*u.anchorY),_=i[c].materialId,m=this._materialStore.get(_),g=null==s?Math.floor(10*u.minZoom):s,y=null==n?Math.floor(10*u.maxZoom):n,v=new x(r,this.geometryType,_,g,y);v.vertexFrom=p+l,v.indexFrom=a.length,this._writeVertex(v,t,r,f,this._color,u,m,o),this._writeIndices(v,a,p+l),e.push(v)}},p.prototype._writeVertex=function(e,t,r,o,i,s,n,a){var h=t.get("geometry"),p=t.get("visibility");h.push(o),h.push(r),h.push(i),h.push(s.vertexOffsetUpperLeft),h.push(s.texFontSizeUpperLeft),this._writeVV(h,a,n),p.push(m),h.push(o),h.push(r),h.push(i),h.push(s.vertexOffsetUpperRight),h.push(s.texFontSizeUpperRight),this._writeVV(h,a,n),p.push(m),h.push(o),h.push(r),h.push(i),h.push(s.vertexOffsetLowerLeft),h.push(s.texFontSizeLowerLeft),this._writeVV(h,a,n),p.push(m),h.push(o),h.push(r),h.push(i),h.push(s.vertexOffsetLowerRight),h.push(s.texFontSizeLowerRight),this._writeVV(h,a,n),p.push(m),e.vertexCount+=4},p.prototype._writeVV=function(e,t,r){r.materialKeyInfo.hasVV()&&(e.push(t[a.VVType.SIZE]),e.push(t[a.VVType.COLOR]),e.push(t[a.VVType.OPACITY]),e.push(t[a.VVType.ROTATION]))},p.prototype._writeIndices=function(e,t,r){t.push(r+0),t.push(r+1),t.push(r+2),t.push(r+1),t.push(r+3),t.push(r+2),e.indexCount+=6},p}(i.default);t.default=p});