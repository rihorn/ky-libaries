// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.10/esri/copyright.txt for details.

define(["require","exports","../../../../../../core/tsSupport/extendsHelper","../../../../../../core/Logger","../../../../../../core/screenUtils","../../color","../../definitions","../../enums","../../enums","../../LineTess","../../number","../../TileClipper","../../Utils","../../WGLDisplayRecord","./WGLMeshTemplate"],function(e,t,r,i,T,_,o,f,g,D,L,n,V,x,s){Object.defineProperty(t,"__esModule",{value:!0});var C=i.getLogger("esri.views.2d.engine.webgl.WGLLineTemplate"),U=65535,W=D.allocTriangles(20),a=D.allocTriangles(20),B=[D.allocExtrudeVectors(),D.allocExtrudeVectors()],F=D.allocExtrudeVectors(),v=o.TILE_SIZE+8,S=31,j=new D.Tessellator({distanceAlongCorrection:!0}),b=new n.TileClipper(0,0,0,1,8);b.setExtent(o.TILE_SIZE);var l=function(y){function m(e,t,r,i,o,n,s,a,l,p,u,h){var c=y.call(this)||this;c.capType=n,c.joinType=s,c.fillColor=a,c.tl=l,c.br=p,c.hasPattern=u,c.isDashed=h,c.geometryType=f.WGLGeometryType.LINE;var d=1/o;return c.halfWidth=0<i?.5*(i+d):0,c._materialStore=e,c.vvFlags=t,c.materialId=c._materialStore.createSpriteMaterial(r,c.geometryType,t),c}return r(m,y),m.fromSimpleLine=function(e,t,r,i,o){var n=r.color,s="solid"!==r.style&&"none"!==r.style,a=V.getCapType(r.cap||"round",s),l=V.getJoinType(r.join||"round"),p=n&&"none"!==r.style&&_.premultiplyAlphaRGBA(n)||0;if("none"===r.style&&(p=0),!i)return new m(e,t,i,T.pt2px(r.width),o,a,l,p,0,0,!1,s);var u=i.rect,h=i.width,c=i.height,d=u.x+1,y=u.y+1,f=u.x+1+h,v=u.y+1+c,g=L.i1616to32(d,y),x=L.i1616to32(f,v);return new m(e,t,i,T.pt2px(r.width),o,a,l,p,g,x,!0,s)},m.fromPictureLineSymbol=function(e,t,r,i){return C.error("PictureLineSymbol support does not exist!"),null},m.prototype.writeMesh=function(e,t,r,i,o,n,s){if(this.vvFlags&g.WGLVVFlag.COLOR||0!==this.fillColor){var a=this._materialStore.get(this.materialId),l=t.indexVector,p=t.get("geometry"),u=t.get("visibility"),h=this.halfWidth,c=new x(i,this.geometryType,this.materialId),d=this._getOffset(p,a);switch(c.vertexFrom=d,c.indexFrom=l.length,r){case"esriGeometryPolyline":var y=o.geometry.paths;if(0===(f=this._clipLines(y)).length)return;return this._write(c,l,p,u,d,i,h,f,a,s),void e.push(c);case"esriGeometryPolygon":var f,v=o.geometry.rings;if(0===(f=this._clipLines(v)).length)return;return this._write(c,l,p,u,d,i,h,f,a,s),void e.push(c);default:C.error("Unable to handle geometryType: "+r)}}},m.prototype._clipLines=function(e){for(var t=[],r=!1,i=0;i<e.length;){var o=[],n=e[i];b.reset(2);var s=n[0],a=s[0],l=s[1];if(r)b.moveTo(a,l);else{if(a<-8||v<a||l<-8||v<l){r=!0;continue}o.push({x:a,y:l})}for(var p=!1,u=n.length,h=1;h<u;++h)if(a+=n[h][0],l+=n[h][1],r)b.lineTo(a,l);else{if(a<-8||v<a||l<-8||v<l){p=!0;break}o.push({x:a,y:l})}if(p)r=!0;else{if(r){var c=b.resultWithStarts();if(c)for(var d=0,y=c;d<y.length;d++){var f=y[d];t.push(f)}}else t.push({line:o,start:0});i++,r=!1}}return t},m.prototype._getOffset=function(e,t){var r=t.materialKeyInfo.hasVV()?11:8;return e.length/r},m.prototype._write=function(e,t,r,i,o,n,s,a,l,p){for(var u=0,h=0,c=a;h<c.length;h++){var d=c[h],y=d.line,f=d.start;if(!(y.length<2))for(var v=y[0],g=y[y.length-1],x=g.x-v.x,m=g.y-v.y,T=x*x+m*m<1e-6,_=f%U,V=B[1],C=0;C<y.length;C++){var b=y[C],E=V===B[C%2]?B[(C+1)%2]:B[C%2],w=0===C,I=C===y.length-1;if(I&&T&&!this.hasPattern?D.copyExtrudeVectors(E,F):(this._computeExtrudeVectors(E,C,y,T),u+=this._writeVertices(r,i,n,s,b.x,b.y,E,_,u,l,p),null==E.capCenter||T&&I||this._writePieIndices(e,t,o,E),T&&w&&!this.hasPattern&&D.copyExtrudeVectors(F,E)),w||this._writeBridgeIndices(e,t,o,V,E),!I){var L=y[C+1],S=[L.x-b.x,L.y-b.y],M=D.length(S),P=[S[0]/M,S[1]/M],J=_+M;if(U<J){var R=(U-_)/(J-_),O=b.x+(L.x-b.x)*R,A=b.y+(L.y-b.y)*R,G=V;j.buttCap(G,P,P),u+=this._writeVertices(r,i,n,s,O,A,G,U,u,l,p),j.bridge(W,E,G),this._writeBridgeIndices(e,t,o,E,G),j.buttCap(G,P,P),_=J-U}else _=J,V=E}}}e.vertexCount=u},m.prototype._writeVertices=function(e,t,r,i,o,n,s,a,l,p,u){for(var h=0,c=L.i1616to32(o,n),d=s.vectors,y=d.items,f=d.count;h<f;++h){var v=y[h].vector,g=v[0],x=v[1],m=y[h].texCoords,T=m[0],_=m[1],V=y[h].direction,C=V[0],b=V[1],E=L.i1616to32(a,S*i),w=L.i8888to32(Math.round(S*g),Math.round(S*x),Math.round(S*T),Math.round(S*_)),I=L.i8888to32(Math.round(S*C),Math.round(S*b),0,0);e.push(c),e.push(r),e.push(this.fillColor),e.push(w),e.push(E),e.push(this.tl),e.push(this.br),e.push(I),this._writeVV(e,u,p),t.push(255),y[h].base={index:l+h,point:[o,n]}}return h},m.prototype._writeVV=function(e,t,r){r.materialKeyInfo.hasVV()&&(e.push(t[f.VVType.SIZE]),e.push(t[f.VVType.COLOR]),e.push(t[f.VVType.OPACITY]))},m.prototype._writeBridgeIndices=function(e,t,r,i,o){j.bridge(W,i,o);for(var n=0;n<W.count;++n){var s=W.items[n];t.push(r+s.v1.base.index),t.push(r+s.v2.base.index),t.push(r+s.v3.base.index),e.indexCount+=3}},m.prototype._writePieIndices=function(e,t,r,i){j.pie(a,i);for(var o=0;o<a.count;++o){var n=a.items[o];t.push(r+n.v1.base.index),t.push(r+n.v2.base.index),t.push(r+n.v3.base.index),e.indexCount+=3}},m.prototype._computeExtrudeVectors=function(e,t,r,i){var o=r[t],n=[void 0,void 0],s=[void 0,void 0];if(0<t&&t<r.length-1){var a=r[(t+r.length-1)%r.length],l=r[(t+1)%r.length];D.normalize(n,[o.x-a.x,o.y-a.y]),D.normalize(s,[l.x-o.x,l.y-o.y])}else if(0===t){l=r[(t+1)%r.length];if(D.normalize(s,[l.x-o.x,l.y-o.y]),i){var p=r[r.length-2];D.normalize(n,[o.x-p.x,o.y-p.y])}else n=s}else{if(t!==r.length-1)return void console.error("Vertex index 'i' out of range.");a=r[(t+r.length-1)%r.length];if(D.normalize(n,[o.x-a.x,o.y-a.y]),i){var u=r[1];D.normalize(s,[u.x-o.x,u.y-o.y])}else s=n}i||0!==t?i||t!==r.length-1?this._computeJoinExtrudeVectors(e,n,s):this._computeCapExtrudeVectors(e,n,s,D.CapPosition.END):this._computeCapExtrudeVectors(e,n,s,D.CapPosition.START)},m.prototype._computeCapExtrudeVectors=function(e,t,r,i){switch(this.capType){case f.CapType.BUTT:return void j.buttCap(e,t,r);case f.CapType.ROUND:var o=D.getNumberOfSlices(Math.PI),n=i===D.CapPosition.START?-1:1;return void j.roundCap(e,t,r,i,o,n);case f.CapType.SQUARE:return void(this.isDashed?j.squareCapForDashedLines(e,t,r,i):j.squareCap(e,t,r,i));default:return C.error("Encountered unknown cap type: "+this.capType+", defaulting to BUTT"),void j.buttCap(e,t,r)}},m.prototype._computeJoinExtrudeVectors=function(e,t,r){var i=D.getRads(t,r);if(i>Math.PI-.05)j.rectJoin(e,t,r);else if(this.joinType===f.JoinType.MITER||i<.1)i<.05?j.fastMiterJoin(e,t,r):i<D.MITER_SAFE_RADS?j.miterJoin(e,t,r):j.bevelJoin(e,t,r,D.SYSTEM_MAG_LIMIT);else if(this.joinType===f.JoinType.BEVEL)j.bevelJoin(e,t,r,1);else if(this.joinType===f.JoinType.ROUND){var o=D.getNumberOfSlices(i);i<2.3?o<2||i<.5?j.bevelJoin(e,t,r,1):j.roundJoin(e,t,r,o):j.unitRoundJoin(e,t,r,o)}},m}(s.default);t.default=l});