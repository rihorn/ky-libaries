// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.10/esri/copyright.txt for details.

define(["require","exports","../../../../../../core/tsSupport/awaiterHelper","../../../../../../core/tsSupport/generatorHelper","../../../../../../symbols","../../../../../../core/Error","../../../../../../core/Logger","../../../../../../core/promiseUtils","../../enums","./WGLFillTemplate","./WGLLineTemplate","./WGLMarkerTemplate","./WGLTextTemplate","../../util/BidiText","../../util/Lock","../../util/Result","../../util/vvFlagUtils"],function(e,t,r,l,i,o,s,a,u,c,p,h,m,n,_,f,d){Object.defineProperty(t,"__esModule",{value:!0});var y=s.getLogger("esri.views.2d.engine.webgl.mesh.templates.WGLTemplateStore"),T=new Array,b=new i.SimpleFillSymbol({color:"black",outline:null}),g=new i.SimpleMarkerSymbol({size:"14px",color:"black",outline:null}),S=new i.SimpleLineSymbol({color:"black",width:"2px"});function v(t,e){var r=t.length;return t.push(null),e.then(function(e){return t[r]=e}),t}var M=function(){function e(e,t){this._idCounter=0,this._templateIdCounter=0,this._idToTemplateGroup=new Map,this._symbolToTemplate=new Map,this._fetchQueue=[],this._idToResolver=new Map,this._pixelRatio=1,this._lock=new _.default,this._fetchResource=e,this._pixelRatio=t}return Object.defineProperty(e.prototype,"_markerError",{get:function(){return this._errorTemplates.marker[0]},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"_fillError",{get:function(){return this._errorTemplates.fill[0]},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"_lineError",{get:function(){return this._errorTemplates.line[0]},enumerable:!0,configurable:!0}),e.prototype.createTemplateGroup=function(e,t,r,i){this._initErrorTemplates(r);var o=this._hashSymbol(e);if(!this._symbolToTemplate.has(o)){var s=new Array;t&&this._createMeshTemplates(s,r,t,i,this._pixelRatio,!0),this._createMeshTemplates(s,r,e,i,this._pixelRatio,!1);var n=this._createGroupId();this._idToTemplateGroup.set(n,s),this._symbolToTemplate.set(o,n)}return this._symbolToTemplate.get(o)},e.prototype.getTemplateGroup=function(e){return this._idToTemplateGroup.has(e)?this._idToTemplateGroup.get(e):T},e.prototype.finalize=function(){return this._fetchQueue.length||this._lock.isHeld()?_.withLock(this._lock,this._fetchAllQueuedResources.bind(this)):a.resolve()},e.prototype._initErrorTemplates=function(e){if(!this._errorTemplates){var t=this._pixelRatio,r=this._createMeshTemplates([],e,b,0,t,!1),i=this._createMeshTemplates([],e,g,0,t,!1),o=this._createMeshTemplates([],e,S,0,t,!1);this._errorTemplates={fill:r,marker:i,line:o}}},e.prototype._fetchAllQueuedResources=function(){var n=this;if(!this._fetchQueue.length)return a.resolve();var t=this._fetchQueue;return this._fetchQueue=[],this._fetchResource(t).then(function(e){for(var t=0,r=e;t<r.length;t++){var i=r[t],o=i.id,s=i.mosaicItem;n._idToResolver.get(o)(s),n._idToResolver.delete(o)}}).catch(function(e){"cancel"===e.dojoType?n._fetchQueue=n._fetchQueue.concat(t):y.error(new o("mapview-template-store","Unable to fetch requested texture resources",e))})},e.prototype._createGroupId=function(){return this._idCounter++},e.prototype._createTemplateId=function(){return this._templateIdCounter++},e.prototype._getCodepoints=function(e){for(var t=n.bidiText(e.text)[0],r=[],i=0;i<t.length;i++)r.push(t.charCodeAt(i));return r},e.prototype._getMosaicItem=function(e){var t=this,r=this._createTemplateId(),i="text"===e.type&&this._getCodepoints(e),o=a.create(function(e){return t._idToResolver.set(r,e)});return this._fetchQueue.push({symbol:e.toJSON(),id:r,glyphIds:i}),o},e.prototype._hashSymbol=function(e){return e.id?e.id:JSON.stringify(e)},e.prototype._createSMS=function(i,o,s,n){return r(this,void 0,void 0,function(){var t,r;return l(this,function(e){switch(e.label){case 0:return[4,this._getMosaicItem(o)];case 1:return t=e.sent().spriteMosaicItem,r=d.getMarkerVVFlags(s),f.ok(t,y)?[2,h.default.fromSimpleMarker(i,r,o,t,n)]:[2,this._markerError]}})})},e.prototype._createPMS=function(i,o,s,n){return r(this,void 0,void 0,function(){var t,r;return l(this,function(e){switch(e.label){case 0:return[4,this._getMosaicItem(o)];case 1:return t=e.sent().spriteMosaicItem,r=d.getMarkerVVFlags(s),f.ok(t,y)?[2,h.default.fromPictureMarker(i,r,o,t,n)]:[2,this._markerError]}})})},e.prototype._createSFS=function(i,o,s,n,a){return r(this,void 0,void 0,function(){var t,r;return l(this,function(e){switch(e.label){case 0:return[4,this._getMosaicItem(o)];case 1:return t=e.sent().spriteMosaicItem,r=d.getFillVVFlags(s),f.ok(t,y)?[2,c.default.fromSimpleFill(i,r,o,t,n,a)]:[2,this._fillError]}})})},e.prototype._createPFS=function(i,o,s,n,a){return r(this,void 0,void 0,function(){var t,r;return l(this,function(e){switch(e.label){case 0:return[4,this._getMosaicItem(o)];case 1:return t=e.sent().spriteMosaicItem,r=d.getFillVVFlags(s),f.ok(t,y)?[2,c.default.fromPictureFill(i,r,o,t,n,a)]:[2,this._fillError]}})})},e.prototype._createSLS=function(i,o,s,n,a){return r(this,void 0,void 0,function(){var t,r;return l(this,function(e){switch(e.label){case 0:return[4,this._getMosaicItem(o)];case 1:return t=e.sent().spriteMosaicItem,r=d.getLineVVFlags(s,a),f.ok(t,y)?[2,p.default.fromSimpleLine(i,r,o,t,n)]:[2,this._lineError]}})})},e.prototype._createTS=function(i,o,s,n){return r(this,void 0,void 0,function(){var t,r;return l(this,function(e){switch(e.label){case 0:return[4,this._getMosaicItem(o)];case 1:return t=e.sent().glyphMosaicItems,r=d.getTextVVFlags(s),[2,m.default.fromText(i,r,o,n,t)]}})})},e.prototype._createMeshTemplates=function(e,t,r,i,o,s){if(-1!==r.type.indexOf("3d"))return y.error("3D symbols are not supported with MapView"),e;switch(r.type){case u.EsriSymbolTypeKebab.SIMPLE_MARKER:return v(e,this._createSMS(t,r,i,o));case u.EsriSymbolTypeKebab.PICTURE_MARKER:return v(e,this._createPMS(t,r,i,o));case u.EsriSymbolTypeKebab.SIMPLE_FILL:var n=r;return v(e,this._createSFS(t,n,i,o,s)),n.outline&&v(e,this._createSLS(t,n.outline,i,o,!0)),e;case u.EsriSymbolTypeKebab.PICTURE_FILL:var a=r;return v(e,this._createPFS(t,a,i,o,s)),a.outline&&v(e,this._createSLS(t,a.outline,i,o,!0)),e;case u.EsriSymbolTypeKebab.SIMPLE_LINE:return v(e,this._createSLS(t,r,i,o,!1));case u.EsriSymbolTypeKebab.TEXT:return v(e,this._createTS(t,r,i,o));default:return y.error("Unable to create mesh template for unknown symbol type: "+r.type),e}},e}();t.default=M});