// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.10/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/generatorHelper","../../../../core/Logger","./enums","./MaterialInfo","./Utils"],function(e,t,n,r,m,p,y){var i=r.getLogger("esri.views.2d.engine.webgl.WGLDisplayList");function d(e,t,n){for(var r=[],o=3;o<arguments.length;o++)r[o-3]=arguments[o];t<e.length?e.splice.apply(e,[t,n].concat(r)):e.push.apply(e,r)}var h=new Map;h.set(m.WGLDrawPhase.MAP,[m.WGLGeometryType.FILL,m.WGLGeometryType.LINE,m.WGLGeometryType.MARKER,m.WGLGeometryType.TEXT]),h.set(m.WGLDrawPhase.LABEL,[m.WGLGeometryType.LABEL]),h.set(m.WGLDrawPhase.LABEL_ALPHA,[m.WGLGeometryType.LABEL]);var o=function(){function o(e){void 0===e&&(e=!1),this.symbolLevels=[],this.unified=e}return o.prototype.replay=function(n,r){if(this.unified)for(var e=0,t=this.symbolLevels;e<t.length;e++)for(var o=0,i=t[e].zLevels;o<i.length;o++){var l=i[o].geometryDPInfo;for(var s in l)if(l[s])for(var y=0,a=l[s];y<a.length;y++){var m=a[y];n.painter.getGeometryBrush(m.geometryType).drawGeometry(n,r,m,null)}}else for(var u=function(e){var t=n.painter.getGeometryBrush(e);f.byType(e,function(e){t.drawGeometry(n,r,e,null)})},f=this,p=0,d=h.get(n.drawPhase);p<d.length;p++){u(d[p])}},Object.defineProperty(o.prototype,"empty",{get:function(){return!this.symbolLevels||0===this.symbolLevels.length},enumerable:!0,configurable:!0}),o.prototype.clear=function(){this.symbolLevels.length=0},o.prototype.addToList=function(e,t){if(Array.isArray(e))for(var n=0,r=e;n<r.length;n++){var o=r[n];this._addToList(o,t)}else this._addToList(e,t)},o.prototype.removeFromList=function(e){Array.isArray(e)||(e=[e]);for(var t=null,n=0,r=e;n<r.length;n++){var o=r[n];t=this._removeFromList(o)}return t},o.prototype.byType=function(e,t){for(var n=0,r=this.symbolLevels;n<r.length;n++)for(var o=0,i=r[n].zLevels;o<i.length;o++){var l=i[o].geometryDPInfo,s=this.getDPInfoType(e);if(l[s])for(var y=0,a=l[s];y<a.length;y++){t(a[y])}}},o.prototype.clone=function(){for(var e=new o(this.unified),t=0,n=this.symbolLevels;t<n.length;t++){var r=n[t];e.symbolLevels.push(r.clone())}return e},o.prototype.splitAfter=function(e){for(var t=this._getDisplayList(e.symbolLevel,e.zOrder,e.geometryType),n=t.length,r=e.indexFrom+e.indexCount,o=0;o<n;++o){var i=t[o];if(i.geometryType===e.geometryType&&r>i.indexFrom&&r<=i.indexFrom+i.indexCount){if(r<i.indexFrom+i.indexCount){var l=new L;l.geometryType=i.geometryType,l.materialInfo=i.materialInfo,l.indexFrom=r,l.indexCount=i.indexFrom+i.indexCount-r,t.splice(o+1,0,l),i.indexCount=r-i.indexFrom}return o}}},o.prototype._addToList=function(e,t){var n=e.symbolLevel,r=e.zOrder,o=this._getDisplayList(n,r,e.geometryType),i=null!=t?t:o.length-1,l=0<=i&&i<o.length?o[i]:null;if(null===l||!y.isSameMaterialInfo(l.materialInfo,e.materialInfo)||l.indexFrom+l.indexCount!==e.indexFrom||this.unified&&l.geometryType!==e.geometryType){var s=new L;s.indexFrom=e.indexFrom,s.indexCount=e.indexCount,s.materialInfo=e.materialInfo,s.geometryType=e.geometryType,d(o,i+1,0,s)}else l.indexCount+=e.indexCount},o.prototype._removeFromList=function(e){for(var t=e.symbolLevel,n=e.zOrder,r=this._getDisplayList(t,n,e.geometryType),o=r.length,i=void 0,l=0;l<o;++l){var s=r[l];if(e.indexFrom+e.indexCount>s.indexFrom&&e.indexFrom<s.indexFrom+s.indexCount&&(!this.unified||s.geometryType===e.geometryType)){i=l;break}}if(void 0===i)return null;s=r[i];if(e.indexFrom===s.indexFrom)return s.indexCount-=e.indexCount,s.indexFrom+=e.indexCount,0===s.indexCount&&d(r,i,1),i-1;if(e.indexFrom+e.indexCount===s.indexFrom+s.indexCount)return s.indexCount-=e.indexCount,0===s.indexCount?(d(r,i,1),i-1):i;var y=s.indexFrom,a=e.indexFrom-s.indexFrom,m=e.indexCount,u=s.indexFrom+s.indexCount-(e.indexFrom+e.indexCount);s.indexCount=a;var f=new L;return f.geometryType=s.geometryType,f.materialInfo=new p.default,f.materialInfo.copy(s.materialInfo),f.indexFrom=y+a+m,f.indexCount=u,d(r,i+1,0,f),i},o.prototype._getDisplayList=function(e,t,n){for(var r,o,i=this.symbolLevels.length,l=0;l<i;l++)if(this.symbolLevels[l].symbolLevel===e){r=this.symbolLevels[l];break}r||((r=new g).symbolLevel=e,this.symbolLevels.push(r));for(var s,y=r.zLevels.length,a=0;a<y;a++)if(r.zLevels[a].zLevel===t){o=r.zLevels[a];break}if(o||((o=new f).geometryDPInfo=new u,o.zLevel=t,r.zLevels.push(o)),this.unified)o.geometryDPInfo.unified||(o.geometryDPInfo.unified=[]),s=o.geometryDPInfo.unified;else switch(n){case m.WGLGeometryType.FILL:o.geometryDPInfo.fill||(o.geometryDPInfo.fill=[]),s=o.geometryDPInfo.fill;break;case m.WGLGeometryType.LINE:o.geometryDPInfo.line||(o.geometryDPInfo.line=[]),s=o.geometryDPInfo.line;break;case m.WGLGeometryType.MARKER:o.geometryDPInfo.marker||(o.geometryDPInfo.marker=[]),s=o.geometryDPInfo.marker;break;case m.WGLGeometryType.TEXT:o.geometryDPInfo.text||(o.geometryDPInfo.text=[]),s=o.geometryDPInfo.text;break;case m.WGLGeometryType.LABEL:o.geometryDPInfo.label||(o.geometryDPInfo.label=[]),s=o.geometryDPInfo.label;break;default:console.error("Trying to add a record with geometry type '"+n+"'.")}return s},o.prototype.getDPInfoType=function(e){if(this.unified)return"unified";switch(e){case m.WGLGeometryType.FILL:return"fill";case m.WGLGeometryType.LINE:return"line";case m.WGLGeometryType.MARKER:return"marker";case m.WGLGeometryType.TEXT:return"text";case m.WGLGeometryType.LABEL:return"label";default:i.error("DisplayList: Tried to convert unknown geometryType: "+e)}},o}(),L=function(){function t(){this.materialInfo=null,this.indexFrom=0,this.indexCount=0}return t.prototype.clone=function(){var e=new t;return e.geometryType=this.geometryType,e.materialInfo=new p.default,e.materialInfo.copy(this.materialInfo),e.indexFrom=this.indexFrom,e.indexCount=this.indexCount,e},t}(),u=function(){function t(){this.fill=null,this.line=null,this.marker=null,this.text=null,this.label=null,this.unified=null}return t.prototype.clone=function(){var e=new t;return e.fill=this.fill&&this.fill.map(function(e){return e.clone()}),e.line=this.line&&this.line.map(function(e){return e.clone()}),e.marker=this.marker&&this.marker.map(function(e){return e.clone()}),e.text=this.text&&this.text.map(function(e){return e.clone()}),e.label=this.label&&this.label.map(function(e){return e.clone()}),e.unified=this.unified&&this.unified.map(function(e){return e.clone()}),e},t}(),f=function(){function t(){this.geometryDPInfo=new u}return t.prototype.clone=function(){var e=new t;return e.zLevel=this.zLevel,e.geometryDPInfo=this.geometryDPInfo.clone(),e},t}(),g=function(){function o(){this.zLevels=[]}return o.prototype.clone=function(){var e=new o;e.symbolLevel=this.symbolLevel;for(var t=0,n=this.zLevels;t<n.length;t++){var r=n[t];e.zLevels.push(r.clone())}return e},o}();return o});