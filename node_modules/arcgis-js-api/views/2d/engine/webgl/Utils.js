// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.10/esri/copyright.txt for details.

define(["require","exports","../../../../arcade/Dictionary","../../../../arcade/Feature","../../../../core/Error","../../../../core/Logger","../../../../core/screenUtils","../../../../geometry/support/quantizationUtils","../../../../support/arcadeUtils","./color","./enums","./SymbolProperties","../../../3d/support/mathUtils","../../../webgl/Texture"],function(e,t,i,a,n,r,o,s,m,_,u,c,E,I){var l;Object.defineProperty(t,"__esModule",{value:!0});var T=r.getLogger("esri.views.2d.engine.webgl.Utils");function y(e){for(var r={},t=0,n=e;t<n.length;t++){var i=n[t];r[i.name]=i.strideInBytes}return r}t.C_HITTEST_SEARCH_SIZE=4,t.C_VBO_GEOMETRY="geometry",t.C_VBO_PERINSTANCE="per_instance",t.C_VBO_PERINSTANCE_VV="per_instance_vv",t.C_VBO_VISIBILITY="visibility",t.C_VBO_VISIBILITY_RANGE="visibilityRange",t.C_ICON_VERTEX_DEF=[{name:t.C_VBO_GEOMETRY,strideInBytes:24,divisor:0},{name:t.C_VBO_VISIBILITY,strideInBytes:1,divisor:0}],t.C_ICON_VERTEX_DEF_VV=[{name:t.C_VBO_GEOMETRY,strideInBytes:40,divisor:0},{name:t.C_VBO_VISIBILITY,strideInBytes:1,divisor:0}],t.C_FILL_VERTEX_DEF=[{name:t.C_VBO_GEOMETRY,strideInBytes:28,divisor:0},{name:t.C_VBO_VISIBILITY,strideInBytes:1,divisor:0}],t.C_FILL_VERTEX_DEF_VV=[{name:t.C_VBO_GEOMETRY,strideInBytes:36,divisor:0},{name:t.C_VBO_VISIBILITY,strideInBytes:1,divisor:0}],t.C_LINE_VERTEX_DEF=[{name:t.C_VBO_GEOMETRY,strideInBytes:32,divisor:0},{name:t.C_VBO_VISIBILITY,strideInBytes:1,divisor:0}],t.C_LINE_VERTEX_DEF_VV=[{name:t.C_VBO_GEOMETRY,strideInBytes:44,divisor:0},{name:t.C_VBO_VISIBILITY,strideInBytes:1,divisor:0}],t.C_TEXT_VERTEX_DEF=[{name:t.C_VBO_GEOMETRY,strideInBytes:20,divisor:0},{name:t.C_VBO_VISIBILITY,strideInBytes:1,divisor:0}],t.C_TEXT_VERTEX_DEF_VV=[{name:t.C_VBO_GEOMETRY,strideInBytes:36,divisor:0},{name:t.C_VBO_VISIBILITY,strideInBytes:1,divisor:0}],t.C_LABEL_VERTEX_DEF=[{name:t.C_VBO_GEOMETRY,strideInBytes:24,divisor:0},{name:t.C_VBO_VISIBILITY,strideInBytes:1,divisor:0},{name:t.C_VBO_VISIBILITY_RANGE,strideInBytes:2,divisor:0}],t.C_ICON_STRIDE_SPEC=y(t.C_ICON_VERTEX_DEF),t.C_ICON_STRIDE_SPEC_VV=y(t.C_ICON_VERTEX_DEF_VV),t.C_FILL_STRIDE_SPEC=y(t.C_FILL_VERTEX_DEF),t.C_FILL_STRIDE_SPEC_VV=y(t.C_FILL_VERTEX_DEF_VV),t.C_LINE_STRIDE_SPEC=y(t.C_LINE_VERTEX_DEF),t.C_LINE_STRIDE_SPEC_VV=y(t.C_LINE_VERTEX_DEF_VV),t.C_TEXT_STRIDE_SPEC=y(t.C_TEXT_VERTEX_DEF),t.C_TEXT_STRIDE_SPEC_VV=y(t.C_TEXT_VERTEX_DEF_VV),t.C_LABEL_STRIDE_SPEC=y(t.C_LABEL_VERTEX_DEF),t.getStrides=function(e,r){switch(e){case u.WGLGeometryType.MARKER:return r?t.C_ICON_STRIDE_SPEC_VV:t.C_ICON_STRIDE_SPEC;case u.WGLGeometryType.FILL:return r?t.C_FILL_STRIDE_SPEC_VV:t.C_FILL_STRIDE_SPEC;case u.WGLGeometryType.LINE:return r?t.C_LINE_STRIDE_SPEC_VV:t.C_LINE_STRIDE_SPEC;case u.WGLGeometryType.TEXT:return r?t.C_TEXT_STRIDE_SPEC_VV:t.C_TEXT_STRIDE_SPEC;case u.WGLGeometryType.LABEL:return t.C_LABEL_STRIDE_SPEC}return null};var p=[t.C_VBO_GEOMETRY,t.C_VBO_VISIBILITY],f=[t.C_VBO_GEOMETRY,t.C_VBO_VISIBILITY],C=[t.C_VBO_GEOMETRY,t.C_VBO_VISIBILITY],V=[t.C_VBO_GEOMETRY,t.C_VBO_VISIBILITY],d=[t.C_VBO_GEOMETRY,t.C_VBO_VISIBILITY,t.C_VBO_VISIBILITY_RANGE];function B(e){switch(e){case u.WGLGeometryType.MARKER:return p;case u.WGLGeometryType.FILL:return f;case u.WGLGeometryType.LINE:return C;case u.WGLGeometryType.TEXT:return V;case u.WGLGeometryType.LABEL:return d}return null}function S(e){switch(e%4){case 0:case 2:return 4;case 1:case 3:return 1}}function v(e){switch(e){case"esriSMS":return"simple-marker";case"esriPMS":return"picture-marker";case"esriSLS":return"simple-line";case"esriPLS":return"picture-line";case"esriSFS":return"simple-fill";case"esriPFS":return"picture-fill";case"esriTS":return"text"}return e}function h(e){var r=v(e.type);if(r){switch(r){case"simple-marker":case"picture-marker":case"CIMPointSymbol":return!0}return!1}}function L(e){var r=v(e.type);if(r){switch(r){case"simple-fill":case"picture-fill":case"CIMPolygonSymbol":return!0}return!1}}function O(e){var r=v(e.type);if(r){switch(r){case"simple-line":case"picture-line":case"CIMLineSymbol":return!0}return!1}}function R(e){var r=v(e.type);if(r){switch(r){case"text":case"CIMTextSymbol":return!0}return!1}}function g(e,r){return!1}function G(e){return e&&e.length||0}function M(e){return"string"==typeof e}t.getNamedBuffers=B,t.strideToPackingFactor=S,t.allocateTypedArrayBuffer=function(e,r){switch(r%4){case 0:case 2:return new Uint32Array(Math.floor(e*r/4));case 1:case 3:return new Uint8Array(e*r)}},t.allocateTypedArrayBufferwithData=function(e,r){switch(r%4){case 0:case 2:return new Uint32Array(e);case 1:case 3:return new Uint8Array(e)}},t.getSymbolGeometryType=function(e){return h(e)?u.WGLGeometryType.MARKER:O(e)?u.WGLGeometryType.LINE:L(e)?u.WGLGeometryType.FILL:R(e)?u.WGLGeometryType.TEXT:u.WGLGeometryType.UNKNOWN},t.normalizeSymbolType=v,t.isMarkerSymbol=h,t.isFillSymbol=L,t.isLineSymbol=O,t.isPictureSymbol=function(e){var r=v(e.type);if(r){switch(r){case"picture-marker":case"picture-line":case"picture-fill":return!0}return!1}return!1},t.isTextSymbol=R,t.getTextProperties=function(e){return c.TextProperties.pool.acquire(e.color?_.copyAndPremultiply(e.color):[255,255,255,255],e.haloColor?_.copyAndPremultiply(e.haloColor):[255,255,255,255],o.pt2px(e.haloSize),o.pt2px(e.font.size),e.angle*Math.PI/180,e.xoffset/e.font.size,e.yoffset/e.font.size,"left"===e.horizontalAlignment?0:"right"===e.horizontalAlignment?1:.5,"top"===e.verticalAlignment?0:"bottom"===e.verticalAlignment?1:.5)},t.isSameUniformValue=g,t.isSameMaterialInfo=function(e,r){if(e.materialKey!==r.materialKey)return!1;if(G(e.texBindingInfo)!==G(r.texBindingInfo))return!1;if(G(e.materialParams)!==G(r.materialParams))return!1;for(var t=e.texBindingInfo.length,n=0;n<t;++n){var i=e.texBindingInfo[n],a=r.texBindingInfo[n];if(i.unit!==a.unit||i.pageId!==a.pageId||i.semantic!==a.semantic)return!1}var o=e.materialParams.length;for(n=0;n<o;++n){var s=e.materialParams[n],_=r.materialParams[n];if(s.name!==_.name||(s.value,_.value,1))return!1}return!0},t.serializeString=function(e,r,t){for(var n=0,i=e.length,a=0;a<i;++a)r&&(r[t+n]=e.charCodeAt(a)),++n;return r&&(r[t+n]=0),++n},t.deserializeString=function(e,r,t){for(var n=0,i=!(e.s="");i;){var a=r[t+n];++n,0!==a?e.s+=String.fromCharCode(a):i=!1}return n},t.isDefined=function(e){return null!=e},t.isNumber=function(e){return"number"==typeof e},t.isString=M,t.isStringOrNull=function(e){return null==e||M(e)},t.lerp=function(e,r,t){return e+(r-e)*t};var P=function(){function e(){this._arr=[],this._push=this._push.bind(this)}return e.prototype._push=function(e,r){this._arr.push(r)},e.prototype.getKeys=function(e){return this._arr.length=0,e&&e.forEach(this._push),this._arr},e}();t.KeysGetter=P;var D=function(){function e(){this._arr=[],this._push=this._push.bind(this)}return e.prototype._push=function(e,r){this._arr.push(e)},e.prototype.getValues=function(e){return this._arr.length=0,e&&e.forEach(this._push),this._arr},e}();function F(e){var i={};switch(e){case"esriGeometryPoint":return function(e,r,t,n){return s.hydratePoint(r,i,e,t,n)};case"esriGeometryPolygon":return function(e,r,t,n){return s.hydratePolygon(r,i,e,t,n)};case"esriGeometryPolyline":return function(e,r,t,n){return s.hydratePolyline(r,i,e,t,n)};case"esriGeometryMultipoint":return function(e,r,t,n){return s.hydrateMultipoint(r,i,e,t,n)};default:return T.error(new n("mapview-arcade","Unable to handle geometryType: "+e)),function(e,r,t,n){return e}}}t.ValuesGetter=D,t.getCapType=function(e,r){switch(e){case"butt":return u.CapType.BUTT;case"round":return r?u.CapType.SQUARE:u.CapType.ROUND;case"square":return u.CapType.SQUARE;default:return T.error(new n("mapview-invalid-type","Cap type "+e+" is not a valid option. Defaulting to round")),u.CapType.ROUND}},t.getJoinType=function(e){switch(e){case"miter":return u.JoinType.MITER;case"bevel":return u.JoinType.BEVEL;case"round":return u.JoinType.ROUND;default:return T.error(new n("mapview-invalid-type","Join type "+e+" is not a valid option. Defaulting to round")),u.JoinType.ROUND}},t.getVVType=function(e){switch(e){case"opacity":return u.VVType.OPACITY;case"color":return u.VVType.COLOR;case"rotation":return u.VVType.ROTATION;case"size":return u.VVType.SIZE;default:return T.error("Cannot interpret unknown vv: "+e),null}},t.createHydrateFactory=F,t.getTransformParams=function(e){return{transform:e.transform,hasZ:e.hasZ,hasM:e.hasM}},t.createArcadeFunction=function(e,r,_){var t=r.fields,u=r.spatialReference,c=r.hasGeometryExpr,n=r.geometryType,E=m.createFunction(e),I=new a,l=new i({viewingMode:null,scale:null}),T={},y={vars:{$feature:I,$view:null},spatialReference:u},p={fields:t},f=F(n);return function(e,r,t){if(c){var n=r.transform,i=r.hasZ,a=r.hasM,o=f(e.geometry,n,i,a);o.spatialReference=u,I.repurposeFromGraphicLikeObject(o,e.attributes,p)}else I.repurposeFromGraphicLikeObject(e.geometry,e.attributes,p);t?((y.vars.$view=l).attributes.viewingMode=t.viewingMode,l.attributes.scale=t.scale):y.vars.$view=T;var s=m.executeFunction(E,y);return _?_(s):s}},t.copyMeshData=function(e,r,t,n,i,a,o){for(var s in a)for(var _=a[s].stride,u=S(_),c=a[s].data,E=t[s].data,I=_*i.vertexCount/u,l=_*e/u,T=_*i.vertexFrom/u,y=0;y<I;++y)E[y+l]=c[y+T];var p=i.indexCount;for(y=0;y<p;++y)n[y+r]=o[y+i.indexFrom]-i.vertexFrom+e},t.C_VBO_INFO=((l={})[t.C_VBO_GEOMETRY]=35044,l[t.C_VBO_VISIBILITY]=35044,l[t.C_VBO_VISIBILITY_RANGE]=35048,l),t.createGeometryData=function(e,r){for(var t=[],n=0;n<5;++n){for(var i={},a=0,o=B(n);a<o.length;a++){var s=o[a];i[s]={data:r(n,s)}}t.push({data:e(n),buffers:i})}return t},t.resampleHermite=function(e,r,t,n,i,a,o){void 0===o&&(o=!0);for(var s=r/i,_=t/a,u=Math.ceil(s/2),c=Math.ceil(_/2),E=0;E<a;E++)for(var I=0;I<i;I++){for(var l=4*(I+(o?a-E-1:E)*i),T=0,y=0,p=0,f=0,m=0,C=0,V=0,d=(E+.5)*_,B=Math.floor(E*_);B<(E+1)*_;B++)for(var S=Math.abs(d-(B+.5))/c,v=(I+.5)*s,h=S*S,L=Math.floor(I*s);L<(I+1)*s;L++){var O=Math.abs(v-(L+.5))/u,R=Math.sqrt(h+O*O);-1<=R&&R<=1&&0<(T=2*R*R*R-3*R*R+1)&&(V+=T*e[3+(O=4*(L+B*r))],p+=T,e[O+3]<255&&(T=T*e[O+3]/250),f+=T*e[O],m+=T*e[O+1],C+=T*e[O+2],y+=T)}n[l]=f/y,n[l+1]=m/y,n[l+2]=C/y,n[l+3]=V/p}},t.createTextureFromTexelData=function(e,r){var t,n;return n=E.isPowerOfTwo(r.width)&&E.isPowerOfTwo(r.height)?(t=!0,9987):(t=!1,9729),new I(e,{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,hasMipmap:t,samplingMode:n,wrapMode:33071,flipped:!0},r)},t.geometryToMappedGeometry=function(e){return{vertexFrom:void 0,vertexTo:void 0,geometry:e}}});