// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.10/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/extendsHelper","../../../../core/libs/gl-matrix-2/gl-matrix","../DisplayObject","./definitions","./DirtyMap","./DisplayRecordStore","./enums","./Fader","./number","./Utils","./WGLBuffers","./WGLDisplayList","../../tiling/TileKey"],function(e,t,r,l,a,s,o,d,v,n,g,x,y,p,h){function f(e,t){return e.sortKey-t.sortKey}var W=new Set;return function(i){function e(e,t,r){void 0===r&&(r=!1);var a=i.call(this)||this;return a._data=null,a.hlDisplayList=null,a._displayList=null,a._wglBuffers=null,a._dirtyMap=new o.default,a.coords=[0,0],a.bounds=[0,0,0,0],a.tileTransform={transform:l.mat4f32.create(),screenTransform:l.mat2df32.create(),displayCoord:l.vec2f32.create(),screenCoord:l.vec2f32.create()},a.dvsMat3=l.mat3f32.create(),a.tileMat3=l.mat3f32.create(),a.labelMat2d=l.mat2df32.create(),a._labelIndex=null,a._dirty=!0,a.fader=new n.default,a.key=h.pool.acquire(e),a.coords[0]=t[0],a.coords[1]=t[3],a.bounds=t,a._ensureCorrectZOrder=r,a}return r(e,i),Object.defineProperty(e.prototype,"iconGeometry",{get:function(){return this.getGeometry(v.WGLGeometryType.MARKER)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"textGeometry",{get:function(){return this.getGeometry(v.WGLGeometryType.TEXT)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"fillGeometry",{get:function(){return this.getGeometry(v.WGLGeometryType.FILL)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"lineGeometry",{get:function(){return this.getGeometry(v.WGLGeometryType.LINE)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"labelGeometry",{get:function(){return this.getGeometry(v.WGLGeometryType.LABEL)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"displayObjects",{get:function(){return this._data.tileDisplayData.displayObjects},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"canDisplay",{get:function(){return!!this.attached},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"isDirty",{get:function(){return this._dirty},set:function(e){(this._dirty=e)||this.isReady||this.ready(),this.requestRender()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"hasData",{get:function(){return!!this._data},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"labelIndex",{get:function(){return this._labelIndex},enumerable:!0,configurable:!0}),e.prototype.getGeometry=function(e){return this._wglBuffers&&this._wglBuffers.has(e)?this._wglBuffers.get(e):null},e.prototype.getDisplayList=function(e){switch(e){case v.WGLDrawPhase.HIGHLIGHT:return this.hlDisplayList;default:return this._data&&this._displayList}},Object.defineProperty(e.prototype,"data",{get:function(){return this._data},enumerable:!0,configurable:!0}),e.prototype.setData=function(e,t,r){var a=e.addOrUpdate,i=e.remove;if(this.fader.reset(),(e.clear||!this.hasData)&&!e.addOrUpdate)return this.clear(),void this.ready();!e.clear&&this.hasData||!e.addOrUpdate?this.hasData&&this._doPatchData({addOrUpdate:a,remove:i},t,r):(a.tileDisplayData.computeDisplayList(this._ensureCorrectZOrder),this._dirtyMap=new o.default,this._dispRecStore=d.default.fromTileData(a,this._dirtyMap),this._data=a,this._readyTileIfNoLabels(t,r),this._dirtyMap.markAllDirty(),this._displayList||(this._displayList=a.tileDisplayData.displayList.clone()))},e.prototype.commitChanges=function(e){this.isDirty&&this._wglBuffers||(this._wglBuffers||(this._wglBuffers=new y.default(this.stage.context)),this._displayList=this._data.tileDisplayData.displayList.clone(),this._wglBuffers.upload(this._data.tileBufferData,this._dirtyMap),this._dirtyMap.markAllClean())},e.prototype.resetVisibility=function(e){var t=this,r=new Array(0),a=new Array(1);e.forEach(function(e){a[0]=e,t.setVisibility(r,a)})},e.prototype.setVisibility=function(e,t){for(var r=this._data.tileBufferData.geometries.map(x.geometryToMappedGeometry),a=0,i=e;a<i.length;a++){var s=i[a];if(f=this._data.tileDisplayData.displayObjectRegistry.get(s))for(var o=0,l=f.displayRecords;o<l.length;o++){if(g=(L=r[(v=l[o]).geometryType]).geometry.vertexBuffer[x.C_VBO_VISIBILITY]){L.vertexFrom=null==L.vertexFrom?v.vertexFrom:Math.min(L.vertexFrom,v.vertexFrom),L.vertexTo=null==L.vertexTo?v.vertexFrom+v.vertexCount:Math.max(L.vertexTo,v.vertexFrom+v.vertexCount);for(var d=v.vertexFrom,n=v.vertexCount,y=0;y<n;++y)g.data[d+y]=255}}}for(var p=0,h=t;p<h.length;p++){var f,c=h[p];if(f=this._data.tileDisplayData.displayObjectRegistry.get(c))for(var u=0,m=f.displayRecords;u<m.length;u++){var v,g;if(g=(L=r[(v=m[u]).geometryType]).geometry.vertexBuffer[x.C_VBO_VISIBILITY]){L.vertexFrom=null==L.vertexFrom?v.vertexFrom:Math.min(L.vertexFrom,v.vertexFrom),L.vertexTo=null==L.vertexTo?v.vertexFrom+v.vertexCount:Math.max(L.vertexTo,v.vertexFrom+v.vertexCount);for(d=v.vertexFrom,n=v.vertexCount,y=0;y<n;++y)g.data[d+y]=0}}}for(var _=!1,D=0;D<r.length;++D){var L;if(null!=(L=r[D]).vertexFrom&&null!=L.vertexTo){var b=L.vertexTo?L.vertexTo-L.vertexFrom:0;this._dirtyMap.markDirtyVertices(D,x.C_VBO_VISIBILITY,L.vertexFrom,b),_=!0}}_&&this.requestRender()},e.prototype.setVisibilityRange=function(e,t,r,a){for(var i=this._data.tileDisplayData.displayObjectRegistry.get(e),s=this._data.tileBufferData.geometries[v.WGLGeometryType.LABEL].vertexBuffer[x.C_VBO_VISIBILITY_RANGE],o=1/0,l=0,d=t;d<t+r;++d){for(var n=i.displayRecords[d],y=Math.max(n.minZoom,a),p=n.maxZoom,h=g.i8888to32(y,p,y,p),f=n.vertexFrom*s.stride/4,c=n.vertexCount*s.stride/4,u=f;u<f+c;++u)s.data[u]=h;o=Math.min(o,n.vertexFrom),l=Math.max(l,n.vertexFrom+n.vertexCount)}var m=l-o;this._dirtyMap.markDirtyVertices(v.WGLGeometryType.LABEL,x.C_VBO_VISIBILITY_RANGE,o,m)},e.prototype.setTransform=function(e,t){var r=this.tileMat3,a=e.toScreenNoRotation([0,0],this.coords),i=a[0],s=a[1],o=t;l.mat3.set(this.tileMat3,o,0,0,0,o,0,i,s,1),l.mat3.multiply(this.dvsMat3,e.displayViewMat3,r)},e.prototype.setLabelTransform=function(e,t){var r=this.labelMat2d,a=e.getScreenTransform(r,t),i=l.vec2f32.create();l.vec2.transformMat2d(i,this.coords,a),l.mat2d.identity(r),l.mat2d.translate(r,r,i),l.mat2d.multiply(r,e.viewMat2d,r)},e.prototype.clear=function(){this._data=null,this._displayList=null,this._dispRecStore=null,this._wglBuffers&&(this._wglBuffers.dispose(),this._wglBuffers=null),this.hlDisplayList&&(this.hlDisplayList=null)},e.prototype.attach=function(){return!0},e.prototype.dispose=function(){this.clear()},e.prototype.doRender=function(e){if(this.isReady&&this.hasData){if(this.commitChanges(e),this.stage.context.setStencilFunction(514,this.stencilRef,255),e.drawPhase===v.WGLDrawPhase.MAP||e.drawPhase===v.WGLDrawPhase.LABEL||e.drawPhase===v.WGLDrawPhase.LABEL_ALPHA)this._displayList.replay(e,this);else for(var t=0,r=this.stage.painter.getBrushes(e.drawPhase);t<r.length;t++){r[t].draw(e,this)}this.fader.step()||this.requestRender()}},e.prototype.buildHLList=function(e){var t=this;this.hlDisplayList=new p;e.forEach(function(e){t._addToHLDisplayList(t.hlDisplayList,e)})},e.prototype._addToHLDisplayList=function(e,t){if(this._data){var r=this._data.tileDisplayData.displayObjectRegistry.get(t);if(r){for(var a=[],i=0,s=r.displayRecords;i<s.length;i++){var o=s[i].copy();o.meshData=null,o.symbolLevel=0,o.zOrder=0,a.push(o)}a.sort(f),e.addToList(a)}}},e.prototype._readyTileIfNoLabels=function(e,t){this.isDirty=!!e&&(t||(this.isDirty=!1),this._rebuildLabelIndex(),!0)},e.prototype._doPatchData=function(e,t,r){this._patchData(e)||(this._dirtyMap.markAllDirty(),this._data.reshuffle(),this._dispRecStore=d.default.fromTileData(this._data,this._dirtyMap)),this._readyTileIfNoLabels(t,r),this.requestRender()},e.prototype._rebuildLabelIndex=function(){this._labelIndex=this._initLabelIndex();for(var e=0,t=this.displayObjects;e<t.length;e++)for(var r=0,a=t[e].metrics;r<a.length;r++){var i=a[r];this._insertIntoLabelIndex(i)}},e.prototype._insertIntoLabelIndex=function(e){-1!==e.xBucket&&this.labelIndex[e.yBucket][e.xBucket].push(e)},e.prototype._initLabelIndex=function(){for(var e=[],t=0;t<s.TILE_SIZE/s.COLLISION_BUCKET_SIZE;t++){e.push([]);for(var r=0;r<s.TILE_SIZE/s.COLLISION_BUCKET_SIZE;r++)e[t].push([])}return e},e.prototype._patchData=function(e){for(var t=!0,r=e.addOrUpdate&&e.addOrUpdate.tileDisplayData&&e.addOrUpdate.tileDisplayData.displayObjects||[],a=(e.remove||[]).slice(),i=0,s=r;i<s.length;i++){null!=(m=s[i]).insertAfter&&a.push(m.id)}for(var o=0,l=a;o<l.length;o++){var d=l[o];if(u=this._data.tileDisplayData.displayObjectRegistry.get(d)){this._data.tileDisplayData.displayList.removeFromList(u.displayRecords);for(var n=0,y=u.displayRecords;n<y.length;n++){var p=y[n];this._dispRecStore.delete(p)}this._data.tileDisplayData.displayObjectRegistry.delete(d);var h=this._data.tileDisplayData.displayObjects.indexOf(u);this._data.tileDisplayData.displayObjects.splice(h,1)}}for(var f=0,c=r;f<c.length;f++){var u,m=c[f],v=void 0;if(u=this._data.tileDisplayData.displayObjectRegistry.get(m.id)){var g=u.displayRecords;u.set(m),u.displayRecords=g;for(var _=u.displayRecords.length,D=0;D<_;++D){var L=u.displayRecords[D],b=m.displayRecords[D];(D>=m.displayRecords.length||L.geometryType!==b.geometryType||L.symbolLevel!==b.symbolLevel||L.zOrder!==b.zOrder||L.materialInfo.materialKey!==b.materialInfo.materialKey)&&(this._dispRecStore.delete(u.displayRecords[D]),D<m.displayRecords.length&&(u.displayRecords[D]=void 0))}u.displayRecords.length=m.displayRecords.length,u.metrics=m.metrics}else{(u=m.copy()).displayRecords=[],this._data.tileDisplayData.displayObjectRegistry.set(m.id,u);var x=void 0,I=this._data.tileDisplayData.displayObjects;if(null!=u.insertAfter)if(v={},0<=u.insertAfter){var R=this._data.tileDisplayData.displayObjectRegistry.get(u.insertAfter);R&&(x=I.indexOf(R)+1)<I.length?I.splice(x,0,u):(I.push(u),x=I.length)}else I.unshift(u),x=0;else I.push(u),x=I.length;if(v){var O=void 0;if(this._data.tileDisplayData.displayList.unified)O=0<m.displayRecords.length?1:0;else{W.clear();for(var T=0,B=m.displayRecords;T<B.length;T++){var G=B[T],M=this._data.tileDisplayData.displayList.getDPInfoType(G.geometryType);W.add(M)}O=W.size}var w=0;for(D=x-1;0<=D&&w<O;--D)for(var F=I[D].displayRecords.length-1;0<=F&&w<O;--F){var j=I[D].displayRecords[F];v[M=this._data.tileDisplayData.displayList.getDPInfoType(j.geometryType)]||(v[M]=j,++w)}}}var P=m.displayRecords.length;for(D=0;D<P;++D){b=m.displayRecords[D];(L=u.displayRecords[D])?(L.meshData=b.meshData,L.materialInfo=b.materialInfo):((L=b.copy()).vertexFrom=void 0,L.indexFrom=void 0,u.displayRecords[D]=L);var C=b.geometryType,S=(M=this._data.tileDisplayData.displayList.getDPInfoType(C),e.addOrUpdate.tileBufferData.geometries[C]),A=S.vertexBuffer,E=S.indexBuffer,V=void 0;v&&(V=v[M]?this._data.tileDisplayData.displayList.splitAfter(v[M]):-1),t=this._dispRecStore.setMeshData(L,b,A,E,V)&&t,v&&null!=L.indexFrom&&null!=L.indexFrom&&(v[M]=L)}}return t},e}(a.DisplayObject)});