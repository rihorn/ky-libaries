// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.10/esri/copyright.txt for details.

define(["require","exports","../../shaders/HighlightPrograms","../../../../../webgl/BufferObject","../../../../../webgl/programUtils","../../../../../webgl/Texture","../../../../../webgl/VertexArrayObject"],function(i,e,u,a,l,d,g){var c=256,f=[void 0,void 0,void 0,1],m=[3,4],t=[0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1],r=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];return function(){function i(){this._width=void 0,this._height=void 0,this._highlightOptions={fillColor:[.2,.6,.9,.75],outlineColor:[.2,.6,.9,.9],outlinePosition:0,outlineWidth:3.4,innerHaloWidth:2,outerHaloWidth:3.3},this._resources=null}return i.prototype.dispose=function(){this._resources&&(this._resources.quadGeometry.dispose(),this._resources.quadVAO.dispose(),this._resources.highlightProgram.dispose(),this._resources.blurProgram.dispose(),this._resources.shadeTex.dispose(),this._resources=null)},i.prototype.preBlur=function(i,e){i.bindTexture(e,m[0]),i.bindProgram(this._resources.blurProgram),this._resources.blurProgram.setUniform4fv("u_direction",[1,0,1/this._width,0]),this._resources.blurProgram.setUniformMatrix4fv("u_channelSelector",t),i.bindVAO(this._resources.quadVAO),i.drawArrays(5,0,4),i.bindVAO()},i.prototype.finalBlur=function(i,e){i.bindTexture(e,m[0]),i.bindProgram(this._resources.blurProgram),this._resources.blurProgram.setUniform4fv("u_direction",[0,1,0,1/this._height]),this._resources.blurProgram.setUniformMatrix4fv("u_channelSelector",r),i.bindVAO(this._resources.quadVAO),i.drawArrays(5,0,4),i.bindVAO()},i.prototype.renderHighlight=function(i,e){i.bindTexture(e,m[0]),i.bindTexture(this._resources.shadeTex,m[1]),i.bindProgram(this._resources.highlightProgram),i.bindVAO(this._resources.quadVAO),i.drawArrays(5,0,4),i.bindVAO()},i.prototype._initialize=function(i,e,t){this._width=e,this._height=t;var r=new a(i,34962,35044,new Int8Array([-1,-1,0,0,1,-1,1,0,-1,1,0,1,1,1,1,1]).buffer),o=new g(i,{a_position:0,a_texcoord:1},{geometry:[{name:"a_position",count:2,type:5120,offset:0,stride:4,normalized:!1},{name:"a_texcoord",count:2,type:5121,offset:2,stride:4,normalized:!1}]},{geometry:r}),s=l.createProgram(i,u.highlight),h=l.createProgram(i,u.blur);s.setUniform1i("u_texture",m[0]),s.setUniform1i("u_shade",m[1]),s.setUniform4fv("u_sigmas",f),h.setUniform1i("u_texture",m[0]),h.setUniform4fv("u_sigmas",f);var n=new d(i,{target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,width:c,height:1,samplingMode:9728});this._resources={quadGeometry:r,quadVAO:o,highlightProgram:s,blurProgram:h,shadeTex:n}},i.prototype.setHighlightOptions=function(i){if(this._highlightOptions=i,this._resources){var e=i.outlinePosition-i.outlineWidth/2-i.outerHaloWidth,t=i.outlinePosition-i.outlineWidth/2,r=i.outlinePosition+i.outlineWidth/2,o=i.outlinePosition+i.outlineWidth/2+i.innerHaloWidth,s=Math.sqrt(Math.PI/2)*f[3],h=Math.abs(e)>s?Math.round(10*(Math.abs(e)-s))/10:0,n=Math.abs(o)>s?Math.round(10*(Math.abs(o)-s))/10:0;h&&!n?console.warn("The outer rim of the highlight is "+h+"px away from the edge of the feature; consider reducing some width values or shifting the outline position towards positive values (inwards)."):!h&&n?console.warn("The inner rim of the highlight is "+n+"px away from the edge of the feature; consider reducing some width values or shifting the outline position towards negative values (outwards)."):h&&n&&console.warn("The highlight is "+Math.max(h,n)+"px away from the edge of the feature; consider reducing some width values.");for(var u,a=new Uint8Array(4*c),l=[void 0,void 0,void 0,void 0],d=0;d<c;++d)(u=e+d/255*(o-e))<e?(a[4*d+0]=0,a[4*d+1]=0,a[4*d+2]=0,a[4*d+3]=0):u<t?g([0,0,0,0],i.outlineColor,(u-e)/(t-e)):u<r?(l[0]=i.outlineColor[0],l[1]=i.outlineColor[1],l[2]=i.outlineColor[2],l[3]=i.outlineColor[3]):u<o?g(i.outlineColor,i.fillColor,(u-r)/(o-r)):(a[4*d+0]=i.fillColor[0],a[4*d+1]=i.fillColor[1],a[4*d+2]=i.fillColor[2],a[4*d+3]=i.fillColor[3]),a[4*d+0]=255*l[0]*l[3],a[4*d+1]=255*l[1]*l[3],a[4*d+2]=255*l[2]*l[3],a[4*d+3]=255*l[3];this._resources.highlightProgram.setUniform2fv("u_minMaxDistance",[e,o]),this._resources.shadeTex.updateData(0,0,0,c,1,a)}function g(i,e,t){l[0]=(1-t)*i[0]+t*e[0],l[1]=(1-t)*i[1]+t*e[1],l[2]=(1-t)*i[2]+t*e[2],l[3]=(1-t)*i[3]+t*e[3]}},i.prototype.setup=function(i,e,t){this._resources?(this._width=e,this._height=t):(this._initialize(i,e,t),this.setHighlightOptions(this._highlightOptions))},i}()});