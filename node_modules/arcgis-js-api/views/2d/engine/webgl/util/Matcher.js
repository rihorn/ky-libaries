// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.10/esri/copyright.txt for details.

define(["require","exports","../../../../../core/tsSupport/extendsHelper","../../../../../core/Logger","../Utils","./vvFlagUtils"],function(e,t,r,i,o,b){Object.defineProperty(t,"__esModule",{value:!0});var u=i.getLogger("esri/views/2d/engine/webgl/util/Matcher"),a=function(){function u(){this._defaultResult=null}return u.fromSimpleRenderer=function(e,t,r){var i=e.getSymbols(),a=e.visualVariables,n=b.getVVFlags(a),l=new u;if(i.length){var o=r.createTemplateGroup(i[0],null,t,n);l.setDefault(o)}return l},u.prototype.size=function(){return 1},u.prototype.getDefault=function(){return this._defaultResult},u.prototype.setDefault=function(e){this._defaultResult=e},u.prototype.match=function(e,t,r){return this.getDefault()},u}(),n=function(l){function z(e,t,r,i,a){var n=l.call(this)||this;return n._intervals=[],n._isMaxInclusive=t,i?n._getValue=o.createArcadeFunction(i,a):e&&e.length?n._getValue="function"==typeof e?(n._field=null,e):(n._field=e,n._normalizationInfo=r,n._getValueFromField.bind(n)):n._field=null,n}return r(z,l),z.fromCBRenderer=function(e,t,r,i){for(var a=e.isMaxInclusive,n=e.visualVariables,l=e.valueExpression,o=e.normalizationField,u=e.normalizationTotal,s=e.normalizationType,f=b.getVVFlags(n),p=new z(e.field,a,{normalizationField:o,normalizationTotal:u,normalizationType:s},l,i),c=e.backgroundFillSymbol,d=0,h=e.classBreakInfos;d<h.length;d++){var m=h[d],g=m.symbol,v=r.createTemplateGroup(g,c,t,f),_={min:m.minValue,max:m.maxValue};p.add(_,v)}var y=e.defaultSymbol;if(y){var V=r.createTemplateGroup(y,c,t,f);p.setDefault(V)}return p},z.prototype.add=function(e,t){this._intervals.push({interval:e,result:t}),this._intervals.sort(function(e,t){return e.interval.min-t.interval.min})},z.prototype.size=function(){return l.prototype.size.call(this)+this._intervals.length},z.prototype.match=function(e,t,r){if(!this._getValue)return this.getDefault();var i=this._getValue(e,t,r);if(!i&&(null==i||isNaN(i)))return this.getDefault();for(var a=0;a<this._intervals.length;a++){var n=this._intervals[a],l=n.interval,o=n.result,u=i>=l.min,s=this._isMaxInclusive?i<=l.max:i<l.max;if(u&&s)return o}return this.getDefault()},z.prototype._needsNormalization=function(){var e=this._normalizationInfo;return e&&(e.normalizationField||e.normalizationTotal||e.normalizationType)},z.prototype._getValueFromField=function(e){var t=e.attributes[this._field];if(!this._needsNormalization())return t;var r=this._normalizationInfo,i=r.normalizationField,a=r.normalizationTotal,n=r.normalizationType,l=!!i&&e.attributes[i];if(n)switch(n){case"field":return l?t/l:void 0;case"log":return Math.log(t)*Math.LOG10E;case"percent-of-total":return t/a*100;default:return void u.error("Found unknown normalization type: "+n)}else u.error("Normalization is required, but no type was set!")},z}(t.default=a);t.IntervalMatcher=n;var l=function(n){function v(e,t,r,i){var a=n.call(this)||this;return a._resultsMap=new Map,r?a._getValue=o.createArcadeFunction(r,i):e&&e.length?"function"==typeof e[0]?(a._fields=null,a._getValue=e[0]):(a._fields=e,a._seperator=t||"",a._getValue=a._getValueFromFields.bind(a)):a._fields=null,a}return r(v,n),v.fromUVRenderer=function(e,t,r,i){var a=e.uniqueValueInfos,n=e.visualVariables,l=b.getVVFlags(n),o=e.fieldDelimiter,u=e.valueExpression,s=[e.field];e.field2&&s.push(e.field2),e.field3&&s.push(e.field3);for(var f=e.backgroundFillSymbol,p=new v(s,o,u,i),c=0,d=a;c<d.length;c++){var h=d[c],m=r.createTemplateGroup(h.symbol,f,t,l);p.add(h.value,m)}if(e.defaultSymbol){var g=r.createTemplateGroup(e.defaultSymbol,f,t,l);p.setDefault(g)}return p},v.prototype.add=function(e,t){this._resultsMap.set(e.toString(),t)},v.prototype.size=function(){return n.prototype.size.call(this)+this._resultsMap.size},v.prototype.match=function(e,t,r){if(!this._getValue)return this.getDefault();var i=this._getValue(e,t,r);if(!i&&null==i)return this.getDefault();var a=i.toString();return this._resultsMap.has(a)?this._resultsMap.get(a):this.getDefault()},v.prototype._getValueFromFields=function(e){for(var t=[],r=0,i=this._fields;r<i.length;r++){var a=i[r],n=e.attributes[a];t.push(n)}return t.join(this._seperator)},v}(a);t.MapMatcher=l});