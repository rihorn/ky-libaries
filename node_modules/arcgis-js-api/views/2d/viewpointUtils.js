// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.10/esri/copyright.txt for details.

define(["require","exports","../../Viewpoint","../../core/Error","../../core/promiseUtils","../../core/wgs84Constants","../../core/libs/gl-matrix-2/gl-matrix","../../geometry/Extent","../../geometry/Geometry","../../geometry/Point","../../geometry/SpatialReference","../../geometry/support/scaleUtils","../../geometry/support/spatialReferenceUtils","../../geometry/support/webMercatorUtils","../../geometry/support/webMercatorUtils"],function(e,t,r,n,a,c,o,i,u,s,f,l,v,m,g){function y(e,t,r){var n=o.common.toDegree(t[0]/I);return o.vec2.set(e,r?n:n-360*Math.floor((n+180)/360),o.common.toDegree(.5*Math.PI-2*Math.atan(Math.exp(-1*t[1]/I))))}function p(e,t){var r=t[1];return r>89.99999?r=89.99999:r<-89.99999&&(r=-89.99999),r=Math.sin(o.common.toRadian(r)),o.vec2.set(e,o.common.toRadian(t[0])*I,.5*I*Math.log((1+r)/(1-r)))}function d(e,t,r,n){return n&&r&&!n.equals(r)&&m.canProject(n,r)&&n.isWebMercator?n.isWebMercator?p(e,t):y(e,t):o.vec2.copy(e,t)}function x(e){return e.wkid?e:e.spatialReference||f.WGS84}function h(e,t){return t.type?o.vec2.set(e,t.x,t.y):o.vec2.copy(e,t)}function M(e){return l.getMetersPerUnitForSR(e)}function R(e,t){return Math.max(e.width/t[0],e.height/t[1])*O(e.spatialReference)}function b(e,t,r){var n;if(!e)return null;if(Array.isArray(e)&&2===e.length&&"number"==typeof e[0]&&"number"==typeof e[1])return new s(e);if(e.reduce)return e.reduce(function(e,r){return b(r,t,e)},r);if(e instanceof u?n=e:e.geometry&&(n=e.geometry),!n)return null;var a;if(!(a="point"===n.type?new i({xmin:n.x,ymin:n.y,xmax:n.x,ymax:n.y,spatialReference:n.spatialReference}):n.extent))return null;var c=m.canProject(a,t);if(!a.spatialReference.equals(t)&&c)a=m.project(a,t);else if(!c)return null;return r=r?r.union(a):a.clone()}function w(e,t){if(!e)return new r({targetGeometry:new s,scale:0,rotation:0});var n=t.spatialReference,a=t.size,c=t.viewpoint,u=t.constraints,f=null;"esri.Viewpoint"===e.declaredClass?f=e:e.viewpoint?f=e.viewpoint:e.target&&"esri.Viewpoint"===e.target.declaredClass&&(f=e.target);var l=null;f&&f.targetGeometry?l=f.targetGeometry:e instanceof i?l=e:(e||e&&(e.hasOwnProperty("center")||e.hasOwnProperty("extent")||e.hasOwnProperty("target")))&&(l=b(e.center,n)||b(e.extent,n)||b(e.target,n)||b(e,n)),!l&&c&&c.targetGeometry?l=c.targetGeometry:!l&&t.extent&&(l=t.extent);var v=x(l);if(n||(n=x(t.spatialReference||t.extent||l)),!g.canProject(l,n)&&v&&!v.equals(n))return null;var y=h(o.vec2f64.create(),l.center?l.center:l),p=new s(d(y,y,v,n),n),M=null;M=f&&f.targetGeometry&&"point"===f.targetGeometry.type?f.scale:e.hasOwnProperty("scale")&&e.scale?e.scale:e.hasOwnProperty("zoom")&&-1!==e.zoom&&u&&u.effectiveLODs?u.zoomToScale(e.zoom):Array.isArray(l)||"point"===l.type||"extent"===l.type&&0===l.width&&0===l.height?t.extent&&m.canProject(t.extent,n)?R(m.project(t.extent,n),a):t.extent?R(t.extent,a):c.scale:m.canProject(l.extent,n)?R(m.project(l.extent,n),a):R(l.extent,a);var w=0;f?w=f.rotation:e.hasOwnProperty("rotation")?w=e.rotation:c&&(w=c.rotation);var G=new r({targetGeometry:p,scale:M,rotation:w});return u&&(G=u.fit(G),u.rotationEnabled||(G.rotation=w)),G}function G(e,t){var r=e.targetGeometry,n=t.targetGeometry;return r.x=n.x,r.y=n.y,r.spatialReference=n.spatialReference,e.scale=t.scale,e.rotation=t.rotation,e}function P(e,t,r){return r?o.vec2.set(e,.5*(t[0]-r.right+r.left),.5*(t[1]-r.bottom+r.top)):o.vec2.scale(e,t,.5)}function S(e,r,n,a,c){return t.centerAt(e,r,n.center),e.scale=R(n,a),c&&c.constraints&&c.constraints.constrain(e),e}function A(e,r,n,a){return t.getTransform(e,r,n,a),o.mat2d.invert(e,e)}function T(e,t,r){var n=z(t),a=Math.abs(Math.cos(n)),c=Math.abs(Math.sin(n));return o.vec2.set(e,Math.round(r[1]*c+r[0]*a),Math.round(r[1]*a+r[0]*c))}function j(e){return e.scale*B(e.targetGeometry.spatialReference)}function B(e){return v.isValid(e)?1/(M(e)*D*96):1}function z(e){return o.common.toRadian(e.rotation)||0}function O(e){return v.isValid(e)?M(e)*D*96:1}function k(e,t){return o.vec2.scale(e,t,.5)}function W(e){if(e.isWrappable){var t=v.getInfo(e);return t.valid[1]-t.valid[0]}return 0}function N(e,t){return Math.round(W(e)/t)}function U(e,t){var r=w(e,t);if(r)return a.resolve(r);var c=new n("viewpointUtils-createAsync:different-spatialReference","Target spatialReference cannot be projected and is different from out spatialReference");return a.reject(c)}function E(e,t,r){return j(t)}function V(e,t,r){return G(e,t),e.rotation+=r,e}function q(e,t,r){return G(e,t),e.rotation=r,e}function C(e,t,r){return G(e,t),e.scale=r,e}Object.defineProperty(t,"__esModule",{value:!0});var D=39.37,I=c.wgs84Radius,F=180/Math.PI;t.extentToScale=R,t.create=w,t.copy=G,t.getAnchor=P,t.getExtent=function(){var e=o.vec2f64.create();return function(t,r,n){var a=r.targetGeometry;h(e,a);var c=.5*j(r);return t.xmin=e[0]-c*n[0],t.ymin=e[1]-c*n[1],t.xmax=e[0]+c*n[0],t.ymax=e[1]+c*n[1],t.spatialReference=a.spatialReference,t}}(),t.setExtent=S,t.getOuterExtent=function(){var e=o.vec2f64.create(),t=o.vec2f64.create();return function(r,n,a){h(e,n.targetGeometry),T(t,n,a);var c=.5*j(n),o=e[0]-c*t[0],i=e[1]-c*t[1],u=e[0]+c*t[0],s=e[1]+c*t[1],f=n.targetGeometry.spatialReference;return r.set({xmin:o,ymin:i,xmax:u,ymax:s,spatialReference:f}),r}}(),t.getOuterSize=T,t.getPaddingScreenTranslation=function(){var e=o.vec2f64.create();return function(t,r,n){return o.vec2.sub(t,k(t,r),P(e,r,n))}}();var _=function(){var e=o.mat2df64.create(),r=o.vec2f64.create();return function(n,a,c,i){var u=j(a),s=z(a);return o.vec2.set(r,u,u),o.mat2d.fromScaling(e,r),o.mat2d.rotate(e,e,s),o.mat2d.translate(e,e,t.getPaddingScreenTranslation(r,c,i)),o.mat2d.translate(e,e,[0,i.top-i.bottom]),o.vec2.set(n,e[4],e[5])}}();t.getResolution=j,t.getResolutionToScaleFactor=O,t.getMatrix=function(){var e=o.vec2f64.create(),t=o.vec2f64.create(),r=o.vec2f64.create();return function(n,a,c,i,u,s){return o.vec2.negate(e,a),o.vec2.scale(t,c,.5*s),o.vec2.set(r,1/i*s,-1/i*s),o.mat2d.identity(n),o.mat2d.translate(n,n,t),u&&o.mat2d.rotate(n,n,u),o.mat2d.scale(n,n,r),o.mat2d.translate(n,n,e),n}}(),t.getTransform=function(){var e=o.vec2f64.create();return function(r,n,a,c){var o=j(n),i=z(n);return h(e,n.targetGeometry),t.getMatrix(r,e,a,o,i,c)}}(),t.getTransformNoRotation=function(){var e=o.vec2f64.create();return function(r,n,a,c){var o=j(n);return h(e,n.targetGeometry),t.getMatrix(r,e,a,o,0,c)}}(),t.getWorldWidth=W,t.getWorldScreenWidth=N,t.createAsync=U,t.angleBetween=function(){var e=o.vec2f64.create(),t=o.vec2f64.create(),r=[0,0,0];return function(n,a,c){o.vec2.subtract(e,n,a),o.vec2.normalize(e,e),o.vec2.subtract(t,n,c),o.vec2.normalize(t,t),o.vec2.cross(r,e,t);var i=Math.acos(o.vec2.dot(e,t)/(o.vec2.length(e)*o.vec2.length(t)))*F;return r[2]<0&&(i=-i),isNaN(i)&&(i=0),i}}(),t.addPadding=function(){var e=o.vec2f64.create();return function(t,r,n,a){var c=t.targetGeometry;return G(t,r),_(e,r,n,a),c.x+=e[0],c.y+=e[1],t}}(),t.removePadding=function(){var e=o.vec2f64.create();return function(t,r,n,a){var c=t.targetGeometry;return G(t,r),_(e,r,n,a),c.x-=e[0],c.y-=e[1],t}}(),t.centerAt=function(){var e=o.vec2f64.create();return function(t,r,n){G(t,r);var a=t.targetGeometry,c=x(n),o=x(a);return h(e,n),d(e,e,c,o),a.x=e[0],a.y=e[1],t}}(),t.pixelSizeAt=E,t.resize=function(){var e=o.vec2f64.create();return function(r,n,a,c,i){i||(i="center"),o.vec2.sub(e,a,c),o.vec2.scale(e,e,.5);var u=e[0],s=e[1];switch(i){case"center":o.vec2.set(e,0,0);break;case"left":o.vec2.set(e,-u,0);break;case"top":o.vec2.set(e,0,s);break;case"right":o.vec2.set(e,u,0);break;case"bottom":o.vec2.set(e,0,-s);break;case"top-left":o.vec2.set(e,-u,s);break;case"bottom-left":o.vec2.set(e,-u,-s);break;case"top-right":o.vec2.set(e,u,s);break;case"bottom-right":o.vec2.set(e,u,-s)}return t.translateBy(r,n,e),r}}(),t.rotateBy=V,t.rotateTo=q,t.scaleBy=function(){var e=o.vec2f64.create();return function(r,n,a,c,i){return G(r,n),isNaN(a)||0===a||(t.toMap(e,c,n,i),r.scale=n.scale*a,t.toScreen(e,e,r,i),t.translateBy(r,r,o.vec2.set(e,e[0]-c[0],c[1]-e[1]))),r}}(),t.scaleTo=C,t.scaleAndRotateBy=function(){var e=o.vec2f64.create();return function(r,n,a,c,i,u){return G(r,n),isNaN(a)||0===a||(t.toMap(e,i,n,u),r.scale=n.scale*a,r.rotation+=c,t.toScreen(e,e,r,u),t.translateBy(r,r,o.vec2.set(e,e[0]-i[0],i[1]-e[1]))),r}}(),t.padAndScaleAndRotateBy=function(){var e=o.vec2f64.create(),r=o.vec2f64.create();return function(n,a,c,i,u,s,f){return t.getPaddingScreenTranslation(r,s,f),o.vec2.add(e,u,r),i?t.scaleAndRotateBy(n,a,c,i,e,s):t.scaleBy(n,a,c,e,s)}}(),t.toMap=function(){var e=o.mat2df64.create();return function(t,r,n,a){return o.vec2.transformMat2d(t,r,A(e,n,a,1))}}(),t.toScreen=function(){var e=o.mat2df64.create();return function(r,n,a,c){return o.vec2.transformMat2d(r,n,t.getTransform(e,a,c,1))}}(),t.translateBy=function(){var e=o.vec2f64.create(),t=o.mat2df64.create();return function(r,n,a){G(r,n);var c=j(n),i=r.targetGeometry;return o.mat2d.fromRotation(t,z(n)),o.mat2d.scale(t,t,o.vec2f64.fromValues(c,c)),o.vec2.transformMat2d(e,a,t),i.x+=e[0],i.y+=e[1],r}}()});