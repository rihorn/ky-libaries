// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.10/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/declareExtendsHelper","../../../../core/tsSupport/decorateHelper","../../../../core/Accessor","../../../../core/Evented","../../../../core/Handles","../../../../core/watchUtils","../../../../core/accessorSupport/decorators","./drawUtils","./input/GraphicMoverEvents"],function(i,e,t,r,n,a,o,c,h,p,l){return function(i){function e(e){var t=i.call(this,e)||this;return t._activeGraphic=null,t._dragEvent=null,t._handles=new o,t._hoverGraphic=null,t._initialDragGeometry=null,t._pointerDownEvent=null,t._viewHandles=new o,t.callbacks={onGraphicClick:function(i){},onGraphicDoubleClick:function(i){},onGraphicMoveStart:function(i){},onGraphicMove:function(i){},onGraphicMoveStop:function(i){},onGraphicPointerOver:function(i){},onGraphicPointerOut:function(i){},onGraphicPointerDown:function(i){},onGraphicPointerUp:function(i){}},t.enableMoveAllGraphics=!1,t.graphics=[],t.view=null,t}return t(e,i),e.prototype.initialize=function(){var i=this;this._handles.add([c.whenOnce(this,"view.ready",function(){i._viewHandles.add([i.view.on("click",function(e){return i._clickHandler(e)}),i.view.on("double-click",function(e){return i._doubleClickHandler(e)}),i.view.on("pointer-down",function(e){return i._pointerDownHandler(e)}),i.view.on("pointer-move",function(e){return i._pointerMoveHandler(e)}),i.view.on("pointer-up",function(e){return i._pointerUpHandler(e)}),i.view.on("drag",function(e){return i._dragHandler(e)}),i.view.on("key-down",function(e){return i._keyDownHandler(e)})])})])},e.prototype.destroy=function(){this.reset(),this._viewHandles.removeAll(),this._handles.removeAll()},Object.defineProperty(e.prototype,"state",{get:function(){var i=!!this.get("view.ready"),e=!!this.get("graphics.length"),t=this._activeGraphic;return i&&e?t?"moving":"active":i?"ready":"disabled"},enumerable:!0,configurable:!0}),e.prototype.reset=function(){this._activeGraphic=null,this._hoverGraphic=null,this._dragEvent=null},e.prototype.updateGeometry=function(i,e){var t=this.graphics[i];t&&t.set("geometry",e)},e.prototype._clickHandler=function(i){var e=this;this.view.hitTest(i).then(function(t){var r=t.results;if(r.length&&r[0].graphic){var n=r[0].graphic;if(e.graphics.indexOf(n)>-1){var a=new l.GraphicClickEvent(n,e.graphics.indexOf(n),i.x,i.y,i);e.emit("graphic-click",a),e.callbacks.onGraphicClick&&e.callbacks.onGraphicClick(a)}}})},e.prototype._doubleClickHandler=function(i){var e=this;this.view.hitTest(i).then(function(t){var r=t.results;if(r.length&&r[0].graphic){var n=r[0].graphic;if(e.graphics.indexOf(n)>-1){var a=new l.GraphicDoubleClickEvent(n,e.graphics.indexOf(n),i.x,i.y,i);e.emit("graphic-double-click",a),e.callbacks.onGraphicDoubleClick&&e.callbacks.onGraphicDoubleClick(a)}}})},e.prototype._pointerDownHandler=function(i){var e=this;this._pointerDownEvent=i,this.view.hitTest(i).then(function(t){var r=t.results;if(r.length&&r[0].graphic){var n=r[0].graphic;if(e.graphics.indexOf(n)>-1){e._activeGraphic=n;var a=i.x,o=i.y,c=new l.GraphicPointerDownEvent(n,e.graphics.indexOf(n),a,o,i);e.emit("graphic-pointer-down",c),e.callbacks.onGraphicPointerDown&&e.callbacks.onGraphicPointerDown(c)}else n!==e._activeGraphic&&(e._pointerDownEvent=null,e._activeGraphic=null)}else e._pointerDownEvent=null,e._activeGraphic=null})},e.prototype._pointerUpHandler=function(i){if(this._pointerDownEvent=null,this._activeGraphic){var e=i.x,t=i.y,r=this.graphics.indexOf(this._activeGraphic),n=new l.GraphicPointerUpEvent(this._activeGraphic,r,e,t,i);this._activeGraphic=null,this.emit("graphic-pointer-up",n),this.callbacks.onGraphicPointerUp&&this.callbacks.onGraphicPointerUp(n)}},e.prototype._pointerMoveHandler=function(i){var e=this;this._dragEvent||this.view.hitTest(i).then(function(t){var r=t.results;if(r.length&&r[0].graphic){var n=r[0].graphic;if(n===e._hoverGraphic)return;if(e.graphics.indexOf(n)>-1){var a=i.x,o=i.y;if(e._hoverGraphic){var c=e.graphics.indexOf(e._hoverGraphic),h=new l.GraphicPointerOutEvent(e.graphics[c],c,a,o,i);e._hoverGraphic=null,e.emit("graphic-pointer-out",h),e.callbacks.onGraphicPointerOut&&e.callbacks.onGraphicPointerOut(h)}var p=e.graphics.indexOf(n),s=new l.GraphicPointerOverEvent(n,p,a,o,i);return e._hoverGraphic=n,e.emit("graphic-pointer-over",s),void(e.callbacks.onGraphicPointerOver&&e.callbacks.onGraphicPointerOver(s))}}if(e._hoverGraphic){var a=i.x,o=i.y,c=e.graphics.indexOf(e._hoverGraphic),s=new l.GraphicPointerOutEvent(e.graphics[c],c,a,o,i);e._hoverGraphic=null,e.emit("graphic-pointer-out",s),e.callbacks.onGraphicPointerOut&&e.callbacks.onGraphicPointerOut(s)}})},e.prototype._dragHandler=function(i){var e=this;if(this._pointerDownEvent){if("start"!==i.action&&!this._dragEvent||!this._activeGraphic||!this._activeGraphic.geometry)return;i.stopPropagation();var t=i.x,r=i.y,n=this.graphics.indexOf(this._activeGraphic),a=this._activeGraphic.geometry,o=this._dragEvent?t-this._dragEvent.x:0,c=this._dragEvent?r-this._dragEvent.y:0,h=t-i.origin.x,s=r-i.origin.y;if(this._activeGraphic.geometry=p.move(a,o,c,this.view),this.enableMoveAllGraphics&&this.graphics.forEach(function(i){i!==e._activeGraphic&&(i.geometry=p.move(i.geometry.clone(),o,c,e.view))}),this._dragEvent=i,"start"===i.action){this._initialDragGeometry=a.clone();var v=new l.GraphicMoveStartEvent(this._activeGraphic,n,t,r,o,c,h,s,i);this.emit("graphic-move-start",v),this.callbacks.onGraphicMoveStart&&this.callbacks.onGraphicMoveStart(v),v.defaultPrevented&&this._activeGraphic.set("geometry",a)}else if("update"===i.action){var v=new l.GraphicMoveEvent(this._activeGraphic,n,t,r,o,c,h,s,i);this.emit("graphic-move",v),this.callbacks.onGraphicMove&&this.callbacks.onGraphicMove(v),v.defaultPrevented&&this._activeGraphic.set("geometry",a)}else{this._dragEvent=null;var v=new l.GraphicMoveStopEvent(this._activeGraphic,n,t,r,o,c,h,s,i);this.emit("graphic-move-stop",v),this.callbacks.onGraphicMoveStop&&this.callbacks.onGraphicMoveStop(v),v.defaultPrevented&&this.graphics[n].set("geometry",this._initialDragGeometry),this._initialDragGeometry=null}}},e.prototype._keyDownHandler=function(i){"a"!==i.key&&"d"!==i.key&&"n"!==i.key||"moving"!==this.state||i.stopPropagation()},r([h.property()],e.prototype,"_activeGraphic",void 0),r([h.property()],e.prototype,"callbacks",void 0),r([h.property()],e.prototype,"enableMoveAllGraphics",void 0),r([h.property()],e.prototype,"graphics",void 0),r([h.property({dependsOn:["view.ready","graphics.length","_activeGraphic"],readOnly:!0})],e.prototype,"state",null),r([h.property()],e.prototype,"view",void 0),e=r([h.subclass("esri.views.2d.draw.support.GraphicMover")],e)}(h.declared(n,a))});