// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.10/esri/copyright.txt for details.

define(["require","exports","../../core/tsSupport/declareExtendsHelper","../../core/tsSupport/decorateHelper","../../geometry","../../Viewpoint","../../core/JSONSupport","../../core/accessorSupport/decorators","./../../core/libs/gl-matrix-2/gl-matrix","../../core/libs/gl-matrix-2/types/vec2","./viewpointUtils"],function(t,e,i,r,o,a,n,s,p,c,l){var f=[0,0];return function(t){function e(){for(var e=[],i=0;i<arguments.length;i++)e[i]=arguments[i];var r=t.apply(this,e)||this;return r._viewpoint2D={center:p.vec2f64.create(),rotation:0,scale:0,spatialReference:null},r.center=[0,0],r.extent=new o.Extent,r.id=0,r.inverseTransform=p.mat2df64.create(),r.resolution=0,r.rotation=0,r.scale=0,r.transform=p.mat2df64.create(),r.transformNoRotation=p.mat2df64.create(),r.displayMat3=p.mat3f32.create(),r.displayViewMat3=p.mat3f32.create(),r.viewMat3=p.mat3f32.create(),r.viewMat2d=p.mat2df32.create(),r.worldScreenWidth=0,r.size=[0,0],r}i(e,t),n=e,Object.defineProperty(e.prototype,"pixelRatio",{set:function(t){this._set("pixelRatio",t),this._update()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"size",{set:function(t){this._set("size",t),this._update()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"viewpoint",{set:function(t){if(t){var e=this._viewpoint2D,i=t.targetGeometry;e.center[0]=i.x,e.center[1]=i.y,e.rotation=t.rotation,e.scale=t.scale,e.spatialReference=i.spatialReference}this._update()},enumerable:!0,configurable:!0}),e.prototype.copy=function(t){var e=this.size,i=this.viewpoint;return i&&e?(this.viewpoint=l.copy(i,t.viewpoint),this._set("size",p.vec2.copy(e,t.size))):(this.viewpoint=t.viewpoint.clone(),this._set("size",[t.size[0],t.size[1]])),this._set("pixelRatio",t.pixelRatio),this},e.prototype.clone=function(){return new n({size:this.size,viewpoint:this.viewpoint.clone(),pixelRatio:this.pixelRatio})},e.prototype.toMap=function(t,e,i){return c.isVec2(e)?p.vec2.transformMat2d(t,e,this.inverseTransform):(f[0]=e,f[1]=i,p.vec2.transformMat2d(t,f,this.inverseTransform))},e.prototype.toScreen=function(t,e,i){return c.isVec2(e)?p.vec2.transformMat2d(t,e,this.transform):(f[0]=e,f[1]=i,p.vec2.transformMat2d(t,f,this.transform))},e.prototype.toScreenNoRotation=function(t,e,i){return c.isVec2(e)?p.vec2.transformMat2d(t,e,this.transformNoRotation):(f[0]=e,f[1]=i,p.vec2.transformMat2d(t,f,this.transformNoRotation))},e.prototype.pixelSizeAt=function(t){var e=this.viewpoint;return l.pixelSizeAt(t,e,this.size)},e.prototype.getScreenTransform=function(t,e){var i=this._viewpoint2D.center,r=this._get("pixelRatio")||1,o=this._get("size");return l.getMatrix(t,i,o,e,0,r),t},e.prototype._update=function(){var t=this._viewpoint2D,e=t.center,i=t.spatialReference,r=t.scale,n=t.rotation,s=this._get("pixelRatio")||1,c=this._get("size");this._set("id",this.id+1);var f=new a({targetGeometry:new o.Point(e[0],e[1],i),scale:r,rotation:n});if(this._set("viewpoint",f),c&&i&&r){this.resolution=l.getResolution(f),this.rotation=n,this.scale=r,this.spatialReference=i,p.vec2.copy(this.center,e);var h=2/c[0],m=-2/c[1];p.mat3.set(this.displayMat3,h,0,0,0,m,0,-1,1,1);var u=p.mat3.identity(this.viewMat3),v=p.vec2f32.fromValues(c[0]/2,c[1]/2),d=p.vec2f32.fromValues(-c[0]/2,-c[1]/2),y=p.common.toRadian(n);p.mat3.translate(u,u,v),p.mat3.rotate(u,u,y),p.mat3.translate(u,u,d),p.mat3.multiply(this.displayViewMat3,this.displayMat3,u);var w=p.mat2d.identity(this.viewMat2d);return p.mat2d.translate(w,w,v),p.mat2d.rotate(w,w,y),p.mat2d.translate(w,w,d),l.getExtent(this.extent,f,c),l.getTransform(this.transform,f,c,s),p.mat2d.invert(this.inverseTransform,this.transform),l.getTransformNoRotation(this.transformNoRotation,f,c,s),this.worldScreenWidth=l.getWorldScreenWidth(this.spatialReference,this.resolution),this}};var n;return r([s.property({readOnly:!0})],e.prototype,"id",void 0),r([s.property({value:1,json:{write:!0}})],e.prototype,"pixelRatio",null),r([s.property({json:{write:!0}})],e.prototype,"size",null),r([s.property({type:a,json:{write:!0}})],e.prototype,"viewpoint",null),e=n=r([s.subclass("esri.views.2d.ViewState")],e)}(s.declared(n))});