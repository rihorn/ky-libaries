// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.10/esri/copyright.txt for details.

define(["require","exports","../../../../core/promiseUtils","../../../../core/screenUtils","../../../../core/libs/gl-matrix-2/gl-matrix","../../../../geometry/Polygon","../../../../geometry/Polyline","../../../../geometry/SpatialReference","../../../../geometry/support/boundsUtils","../../../../geometry/support/jsonUtils","../../../../geometry/support/normalizeUtils","../../../../geometry/support/spatialReferenceUtils","../../../../geometry/support/spatialReferenceUtils","../../engine/webgl/definitions","../../engine/webgl/fontUtils","../../engine/webgl/GeometryUtils","../../engine/webgl/TextShapingNew","../../engine/webgl/TileClipper","../../engine/webgl/util/BidiText"],function(e,t,r,n,i,a,s,o,c,l,f,p,u,v,m,g,h,x,y){function b(e){if(l.isPolygon(e))for(var t=0,r=e.rings;t<r.length;t++){var n=r[t];n.length<3||(n[0][0]===n[n.length-1][0]&&n[0][1]===n[n.length-1][1]||n.push(n[0]))}}function M(e,t,r,n,i,a,s,o,f){if(!n)return e[0]=e[1]=e[2]=e[3]=0,t[0]=t[1]=t[2]=t[3]=0,e;var p=r.symbol;if(!p&&a&&(p=a.getSymbol(r,{scale:o})),!p)return e;var u=n;if(!l.isPoint(u)){c.getBoundsXY(e,u);var v=t[0];0===v&&(v=R(p,i),t[0]=v);var m=s*v,g=m/2;return e[0]-=g,e[1]-=g,e[2]+=g,e[3]+=g,e}var h=u.x,x=u.y;switch(p.type){case"simple-marker":case"picture-marker":C(e,h,x,p,s,f);break;case"text":0===t[2]&&0===t[3]&&E(t,p,i),G(e,h,x,p,t,s,f)}return e}function d(e){return"simple-marker"===e||"picture-marker"===e||"text"===e}function w(e){switch(e.geometry.type){case"point":case"multipoint":return 0;case"polyline":return 1;case"polygon":case"extent":return 2}return 0}function _(e){switch(e){case"left":return 1;case"right":return-1;case"center":case"justify":return 0}}function T(e){switch(e){case"top":return-1;case"middle":return 0;case"baseline":case"bottom":return 1}}function k(e){switch(e){case"left":return 0;case"right":return 1;case"center":case"justify":return.5}}function A(e,t,r,n){i.vec2.set(O,t,r);for(var a,s,o,c,l,f,p,u,v,m=e.paths,g=1/0,h=0;h<m.length;h++){var x=m[h];if(!(x.length<2))for(var y=1;y<x.length;y++)a=x[y-1][0],o=x[y-1][1],s=x[y][0],c=x[y][1],l=Math.min(a,s)-n,f=Math.min(o,c)-n,p=Math.max(a,s)+n,u=Math.max(o,c)+n,t<l||t>p||r<f||r>u||(i.vec2.set(S,a,o),i.vec2.set(N,s,c),i.vec2.subtract(B,N,S),i.vec2.subtract(W,S,O),i.vec2.scale(H,B,i.vec2.dot(B,W)/i.vec2.dot(B,B)),i.vec2.subtract(j,W,H),v=i.vec2.dot(j,j),g>v&&(g=v))}return Math.sqrt(g)<=n}function X(e,t,r,i,a,s){var o,c,l=a*n.pt2px(i.xoffset),f=a*n.pt2px(i.yoffset),p=g.C_DEG_TO_RAD*i.angle;switch(i.type){case"simple-marker":var u=i;o=c=.5*a*n.pt2px(u.size);break;case"picture-marker":var v=i;o=.5*a*n.pt2px(v.width),c=.5*a*n.pt2px(v.height)}var m=g.C_DEG_TO_RAD*s,h=Math.cos(m),x=Math.sin(m);if(t+=l*h-f*x,r+=l*x+f*h,0!==p){var y=Math.cos(p),b=Math.sin(p),M=o*y+c*b,d=o*b+c*y;o=M,c=d}return e[0]=t-o,e[1]=r-c,e[2]=t+o,e[3]=r+c,e}function z(e,t,r,i,a,s,o){var c=T(i.verticalAlignment||"baseline"),l="baseline"===(i.verticalAlignment||"baseline"),f=s*n.pt2px(i.xoffset),p=s*n.pt2px(i.yoffset),u=n.pt2px(i.font.size)/24,v=4*u,m=l?25*u:a[1]+(1-c)*a[3]*.5,h=g.C_DEG_TO_RAD*o,x=Math.cos(h),y=Math.sin(h),b=f*x-p*y,M=f*y+p*x,d=s*a[0],w=s*(m+v),_=t+b+d,k=r+M+w;return e[0]=_,e[1]=k-s*a[3],e[2]=_+s*a[2],e[3]=k,e}function D(e){var t,n,i,s,o,c,l,f,u=null;if(!e)return r.resolve(null);t=e.spatialReference,n=p.getInfo(t),i=t.isWebMercator,c=i?102100:4326,s=Y[c].maxX,o=Y[c].minX,l=Y[c].plus180Line,f=Y[c].minus180Line;var v;if(!n)return r.resolve(e);if("mesh"===e.type)v=e;else if("point"===e.type)v=L(e.clone(),s,o);else if("multipoint"===e.type){var m=e.clone();m.points=m.points.map(function(e){return L(e,s,o)}),v=m}else if("extent"===e.type){var g=e.clone(),h=g._normalize(!1,!1,n);v=h.rings?new a(h):h}else if(e.extent){var g=e.extent,y=P(g.xmin,o),b=y*(2*s),M=0===b?e.clone():U(e.clone(),b);g.offset(b,0),g.intersects(l)&&g.xmax!==s?u=M:g.intersects(f)&&g.xmin!==o?u=M:v=M}else v=e.clone();if(null!==u){var d=new x.CutVertical,w=d.cut(u,s);return r.resolve(w)}return r.resolve(v)}function R(e,t){var r=0;switch(e.type){case"simple-fill":case"picture-fill":var n=e.outline;if(!n)return 0;r=n.width;break;case"simple-line":r=e.width;break;case"simple-marker":r=e.size;break;case"picture-marker":r=Math.max(e.width,e.height);break;case"text":var i=[0,0,0,0];E(i,e,t),r=Math.max(i[0],i[1])}return r}function E(e,t,r){if(!r)return e;var i=y.bidiText(t.text),a=i[0],s=i[1],o=k(t.horizontalAlignment||"center"),c=_(t.horizontalAlignment||"center"),l=r.glyphMosaicItems,f=new h([l],v.TEXT_MAX_WIDTH,v.TEXT_LINE_HEIGHT,v.TEXT_SPACING,[0,.5*-v.TEXT_LINE_HEIGHT],.5*(1-c),0,o),p=f.getShaping(a,s),u=m.getFontDecorationTop(t.font);isNaN(u)||h.addDecoration(p,u);var g=h.getBox(p),x=n.pt2px(t.font.size),b=x/q;return e[0]=b*g.x,e[1]=b*g.y,e[2]=b*g.width,e[3]=b*g.height,e}function C(e,t,r,i,a,s){var o,c,l=n.pt2px(i.xoffset),p=n.pt2px(i.yoffset),v=g.C_DEG_TO_RAD*i.angle;switch(i.type){case"simple-marker":var m=i;o=c=n.pt2px(m.size);break;case"picture-marker":var h=i;o=n.pt2px(h.width),c=n.pt2px(h.height)}var x=.5*o,y=.5*c;if(0!==v){var b=Math.cos(v),M=Math.sin(v),d=x*b+y*M,w=x*M+y*b;x=d,y=w}var _=a*(l+x),T=a*(p+y),k=Math.sqrt(_*_+T*T),A=f.normalizeMapX(t-k,s),X=f.normalizeMapX(t+k,s);if(A>X){var z=u.getInfo(s);if(z){var D=z.valid,R=D[0],E=D[1];A=R,X=E}}return e[0]=A,e[1]=r-k,e[2]=X,e[3]=r+k,e}function G(e,t,r,i,a,s,o){var c=_(i.horizontalAlignment||"center"),l=T(i.verticalAlignment||"middle"),p=s*n.pt2px(i.xoffset),v=s*n.pt2px(i.yoffset),m=g.C_DEG_TO_RAD*i.angle,h=s*a[2],x=s*a[3];if(0!==m){var y=Math.cos(m),b=Math.sin(m),M=h*y+x*b,d=h*b+x*y;h=M,x=d}var w=c*h,k=l*x,A=p+w+h,X=v+k+x,z=Math.sqrt(A*A+X*X),D=f.normalizeMapX(t-z,o),R=f.normalizeMapX(t+z,o);if(D>R){var E=u.getInfo(o);if(E){var C=E.valid,G=C[0],I=C[1];D=G,R=I}}return e[0]=D,e[1]=r-z,e[2]=R,e[3]=r+z,e}function I(e){return l.isPolygon(e)?e.rings:e.paths}function P(e,t){return Math.ceil((e-t)/(2*t))}function U(e,t){for(var r=I(e),n=0,i=r;n<i.length;n++)for(var a=i[n],s=0,o=a;s<o.length;s++){var c=o[s];c[0]+=t}return e}function L(e,t,r){if(Array.isArray(e)){var n=e[0];if(n>t){var i=P(n,t);e[0]=n+i*(-2*t)}else if(n<r){var i=P(n,r);e[0]=n+i*(-2*r)}}else{var n=e.x;if(n>t){var i=P(n,t);e=e.clone().offset(i*(-2*t),0)}else if(n<r){var i=P(n,r);e=e.clone().offset(i*(-2*r),0)}}return e}Object.defineProperty(t,"__esModule",{value:!0}),t.ensureClosedRings=b,t.getBounds=M,t.isMarkerSymbol=d,t.graphicGeometryToNumber=w,t.getXAnchorDirection=_,t.getYAnchorDirection=T,t.getJustification=k;var S=i.vec2f32.create(),N=i.vec2f32.create(),O=i.vec2f32.create(),B=i.vec2f32.create(),W=i.vec2f32.create(),H=i.vec2f32.create(),j=i.vec2f32.create();t.isPointOnPolyline=A,t.getMarkerSymbolBounds=X,t.getTextSymbolBounds=z,t.normalizeCentralMeridian=D;var q=24,Y={102100:{maxX:20037508.342788905,minX:-20037508.342788905,plus180Line:new s({paths:[[[20037508.342788905,-20037508.342788905],[20037508.342788905,20037508.342788905]]],spatialReference:o.WebMercator}),minus180Line:new s({paths:[[[-20037508.342788905,-20037508.342788905],[-20037508.342788905,20037508.342788905]]],spatialReference:o.WebMercator})},4326:{maxX:180,minX:-180,plus180Line:new s({paths:[[[180,-180],[180,180]]],spatialReference:o.WebMercator}),minus180Line:new s({paths:[[[-180,-180],[-180,180]]],spatialReference:o.WebMercator})}}});