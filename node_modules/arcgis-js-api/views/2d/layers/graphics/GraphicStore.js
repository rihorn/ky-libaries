// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.10/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/assignHelper","@dojo/framework/shim/Map","../../../../core/has","../../../../core/screenUtils","../../../../core/libs/rbush/rbush","../../../../geometry/support/aaBoundingRect","../../../../geometry/support/contains","../../../../geometry/support/jsonUtils","../../../../geometry/support/normalizeUtils","../../engine/webgl/util/iterator","./GraphicStoreItem","./graphicsUtils","../../../vectorTiles/GeometryUtils"],function(e,t,i,r,o,n,s,a,u,h,c,l,p,d,m){function y(e,t,i,r,o){return _.minX=t,_.minY=i,_.maxX=r,_.maxY=o,e.search(_)}Object.defineProperty(t,"__esModule",{value:!0});var _={minX:0,minY:0,maxX:0,maxY:0},g=a.create(),f=a.create(),v=function(){function e(e,t,i,n,a){this.renderer=n,this._graphics=a,this._index=s(9,o("csp-restrictions")?function(e){return{minX:e[0],minY:e[1],maxX:e[2],maxY:e[3]}}:[".bounds[0]",".bounds[1]",".bounds[2]",".bounds[3]"]),this._itemByGraphic=new r.default,this._currentLevel=-1/0,this._tileInfoView=e,this._uidFieldName=i;var u=e.getClosestInfoForScale(t);u&&(this._currentLevel=u.level,this._resolution=this._tileInfoView.getTileResolution(u.level)),this._updateGraphicZorder=this._updateGraphicZorder.bind(this)}return e.prototype.hitTest=function(e,t,i,r,o){e=c.normalizeMapX(e,this._tileInfoView.spatialReference);var s=.5*r*i;f[0]=e-s,f[1]=t-s,f[2]=e+s,f[3]=t+s;var l=.5*r*(i+50),p=y(this._index,e-l,t-l,e+l,t+l);if(!p||0===p.length)return[];for(var _,v=a.create(),b=o?function(i,r,n){var u=m.C_DEG_TO_RAD*o,h=Math.cos(u),c=Math.sin(u),l=((1+r)*i[0]+(1-r)*i[2])/2,p=((1+n)*i[1]+(1-n)*i[3])/2,d=e-l,y=t-p,_=l+h*d+c*y,g=p-c*d+h*y;return v[0]=_-s,v[1]=g-s,v[2]=_+s,v[3]=g+s,a.intersects(i,v)}:function(e){return a.intersects(e,f)},G=[],x=0,B=p;x<B.length;x++){var z=B[x];switch(h.getJsonType(z.geometry)){case"esriGeometryPoint":var w=this._getSymbol(z.graphic);if(!w)continue;var T=z.geometry,S=void 0,A=void 0;if("text"===w.type){var I=w;S=d.getXAnchorDirection(I.horizontalAlignment||"center"),A=d.getYAnchorDirection(I.verticalAlignment||"middle"),d.getTextSymbolBounds(g,T.x,T.y,I,z.size,this._resolution,o)}else S=0,A=0,d.getMarkerSymbolBounds(g,T.x,T.y,w,this._resolution,o);b(g,S,A)&&G.push(z);break;case"esriGeometryPolyline":var P=this._getSymbol(z.graphic);if(!P)continue;_=1.5*r*window.devicePixelRatio*n.pt2px(P.width),d.isPointOnPolyline(z.geometry,e,t,_)&&G.push(z);break;case"esriGeometryEnvelope":var R=z.geometry,V=a.fromValues(R.xmin,R.ymin,R.xmax,R.ymax);a.intersects(V,f)&&G.push(z);break;case"esriGeometryPolygon":u.polygonContainsPoint(z.geometry,{x:e,y:t})&&G.push(z);break;case"esriGeometryMultipoint":var X=this._getSymbol(z.graphic);if(!X)continue;for(var k=z.geometry.points,D=void 0,M=void 0,Y=0;Y<k.length;Y++){if("text"===X.type){var I=X;D=d.getXAnchorDirection(I.horizontalAlignment||"center"),M=d.getYAnchorDirection(I.verticalAlignment||"middle"),d.getTextSymbolBounds(g,k[Y][0],k[Y][1],I,z.size,this._resolution,o)}else D=0,M=0,d.getMarkerSymbolBounds(g,k[Y][0],k[Y][1],X,this._resolution,o);if(b(g,D,M)){G.push(z);break}}}}return G.sort(function(e,t){var i=d.graphicGeometryToNumber(e.graphic),r=d.graphicGeometryToNumber(t.graphic);return i===r?t.zorder-e.zorder:i-r}),G.map(function(e){return e.graphic})},e.prototype.getGraphicData=function(e,t){var r=this._itemByGraphic.get(t);if(!r)return null;var o=y(this._index,e.bounds[0],e.bounds[1],e.bounds[2],e.bounds[3]);o.sort(function(e,t){return e.zorder-t.zorder});var n=o.indexOf(r),s=0===n||-1===n?-1:o[n-1].graphic.uid,a={originPosition:"upperLeft",scale:[e.resolution,e.resolution],translate:[e.bounds[0],e.bounds[3]]},u=r.getGeometryQuantized(a),h=i({},r.graphic.attributes);return h[this._uidFieldName]=t.uid,{centroid:p.default.getCentroidQuantized(r,a,this.renderer,this._scale),geometry:u,attributes:h,symbol:t.symbol,insertAfter:s}},e.prototype.queryTileData=function(e){var t=50*e.resolution,i=a.pad(e.bounds,t,a.create()),r=y(this._index,i[0],i[1],i[2],i[3]),o=[];return this._createTileGraphics(o,r,{originPosition:"upperLeft",scale:[e.resolution,e.resolution],translate:[e.bounds[0],e.bounds[3]]}),o},e.prototype.has=function(e){return this._itemByGraphic.has(e)},e.prototype.getBounds=function(e){return this._itemByGraphic.has(e)?this._itemByGraphic.get(e).bounds:null},e.prototype.add=function(e,t,i){if(e){var r=p.default.acquire(e,i,t,this.renderer,this._resolution,this._scale,this._tileInfoView.spatialReference);return this._itemByGraphic.set(e,r),this._itemByGraphic.forEach(this._updateGraphicZorder),i&&this._index.insert(r),r.bounds}},e.prototype.remove=function(e){if(this._itemByGraphic.has(e)){var t=this._itemByGraphic.get(e);this._index.remove(t),this._itemByGraphic.delete(e),this._itemByGraphic.forEach(this._updateGraphicZorder)}},e.prototype.reorder=function(e){this._itemByGraphic.has(e)&&this._itemByGraphic.forEach(this._updateGraphicZorder)},e.prototype.update=function(e,t,i){var r=this._itemByGraphic.get(e),o=a.clone(r.bounds);return r.size[0]=r.size[1]=0,this._index.remove(r),r.set(e,i,t,this.renderer,this._resolution,this._scale,this._tileInfoView.spatialReference),i&&this._index.insert(r),{oldBounds:o,newBounds:r.bounds}},e.prototype.updateLevel=function(e){var t=this;if(this._currentLevel!==e){this._currentLevel=e;var i=this._tileInfoView.getTileResolution(e);this._resolution=i,this._scale=this._tileInfoView.getTileScale({level:e,row:0,col:0,world:0});var r=this._itemByGraphic.values();l.forEachIter(r,function(e){t._index.remove(e),e.updateBounds(t.renderer,t._resolution,t._scale,t._tileInfoView.spatialReference),e.geometry&&t._index.insert(e)})}},e.prototype.clear=function(){this._itemByGraphic.clear(),this._index.clear()},e.prototype._createTileGraphics=function(e,t,r){var o=this._uidFieldName;t.sort(function(e,t){return e.zorder-t.zorder});for(var n,s,a,u,h=0;h<t.length;h++){a=t[h],n=a.graphic,s=a.getGeometryQuantized(r),u=0===h?-1:t[h-1].graphic.uid;var c=i({},a.graphic.attributes);c[o]=n.uid,e.push({centroid:p.default.getCentroidQuantized(a,r,this.renderer,this._scale),geometry:s,attributes:c,symbol:n.symbol,insertAfter:u})}},e.prototype._getSymbol=function(e){return e.symbol?e.symbol:this.renderer?this.renderer.getSymbol(e,{scale:this._scale}):null},e.prototype._updateGraphicZorder=function(e,t){e.zorder=this._graphics.indexOf(t)},e}();t.default=v});