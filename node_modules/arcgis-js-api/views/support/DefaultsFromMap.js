// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.10/esri/copyright.txt for details.

define(["require","exports","../../core/tsSupport/declareExtendsHelper","../../core/tsSupport/decorateHelper","../../core/Accessor","../../core/arrayUtils","../../core/Handles","../../core/Logger","../../core/watchUtils","../../core/accessorSupport/decorators","../../geometry/support/heightModelInfoUtils","../../geometry/support/webMercatorUtils","../../portal/support/geometryServiceUtils"],function(e,t,i,o,n,r,a,s,l,d,p,c,u){function h(e){return e?JSON.stringify(e.toJSON()):"undefined"}function f(e){switch(e){case 0:return"Waiting";case 1:return"Found";case 2:return"Exhausted"}return"Unknown: "+e}var g=s.getLogger("esri.views.support.DefaultsFromMap");return function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._handles=new a,t._waitTask=null,t._isStarted=!1,t._spatialReferenceCandidates=null,t._extentCandidates=null,t.logDebugInformation=!1,t.isSpatialReferenceDone=!1,t.isTileInfoDone=!1,t.isHeightModelInfoSearching=!1,t.spatialReference=null,t.extent=null,t.heightModelInfo=null,t.vcsWkid=null,t.latestVcsWkid=null,t.mapCollectionPaths=n.DefaultMapCollectionPaths.slice(),t.tileInfo=null,t}i(t,e),n=t,t.prototype.initialize=function(){var e=this;this.watch("mapCollectionPaths",function(){e._isStarted&&(e.reset(),e.start())})},t.prototype.destroy=function(){this._set("view",null),this._handles&&(this._handles.destroy(),this._handles=null,this._isStarted=!1),this._cancelLoading()},t.prototype.reset=function(){this._handles.removeAll(),this._isStarted=!1,this._set("isSpatialReferenceDone",!1),this._set("isTileInfoDone",!1),this._set("isHeightModelInfoSearching",!1),this._set("spatialReference",null),this._set("extent",null),this._set("heightModelInfo",null),this._set("vcsWkid",null),this._set("latestVcsWkid",null),this._set("tileInfo",null),this._spatialReferenceCandidates=null,this._extentCandidates=null},t.prototype.start=function(){this._handles.removeAll(),this._isStarted=!0;for(var e=this._updateLayerChange.bind(this),t=0,i=this.mapCollectionPaths;t<i.length;t++){var o=i[t];this._handles.add(l.on(this.view,"map."+o,"change",e,e,e,!0))}},t.prototype._ownerNameFromCollectionName=function(e){var t=e.lastIndexOf(".");return-1===t?"view":"view."+e.slice(0,t)},t.prototype._ensureLoadedOwnersFromCollectionName=function(e){for(var t,i=this._ownerNameFromCollectionName(e),o=i.split("."),n=0;n<o.length&&(t=this.get(o.slice(0,n+1).join(".")));n++)if(t.load&&!t.isFulfilled())return{collectionName:e,owner:null,loading:t.load()};return{collectionName:e,owner:t}},t.prototype._cancelLoading=function(){this._waitTask=null,this._extentProjectTask&&(this._extentProjectTask.cancel(),this._extentProjectTask=null)},t.prototype._updateWhen=function(e){var t=this,i=!0,o=!1,n=e.catch(function(e){}).then(function(){i?o=!0:n===t._waitTask&&t._update()});return i=!1,o||(this._waitTask=n),o},t.prototype._updateLayerChange=function(){this.isSpatialReferenceDone&&!this.spatialReference&&this._set("isSpatialReferenceDone",!1),this._update()},t.prototype._update=function(){var e=this;if(this._cancelLoading(),this.view){if(!this.isSpatialReferenceDone){this._debugLog("Starting search for spatial reference...");var t=this._processMapCollections(function(t){return e._processSpatialReferenceSource(t)});if(this._debugLog("Search ended with status '"+f(t)+"'"),0!==t){var i=null,o=this._spatialReferenceCandidates;if(!o||o.length<1?(i=this.defaultSpatialReference,this._debugLog("No spatial reference found, locking to default ("+h(i)+")")):(this.defaultSpatialReference&&o.length>1&&r.findIndex(o,function(t){return t.equals(e.defaultSpatialReference)})>-1&&(o=[this.defaultSpatialReference]),i=o[0],this._debugLog("Locking to "+h(i))),this._set("spatialReference",i),this._set("isSpatialReferenceDone",!0),i){var n=this.logDebugInformation;this.logDebugInformation=!1,this._processMapCollections(function(t){return e._findExtent(t,i)}),this.extent||this._projectExtentCandidate(),this.logDebugInformation=n}}}if(null==this.heightModelInfo&&this.view.isHeightModelInfoRequired){this._debugLog("Starting search for height model info...");var a=this._processMapCollections(function(t){return e._processHeightModelInfoSource(t)},function(e){return p.mayHaveHeightModelInfo(e)});this._debugLog("Search ended with status "+f(a)),this._set("isHeightModelInfoSearching",0===a)}if(null==this.tileInfo){var s=!1;this.view.isTileInfoRequired()&&(s=this._deriveTileInfo()),s||this._set("isTileInfoDone",!0)}}},t.prototype._processMapCollections=function(e,t){var i=this;this._preloadMapCollections(t);var o=2;return this._forAllMapCollectionSources(function(e){if(2!==o)return!1;var t=e.collectionName;return i._debugLog("Processing collection "+t+"..."),e.loading&&!i._updateWhen(e.loading)?(i._debugLog("Collection "+e.collectionName+" owner is loading -> wait"),o=0,!1):void 0},function(n){return 2===o&&(null==t||t(n)?!n.load||n.isFulfilled()||i._updateWhen(n.load())?n.load&&!n.isResolved()||!e(n)?void 0:(o=1,!1):(i._debugLog("Source "+n.id+" is loading -> wait"),o=0,!1):(i._debugLog("Source "+n.id+" is skipped due to predicate"),!1))}),o},t.prototype._preloadMapCollections=function(e){var t=this,i=10,o=this.logDebugInformation;this.logDebugInformation=!1,this._forAllMapCollectionSources(function(e){return!0},function(n){return 0!==i&&(!(null!=e&&!e(n))&&void(n.load&&!n.isFulfilled()&&(t.logDebugInformation=o,t._debugLog("Pre-loading source "+n.id),t.logDebugInformation=!1,n.load(),i--)))}),this.logDebugInformation=o},t.prototype._forAllMapCollectionSources=function(e,t){for(var i=0,o=this.mapCollectionPaths;i<o.length;i++){var n=o[i],r="map."+n,a=this._ensureLoadedOwnersFromCollectionName(r);if(!1!==e(a)){var s=a.owner;if(!s||s.isRejected&&s.isRejected())this._debugLog("Collection "+r+" owner is invalid or rejected -> skip");else{var l=this.view.get(r);l?this._forEachSource(l,t):this._debugLog("Collection "+r+" does not exist -> skip")}}}},t.prototype._forEachSource=function(e,t){for(var i=0,o=e.items;i<o.length;i++){var n=o[i];if(!1!==t(n)){var r=n;r.layers&&this._forEachSource(r.layers,t)}}},t.prototype._processSpatialReferenceSource=function(e){var t=this._getSupportedSpatialReferences(e);return 0!==t.length&&(this._spatialReferenceCandidates?(t=r.intersect(t,this._spatialReferenceCandidates,function(e,t){return e.equals(t)}),t.length>0?this._spatialReferenceCandidates=t:this._debugLog("Layer "+e.id+" is ignored because its supported spatial\n          references are not compatible with the previous candidates")):this._spatialReferenceCandidates=t,1===this._spatialReferenceCandidates.length)},t.prototype._findExtent=function(e,t){var i=e.fullExtents||(e.fullExtent?[e.fullExtent]:[]),o=r.find(i,function(e){return e.spatialReference.equals(t)});if(o)return this._set("extent",o),!0;if(this._getSupportedSpatialReferences(e).length>0){var n=i.map(function(t){return{extent:t,layer:e}}),a=this._extentCandidates||[];this._extentCandidates=a.concat(n)}return!1},t.prototype._projectExtentCandidate=function(){var e=this;if(this._extentCandidates&&this._extentCandidates.length){var t=this.spatialReference,i=r.find(this._extentCandidates,function(e){return c.canProject(e.extent.spatialReference,t)});if(i)this._set("extent",c.project(i.extent,t));else{var o=this._extentCandidates[0];this._extentProjectTask=u.projectGeometry(o.extent,t,o.layer.portalItem).then(function(t){e._set("extent",t)})}}},t.prototype._getSupportedSpatialReferences=function(e){var t=this,i=e.supportedSpatialReferences||(e.spatialReference?[e.spatialReference]:[]);if(0===i.length)return this._debugLog("Layer "+e.id+" is ignored because it does not have any spatial references"),[];var o=i.filter(function(i){return t.view.isSpatialReferenceSupported(i,e,function(e){return t._debugLog(e)})});return 0===o.length?this._debugLog("Layer "+e.id+" has spatial references but none of them are supported (or layer doesn't require locking)"):this._debugLog("Layer "+e.id+" has spatial references. Resulting candidate set: "+o.map(h).join(", ")),o},t.prototype._processHeightModelInfoSource=function(e){var t=p.deriveHeightModelInfoFromLayer(e);return!!t&&(this._set("heightModelInfo",t),this._set("isHeightModelInfoSearching",!1),e.spatialReference&&(this._set("vcsWkid",e.spatialReference.vcsWkid),this._set("latestVcsWkid",e.spatialReference.latestVcsWkid)),!0)},t.prototype._deriveTileInfo=function(){if(!this.isSpatialReferenceDone)return!0;var e=this.get("view.map");if(!e)return!0;var t=e.basemap,i=t&&t.get("baseLayers.0"),o=e.get("layers.0"),n=!1,r=null;return t&&"failed"!==t.loadStatus?t.loaded?i&&"failed"!==i.loadStatus?i.loaded?r=i.tileInfo:(this._updateWhen(i.load()),n=!0):o&&"failed"!==o.loadStatus?o.loaded?r=o.tileInfo:(this._updateWhen(o.load()),n=!0):n=!0:(this._updateWhen(t.load()),n=!0):o&&"failed"!==o.loadStatus&&(o.loaded?r=o.tileInfo:(this._updateWhen(o.load()),n=!0)),r&&!r.spatialReference.equals(this.spatialReference)&&(r=null),n||this._set("tileInfo",r),n},t.prototype._debugLog=function(e){this.logDebugInformation&&g.info(e)};var n;return t.DefaultMapCollectionPaths=["basemap.baseLayers","layers","ground.layers","basemap.referenceLayers"],o([d.property()],t.prototype,"logDebugInformation",void 0),o([d.property({readOnly:!0})],t.prototype,"isSpatialReferenceDone",void 0),o([d.property({readOnly:!0})],t.prototype,"isTileInfoDone",void 0),o([d.property({readOnly:!0})],t.prototype,"isHeightModelInfoSearching",void 0),o([d.property({constructOnly:!0})],t.prototype,"view",void 0),o([d.property({readOnly:!0})],t.prototype,"spatialReference",void 0),o([d.property({readOnly:!0})],t.prototype,"extent",void 0),o([d.property({readOnly:!0})],t.prototype,"heightModelInfo",void 0),o([d.property({readOnly:!0})],t.prototype,"vcsWkid",void 0),o([d.property({readOnly:!0})],t.prototype,"latestVcsWkid",void 0),o([d.property()],t.prototype,"mapCollectionPaths",void 0),o([d.property()],t.prototype,"defaultSpatialReference",void 0),o([d.property({readOnly:!0})],t.prototype,"tileInfo",void 0),t=n=o([d.subclass("esri.views.support.DefaultsFromMap")],t)}(d.declared(n))});