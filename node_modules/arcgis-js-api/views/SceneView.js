// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.10/esri/copyright.txt for details.

define(["require","exports","../core/tsSupport/declareExtendsHelper","../core/tsSupport/decorateHelper","../core/tsSupport/generatorHelper","../core/tsSupport/awaiterHelper","dojo/dom","../Camera","../geometry","../Graphic","../Viewpoint","../core/asyncUtils","../core/Error","../core/Handles","../core/has","../core/Logger","../core/promiseUtils","../core/scheduling","../core/watchUtils","../core/accessorSupport/decorators","../core/accessorSupport/ensureType","../core/accessorSupport/watch","../core/libs/gl-matrix-2/gl-matrix","../geometry/HeightModelInfo","../geometry/support/aaBoundingRect","../geometry/support/scaleUtils","../geometry/support/webMercatorUtils","./BreakpointsOwner","./DOMContainer","./PopupView","./View","./ViewAnimation","./3d/constraints/Constraints","./3d/environment/SceneViewEnvironment","./3d/environment/SceneViewEnvironmentManager","./3d/input/SceneInputManager","./3d/layers/graphics/Deconflictor","./3d/layers/graphics/Labeler","./3d/layers/support/FeatureTileTree3D","./3d/layers/support/FeatureTileTree3DDebugger","./3d/state/ViewState","./3d/state/ViewStateManager","./3d/state/helpers/SceneIntersectionHelper","./3d/support/CombinedElevationProvider","./3d/support/debugFlags","./3d/support/DisplayQualityProfile","./3d/support/geometryUtils","./3d/support/HighlightOptions","./3d/support/MapCoordsHelper","./3d/support/projectionUtils","./3d/support/PropertiesPool","./3d/support/QualitySettings","./3d/support/RenderCoordsHelper","./3d/support/ResourceController","./3d/support/SharedSymbolResources","./3d/support/geometryUtils/boundedPlane","./3d/support/pointsOfInterest/PointsOfInterest","./3d/terrain/TerrainSurface","./3d/terrain/terrainUtils","./3d/webgl-engine/Stage","./3d/webgl-engine/lib/Selector","./support/screenshotUtils","./support/WebGLRequirements","./ui/3d/DefaultUI3D","../webscene/Environment"],function(e,t,r,i,n,a,s,o,p,l,c,d,h,u,g,y,f,v,m,w,_,b,S,R,O,M,T,V,P,x,E,C,I,H,L,G,U,D,F,A,j,q,z,W,k,B,N,Q,K,Z,J,X,Y,$,ee,te,re,ie,ne,ae,se,oe,pe,le,ce){var de=y.getLogger("esri.views.SceneView"),he=function(t){function y(e){var r=t.call(this)||this;return r._clippingArea=null,r._internallyReady=!1,r._userClippingArea=null,r._initialDefaultSpatialReference=null,r._defaults={},r._externallySet={environment:!1},r._handles=new u,r._createGraphicsViewPromise=null,r._updateUpdatingMonitorsHandle=null,r._mapLayersChangeHandle=null,r._updateDrawingOrderHandle=null,r._stageFrameTask=null,r.onViewExtentUpdateHandle=null,r._resolveWhenReady=[],r.propertiesPool=new J.default({slicePlane:te.BoundedPlaneClass},r),r.resourceController=new $(r),r.deconflictor=new U.Deconflictor(r),r.labeler=new D.Labeler({view:r}),r.renderSpatialReference=null,r.sharedSymbolResources=null,r.basemapTerrain=null,r.elevationProvider=null,r.camera=null,r.canvas=null,r.center=null,r.constraints=new I.default,r.extent=null,r.fullOpacity=1,r.graphicsView=null,r.map=null,r.screenSizePerspectiveEnabled=!0,r.state=null,r.scale=null,r.isHeightModelInfoRequired=!0,r.alphaCompositingEnabled=!1,r.supersampleScreenhotsEnabled=!0,r.type="3d",r.ui=new le,r.updating=!1,r.updatingPercentage=0,r.viewpoint=null,r.zoom=null,r.highlightOptions=new Q,m.when(r,"ready",r._viewReadyHandler.bind(r)),r._evaluateUpdating=r._evaluateUpdating.bind(r),r.watch("map",function(e){e&&e.load&&e.load()}),r.inputManager=new G({view:r}),r.stateManager=new q.ViewStateManager({view:r}),r}return r(y,t),y.prototype.getDefaults=function(e){var t=this.inherited(arguments);return t.environment||e.environment||(this._defaults.environment=new H,t.environment=this._defaults.environment),t},y.prototype.initialize=function(){var e=this;this.environmentManager=new L.default({view:this}),this._updateUpdatingMonitorsHandle=this.allLayerViews.on("change",function(t){return e._updateUpdatingMonitors(t)}),this._updateUpdatingMonitors({added:this.allLayerViews.toArray(),removed:[]}),m.whenNot(this,"ready",this._viewUnreadyHandler.bind(this)),this.resourceController.memoryEvents.on("updating-changed",function(){return e._evaluateUpdating()}),m.init(this.qualitySettings,"gpuMemoryLimit",function(t){e.resourceController&&(e.resourceController.maxGpuMemory=t)}),m.init(this.qualitySettings,"additionalCacheMemory",function(t){e.resourceController&&(e.resourceController.additionalCacheMemory=t)}),m.init(this.qualitySettings,"frameRate",function(e){v.setFrameRate(e)}),m.init(k,"SCENEVIEW_LOCKING_LOG",function(t){e.defaultsFromMap.logDebugInformation=t})},y.prototype.destroy=function(){this.activeTool=null,b.dispatchTarget(this),this.environmentManager.destroy(),this._disposeGraphicsView(),this._updateUpdatingMonitorsHandle.remove(),this._updateUpdatingMonitorsHandle=null,this._handles.removeAll(),this.inputManager&&(this.inputManager.destroy(),this._set("inputManager",null)),this.propertiesPool.destroy()},Object.defineProperty(y.prototype,"clippingArea",{get:function(){if("global"===this.viewingMode)return null;if(this._userClippingArea)return this._userClippingArea;var e=this.get("map.clippingEnabled"),t=this.get("map.clippingArea");return e&&t?t instanceof p.Extent?T.canProject(t.spatialReference,this.spatialReference)?(t=T.project(t,this.spatialReference),this._clippingArea&&t&&this._clippingArea.equals(t)?this._clippingArea:(this._clippingArea=t,t)):(de.error("#clippingArea","setting clippingArea with incompatible SpatialReference"),this._clippingArea):(de.error("#clippingArea","only clippingArea geometries of type Extent are supported"),this._clippingArea):(this._clippingArea=null,null)},set:function(e){this.ready&&"global"===this.viewingMode&&e?de.error("#clippingArea=","Clipping area is only supported in local viewingMode"):(this._userClippingArea=e,this.notifyChange("clippingArea"))},enumerable:!0,configurable:!0}),Object.defineProperty(y.prototype,"dataExtent",{get:function(){var e=[],t=this.spatialReference||p.SpatialReference.WGS84,r=this.clippingArea;r&&(r=T.project(r,t));var i=function(i){if(i){var n=T.project(i,t);n&&(r&&(n=n.intersection(r)),n&&e.push(n))}},n=this._get("basemapTerrain");if(n&&n.spatialReference&&i(new p.Extent({xmin:n.extent[0],ymin:n.extent[1],zmin:0,xmax:n.extent[2],ymax:n.extent[3],zmax:0,spatialReference:n.spatialReference})),this.map&&this.map.allLayers.forEach(function(e){i(e.fullExtent)}),e.length>0){var a=e.reduce(function(e,t){return e.union(t)});return a.hasZ?(a.zmin=Math.min(0,a.zmin),a.zmax=Math.max(0,a.zmax)):(a.zmin=0,a.zmax=0),a}return new p.Extent({xmin:0,ymin:0,zmin:0,xmax:0,ymax:0,zmax:0,spatialReference:t})},enumerable:!0,configurable:!0}),Object.defineProperty(y.prototype,"environment",{set:function(e){e!==this._defaults.environment&&(this._externallySet.environment=!0),this._set("environment",e)},enumerable:!0,configurable:!0}),y.prototype.castEnvironment=function(e){return e?e instanceof H?e:e instanceof ce?H.fromWebsceneEnvironment(e):_.ensureType(H,e):new H},Object.defineProperty(y.prototype,"groundExtent",{get:function(){var e=this._get("basemapTerrain");if(e&&e.spatialReference){var t=e.extent;return new p.Extent({xmin:t[0],ymin:t[1],xmax:t[2],ymax:t[3],spatialReference:e.spatialReference})}var r=this.spatialReference||p.SpatialReference.WGS84;return new p.Extent({spatialReference:r})},enumerable:!0,configurable:!0}),Object.defineProperty(y.prototype,"initialExtentRequired",{get:function(){return!this.stateManager.hasInitialView},enumerable:!0,configurable:!0}),Object.defineProperty(y.prototype,"interacting",{get:function(){return!!this.state&&this.state.interacting},enumerable:!0,configurable:!0}),y.prototype._mapSetter=function(e){e!==this._get("map")&&(this._mapLayersChangeHandle&&(this._mapLayersChangeHandle.remove(),this._mapLayersChangeHandle=null),e&&(this._mapLayersChangeHandle=e.allLayers.on("change",this.notifyChange.bind(this,"dataExtent"))),this.inherited(arguments))},Object.defineProperty(y.prototype,"qualityProfile",{get:function(){return this._get("qualityProfile")||B.getDefaultProfile()},set:function(e){B.isValidProfile(e)&&(B.apply(e,this.qualitySettings),this._set("qualityProfile",e))},enumerable:!0,configurable:!0}),Object.defineProperty(y.prototype,"slicePlane",{set:function(e){if(this._stage.setRenderParams({slicePlane:e}),!e)return void this._set("slicePlane",null);var t=this.propertiesPool.get("slicePlane");N.boundedPlane.copy(e,t),this._set("slicePlane",t)},enumerable:!0,configurable:!0}),Object.defineProperty(y.prototype,"resolution",{get:function(){return null!=this.spatialReference?M.getResolutionForScale(this.scale,this.spatialReference):0},enumerable:!0,configurable:!0}),Object.defineProperty(y.prototype,"heightModelInfo",{get:function(){var e=this.getDefaultHeightModelInfo();return null!=e?R.deriveUnitFromSR(e,this.spatialReference):null},enumerable:!0,configurable:!0}),Object.defineProperty(y.prototype,"viewingMode",{get:function(){var e=this.get("map.initialViewProperties.viewingMode"),t=this.spatialReference;return e||(e=!t||t.isWebMercator||t.isWGS84?"global":"local"),e},set:function(e){if(this._internallyReady)de.error("#viewingMode","viewingMode cannot be set once view is ready");else{["local","global"].indexOf(e)>=0?this._override("viewingMode",e):void 0===e&&this._clearOverride("viewingMode")}},enumerable:!0,configurable:!0}),y.prototype.on=function(e,t,r){var i=this.inputManager.viewEvents.register(e,t,r);return i||this.inherited(arguments)},y.prototype.hasEventListener=function(e){return this.inherited(arguments)||this.inputManager&&this.inputManager.viewEvents.hasHandler(e)},y.prototype.toMap=function(e,t,r){if(!this.ready)return de.error("#toMap()","Scene view cannot be used before it is ready"),null;var i,n;"number"==typeof e?(i=e,n=t):(i=e.x,n=e.y,r=t);var a=S.vec2f64.fromValues(i,this.height-n),s=this.sceneIntersectionHelper.intersectSelectorScreen(a).minResult;return this._computeMapPointFromIntersectionResult(s,r)},y.prototype.toScreen=function(e,t,r,i){if(!this.ready)return de.error("#toScreen()","Scene view cannot be used before it is ready"),null;if("number"==typeof e){var n="number"==typeof r?r:0;"object"==typeof r&&(i=r),Z.vectorToVector([e,t,n],this.spatialReference,ue,this.renderSpatialReference)}else Z.pointToVector(e,ue,this.renderSpatialReference),i=t;return this.engineToScreen(ue,i)},y.prototype.pixelSizeAt=function(e,t){if(!this.ready)return de.error("#pixelSizeAt()","Scene view cannot be used before it is ready"),null;if("number"==typeof e){var r=this.sceneIntersectionHelper.intersectSelectorScreen(S.vec2f64.fromValues(e,this.height-t)).minResult;if(!r.getIntersectionPoint(ue))return 0}else if(e instanceof p.Point)Z.pointToVector(e,ue,this.renderSpatialReference);else{var r=this.sceneIntersectionHelper.intersectSelectorScreen(S.vec2f64.fromValues(e.x,this.height-e.y)).minResult;if(!r.getIntersectionPoint(ue))return 0}return this.state.camera.computePixelSizeAt(ue)},y.prototype.hitTest=function(e){if(!this.ready)return de.error("#hitTest()","Scene view cannot be used before it is ready"),null;var t=S.vec2f64.fromValues(e.x,this.height-e.y),r=this.sceneIntersectionHelper.intersectSelectorScreen(t,null,null,!0),i=r.minResult,n=this._computeMapPointFromIntersectionResult(i),a=null;if(i.target)switch(i.target.type){case"stage":a=this._getGraphicFromStageObject(i.target.obj,i.triangleNr);break;case"external":switch(i.intersector){case"PointRenderer":a=f.when(this._getGraphicFromPointRenderer(i.target));break;case"LodRenderer":a=this._getGraphicFromLodRenderer(i.target)}}return f.when(a).catch(function(){return null}).then(function(t){var i=[];(t||n)&&i.push({mapPoint:n,graphic:t});var a={screenPoint:new p.ScreenPoint({x:e.x,y:e.y}),results:i};return k.SCENEVIEW_HITTEST_RETURN_SELECTOR&&(a.selector=r),a})},y.prototype.popupHitTest=function(e){var t=this;return this.hitTest(e).then(function(r){var i=[],n=null;if(0===r.results.length){var a=S.vec2f64.fromValues(e.x,t.height-e.y),s=t.sceneIntersectionHelper.intersectSelectorScreen(a,null,new Set).minResult;n=t._computeMapPointFromIntersectionResult(s)}for(var o=0,p=r.results;o<p.length;o++){var l=p[o];l.graphic?i.push(l):n||(n=l.mapPoint)}return{results:i,screenPoint:e,mapPoint:n}})},y.prototype.goTo=function(e,t){return this.stateManager.goTo(e,t)},y.prototype.takeScreenshot=function(e){var t=this;return this.whenReady().then(function(){return t._stage.takeScreenshot(oe.toRenderSettings(e,t))})},y.prototype.destroyLayerViews=function(){var e=this;this.allLayerViews.forEach(function(t){return e._handles.remove(t.layer.uid)}),this.stateManager.deinit(),this._disposeSurface(),this.inherited(arguments),this._stage&&(this._stage.dispose(),this._stage=null,this._handles.remove("stage")),this._set("canvas",null),this.labeler=null,this.deconflictor.destroy(),this.deconflictor=null,this.resourceController.destroy(),this.resourceController=null},y.prototype.getDefaultSpatialReference=function(){return this.get("map.initialViewProperties.spatialReference")||this.get("defaultsFromMap.spatialReference")||this.get("defaultsFromMap.isSpatialReferenceDone")&&this._initialDefaultSpatialReference||null},y.prototype.validate=function(){var e=pe.check();return g("safari")&&g("safari")<9&&(e=new h("sceneview:browser-not-supported","This browser is not supported by SceneView (Safari < 9)",{type:"safari",requiredVersion:9,detectedVersion:g("safari")})),e?(de.warn("#validate()",e.message),f.reject(e)):f.resolve()},y.prototype.isSpatialReferenceSupported=function(e,t,r){var i=e.isGeographic,n=e.isWebMercator,a=e.isWGS84,s="local"===this.viewingMode,o=!(!this._isOverridden("viewingMode")&&!this.get("map.initialViewProperties.viewingMode"));if(o){if(s&&i)return r&&r("Layer "+t.id+" is ignored because it is GCS and viewing mode is local"),!1;if(!s&&!n&&!a)return r&&r("Layer "+t.id+" is ignored because its spatial reference is not supported in global viewing mode"),!1}else if(i&&!a)return r&&r("Layer "+t.id+" is ignored because its spatial reference is geographic but not WGS84"),!1;if(t)if(ne.isTiledLayer(t)){var p=void 0;if(o){var l=ne.getTiledLayerInfo(t,e,this.viewingMode);p=null!=l.tileInfo}else{var l=ne.getTiledLayerInfo(t,e,"global");null==l.tileInfo&&(l=ne.getTiledLayerInfo(t,e,"local")),p=null!=l.tileInfo}if(!p)return r&&r("Layer "+t.id+" is ignored because it is tiled but\n            its tiling scheme is not supported or compatible with the viewing mode"),!1}else if((a||n)&&!s)return null==this._initialDefaultSpatialReference&&(this._initialDefaultSpatialReference=e),o||this._internallyReady||(this.viewingMode="global",r&&r("Viewing mode locked to global due to reprojectable layer "+t.id)),r&&r("Layer "+t.id+" is ignored because it supports server-side reprojection"),!1;return!0},y.prototype.whenReady=function(){var e=this;return f.create(function(t){e._internallyReady?t(e):e._resolveWhenReady.push(t)})},y.prototype.engineToScreen=function(e,t){var r=S.vec3f64.create();this.state.camera.projectPoint(e,r);var i=r[0],n=this.height-r[1],a=r[2];return t?(t.x=i,t.y=n,t.z=a,t):new p.ScreenPoint({x:i,y:n,z:a})},y.prototype.flushDisplayModifications=function(){this._stage.processDirty()},y.prototype.getDrawingOrder=function(e){return this.allLayerViews.findIndex(function(t){return t.layer&&t.layer.uid===e})},y.prototype.getViewForGraphic=function(e){return e.layer?this.allLayerViews.find(function(t){return t.layer===e.layer}):this.graphicsView},y.prototype.whenViewForGraphic=function(e){var t=this;return e.layer?this.whenLayerView(e.layer):this.graphicsView||this._createGraphicsViewPromise||this.graphics.length>0?m.whenOnce(this,"graphicsView").then(function(){return t.graphicsView}):f.reject()},y.prototype._computeMapPointFromIntersectionResult=function(e,t){if(e.getIntersectionPoint(ue)){t=this._computeMapPointFromVec3d(ue,t);var r=this._get("basemapTerrain");if("TerrainRenderer"===e.intersector&&r){var i=r.getElevation(t);null!==i&&(t.z=i)}return t}return null},y.prototype._computeMapPointFromVec3d=function(e,t){var r=this.spatialReference||p.SpatialReference.WGS84;return Z.vectorToVector(e,this.renderSpatialReference,e,r)||(r=p.SpatialReference.WGS84,Z.vectorToVector(e,this.renderSpatialReference,e,r)),t?(t.x=e[0],t.y=e[1],t.z=e[2],t.spatialReference=r):t=new p.Point(e,r),t},y.prototype._getGraphicFromStageObject=function(e,t){var r=e.getMetadata();if(null!=r&&null!=r.layerUid){if(this.graphicsView&&r.layerUid===this.graphicsView.mockLayerId)return this.graphicsView.getGraphicFromGraphicUid(e.metadata.graphicUid);var i=this.map.findLayerByUid(r.layerUid);if(i)return this.whenLayerView(i).then(function(r){if(r&&!r.suspended){if(r.getGraphicFromStageObject)return r.getGraphicFromStageObject(e,t);if(r.getGraphicFromGraphicUid&&null!=e.metadata.graphicUid)return r.getGraphicFromGraphicUid(e.metadata.graphicUid)}})}return null},y.prototype._getGraphicFromPointRenderer=function(e){var t=this._computeMapPointFromVec3d(e.point),r=new l(t),i=e.metadata.layerUid;if(null!=i){var n=this.map.findLayerByUid(i);r.layer=n,r.sourceLayer=n}return r},y.prototype._getGraphicFromLodRenderer=function(e){var t=e.metadata;if(null!=t&&null!=t.layerUid){if(this.graphicsView&&t.layerUid===this.graphicsView.mockLayerId)return this.graphicsView.getGraphicFromGraphicUid(t.graphicUid);var r=this.map.findLayerByUid(t.layerUid);if(r)return this.whenLayerView(r).then(function(e){if(e&&!e.suspended)return e.getGraphicFromGraphicUid(t.graphicUid)})}return null},y.prototype._viewingModeToManifold=function(e){switch(e){case"global":return"spherical";case"local":return"planar"}},y.prototype._initBasemapTerrain=function(e){var t=this;this._disposeBasemapTerrain(),this._set("basemapTerrain",new ie(this,this._viewingModeToManifold(e))),this._set("elevationProvider",new W({view:this})),this.elevationProvider.register("ground",this.basemapTerrain),this._handles.add([m.init(this,"map.ground.opacity",function(e){t.basemapTerrain.baseOpacity=null!=e?e:1}),m.init(this,"map.ground.surfaceColor",function(e){t.basemapTerrain.backgroundColor=e})],"basemapTerrain")},y.prototype._initGlobe=function(e){var t=this;this._initCoordinateSystem(),this._initState(),this._stage.setViewParams({backgroundColor:[0,0,0,0]}),this._initBasemapTerrain(e),this._set("pointsOfInterest",new re.default({view:this})),this._set("featureTiles",new F.default({renderCoordsHelper:this.renderCoordsHelper,cameraOnSurface:this.pointsOfInterest.cameraOnSurface,focus:this.pointsOfInterest.focus,tilingSchemeOwner:this.basemapTerrain,viewState:this.state,resourceController:this.resourceController})),this._handles.add(this.featureTiles.watch("updating",function(){return t._evaluateUpdating()})),this._handles.add(m.init(k,"FEATURE_TILE_TREE_SHOW_TILES",function(e){e&&t.featureTiles&&!t.featureTilesDebugger?t.featureTilesDebugger=new A.FeatureTileTree3DDebugger(t):!e&&t.featureTilesDebugger&&(t.featureTilesDebugger.destroy(),t.featureTilesDebugger=null)}),"feature-tiles"),this._handles.add(m.init(this,["clippingArea","basemapTerrain.extent"],function(){if(t.clippingArea||t.basemapTerrain.extent)if(t.basemapTerrain.extent&&t.basemapTerrain.spatialReference){var e=O.toExtent(t.basemapTerrain.extent,t.basemapTerrain.spatialReference);t.clippingArea?t.featureTiles.filterExtent=e.intersection(t.clippingArea):t.featureTiles.filterExtent=e}else t.featureTiles.filterExtent=t.clippingArea;else t.featureTiles.filterExtent=null},!0),"feature-tiles"),this.stateManager.init()},y.prototype._initCoordinateSystem=function(){var e=this;if(this.spatialReference){var t=this.spatialReference;this.mapCoordsHelper&&this.mapCoordsHelper.spatialReference.equals(t)||this._set("mapCoordsHelper",new K.default(this.map,t));var r="global"===this.viewingMode,i=r?Z.SphericalECEFSpatialReference:t;i!==this.renderSpatialReference&&(this.renderSpatialReference=i,this._set("renderCoordsHelper",Y.RenderCoordsHelper.createMode(this.viewingMode,i)),r||this._handles.add(this.watch("basemapTerrain.extent",function(t){0===t[0]&&0===t[1]&&0===t[2]&&0===t[3]||(e.renderCoordsHelper.extent=t)},!0),"render-coords-helper"),this.sceneIntersectionHelper&&this.sceneIntersectionHelper.setTolerance(se.DEFAULT_TOLERANCE/this.renderCoordsHelper.unitInMeters))}else this._set("mapCoordsHelper",null),this._set("renderCoordsHelper",null),this.renderSpatialReference=null},y.prototype._evaluateUpdating=function(){var e=0,t=0,r=!1;this.allLayerViews.forEach(function(i){if(i.updating){r=!0;var n=i.updatingPercentage;null!=n&&(++t,e+=n)}}),(this._createGraphicsViewPromise||this.graphicsView&&this.graphicsView.updating||this.resourceController&&this.resourceController.updating||this.featureTiles&&this.featureTiles.updating||this.labeler&&this.labeler.updating)&&(r=!0),r!==this.updating&&this._set("updating",r),0!==t?e/=t:e=r?100:0,this.updatingPercentage!==e&&this._set("updatingPercentage",e)},y.prototype._updateUpdatingMonitors=function(e){for(var t=this,r=0,i=e.removed;r<i.length;r++){var n=i[r];this._handles.remove(n.uid)}for(var a=0,s=e.added;a<s.length;a++){var n=s[a];n.destroyed||this._handles.add([n.watch(["updating","updatingPercentage"],this._evaluateUpdating),n.watch("suspended",function(e){return t._updateLayerViewSuspension(e)})],n.uid)}this._evaluateUpdating()},y.prototype._updateLayerViewSuspension=function(e){e&&this.resourceController.setMemoryDirty()},y.prototype._disposeSurface=function(){var e=function(e){return e&&e.remove(),null};this._stageFrameTask=e(this._stageFrameTask),this._updateDrawingOrderHandle=e(this._updateDrawingOrderHandle),this.onViewExtentUpdateHandle=e(this.onViewExtentUpdateHandle),this._mapLayersChangeHandle=e(this._mapLayersChangeHandle),this.pointsOfInterest&&(this.pointsOfInterest.destroy(),this._set("pointsOfInterest",null)),this.featureTiles&&(this.featureTiles.destroy(),this._set("featureTiles",null)),this._handles.remove("feature-tiles"),this._handles.remove("render-coords-helper"),this._disposeBasemapTerrain(),this.environmentManager&&this.environmentManager.disposeRendering()},y.prototype._disposeBasemapTerrain=function(){var e=this._get("basemapTerrain");e&&(this._handles.remove("basemapTerrain"),e.destroy(),this._set("basemapTerrain",null))},y.prototype._renderScreenshotOverlay=function(e,t){if(this.overlay&&this.overlay.hasVisibleItems){var r=e.getContext("2d");r.putImageData(t,0,0),this.overlay.renderCanvas(e);for(var i=r.getImageData(0,0,t.width,t.height),n=0;n<i.data.length;n++)t.data[n]=i.data[n]}},y.prototype._initStage=function(){var e=this,t={};t.renderContext=this.renderContext,t.deactivatedWebGLExtensions=this.deactivatedWebGLExtensions,t.viewingMode=this.viewingMode,t.alpha=this.alphaCompositingEnabled,t.supersampleScreenshots=this.supersampleScreenhotsEnabled,t.renderScreenshotOverlay=function(t,r){return e._renderScreenshotOverlay(t,r)},this.renderCanvas&&(t.canvas=this.renderCanvas);var r=new z.SceneIntersectionHelper(this.viewingMode,{forEachLayer:function(t){var r=e._stage.getLayers();Object.keys(r).forEach(function(e){t(r[e])})}},{camera:function(){return e.state.camera},extent:function(){return e.dataExtent},slicePlane:function(){return e.slicePlane},hasOpaqueTerrain:function(){return!!e.basemapTerrain&&e.basemapTerrain.isOpaque()}});this._set("sceneIntersectionHelper",r),this._stage=new ae(this.viewingMode,s.byId(this.surface),t,r),this._handles.add(m.init(this.qualitySettings,"antialiasingEnabled",function(){e._stage.setRenderParams({antialiasingEnabled:e.qualitySettings.antialiasingEnabled})}),"stage");var i=function(){e._stage.setRenderParams({defaultHighlightOptions:Q.toEngineOptions(e.highlightOptions)})};this._handles.add(this.watch(["highlightOptions","highlightOptions.color","highlightOptions.haloOpacity","highlightOptions.fillOpacity"],i),"stage"),i(),this.renderCoordsHelper&&this.sceneIntersectionHelper.setTolerance(se.DEFAULT_TOLERANCE/this.renderCoordsHelper.unitInMeters),this._set("canvas",this._stage.getCanvas()),this._stageFrameTask=v.addFrameTask(this._stage.getFrameTask())},y.prototype._initSurface=function(){this._initStage(),this._initGlobe(this.viewingMode),this.sharedSymbolResources=new ee.default({stage:this._stage,viewingMode:this.viewingMode,resourceController:this.resourceController,pointsOfInterest:this.pointsOfInterest,viewState:this.state})},y.prototype._createGraphicsViewIfNeeded=function(){this.graphicsView||this._createGraphicsViewPromise||0!==this.graphics.length&&(this._handles.remove("graphics-view"),this._createGraphicsViewPromise=d.safeCast(this._createGraphicsViewAsync()),this._createGraphicsViewPromise.isFulfilled()&&(this._createGraphicsViewPromise=null),this._evaluateUpdating())},y.prototype._createGraphicsViewAsync=function(){return a(this,void 0,void 0,function(){var t,r=this;return n(this,function(i){switch(i.label){case 0:return[4,f.create(function(t){return e(["./3d/layers/GraphicsView3D"],t)})];case 1:return t=i.sent(),[4,m.whenTrueOnce(this.basemapTerrain,"ready")];case 2:return i.sent(),this._set("graphicsView",new t({view:this})),this._handles.add([m.init(this.graphicsView,"updating",this._evaluateUpdating),m.init(this.graphicsView,"suspended",function(){return r._updateLayerViewSuspension(!0)})],this.graphicsView.mockLayerId),this._createGraphicsViewPromise=null,this._evaluateUpdating(),[2]}})})},y.prototype._disposeGraphicsView=function(){this._createGraphicsViewPromise&&(this._createGraphicsViewPromise.cancel(),this._createGraphicsViewPromise=null),this._handles.remove("graphics-view"),this.graphicsView&&(this._handles.remove(this.graphicsView.mockLayerId),this.graphicsView.destroy(),this._set("graphicsView",null))},y.prototype._initState=function(){this._set("state",new j.default({viewingMode:this.viewingMode,spatialReference:this.spatialReference}))},y.prototype._viewReadyHandler=function(e,t){var r=this;if(!t){if("global"===this.viewingMode&&(this._clippingArea=null),this._internallyReady=!0,this._initSurface(),this._handles.add(m.on(this,"graphics","change",function(){return r._createGraphicsViewIfNeeded()},function(){return r._createGraphicsViewIfNeeded()}),"graphics-view"),this._createGraphicsViewPromise&&this._handles.remove("graphics-view"),this._evaluateUpdating(),!this._externallySet.environment){var i=this.get("map.initialViewProperties.environment");i&&(this.environment=i)}this._updateDrawingOrderHandle=this.allLayerViews.on("change",function(){return r._updateDrawingOrder()}),this._updateDrawingOrder(),this.labeler.setup(),this.environmentManager.updateReadyChange(!0);var n=this._resolveWhenReady;this._resolveWhenReady=[],n.forEach(function(e){return e(r)})}},y.prototype._viewUnreadyHandler=function(e,t){t&&(this.activeTool&&(this.activeTool.deactivate&&this.activeTool.deactivate(),this._set("activeTool",null)),this._initialDefaultSpatialReference=null,this.environmentManager.updateReadyChange(!1),this._disposeGraphicsView(),this._internallyReady=!1,this.stateManager.deinit(),this._disposeSurface(),this.state.destroy(),this._set("state",null),this.sharedSymbolResources&&(this.sharedSymbolResources.destroy(),this.sharedSymbolResources=null),this.labeler&&this.labeler.dispose(),this._stage&&(this._stage.dispose(),this._stage=null),this._handles.remove("stage"),this._set("canvas",null))},y.prototype._updateDrawingOrder=function(){var e=this.allLayerViews.length-1;this.allLayerViews.forEach(function(t,r){"drawingOrder"in t&&(t.drawingOrder=e-r)})},i([w.property({type:C,readOnly:!0,aliasOf:"state.animation"})],y.prototype,"animation",void 0),i([w.property()],y.prototype,"layerViews",void 0),i([w.property({readOnly:!0})],y.prototype,"basemapTerrain",void 0),i([w.property({readOnly:!0})],y.prototype,"elevationProvider",void 0),i([w.property({type:o,aliasOf:"stateManager.camera"})],y.prototype,"camera",void 0),i([w.property({readOnly:!0})],y.prototype,"canvas",void 0),i([w.property({type:p.Point,aliasOf:"stateManager.center"})],y.prototype,"center",void 0),i([w.property({type:p.Extent,dependsOn:["map.clippingArea?","map.clippingEnabled?","viewingMode"]})],y.prototype,"clippingArea",null),i([w.property({type:I.default})],y.prototype,"constraints",void 0),i([w.property({type:p.Extent,dependsOn:["basemapTerrain.extent","clippingArea","map"],readOnly:!0})],y.prototype,"dataExtent",null),i([w.property({value:null})],y.prototype,"environment",null),i([w.cast("environment")],y.prototype,"castEnvironment",null),i([w.property()],y.prototype,"environmentManager",void 0),i([w.property({type:p.Extent,aliasOf:"stateManager.extent"})],y.prototype,"extent",void 0),i([w.property({type:p.ScreenPoint,readOnly:!0,aliasOf:"stateManager.screenCenter"})],y.prototype,"screenCenter",void 0),i([w.property({aliasOf:"stateManager.frustum"})],y.prototype,"frustum",void 0),i([w.property({type:Number,readOnly:!0})],y.prototype,"fullOpacity",void 0),i([w.property({readOnly:!0})],y.prototype,"graphicsView",void 0),i([w.property({type:p.Extent,dependsOn:["basemapTerrain.extent"],readOnly:!0})],y.prototype,"groundExtent",null),i([w.property({type:Boolean,dependsOn:["stateManager.hasInitialView"]})],y.prototype,"initialExtentRequired",null),i([w.property({type:Boolean,dependsOn:["state.interacting"],readOnly:!0})],y.prototype,"interacting",null),i([w.property()],y.prototype,"map",void 0),i([w.property({readOnly:!0})],y.prototype,"mapCoordsHelper",void 0),i([w.property({aliasOf:"stateManager.padding"})],y.prototype,"padding",void 0),i([w.property({type:re.default,readOnly:!0})],y.prototype,"pointsOfInterest",void 0),i([w.property({type:F.default,readOnly:!0})],y.prototype,"featureTiles",void 0),i([w.property({type:A.FeatureTileTree3DDebugger})],y.prototype,"featureTilesDebugger",void 0),i([w.property({type:Boolean})],y.prototype,"screenSizePerspectiveEnabled",void 0),i([w.property({constructOnly:!0})],y.prototype,"deactivatedWebGLExtensions",void 0),i([w.property({constructOnly:!0})],y.prototype,"renderCanvas",void 0),i([w.property({readOnly:!0})],y.prototype,"state",void 0),i([w.property({readOnly:!0})],y.prototype,"inputManager",void 0),i([w.property({readOnly:!0})],y.prototype,"stateManager",void 0),i([w.property()],y.prototype,"qualityProfile",null),i([w.property({type:X,get:function(){var e=this._get("qualitySettings");return e||(e=new X,B.apply(this.qualityProfile,e)),e}})],y.prototype,"qualitySettings",void 0),i([w.property()],y.prototype,"slicePlane",null),i([w.property({dependsOn:["viewingMode"]})],y.prototype,"ready",void 0),i([w.property({readOnly:!0})],y.prototype,"renderCoordsHelper",void 0),i([w.property({readOnly:!0})],y.prototype,"sceneIntersectionHelper",void 0),i([w.property({type:Number,dependsOn:["scale","spatialReference"],readOnly:!0})],y.prototype,"resolution",null),i([w.property({type:Number,aliasOf:"stateManager.scale"})],y.prototype,"scale",void 0),i([w.property()],y.prototype,"heightModelInfo",null),i([w.property({dependsOn:["map.initialViewProperties?.spatialReference","defaultsFromMap.isSpatialReferenceDone"]})],y.prototype,"spatialReference",void 0),i([w.property({type:Boolean})],y.prototype,"isHeightModelInfoRequired",void 0),i([w.property({type:Boolean,constructOnly:!0})],y.prototype,"alphaCompositingEnabled",void 0),i([w.property({type:Boolean,constructOnly:!0})],y.prototype,"supersampleScreenhotsEnabled",void 0),i([w.property()],y.prototype,"type",void 0),i([w.property({type:le})],y.prototype,"ui",void 0),i([w.property({type:Boolean,readOnly:!0})],y.prototype,"updating",void 0),i([w.property({type:Number,readOnly:!0})],y.prototype,"updatingPercentage",void 0),i([w.property({type:["global","local"],dependsOn:["map.initialViewProperties?.viewingMode","spatialReference"]})],y.prototype,"viewingMode",null),i([w.property({type:c,aliasOf:"stateManager.viewpoint"})],y.prototype,"viewpoint",void 0),i([w.property({type:Number,aliasOf:"stateManager.zoom"})],y.prototype,"zoom",void 0),i([w.property({type:Q})],y.prototype,"highlightOptions",void 0),y=i([w.subclass("esri.views.SceneView")],y)}(w.declared(P,E,V,x)),ue=S.vec3f64.create();return he});