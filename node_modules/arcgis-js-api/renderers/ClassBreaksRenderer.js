// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.10/esri/copyright.txt for details.

define(["require","exports","../core/tsSupport/declareExtendsHelper","../core/tsSupport/decorateHelper","../core/tsSupport/paramHelper","../symbols","../core/kebabDictionary","../core/lang","../core/Logger","../core/accessorSupport/decorators","../core/accessorSupport/ensureType","./Renderer","./mixins/VisualVariablesRenderer","./support/ClassBreakInfo","./support/LegendOptions","../support/arcadeUtils","../symbols/support/jsonUtils","../symbols/support/typeUtils"],function(e,t,r,o,l,n,a,i,s,p,u,y,f,c,d,m,h,b){var g=s.getLogger("esri.renderers.ClassBreaksRenderer"),v=a({esriNormalizeByLog:"log",esriNormalizeByPercentOfTotal:"percent-of-total",esriNormalizeByField:"field"}),k=u.ensureType(c.ClassBreakInfo);return function(e){function t(t){var r=e.call(this)||this;return r.backgroundFillSymbol=null,r.classBreakInfos=null,r.defaultLabel=null,r.defaultSymbol=null,r.field=null,r.isMaxInclusive=!0,r.legendOptions=null,r.normalizationField=null,r.normalizationTotal=null,r.type="class-breaks",r.valueExpression=null,r.valueExpressionTitle=null,r._set("classBreakInfos",[]),r}r(t,e),a=t,t.prototype.readClassBreakInfos=function(e,t,r){if(Array.isArray(e)){var o=t.minValue;return e.map(function(e){var t=new c.ClassBreakInfo;return t.read(e,r),null==t.minValue&&(t.minValue=o),null==t.maxValue&&(t.maxValue=t.minValue),o=t.maxValue,t})}},t.prototype.writeClassBreakInfos=function(e,t,r,o){var l=e.map(function(e){return e.write({},o)});this._areClassBreaksConsecutive()&&l.forEach(function(e){return delete e.classMinValue}),t[r]=l},Object.defineProperty(t.prototype,"compiledFunc",{get:function(){return m.createFunction(this.valueExpression)},enumerable:!0,configurable:!0}),t.prototype.readDefaultSymbol=function(e,t,r){return h.read(e,t,r)},t.prototype.writeDefaultSymbolWebScene=function(e,t,r,o){h.writeTarget(e,t,r,o)},t.prototype.writeDefaultSymbol=function(e,t,r,o){h.writeTarget(e,t,r,o)},t.prototype.castField=function(e){return null==e?e:"function"==typeof e?(g.error(".field: field must be a string value"),null):u.ensureString(e)},Object.defineProperty(t.prototype,"minValue",{get:function(){return this.classBreakInfos&&this.classBreakInfos[0]&&this.classBreakInfos[0].minValue||0},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"normalizationType",{get:function(){var e=this._get("normalizationType"),t=!!this.normalizationField,r=null!=this.normalizationTotal;return t||r?(e=t&&"field"||r&&"percent-of-total"||null,t&&r&&g.warn("warning: both normalizationField and normalizationTotal are set!")):"field"!==e&&"percent-of-total"!==e||(e=null),e},set:function(e){this._set("normalizationType",e)},enumerable:!0,configurable:!0}),t.prototype.addClassBreakInfo=function(e,t,r){var o=null;o="number"==typeof e?new c.ClassBreakInfo({minValue:e,maxValue:t,symbol:r}):k(i.clone(e)),this.classBreakInfos.push(o),1===this.classBreakInfos.length&&this.notifyChange("minValue")},t.prototype.removeClassBreakInfo=function(e,t){for(var r=this.classBreakInfos.length,o=0;o<r;o++){var l=[this.classBreakInfos[o].minValue,this.classBreakInfos[o].maxValue];if(l[0]===e&&l[1]===t){this.classBreakInfos.splice(o,1);break}}},t.prototype.getBreakIndex=function(e,t){var r=this.field,o=e.attributes,l=this.isMaxInclusive,n=null;if(this.valueExpression)n=m.executeFunction(this.compiledFunc,m.createExecContext(e,m.getViewInfo(t)));else{n=parseFloat(o[r]);var a=this.normalizationType;if(a){var i=this.normalizationTotal,s=parseFloat(o[this.normalizationField]);if("log"===a)n=Math.log(n)*Math.LOG10E;else if("percent-of-total"!==a||isNaN(i)){if("field"===a&&!isNaN(s)){if(isNaN(n)||isNaN(s))return-1;n/=s}}else n=n/i*100}}if(null!=n&&"number"==typeof n&&!isNaN(n))for(var p=0;p<this.classBreakInfos.length;p++){var u=[this.classBreakInfos[p].minValue,this.classBreakInfos[p].maxValue];if(u[0]<=n&&(l?n<=u[1]:n<u[1]))return p}return-1},t.prototype.getClassBreakInfo=function(e,t){var r=this.getBreakIndex(e,t);return-1!==r?this.classBreakInfos[r]:null},t.prototype.getSymbol=function(e,t){var r=this.getBreakIndex(e,t);return r>-1?this.classBreakInfos[r].symbol:this.defaultSymbol},t.prototype.getSymbols=function(){var e=[];return this.classBreakInfos.forEach(function(t){t.symbol&&e.push(t.symbol)}),this.defaultSymbol&&e.push(this.defaultSymbol),e},t.prototype.clone=function(){return new a({field:this.field,backgroundFillSymbol:this.backgroundFillSymbol&&this.backgroundFillSymbol.clone(),defaultLabel:this.defaultLabel,defaultSymbol:this.defaultSymbol&&this.defaultSymbol.clone(),valueExpression:this.valueExpression,valueExpressionTitle:this.valueExpressionTitle,classBreakInfos:i.clone(this.classBreakInfos),isMaxInclusive:this.isMaxInclusive,normalizationField:this.normalizationField,normalizationTotal:this.normalizationTotal,normalizationType:this.normalizationType,visualVariables:i.clone(this.visualVariables),legendOptions:i.clone(this.legendOptions),authoringInfo:this.authoringInfo&&this.authoringInfo.clone()})},t.prototype.collectRequiredFields=function(e){this.inherited(arguments),[this.field,this.normalizationField].forEach(function(t){t&&"string"==typeof t&&(e[t]=!0)}),this.valueExpression&&m.extractFieldNames(this.valueExpression).forEach(function(t){e[t]=!0})},t.prototype._areClassBreaksConsecutive=function(){for(var e=this.classBreakInfos,t=e.length,r=1;r<t;r++)if(e[r-1].maxValue!==e[r].minValue)return!1;return!0};var a;return o([p.property({types:{base:n.BaseSymbol,key:"type",typeMap:{"simple-fill":b.rendererTypes.typeMap["simple-fill"],"picture-fill":b.rendererTypes.typeMap["picture-fill"],"polygon-3d":b.rendererTypes.typeMap["polygon-3d"]}},json:{origins:{"web-scene":{read:h.read,write:{target:{backgroundFillSymbol:{type:n.PolygonSymbol3D}},writer:h.writeTarget}}},read:h.read,write:h.writeTarget}})],t.prototype,"backgroundFillSymbol",void 0),o([p.property({type:[c.ClassBreakInfo]})],t.prototype,"classBreakInfos",void 0),o([p.reader("classBreakInfos")],t.prototype,"readClassBreakInfos",null),o([p.writer("classBreakInfos")],t.prototype,"writeClassBreakInfos",null),o([p.property({dependsOn:["valueExpression"]})],t.prototype,"compiledFunc",null),o([p.property({type:String,json:{write:!0}})],t.prototype,"defaultLabel",void 0),o([p.property({types:b.rendererTypes})],t.prototype,"defaultSymbol",void 0),o([p.reader("defaultSymbol")],t.prototype,"readDefaultSymbol",null),o([p.writer("web-scene","defaultSymbol",{defaultSymbol:{types:b.rendererTypes3D}})],t.prototype,"writeDefaultSymbolWebScene",null),o([p.writer("defaultSymbol")],t.prototype,"writeDefaultSymbol",null),o([p.property({type:String,json:{write:!0}})],t.prototype,"field",void 0),o([p.cast("field")],t.prototype,"castField",null),o([p.property({type:Boolean})],t.prototype,"isMaxInclusive",void 0),o([p.property({type:d.default,json:{write:!0}})],t.prototype,"legendOptions",void 0),o([p.property({type:Number,readOnly:!0,value:null,dependsOn:["classBreakInfos"],json:{read:!1,write:{overridePolicy:function(){return 0!==this.classBreakInfos.length&&this._areClassBreaksConsecutive()?{enabled:!0}:{enabled:!1}}}}})],t.prototype,"minValue",null),o([p.property({type:String,json:{write:!0}})],t.prototype,"normalizationField",void 0),o([p.property({type:Number,cast:function(e){return u.ensureNumber(e)},json:{write:!0}})],t.prototype,"normalizationTotal",void 0),o([p.property({type:v.apiValues,value:null,dependsOn:["normalizationField","normalizationTotal"],json:{type:v.jsonValues,read:v.read,write:v.write}})],t.prototype,"normalizationType",null),o([p.property({dependsOn:["field","normalizationField","valueExpression"],readOnly:!0})],t.prototype,"requiredFields",void 0),o([p.enumeration.serializable()({classBreaks:"class-breaks"})],t.prototype,"type",void 0),o([p.property({type:String,json:{write:!0}})],t.prototype,"valueExpression",void 0),o([p.property({type:String,json:{write:!0}})],t.prototype,"valueExpressionTitle",void 0),o([l(2,p.cast(b.ensureType))],t.prototype,"addClassBreakInfo",null),t=a=o([p.subclass("esri.renderers.ClassBreaksRenderer")],t)}(p.declared(y,f))});