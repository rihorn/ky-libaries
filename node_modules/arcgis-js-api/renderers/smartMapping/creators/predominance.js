// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.10/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/assignHelper","dojo/i18n!../../nls/smartMapping","../../../core/numberUtils","../../../core/promiseUtils","./size","./type","./support/utils","../statistics/summaryStatistics","../support/utils","../support/adapters/support/predominanceUtils","../symbology/predominance","../../support/AuthoringInfo","../../support/AuthoringInfoVisualVariable","../../visualVariables/OpacityVariable"],function(e,r,a,i,n,l,o,t,s,p,u,d,m,c,y,v){function f(e){if(!(e&&e.layer&&e.view&&e.fields&&e.fields.length))return l.reject(s.createError("predominance-renderer:missing-parameters","'layer', 'view' and 'fields' parameters are required"));if(e.fields.length<2)return l.reject(s.createError("predominance-renderer:invalid-parameters","Minimum 2 fields are required"));if(e.fields.length>10)return l.reject(s.createError("predominance-renderer:invalid-parameters","Maximum 10 fields are supported"));var r=a({},e);r.symbolType=r.symbolType||"2d",r.defaultSymbolEnabled=null==r.defaultSymbolEnabled||r.defaultSymbolEnabled,r.includeOpacityVariable=e.includeOpacityVariable||!1,r.includeSizeVariable=e.includeSizeVariable||!1,r.sortBy=null==r.sortBy?"count":r.sortBy;var i=[0,1,2],n=u.createLayerAdapter(r.layer,i);return r.layer=n,n?n.load().then(function(){var e=n.geometryType,a=r.symbolType.indexOf("3d")>-1;if("mesh"===e)r.symbolType="3d-volumetric",r.colorMixMode=r.colorMixMode||"replace",r.edgesType=r.edgesType||"none";else{if(a&&("polyline"===e||"polygon"===e))return l.reject(s.createError("predominance-renderer:not-supported","3d symbols are not supported for polyline and polygon layers"));if(r.symbolType.indexOf("3d-volumetric")>-1&&(!r.view||"3d"!==r.view.type))return l.reject(s.createError("predominance-renderer:invalid-parameters","'view' parameter should be an instance of SceneView when 'symbolType' parameter is '3d-volumetric' or '3d-volumetric-uniform'"))}var i=r.fields.map(function(e){return e.name}),o=s.verifyBasicFieldValidity(n,i,"predominance-renderer:invalid-parameters");return o?l.reject(o):r}):l.reject(s.createError("predominance-renderer:invalid-parameters","'layer' must be one of these types: "+u.getLayerTypeLabels(i).join(", ")))}function b(e){var r=e.predominanceScheme,a=e.basemap;if(r)r=m.cloneScheme(r);else{var i=m.getSchemes({basemap:e.basemap,geometryType:e.geometryType,numColors:e.numColors,theme:e.theme,worldScale:e.worldScale,view:e.view});r=i&&i.primaryScheme,a=i&&i.basemapId}return{scheme:r,basemapId:a}}function g(e,r,a,n){var l=e.layer;return l.getPredominantCategories(n,e.view).then(function(o){var p=o;return o&&o.predominantCategoryInfos||(p={predominantCategoryInfos:n.map(function(e){return{value:e,count:0}})}),t.createRenderer({layer:l,basemap:e.basemap,valueExpression:r.valueExpression,valueExpressionTitle:i.predominantCategory,numTypes:-1,defaultSymbolEnabled:e.defaultSymbolEnabled,sortBy:e.sortBy,typeScheme:a,statistics:{uniqueValueInfos:p.predominantCategoryInfos},legendOptions:e.legendOptions,symbolType:e.symbolType,colorMixMode:e.colorMixMode,edgesType:e.edgesType,view:e.view}).then(function(r){for(var i=r.renderer,n=i.uniqueValueInfos,o={},t=0,p=e.fields;t<p.length;t++){var u=p[t],d=l.getField(u.name);o[d.name]=u.label||d&&d.alias||u.name}for(var m=0,c=n;m<c.length;m++){var y=c[m];y.label=o[y.value]}if(e.includeSizeVariable){var v=l.geometryType,f=null;if("polygon"===v){var b=a,g=b.sizeScheme,h=g.background;i.backgroundFillSymbol=s.createSymbol(h,h.color,l.geometryType,e.symbolType),f=g.marker.size,v="point"}else if("polyline"===v){var S=a;f=S.width}else{var x=a;f=x.size}var T=s.createColors(a.colors,n.length);n.forEach(function(r,i){r.symbol=s.createSymbol(a,T[i],v,e.symbolType,e.colorMixMode,e.edgesType,f)})}return{renderer:i,predominantCategoryInfos:n,excludedCategoryInfos:r.excludedUniqueValueInfos,predominanceScheme:a,basemapId:r.basemapId}})})}function h(e,r,a){return o.createVisualVariables({layer:e.layer,basemap:e.basemap,valueExpression:r.valueExpression,sqlExpression:r.statisticsQuery.sqlExpression,sqlWhere:r.statisticsQuery.sqlWhere,sizeScheme:a,worldScale:e.symbolType.indexOf("3d-volumetric")>-1,legendOptions:{title:i.sumOfCategories},view:e.view})}function S(e,r){return p({layer:e.layer,valueExpression:r.valueExpression,sqlExpression:r.statisticsQuery.sqlExpression,sqlWhere:r.statisticsQuery.sqlWhere,view:e.view}).then(function(a){var l=null==a.avg||null==a.stddev,o=1/e.fields.length*100,t=l?100:a.avg+1.285*a.stddev;t>100&&(t=100);var s=n.round([o,t],{strictBounds:!0}),p=new v({valueExpression:r.valueExpression,stops:[{value:s[0],opacity:.15},{value:s[1],opacity:1}],legendOptions:{title:i.strengthOfPredominance}}),u=new y({type:"opacity",minSliderValue:a.min,maxSliderValue:a.max});return{visualVariable:p,statistics:a,defaultValuesUsed:l,authoringInfo:new c({visualVariables:[u]})}})}function x(e){return f(e).then(function(e){var r=e.layer,a=b({basemap:e.basemap,geometryType:r.geometryType,numColors:e.fields.length,predominanceScheme:e.predominanceScheme,worldScale:e.symbolType.indexOf("3d-volumetric")>-1,view:e.view}),i=a.scheme,n=e.fields.map(function(e){return e.name}),o=d.getPredominanceExpressions(r,n),t=g(e,o.predominantCategory,i,n),s=e.includeSizeVariable?h(e,o.size,i.sizeScheme):l.resolve(),p=e.includeOpacityVariable?S(e,o.opacity):l.resolve();return l.all([t,s,p]).then(function(e){var r=e[0],a=e[1],i=e[2],n=[];if(a&&(Array.prototype.push.apply(n,a.visualVariables.map(function(e){return e.clone()})),delete a.sizeScheme,r.size=a),i&&(n.push(i.visualVariable),r.opacity=i),n.length){var l=r.renderer.visualVariables||[];Array.prototype.push.apply(l,n),r.renderer.visualVariables=l}return r})})}Object.defineProperty(r,"__esModule",{value:!0}),r.createRenderer=x});