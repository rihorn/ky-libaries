// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.10/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/assignHelper","dojo/i18n!../../nls/smartMapping","../../../core/lang","../../../core/promiseUtils","./type","./support/utils","../support/utils","../symbology/relationship","../../support/AuthoringInfo"],function(e,r,a,l,n,i,o,s,t,d,u){function m(e){if(!(e&&e.layer&&e.view&&e.field1&&e.field2))return i.reject(s.createError("relationship-renderer:missing-parameters","'layer', 'view', 'field1' and 'field2' parameters are required"));var r=a({},e);if(r.symbolType=r.symbolType||"2d",r.defaultSymbolEnabled=null==r.defaultSymbolEnabled||r.defaultSymbolEnabled,r.classificationMethod=r.classificationMethod||"quantile",r.numClasses=r.numClasses||3,r.focus=r.focus||null,-1===b.indexOf(r.classificationMethod))return i.reject(s.createError("relationship-renderer:invalid-parameters","classification method "+r.classificationMethod+" is not supported"));if(r.numClasses<2||r.numClasses>4)return i.reject(s.createError("relationship-renderer:invalid-parameters","'numClasses' must be 2, 3 or 4"));if(e.focus&&-1===M.indexOf(e.focus))return i.reject(s.createError("relationship-renderer:invalid-parameters","'focus' must be 'HH', 'HL', 'LH', 'LL' or null"));var l=[0,1,2],n=t.createLayerAdapter(r.layer,l);return r.layer=n,n?n.load().then(function(){var e=n.geometryType,a=r.symbolType.indexOf("3d")>-1;if("mesh"===e)r.symbolType="3d-volumetric",r.colorMixMode=r.colorMixMode||"replace",r.edgesType=r.edgesType||"none";else{if(a&&("polyline"===e||"polygon"===e))return i.reject(s.createError("relationship-renderer:not-supported","3d symbols are not supported for polyline and polygon layers"));if(r.symbolType.indexOf("3d-volumetric")>-1&&(!r.view||"3d"!==r.view.type))return i.reject(s.createError("relationship-renderer:invalid-parameters","'view' parameter should be an instance of SceneView when 'symbolType' parameter is '3d-volumetric' or '3d-volumetric-uniform'"))}var l=r.field1,o=r.field2,t=[l.field,o.field];l.normalizationField&&t.push(l.normalizationField),o.normalizationField&&t.push(o.normalizationField);var d=s.verifyBasicFieldValidity(n,t,"relationship-renderer:invalid-parameters");return d?i.reject(d):r}):i.reject(s.createError("relationship-renderer:invalid-parameters","'layer' must be one of these types: "+t.getLayerTypeLabels(l).join(", ")))}function f(e){var r=e.relationshipScheme,a=e.basemap;if(r)r=d.cloneScheme(r);else{var l=d.getSchemes({basemap:e.basemap,geometryType:e.geometryType,theme:e.theme,worldScale:e.worldScale,view:e.view});r=l&&l.primaryScheme,a=l&&l.basemapId}return{scheme:r,basemapId:a}}function c(e,r){var a=n.clone(g[e]);return d.flatten2DArray(a,r)}function p(e,r){return c(e,r).map(function(e){return{value:e,count:0}})}function y(e,r,a,l){var n=e.field,i=e.normalizationField,o=r.field,s=r.normalizationField,t=a.map(function(e){return[e.minValue,e.maxValue]}),d=l.map(function(e){return[e.minValue,e.maxValue]}),u=t.length,m=L[u];return"\n  var field1 = $feature['"+n+"'];\n  var field2 = $feature['"+o+"'];\n  var hasNormField1 = "+(i?"true":"false")+";\n  var hasNormField2 = "+(s?"true":"false")+";\n  var normField1 = "+(i?"$feature['"+i+"']":"null")+";\n  var normField2 = "+(s?"$feature['"+s+"']":"null")+";\n\n  if (\n    IsEmpty(field1) ||\n    IsEmpty(field2) ||\n    (hasNormField1 && (IsEmpty(normField1) || normField1 == 0)) ||\n    (hasNormField2 && (IsEmpty(normField2) || normField2 == 0))\n  ) {\n    return null;\n  }\n\n  var value1 = IIf(hasNormField1, (field1 / normField1), field1);\n  var value2 = IIf(hasNormField2, (field2 / normField2), field2);\n\n  var breaks1 = "+JSON.stringify(t)+";\n  var breaks2 = "+JSON.stringify(d)+";\n  var classCodes = "+JSON.stringify(m)+";\n\n  function getClassCode(value, breaks) {\n    var code = null;\n\n    for (var i in breaks) {\n      var info = breaks[i];\n      if (value >= info[0] && value <= info[1]) {\n        code = classCodes[i];\n        break;\n      }\n    }\n\n    return code;\n  }\n\n  var code1 = getClassCode(value1, breaks1);\n  var code2 = getClassCode(value2, breaks2);\n\n  var classValue = IIf(IsEmpty(code1) || IsEmpty(code2), null, code1 + code2);\n  return classValue;\n  "}function v(e,r,n){var t=e.basemap,m=e.classificationMethod,c=e.field1,v=e.field2,h=e.focus,b=e.numClasses,M=e.layer,g=r.classBreakInfos,L=n.classBreakInfos;if(b!==g.length||g.length!==L.length)return i.reject(s.createError("relationship-renderer:error","incompatible class breaks"));var H=p(b,h),V=y(e.field1,e.field2,g,L),I=f({basemap:t,geometryType:M.geometryType,theme:"default",relationshipScheme:e.relationshipScheme,worldScale:e.symbolType.indexOf("3d-volumetric")>-1,view:e.view}),T=I.scheme;return o.createRenderer({layer:M,basemap:t,valueExpression:V,valueExpressionTitle:l.relationship.legendTitle,numTypes:-1,sortEnabled:!1,defaultSymbolEnabled:e.defaultSymbolEnabled,typeScheme:a({colors:d.getColors(T,b,h)},T),statistics:{uniqueValueInfos:H},legendOptions:e.legendOptions,symbolType:e.symbolType,colorMixMode:e.colorMixMode,edgesType:e.edgesType,view:e.view}).then(function(e){for(var a=e.renderer,i=a.uniqueValueInfos,o=l.relationship,s=0,t=i;s<t.length;s++){var d=t[s];d.label=o[d.value]}var f=new u({type:"relationship",classificationMethod:m,numClasses:b,focus:h,field1:{field:c.field,normalizationField:c.normalizationField,classBreakInfos:g.map(F)},field2:{field:v.field,normalizationField:v.normalizationField,classBreakInfos:L.map(F)}});return a.authoringInfo=f,{renderer:a,classBreaks:{field1:r,field2:n},uniqueValueInfos:e.uniqueValueInfos,relationshipScheme:T,basemapId:e.basemapId}})}function h(e){return m(e).then(function(e){var r=e.layer,a=e.classificationMethod,l=e.field1,n=e.field2,o=e.numClasses,t=e.view,d=[s.getClassBreaks({layer:r,classificationMethod:a,field:l.field,normalizationField:l.normalizationField,normalizationType:l.normalizationField?"field":null,minValue:l.minValue,maxValue:l.maxValue,analyzeData:!(null!=l.minValue&&null!=l.maxValue),numClasses:o,view:t}),s.getClassBreaks({layer:r,classificationMethod:a,field:n.field,normalizationField:n.normalizationField,normalizationType:n.normalizationField?"field":null,minValue:n.minValue,maxValue:n.maxValue,analyzeData:!(null!=n.minValue&&null!=n.maxValue),numClasses:o,view:t})];return i.all(d).then(function(r){var a=r[0],l=r[1];return a&&l?v(e,a.result,l.result):i.reject(s.createError("relationship-renderer:error","error when calculating class breaks"))})})}Object.defineProperty(r,"__esModule",{value:!0});var b=["equal-interval","natural-breaks","quantile"],M=["HH","HL","LH","LL"],g={2:[["HL","HH"],["LL","LH"]],3:[["HL","HM","HH"],["ML","MM","MH"],["LL","LM","LH"]],4:[["HL","HM1","HM2","HH"],["M2L","M2M1","M2M2","M2H"],["M1L","M1M1","M1M2","M1H"],["LL","LM1","LM2","LH"]]},L={2:["L","H"],3:["L","M","H"],4:["L","M1","M2","H"]},F=function(e){return{minValue:e.minValue,maxValue:e.maxValue}};r.createRenderer=h});