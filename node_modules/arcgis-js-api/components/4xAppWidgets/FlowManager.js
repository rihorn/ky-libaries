// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.10/esri/copyright.txt for details.

define(["require","exports","../../core/tsSupport/declareExtendsHelper","../../core/tsSupport/decorateHelper","dojo/i18n!../../nls/common","dojo/keys","../../core/Collection","../../core/Handles","../../core/watchUtils","../../core/accessorSupport/decorators","../../widgets/Widget","./FlowManager/FlowManagerViewModel","../../widgets/support/widget"],function(e,t,n,o,i,r,a,s,c,l,d,u,h){"use strict";var f=["active","className","disabled","id","title","image","visible","indicator"],g={base:"esri-flow-manager",animationFrame:"esri-flow-manager__frame",frameAdvancing:"esri-flow-manager__frame--advancing",frameRetreating:"esri-flow-manager__frame--retreating",childFrame:"esri-flow-manager__frame--child",header:"esri-flow-manager__header",childHeader:"esri-flow-manager__header--child",headerButton:"esri-flow-manager__header-button",headerPreviousButton:"esri-flow-manager__header-previous-button",headerPreviousButtonIcon:"esri-flow-manager__header-previous-icon",headerMenuDropdown:"esri-flow-manager__header-dropdown",headerMenuButton:"esri-flow-manager__header-menu-button",headerMenuButtonIcon:"esri-flow-manager__header-menu-icon",title:"esri-flow-manager__title",childTitle:"esri-flow-manager__title--child",content:"esri-flow-manager__content",contentChild:"esri-flow-manager__content--child",footer:"esri-flow-manager__footer",menu:"esri-flow-manager__menu esri-menu",menuItem:"esri-flow-manager__menu-item",action:"esri-flow-manager__action",actionDisabled:"esri-flow-manager__action--disabled",actionIndicator:"esri-flow-manager__action--indicator",actionIcon:"esri-flow-manager__action-icon",actionIconImage:"esri-flow-manager__action-icon--image",actionTitle:"esri-flow-manager__action-title",esriButton:"esri-button",esriButtonSecondary:"esri-button--secondary",esriButtonTertiary:"esri-button--tertiary",iconLoading:"esri-icon-loading-indicator",iconMenu:"esri-icon-handle-horizontal",iconLeftChevron:"esri-icon-left",iconRightChevron:"esri-icon-right",rotating:"esri-rotating",text:"esri-icon-font-fallback-text"};return function(e){function t(t){var n=e.call(this)||this;return n._handles=new s,n._menuOpen=!1,n._actionsMenuNode=null,n._focusActionsMenuButton=!1,n._focusFirstMenuAction=!1,n.viewModel=new u,n.own([n.on("trigger-form-action",function(e){"cancel"===e.action.id&&n._close()}),n.watch("activeFlow",function(){return n._closeMenu()}),n.on("trigger-menu-action",function(){return n._closeMenu()})]),n}return n(t,e),t.prototype.destroy=function(){this._handles&&this._handles.destroy()},t.prototype.render=function(){var e,t,n,o,r=this,a=r._menuOpen,s=r.activeFlow,c=r.parentFlow,l=this.viewModel.flowDirection,d=!!c,u=(e={},e[g.iconLeftChevron]=!0,e[g.iconRightChevron]=!1,e),f=d?h.tsx("button",{class:this.classes(g.headerButton,g.headerPreviousButton),title:i.pagination.previous,"aria-label":i.pagination.previous,bind:this,onclick:this._closeFlow,onkeydown:this._closeFlow},h.tsx("span",{"aria-hidden":"true",class:this.classes(g.headerPreviousButtonIcon,u)})):null,p="retreating"===l?g.frameRetreating:"advancing"===l?g.frameAdvancing:null,_=(t={},t[g.childFrame]=d,t),m=(n={},n[g.childHeader]=d,n),v=(o={},o[g.childTitle]=d,o),w=this._renderMenuActions(s&&s.menuActions),y=a?i.close:i.open,M=w.length?h.tsx("button",{class:this.classes(g.headerButton,g.headerMenuButton),title:y,"aria-label":y,bind:this,afterCreate:this._focusActionsMenuButtonNode,afterUpdate:this._focusActionsMenuButtonNode,onclick:this._toggleActionsMenu,onkeydown:this._toggleActionsMenu},h.tsx("span",{"aria-hidden":"true",class:this.classes(g.headerMenuButtonIcon,g.iconMenu)})):null,b=a&&w.length?h.tsx("ul",{key:"menu",class:g.menu,bind:this,afterCreate:h.storeNode,afterUpdate:h.storeNode,"data-node-ref":"_actionsMenuNode"},w):null,A=w.length?h.tsx("div",{class:g.headerMenuDropdown},M,b):null,F=s&&s.title,x=h.tsx("div",{key:"header",class:this.classes(g.header,m),role:"presentation"},f,h.tsx("h2",{class:this.classes(g.title,v)},F),A),B=this._renderContent(s),k=this._renderFormActions(s&&s.formActions),I=s&&d&&k.length?h.tsx("div",{key:"footer",class:g.footer},k):null,T=s?[x,B,I]:null;return h.tsx("div",{class:g.base},h.tsx("div",{key:s,class:this.classes(g.animationFrame,_,p)},T))},t.prototype._attachToNode=function(e){var t=this;e.appendChild(t)},t.prototype._renderContent=function(e){var t;if(!e)return null;var n=e.content,o=!!this.parentFlow,i=(t={},t[g.contentChild]=o,t);return"string"==typeof n?h.tsx("div",{class:this.classes(g.content,i),key:n,innerHTML:n}):"object"==typeof n&&n.render&&"function"==typeof n.render?h.tsx("div",{class:this.classes(g.content,i),key:n},n.render()):n instanceof HTMLElement?h.tsx("div",{class:this.classes(g.content,i),key:n,bind:n,afterCreate:this._attachToNode}):void 0},t.prototype._renderMenuActions=function(e){var t=this;return this._handles.remove("menu-actions"),e&&a.isCollection(e)?e.map(function(e,n){return t._renderMenuAction(e,n)}).filter(Boolean).toArray():[]},t.prototype._focusActionsMenuButtonNode=function(e){this._focusActionsMenuButton&&(this._focusActionsMenuButton=!1,e.focus())},t.prototype._renderMenuAction=function(e,t){var n,o,i=this;if(e){var r=c.watch(e,f,function(){return i.scheduleRender()});this._handles.add(r,"menu-actions");var a=e,s=a.active,l=a.disabled,d=a.title,u=a.className,p=a.image,_=a.indicator,m=a.visible,v=(n={},n[g.iconLoading]=s,n[u]=!!u,n[g.rotating]=s,n[g.actionIconImage]=!!p,n),w=(o={},o[g.actionDisabled]=l,o[g.actionIndicator]=_,o);if(m){var y=0===t?this._actionsMenuNodeUpdated:null;return h.tsx("li",{role:"menuitem",title:d,"aria-label":d,class:g.menuItem},h.tsx("button",{tabIndex:0,key:e,class:this.classes(g.action,w),bind:this,"data-action":e,"data-action-index":t,afterCreate:y,afterUpdate:y,onclick:this._triggerMenuAction,onkeydown:this._triggerMenuAction,onkeyup:this._handleActionKeyup,disabled:l},h.tsx("span",{key:"icon","aria-hidden":"true",class:this.classes(g.actionIcon,v),styles:this._getIconStyles(p)}),h.tsx("span",{key:"text",class:g.actionTitle},d)))}}},t.prototype._actionsMenuNodeUpdated=function(e){e&&this._focusFirstMenuAction&&(this._focusFirstMenuAction=!1,e.focus())},t.prototype._renderFormActions=function(e){var t=this;return this._handles.remove("form-actions"),e&&a.isCollection(e)?e.map(function(e){return t._renderFormAction(e)}).filter(Boolean).toArray():[]},t.prototype._renderFormAction=function(e){var t,n,o=this;if(e){var i=c.watch(e,f,function(){return o.scheduleRender()});this._handles.add(i,"form-actions");var r=e,a=r.active,s=r.disabled,l=r.title,d=r.className,u=r.image,p=r.indicator,_=r.visible,m=(t={},t[g.iconLoading]=a,t[g.rotating]=a,t[d]=!!d,t[g.actionIconImage]=!!u,t),v=(n={},n[g.esriButton]="primary"===e.buttonType,n[g.esriButtonSecondary]="secondary"===e.buttonType,n[g.esriButtonTertiary]="tertiary"===e.buttonType,n[g.actionDisabled]=s,n[g.actionIndicator]=p,n);if(_)return h.tsx("button",{key:e,tabIndex:0,title:l,"aria-label":l,class:this.classes(g.esriButton,g.action,v),bind:this,"data-action":e,onclick:this._triggerFormAction,onkeydown:this._triggerFormAction,disabled:s},h.tsx("span",{key:"icon","aria-hidden":"true",class:this.classes(g.actionIcon,m),styles:this._getIconStyles(u)}),h.tsx("span",{key:"text",class:g.actionTitle},l))}},t.prototype._getIconStyles=function(e){return{"background-image":e?"url("+e+")":""}},t.prototype._closeMenu=function(){this._menuOpen=!1,this.scheduleRender()},t.prototype._close=function(){this.parentFlow&&this.flows.pop()},t.prototype._handleActionKeyup=function(e){var t=e.keyCode;t===r.ESCAPE&&(e.stopPropagation(),this._menuOpen=!1,this._focusActionsMenuButton=!0,this.scheduleRender());var n=this._actionsMenuNode,o=this.get("activeFlow.menuActions.length"),i=e.currentTarget,a=i["data-action-index"];if(n){var s=n.querySelectorAll("li");if(t===r.UP_ARROW){e.stopPropagation();var c=a-1,l=(c+o)%o;return void s[l].focus()}if(t===r.DOWN_ARROW){e.stopPropagation();var d=a+1,l=(d+o)%o;return void s[l].focus()}if(t===r.HOME){e.stopPropagation();return void s[0].focus()}if(t===r.END){e.stopPropagation();return void s[s.length-1].focus()}}},t.prototype._toggleActionsMenu=function(){var e=!this._menuOpen;this._menuOpen=e,e?this._focusFirstMenuAction=!0:this._focusActionsMenuButton=!0,this.scheduleRender()},t.prototype._closeFlow=function(){this._close()},t.prototype._triggerMenuAction=function(e){var t=e.currentTarget&&e.currentTarget["data-action"];t&&this.viewModel.triggerMenuAction(t)},t.prototype._triggerFormAction=function(e){var t=e.currentTarget&&e.currentTarget["data-action"];t&&this.viewModel.triggerFormAction(t)},o([h.renderable(),l.aliasOf("viewModel.activeFlow")],t.prototype,"activeFlow",void 0),o([h.renderable(),l.aliasOf("viewModel.flows")],t.prototype,"flows",void 0),o([h.renderable(),l.aliasOf("viewModel.parentFlow")],t.prototype,"parentFlow",void 0),o([l.property(),h.renderable(["viewModel.activeFlow","viewModel.flows","viewModel.parentFlow","viewModel.flowDirection"]),h.vmEvent(["triggerMenuAction","trigger-menu-action"]),h.vmEvent(["triggerFormAction","trigger-form-action"])],t.prototype,"viewModel",void 0),o([h.accessibleHandler()],t.prototype,"_toggleActionsMenu",null),o([h.accessibleHandler()],t.prototype,"_closeFlow",null),o([h.accessibleHandler()],t.prototype,"_triggerMenuAction",null),o([h.accessibleHandler()],t.prototype,"_triggerFormAction",null),t=o([l.subclass("esri.widgets.FlowManager")],t)}(l.declared(d))});