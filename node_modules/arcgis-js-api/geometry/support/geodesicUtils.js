// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.10/esri/copyright.txt for details.

define(["require","exports","../../core/Error","../../core/Logger","../../core/unitUtils","../Point","../Polygon","../Polyline","../SpatialReference"],function(e,t,a,r,i,n,s,o,h){function f(e){return e&&p(e)?S[e.wkid]:S[q]}function u(e,t,a){var r,i=f(a),n=i.a,s=i.eSq,o=Math.sqrt(s),h=Math.sin(t[1]*y),u=n*t[0]*y;if(s>0){r=n*((1-s)*(h/(1-s*(h*h))-1/(2*o)*Math.log((1-o*h)/(1+o*h))))*.5}else r=n*h;return e[0]=u,e[1]=r,e}function p(e){return!!(e&&e.wkid&&S[e.wkid])}function c(e,t){if(e.some(function(e){return!p(e.spatialReference)}))throw v.error("invalid spatialreference: the input geometries spatialreference is not supported"),new a("geodesic-areas:invalid-spatial-reference","the input geometries spatial reference is not supported");for(var r=[],n=0;n<e.length;n++){var s=e[n],o=s.spatialReference,h=f(o).radius,c=h*m;r.push(d(s,c))}for(var l=[],g=0;g<r.length;g++){for(var M=r[g],y=M.rings,o=M.spatialReference,q=0,b=0;b<y.length;b++){var S=y[b];u(w,S[0],o),u(R,S[S.length-1],o);for(var D=R[0]*w[1]-w[0]*R[1],P=0;P<S.length-1;P++)u(w,S[P+1],o),u(R,S[P],o),D+=R[0]*w[1]-w[0]*R[1];q+=D}q=i.convertUnit(q,"square-meters",t),l.push(q/-2)}return l}function l(e,t){var r=e,n=e;if(!r&&!n)throw v.error("invalid geometry type: the input geometries type is not supported"),new a("geodesic-lengths:invalid-geometries","the input geometries type is not supported");if(r?r.some(function(e){return!p(e.spatialReference)}):n.some(function(e){return!p(e.spatialReference)}))throw v.error("invalid spatialreference: the input geometries spatialreference is not supported"),new a("geodesic-lengths:invalid-spatial-reference","the input geometries spatial reference is not supported");for(var s=[],o=0;o<e.length;o++){for(var h=e[o],f=h.spatialReference,u="polyline"===h.type?h.paths:h.rings,c=0,l=0;l<u.length;l++){for(var d=u[l],g=0,q=1;q<d.length;q++){var b=d[q-1][0]*y,m=d[q][0]*y,S=d[q-1][1]*y,w=d[q][1]*y;if(S!==w||b!==m){g+=M(S,b,w,m,f).geodesicDistance}}c+=g}c=i.convertUnit(c,"meters",t),s.push(c)}return s}function d(e,t){if("polyline"!==e.type&&"polygon"!==e.type)throw v.error("invalid geometry: the input geometry is neither polyline nor polygon"),new a("geodesic-densify:invalid-geometry","the input geometry is neither polyline nor polygon");if(!p(e.spatialReference))throw v.error("invalid spatialreference: the input geometry spatialreference is not supported"),new a("geodesic-densify:invalid-spatial-reference","the input geometry spatial reference is not supported");var r=e.spatialReference,i=f(r).radius,n=i/1e4;t<n&&(t=n);for(var h="polyline"===e.type?e.paths:e.rings,u=[],c=0,l=h;c<l.length;c++){var d=l[c],q=[];u.push(q),q.push([d[0][0],d[0][1]]);for(var b=d[0][0]*y,m=d[0][1]*y,S=void 0,w=void 0,R=0;R<d.length-1;R++)if(S=d[R+1][0]*y,w=d[R+1][1]*y,b!==S||m!==w){var D=M(m,b,w,S,r),P=D.azimuth,x=D.geodesicDistance,k=x/t;if(k>1){for(var z=1;z<=k-1;z++){var U=z*t,L=g(m,b,P,U,r);q.push([L.x,L.y])}var A=(x+Math.floor(k-1)*t)/2,G=g(m,b,P,A,r);q.push([G.x,G.y])}var I=g(m,b,P,x,r);q.push([I.x,I.y]),b=I.x*y,m=I.y*y}}return"polyline"===e.type?new o({paths:u,spatialReference:r}):new s({rings:u,spatialReference:r})}function g(e,t,a,r,i){for(var s,o,h,u,p=f(i),c=p.a,l=p.b,d=p.f,g=Math.sin(a),M=Math.cos(a),v=(1-d)*Math.tan(e),q=1/Math.sqrt(1+v*v),m=v*q,S=Math.atan2(v,M),w=q*g,R=w*w,D=1-R,P=D*(c*c-l*l)/(l*l),x=1+P/16384*(4096+P*(P*(320-175*P)-768)),k=P/1024*(256+P*(P*(74-47*P)-128)),z=r/(l*x),U=2*Math.PI;Math.abs(z-U)>1e-12;)h=Math.cos(2*S+z),s=Math.sin(z),o=Math.cos(z),u=k*s*(h+k/4*(o*(2*h*h-1)-k/6*h*(4*s*s-3)*(4*h*h-3))),U=z,z=r/(l*x)+u;var L=m*s-q*o*M,A=Math.atan2(m*o+q*s*M,(1-d)*Math.sqrt(R+L*L)),G=Math.atan2(s*g,q*o-m*s*M),I=d/16*D*(4+d*(4-3*D));return new n((t+(G-(1-I)*d*w*(z+I*s*(h+I*o*(2*h*h-1)))))/y,A/y,i||b)}function M(e,t,a,r,i){var n,s,o,h,u,p,c,l,d,g,M=f(i),v=M.a,y=M.b,q=M.f,b=M.radius,m=r-t,S=Math.atan((1-q)*Math.tan(e)),w=Math.atan((1-q)*Math.tan(a)),R=Math.sin(S),D=Math.cos(S),P=Math.sin(w),x=Math.cos(w),k=1e3,z=m;do{if(c=Math.sin(z),l=Math.cos(z),0===(o=Math.sqrt(x*c*(x*c)+(D*P-R*x*l)*(D*P-R*x*l))))return{geodesicDistance:0};u=R*P+D*x*l,p=Math.atan2(o,u),d=D*x*c/o,s=1-d*d,h=u-2*R*P/s,isNaN(h)&&(h=0),g=q/16*s*(4+q*(4-3*s)),n=z,z=m+(1-g)*q*d*(p+g*o*(h+g*u*(2*h*h-1)))}while(Math.abs(z-n)>1e-12&&--k>0);if(0===k){var U=b,L=Math.acos(Math.sin(e)*Math.sin(a)+Math.cos(e)*Math.cos(a)*Math.cos(r-t))*U,A=r-t,G=Math.sin(A)*Math.cos(a),I=Math.cos(e)*Math.sin(a)-Math.sin(e)*Math.cos(a)*Math.cos(A);return{azimuth:Math.atan2(G,I),geodesicDistance:L}}var N=s*(v*v-y*y)/(y*y),_=1+N/16384*(4096+N*(N*(320-175*N)-768)),j=N/1024*(256+N*(N*(74-47*N)-128)),E=j*o*(h+j/4*(u*(2*h*h-1)-j/6*h*(4*o*o-3)*(4*h*h-3))),O=y*_*(p-E);return{azimuth:Math.atan2(x*Math.sin(z),D*P-R*x*Math.cos(z)),geodesicDistance:O,reverseAzimuth:Math.atan2(D*Math.sin(z),D*P*Math.cos(z)-R*x)}}Object.defineProperty(t,"__esModule",{value:!0});var v=r.getLogger("esri.geometry.support.geodesicUtils"),y=Math.PI/180,q=4326,b=new h({wkid:q}),m=.0015696101447650193,S={4326:{a:6378137,b:6356752.31424518,f:1/298.257223563,eSq:.006694379990197414,radius:6371008.771415059},104900:{a:2439700,b:2439700,f:0,eSq:0,radius:2439700},104901:{a:6051e3,b:6051e3,f:0,eSq:0,radius:6051e3},104902:{a:6051800,b:6051800,f:0,eSq:0,radius:6051800},104903:{a:1737400,b:1737400,f:0,eSq:0,radius:1737400},104904:{a:3393400,b:3375730,f:1/192.04301075,eSq:.01038722,radius:3387510},104905:{a:3396190,b:3376200,f:1/169.89444722,eSq:.01173737,radius:3389526.6666666665},104906:{a:6200,b:6200,f:0,eSq:0,radius:6200},104907:{a:11100,b:11100,f:0,eSq:0,radius:11100},104912:{a:2409300,b:2409300,f:0,eSq:0,radius:2409300},104915:{a:1562090,b:1562090,f:0,eSq:0,radius:1562090},104916:{a:2632345,b:2632345,f:0,eSq:0,radius:2632345},104918:{a:1821460,b:1821460,f:0,eSq:0,radius:1821460},104929:{a:249400,b:249400,f:0,eSq:0,radius:249400},104943:{a:2575e3,b:2575e3,f:0,eSq:0,radius:2575e3},104971:{a:3396190,b:3396190,f:0,eSq:0,radius:3396190},104972:{a:47e4,b:47e4,f:0,eSq:0,radius:47e4},104973:{a:255e3,b:255e3,f:0,eSq:0,radius:255e3},104974:{a:2439400,b:2439400,f:0,eSq:0,radius:2439400}},w=[0,0],R=[0,0];t.isSupported=p,t.geodesicAreas=c,t.geodesicLengths=l,t.geodesicDensify=d,t.directGeodeticSolver=g,t.inverseGeodeticSolver=M});