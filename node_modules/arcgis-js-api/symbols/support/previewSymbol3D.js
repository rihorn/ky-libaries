// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.10/esri/copyright.txt for details.

define(["require","exports","../../core/Error","../../core/Logger","../../core/promiseUtils","../../core/screenUtils","./gfxUtils","./previewUtils","./renderUtils","./styleUtils","./utils"],function(e,a,t,r,l,s,i,o,n,h,p){function u(e){var a=e.outline,t=e.get("material.color"),r=t&&t.toRgba().toString();if(!a)return"fill"===e.type&&"255,255,255,1"===r?{color:"#bdc3c7",width:.75}:null;var l=s.pt2px(a.size)||0;return{color:"rgba("+(null!=a.color?a.color.toRgba():"255,255,255,1")+")",width:Math.min(l,j)}}function c(e,a){var t=a&&a.resource,r=t&&t.href;return e.thumbnail&&e.thumbnail.url?l.resolve(e.thumbnail.url):r&&"object"!==a.type?l.resolve(p.getIconHref(e,a)):e.styleOrigin&&(e.styleOrigin.styleName||e.styleOrigin.styleUrl)?h.resolveWebStyleSymbol(e.styleOrigin,{portal:e.styleOrigin.portal}).catch(function(e){return e}).then(function(e){return e&&e.thumbnail&&e.thumbnail.url||z}):l.resolve(z)}function m(e,a){return Math.min(Math.max(e+255*a*.75,0),255)}function f(e,a){if(void 0===a&&(a=0),!e.material||!e.material.color){var t=i.defaultThematicColor.r,r=m(t,a);return[r,r,r,100]}for(var l=e.material.color.toRgb(),s=0;s<3;s++)l[s]=m(l[s],a);return l.push(e.material.color.a),l}function v(e){return e.outline?u(e):{color:"rgba(0, 0, 0, 1)",width:1.5}}function d(e,a){if(!e.material)return{};for(var t=e.material.color.toRgb(),r="rgba(",l=0;l<3;l++)r+=m(t[l],a)+",";r+=e.material.color.a+");";var i=e.size?s.pt2px(e.size):.75;return{color:r,width:Math.min(i,j)}}function y(e,a,t){var r=.75*t;return{type:"linear",x1:r?.25*r:0,y1:r?.5*r:0,x2:r||4,y2:r?.5*r:4,colors:[{color:e,offset:0},{color:a,offset:1}]}}function b(e){var a=e.depth,t=e.height,r=e.width;return r&&a&&t&&r===a&&r<t}function g(e,a,t,r){var l=e&&e.type,s="icon"===l,i="object"===l,n=[];if(s){var h=e,p=t,c=t;switch(a){case"circle":n.push({shape:{type:"circle",cx:0,cy:0,r:.5*t},fill:f(h,0),stroke:u(h)});break;case"square":n.push({shape:{type:"path",path:[{command:"M",values:[0,c]},{command:"L",values:[0,0]},{command:"L",values:[p,0]},{command:"L",values:[p,c]},{command:"Z",values:[]}]},fill:f(h,0),stroke:u(h)});break;case"triangle":n.push({shape:{type:"path",path:[{command:"M",values:[0,c]},{command:"L",values:[.5*p,0]},{command:"L",values:[p,c]},{command:"Z",values:[]}]},fill:f(h,0),stroke:u(h)});break;case"cross":n.push({shape:{type:"path",path:[{command:"M",values:[.5*p,0]},{command:"L",values:[.5*p,c]},{command:"M",values:[0,.5*c]},{command:"L",values:[p,.5*c]},{command:"E",values:[]}]},stroke:v(h)});break;case"x":n.push({shape:{type:"path",path:[{command:"M",values:[0,0]},{command:"L",values:[p,c]},{command:"M",values:[p,0]},{command:"L",values:[0,c]},{command:"E",values:[]}]},stroke:v(h)});break;case"kite":n.push({shape:{type:"path",path:[{command:"M",values:[0,.5*c]},{command:"L",values:[.5*p,0]},{command:"L",values:[p,.5*c]},{command:"L",values:[.5*p,c]},{command:"Z",values:[]}]},fill:f(h,0),stroke:u(h)})}}else if(i){var m=e;switch(a){case"cone":var d=f(m,0),b=f(m,-.6),g=r?D:t,x=y(d,b,g),w=o.getConeShapes(t,r);n.push({shape:w[0],fill:x}),n.push({shape:w[1],fill:x});break;case"inverted-cone":var M=f(m,0),k=f(m,-.6),S=y(M,k,t),L=o.getInvertedConeShapes(t);n.push({shape:L[0],fill:S}),n.push({shape:L[1],fill:M});break;case"cube":var z=o.getCubeShapes(t,r);n.push({shape:z[0],fill:f(m,0)}),n.push({shape:z[1],fill:f(m,-.3)}),n.push({shape:z[2],fill:f(m,-.5)});break;case"cylinder":var U=f(m,0),E=f(m,-.6),j=r?D:t,C=y(U,E,j),I=o.getCylinderShapes(t,r);n.push({shape:I[0],fill:C}),n.push({shape:I[1],fill:C}),n.push({shape:I[2],fill:f(m,0)});break;case"diamond":var O=o.getDiamondShapes(t);n.push({shape:O[0],fill:f(m,-.3)}),n.push({shape:O[1],fill:f(m,0)}),n.push({shape:O[2],fill:f(m,-.3)}),n.push({shape:O[3],fill:f(m,-.7)});break;case"sphere":var P=f(m,0),R=f(m,-.6),A=y(P,R);A.x1=0,A.y1=0,A.x2=.25*t,A.y2=.25*t,n.push({shape:{type:"circle",cx:0,cy:0,r:.5*t},fill:A});break;case"tetrahedron":var T=o.getTetrahedronShapes(t);n.push({shape:T[0],fill:f(m,-.3)}),n.push({shape:T[1],fill:f(m,0)}),n.push({shape:T[2],fill:f(m,-.6)})}}return n}function x(e){return"icon"===e.type?"multiply":"tint"}function w(e){return"icon"===e.type?"circle":"sphere"}function M(e,a){var t,r=a&&a.size?s.pt2px(a.size):null,i=a&&a.maxSize?s.pt2px(a.maxSize):null,o=a&&a.disableUpsampling,h=e.symbolLayers,p=[],m=0,f=0,v=h.getItemAt(h.length-1);return v&&"icon"===v.type&&(t=v.size&&s.pt2px(v.size)),h.forEach(function(h,v){if("icon"===h.type||"object"===h.type){var d="icon"===h.type?h.size&&s.pt2px(h.size):0,y=r||d?Math.ceil(Math.min(r||d,i||E)):U,M=u(h),k=M?M.width:0;if(h&&h.resource&&h.resource.href){var S=c(e,h).then(function(e){var a=h.get("material.color"),t=x(h);return n.tintImageWithColor(e,y,a,t,o)}).then(function(e){var a=e.width,t=e.height;return m=Math.max(m,a+k+O),f=Math.max(f,t+k+O),[{shape:{type:"image",width:a,height:t,src:e.url},fill:null,stroke:null}]});p.unshift(S)}else{var L=h.get("resource.primitive"),z=L||w(h),j=y;"icon"===h.type&&t&&r&&(j=y*(d/t));var C=a&&"tall"===a.symbolConfig||"object"===h.type&&b(h);m=Math.max(m,C?D:j+k+O),f=Math.max(f,j+k+O),p.unshift(l.resolve(g(h,z,j,C)))}}}),l.eachAlways(p).then(function(e){var t=[];return e.forEach(function(e){e.value?t.push(e.value):e.error&&I.warn("error while building swatchInfo!",e.error)}),n.renderSymbol(t,[m,f],{node:a&&a.node,scale:!1})})}function k(e,a){var t,r=e.symbolLayers,i=[],h=p.isVolumetricSymbol(e),u=a&&a.size?s.pt2px(a.size):null,c=a&&a.maxSize?s.pt2px(a.maxSize):null,m=c||j,v=0,y=0;return r.forEach(function(e,a){var r=e&&e.type,l="line"===r,s="path"===r;if(l||s){var n=d(e,0),h=n&&n.width||0,p=[];if(l){0===a&&(t=h);var c=Math.min(u||h,m),b=0===a?c:u?c*(h/t):c,g=b>U?b+O:C;y=Math.max(y,b),v=Math.max(v,g),n.width=b,p.push({shape:{type:"path",path:[{command:"M",values:[0,.5*y]},{command:"L",values:[v,.5*y]},{command:"E",values:[]}]},stroke:n})}else{var x=Math.min(u||U,m),w=f(e,0),M=f(e,-.2),k=d(e,-.4);k.width=1,p.push({shape:o.shapes.pathSymbol3DLayer[0],fill:M,stroke:k}),p.push({shape:o.shapes.pathSymbol3DLayer[1],fill:w,stroke:k}),y=Math.max(y,x+1+O),v=y}i.push(p)}}),l.resolve(n.renderSymbol(i,[v,y],{node:a&&a.node,scale:h}))}function S(e,a){for(var t=e.type,r="mesh-3d"===t,i=e.symbolLayers,h=a&&a.size?s.pt2px(a.size):null,p=a&&a.maxSize?s.pt2px(a.maxSize):null,c=h||U,m=[],v=0,y=0,b=!1,g=0;g<i.length;g++){var x=i.getItemAt(g),w=x.type,M="fill"===w,k="line"===w,S="extrude"===x.type,L=[];if(r&&!M)return;var z=o.shapes.fill[0];if(M){var j=u(x),C=j&&j.width||0;v=Math.max(v,c+C),y=Math.max(y,c+C),b=!0,L.push({shape:z,fill:f(x,0),stroke:j})}else if(k){var D=d(x,0),I=D&&D.width||0,P={stroke:D,shape:z};v=Math.max(v,U+I),y=Math.max(y,U+I),L.push(P)}else if(S){var R=d(x,-.4),A=f(x,0),T=f(x,-.2),Z=Math.min(c,p||E),q=o.getExtrudeSymbolShapes(Z);R.width=1,L.push({shape:q[0],fill:T,stroke:R}),L.push({shape:q[1],fill:T,stroke:R}),L.push({shape:q[2],fill:A,stroke:R});var H=U,N=.7*U+.5*Z;v=Math.max(v,H+R.width+O),y=Math.max(y,N+R.width+O)}m.push(L)}return l.resolve(n.renderSymbol(m,[v,y],{node:a&&a.node,scale:b}))}function L(e,a){if(0===e.symbolLayers.length)return l.reject(new t("symbolPreview: renderPreviewHTML3D","No symbolLayers in the symbol."));var r=null;switch(e.type){case"point-3d":r=M(e,a);break;case"line-3d":r=k(e,a);break;case"polygon-3d":case"mesh-3d":r=S(e,a)}return r||l.reject(new t("symbolPreview: swatchInfo3D","symbol not supported."))}Object.defineProperty(a,"__esModule",{value:!0});var z=e.toUrl("../../images/Legend/legend3dsymboldefault.png"),U=22,E=120,j=80,C=40,D=20,I=r.getLogger("esri.symbols.support.previewSymbol3D"),O=1;a.getSymbolLayerFill=f,a.previewSymbol3D=L});