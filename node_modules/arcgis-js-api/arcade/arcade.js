// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.10/esri/copyright.txt for details.

define(["require","exports","./arcadeCompiler","./arcadeRuntime","./parser","./treeAnalysis","../core/has","../core/promiseUtils"],function(require,exports,ArcadeCompiler,ArcadeRuntime,ArcadeParser,TreeAnalysis,has,promiseUtils){function evaluates(statement){try{return eval(statement),!0}catch(e){return!1}}function compileScript(e,r){if(!0===r.useAsync||!0===e.isAsync)return compileScriptAsync(e,r);if(has("csp-restrictions")){return function(r,t){return ArcadeRuntime.executeScript(e,r,t)}}return ArcadeCompiler.compileScript(e,r)}function compileScriptAsync(e,r){if(null===_asyncRuntime)throw new Error("Async Arcade must be enabled for this script");if(has("csp-restrictions")||!1===hasGenerators){return function(r,t){return _asyncRuntime.executeScript(e,r,t)}}return ArcadeCompiler.compileScript(e,r,!0)}function extend(e){ArcadeRuntime.extend(e),ArcadeCompiler.extend(e,"sync"),null===_asyncRuntime?_asyncPendingLibraries.push(e):(ArcadeCompiler.extend(e,"async"),_asyncRuntime.extend(e))}function parseScript(e,r){return void 0===r&&(r=[]),ArcadeParser.parseScript(e,r)}function validateScript(e,r,t){return void 0===t&&(t=""),ArcadeParser.validateScript(e,r,t)}function scriptCheck(e,r,t,n){return void 0===n&&(n=""),ArcadeParser.scriptCheck(e,r,t,n)}function parseAndExecuteScript(e,r,t,n){return void 0===n&&(n=[]),executeScript(ArcadeParser.parseScript(e,n),r,t)}function executeScript(e,r,t){if(!0===r.useAsync||!0===e.isAsync){if(null===_asyncRuntime)throw new Error("Async Arcade must be enabled for this script");return _asyncRuntime.executeScript(e,r,t)}return ArcadeRuntime.executeScript(e,r,t)}function referencesMember(e,r){return ArcadeRuntime.referencesMember(e,r)}function referencesFunction(e,r){return ArcadeRuntime.referencesFunction(e,r)}function extractFieldLiterals(e,r){return void 0===r&&(r=!1),ArcadeParser.extractFieldLiterals(e,r)}function scriptUsesGeometryEngine(e){return void 0===e.usesGeometry&&TreeAnalysis.findScriptDependencies(e),!0===e.usesGeometry}function enableGeometrySupport(){return _loadGE||(_loadGE=promiseUtils.create(function(e,r){require(["../geometry/geometryEngine","./functions/geomsync"],function(r,t){_geometryEnabled=!0,t.setGeometryEngine(r),e(!0)},function(e){r(e)})}))}function enableAsyncSupport(){return null!==_loadAsync?_loadAsync:_loadAsync=ArcadeCompiler.enableAsyncSupport().then(function(){return promiseUtils.create(function(e,r){require(["./arcadeAsyncRuntime"],function(t){try{_asyncRuntime=t;for(var n=0,s=_asyncPendingLibraries;n<s.length;n++){var i=s[n];_asyncRuntime.extend(i),ArcadeCompiler.extend(i,"async")}_asyncPendingLibraries=null,e(!0)}catch(e){r(e)}},r)})})}function isFeatureSetSupportEnabled(){return _featureSetEnabled}function isAsyncEnabled(){return!!_asyncRuntime}function isGeometryEnabled(){return _geometryEnabled}function enableFeatureSetSupport(){return _loadFS||(_loadFS=enableAsyncSupport().then(function(){return promiseUtils.create(function(e,r){require(["./featureSetUtils","./functions/featuresetbase","./functions/featuresetgeom","./functions/featuresetstats","./functions/featuresetstring"],function(t,n,s,i,c){try{_utils=t,_asyncRuntime.extend([n,s,i,c]),ArcadeCompiler.extend([n,s,i,c],"async"),_featureSetEnabled=!0,e(!0)}catch(e){r(e)}},r)})}))}function scriptUsesFeatureSet(e){return void 0===e.usesFeatureSet&&TreeAnalysis.findScriptDependencies(e),!0===e.usesFeatureSet}function scriptIsAsync(e){return void 0===e.isAsync&&TreeAnalysis.findScriptDependencies(e),!0===e.isAsync}function scriptUsesVars(e,r){if(r){for(var t=0,n=r;t<n.length;t++){if(referencesMember(e,n[t]))return!0}return!1}return!1}function loadScriptDependencies(e,r,t,n){return void 0===t&&(t=[]),void 0===n&&(n=!1),promiseUtils.create(function(s,i){var c="string"==typeof e?parseScript(e):e,a=[];c&&(!1===isGeometryEnabled()&&(scriptUsesGeometryEngine(c)||n)&&a.push(enableGeometrySupport()),!1===isAsyncEnabled()&&(!0===c.isAsync||r)&&a.push(enableAsyncSupport()),!1===isFeatureSetSupportEnabled()&&(scriptUsesFeatureSet(c)||scriptUsesVars(c,t))&&a.push(enableFeatureSetSupport())),a?promiseUtils.all(a).then(function(){s(!0)},i):s(!0)})}function scriptTouchesGeometry(e){if(scriptUsesGeometryEngine(e))return!0;var r=TreeAnalysis.findFunctionCalls(e,!0);return r.indexOf("geometry")>-1||r.indexOf("feature")>-1}function featureSetUtils(){return _utils}Object.defineProperty(exports,"__esModule",{value:!0});var hasGenerators=evaluates("function* test() {}"),_featureSetEnabled=!1,_geometryEnabled=!1,_asyncRuntime=null,_asyncPendingLibraries=[];exports.compileScript=compileScript,exports.extend=extend,exports.parseScript=parseScript,exports.validateScript=validateScript,exports.scriptCheck=scriptCheck,exports.parseAndExecuteScript=parseAndExecuteScript,exports.executeScript=executeScript,exports.referencesMember=referencesMember,exports.referencesFunction=referencesFunction,exports.extractFieldLiterals=extractFieldLiterals,exports.scriptUsesGeometryEngine=scriptUsesGeometryEngine;var _loadGE=null;exports.enableGeometrySupport=enableGeometrySupport;var _loadAsync=null;exports.enableAsyncSupport=enableAsyncSupport,exports.isFeatureSetSupportEnabled=isFeatureSetSupportEnabled,exports.isAsyncEnabled=isAsyncEnabled,exports.isGeometryEnabled=isGeometryEnabled;var _loadFS=null;exports.enableFeatureSetSupport=enableFeatureSetSupport,exports.scriptUsesFeatureSet=scriptUsesFeatureSet,exports.scriptIsAsync=scriptIsAsync,exports.loadScriptDependencies=loadScriptDependencies,exports.scriptTouchesGeometry=scriptTouchesGeometry;var _utils=null;exports.featureSetUtils=featureSetUtils});