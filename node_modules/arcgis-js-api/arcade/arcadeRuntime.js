// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.10/esri/copyright.txt for details.

define(["require","exports","./Dictionary","./Feature","./FunctionWrapper","./ImmutablePathArray","./ImmutablePointArray","./languageUtils","./treeAnalysis","./functions/date","./functions/geometry","./functions/geomsync","./functions/maths","./functions/stats","./functions/string","../geometry/Extent","../geometry/Geometry","../geometry/Multipoint","../geometry/Point","../geometry/Polygon","../geometry/Polyline","../geometry/SpatialReference"],function(e,r,t,n,o,a,i,s,u,l,c,f,p,h,d,v,g,E,m,w,N,y){function I(e,r){for(var t=[],n=0;n<r.arguments.length;n++)t.push(R(e,r.arguments[n]));return t}function b(e,r,t){try{return t(e,r,I(e,r))}catch(e){throw e}}function R(e,r){try{switch(r.type){case"EmptyStatement":return s.voidOperation;case"VariableDeclarator":return B(e,r);case"VariableDeclaration":return _(e,r);case"BlockStatement":return D(e,r);case"FunctionDeclaration":return L(e,r);case"ReturnStatement":return k(e,r);case"IfStatement":return P(e,r);case"ExpressionStatement":return x(e,r);case"AssignmentExpression":return F(e,r);case"UpdateExpression":return C(e,r);case"BreakStatement":return s.breakResult;case"ContinueStatement":return s.continueResult;case"ForStatement":return M(e,r);case"ForInStatement":return T(e,r);case"Identifier":return H(e,r);case"MemberExpression":return Y(e,r);case"Literal":return r.value;case"ThisExpression":throw new Error(u.nodeErrorMessage(r,"RUNTIME","NOTSUPPORTED"));case"CallExpression":return Z(e,r);case"UnaryExpression":return G(e,r);case"BinaryExpression":return q(e,r);case"LogicalExpression":return z(e,r);case"ConditionalExpression":throw new Error(u.nodeErrorMessage(r,"RUNTIME","NOTSUPPORTED"));case"ArrayExpression":return j(e,r);case"ObjectExpression":return O(e,r);case"Property":return S(e,r);case"Array":throw new Error(u.nodeErrorMessage(r,"RUNTIME","NOTSUPPORTED"));default:throw new Error(u.nodeErrorMessage(r,"RUNTIME","UNREOGNISED"))}}catch(e){throw e}}function O(e,r){for(var n={},o=0;o<r.properties.length;o++){var a=R(e,r.properties[o]);if(s.isFunctionParameter(a.value))throw new Error("Illegal Argument");if(!1===s.isString(a.key))throw new Error("Illegal Argument");a.value===s.voidOperation?n[a.key.toString()]=null:n[a.key.toString()]=a.value}var i=new t(n);return i.immutable=!1,i}function S(e,r){return{key:"Identifier"===r.key.type?r.key.name:R(e,r.key),value:R(e,r.value)}}function T(e,r){var o=R(e,r.right);"VariableDeclaration"===r.left.type&&R(e,r.left);var a=null,i="VariableDeclaration"===r.left.type?r.left.declarations[0].id.name:r.left.name;if(null!==e.localScope&&void 0!==e.localScope[i]&&(a=e.localScope[i]),null===a&&void 0!==e.globalScope[i]&&(a=e.globalScope[i]),null===a)throw new Error(u.nodeErrorMessage(r,"RUNTIME","VARIABLENOTDECLARED"));if(s.isArray(o)||s.isString(o)){for(var l=o.length,c=0;c<l;c++){a.value=c;var f=R(e,r.body);if(f===s.breakResult)break;if(f instanceof s.ReturnResult)return f}return s.voidOperation}if(s.isImmutableArray(o)){for(var c=0;c<o.length();c++){a.value=c;var f=R(e,r.body);if(f===s.breakResult)break;if(f instanceof s.ReturnResult)return f}return s.voidOperation}if(!(o instanceof t||o instanceof n))return s.voidOperation;for(var p=o.keys(),h=0;h<p.length;h++){a.value=p[h];var f=R(e,r.body);if(f===s.breakResult)break;if(f instanceof s.ReturnResult)return f}}function M(e,r){null!==r.init&&R(e,r.init);var t={testResult:!0,lastAction:s.voidOperation};do{A(e,r,t)}while(!0===t.testResult);return t.lastAction instanceof s.ReturnResult?t.lastAction:s.voidOperation}function A(e,r,t){if(null!==r.test){if(t.testResult=R(e,r.test),!1===t.testResult)return;if(!0!==t.testResult)throw new Error(u.nodeErrorMessage(r,"RUNTIME","CANNOT_USE_NONBOOLEAN_IN_CONDITION"))}return t.lastAction=R(e,r.body),t.lastAction===s.breakResult?void(t.testResult=!1):t.lastAction instanceof s.ReturnResult?void(t.testResult=!1):void(null!==r.update&&R(e,r.update))}function C(e,r){var o,a=null,i="";if("MemberExpression"===r.argument.type){if(a=R(e,r.argument.object),i=!0===r.argument.computed?R(e,r.argument.property):r.argument.property.name,s.isArray(a)){if(!s.isNumber(i))throw new Error("Invalid Parameter");if(i<0&&(i=a.length+i),i<0||i>=a.length)throw new Error("Assignment outside of array bounds");o=s.toNumber(a[i]),a[i]="++"===r.operator?o+1:o-1}else if(a instanceof t){if(!1===s.isString(i))throw new Error("Dictionary accessor must be a string");if(!0!==a.hasField(i))throw new Error("Invalid Parameter");o=s.toNumber(a.field(i)),a.setField(i,"++"===r.operator?o+1:o-1)}else{if(!(a instanceof n))throw s.isImmutableArray(a)?new Error("Array is Immutable"):new Error("Invalid Parameter");if(!1===s.isString(i))throw new Error("Feature accessor must be a string");if(!0!==a.hasField(i))throw new Error("Invalid Parameter");o=s.toNumber(a.field(i)),a.setField(i,"++"===r.operator?o+1:o-1)}return!1===r.prefix?o:"++"===r.operator?o+1:o-1}if(a=r.argument.name.toLowerCase(),null!==e.localScope&&void 0!==e.localScope[a])return o=s.toNumber(e.localScope[a].value),e.localScope[a]={value:"++"===r.operator?o+1:o-1,valueset:!0,node:r},!1===r.prefix?o:"++"===r.operator?o+1:o-1;if(void 0!==e.globalScope[a])return o=s.toNumber(e.globalScope[a].value),e.globalScope[a]={value:"++"===r.operator?o+1:o-1,valueset:!0,node:r},!1===r.prefix?o:"++"===r.operator?o+1:o-1;throw new Error("Variable not recognised")}function U(e,r,t,n){switch(r){case"=":return e===s.voidOperation?null:e;case"/=":return s.toNumber(t)/s.toNumber(e);case"*=":return s.toNumber(t)*s.toNumber(e);case"-=":return s.toNumber(t)-s.toNumber(e);case"+=":return s.isString(t)||s.isString(e)?s.toString(t)+s.toString(e):s.toNumber(t)+s.toNumber(e);case"%=":return s.toNumber(t)%s.toNumber(e);default:throw new Error(u.nodeErrorMessage(n,"RUNTIME","OPERATORNOTRECOGNISED"))}}function F(e,r){var o=R(e,r.right),a=null,i="";if("MemberExpression"===r.left.type){if(a=R(e,r.left.object),i=!0===r.left.computed?R(e,r.left.property):r.left.property.name,s.isArray(a)){if(!s.isNumber(i))throw new Error("Invalid Parameter");if(i<0&&(i=a.length+i),i<0||i>a.length)throw new Error("Assignment outside of array bounds");if(i===a.length){if("="!==r.operator)throw new Error("Invalid Parameter");a[i]=U(o,r.operator,a[i],r)}else a[i]=U(o,r.operator,a[i],r)}else if(a instanceof t){if(!1===s.isString(i))throw new Error("Dictionary accessor must be a string");if(!0===a.hasField(i))a.setField(i,U(o,r.operator,a.field(i),r));else{if("="!==r.operator)throw new Error("Invalid Parameter");a.setField(i,U(o,r.operator,null,r))}}else{if(!(a instanceof n))throw s.isImmutableArray(a)?new Error("Array is Immutable"):new Error("Invalid Parameter");if(!1===s.isString(i))throw new Error("Feature accessor must be a string");if(!0===a.hasField(i))a.setField(i,U(o,r.operator,a.field(i),r));else{if("="!==r.operator)throw new Error("Invalid Parameter");a.setField(i,U(o,r.operator,null,r))}}return s.voidOperation}if(a=r.left.name.toLowerCase(),null!==e.localScope&&void 0!==e.localScope[a])return e.localScope[a]={value:U(o,r.operator,e.localScope[a].value,r),valueset:!0,node:r.right},s.voidOperation;if(void 0!==e.globalScope[a])return e.globalScope[a]={value:U(o,r.operator,e.globalScope[a].value,r),valueset:!0,node:r.right},s.voidOperation;throw new Error("Variable not recognised")}function x(e,r){if("AssignmentExpression"===r.expression.type||"UpdateExpression"===r.expression.type)return R(e,r.expression);if("CallExpression"===r.expression.type){var t=R(e,r.expression);return t===s.voidOperation?s.voidOperation:new s.ImplicitResult(t)}var t=R(e,r.expression);return t===s.voidOperation?s.voidOperation:new s.ImplicitResult(t)}function P(e,r){if("AssignmentExpression"===r.test.type||"UpdateExpression"===r.test.type)throw new Error(u.nodeErrorMessage(r.test,"RUNTIME","CANNOT_USE_ASSIGNMENT_IN_CONDITION"));var t=R(e,r.test);if(!0===t)return R(e,r.consequent);if(!1===t)return null!==r.alternate?R(e,r.alternate):s.voidOperation;throw new Error(u.nodeErrorMessage(r,"RUNTIME","CANNOT_USE_NONBOOLEAN_IN_CONDITION"))}function D(e,r){for(var t=s.voidOperation,n=0;n<r.body.length;n++)if((t=R(e,r.body[n]))instanceof s.ReturnResult||t===s.breakResult||t===s.continueResult)return t;return t}function k(e,r){if(null===r.argument)return new s.ReturnResult(s.voidOperation);var t=R(e,r.argument);return new s.ReturnResult(t)}function L(e,r){var t=r.id.name.toLowerCase();return e.globalScope[t]={valueset:!0,node:null,value:new o(r,e)},s.voidOperation}function _(e,r){for(var t=0;t<r.declarations.length;t++)R(e,r.declarations[t]);return s.voidOperation}function B(e,r){var t=null===r.init?null:R(e,r.init);t===s.voidOperation&&(t=null);var n=r.id.name.toLowerCase();return null!==e.localScope?e.localScope[n]={value:t,valueset:!0,node:r.init}:e.globalScope[n]={value:t,valueset:!0,node:r.init},s.voidOperation}function V(e,r,n,o){var s;switch(r=r.toLowerCase()){case"hasz":var l=e.hasZ;return void 0!==l&&l;case"hasm":var c=e.hasM;return void 0!==c&&c;case"spatialreference":var f=e.spatialReference._arcadeCacheId;if(void 0===f){var p=!0;Object.freeze&&Object.isFrozen(e.spatialReference)&&(p=!1),p&&(fe++,e.spatialReference._arcadeCacheId=fe,f=fe)}var h=new t({wkt:e.spatialReference.wkt,wkid:e.spatialReference.wkid});return void 0!==f&&(h._arcadeCacheId="SPREF"+f.toString()),h}switch(e.type){case"extent":switch(r){case"xmin":case"xmax":case"ymin":case"ymax":case"zmin":case"zmax":case"mmin":case"mmax":var d=e[r];return void 0!==d?d:null;case"type":return"Extent"}break;case"polygon":switch(r){case"rings":s=e.cache._arcadeCacheId,void 0===s&&(fe++,s=fe,e.cache._arcadeCacheId=s);var v=new a(e.rings,e.spatialReference,!0===e.hasZ,!0===e.hasM,s);return v;case"type":return"Polygon"}break;case"point":switch(r){case"x":case"y":case"z":case"m":return void 0!==e[r]?e[r]:null;case"type":return"Point"}break;case"polyline":switch(r){case"paths":s=e.cache._arcadeCacheId,void 0===s&&(fe++,s=fe,e.cache._arcadeCacheId=s);var v=new a(e.paths,e.spatialReference,!0===e.hasZ,!0===e.hasM,s);return v;case"type":return"Polyline"}break;case"multipoint":switch(r){case"points":s=e.cache._arcadeCacheId,void 0===s&&(fe++,s=fe,e.cache._arcadeCacheId=s);var v=new i(e.points,e.spatialReference,!0===e.hasZ,!0===e.hasM,s,1);return v;case"type":return"Multipoint"}}throw new Error(u.nodeErrorMessage(o,"RUNTIME","PROPERTYNOTFOUND"))}function Y(e,r){try{var o=R(e,r.object);if(null===o)throw new Error(u.nodeErrorMessage(r,"RUNTIME","NOTFOUND"));if(!1===r.computed){if(o instanceof t||o instanceof n)return o.field(r.property.name);if(o instanceof g)return V(o,r.property.name,e,r);throw new Error(u.nodeErrorMessage(r,"RUNTIME","INVALIDTYPE"))}var a=R(e,r.property);if(o instanceof t||o instanceof n){if(s.isString(a))return o.field(a);throw new Error(u.nodeErrorMessage(r,"RUNTIME","INVALIDTYPE"))}if(o instanceof g){if(s.isString(a))return V(o,a,e,r);throw new Error(u.nodeErrorMessage(r,"RUNTIME","INVALIDTYPE"))}if(s.isArray(o)){if(s.isNumber(a)&&isFinite(a)&&Math.floor(a)===a){if(a<0&&(a=o.length+a),a>=o.length||a<0)throw new Error(u.nodeErrorMessage(r,"RUNTIME","OUTOFBOUNDS"));return o[a]}throw new Error(u.nodeErrorMessage(r,"RUNTIME","INVALIDTYPE"))}if(s.isString(o)){if(s.isNumber(a)&&isFinite(a)&&Math.floor(a)===a){if(a<0&&(a=o.length+a),a>=o.length||a<0)throw new Error(u.nodeErrorMessage(r,"RUNTIME","OUTOFBOUNDS"));return o[a]}throw new Error(u.nodeErrorMessage(r,"RUNTIME","INVALIDTYPE"))}if(s.isImmutableArray(o)){if(s.isNumber(a)&&isFinite(a)&&Math.floor(a)===a){if(a<0&&(a=o.length()+a),a>=o.length()||a<0)throw new Error(u.nodeErrorMessage(r,"RUNTIME","OUTOFBOUNDS"));return o.get(a)}throw new Error(u.nodeErrorMessage(r,"RUNTIME","INVALIDTYPE"))}throw new Error(u.nodeErrorMessage(r,"RUNTIME","INVALIDTYPE"))}catch(e){throw e}}function G(e,r){try{var t=R(e,r.argument);if(s.isBoolean(t)){if("!"===r.operator)return!t;if("-"===r.operator)return-1*s.toNumber(t);if("+"===r.operator)return 1*s.toNumber(t);throw new Error(u.nodeErrorMessage(r,"RUNTIME","NOTSUPPORTEDUNARYOPERATOR"))}if("-"===r.operator)return-1*s.toNumber(t);if("+"===r.operator)return 1*s.toNumber(t);throw new Error(u.nodeErrorMessage(r,"RUNTIME","NOTSUPPORTEDUNARYOPERATOR"))}catch(e){throw e}}function j(e,r){try{for(var t=[],n=0;n<r.elements.length;n++){var o=R(e,r.elements[n]);if(s.isFunctionParameter(o))throw new Error(u.nodeErrorMessage(r,"RUNTIME","FUNCTIONCONTEXTILLEGAL"));o===s.voidOperation?t.push(null):t.push(o)}return t}catch(e){throw e}}function q(e,r){try{var t=[R(e,r.left),R(e,r.right)],n=t[0],o=t[1];switch(r.operator){case"==":case"=":return s.equalityTest(n,o);case"!=":return!s.equalityTest(n,o);case"<":case">":case"<=":case">=":return s.greaterThanLessThan(n,o,r.operator);case"+":return s.isString(n)||s.isString(o)?s.toString(n)+s.toString(o):s.toNumber(n)+s.toNumber(o);case"-":return s.toNumber(n)-s.toNumber(o);case"*":return s.toNumber(n)*s.toNumber(o);case"/":return s.toNumber(n)/s.toNumber(o);case"%":return s.toNumber(n)%s.toNumber(o);default:throw new Error(u.nodeErrorMessage(r,"RUNTIME","OPERATORNOTRECOGNISED"))}}catch(e){throw e}}function z(e,r){try{if("AssignmentExpression"===r.left.type||"UpdateExpression"===r.left.type)throw new Error(u.nodeErrorMessage(r.left,"RUNTIME","CANNOT_USE_ASSIGNMENT_IN_CONDITION"));if("AssignmentExpression"===r.right.type||"UpdateExpression"===r.right.type)throw new Error(u.nodeErrorMessage(r.right,"RUNTIME","CANNOT_USE_ASSIGNMENT_IN_CONDITION"));var t=R(e,r.left);if(!s.isBoolean(t))throw new Error(u.nodeErrorMessage(r,"RUNTIME","ONLYBOOLEAN"));switch(r.operator){case"||":if(!0===t)return t;var n=R(e,r.right);if(s.isBoolean(n))return n;throw new Error(u.nodeErrorMessage(r,"RUNTIME","ONLYORORAND"));case"&&":if(!1===t)return t;var n=R(e,r.right);if(s.isBoolean(n))return n;throw new Error(u.nodeErrorMessage(r,"RUNTIME","ONLYORORAND"));default:throw new Error(u.nodeErrorMessage(r,"RUNTIME","ONLYORORAND"))}}catch(e){throw e}}function H(e,r){var t;try{var n=r.name.toLowerCase();if(null!==e.localScope&&void 0!==e.localScope[n])return t=e.localScope[n],!0===t.valueset?t.value:(t.value=R(e,t.node),t.valueset=!0,t.value);if(void 0!==e.globalScope[n])return t=e.globalScope[n],!0===t.valueset?t.value:(t.value=R(e,t.node),t.valueset=!0,t.value);throw new Error(u.nodeErrorMessage(r,"RUNTIME","VARIABLENOTFOUND"))}catch(e){throw e}}function Z(e,r){try{if("Identifier"!==r.callee.type)throw new Error(u.nodeErrorMessage(r,"RUNTIME","ONLYNODESSUPPORTED"));if(null!==e.localScope&&void 0!==e.localScope[r.callee.name.toLowerCase()]){var t=e.localScope[r.callee.name.toLowerCase()];if(t.value instanceof s.NativeFunction)return t.value.fn(e,r);if(t.value instanceof o)return ee(e,r,t.value.definition);throw new Error(u.nodeErrorMessage(r,"RUNTIME","NOTAFUNCTION"))}if(void 0!==e.globalScope[r.callee.name.toLowerCase()]){var t=e.globalScope[r.callee.name.toLowerCase()];if(t.value instanceof s.NativeFunction)return t.value.fn(e,r);if(t.value instanceof o)return ee(e,r,t.value.definition);throw new Error(u.nodeErrorMessage(r,"RUNTIME","NOTAFUNCTION"))}throw new Error(u.nodeErrorMessage(r,"RUNTIME","NOTFOUND"))}catch(e){throw e}}function W(e){return null==e?"":s.isArray(e)?"Array":s.isImmutableArray(e)?"Array":s.isDate(e)?"Date":s.isString(e)?"String":s.isBoolean(e)?"Boolean":s.isNumber(e)?"Number":e instanceof t?"Dictionary":e instanceof n?"Feature":e instanceof m?"Point":e instanceof w?"Polygon":e instanceof N?"Polyline":e instanceof E?"Multipoint":e instanceof v?"Extent":s.isFunctionParameter(e)?"Function":s.isFeatureSet(e)?"FeatureSet":s.isFeatureSetCollection(e)?"FeatureSetCollection":e===s.voidOperation?"":"number"==typeof e&&isNaN(e)?"Number":"Unrecognised Type"}function K(e,r,t,n){try{var o=R(e,r.arguments[t]);if(s.equalityTest(o,n))return R(e,r.arguments[t+1]);var a=r.arguments.length-t;return 1===a?R(e,r.arguments[t]):2===a?null:3===a?R(e,r.arguments[t+2]):K(e,r,t+2,n)}catch(e){throw e}}function X(e,r,t,n){try{if(!0===n)return R(e,r.arguments[t+1]);if(3===r.arguments.length-t)return R(e,r.arguments[t+2]);var o=R(e,r.arguments[t+2]);if(!1===s.isBoolean(o))throw new Error("WHEN needs boolean test conditions");return X(e,r,t+2,o)}catch(e){throw e}}function J(e,r){var t=e.length,n=Math.floor(t/2);return 0===t?[]:1===t?[e[0]]:Q(J(e.slice(0,n),r),J(e.slice(n,t),r),r)}function Q(e,r,t){for(var n=[];e.length>0||r.length>0;)if(e.length>0&&r.length>0){var o=t(e[0],r[0]);isNaN(o)&&(o=0),o<=0?(n.push(e[0]),e=e.slice(1)):(n.push(r[0]),r=r.slice(1))}else e.length>0?(n.push(e[0]),e=e.slice(1)):r.length>0&&(n.push(r[0]),r=r.slice(1));return n}function $(e,r,t){try{var n=e.body;if(t.length!==e.params.length)throw new Error("Invalid Parameter calls to function.");for(var o=0;o<t.length;o++)r.localScope[e.params[o].name.toLowerCase()]={value:t[o],valueset:!0,node:null};var a=R(r,n);if(a instanceof s.ReturnResult)return a.value;if(a===s.breakResult)throw new Error("Cannot Break from a Function");if(a===s.continueResult)throw new Error("Cannot Continue from a Function");return a instanceof s.ImplicitResult?a.value:a}catch(e){throw e}}function ee(e,r,t){return b(e,r,function(r,n,o){var a={spatialReference:e.spatialReference,applicationCache:void 0===e.applicationCache?null:e.applicationCache,globalScope:e.globalScope,depthCounter:e.depthCounter+1,console:e.console,lrucache:e.lrucache,localScope:{}};if(a.depthCounter>64)throw new Error("Exceeded maximum function depth");return $(t,a,o)})}function re(e){return function(){var r={applicationCache:void 0===e.context.applicationCache?null:e.context.applicationCache,spatialReference:e.context.spatialReference,console:e.context.console,lrucache:e.context.lrucache,localScope:{},depthCounter:e.context.depthCounter+1,globalScope:e.context.globalScope};if(r.depthCounter>64)throw new Error("Exceeded maximum function depth");return $(e.definition,r,arguments)}}function te(e,r){var o=new de;e||(e={}),r||(r={});var a=new t({newline:"\n",tab:"\t",singlequote:"'",doublequote:'"',forwardslash:"/",backwardslash:"\\"});a.immutable=!1,o.textformatting={value:a,valueset:!0,node:null};for(var i in r)o[i]={value:new s.NativeFunction(r[i]),native:!0,valueset:!0,node:null};for(var i in e)e[i]&&"esri.Graphic"===e[i].declaredClass?o[i]={value:n.createFromGraphic(e[i]),valueset:!0,node:null}:o[i]={value:e[i],valueset:!0,node:null};return o}function ne(e){console.log(e)}function oe(e){for(var r={mode:"sync",compiled:!1,functions:{},signatures:[],standardFunction:b,evaluateIdentifier:H,arcadeCustomFunctionHandler:re},t=0;t<e.length;t++)e[t].registerFunctions(r);for(var n in r.functions)pe[n]={value:new s.NativeFunction(r.functions[n]),valueset:!0,node:null},de.prototype[n]=pe[n];for(var t=0;t<r.signatures.length;t++)u.addFunctionDeclaration(r.signatures[t],"async")}function ae(e,r,t){t||(t=new y({wkid:102100}));var n=te(r.vars,r.customfunctions),a={spatialReference:t,globalScope:n,localScope:null,console:r.console?r.console:ne,lrucache:r.lrucache,depthCounter:1,applicationCache:void 0===r.applicationCache?null:r.applicationCache},i=R(a,e.body[0].body);if(i instanceof s.ReturnResult&&(i=i.value),i instanceof s.ImplicitResult&&(i=i.value),i===s.voidOperation&&(i=null),i===s.breakResult)throw new Error("Cannot return BREAK");if(i===s.continueResult)throw new Error("Cannot return CONTINUE");if(i instanceof o)throw new Error("Cannot return FUNCTION");if(i instanceof s.NativeFunction)throw new Error("Cannot return FUNCTION");return i}function ie(e,r){return void 0===r&&(r=!1),u.findFieldLiterals(e,r)}function se(e,r){return u.validateScript(e,r,"simple")}function ue(e,r){return u.referencesMember(e,r)}function le(e,r){return u.referencesFunction(e,r)}function ce(e){return u.findFunctionCalls(e,!1)}Object.defineProperty(r,"__esModule",{value:!0});var fe=0,pe={};l.registerFunctions(pe,b),d.registerFunctions(pe,b),p.registerFunctions(pe,b),c.registerFunctions(pe,b),h.registerFunctions(pe,b),f.registerFunctions(pe,b),pe.typeof=function(e,r){return b(e,r,function(e,r,t){s.pcCheck(t,1,1);var n=W(t[0]);if("Unrecognised Type"===n)throw new Error("Unrecognised Type");return n})},pe.iif=function(e,r){try{s.pcCheck(null===r.arguments?[]:r.arguments,3,3);var t=R(e,r.arguments[0]);if(!1===s.isBoolean(t))throw new Error("IF Function must have a boolean test condition");return!0===t?R(e,r.arguments[1]):R(e,r.arguments[2])}catch(e){throw e}},pe.decode=function(e,r){try{if(r.arguments.length<2)throw new Error("Missing Parameters");if(2===r.arguments.length)return R(e,r.arguments[1]);if((r.arguments.length-1)%2==0)throw new Error("Must have a default value result.");return K(e,r,1,R(e,r.arguments[0]))}catch(e){throw e}},pe.when=function(e,r){try{if(r.arguments.length<3)throw new Error("Missing Parameters");if(r.arguments.length%2==0)throw new Error("Must have a default value result.");var t=R(e,r.arguments[0]);if(!1===s.isBoolean(t))throw new Error("WHEN needs boolean test conditions");return X(e,r,0,t)}catch(e){throw e}},pe.top=function(e,r){return b(e,r,function(e,r,t){if(s.pcCheck(t,2,2),s.isArray(t[0]))return s.toNumber(t[1])>=t[0].length?t[0].slice(0):t[0].slice(0,s.toNumber(t[1]));if(s.isImmutableArray(t[0]))return s.toNumber(t[1])>=t[0].length()?t[0].slice(0):t[0].slice(0,s.toNumber(t[1]));throw new Error("Top cannot accept this parameter type")})},pe.first=function(e,r){return b(e,r,function(e,r,t){return s.pcCheck(t,1,1),s.isArray(t[0])?0===t[0].length?null:t[0][0]:s.isImmutableArray(t[0])?0===t[0].length()?null:t[0].get(0):null})},pe.sort=function(e,r){return b(e,r,function(e,r,t){s.pcCheck(t,1,2);var n=t[0];if(s.isImmutableArray(n)&&(n=n.toArray()),!1===s.isArray(n))throw new Error("Illegal Argument");if(t.length>1){if(!1===s.isFunctionParameter(t[1]))throw new Error("Illegal Argument");var o=n,a=re(t[1]);return o=J(o,function(e,r){return a(e,r)})}var o=n;if(0===o.length)return[];for(var i={},u=0;u<o.length;u++){var l=W(o[u]);""!==l&&(i[l]=!0)}if(!0===i.Array||!0===i.Dictionary||!0===i.Feature||!0===i.Point||!0===i.Polygon||!0===i.Polyline||!0===i.Multipoint||!0===i.Extent||!0===i.Function)return o.slice(0);var c=0,f="";for(var p in i)c++,f=p;return o=c>1||"String"===f?J(o,function(e,r){if(null===e||void 0===e||e===s.voidOperation)return null===r||void 0===r||r===s.voidOperation?0:1;if(null===r||void 0===r||r===s.voidOperation)return-1;var t=s.toString(e),n=s.toString(r);return t<n?-1:t===n?0:1}):"Number"===f?J(o,function(e,r){return e-r}):"Boolean"===f?J(o,function(e,r){return e===r?0:r?-1:1}):"Date"===f?J(o,function(e,r){return r-e}):o.slice(0)})};for(var he in pe)pe[he]={value:new s.NativeFunction(pe[he]),valueset:!0,node:null};var de=function(){};de.prototype=pe,de.prototype.infinity={value:Number.POSITIVE_INFINITY,valueset:!0,node:null},de.prototype.pi={value:Math.PI,valueset:!0,node:null};var ve={fixSpatialReference:s.fixSpatialReference,parseArguments:I,standardFunction:b};r.functionHelper=ve,r.extend=oe,r.executeScript=ae,r.extractFieldLiterals=ie,r.validateScript=se,r.referencesMember=ue,r.referencesFunction=le,r.findFunctionCalls=ce});