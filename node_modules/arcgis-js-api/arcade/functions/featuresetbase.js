// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.10/esri/copyright.txt for details.

define(["require","exports","dojo/Deferred","dojo/promise/all","../Dictionary","../Feature","../featureSetCollection","../kernel","../languageUtils","../featureSetUtils","../featureset/actions/AttributeFilter","../featureset/actions/OrderBy","../featureset/actions/Top","../featureset/sources/FeatureLayerMemory","../featureset/support/OrderbyClause","../featureset/support/WhereClause"],function(e,r,t,n,a,i,l,o,u,s,f,c,y,d,m,p){function v(e,r,t){void 0===t&&(t=null);for(var n in e)if(n.toLowerCase()===r.toLowerCase())return e[n];return t}function h(e){if(null===e)return null;var r={type:v(e,"type",""),name:v(e,"name","")};if("range"===r.type)r.range=v(e,"range",[]);else{r.codedValues=[];for(var t=0,n=v(e,"codedValues",[]);t<n.length;t++){var a=n[t];r.codedValues.push({name:v(a,"name",""),code:v(a,"code",null)})}}return r}function g(e){if(null===e)return null;var r={},t=v(e,"wkt",null);null!==t&&(r.wkt=t);var n=v(e,"wkid",null);return null!==n&&(r.wkid=n),r}function b(e){if(null===e)return null;var r={hasZ:v(e,"hasz",!1),hasM:v(e,"hasm",!1)},t=v(e,"spatialreference",null);t&&(r.spatialReference=g(t));var n=v(e,"x",null);if(null!==n)return r.x=n,r.y=v(e,"y",null),r;var a=v(e,"rings",null);if(null!==a)return r.rings=a,r;var i=v(e,"paths",null);if(null!==i)return r.paths=i,r;var l=v(e,"points",null);if(null!==l)return r.points=l,r;for(var o=0,u=["xmin","xmax","ymin","ymax","zmin","zmax","mmin","mmax"];o<u.length;o++){var s=u[o],f=v(e,s,null);null!==f&&(r[s]=f)}return r}function w(e,r){for(var t=0,n=r;t<n.length;t++){if(n[t]===e)return!0}return!1}function D(e){return!!e.layerDefinition&&(!!e.featureSet&&(!1!==w(e.layerDefinition.geometryType,["","esriGeometryPoint","esriGeometryPolyline","esriGeometryPolygon","esriGeometryMultipoint","esriGeometryEnvelope"])&&(null!==e.layerDefinition.objectIdField&&""!==e.layerDefinition.objectIdField&&(!1!==u.isArray(e.layerDefinition.fields)&&(!1!==u.isArray(e.featureSet.features)&&void 0)))))}function F(e){"async"===e.mode&&(e.functions.featuresetbyid=function(r,t){return e.standardFunctionAsync(r,t,function(e,r,t){if(u.pcCheck(t,2,4),t[0]instanceof l){var n=u.toString(t[1]),a=u.defaultUndefined(t[2],null),i=u.toBoolean(u.defaultUndefined(t[3],!0));if(null===a&&(a=["*"]),!1===u.isArray(a))throw new Error("Invalid Parameter");return t[0].featureSetById(n,i,a)}throw new Error("Invalid Parameter")})},e.signatures.push({name:"featuresetbyid",min:"2",max:"4"}),e.functions.featuresetbyportalitem=function(r,t){return e.standardFunctionAsync(r,t,function(e,t,n){u.pcCheck(n,2,4);var a=u.toString(n[0]),i=u.toString(n[1]),l=u.defaultUndefined(n[2],null),o=u.toBoolean(u.defaultUndefined(n[3],!0));if(null===l&&(l=["*"]),!1===u.isArray(l))throw new Error("Invalid Parameter");if(r.services&&r.services.portal)return s.constructFeatureSetFromPortalItem(a,i,r.spatialReference,l,o,r.services.portal,r.lrucache);throw new Error("Portal is required")})},e.signatures.push({name:"featuresetbyportalitem",min:"2",max:"4"}),e.functions.featuresetbyname=function(r,t){return e.standardFunctionAsync(r,t,function(e,r,t){if(u.pcCheck(t,2,4),t[0]instanceof l){var n=u.toString(t[1]),a=u.defaultUndefined(t[2],null),i=u.toBoolean(u.defaultUndefined(t[3],!0));if(null===a&&(a=["*"]),!1===u.isArray(a))throw new Error("Invalid Parameter");return t[0].featureSetByName(n,i,a)}throw new Error("Invalid Parameter")})},e.signatures.push({name:"featuresetbyname",min:"2",max:"4"}),e.functions.featureset=function(r,t){return e.standardFunction(r,t,function(e,t,n){u.pcCheck(n,1,1);var i=n[0],l={layerDefinition:{geometryType:"",objectIdField:"",typeIdField:"",fields:[]},featureSet:{geometryType:"",features:[]}};if(u.isString(i))i=JSON.parse(i),void 0!==i.layerDefinition?(l.layerDefinition=i.layerDefinition,l.featureSet=i.featureSet,i.layerDefinition.spatialReference&&(l.layerDefinition.spatialReference=i.layerDefinition.spatialReference)):(l.featureSet.features=i.features,l.featureSet.geometryType=i.geometryType,l.layerDefinition.geometryType=l.featureSet.geometryType,l.layerDefinition.objectIdField=i.objectIdFieldName,l.layerDefinition.typeIdField=i.typeIdFieldName,l.layerDefinition.fields=i.fields,i.spatialReference&&(l.layerDefinition.spatialReference=i.spatialReference));else{if(!(n[0]instanceof a))throw new Error("Invalid Parameter");i=JSON.parse(n[0].castToText());var o=v(i,"layerdefinition");if(null!==o){l.layerDefinition.geometryType=v(o,"geometrytype",""),l.featureSet.geometryType=l.layerDefinition.geometryType,l.layerDefinition.objectIdField=v(o,"objectidfield",""),l.layerDefinition.typeIdField=v(o,"typeidfield","");var s=v(o,"spatialreference",null);s&&(l.layerDefinition.spatialReference=g(s));for(var f=0,c=v(o,"fields",[]);f<c.length;f++){var y=c[f],m={name:v(y,"name",""),alias:v(y,"alias",""),type:v(y,"type",""),nullable:v(y,"nullable",!0),editable:v(y,"editable",!0),length:v(y,"length",null),domain:h(v(y,"domain"))};l.layerDefinition.fields.push(m)}var p=v(i,"featureset",null);if(p){for(var w={},F=0,S=l.layerDefinition.fields;F<S.length;F++){var I=S[F];w[I.name.toLowerCase()]=I.name}for(var k=0,x=v(p,"features",[]);k<x.length;k++){var A=x[k],C={},T=v(A,"attributes",{});for(var I in T)C[w[I.toLowerCase()]]=T[I];l.featureSet.features.push({attributes:C,geometry:b(v(A,"geometry",null))})}}}else{l.layerDefinition.geometryType=v(i,"geometrytype",""),l.featureSet.geometryType=l.layerDefinition.geometryType,l.layerDefinition.objectIdField=v(i,"objectidfieldname",""),l.layerDefinition.typeIdField=v(i,"typeidfieldname","");var s=v(i,"spatialreference",null);s&&(l.layerDefinition.spatialReference=g(s));for(var j=0,P=v(i,"fields",[]);j<P.length;j++){var y=P[j],m={name:v(y,"name",""),alias:v(y,"alias",""),type:v(y,"type",""),nullable:v(y,"nullable",!0),editable:v(y,"editable",!0),length:v(y,"length",null),domain:h(v(y,"domain"))};l.layerDefinition.fields.push(m)}for(var w={},R=0,E=l.layerDefinition.fields;R<E.length;R++){var I=E[R];w[I.name.toLowerCase()]=I.name}for(var N=0,L=v(i,"features",[]);N<L.length;N++){var A=L[N],C={},T=v(A,"attributes",{});for(var I in T)C[w[I.toLowerCase()]]=T[I];l.featureSet.features.push({attributes:C,geometry:b(v(A,"geometry",null))})}}}if(!1===D(l))throw new Error("Invalid Parameter");return d.create(l,r.spatialReference)})},e.signatures.push({name:"featureset",min:"1",max:"1"}),e.functions.filter=function(r,a){return e.standardFunctionAsync(r,a,function(a,i,l){if(u.pcCheck(l,2,2),u.isFeatureSet(l[0])){var s=p.create(l[1]),c=s.getVariables(),y=new t;if(c.length>0){for(var d=[],m=0;m<c.length;m++){var v={name:c[m]};d.push(e.evaluateIdentifier(r,v))}n(d).then(o.callback(function(e){for(var r={},t=0;t<c.length;t++)r[c[t]]=e[t];s.setVariablesDictionary(r),y.resolve(new f({parentfeatureset:l[0],whereclause:s}))},y),o.errback(y))}else y.resolve(new f({parentfeatureset:l[0],whereclause:s}));return y.promise}return e.failDefferred("Filter cannot accept this parameter type")})},e.signatures.push({name:"filter",min:"2",max:"2"}),e.functions.orderby=function(r,n){return e.standardFunctionAsync(r,n,function(r,n,a){if(u.pcCheck(a,2,2),u.isFeatureSet(a[0])){var i=new t,l=new m(a[1]);return i.resolve(new c({parentfeatureset:a[0],orderbyclause:l})),i.promise}return e.failDefferred("Order cannot accept this parameter type")})},e.signatures.push({name:"orderby",min:"2",max:"2"}),e.functions.top=function(r,n){return e.standardFunctionAsync(r,n,function(r,n,a){if(u.pcCheck(a,2,2),u.isFeatureSet(a[0])){var i=new t;return i.resolve(new y({parentfeatureset:a[0],topnum:a[1]})),i.promise}return u.isArray(a[0])?u.toNumber(a[1])>=a[0].length?a[0].slice(0):a[0].slice(0,u.toNumber(a[1])):u.isImmutableArray(a[0])?u.toNumber(a[1])>=a[0].length()?a[0].slice(0):a[0].slice(0,u.toNumber(a[1])):e.failDefferred("Top cannot accept this parameter type")})},e.signatures.push({name:"top",min:"2",max:"2"}),e.functions.first=function(r,n){return e.standardFunctionAsync(r,n,function(e,r,n){var a=new t;if(u.pcCheck(n,1,1),u.isFeatureSet(n[0]))n[0].first().then(o.callback(function(e){if(null!==e){var r=i.createFromGraphicLikeObject(e.geometry,e.attributes,n[0]);r._underlyingGraphic=e,e=r}a.resolve(e)},a),o.errback(a));else if(u.isArray(n[0]))0===n[0].length?a.resolve(null):a.resolve(n[0][0]);else{if(!u.isImmutableArray(n[0]))return null;0===n[0].length()?a.resolve(null):a.resolve(n[0].get(0))}return a.promise})},e.signatures.push({name:"first",min:"1",max:"1"}))}Object.defineProperty(r,"__esModule",{value:!0}),r.registerFunctions=F});