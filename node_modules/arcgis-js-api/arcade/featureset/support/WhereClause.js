// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.10/esri/copyright.txt for details.

define(["require","exports","dojo/Deferred","dojo/promise/all","../../../moment","./shared","./StandardizedFunctions","../../../core/sql/WhereGrammar","../../../geometry/geometryEngineAsync"],function(e,r,t,a,s,n,o,l,u){function i(e){if(e){for(var r="",t=0,a=e;t<a.length;t++){var s=a[t];""!==s&&(r=""===r?s:E[r]<E[s]?s:r)}return r}return""}function c(e){return s(e,["YYYY-M-D H:m:s","YYYY-M-D H:mZ","YYYY-M-D H:m:sZ","YYYY-M-D H:m","YYYY-m-d"]).toDate()}function h(e){return s(e,["YYYY-M-D"]).toDate()}function p(e){return!0===e}function v(e){return Array.isArray(e)?e:[e]}function f(e){return null!==e?!0!==e:null}function d(e,r){return null!=e&&null!=r?!0===e&&!0===r:!1!==e&&!1!==r&&null}function N(e,r){return null!=e&&null!=r?!0===e||!0===r:!0===e||!0===r||null}function T(e,r){if(null==e)return null;for(var t=!1,a=0,s=r;a<s.length;a++){var n=s[a];if(null==n)t=null;else if(e===n){t=!0;break}}return t}function g(e,r,t){if(null==e)return null;for(var a=r,s=t,n="",o="-[]/{}()*+?.\\^$|",l=0,u=0;u<a.length;u++){var i=a.charAt(u);switch(l){case 0:i===s?l=1:o.indexOf(i)>=0?n+="\\"+i:n+="%"===i?".*":"_"===i?".":i;break;case 1:o.indexOf(i)>=0?n+="\\"+i:n+=i,l=0}}return new RegExp("^"+n+"$").test(e)}function m(e){return e instanceof Date?e.valueOf():e}function S(e,r,t){if(null==r||null==t)return null;var a=m(r),s=m(t);switch(e){case"<>":return a!==s;case"=":return a===s;case">":return a>s;case"<":return a<s;case">=":return a>=s;case"<=":return a<=s}}function y(e){for(var r=[],t={},a=0,s=e;a<s.length;a++){var n=s[a],o=n.toLowerCase();void 0===t[o]&&(r.push(n),t[o]=1)}return r}var E={boolean:1,string:2,integer:3,double:4,date:5},b=function(){function e(){}return e.makeBool=function(e){return p(e)},e.featureValue=function(e,r){var t=e.attributes[r];if(void 0!==t)return t;for(var a in e.attributes)if(r.toLowerCase()===a.toLowerCase())return e.attributes[a];return null},e.equalsNull=function(e){return null===e},e.applyLike=function(e,r,t){return g(e,r,t)},e.ensureArray=function(e){return v(e)},e.applyIn=function(e,r){return T(e,r)},e.currentDate=function(){var e=new Date;return e.setHours(0,0,0,0),e},e.currentTimestamp=function(){return new Date},e.compare=function(e,r,t){return S(e,r,t)},e.makeComparable=function(e){return m(e)},e.evaluateFunction=function(e,r){return o.evaluateFunction(e,r)},e.lookup=function(e,r){var t=r[e];return void 0===t?null:t},e.between=function(e,r){return null==e||null==r[0]||null==r[1]?null:e>=r[0]&&e<=r[1]},e.notbetween=function(e,r){return null==e||null==r[0]||null==r[1]?null:e<r[0]||e>r[1]},e}();return function(){function e(){this.parseTree=null,this.parameters=null}return e.create=function(r){var t=new e;return t.parseTree=l.WhereGrammar.parse(r),t},e.prototype.isStandardized=function(){var e=!0;return this.visitAll(this.parseTree,function(r){e&&"function"===r.type&&(e=o.isStandardized(r.name,r.args.value.length))}),e},e.prototype.setVariablesDictionary=function(e){this.parameters=e},e.prototype.testFeature=function(e){return!!this.evaluateNode(this.parseTree,e)},e.prototype.testFeatureCompiled=function(e){return void 0===this.parseTree._compiledVersion&&this._compileMe(),!!this.parseTree._compiledVersion(e,this.parameters)},e.prototype._compileMe=function(){var e="return "+this.evaluateNodeToJavaScript(this.parseTree);this.parseTree._compiledVersion=new Function("feature","lookups",e).bind(b)},e.prototype.evaluateNodeToJavaScript=function(e){switch(e.type){case"case_expression":var r="";if("simple"===e.format){var t="this.makeComparable("+this.evaluateNodeToJavaScript(e.operand)+")";r="( ";for(var a=0;a<e.clauses.length;a++)r+=" ("+t+" === this.makeComparable("+this.evaluateNodeToJavaScript(e.clauses[a].operand)+")) ? ("+this.evaluateNodeToJavaScript(e.clauses[a].value)+") : ";null!==e.else?r+=this.evaluateNodeToJavaScript(e.else):r+="null",r+=" )"}else{r="( ";for(var a=0;a<e.clauses.length;a++)r+=" this.makeBool("+this.evaluateNodeToJavaScript(e.clauses[a].operand)+")===true ? ("+this.evaluateNodeToJavaScript(e.clauses[a].value)+") : ";null!==e.else?r+=this.evaluateNodeToJavaScript(e.else):r+="null",r+=" )"}return r;case"param":return"this.lookup("+JSON.stringify(e.value.toLowerCase())+",lookups)";case"expr_list":for(var s="[",n=0,o=e.value;n<o.length;n++){var l=o[n];"["!==s&&(s+=","),s+=this.evaluateNodeToJavaScript(l)}return s+="]";case"unary_expr":return"this.ternaryNot("+this.evaluateNodeToJavaScript(e.expr)+")";case"binary_expr":switch(e.operator){case"AND":return"this.ternaryAnd("+this.evaluateNodeToJavaScript(e.left)+","+this.evaluateNodeToJavaScript(e.right)+" )";case"OR":return"this.ternaryOr("+this.evaluateNodeToJavaScript(e.left)+","+this.evaluateNodeToJavaScript(e.right)+" )";case"IS":if("null"!==e.right.type)throw new Error("Unsupported RHS for IS");return"this.equalsNull("+this.evaluateNodeToJavaScript(e.left)+")";case"ISNOT":if("null"!==e.right.type)throw new Error("Unsupported RHS for IS");return"(!(this.equalsNull("+this.evaluateNodeToJavaScript(e.left)+")))";case"IN":return"this.applyIn("+this.evaluateNodeToJavaScript(e.left)+",this.ensureArray("+this.evaluateNodeToJavaScript(e.right)+"))";case"NOT IN":return"this.ternaryNot(this.applyIn("+this.evaluateNodeToJavaScript(e.left)+",this.ensureArray("+this.evaluateNodeToJavaScript(e.right)+")))";case"BETWEEN":return"this.between("+this.evaluateNodeToJavaScript(e.left)+","+this.evaluateNodeToJavaScript(e.right)+")";case"NOTBETWEEN":return"this.notbetween("+this.evaluateNodeToJavaScript(e.left)+","+this.evaluateNodeToJavaScript(e.right)+")";case"LIKE":return"this.applyLike("+this.evaluateNodeToJavaScript(e.left)+","+this.evaluateNodeToJavaScript(e.right)+","+JSON.stringify(e.escape)+")";case"NOT LIKE":return"this.ternaryNot(this.applyLike("+this.evaluateNodeToJavaScript(e.left)+","+this.evaluateNodeToJavaScript(e.right)+","+JSON.stringify(e.escape)+"))";case"<>":case"<":case">":case">=":case"<=":case"=":return"this.compare("+JSON.stringify(e.operator)+","+this.evaluateNodeToJavaScript(e.left)+","+this.evaluateNodeToJavaScript(e.right)+")";case"*":return"("+this.evaluateNodeToJavaScript(e.left)+" * "+this.evaluateNodeToJavaScript(e.right)+")";case"-":return"("+this.evaluateNodeToJavaScript(e.left)+" - "+this.evaluateNodeToJavaScript(e.right)+")";case"+":return"("+this.evaluateNodeToJavaScript(e.left)+" + "+this.evaluateNodeToJavaScript(e.right)+")";case"/":return"("+this.evaluateNodeToJavaScript(e.left)+" / "+this.evaluateNodeToJavaScript(e.right)+")"}throw new Error("Not Supported Operator "+e.operator);case"null":case"bool":case"string":case"number":return JSON.stringify(e.value);case"date":return"(new Date("+h(e.value).getTime().toString()+"))";case"timestamp":return"(new Date("+c(e.value).getTime().toString()+"))";case"column_ref":return"CURRENT_DATE"===e.column.toUpperCase()?"this.currentDate()":"CURRENT_TIMESTAMP"===e.column.toUpperCase()?"this.currentTimestamp()":"this.featureValue(feature,"+JSON.stringify(e.column)+")";case"function":return"this.evaluateFunction("+JSON.stringify(e.name)+","+this.evaluateNodeToJavaScript(e.args)+")"}throw new Error("Unsupported sql syntax "+e.type)},e.prototype.calculateValue=function(e){return this.evaluateNode(this.parseTree,e)},e.prototype.predictType=function(e,r){void 0===r&&(r={});for(var t={},a={},s={esriFieldTypeSmallInteger:"integer",esriFieldTypeInteger:"integer",esriFieldTypeSingle:"double",esriFieldTypeDouble:"double",esriFieldTypeString:"string",esriFieldTypeDate:"date",esriFieldTypeOID:"integer",oid:"integer",long:"integer","small-integer":"integer",integer:"integer",single:"double",double:"double",date:"date",string:"string"},n=0,o=e;n<o.length;n++){var l=o[n],u=s[l.type];t[l.name.toLowerCase()]=void 0===u?"":u}for(var l in r){var u=s[r[l]];a[l.toLowerCase()]=void 0===u?"":u}switch(this.evaluateType(t,this.parseTree,a)){case"double":return"double";case"integer":return"integer";case"double":return"double";case"date":return"date";case"string":return"string"}return""},e.prototype.evaluateType=function(e,r,t){var a;switch(r.type){case"case_expression":var s=[];if("simple"===r.format){for(var n=0;n<r.clauses.length;n++)s.push(this.evaluateType(e,r.clauses[n].value,t));null!==r.else&&s.push(this.evaluateType(e,r.else,t))}else{for(var n=0;n<r.clauses.length;n++)s.push(this.evaluateType(e,r.else,t));null!==r.else&&s.push(this.evaluateType(e,r.else,t))}return i(s);case"param":var o=t[r.value.toLowerCase()];if(void 0===o&&this.parameters){var l=this.parameters[r.value.toLowerCase()];if(void 0===l)return"";if(null===l)return"";if("string"==typeof l||l instanceof String)return"string";if("boolean"==typeof l)return"boolean";if(l instanceof Date)return"date";if("number"==typeof l)return l%1==0?"integer":"double"}return void 0===o?"":o;case"expr_list":for(var u=[],c=0,h=r.value;c<h.length;c++){var p=h[c];u.push(this.evaluateType(e,p,t))}return u;case"unary_expr":return"boolean";case"binary_expr":switch(r.operator){case"AND":case"OR":return"boolean";case"IS":case"ISNOT":if("null"!==r.right.type)throw new Error("Unsupported RHS for IS");return"boolean";case"IN":case"NOT IN":case"BETWEEN":case"NOTBETWEEN":case"LIKE":case"NOT LIKE":return"boolean";case"<>":case"<":case">":case">=":case"<=":case"=":return"boolean";case"*":case"-":case"+":case"/":return i([this.evaluateType(e,r.left,t),this.evaluateType(e,r.right,t)])}throw new Error("Not Supported Operator "+r.operator);case"null":return"";case"bool":return"boolean";case"string":return"string";case"number":return null===r.value?"":r.value%1==0?"integer":"double";case"date":case"timestamp":return"date";case"column_ref":if("CURRENT_DATE"===r.column.toUpperCase())return"date";if("CURRENT_TIMESTAMP"===r.column.toUpperCase())return"date";var v=e[r.column.toLowerCase()];return void 0===v?"":v;case"function":switch(r.name.toLowerCase()){case"position":case"extract":case"char_length":return"integer";case"round":return a=this.evaluateType(e,r.args,t),a instanceof Array?a.length>0?a[0]:"":a;case"sign":return a=this.evaluateType(e,r.args,t),a instanceof Array&&(a=i(a)),"integer"===a||"double"===a?a:"double";case"ceiling":case"floor":case"abs":var f=this.evaluateType(e,r.args,t);return f instanceof Array?i(f):f;case"area":case"length":case"log":case"log10":case"sin":case"cos":case"tan":case"asin":case"acos":case"atan":case"power":return"double";case"substring":case"trim":case"concat":case"lower":case"upper":return"string";case"truncate":return"double";case"round":return a=this.evaluateType(e,r.args,t),a instanceof Array?a.length>0?a[0]:"":a}return""}throw new Error("Unsupported sql syntax "+r.type)},e.prototype.calculateValueCompiled=function(e){return void 0===this.parseTree._compiledVersion&&this._compileMe(),this.parseTree._compiledVersion(e,this.parameters)},e.prototype.getFunctions=function(){var e=[];return this.visitAll(this.parseTree,function(r){"function"===r.type&&e.push(r.name.toLowerCase())}),y(e)},e.prototype.getFields=function(){var e=[];return this.visitAll(this.parseTree,function(r){"column_ref"===r.type&&e.push(r.column)}),y(e)},e.prototype.getVariables=function(){var e=[];return this.visitAll(this.parseTree,function(r){"param"===r.type&&e.push(r.value.toLowerCase())}),y(e)},e.prototype.featureValue=function(e,r,t){var a=e.attributes[r];if(void 0!==a)return a;for(var s in e.attributes)if(r.toLowerCase()===s.toLowerCase())return t.column=s,e.attributes[s];return null},e.prototype.visitAll=function(e,r){if(null!=e)switch(r(e),e.type){case"when_clause":this.visitAll(e.operand,r),this.visitAll(e.value,r);break;case"case_expression":for(var t=0,a=e.clauses;t<a.length;t++){var s=a[t];this.visitAll(s,r)}"simple"===e.format&&this.visitAll(e.operand,r),null!==e.else&&this.visitAll(e.else,r);break;case"expr_list":for(var n=0,o=e.value;n<o.length;n++){var s=o[n];this.visitAll(s,r)}break;case"unary_expr":this.visitAll(e.expr,r);break;case"binary_expr":this.visitAll(e.left,r),this.visitAll(e.right,r);break;case"function":this.visitAll(e.args,r)}},e.prototype.toWhereClause=function(e){return this.evaluateNodeToWhereClause(this.parseTree,e)},e.prototype.reformulateWithoutField=function(r,t){return e.create(this.evaluateNodeToWhereClause(this.parseTree,n.FeatureServiceDatabaseType.Standardised,r,t))},e.prototype.statisticFunction=function(){if("function"===this.parseTree.type){if(0===this.parseTree.args.value.length)return{name:this.parseTree.name,expr:null};if(this.parseTree.args.value.length>1)throw new Error("Statistic does not have 1 or 0 Parameters");var r=new e;return r.parseTree=this.parseTree.args.value[0],{name:this.parseTree.name,expr:r}}return null},e.prototype.testFeatureDeferred=function(e){var r=new t;return this.evaluateNodeDeferred(this.parseTree,e).then(n.callback(function(e){r.resolve(e)},r),n.errback(r)),r.promise},e.prototype.calculateValueDeferred=function(e){var r=new t;return this.evaluateNodeDeferred(this.parseTree,e).then(n.callback(function(e){r.resolve(e)},r),n.errback(r)),r.promise},e.prototype.scanForField=function(e){return this.findField(this.parseTree,e)},e.combine=function(r,t,a){return void 0===a&&(a="AND"),e.create("(("+r.toWhereClause(n.FeatureServiceDatabaseType.Standardised)+")"+a+"("+t.toWhereClause(n.FeatureServiceDatabaseType.Standardised)+"))")},e.prototype.isSingleField=function(){return"column_ref"===this.parseTree.type},e.prototype.findField=function(e,r){if(null===e||void 0===e)return!1;switch(e.type){case"when_clause":return this.findField(e.operand,r)||this.findField(e.value,r);case"case_expression":for(var t=0,a=e.clauses;t<a.length;t++){var s=a[t];if(this.findField(s,r))return!0}return!("simple"!==e.format||!this.findField(e.operand,r))||!(null===e.else||!this.findField(e.else,r));case"param":return!1;case"expr_list":for(var n=0,o=e.value;n<o.length;n++){var s=o[n];if(this.findField(s,r))return!0}return!1;case"unary_expr":return this.findField(e.expr,r);case"binary_expr":return this.findField(e.left,r)||this.findField(e.right,r);case"null":case"bool":case"date":case"timestamp":case"string":case"number":return!1;case"column_ref":return r.toLowerCase()===e.column.toLowerCase();case"function":return this.findField(e.args,r)}return!1},e.prototype.evaluateNode=function(e,r){switch(e.type){case"case_expression":if("simple"===e.format){for(var t=m(this.evaluateNode(e.operand,r)),a=0;a<e.clauses.length;a++)if(t===m(this.evaluateNode(e.clauses[a].operand,r)))return this.evaluateNode(e.clauses[a].value,r);if(null!==e.else)return this.evaluateNode(e.else,r)}else{for(var a=0;a<e.clauses.length;a++)if(p(this.evaluateNode(e.clauses[a].operand,r)))return this.evaluateNode(e.clauses[a].value,r);if(null!==e.else)return this.evaluateNode(e.else,r)}return null;case"param":return this.parameters[e.value.toLowerCase()];case"expr_list":for(var s=[],n=0,l=e.value;n<l.length;n++){var u=l[n];s.push(this.evaluateNode(u,r))}return s;case"unary_expr":return f(this.evaluateNode(e.expr,r));case"binary_expr":switch(e.operator){case"AND":return d(this.evaluateNode(e.left,r),this.evaluateNode(e.right,r));case"OR":return N(this.evaluateNode(e.left,r),this.evaluateNode(e.right,r));case"IS":if("null"!==e.right.type)throw new Error("Unsupported RHS for IS");return null===this.evaluateNode(e.left,r);case"ISNOT":if("null"!==e.right.type)throw new Error("Unsupported RHS for IS");return null!==this.evaluateNode(e.left,r);case"IN":var i=v(this.evaluateNode(e.right,r));return T(this.evaluateNode(e.left,r),i);case"NOT IN":var i=v(this.evaluateNode(e.right,r));return f(T(this.evaluateNode(e.left,r),i));case"BETWEEN":var y=this.evaluateNode(e.left,r),E=this.evaluateNode(e.right,r);return null==y||null==E[0]||null==E[1]?null:y>=E[0]&&y<=E[1];case"NOTBETWEEN":var y=this.evaluateNode(e.left,r),E=this.evaluateNode(e.right,r);return null==y||null==E[0]||null==E[1]?null:y<E[0]||y>E[1];case"LIKE":return g(this.evaluateNode(e.left,r),this.evaluateNode(e.right,r),e.escape);case"NOT LIKE":return f(g(this.evaluateNode(e.left,r),this.evaluateNode(e.right,r),e.escape));case"<>":case"<":case">":case">=":case"<=":case"=":return S(e.operator,this.evaluateNode(e.left,r),this.evaluateNode(e.right,r));case"*":return this.evaluateNode(e.left,r)*this.evaluateNode(e.right,r);case"-":return this.evaluateNode(e.left,r)-this.evaluateNode(e.right,r);case"+":return this.evaluateNode(e.left,r)+this.evaluateNode(e.right,r);case"/":return this.evaluateNode(e.left,r)/this.evaluateNode(e.right,r)}throw new Error("Not Supported Operator "+e.operator);case"null":case"bool":case"string":case"number":return e.value;case"date":return h(e.value);case"timestamp":return c(e.value);case"column_ref":if("CURRENT_DATE"===e.column.toUpperCase()){var u=new Date;return u.setHours(0,0,0,0),u}return"CURRENT_TIMESTAMP"===e.column.toUpperCase()?new Date:this.featureValue(r,e.column,e);case"function":var b=this.evaluateNode(e.args,r);return o.evaluateFunction(e.name,b)}throw new Error("Unsupported sql syntax "+e.type)},e.prototype._makeDateString=function(e,r){var t=s(e),a=0===t.minute()&&0===t.hour()&&0===t.second()&&0===t.millisecond();switch(r){case n.FeatureServiceDatabaseType.FILEGDB:case n.FeatureServiceDatabaseType.Standardised:return a?"date '"+t.format("YYYY-MM-DD")+"'":"date '"+t.format("YYYY-MM-DD HH:mm:ss")+"'";case n.FeatureServiceDatabaseType.Oracle:return a?"TO_DATE('"+t.format("YYYY-MM-DD")+"','YYYY-MM-DD')":"TO_DATE('"+t.format("YYYY-MM-DD HH:mm:ss")+"','YYYY-MM-DD HH24:MI:SS')";case n.FeatureServiceDatabaseType.SqlServer:return"'"+t.format(a?"YYYY-MM-DD":"YYYY-MM-DD HH:mm:ss")+"'";case n.FeatureServiceDatabaseType.PGDB:return"#"+t.format(a?"MM-DD-YYYY":"MM-DD-YYYY HH:mm:ss")+"#";case n.FeatureServiceDatabaseType.Postgres:return"TIMESTAMP '"+t.format(a?"YYYY-MM-DD":"YYYY-MM-DD HH:mm:ss")+"'";default:return"date '"+t.format("YYYY-MM-DD HH:mm:ss")+"'"}},e.prototype._makeToday=function(e,r){switch(r){case n.FeatureServiceDatabaseType.FILEGDB:case n.FeatureServiceDatabaseType.Standardised:case n.FeatureServiceDatabaseType.Oracle:return e?"CURRENT_DATE":"CURRENT_TIMESTAMP";case n.FeatureServiceDatabaseType.SqlServer:return e?"CAST(GETDATE() AS DATE)":"GETDATE()";case n.FeatureServiceDatabaseType.PGDB:case n.FeatureServiceDatabaseType.Postgres:default:return e?"CURRENT_DATE":"CURRENT_TIMESTAMP"}},e.prototype.evaluateNodeToWhereClause=function(e,r,t,a){void 0===t&&(t=null),void 0===a&&(a=null);var s,n,o,l;switch(e.type){case"case_expression":var u=" CASE ";"simple"===e.format&&(u+=this.evaluateNodeToWhereClause(e.operand,r,t,a));for(var i=0;i<e.clauses.length;i++)u+=" WHEN "+this.evaluateNodeToWhereClause(e.clauses[i].operand,r,t,a)+" THEN "+this.evaluateNodeToWhereClause(e.clauses[i].value,r,t,a);return null!==e.else&&(u+=" ELSE "+this.evaluateNodeToWhereClause(e.else,r,t,a)),u+=" END ";case"param":var c=this.parameters[e.value.toLowerCase()];if("string"==typeof c){return"'"+this.parameters[e.value.toLowerCase()].toString().replace(/'/g,"''")+"'"}if(c instanceof Date)return this._makeDateString(c,r);if(c instanceof Array){for(var h=[],i=0;i<c.length;i++)"string"==typeof c[i]?h.push("'"+c[i].toString().replace(/'/g,"''")+"'"):c[i]instanceof Date?h.push(this._makeDateString(c[i],r)):h.push(c[i].toString());return h}return c.toString();case"expr_list":n=[];for(var p=0,v=e.value;p<v.length;p++){var f=v[p];n.push(this.evaluateNodeToWhereClause(f,r,t,a))}return n;case"unary_expr":return" ( NOT "+this.evaluateNodeToWhereClause(e.expr,r,t,a)+" ) ";case"binary_expr":switch(e.operator){case"AND":return" ("+this.evaluateNodeToWhereClause(e.left,r,t,a)+" AND "+this.evaluateNodeToWhereClause(e.right,r,t,a)+") ";case"OR":return" ("+this.evaluateNodeToWhereClause(e.left,r,t,a)+" OR "+this.evaluateNodeToWhereClause(e.right,r,t,a)+") ";case"IS":if("null"!==e.right.type)throw new Error("Unsupported RHS for IS");return" ("+this.evaluateNodeToWhereClause(e.left,r,t,a)+" IS NULL )";case"ISNOT":if("null"!==e.right.type)throw new Error("Unsupported RHS for IS");return" ("+this.evaluateNodeToWhereClause(e.left,r,t,a)+" IS NOT NULL )";case"IN":return s=[],"expr_list"===e.right.type?(s=this.evaluateNodeToWhereClause(e.right,r,t,a)," ("+this.evaluateNodeToWhereClause(e.left,r,t,a)+" IN ("+s.join(",")+")) "):(l=this.evaluateNodeToWhereClause(e.right,r,t,a),l instanceof Array?" ("+this.evaluateNodeToWhereClause(e.left,r,t,a)+" IN ("+l.join(",")+")) ":" ("+this.evaluateNodeToWhereClause(e.left,r,t,a)+" IN ("+l+")) ");case"NOT IN":return s=[],"expr_list"===e.right.type?(s=this.evaluateNodeToWhereClause(e.right,r,t,a)," ("+this.evaluateNodeToWhereClause(e.left,r,t,a)+" NOT IN ("+s.join(",")+")) "):(l=this.evaluateNodeToWhereClause(e.right,r,t,a),l instanceof Array?" ("+this.evaluateNodeToWhereClause(e.left,r,t,a)+" NOT IN ("+l.join(",")+")) ":" ("+this.evaluateNodeToWhereClause(e.left,r,t,a)+" NOT IN ("+l+")) ");case"BETWEEN":return o=this.evaluateNodeToWhereClause(e.right,r,t,a)," ("+this.evaluateNodeToWhereClause(e.left,r,t,a)+" BETWEEN "+o[0]+" AND "+o[1]+" ) ";case"NOTBETWEEN":return o=this.evaluateNodeToWhereClause(e.right,r,t,a)," ("+this.evaluateNodeToWhereClause(e.left,r,t,a)+" NOT BETWEEN "+o[0]+" AND "+o[1]+" ) ";case"LIKE":return""!==e.escape?" ("+this.evaluateNodeToWhereClause(e.left,r,t,a)+" LIKE "+this.evaluateNodeToWhereClause(e.right,r,t,a)+" ESCAPE '"+e.escape+"') ":" ("+this.evaluateNodeToWhereClause(e.left,r,t,a)+" LIKE "+this.evaluateNodeToWhereClause(e.right,r,t,a)+") ";case"NOT LIKE":return""!==e.escape?" ("+this.evaluateNodeToWhereClause(e.left,r,t,a)+" NOT LIKE "+this.evaluateNodeToWhereClause(e.right,r,t,a)+" ESCAPE '"+e.escape+"') ":" ("+this.evaluateNodeToWhereClause(e.left,r,t,a)+" NOT LIKE "+this.evaluateNodeToWhereClause(e.right,r,t,a)+") ";case"<>":case"<":case">":case">=":case"<=":case"=":case"*":case"-":case"+":case"/":return" ("+this.evaluateNodeToWhereClause(e.left,r,t,a)+" "+e.operator+" "+this.evaluateNodeToWhereClause(e.right,r,t,a)+") "}throw new Error("Not Supported Operator "+e.operator);case"null":return"null";case"bool":return!0===e.value?"1":"0";case"string":return"'"+e.value.toString().replace(/'/g,"''")+"'";case"timestamp":case"date":return this._makeDateString(e.value,r);case"number":return e.value.toString();case"column_ref":return"CURRENT_DATE"===e.column.toUpperCase()?this._makeToday(!0,r):"CURRENT_TIMESTAMP"===e.column.toUpperCase()?this._makeToday(!1,r):t&&t.toLowerCase()===e.column.toLowerCase()?"("+a+")":e.column;case"function":var d=this.evaluateNodeToWhereClause(e.args,r,t,a);return this._translateFunctionToDatabaseSpecific(e.name,d,r)}throw new Error("Unsupported sql syntax "+e.type)},e.prototype._translateFunctionToDatabaseSpecific=function(e,r,t){switch(e.toLowerCase().trim()){case"abs":if(1!==r.length)throw new Error("Invalid Parameter for call to ABS");return"abs("+r[0]+")";case"ceiling":case"ceil":if(1!==r.length)throw new Error("Invalid Parameter for call to CEILING");switch(t){case n.FeatureServiceDatabaseType.Standardised:default:return"CEILING("+r[0]+")"}case"floor":if(1!==r.length)throw new Error("Invalid Parameter for call to Floor");return"FLOOR("+r[0]+")";case"log":if(1!==r.length)throw new Error("Invalid Parameter for call to LOG");return"LOG("+r[0]+")";case"log10":if(1!==r.length)throw new Error("Invalid Parameter for call to LOG10");return"LOG10("+r[0]+")";case"power":if(2!==r.length)throw new Error("Invalid Parameter for call to POWER");return"POWER("+r[0]+","+r[1]+")";case"round":if(2===r.length)return"ROUND("+r[0]+","+r[1]+")";if(1===r.length)return"ROUND("+r[0]+")";throw new Error("Invalid Parameter for call to ROUND");case"truncate":if(r.length<1||r.length>2)throw new Error("Invalid Parameter for TRUNCATE function");switch(t){case n.FeatureServiceDatabaseType.SqlServer:return"ROUND("+r[0]+(1===r.length?"0":","+r[1])+",1)";default:return"TRUNCATE("+r[0]+(1===r.length?")":","+r[1]+")")}case"char_length":case"len":if(1!==r.length)throw new Error("Invalid Parameter for CHAR_LENGTH function");switch(t){case n.FeatureServiceDatabaseType.SqlServer:return"LEN("+r[0]+")";case n.FeatureServiceDatabaseType.Oracle:return"LENGTH("+r[0]+")";default:return"CHAR_LENGTH("+r[0]+")"}case"concat":if(r.length<1)throw new Error("Invalid Parameter for CONCAT function");for(var a="CONCAT(",s=0;s<r.length;s++)0!==s&&(a+=","),a+=r[s];return a+=")";case"lower":case"lcase":if(1!==r.length)throw new Error("Invalid Parameter for Lower function");return"LOWER("+r[0]+")";case"upper":case"ucase":if(1!==r.length)throw new Error("Invalid Parameter for Upper function");return"UPPER("+r[0]+")";case"substring":var o="";switch(t){case n.FeatureServiceDatabaseType.Oracle:return o="SUBSTR("+r[0]+","+r[1],3===r.length&&(o+=","+r[2]),o+=")";case n.FeatureServiceDatabaseType.SqlServer:return o=3===r.length?"SUBSTRING("+r[0]+","+r[1]+","+r[2]+")":"SUBSTRING("+r[0]+",  "+r[1]+", LEN("+r[0]+") - "+r[1]+")";default:return o="SUBSTRING("+r[0]+" FROM "+r[1],3===r.length&&(o+=" FOR "+r[2]),o+=")"}case"extract":return"EXTRACT("+r[0].replace(/\'/g,"")+" FROM "+r[1]+")"}throw new Error("Function Not Recognised")},e.prototype.evaluateWhereClausesSimpleDeferred=function(e,r,a,s,n){var o=this,l=new t;try{r>=e.length?null===a?l.resolve(null):this.evaluateNodeDeferred(a,n).then(function(e){l.resolve(e)},function(e){l.reject(e)}):this.evaluateNodeDeferred(e[r],n).then(function(t){try{s===m(t)?o.evaluateNodeDeferred(e[r].value,n).then(function(e){l.resolve(e)},function(e){l.reject(e)}):o.evaluateWhereClausesSimpleDeferred(e,r+1,a,s,n).then(function(e){l.resolve(e)},function(e){l.reject(e)})}catch(e){l.reject(e)}},function(e){l.reject(e)})}catch(e){l.reject(e)}return l.promise},e.prototype.evaluateWhereClausesDeferred=function(e,r,a,s){var n=this,o=new t;try{r>=e.length?null===a?o.resolve(null):this.evaluateNodeDeferred(a,s).then(function(e){o.resolve(e)},function(e){o.reject(e)}):this.evaluateNodeDeferred(e[r].operand,s).then(function(t){try{p(t)?n.evaluateNodeDeferred(e[r].value,s).then(function(e){o.resolve(e)},function(e){o.reject(e)}):n.evaluateWhereClausesDeferred(e,r+1,a,s).then(function(e){o.resolve(e)},function(e){o.reject(e)})}catch(e){o.reject(e)}},function(e){o.reject(e)})}catch(e){o.reject(e)}return o.promise},e.prototype.evaluateNodeDeferred=function(e,r){var s,o=this,l=new t;try{var u=void 0;switch(e.type){case"case_expression":"simple"===e.format?this.evaluateNodeDeferred(e.operand,r).then(function(t){var a=m(t);o.evaluateWhereClausesSimpleDeferred(e.clauses,0,e.else,a,r).then(function(e){l.resolve(e)},function(e){l.reject(e)})},function(e){l.reject(e)}):this.evaluateWhereClausesDeferred(e.clauses,0,e.else,r).then(function(e){l.resolve(e)},function(e){l.reject(e)});break;case"param":l.resolve(this.parameters[e.value.toLowerCase()]);break;case"expr_list":u=[];for(var i=0,p=e.value;i<p.length;i++){var v=p[i];u.push(this.evaluateNodeDeferred(v,r))}a(u).then(n.callback(function(e){l.resolve(e)},l),n.errback(l));break;case"unary_expr":this.evaluateNodeDeferred(e.value,r).then(n.callback(function(e){l.resolve(f(e))},l),n.errback(l));break;case"binary_expr":switch(e.operator){case"IS":"null"!==e.right.type?l.reject(new Error("Unsupported RHS for IS")):this.evaluateNodeDeferred(e.left,r).then(n.callback(function(e){l.resolve(null===e)},l),n.errback(l));break;case"ISNOT":"null"!==e.right.type?l.reject(new Error("Unsupported RHS for IS")):this.evaluateNodeDeferred(e.left,r).then(n.callback(function(e){l.resolve(null!==e)},l),n.errback(l));break;case"LIKE":case"NOT LIKE":case"BETWEEN":case"NOTBETWEEN":case"IN":case"NOT IN":case"AND":case"OR":case"<>":case"<":case">":case">=":case"<=":case"=":case"*":case"-":case"+":case"/":s=[this.evaluateNodeDeferred(e.left,r),this.evaluateNodeDeferred(e.right,r)],a(s).then(n.callback(function(r){switch(e.operator){case"LIKE":case"NOT LIKE":var t=g(r[0],r[0],e.escape);l.resolve("LIKE"===e.operator?t:f(t));break;case"BETWEEN":var a=r[0],s=r[1];l.resolve(null==a||null==s[0]||null==s[1]?null:a>=s[0]&&a<=s[1]);break;case"NOTBETWEEN":var n=r[0],o=r[1];l.resolve(null==n||null==o[0]||null==o[1]?null:n<o[0]||n>o[1]);break;case"IN":case"NOT IN":var u=null;u=r[1]instanceof Array?r[1]:[u],"IN"===e.operator?l.resolve(T(r[0],u)):"NOT IN"===e.operator&&l.resolve(f(T(r[0],u)));break;case"AND":l.resolve(d(r[0],r[1]));break;case"OR":l.resolve(N(r[0],r[1]));break;case"<>":case"<":case">":case">=":case"<=":case"=":l.resolve(S(e.operator,r[0],r[1]));break;case"*":l.resolve(r[0]*r[1]);break;case"-":l.resolve(r[0]-r[1]);break;case"+":l.resolve(r[0]+r[1]);break;case"/":l.resolve(r[0]/r[1]);break;default:l.reject(new Error("Unrecognised operator"))}},l),n.errback(l));break;default:l.reject(new Error("Not Supported Operator "+e.operator))}break;case"null":case"bool":case"string":case"number":l.resolve(e.value);break;case"date":l.resolve(h(e.value));break;case"timestamp":l.resolve(c(e.value));break;case"column_ref":if("CURRENT_DATE"===e.column.toUpperCase()){var v=new Date;v.setHours(0,0,0,0),l.resolve(v)}else if("CURRENT_TIMESTAMP"===e.column.toUpperCase()){var y=new Date;l.resolve(y)}else l.resolve(this.featureValue(r,e.column,e));break;case"function":this.evaluateNodeDeferred(e.args,r).then(n.callback(function(t){o.executeFunctionDeferred(e.name,r,t).then(n.callback(function(e){l.resolve(e)},l),n.errback(l))},l),n.errback(l));break;default:l.reject(new Error("Malformed Where Clause"))}}catch(e){l.reject(e)}return l.promise},e.prototype.executeFunctionDeferred=function(e,r,a){var s=new t,l=0;try{if(o.isStandardized(e,a.length))s.resolve(o.evaluateFunction(e,a));else switch(e.toLowerCase().trim()){case"area":l=n.convertSquareUnitsToCode(a[0]);var i=!1;void 0!==a[1]&&null!==a[1]&&("1"!==a[1].toString()&&"true"!==a[1].toString().toLowerCase()&&"geodesic"!==a[1].toString().toLowerCase()||(i=!0)),null===r.geometry?s.resolve(0):i?u.geodesicArea(r.geometry,l).then(n.callback(function(e){s.resolve(e)},s),n.errback(s)):u.planarArea(r.geometry,l).then(n.callback(function(e){s.resolve(e)},s),n.errback(s));break;case"length":l=n.convertLinearUnitsToCode(a[0]);void 0!==a[1]&&null!==a[1]&&("1"!==a[1].toString()&&"true"!==a[1].toString().toLowerCase()&&"geodesic"!==a[1].toString().toLowerCase()||(i=!0)),null===r.geometry?s.resolve(0):u.planarLength(r.geometry,l).then(n.callback(function(e){s.resolve(e)},s),n.errback(s));break;default:s.reject(new Error("Function Not Recognised"))}}catch(e){s.reject(e)}return s.promise},e}()});