// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.10/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/extendsHelper","dojo/Deferred","../support/FeatureSet","../support/IdSet","../support/shared"],function(e,t,n,r,a,s,o){var i=function(e){function t(t){var n=e.call(this,t)||this;return n._topnum=0,n.declaredClass="esri.arcade.featureset.actions.Top",n._countedin=0,n._maxProcessing=100,n._topnum=t.topnum,n._parent=t.parentfeatureset,n}return n(t,e),t.prototype._getSet=function(e){var t=this,n=new r;return null===this._wset?this._ensureLoaded().then(o.callback(function(){t._parent._getSet(e).then(o.callback(function(e){t._wset=new s(e._candidates.slice(0),e._known.slice(0),!1,t._clonePageDefinition(e.pagesDefinition)),t._setKnownLength(t._wset)>t._topnum&&(t._wset._known=t._wset._known.slice(0,t._topnum)),t._setKnownLength(t._wset)>=t._topnum&&(t._wset._candidates=[]),n.resolve(t._wset)},n),o.errback(n))},n),o.errback(n)):n.resolve(this._wset),n.promise},t.prototype._setKnownLength=function(e){return e._known.length>0&&"GETPAGES"===e._known[e._known.length-1]?e._known.length-1:e._known.length},t.prototype._isInFeatureSet=function(e){var t=this._parent._isInFeatureSet(e);if(t===o.IdState.NotInFeatureSet)return t;var n=this._idstates[e];return n===o.IdState.InFeatureSet||n===o.IdState.NotInFeatureSet?n:t===o.IdState.InFeatureSet&&void 0===n?this._countedin<this._topnum?(this._idstates[e]=o.IdState.InFeatureSet,this._countedin++,o.IdState.InFeatureSet):(this._idstates[e]=o.IdState.NotInFeatureSet,o.IdState.NotInFeatureSet):o.IdState.Unknown},t.prototype._expandPagedSet=function(e,t,n,a,s){var i=this,u=new r;if(null===this._parent){var _=new r;return _.reject(new Error("Parent Paging not implemented")),_.promise}if(t>this._topnum&&(t=this._topnum),this._countedin>=this._topnum&&e.pagesDefinition.internal.set.length<=e.pagesDefinition.resultOffset){var c=e._known.length;return c>0&&"GETPAGES"===e._known[c-1]&&(e._known.length=c-1),c=e._candidates.length,c>0&&"GETPAGES"===e._candidates[c-1]&&(e._candidates.length=c-1),u.resolve("success"),u.promise}return this._parent._expandPagedSet(e,t,n,a,s).then(o.callback(function(t){i._setKnownLength(e)>i._topnum&&(e._known.length=i._topnum),i._setKnownLength(e)>=i._topnum&&(e._candidates.length=0),u.resolve(t)},u),o.errback(u)),u.promise},t.prototype._getFeatures=function(e,t,n,a){var i=this,u=new r,_=[],c=this._maxQueryRate();if(!0===this._checkIfNeedToExpandKnownPage(e,c,a))return this._expandPagedSet(e,c,0,0,a).then(o.callback(function(r){i._getFeatures(e,t,n,a).then(o.callback(function(e){u.resolve(e)},u),o.errback(u))},u),o.errback(u)),u.promise;-1!==t&&void 0===this._featureCache[t]&&_.push(t);for(var p=0,h=e._lastFetchedIndex;h<e._known.length&&(p++,p<=n&&(e._lastFetchedIndex+=1),!(void 0===this._featureCache[e._known[h]]&&(e._known[h]!==t&&_.push(e._known[h]),_.length>c-1)));h++);if(0===_.length)u.resolve("success");else{var d=new s([],_,!1,null),l=Math.min(_.length,n);this._parent._getFeatures(d,-1,l,a).then(o.callback(function(e){for(var t=0;t<l;t++){var n=i._parent._featureFromCache(_[t]);void 0!==n&&(i._featureCache[_[t]]=n)}u.resolve("success")},u),o.errback(u))}return u.promise},t.prototype._getFilteredSet=function(e,t,n,a,i){var u=this,_=new r;return this._ensureLoaded().then(o.callback(function(){u._getSet(i).then(o.callback(function(e){var t=new s(e._candidates.slice(0).concat(e._known.slice(0)),[],!1,u._clonePageDefinition(e.pagesDefinition));_.resolve(t)},_),o.errback(_))},_),o.errback(_)),_.promise},t.prototype._refineKnowns=function(e,t){for(var n=0,r=null,a=[],s=0;s<e._candidates.length;s++){var i=this._isInFeatureSet(e._candidates[s]);if(i===o.IdState.InFeatureSet){if(e._known.push(e._candidates[s]),n+=1,null===r?r={start:s,end:s}:r.end===s-1?r.end=s:(a.push(r),r={start:s,end:s}),e._known.length>=this._topnum)break}else if(i===o.IdState.NotInFeatureSet)null===r?r={start:s,end:s}:r.end===s-1?r.end=s:(a.push(r),r={start:s,end:s}),n+=1;else if(i===o.IdState.Unknown)break;if(n>=t)break}null!==r&&a.push(r);for(var u=a.length-1;u>=0;u--)e._candidates.splice(a[u].start,a[u].end-a[u].start+1);this._setKnownLength(e)>this._topnum&&(e._known=e._known.slice(0,this._topnum)),this._setKnownLength(e)>=this._topnum&&(e._candidates=[])},t.prototype._stat=function(e,t,n,a,s,o,i){var u=new r;return u.resolve({calculated:!1}),u.promise},t.prototype._canDoAggregates=function(e,t,n,a,s){var o=new r;return o.resolve(!1),o.promise},t.prototype.arcadeScriptStep=function(e,t,n){var r=this.arcadeAssignNextScriptStepIdentifiers(n);return"var "+r.newFeatureSet+" = "+this.bigDataCachePipeline("top( "+r.currentFeatureSet+","+this._topnum.toString()+")")+"; "},t}(a);return a._featuresetFunctions.top=function(e){return new i({parentfeatureset:this,topnum:e})},i});