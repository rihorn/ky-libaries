// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.10/esri/copyright.txt for details.

define(["require","exports"],function(e,t){function n(e,n){var r=t.functionDecls[e.name.toLowerCase()];void 0===r?t.functionDecls[e.name.toLowerCase()]="sync"===n?{min:e.min,max:e.max}:{fmin:e.min,fmax:e.max}:"sync"===n?(r.min=e.min,r.max=e.max):(r.fmin=e.min,r.fmax=e.max)}function r(e,t,n,r){return"0"!==e.min&&n.length<Number(e.min)?-2:"*"!==e.max&&n.length>Number(e.max)?-2:1}function a(e,t,n){if(null!==n.localScope&&void 0!==n.localScope[e.toLowerCase()]){var a=n.localScope[e.toLowerCase()];if("FormulaFunction"===a.type)return void 0===a.signature&&(a.signature={min:"0",max:"*"}),r(a.signature,e,t,n);if("any"===a.type)return void 0===a.signature&&(a.signature={min:"0",max:"*"}),r(a.signature,e,t,n)}if(void 0!==n.globalScope[e.toLowerCase()]){var a=n.globalScope[e.toLowerCase()];if("FormulaFunction"===a.type)return void 0===a.signature&&(a.signature={min:"0",max:"*"}),r(a.signature,e,t,n);if("any"===a.type)return void 0===a.signature&&(a.signature={min:"0",max:"*"}),r(a.signature,e,t,n)}return-1}function s(e,t){void 0===t&&(t=!0);var n=N(e,"SYNTAX","UNREOGNISED");try{switch(e.type){case"VariableDeclarator":return null!==e.init&&"FunctionExpression"===e.init.type?N(e,"SYNTAX","FUNCTIONVARIABLEDECLARATOR"):"Identifier"!==e.id.type?N(e,"SYNTAX","VARIABLEMUSTHAVEIDENTIFIER"):null!==e.init?s(e.init,!1):"";case"VariableDeclaration":for(var r=0;r<e.declarations.length;r++)if(""!==(n=s(e.declarations[r],t)))return n;return"";case"ForInStatement":if(""!==(n=s(e.left,t)))return n;if("VariableDeclaration"===e.left.type){if(e.left.declarations.length>1)return N(e,"SYNTAX","ONLY1VAR");if(null!==e.left.declarations[0].init)return N(e,"SYNTAX","CANNOTDECLAREVAL")}else if("Identifier"!==e.left.type)return N(e,"SYNTAX","LEFTNOTVAR");return""!==(n=s(e.right,t))?n:(n=s(e.body,t),""!==n?n:"");case"ForStatement":return null!==e.test&&""!==(n=s(e.test,t))?n:null!==e.init&&""!==(n=s(e.init,t))?n:null!==e.update&&""!==(n=s(e.update,t))?n:null!==e.body&&""!==(n=s(e.body,t))?n:"";case"ContinueStatement":case"EmptyStatement":case"BreakStatement":return"";case"IfStatement":return n=s(e.test,t),""!==n?n:null!==e.consequent&&""!==(n=s(e.consequent,!1))?n:null!==e.alternate&&""!==(n=s(e.alternate,!1))?n:"";case"BlockStatement":for(var a=[],r=0;r<e.body.length;r++)"EmptyStatement"!==e.body[r].type&&a.push(e.body[r]);e.body=a;for(var r=0;r<e.body.length;r++)if(""!==(n=s(e.body[r],t)))return n;return"";case"FunctionDeclaration":return!1===t?N(e,"SYNTAX","GLOBALFUNCTIONSONLY"):"Identifier"!==e.id.type?N(e,"SYNTAX","FUNCTIONMUSTHAVEIDENTIFIER"):s(e.body,!1);case"ReturnStatement":return null!==e.argument?s(e.argument,t):"";case"UpdateExpression":return"Identifier"!==e.argument.type&&"MemberExpression"!==e.argument.type?N(e,"SYNTAX","ASSIGNMENTTOVARSONLY"):s(e.argument,t);case"AssignmentExpression":if("Identifier"!==e.left.type&&"MemberExpression"!==e.left.type)return N(e,"SYNTAX","ASSIGNMENTTOVARSONLY");if(""!==(n=s(e.left,t)))return n;switch(e.operator){case"=":case"/=":case"*=":case"%=":case"+=":case"-=":break;default:return N(e,"SYNTAX","OPERATORNOTRECOGNISED")}return s(e.right,!1);case"ExpressionStatement":return"AssignmentExpression"===e.expression.type?s(e.expression,!1):(e.expression.type,s(e.expression,!1));case"Identifier":n="";break;case"MemberExpression":return n=s(e.object,t),""!==n?n:!0===e.computed?s(e.property,t):"";case"Literal":return"";case"ThisExpression":return N(e,"SYNTAX","NOTSUPPORTED");case"CallExpression":if("Identifier"!==e.callee.type)return N(e,"SYNTAX","ONLYNODESSUPPORTED");n="";for(var r=0;r<e.arguments.length;r++)if(""!==(n=s(e.arguments[r],t)))return n;return"";case"UnaryExpression":n=s(e.argument,t);break;case"BinaryExpression":if(""!==(n=s(e.left,t)))return n;if(""!==(n=s(e.right,t)))return n;switch(e.operator){case"==":case"!=":case"<":case"<=":case">":case">=":case"+":case"-":case"*":case"/":case"%":break;default:return N(e,"SYNTAX","OPERATORNOTRECOGNISED")}return"";case"LogicalExpression":if(""!==(n=s(e.left,t)))return n;if(""!==(n=s(e.right)))return n;switch(e.operator){case"&&":case"||":break;default:return N(e,"SYNTAX","OPERATORNOTRECOGNISED")}return"";case"ConditionalExpression":return N(e,"SYNTAX","NOTSUPPORTED");case"ArrayExpression":n="";for(var r=0;r<e.elements.length;r++)if(""!==(n=s(e.elements[r],t)))return n;return n;case"Array":return N(e,"SYNTAX","NOTSUPPORTED");case"ObjectExpression":n="";for(var r=0;r<e.properties.length;r++){if(n="",null!==e.properties[r].key&&("Literal"!==e.properties[r].key.type&&"Identifier"!==e.properties[r].key.type&&(n=N(e,"SYNTAX","OBJECTPROPERTYMUSTBESTRING")),"Literal"===e.properties[r].key.type)){var i=e.properties[r].key.value;"string"==typeof i||i instanceof String||(n=N(e,"SYNTAX","OBJECTPROPERTYMUSTBESTRING"))}if(""===n&&(n=s(e.properties[r],t)),""!==n)return n}return n;case"Property":return"Literal"!==e.key.type&&"Identifier"!==e.key.type?N(e,"SYNTAX","ONLYLITERAL"):"Identifier"!==e.key.type&&""!==(n=s(e.key,t))?n:n=s(e.value,t);default:return n}return n}catch(e){throw e}}function i(e,t){var n=N(e,"SYNTAX","UNREOGNISED"),r=null,s="";try{switch(e.type){case"VariableDeclarator":if(null!==e.init&&"FunctionExpression"===e.init.type)return N(e,"SYNTAX","FUNCTIONVARIABLEDECLARATOR");null!==t.localScope?t.localScope[e.id.name.toLowerCase()]:t.globalScope[e.id.name.toLowerCase()];var o=null===e.init?"":i(e.init,t);return""!==o?o:(null===t.localScope?t.globalScope[e.id.name.toLowerCase()]={type:"any"}:t.localScope[e.id.name.toLowerCase()]={type:"any"},"");case"FunctionDeclaration":return r=d(e.id.name.toLowerCase(),e,t),""!==(s=y(e,t))?s:null!==t.localScope?N(e,"SYNTAX","GLOBALFUNCTIONSONLY"):(r.isnative=!1,t.globalScope[e.id.name.toLowerCase()]={type:"FormulaFunction",signature:[r]},"");case"VariableDeclaration":n="";for(var c=0;c<e.declarations.length;c++)if(""!==(n=i(e.declarations[c],t)))return n;return n;case"IfStatement":return n=i(e.test,t),""!==n?n:"AssignmentExpression"===e.test.type||"UpdateExpression"===e.test.type?N(e.test,"SYNTAX","CANNOT_USE_ASSIGNMENT_IN_CONDITION"):null!==e.consequent&&""!==(n=i(e.consequent,t))?n:null!==e.alternate&&""!==(n=i(e.alternate,t))?n:"";case"EmptyStatement":return"";case"BlockStatement":for(var c=0;c<e.body.length;c++)if(""!==(n=i(e.body[c],t)))return n;return"";case"ReturnStatement":return null!==e.argument?i(e.argument,t):"";case"ForInStatement":if("VariableDeclaration"===e.left.type){if(e.left.declarations.length>1)return N(e,"SYNTAX","ONLY1VAR");if(null!==e.left.declarations[0].init)return N(e,"SYNTAX","CANNOTDECLAREVAL")}else if("Identifier"!==e.left.type)return N(e,"SYNTAX","LEFTNOTVAR");return""!==(n=i(e.left,t))?n:""!==(n=i(e.right,t))?n:(n=i(e.body,t),""!==n?n:"");case"ForStatement":return null!==e.init&&""!==(n=i(e.init,t))?n:null!==e.test&&""!==(n=i(e.test,t))?n:null!==e.body&&""!==(n=i(e.body,t))?n:null!==e.update&&""!==(n=i(e.update,t))?n:"";case"BreakStatement":case"ContinueStatement":return"";case"UpdateExpression":if("Identifier"!==e.argument.type&&"MemberExpression"!==e.argument.type)return N(e,"SYNTAX","ASSIGNMENTTOVARSONLY");var l=!1;return"MemberExpression"===e.argument.type?i(e.argument,t):(null!==t.localScope&&void 0!==t.localScope[e.argument.name.toLowerCase()]&&(l=!0),void 0!==t.globalScope[e.argument.name.toLowerCase()]&&(l=!0),!1===l?"Identifier "+e.argument.name+" has not been declared.":"");case"AssignmentExpression":if("Identifier"!==e.left.type&&"MemberExpression"!==e.left.type)return N(e,"SYNTAX","ASSIGNMENTTOVARSONLY");var u=i(e.right,t);return""!==u?u:(l=!1,"MemberExpression"===e.left.type?(u=i(e.left,t),""!==u?u:""):(null!==t.localScope&&void 0!==t.localScope[e.left.name.toLowerCase()]&&(l=!0),void 0!==t.globalScope[e.left.name.toLowerCase()]&&(l=!0),!1===l?"Identifier "+e.left.name+" has not been declared.":""));case"ExpressionStatement":return"AssignmentExpression"===e.expression.type?i(e.expression,t):(e.expression.type,i(e.expression,t));case"Identifier":var m=e.name.toLowerCase();if(null!==t.localScope&&void 0!==t.localScope[m])return"";n=void 0!==t.globalScope[m]?"":N(e,"SYNTAX","VARIABLENOTFOUND");break;case"MemberExpression":return n=i(e.object,t),""!==n?n:!0===e.computed?i(e.property,t):"";case"Literal":return"";case"ThisExpression":n=N(e,"SYNTAX","NOTSUPPORTED");break;case"CallExpression":if("Identifier"!==e.callee.type)return N(e,"SYNTAX","ONLYNODESSUPPORTED");n="";for(var c=0;c<e.arguments.length;c++)if(""!==(n=i(e.arguments[c],t)))return n;var p=a(e.callee.name,e.arguments,t);-1===p&&(n=N(e,"SYNTAX","NOTFOUND")),-2===p&&(n=N(e,"SYNTAX","WRONGSIGNATURE"));break;case"UnaryExpression":n=i(e.argument,t);break;case"BinaryExpression":return""!==(n=i(e.left,t))?n:(n=i(e.right,t),""!==n?n:"");case"LogicalExpression":return""!==(n=i(e.left,t))?n:"AssignmentExpression"===e.left.type||"UpdateExpression"===e.left.type?N(e.left,"SYNTAX","CANNOT_USE_ASSIGNMENT_IN_CONDITION"):(n=i(e.right,t),""!==n?n:"AssignmentExpression"===e.right.type||"UpdateExpression"===e.right.type?N(e.right,"SYNTAX","CANNOT_USE_ASSIGNMENT_IN_CONDITION"):"");case"ConditionalExpression":return N(e,"SYNTAX","NOTSUPPORTED");case"ArrayExpression":n="";for(var c=0;c<e.elements.length;c++)if(""!==(n=i(e.elements[c],t)))return n;return n;case"ObjectExpression":n="";for(var c=0;c<e.properties.length;c++){if(n="",null!==e.properties[c].key&&("Literal"!==e.properties[c].key.type&&"Identifier"!==e.properties[c].key.type&&(n=N(e,"SYNTAX","OBJECTPROPERTYMUSTBESTRING")),"Literal"===e.properties[c].key.type)){var f=e.properties[c].key.value;"string"==typeof f||f instanceof String||(n=N(e,"SYNTAX","OBJECTPROPERTYMUSTBESTRING"))}if(""===n&&(n=i(e.properties[c],t)),""!==n)return n}return n;case"Property":return"Literal"!==e.key.type&&"Identifier"!==e.key.type?N(e,"SYNTAX","ONLYLITERAL"):"Identifier"!==e.key.type&&""!==(n=i(e.key,t))?n:n=i(e.value,t);case"Array":return N(e,"SYNTAX","NOTSUPPORTED");default:return n}return n}catch(e){throw e}}function o(e,t){var n=!1;try{switch(e.type){case"VariableDeclarator":return null!==e.init?(e.init.type,o(e.init,t)):n;case"FunctionDeclaration":return o(e.body,t);case"VariableDeclaration":for(var r=0;r<e.declarations.length;r++)if(o(e.declarations[r],t))return!0;return n;case"IfStatement":return!!o(e.test,t)||(!(null===e.consequent||!o(e.consequent,t))||(!(null===e.alternate||!o(e.alternate,t))||n));case"EmptyStatement":return n;case"BlockStatement":for(var r=0;r<e.body.length;r++)if(o(e.body[r],t))return!0;return n;case"ReturnStatement":return null!==e.argument?o(e.argument,t):n;case"UpdateExpression":return o(e.argument,t);case"AssignmentExpression":return(n=o(e.right,t))||o(e.left,t);case"ExpressionStatement":return"AssignmentExpression"===e.expression.type?o(e.expression,t):(e.expression.type,o(e.expression,t));case"ForInStatement":return(n=o(e.left,t))?n:(n=o(e.right,t))?n:(n=o(e.body,t))||n;case"ForStatement":return null!==e.init&&(n=o(e.init,t))?n:null!==e.test&&(n=o(e.test,t))?n:null!==e.body&&(n=o(e.body,t))?n:(null!==e.update&&(n=o(e.update,t)),n);case"BreakStatement":case"ContinueStatement":case"Compound":return n;case"Identifier":return t.toLowerCase()===e.name.toLowerCase();case"MemberExpression":return(n=o(e.object,t))?n:(!0===e.computed&&(n=o(e.property,t)),n);case"Literal":case"ThisExpression":return n;case"CallExpression":for(var r=0;r<e.arguments.length;r++)o(e.arguments[r],t)&&(n=!0);return n;case"ArrayExpression":for(var r=0;r<e.elements.length;r++)o(e.elements[r],t)&&(n=!0);return n;case"UnaryExpression":return o(e.argument,t);case"BinaryExpression":case"LogicalExpression":return(n=o(e.left,t))?n:n=o(e.right,t);case"ObjectExpression":for(var r=0;r<e.properties.length;r++)o(e.properties[r],t)&&(n=!0);return n;case"Property":return n=o(e.value,t);case"ConditionalExpression":case"Array":default:return n}}catch(e){throw e}}function c(e,t){return!0===o(e.body[0].body,t.toLowerCase())}function l(e,t){var n=!1;try{switch(e.type){case"VariableDeclarator":return null!==e.init?(e.init.type,l(e.init,t)):n;case"FunctionDeclaration":return l(e.body,t);case"VariableDeclaration":for(var r=0;r<e.declarations.length;r++)if(l(e.declarations[r],t))return!0;return n;case"IfStatement":return!!l(e.test,t)||(!(null===e.consequent||!l(e.consequent,t))||(!(null===e.alternate||!l(e.alternate,t))||n));case"EmptyStatement":return n;case"BlockStatement":for(var r=0;r<e.body.length;r++)if(l(e.body[r],t))return!0;return n;case"ReturnStatement":return null!==e.argument?l(e.argument,t):n;case"UpdateExpression":return l(e.argument,t);case"AssignmentExpression":return!!l(e.left,t)||l(e.right,t);case"ExpressionStatement":return"AssignmentExpression"===e.expression.type?l(e.expression,t):(e.expression.type,l(e.expression,t));case"ForInStatement":return(n=l(e.left,t))?n:(n=l(e.right,t))?n:(n=l(e.body,t))||n;case"ForStatement":return null!==e.init&&(n=l(e.init,t))?n:null!==e.test&&(n=l(e.test,t))?n:null!==e.body&&(n=l(e.body,t))?n:(null!==e.update&&(n=l(e.update,t)),n);case"BreakStatement":case"ContinueStatement":case"Compound":case"Identifier":return n;case"MemberExpression":return(n=l(e.object,t))?n:(!0===e.computed&&(n=l(e.property,t)),n);case"Literal":case"ThisExpression":return n;case"CallExpression":if(e.callee.name.toLowerCase()===t.toLowerCase())return!0;for(var r=0;r<e.arguments.length;r++)l(e.arguments[r],t)&&(n=!0);return n;case"ArrayExpression":for(var r=0;r<e.elements.length;r++)l(e.elements[r],t)&&(n=!0);return n;case"UnaryExpression":return l(e.argument,t);case"BinaryExpression":case"LogicalExpression":return(n=l(e.left,t))?n:n=l(e.right,t);case"ConditionalExpression":return n;case"ObjectExpression":for(var r=0;r<e.properties.length;r++)l(e.properties[r],t)&&(n=!0);return n;case"Property":return n=l(e.value,t);case"Array":default:return n}}catch(e){throw e}}function u(e,t){return!0===l(e.body[0].body,t)}function m(e,t){var n,r=[];try{switch(e.type){case"VariableDeclarator":return null!==e.init?(e.init.type,m(e.init,t)):r;case"FunctionDeclaration":return m(e.body,t);case"VariableDeclaration":for(var a=0;a<e.declarations.length;a++)n=m(e.declarations[a],t),r=r.concat(n);return r;case"ForInStatement":return n=m(e.left,t),r=r.concat(n),n=m(e.right,t),r=r.concat(n),n=m(e.body,t),r=r.concat(n);case"ForStatement":return null!==e.init&&(n=m(e.init,t),r=r.concat(n)),null!==e.test&&(n=m(e.test,t),r=r.concat(n)),null!==e.body&&(n=m(e.body,t),r=r.concat(n)),null!==e.update&&(n=m(e.update,t),r=r.concat(n)),r;case"IfStatement":return n=m(e.test,t),r=r.concat(n),null!==e.consequent&&(n=m(e.consequent,t),r=r.concat(n)),null!==e.alternate&&(n=m(e.alternate,t),r=r.concat(n)),r;case"EmptyStatement":return r;case"BlockStatement":for(var a=0;a<e.body.length;a++)n=m(e.body[a],t),r=r.concat(n);return r;case"ReturnStatement":return null!==e.argument?m(e.argument,t):r;case"UpdateExpression":return m(e.argument,t);case"AssignmentExpression":return r=m(e.left,t),r=r.concat(m(e.right,t));case"ExpressionStatement":return"AssignmentExpression"===e.expression.type?m(e.expression,t):(e.expression.type,m(e.expression,t));case"BreakStatement":case"ContinueStatement":case"Compound":case"Identifier":return r;case"MemberExpression":if("Identifier"!==e.object.type)return r;if(!1===e.computed)r.push(e.object.name.toLowerCase()+"."+e.property.name.toLowerCase());else try{"Literal"===e.property.type&&"string"==typeof e.property.value&&r.push(e.object.name.toLowerCase()+"."+e.property.value.toString().toLowerCase())}catch(e){}return r;case"Literal":case"ThisExpression":return r;case"CallExpression":for(var a=0;a<e.arguments.length;a++)n=m(e.arguments[a],t),r=r.concat(n);return r;case"ArrayExpression":for(var a=0;a<e.elements.length;a++)n=m(e.elements[a],t),r=r.concat(n);return r;case"UnaryExpression":return m(e.argument,t);case"ObjectExpression":for(var a=0;a<e.properties.length;a++)n=m(e.properties[a],t),r=r.concat(n);return r;case"Property":return m(e.value,t);case"BinaryExpression":case"LogicalExpression":return n=m(e.left,t),r=r.concat(n),n=m(e.right,t),r=r.concat(n);case"ConditionalExpression":case"Array":default:return r}}catch(e){throw e}}function p(e,t){return m(e.body[0].body,t)}function d(e,t,n){var r=[];if(void 0!==t.params&&null!==t.params)for(var a=0;a<t.params.length;a++)r.push("any");return{name:e,return:"any",params:r}}function y(e,t){for(var n={globalScope:t.globalScope,localScope:{}},r=0;r<e.params.length;r++){var a=e.params[r].name;n.localScope[a.toLowerCase()]={type:"any"}}return i(e.body,n)}function f(e,t,n,r){var a={};void 0!==e&&null!==e||(e={}),void 0!==n&&null!==n||(n={}),a.infinity={type:"any"},a.textformatting={type:"any"},a.pi={type:"any"};for(var s in t)"sync"===r&&void 0!==t[s].min?a[s]={type:"FormulaFunction",signature:{min:t[s].min,max:t[s].max}}:"sync"!==r&&void 0!==t[s].fmin&&(a[s]={type:"FormulaFunction",signature:{min:t[s].fmin,max:t[s].fmax}});for(var i=0;i<n.length;i++){var s=n[i];a[s.name]={type:"FormulaFunction",signature:s}}for(var s in e)a[s]=e[s],a[s].type="any";return a}function x(e,n,r,a){void 0===r&&(r="async"),void 0===a&&(a=t.functionDecls);var s=f(n.vars,a,n.customFunctions,r),o={globalScope:s,localScope:null};return i(e.body[0].body,o)}function S(e){return"BlockStatement"!==e.body[0].body.type?"Invalid formula content.":s(e.body[0].body)}function N(e,t,n){var r="";switch(t){case"SYNTAX":r="Syntax Error: ";break;case"RUNTIME":r="Runtime Error: ";break;default:r="Syntax Error: "}try{switch(e.type){case"IfStatement":switch(n){case"CANNOT_USE_ASSIGNMENT_IN_CONDITION":r+=" Assignments not be made in logical tests";break;case"CANNOT_USE_NONBOOLEAN_IN_CONDITION":r+=" Non Boolean used as Condition"}break;case"UpdateExpression":case"AssignmentExpression":switch(n){case"CANNOT_USE_ASSIGNMENT_IN_CONDITION":r+=" Assignments not be made in logical tests";break;case"ASSIGNMENTTOVARSONLY":r+=" Assignments can only be made to identifiers"}break;case"ExpressionStatement":r+=" Assignments can only be made to identifiers";break;case"FunctionDeclaration":switch(n){case"GLOBALFUNCTIONSONLY":r+=" Functions cannot be declared as variables";break;case"FUNCTIONMUSTHAVEIDENTIFIER":r+=" Function Definition must have an identifier"}break;case"VariableDeclaration":r+=" Only 1 variable can be declared at a time";break;case"VariableDeclarator":switch(n){case"FUNCTIONVARIABLEDECLARATOR":r+=" Functions cannot be declared as variables";break;case"VARIABLEMUSTHAVEIDENTIFIER":r+=" Variable Definition must have an identifier"}break;case"Identifier":r+=" Identifier Not Found. ",r+=e.name;break;case"ObjectExpression":switch(n){case"OBJECTPROPERTYMUSTBESTRING":r+=" Property name must be a string"}break;case"ForStatement":switch(n){case"CANNOT_USE_NONBOOLEAN_IN_CONDITION":r+=" Non Boolean used as Condition"}break;case"ForInStatement":switch(n){case"ONLY1VAR":r+=" Can only declare 1 var for use with IN";break;case"CANNOTDECLAREVAL":r+=" Can only declare value for use with IN";break;case"LEFTNOVAR":r+="Must provide a variable to iterate with.";break;case"VARIABLENOTDECLARED":r+="Variable must be declared before it is used..";break;case"CANNOTITERATETHISTYPE":r+="This type cannot be used in an IN loop"}break;case"MemberExpression":switch(n){case"PROPERTYNOTFOUND":r+="Cannot find member property. ",r+=!1===e.computed?e.property.name:"";break;case"OUTOFBOUNDS":r+="Out of Bounds. ",r+=!1===e.computed?e.property.name:"";break;case"NOTFOUND":r+="Cannot call member method on null. ",r+=!1===e.computed?e.property.name:"";break;case"INVALIDTYPE":r+="Cannot call member property on object of this type. ",r+=!1===e.computed?e.property.name:""}break;case"Property":switch(n){case"ONLYLITERAL":r+="Property names must be literals or identifiers"}break;case"Literal":break;case"ThisExpression":r+="THIS construct is not supported.";case"CallExpression":switch(n){case"WRONGSIGNATURE":r+="Function signature does not match: ",r+=e.callee.name;break;case"ONLYNODESUPPORTED":r+="Functions must be declared.",r+=e.callee.name;break;case"NOTAFUNCTION":r+="Not a Function: ",r+=e.callee.name;break;case"NOTFOUND":r+="Function Not Found: "+e.callee.name}break;case"UnaryExpression":switch(n){case"NOTSUPPORTEDUNARYOPERATOR":r+="Operator "+e.operator+" not allowed in this context. Only ! can be used with boolean, and - with a number";break;case"NOTSUPPORTEDTYPE":r+="Unary operator "+e.operator+" cannot be used with this argument."}case"BinaryExpression":switch(n){case"OPERATORNOTRECOGNISED":r+="Binary Operator not recognised "+e.operator}break;case"LogicalExpression":switch(n){case"ONLYBOOLEAN":r+="Operator "+e.operator+" cannot be used. Only || or && are allowed values";break;case"ONLYORORAND":r+="Logical Expression "+e.operator+" being applied to parameters that are not boolean."}break;case"ConditionalExpression":r+="Conditional statements not supported.";break;case"ArrayExpression":switch(n){case"FUNCTIONCONTEXTILLEGAL":r+=" Cannot Put Function inside Array."}break;case"Array":r+="Expression contains unrecognised array structure.";break;default:r+="Expression contains unrecognised code structures."}}catch(e){throw e}return r}function E(e,t,n){return{line:e.loc.start.line,character:e.loc.start.column,reason:N(e,t,n)}}function g(e,t,n,r,a){void 0===a&&(a=!0);for(var s={globalScope:t.globalScope,localScope:{}},i=0;i<e.params.length;i++){var o=e.params[i].name;s.localScope[o.toLowerCase()]={type:"any"}}T(e.body,s,n,r,!1)}function T(e,t,n,r,s){if(void 0===s&&(s=!0),null===e)throw new Error("Unnexpexted Expression Syntax");var i=null;try{switch(e.type){case"VariableDeclarator":return null!==e.init&&"FunctionExpression"===e.init.type?void r.push(E(e,"SYNTAX","FUNCTIONVARIABLEDECLARATOR")):("Identifier"!==e.id.type?r.push(E(e,"SYNTAX","VARIABLEMUSTHAVEIDENTIFIER")):(null!==t.localScope?t.localScope[e.id.name.toLowerCase()]:t.globalScope[e.id.name.toLowerCase()],null===t.localScope?t.globalScope[e.id.name.toLowerCase()]={type:"any"}:t.localScope[e.id.name.toLowerCase()]={type:"any"}),void(null!==e.init&&T(e.init,t,n,r,s)));case"FunctionDeclaration":return!1===s&&r.push(E(e,"SYNTAX","GLOBALFUNCTIONSONLY")),"Identifier"!==e.id.type&&r.push(E(e,"SYNTAX","FUNCTIONMUSTHAVEIDENTIFIER")),i=d("",e,t),g(e,t,n,r,s),null!==t.localScope&&r.push(E(e,"SYNTAX","GLOBALFUNCTIONSONLY")),i.isnative=!1,void("Identifier"===e.id.type&&(t.globalScope[e.id.name.toLowerCase()]={type:"FormulaFunction",signature:[i]}));case"VariableDeclaration":for(var o=0;o<e.declarations.length;o++)T(e.declarations[o],t,n,r,s);return;case"IfStatement":return null!==e.test&&(T(e.test,t,n,r,s),"AssignmentExpression"!==e.test.type&&"UpdateExpression"!==e.test.type||r.push(E(e.test,"SYNTAX","CANNOT_USE_ASSIGNMENT_IN_CONDITION"))),null!==e.consequent&&T(e.consequent,t,n,r,s),void(null!==e.alternate&&T(e.alternate,t,n,r,s));case"EmptyStatement":return;case"BlockStatement":if(null!==e.body)for(var o=0;o<e.body.length;o++)T(e.body[o],t,n,r,s);return;case"ReturnStatement":return void(null!==e.argument&&T(e.argument,t,n,r,s));case"ForInStatement":return"VariableDeclaration"===e.left.type?(e.left.declarations.length>1&&r.push(E(e,"SYNTAX","ONLY1VAR")),null!==e.left.declarations[0].init&&r.push(E(e,"SYNTAX","CANNOTDECLAREVAL"))):"Identifier"!==e.left.type&&r.push(E(e,"SYNTAX","LEFTNOTVAR")),T(e.left,t,n,r,s),T(e.right,t,n,r,s),void T(e.body,t,n,r,s);case"ForStatement":return null!==e.init&&T(e.init,t,n,r,s),null!==e.test&&T(e.test,t,n,r,s),null!==e.body&&T(e.body,t,n,r,s),void(null!==e.update&&T(e.update,t,n,r,s));case"BreakStatement":case"ContinueStatement":return;case"UpdateExpression":if("Identifier"!==e.argument.type&&"MemberExpression"!==e.argument.type)r.push(E(e,"SYNTAX","ASSIGNMENTTOVARSONLY"));else{if("Identifier"===e.argument.type){var c=!1;!1===n&&(null!==t.localScope&&void 0!==t.localScope[e.argument.name.toLowerCase()]&&(c=!0),void 0!==t.globalScope[e.argument.name.toLowerCase()]&&(c=!0),!1===c&&r.push({line:null===e?0:e.loc.start.line,character:null===e?0:e.loc.start.column,reason:"Identifier "+e.argument.name+" has not been declared."}))}"MemberExpression"===e.argument.type&&T(e.argument,t,n,r,s)}return;case"AssignmentExpression":switch("Identifier"!==e.left.type&&"MemberExpression"!==e.left.type&&r.push(E(e,"SYNTAX","ASSIGNMENTTOVARSONLY")),e.operator){case"=":case"/=":case"*=":case"%=":case"+=":case"-=":break;default:r.push(E(e,"SYNTAX","OPERATORNOTRECOGNISED"))}T(e.right,t,n,r,s);var l=!1;return"Identifier"===e.left.type&&(null!==t.localScope&&void 0!==t.localScope[e.left.name.toLowerCase()]&&(l=!0),void 0!==t.globalScope[e.left.name.toLowerCase()]&&(l=!0),!1===n&&!1===l&&r.push({line:null===e?0:e.loc.start.line,character:null===e?0:e.loc.start.column,reason:"Identifier "+e.argument.name+" has not been declared."})),void("MemberExpression"===e.left.type&&T(e.left,t,n,r,s));case"ExpressionStatement":return void("AssignmentExpression"===e.expression.type?T(e.expression,t,n,r,s):(e.expression.type,T(e.expression,t,n,r,s)));case"Identifier":var u=e.name.toLowerCase();if(null!==t.localScope&&void 0!==t.localScope[u])return;if(void 0!==t.globalScope[u])return;!1===n&&r.push(E(e,"SYNTAX","VARIABLENOTFOUND"));break;case"MemberExpression":return T(e.object,t,n,r,s),void(!0===e.computed&&T(e.property,t,n,r,s));case"Literal":return"";case"ThisExpression":r.push(E(e,"SYNTAX","NOTSUPPORTED"));break;case"CallExpression":"Identifier"!==e.callee.type&&r.push(E(e,"SYNTAX","ONLYNODESSUPPORTED"));for(var o=0;o<e.arguments.length;o++)T(e.arguments[o],t,n,r,s);var m=a(e.callee.name,e.arguments,t);return!1===n&&-1===m&&r.push(E(e,"SYNTAX","NOTFOUND")),void(-2===m&&r.push(E(e,"SYNTAX","WRONGSIGNATURE")));case"UnaryExpression":return void T(e.argument,t,n,r,s);case"BinaryExpression":switch(T(e.left,t,n,r,s),T(e.right,t,n,r,s),e.operator){case"==":case"!=":case"<":case"<=":case">":case">=":case"+":case"-":case"*":case"/":case"%":break;default:r.push(E(e,"SYNTAX","OPERATORNOTRECOGNISED"))}return;case"LogicalExpression":switch(e.operator){case"&&":case"||":break;default:r.push(E(e,"SYNTAX","OPERATORNOTRECOGNISED"))}return T(e.left,t,n,r,s),"AssignmentExpression"!==e.left.type&&"UpdateExpression"!==e.left.type||r.push(E(e,"SYNTAX","CANNOT_USE_ASSIGNMENT_IN_CONDITION")),T(e.right,t,n,r,s),void("AssignmentExpression"!==e.right.type&&"UpdateExpression"!==e.right.type||r.push(E(e,"SYNTAX","CANNOT_USE_ASSIGNMENT_IN_CONDITION")));case"ConditionalExpression":r.push(E(e,"SYNTAX","NOTSUPPORTED"));break;case"ArrayExpression":for(var o=0;o<e.elements.length;o++)T(e.elements[o],t,n,r,s);return;case"Array":r.push(E(e,"SYNTAX","NOTSUPPORTED"));case"ObjectExpression":for(var o=0;o<e.properties.length;o++)T(e.properties[o],t,n,r,s);return;case"Property":return"Literal"!==e.key.type&&"Identifier"!==e.key.type&&r.push(E(e,"SYNTAX","ONLYLITERAL")),"Literal"===e.key.type&&T(e.key,t,n,r,s),void T(e.value,t,n,r,s);default:r.push(E(e,"SYNTAX","UNRECOGNISED"))}return}catch(t){r.push({line:null===e?0:e.loc.start.line,character:null===e?0:e.loc.start.column,reason:"Unnexpected Syntax"})}}function b(e,n,r,a,s){void 0===a&&(a="async"),void 0===s&&(s=t.functionDecls);var i=[];if("BlockStatement"!==e.body[0].body.type)return[{line:0,character:0,reason:"Invalid Body"}];null!==n&&void 0!==n||(n={vars:{},customFunctions:[]});var o=f(n.vars,s,n.customFunctions,a),c={globalScope:o,localScope:null};try{T(e.body[0].body,c,r,i)}catch(e){}return i}function A(e,t){var n,r=[];try{switch(e.type){case"VariableDeclarator":return null!==e.init?(e.init.type,A(e.init,t)):r;case"FunctionDeclaration":return A(e.body,t);case"VariableDeclaration":for(var a=0;a<e.declarations.length;a++)n=A(e.declarations[a],t),r=r.concat(n);return r;case"ForInStatement":return n=A(e.left,t),r=r.concat(n),n=A(e.right,t),r=r.concat(n),n=A(e.body,t),r=r.concat(n);case"ForStatement":return null!==e.init&&(n=A(e.init,t),r=r.concat(n)),null!==e.test&&(n=A(e.test,t),r=r.concat(n)),null!==e.body&&(n=A(e.body,t),r=r.concat(n)),null!==e.update&&(n=A(e.update,t),r=r.concat(n)),r;case"IfStatement":return n=A(e.test,t),r=r.concat(n),null!==e.consequent&&(n=A(e.consequent,t),r=r.concat(n)),null!==e.alternate&&(n=A(e.alternate,t),r=r.concat(n)),r;case"EmptyStatement":return r;case"BlockStatement":for(var a=0;a<e.body.length;a++)n=A(e.body[a],t),r=r.concat(n);return r;case"ReturnStatement":return null!==e.argument?A(e.argument,t):r;case"UpdateExpression":return A(e.argument,t);case"AssignmentExpression":return r=A(e.left,t),r=r.concat(A(e.right,t));case"ExpressionStatement":return"AssignmentExpression"===e.expression.type?A(e.expression,t):(e.expression.type,A(e.expression,t));case"BreakStatement":case"ContinueStatement":case"Compound":case"Identifier":case"MemberExpression":case"Literal":case"ThisExpression":return r;case"CallExpression":for(var a=0;a<e.arguments.length;a++)n=A(e.arguments[a],t),r=r.concat(n);return r.push(e.callee.name.toLowerCase()),r;case"ArrayExpression":for(var a=0;a<e.elements.length;a++)n=A(e.elements[a],t),r=r.concat(n);return r;case"UnaryExpression":return A(e.argument,t);case"ObjectExpression":for(var a=0;a<e.properties.length;a++)n=A(e.properties[a],t),r=r.concat(n);return r;case"Property":return A(e.value,t);case"BinaryExpression":case"LogicalExpression":return n=A(e.left,t),r=r.concat(n),n=A(e.right,t),r=r.concat(n);case"ConditionalExpression":case"Array":default:return r}}catch(e){throw e}}function O(e,t){return A(e.body[0].body,t)}function h(e,t){void 0===t&&(t=[]);var n=null;if(void 0===e.usesFeatureSet){null===n&&(n=O(e,!1)),e.usesFeatureSet=!1;for(var r=0;r<n.length;r++)L.indexOf(n[r])>-1&&(e.usesFeatureSet=!0,e.isAsync=!0);if(!1===e.usesFeatureSet&&t&&t.length>0)for(var a=0,s=t;a<s.length;a++){var i=s[a];if(c(e,i)){e.usesFeatureSet=!0,e.isAsync=!0;break}}}if(void 0===e.isAsync&&(e.isAsync=!1),void 0===e.usesGeometry){e.usesGeometry=!1,null===n&&(n=O(e,!1));for(var r=0;r<n.length;r++)C.indexOf(n[r])>-1&&(e.usesGeometry=!0)}}function I(e){for(var t=O(e,!1),n=0;n<t.length;n++)if(L.indexOf(t[n])>-1)return!0;return!1}Object.defineProperty(t,"__esModule",{value:!0}),t.functionDecls={concatenate:{min:"0",max:"*"},split:{min:"2",max:"4"},guid:{min:"0",max:"1"},today:{min:"0",max:"0"},now:{min:"0",max:"0"},timestamp:{min:"0",max:"0"},day:{min:"1",max:"1"},month:{min:"1",max:"1"},year:{min:"1",max:"1"},hour:{min:"1",max:"1"},second:{min:"1",max:"1"},millisecond:{min:"1",max:"1"},minute:{min:"1",max:"1"},weekday:{min:"1",max:"1"},toutc:{min:"1",max:"1"},tolocal:{min:"1",max:"1"},date:{min:"0",max:"7"},datediff:{min:"2",max:"3"},dateadd:{min:"2",max:"3"},trim:{min:"1",max:"1"},text:{min:"1",max:"2"},left:{min:"2",max:"2"},right:{min:"2",max:"2"},mid:{min:"2",max:"3"},upper:{min:"1",max:"1"},proper:{min:"1",max:"2"},lower:{min:"1",max:"1"},find:{min:"2",max:"3"},iif:{min:"3",max:"3"},decode:{min:"2",max:"*"},when:{min:"2",max:"*"},defaultvalue:{min:"2",max:"2"},isempty:{min:"1",max:"1"},domaincode:{min:"2",max:"4"},domainname:{min:"2",max:"4"},polygon:{min:"1",max:"1"},point:{min:"1",max:"1"},polyline:{min:"1",max:"1"},extent:{min:"1",max:"1"},multipoint:{min:"1",max:"1"},geometry:{min:"1",max:"1"},count:{min:"0",max:"*"},number:{min:"1",max:"2"},acos:{min:"1",max:"1"},asin:{min:"1",max:"1"},atan:{min:"1",max:"1"},atan2:{min:"2",max:"2"},ceil:{min:"1",max:"2"},floor:{min:"1",max:"2"},round:{min:"1",max:"2"},cos:{min:"1",max:"1"},exp:{min:"1",max:"1"},log:{min:"1",max:"1"},min:{min:"0",max:"*"},constrain:{min:"3",max:"3"},console:{min:"0",max:"*"},max:{min:"0",max:"*"},pow:{min:"2",max:"2"},random:{min:"0",max:"0"},sqrt:{min:"1",max:"1"},sin:{min:"1",max:"1"},tan:{min:"1",max:"1"},abs:{min:"1",max:"1"},isnan:{min:"1",max:"1"},stdev:{min:"0",max:"*"},average:{min:"0",max:"*"},mean:{min:"0",max:"*"},sum:{min:"0",max:"*"},variance:{min:"0",max:"*"},distinct:{min:"0",max:"*"},first:{min:"1",max:"1"},top:{min:"2",max:"2"},boolean:{min:"1",max:"1"},dictionary:{min:"0",max:"*"},typeof:{min:"1",max:"1"},reverse:{min:"1",max:"1"},replace:{min:"3",max:"4"},sort:{min:"1",max:"2"},feature:{min:"1",max:"*"},haskey:{min:"2",max:"2"},indexof:{min:"2",max:"2"},disjoint:{min:"2",max:"2"},intersects:{min:"2",max:"2"},touches:{min:"2",max:"2"},crosses:{min:"2",max:"2"},within:{min:"2",
max:"2"},contains:{min:"2",max:"2"},overlaps:{min:"2",max:"2"},equals:{min:"2",max:"2"},relate:{min:"3",max:"3"},intersection:{min:"2",max:"2"},union:{min:"1",max:"2"},difference:{min:"2",max:"2"},symmetricdifference:{min:"2",max:"2"},clip:{min:"2",max:"2"},cut:{min:"2",max:"2"},area:{min:"1",max:"2"},areageodetic:{min:"1",max:"2"},length:{min:"1",max:"2"},lengthgeodetic:{min:"1",max:"2"},distance:{min:"2",max:"3"},densify:{min:"2",max:"3"},densifygeodetic:{min:"2",max:"3"},generalize:{min:"2",max:"4"},buffer:{min:"2",max:"3"},buffergeodetic:{min:"2",max:"3"},offset:{min:"2",max:"6"},rotate:{min:"2",max:"3"},issimple:{min:"1",max:"1"},simplify:{min:"1",max:"1"},centroid:{min:"1",max:"1"},multiparttosinglepart:{min:"1",max:"1"},setgeometry:{min:"2",max:"2"}};for(var v in t.functionDecls)t.functionDecls[v].fmin=t.functionDecls[v].min,t.functionDecls[v].fmax=t.functionDecls[v].max;var L=["featureset","featuresetbyid","featuresetbyname","featuresetbyurl","featuresetbyportalitem"],C=["disjoint","intersects","touches","crosses","within","contains","overlaps","equals","relate","intersection","union","difference","symmetricdifference","clip","cut","area","areageodetic","length","lengthgeodetic","distance","densify","densifygeodetic","generalize","buffer","buffergeodetic","offset","rotate","issimple","simplify","multiparttosinglepart"];t.addFunctionDeclaration=n,t.checkFunctionSignature=r,t.findFunction=a,t.validateLanguageNode=s,t.testValidityOfExpression=i,t.referencesMemberImpl=o,t.referencesMember=c,t.referencesFunctionImpl=l,t.referencesFunction=u,t.findFieldLiteralsImpl=m,t.findFieldLiterals=p,t.extractFunctionDeclaration=d,t.validateFunction=y,t.constructGlobalScope=f,t.validateScript=x,t.validateLanguage=S,t.nodeErrorMessage=N,t.makeError=E,t.extractAllIssuesInFunction=g,t.extractAllIssues=T,t.checkScript=b,t.findFunctionCallsImpl=A,t.findFunctionCalls=O,t.findScriptDependencies=h,t.scriptUsesFeatureSet=I});