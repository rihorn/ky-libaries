// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.10/esri/copyright.txt for details.

define(["require","exports","./core/tsSupport/assignHelper","./core/tsSupport/declareExtendsHelper","./core/tsSupport/decorateHelper","./core/Collection","./core/JSONSupport","./core/lang","./core/Logger","./core/promiseUtils","./core/accessorSupport/decorators","./core/accessorSupport/ensureType","./support/arcadeUtils","./support/ContentElement","./support/ExpressionInfo","./support/FieldInfo","./support/LayerOptions","./support/RelatedRecordsInfo","./support/ContentElement/Attachments","./support/ContentElement/ContentElement","./support/ContentElement/Fields","./support/ContentElement/Media","./support/ContentElement/Text","./support/ContentElement/Media/types","./support/actions/ActionBase","./support/actions/ActionButton","./support/actions/ActionToggle"],function(t,e,o,n,r,i,s,p,l,a,c,u,d,f,y,m,h,g,x,F,I,v,A,w,O,E,_){var N=i.ofType({key:"type",defaultKeyValue:"button",base:O,typeMap:{button:E,toggle:_}}),C={base:F,key:"type",typeMap:{media:v,text:A,attachments:x,fields:I}},S=l.getLogger("esri.PopupTemplate");return function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.actions=null,e.content="",e.expressionInfos=null,e.fieldInfos=null,e.layerOptions=null,e.lastEditInfoEnabled=!0,e.outFields=null,e.overwriteActions=!1,e.title="",e.relatedRecordsInfo=null,e}n(e,t),o=e,e.prototype.castContent=function(t){return Array.isArray(t)?t.map(function(t){return u.ensureOneOfType(C,t)}):"string"==typeof t||"function"==typeof t||t instanceof HTMLElement||a.isThenable(t)?t:(S.error("content error","unsupported content value",{value:t}),null)},e.prototype.readContent=function(t,e){var o=e.description,n=e.mediaInfos,r=e.popupElements,i=e.showAttachments;if(Array.isArray(r)&&r.length>0)return r.map(function(t){return"media"===t.type?(!t.mediaInfos&&n&&(t.mediaInfos=n),v.fromJSON(t)):"text"===t.type?(!t.text&&o&&(t.text=o),A.fromJSON(t)):"attachments"===t.type?x.fromJSON(t):"fields"===t.type?I.fromJSON(t):void 0}).filter(Boolean);var s=[];return o?s.push(new A({text:o})):s.push(new I),Array.isArray(n)&&n.length&&s.push(v.fromJSON({mediaInfos:n})),i&&s.push(x.fromJSON({displayType:"list"})),s.length?s:o},e.prototype.writeContent=function(t,e){if(e.showAttachments=!1,"string"==typeof t)return void(e.description=t);Array.isArray(t)&&(e.popupElements=t.map(function(t){return t&&t.toJSON()}),e.popupElements.forEach(function(t){"attachments"!==t.type||e.showAttachments?"media"!==t.type||e.mediaInfos?"text"!==t.type||e.description||(t.text&&(e.description=t.text),delete t.text):(t.mediaInfos&&(e.mediaInfos=p.clone(t.mediaInfos)),delete t.mediaInfos):e.showAttachments=!0}))},e.prototype.writeLayerOptions=function(t,e){e.layerOptions=t&&null!==t.showNoDataRecords?t.toJSON():null},e.prototype.writeTitle=function(t,e){e.title=t||""},Object.defineProperty(e.prototype,"requiredFields",{get:function(){return this.collectRequiredFields()},enumerable:!0,configurable:!0}),e.prototype.clone=function(){var t=this.actions,e=t?p.clone(t.toArray()):[];return new o({actions:e,content:Array.isArray(this.content)?p.clone(this.content):this.content,fieldInfos:Array.isArray(this.fieldInfos)?p.clone(this.fieldInfos):null,layerOptions:this.layerOptions?p.clone(this.layerOptions):null,overwriteActions:this.overwriteActions,relatedRecordsInfo:this.relatedRecordsInfo?p.clone(this.relatedRecordsInfo):null,title:this.title})},e.prototype.collectRequiredFields=function(){var t=(this.outFields||[]).concat(this._getActionsFields(this.actions),this._getTitleFields(this.title),this._getContentFields(this.content),this._getExpressionInfoFields(this.expressionInfos));return-1!==t.indexOf("*")?["*"]:t.filter(function(t,e,o){return t&&e===o.indexOf(t)})},e.prototype._getContentElementFields=function(t){var e=this;if(!t||"attachments"===t.type)return[];if("fields"===t.type)return this._getFieldInfoFields(t.fieldInfos||this.fieldInfos);if("media"===t.type){return(t.mediaInfos||[]).reduce(function(t,o){return t.concat(e._getMediaInfoFields(o))},[])}return"text"===t.type?this._extractFieldNames(t.text):void 0},e.prototype._getMediaInfoFields=function(t){var e=t.caption,o=t.title,n=t.value,r=n||{},i=r.fields,s=void 0===i?[]:i,p=r.normalizeField,l=r.tooltipField,a=r.sourceURL,c=r.linkURL,u=this._extractFieldNames(o).concat(this._extractFieldNames(e),this._extractFieldNames(a),this._extractFieldNames(c),s);return p&&u.push(p),l&&u.push(l),u},e.prototype._getContentFields=function(t){var e=this;return"string"==typeof t?this._extractFieldNames(t):Array.isArray(t)?t.reduce(function(t,o){return t.concat(e._getContentElementFields(o))},[]):[]},e.prototype._getExpressionInfoFields=function(t){return t?t.reduce(function(t,e){return t.concat(d.extractFieldNames(e.expression))},[]):[]},e.prototype._getFieldInfoFields=function(t){return t?t.filter(function(t){return void 0===t.visible||!!t.visible}).map(function(t){return t.fieldName}).filter(function(t){return-1===t.indexOf("relationships/")&&-1===t.indexOf("expression/")}):[]},e.prototype._getActionsFields=function(t){var e=this;return t?t.toArray().reduce(function(t,o){return t.concat(e._getActionFields(o))},[]):[]},e.prototype._getActionFields=function(t){var e=t.className,o=t.title,n=t.type,r="button"===n||"toggle"===n?t.image:"";return this._extractFieldNames(o).concat(this._extractFieldNames(e),this._extractFieldNames(r))},e.prototype._getTitleFields=function(t){return"string"==typeof t?this._extractFieldNames(t):[]},e.prototype._extractFieldNames=function(t){if(!t||"string"!=typeof t)return[];var e=/{[^}]*}/g,o=t.match(e);if(!o)return[];var n=/\{(\w+):.+\}/,r=o.filter(function(t){return!(0===t.indexOf("{relationships/")||0===t.indexOf("{expression/"))}).map(function(t){return t.replace(n,"{$1}")});return r?r.map(function(t){return t.slice(1,-1)}):[]};var o;return r([c.property({type:N})],e.prototype,"actions",void 0),r([c.property()],e.prototype,"content",void 0),r([c.cast("content")],e.prototype,"castContent",null),r([c.reader("content",["description","popupElements","mediaInfos","showAttachments"])],e.prototype,"readContent",null),r([c.writer("content",{popupElements:{type:i.ofType(f.types)},showAttachments:{type:Boolean},mediaInfos:{type:i.ofType(w.default)},description:{type:String}})],e.prototype,"writeContent",null),r([c.property({type:[y],json:{write:!0}})],e.prototype,"expressionInfos",void 0),r([c.property({type:[m],json:{write:!0}})],e.prototype,"fieldInfos",void 0),r([c.property({type:h})],e.prototype,"layerOptions",void 0),r([c.writer("layerOptions")],e.prototype,"writeLayerOptions",null),r([c.property({type:Boolean,json:{read:{source:"showLastEditInfo"},write:{target:"showLastEditInfo"},default:!0}})],e.prototype,"lastEditInfoEnabled",void 0),r([c.property()],e.prototype,"outFields",void 0),r([c.property()],e.prototype,"overwriteActions",void 0),r([c.property({json:{type:String}})],e.prototype,"title",void 0),r([c.writer("title")],e.prototype,"writeTitle",null),r([c.property({type:g,json:{write:!0}})],e.prototype,"relatedRecordsInfo",void 0),r([c.property({dependsOn:["actions","title","content","fieldInfos","expressionInfos","outFields"],readOnly:!0})],e.prototype,"requiredFields",null),e=o=r([c.subclass("esri.PopupTemplate")],e)}(c.declared(s))});