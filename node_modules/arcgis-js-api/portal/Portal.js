// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.10/esri/copyright.txt for details.

define(["require","exports","../core/tsSupport/assignHelper","../core/tsSupport/declareExtendsHelper","../core/tsSupport/decorateHelper","../core/tsSupport/paramHelper","dojo/_base/kernel","dojo/_base/url","../config","../kernel","../request","../core/Error","../core/JSONSupport","../core/lang","../core/Loadable","../core/promiseUtils","../core/urlUtils","../core/accessorSupport/decorators","../geometry/Extent","./PortalQueryParams","./PortalQueryResult","./PortalUser"],function(t,e,r,o,n,p,u,a,i,l,s,y,d,c,h,f,m,v,P,S,g,_){var b,O={Bookmark:function(){return f.create(function(e){return t(["./Bookmark"],e)})},Portal:function(){return f.create(function(e){return t(["./Portal"],e)})},PortalFolder:function(){return f.create(function(e){return t(["./PortalFolder"],e)})},PortalGroup:function(){return f.create(function(e){return t(["./PortalGroup"],e)})},PortalItem:function(){return f.create(function(e){return t(["./PortalItem"],e)})},PortalQueryParams:function(){return f.create(function(e){return t(["./PortalQueryParams"],e)})},PortalQueryResult:function(){return f.create(function(e){return t(["./PortalQueryResult"],e)})},PortalRating:function(){return f.create(function(e){return t(["./PortalRating"],e)})},PortalUser:function(){return f.create(function(e){return t(["./PortalUser"],e)})}};return function(e){function d(t){var r=e.call(this)||this;return r.access=null,r.allSSL=!1,r.authMode="auto",r.authorizedCrossOriginDomains=null,r.basemapGalleryGroupQuery=null,r.bingKey=null,r.canListApps=!1,r.canListData=!1,r.canListPreProvisionedItems=!1,r.canProvisionDirectPurchase=!1,r.canSearchPublic=!0,r.canShareBingPublic=!1,r.canSharePublic=!1,r.canSignInArcGIS=!1,r.canSignInIDP=!1,r.colorSetsGroupQuery=null,r.commentsEnabled=!1,r.created=null,r.culture=null,r.customBaseUrl=null,r.defaultBasemap=null,r.defaultExtent=null,r.defaultVectorBasemap=null,r.description=null,r.eueiEnabled=!1,r.featuredGroups=null,r.featuredItemsGroupQuery=null,r.galleryTemplatesGroupQuery=null,r.livingAtlasGroupQuery=null,r.hasCategorySchema=!1,r.helperServices=null,r.homePageFeaturedContent=null,r.homePageFeaturedContentCount=null,r.httpPort=null,r.httpsPort=null,r.id=null,r.ipCntryCode=null,r.isPortal=!1,r.layerTemplatesGroupQuery=null,r.maxTokenExpirationMinutes=null,r.modified=null,r.name=null,r.portalHostname=null,r.portalMode=null,r.portalProperties=null,r.region=null,r.rotatorPanels=null,r.showHomePageDescription=!1,r.supportsHostedServices=!1,r.symbolSetsGroupQuery=null,r.templatesGroupQuery=null,r.units=null,r.url=i.portalUrl,r.urlKey=null,r.user=null,r.useStandardizedQuery=!1,r.useVectorBasemaps=!1,r.vectorBasemapGalleryGroupQuery=null,r}o(d,e),h=d,d.prototype.normalizeCtorArgs=function(t){return"string"==typeof t?{url:t}:t},d.prototype.destroy=function(){this._esriId_credentialCreateHandle&&(this._esriId_credentialCreateHandle.remove(),this._esriId_credentialCreateHandle=null)},d.prototype.readAuthorizedCrossOriginDomains=function(t){if(t)for(var e=0,r=t;e<r.length;e++){var o=r[e];-1===i.request.trustedServers.indexOf(o)&&i.request.trustedServers.push(o)}return t},d.prototype.readDefaultBasemap=function(t){if(t){var e=b.fromJSON(t);return e.portalItem={portal:this},e}return null},d.prototype.readDefaultVectorBasemap=function(t){if(t){var e=b.fromJSON(t);return e.portalItem={portal:this},e}return null},Object.defineProperty(d.prototype,"extraQuery",{get:function(){var t=this.user&&this.user.orgId,e=!t||this.canSearchPublic;return this.id&&!e?" AND orgid:"+this.id:null},enumerable:!0,configurable:!0}),Object.defineProperty(d.prototype,"isOrganization",{get:function(){return!!this.access},enumerable:!0,configurable:!0}),Object.defineProperty(d.prototype,"restUrl",{get:function(){var t=this.url;if(t){var e=t.indexOf("/sharing");t=e>0?t.substring(0,e):this.url.replace(/\/+$/,""),t+="/sharing/rest"}return t},enumerable:!0,configurable:!0}),Object.defineProperty(d.prototype,"thumbnailUrl",{get:function(){var t=this.restUrl,e=this.thumbnail;return t&&e?this._normalizeSSL(t+"/portals/self/resources/"+e):null},enumerable:!0,configurable:!0}),d.prototype.readUrlKey=function(t){return t?t.toLowerCase():t},d.prototype.readUser=function(t){var e=null;return t&&(e=_.fromJSON(t),e.portal=this),e},d.prototype.load=function(){var e=this,r=f.create(function(e){return t(["../Basemap"],e)}).then(function(t){b=t}).then(function(){return e._fetchSelf()}).then(function(t){if(l.id){var r=l.id;e.credential=r.findCredential(e.restUrl),e.credential||e.authMode!==h.AUTH_MODE_AUTO||(e._esriId_credentialCreateHandle=r.on("credential-create",function(){r.findCredential(e.restUrl)&&e._signIn()}))}e.read(t)});return this.addResolvingPromise(r),this.when()},d.prototype.fetchBasemaps=function(t){var e=new S;return e.query=t||(this.useVectorBasemaps?this.vectorBasemapGalleryGroupQuery:this.basemapGalleryGroupQuery),e.disableExtraQuery=!0,this.queryGroups(e).then(function(t){if(e.num=100,e.query='type:"Web Map" -type:"Web Application"',t.total){var r=t.results[0];return e.sortField=r.sortField||"name",e.sortOrder=r.sortOrder||"desc",r.queryItems(e)}return null}).then(function(t){return t&&t.total?t.results.filter(function(t){return"Web Map"===t.type}).map(function(t){return new b({portalItem:t})}):[]})},d.prototype.fetchCategorySchema=function(){return this.hasCategorySchema?this._request(this.restUrl+"/portals/self/categorySchema").then(function(t){return t.categorySchema}):f.resolve([])},d.prototype.fetchFeaturedGroups=function(){var t=this.featuredGroups,e=new S;if(e.num=100,e.sortField="title",t&&t.length){for(var r=[],o=0,n=t;o<n.length;o++){var p=n[o];r.push('(title:"'+p.title+'" AND owner:'+p.owner+")")}return e.query=r.join(" OR "),this.queryGroups(e).then(function(t){return t.results})}return f.resolve([])},d.prototype.fetchRegions=function(){var t=this.user&&this.user.culture||this.culture||u.locale;return this._request(this.restUrl+"/portals/regions",{query:{culture:t}})},d.getDefault=function(){return h._default||(h._default=new h),h._default},d.prototype.queryGroups=function(t){return this._queryPortal("/community/groups",t,"PortalGroup")},d.prototype.queryItems=function(t){return this._queryPortal("/search",t,"PortalItem")},d.prototype.queryUsers=function(t){return t.sortField||(t.sortField="username"),this._queryPortal("/community/users",t,"PortalUser")},d.prototype.toJSON=function(){throw new y("internal:not-yet-implemented","Portal.toJSON is not yet implemented")},d.prototype._fetchSelf=function(t,e){void 0===t&&(t=this.authMode),void 0===e&&(e=!1);var r=this.restUrl+"/portals/self",o={authMode:t,query:{culture:u.locale}};return"auto"===o.authMode&&(o.authMode="no-prompt"),e&&(o.query.default=!0),this._request(r,o)},d.prototype._queryPortal=function(t,e,r){var o=this,n=function(r){return o._request(o.restUrl+t,e.toRequestOptions(o)).then(function(t){var n=e.clone();return n.start=t.nextStart,new g({nextQueryParams:n,queryParams:e,total:t.total,results:h._resultsToTypedArray(r,{portal:o},t)})}).then(function(t){return f.all(t.results.map(function(e){return"function"==typeof e.when?e.when():t})).then(function(){return t},function(){return t})})};return r&&O[r]?O[r]().then(function(t){return n(t)}):n()},d.prototype._signIn=function(){var t=this;if(this.authMode===h.AUTH_MODE_ANONYMOUS)return f.reject(new y("portal:invalid-auth-mode",'Current "authMode"\' is "'+this.authMode+'"'));if("failed"===this.loadStatus)return f.reject(this.loadError);var e=function(e){return f.resolve().then(function(){return"not-loaded"===t.loadStatus?(e||(t.authMode="immediate"),t.load().then(function(){return null})):"loading"===t.loadStatus?t.load().then(function(){return t.credential?null:(t.credential=e,t._fetchSelf("immediate"))}):t.user&&t.credential===e?null:(t.credential=e,t._fetchSelf("immediate"))}).then(function(e){e&&t.read(e)})};return l.id?l.id.getCredential(this.restUrl).then(function(t){return e(t)}):e(this.credential)},d.prototype._normalizeSSL=function(t){var e=this.allSSL||m.isAppHTTPS();if(this.isPortal){var r=new a(t);return this.portalHostname.toLowerCase().indexOf(r.host.toLowerCase())>-1&&r.port&&"80"!==r.port&&"443"!==r.port?e?"https://"+r.host+(this.httpsPort&&443!==this.httpsPort?":"+this.httpsPort:"")+r.path+"?"+r.query:"http://"+r.host+(this.httpPort&&80!==this.httpPort?":"+this.httpPort:"")+r.path+"?"+r.query:e?t.replace("http:","https:"):t}return e?t.replace("http:","https:"):t},d.prototype._normalizeUrl=function(t){var e=this.credential&&this.credential.token;return this._normalizeSSL(e?t+(t.indexOf("?")>-1?"&":"?")+"token="+e:t)},d.prototype._requestToTypedArray=function(e,r,o){var n=this,p=function(t){return n._request(e,r).then(function(e){var r=h._resultsToTypedArray(t,{portal:n},e);return f.all(r.map(function(t){return"function"==typeof t.when?t.when():e})).then(function(){return r},function(){return r})})};return o?f.create(function(e){return t(["./"+o],e)}).then(function(t){return p(t)}):p()},d.prototype._request=function(t,e){var o=this.authMode===h.AUTH_MODE_ANONYMOUS?"anonymous":"auto",n=null,p="auto",u={f:"json"},a="json";e&&(e.authMode&&(o=e.authMode),e.body&&(n=e.body),e.method&&(p=e.method),e.query&&(u=r({},u,e.query)),e.responseType&&(a=e.responseType));var i={authMode:o,body:n,method:p,query:u,responseType:a,timeout:0};return s(this._normalizeSSL(t),i).then(function(t){return t.data})},d._resultsToTypedArray=function(t,e,r){var o;return r?(o=r.listings||r.notifications||r.userInvitations||r.tags||r.items||r.groups||r.comments||r.provisions||r.results||r.relatedItems||r,(t||e)&&(o=o.map(function(r){var o=c.mixin(t?t.fromJSON(r):r,e);return"function"==typeof o.load&&o.load(),o}))):o=[],o};var h;return d.AUTH_MODE_ANONYMOUS="anonymous",d.AUTH_MODE_AUTO="auto",d.AUTH_MODE_IMMEDIATE="immediate",n([v.property()],d.prototype,"access",void 0),n([v.property()],d.prototype,"allSSL",void 0),n([v.property()],d.prototype,"authMode",void 0),n([v.property()],d.prototype,"authorizedCrossOriginDomains",void 0),n([v.reader("authorizedCrossOriginDomains")],d.prototype,"readAuthorizedCrossOriginDomains",null),n([v.property()],d.prototype,"basemapGalleryGroupQuery",void 0),n([v.property()],d.prototype,"bingKey",void 0),n([v.property()],d.prototype,"canListApps",void 0),n([v.property()],d.prototype,"canListData",void 0),n([v.property()],d.prototype,"canListPreProvisionedItems",void 0),n([v.property()],d.prototype,"canProvisionDirectPurchase",void 0),n([v.property()],d.prototype,"canSearchPublic",void 0),n([v.property()],d.prototype,"canShareBingPublic",void 0),n([v.property()],d.prototype,"canSharePublic",void 0),n([v.property()],d.prototype,"canSignInArcGIS",void 0),n([v.property()],d.prototype,"canSignInIDP",void 0),n([v.property()],d.prototype,"colorSetsGroupQuery",void 0),n([v.property()],d.prototype,"commentsEnabled",void 0),n([v.property({type:Date})],d.prototype,"created",void 0),n([v.property()],d.prototype,"credential",void 0),n([v.property()],d.prototype,"culture",void 0),n([v.property()],d.prototype,"currentVersion",void 0),n([v.property()],d.prototype,"customBaseUrl",void 0),n([v.property()],d.prototype,"defaultBasemap",void 0),n([v.reader("defaultBasemap")],d.prototype,"readDefaultBasemap",null),n([v.property({type:P})],d.prototype,"defaultExtent",void 0),n([v.property()],d.prototype,"defaultVectorBasemap",void 0),n([v.reader("defaultVectorBasemap")],d.prototype,"readDefaultVectorBasemap",null),n([v.property()],d.prototype,"description",void 0),n([v.property()],d.prototype,"eueiEnabled",void 0),n([v.property({dependsOn:["user","id","canSearchPublic"],readOnly:!0})],d.prototype,"extraQuery",null),n([v.property()],d.prototype,"featuredGroups",void 0),n([v.property()],d.prototype,"featuredItemsGroupQuery",void 0),n([v.property()],d.prototype,"galleryTemplatesGroupQuery",void 0),n([v.property()],d.prototype,"livingAtlasGroupQuery",void 0),n([v.property()],d.prototype,"hasCategorySchema",void 0),n([v.property()],d.prototype,"helpBase",void 0),n([v.property()],d.prototype,"helperServices",void 0),n([v.property()],d.prototype,"helpMap",void 0),n([v.property()],d.prototype,"homePageFeaturedContent",void 0),n([v.property()],d.prototype,"homePageFeaturedContentCount",void 0),n([v.property()],d.prototype,"httpPort",void 0),n([v.property()],d.prototype,"httpsPort",void 0),n([v.property()],d.prototype,"id",void 0),n([v.property()],d.prototype,"ipCntryCode",void 0),n([v.property({dependsOn:["access"],readOnly:!0})],d.prototype,"isOrganization",null),n([v.property()],d.prototype,"isPortal",void 0),n([v.property()],d.prototype,"layerTemplatesGroupQuery",void 0),n([v.property()],d.prototype,"maxTokenExpirationMinutes",void 0),n([v.property({type:Date})],d.prototype,"modified",void 0),n([v.property()],d.prototype,"name",void 0),n([v.property()],d.prototype,"portalHostname",void 0),n([v.property()],d.prototype,"portalMode",void 0),n([v.property()],d.prototype,"portalProperties",void 0),n([v.property()],d.prototype,"region",void 0),n([v.property({dependsOn:["url"],readOnly:!0})],d.prototype,"restUrl",null),n([v.property()],d.prototype,"rotatorPanels",void 0),n([v.property()],d.prototype,"showHomePageDescription",void 0),n([v.property()],d.prototype,"staticImagesUrl",void 0),n([v.property()],d.prototype,"stylesGroupQuery",void 0),n([v.property()],d.prototype,"supportsHostedServices",void 0),n([v.property()],d.prototype,"symbolSetsGroupQuery",void 0),n([v.property()],d.prototype,"templatesGroupQuery",void 0),n([v.property()],d.prototype,"thumbnail",void 0),n([v.property({dependsOn:["restUrl","thumbnail"],readOnly:!0})],d.prototype,"thumbnailUrl",null),n([v.property()],d.prototype,"units",void 0),n([v.property()],d.prototype,"url",void 0),n([v.property()],d.prototype,"urlKey",void 0),n([v.reader("urlKey")],d.prototype,"readUrlKey",null),n([v.property()],d.prototype,"user",void 0),n([v.reader("user")],d.prototype,"readUser",null),n([v.property()],d.prototype,"useStandardizedQuery",void 0),n([v.property()],d.prototype,"useVectorBasemaps",void 0),n([v.property()],d.prototype,"vectorBasemapGalleryGroupQuery",void 0),n([p(1,v.cast(S))],d.prototype,"_queryPortal",null),d=h=n([v.subclass("esri.portal.Portal")],d)}(v.declared(d,h))});