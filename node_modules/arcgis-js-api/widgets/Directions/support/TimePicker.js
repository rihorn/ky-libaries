// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.10/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/declareExtendsHelper","../../../core/tsSupport/decorateHelper","dojo/i18n!../nls/TimePicker","dojo/keys","../../../moment","../../../core/accessorSupport/decorators","../../Widget","./TimePickerViewModel","../../support/widget"],function(e,t,i,r,a,n,s,o,u,p,h){function l(e){return e.format(d).indexOf(" ")>-1}var c={base:"esri-time-picker esri-widget",timePicker:"esri-time-picker__date-picker",timePickerInput:"esri-time-picker__input",input:"esri-input",button:"esri-widget--button"},d="LT",v=[n.DOWN_ARROW,n.LEFT_ARROW,n.RIGHT_ARROW,n.UP_ARROW,n.TAB];return function(e){function t(t){var i=e.call(this)||this;return i._activeTime=null,i.value=null,i.viewModel=new p,i}return i(t,e),t.prototype.render=function(){var e=this._activeTime||this.viewModel.value;return h.tsx("div",{class:c.base},h.tsx("input",{afterUpdate:this._handleInputUpdate,"aria-label":a.inputTitle,bind:this,class:this.classes(c.timePickerInput,c.input),onblur:this._handleInputBlur,onfocus:this._handleInputFocus,onkeydown:this._handleInputKeydown,onclick:this._handleInputClick,onpaste:this._handleInputPaste,onwheel:this._handleInputWheel,value:e.format(d)}))},t.prototype._handleInputBlur=function(){this._activeTime.isValid()&&(this.viewModel.value=this._activeTime),this._activeTime=null,this._activePart=null},t.prototype._handleInputUpdate=function(e){this._selectPart(e,this._activePart)},t.prototype._selectPart=function(e,t){var i=this._activeTime;if(i){var r=i.format(d),a=r.indexOf(":");if("hours"===t)return void e.setSelectionRange(0,a);var n=a+1,s=n+2;if("minutes"===t)return void e.setSelectionRange(n,s);var o=s+1,u=r.length;return"meridiem"===t?void e.setSelectionRange(o,u):void 0}},t.prototype._handleInputFocus=function(e){this._activePart="hours",this._activeTime=this.viewModel.value.clone().startOf("minute"),this._selectPart(e.target,"hours")},t.prototype._caretIndexToPartName=function(e){var t=this._activeTime.format(d),i=t.indexOf(":"),r=t.indexOf(" ");return e<=i?"hours":e>i&&e<=r?"minutes":"meridiem"},t.prototype._handleInputKeydown=function(e){var t=e.ctrlKey,i=e.key,r=e.keyCode,a=e.metaKey,s=e.shiftKey,o=this._activeTime,u=this._activePart,p=/\d/.test(i),h=/^a|p$/i.test(i),l=a||t;if(!(v.indexOf(r)>-1||p||"meridiem"===u&&h&&!l))return void(l||(e.preventDefault(),e.stopImmediatePropagation()));if(r===n.LEFT_ARROW)this._activePart=this._prevPart();else if(r===n.RIGHT_ARROW)this._activePart=this._nextPart();else if(r===n.TAB){var c=s?this._prevPart():this._nextPart();if(c===this._activePart)return;this._activePart=c}else if(r===n.UP_ARROW)this._shift("up",o,u);else if(r===n.DOWN_ARROW)this._shift("down",o,u);else if(p)this._setTime(o,u,Number(i));else if(h){var d=i.toLowerCase(),_=o.hour(),m="a"===d&&_>=12||"p"===d&&_<12;m&&this._shift("up",o,u)}e.preventDefault(),e.stopImmediatePropagation()},t.prototype._handleInputClick=function(e){var t=e.target;this._activePart=null,this.renderNow(),this._activePart=this._caretIndexToPartName(t.selectionStart)},t.prototype._getOrderedParts=function(){return l(this._activeTime)?["hours","minutes","meridiem"]:["hours","minutes"]},t.prototype._prevPart=function(){var e=this._getOrderedParts(),t=e.indexOf(this._activePart)-1;return e[Math.max(t,0)]},t.prototype._nextPart=function(){var e=this._getOrderedParts(),t=e.indexOf(this._activePart)+1;return e[Math.min(t,e.length-1)]},t.prototype._setTime=function(e,t,i){if("hours"===t){var r=l(e)?12:24,a=""+e.hour()%r,n=i,s=Number(""+a+i);2===a.length||s>r?e.hour(n):s<=r&&e.hour(s)}else if("minutes"===t){var o=""+e.minute(),u=i,p=Number(""+o+i);2===o.length||p>59?e.minute(u):p<59&&e.minute(p)}},t.prototype._handleInputPaste=function(e){var t=e.clipboardData.getData("text/plain"),i=s(t);i.isValid()&&(this._activeTime=i),e.preventDefault(),e.stopImmediatePropagation()},t.prototype._handleInputWheel=function(e){var t=e.wheelDeltaY>0?"up":"down";this._shift(t,this._activeTime,this._activePart)},t.prototype._shift=function(e,t,i){if(e&&t&&i){var r="up"===e?"add":"subtract",a="meridiem"===i?12:1,n="hours"===i?"hour":"minutes"===i?"minute":"hours";t[r](a,n)}},r([o.aliasOf("viewModel.value")],t.prototype,"value",void 0),r([o.property({type:p}),h.renderable("viewModel.value")],t.prototype,"viewModel",void 0),t=r([o.subclass("esri.widgets.Directions.support.TimePicker")],t)}(o.declared(u))});