// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.10/esri/copyright.txt for details.

define(["require","exports","../../core/tsSupport/declareExtendsHelper","../../core/tsSupport/decorateHelper","../../Graphic","../../core/Collection","../../core/Handles","../../core/accessorSupport/decorators","../../geometry/geometryEngine","../../geometry/Point","../../geometry/Polyline","../../geometry/projection","../../geometry/ScreenPoint","../../geometry/SpatialReference","../../geometry/support/geodesicUtils","../../layers/GraphicsLayer","../../views/2d/draw/Draw","../../views/interactive/InteractiveToolBase","../../views/interactive/interactiveToolUtils"],function(e,t,r,i,n,o,s,a,c,d,h,l,p,u,v,y,_,m,f){return function(e){function t(t){var r=e.call(this,t)||this;return r._handles=new s,r._mapHandles=new s,r._sketchHandles=new s,r._sketchLayer=new y,r._vertices=null,r._vertexDrag=null,r._vertexHoverIndex=-1,r}return r(t,e),t.prototype.initialize=function(){var e=this;this._draw=new _({view:this.view});var t=this.view;t.map.add(this._sketchLayer),t.focus(),this._mapHandles.add(t.on("pointer-move",function(t){return e._updateCursor(new p(t.x,t.y))})),this._mapHandles.add(t.on("drag",function(r){switch(r.action){case"start":t.hitTest(r).then(function(t){var i=new o(t.results);if(0!==i.length){var n=e._sketchLayer.graphics.filter(function(e){return"point"===e.geometry.type});if(0!==n.length){var s=i.find(function(e){return-1!==n.indexOf(e.graphic)});if(s){var a=s.graphic.geometry,c=new o(e._vertices),d=c.findIndex(function(e){return e[0]===a.x&&e[1]===a.y});e._vertexDrag={index:d,origin:a},f.setActive(e,!0),r.stopPropagation()}}}});break;case"update":if(e._vertexDrag){var i=t.toMap(r.origin),n=t.toMap(r);e._vertices[e._vertexDrag.index]=[e._vertexDrag.origin.x+n.x-i.x,e._vertexDrag.origin.y+n.y-i.y],e._updateMeasurements(),r.stopPropagation()}break;case"end":e._vertexDrag=null,f.setActive(e,!1)}})),this._handles.add(this.watch(["viewModel.unit","viewModel.mode"],function(){e._updateMeasurements()})),this.projectionEngineRequired&&this.projectionEngineSupported&&(l.isLoaded()||l.load())},t.prototype.destroy=function(){this.detach(),this._sketchHandles.removeAll(),this._mapHandles.removeAll(),this._sketchLayer.removeAll(),this.viewModel.view.map.remove(this._sketchLayer),this.viewModel.measurement=null,this._draw&&(this._draw.destroy(),this._draw=null),this._drawAction&&(this._drawAction.destroy(),this._drawAction=null),this._sketchHandles&&(this._sketchHandles.destroy(),this._sketchHandles=null),this._mapHandles&&(this._mapHandles.destroy(),this._mapHandles=null),this._sketchLayer&&(this._sketchLayer.destroy(),this._sketchLayer=null),this._handles&&(this._handles.destroy(),this._handles=null)},Object.defineProperty(t.prototype,"editable",{set:function(e){this._set("editable",e),e||this._drawAction&&(this._drawAction.destroyed||this._drawAction.destroy(),this._drawAction=null,this._sketchHandles.removeAll()),this._updateMeasurements()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"projectionEngineRequired",{get:function(){if(!this.view||!this.view.spatialReference)return!1;var e=this.view.spatialReference;return!e.isWebMercator&&!e.isWGS84&&!v.isSupported(e)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"projectionEngineSupported",{get:function(){return l.isSupported()},enumerable:!0,configurable:!0}),t.prototype.show=function(){this._sketchLayer.visible=!0},t.prototype.hide=function(){this._sketchLayer.visible=!1},t.prototype.reset=function(){this._vertices=null,this._vertexDrag=null,this._vertexHoverIndex=-1,this._sketchLayer.removeAll(),this.viewModel.measurement=null},t.prototype.newMeasurement=function(){this.reset(),f.setActive(this,!0),this._startSketch()},t.prototype.clearMeasurement=function(){this.reset()},t.prototype._startSketch=function(){var e=this;this._drawAction=this._draw.create("polyline",{mode:"click"}),this._sketchHandles.add([this._drawAction.on("vertex-add",function(t){return e._updateSketch(t.vertices)}),this._drawAction.on("vertex-update",function(t){return e._updateSketch(t.vertices)}),this._drawAction.on("vertex-remove",function(t){return e._updateSketch(t.vertices)}),this._drawAction.on("cursor-update",function(t){return e._updateSketch(t.vertices)}),this._drawAction.on("undo",function(t){return e._updateSketch(t.vertices)}),this._drawAction.on("redo",function(t){return e._updateSketch(t.vertices)}),this._drawAction.on("draw-complete",function(){return e._stopSketch()})])},t.prototype._stopSketch=function(){this._sketchHandles.removeAll(),this._drawAction=null,f.setActive(this,!1)},t.prototype._updateSketch=function(e){this._vertices=e,this._updateMeasurements()},t.prototype._updateCursor=function(e){var t=this,r=this.viewModel.view;return this._vertexDrag?void(r.cursor="grabbing"):this._drawAction?void(r.cursor="crosshair"):void r.hitTest(e).then(function(e){var r=-1;if(0!==e.results.length){var i=new o(e.results),n=i.map(function(e){return e.graphic}),s=n.find(function(e){return e&&e.layer===t._sketchLayer&&"point"===e.geometry.type});if(s){var a=s.geometry;r=new o(t._vertices).findIndex(function(e){return e[0]===a.x&&e[1]===a.y})}}r!==t._vertexHoverIndex&&(t._vertexHoverIndex=r,t.cursor=-1===t._vertexHoverIndex?null:"pointer",t._updateMeasurements())})},t.prototype._updateMeasurements=function(){var e=this;if(this._vertices&&(!this.projectionEngineRequired||l.isLoaded())&&(this._sketchLayer.removeAll(),!(this._vertices.length<2))){var t=this.viewModel,r=t.palette,i=t.view.spatialReference,o=[],s=v.isSupported(i),a=!s&&!i.isWebMercator&&!i.isWGS84,p=new h({paths:[this._vertices],spatialReference:i}),y=a?l.project(p,u.WGS84):p,_=null;if(s||a)t.measurement={geometry:y,length:v.geodesicLengths([y],"meters")[0]},_=v.geodesicDensify(y,1e5);else{var m=c.planarLength(y,"meters");"geodesic"===t.mode||"auto"===t.mode&&m>=t.geodesicDistanceThreshold?(t.measurement={geometry:y,length:c.geodesicLength(y,"meters")},_=c.geodesicDensify(p,1e5,"meters")):(t.measurement={geometry:y,length:m},_=p.clone())}o.push(new n({geometry:_,symbol:{type:"simple-line",cap:"butt",join:"round",color:r.pathPrimaryColor,width:r.pathWidth}}),new n({geometry:_,symbol:{type:"simple-line",style:"dash",cap:"butt",join:"round",color:r.pathSecondaryColor,width:r.pathWidth-2}})),o.push(new n({geometry:p.extent.center,symbol:{type:"text",color:[255,255,255,1],haloColor:[0,0,0,.5],haloSize:2,text:t.measurementLabel,font:{size:14,family:"sans-serif"}}})),this.editable&&this._vertices.forEach(function(t,s){var a=e._vertexHoverIndex===s?1.5:1;o.push(new n({geometry:new d({x:t[0],y:t[1],spatialReference:i}),symbol:{type:"simple-marker",color:r.handleColor,size:r.handleWidth*a,outline:{type:"simple-line",width:0}}}))}),this._sketchLayer.addMany(o)}},i([a.property({constructOnly:!0})],t.prototype,"viewModel",void 0),i([a.property()],t.prototype,"cursor",void 0),i([a.property({value:!0})],t.prototype,"editable",null),i([a.property({dependsOn:["view.spatialReference"],readOnly:!0})],t.prototype,"projectionEngineRequired",null),i([a.property({readOnly:!0})],t.prototype,"projectionEngineSupported",null),t=i([a.subclass("esri.widgets.DistanceMeasurement2D.DistanceMeasurement2DTool")],t)}(a.declared(m))});