// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.10/esri/copyright.txt for details.

define(["require","exports","../../core/tsSupport/declareExtendsHelper","../../core/tsSupport/decorateHelper","../../core/tsSupport/assignHelper","dojo/i18n!dojo/cldr/nls/number","../../Graphic","../../core/date","../../core/Error","../../core/Handles","../../core/lang","../../core/Logger","../../core/promiseUtils","../../core/throttle","../../core/watchUtils","../../core/accessorSupport/decorators","../../support/arcadeUtils","../../support/ContentElement/Text","../../support/ContentElement/Media/Chart/Series","../../support/FieldInfo/Format","../../tasks/support/AttachmentQuery","./support/featureUtils","./support/RelatedFeatures","../support/widget"],function(e,t,r,i,o,a,n,s,l,u,p,f,c,d,h,m,y,_,v,g,F,b,I,A){function x(e,t){var r=t[e];if("string"==typeof r){var i=/\'/g,o=encodeURIComponent(r).replace(i,"&apos;");t[e]=o}}function E(e,t){return e&&"feature"===e.type?e.getField(t):null}function w(e){return(""+e).trim()}function C(e,t,r,i){return t=w(t),p.substitute(t&&"{"===t[0]?r:i,e)}function T(e){return e.replace(/[\u00A0-\u99999<>\&]/gim,function(e){return"&#"+e.charCodeAt(0)+";"})}var N=f.getLogger("esri.widgets.FeatureViewModel"),L=/^\s*expression\//i,R=new RegExp(""+a.group,"g"),P=new l("cancelled-query","cancelled feature query"),D=s.getFormat("short-date-short-time"),O="DateFormat"+D;return function(e){function t(t){var r=e.call(this)||this;return r._handles=new u,r._featurePromise=void 0,r._layerDateFields=null,r._expressionAttributes=null,r._graphicChangedThrottled=d.throttle(r._graphicChanged,1,r),r._effectivePopupTemplate=null,r.content=null,r.contentEnabled=!0,r.formattedAttributes=null,r.graphic=null,r.lastEditInfo=null,r.title="",r.view=null,r._handles.add(h.watch(r,["graphic","graphic.sourceLayer.popupTemplate.title","graphic.sourceLayer.popupTemplate.content","graphic.sourceLayer.popupTemplate.fieldInfos","graphic.sourceLayer.popupTemplate.lastEditInfoEnabled","graphic.popupTemplate.title","graphic.popupTemplate.content","graphic.popupTemplate.fieldInfos","graphic.popupTemplate.lastEditInfoEnabled","contentEnabled"],function(){return r._graphicChangedThrottled()})),r}return r(t,e),t.prototype.destroy=function(){this._clear(),this._cancelFeatureQuery(),this._handles.destroy(),this._handles=null,this.view=null,this.graphic=null,this._layerDateFields=null,this._expressionAttributes=null},Object.defineProperty(t.prototype,"waitingForContent",{get:function(){return!!this._featurePromise},enumerable:!0,configurable:!0}),t.prototype._clear=function(){this._set("title",""),this._set("content",null),this._set("formattedAttributes",null)},t.prototype._graphicChanged=function(){var e=this;this._cancelFeatureQuery(),this._clear();var t=this.graphic;if(t){var r=b.getSourceLayer(t);this._layerDateFields=r?this._getDateFields(r):[];var i=!1,o=this._queryFeature().catch(function(e){e!==P&&N.error("error","error loading template",e)}).then(function(){i=!0,e._featurePromise=null,e.notifyChange("waitingForContent")});i||(this._featurePromise=o,this.notifyChange("waitingForContent"))}},t.prototype._cancelFeatureQuery=function(){var e=this._featurePromise;e&&"function"==typeof e.cancel&&e.cancel(P),this._featurePromise=null,this.notifyChange("waitingForContent")},t.prototype._compileContent=function(e,t){var r=this;return e&&(e.nodeName||e&&A.isWidgetBase(e)||A.isWidget(e))?e:"string"==typeof e?this._compileText(new _({text:e})).text:Array.isArray(e)?e.map(function(e,i){var o=t&&t[i],a=o&&o.value;return"attachments"===e.type?r._compileAttachments(e,a):"fields"===e.type?r._compileFields(e):"media"===e.type?r._compileMedia(e):"text"===e.type?r._compileText(e):void 0}):void(e&&N.warn("invalid content type."))},t.prototype._compileFields=function(e){var t=this,r=this._effectivePopupTemplate,i=p.clone(e),o=r&&r.expressionInfos,a=i.fieldInfos?void 0:r&&r.fieldInfos,n=i.fieldInfos||p.clone(a),s=[];return n&&n.forEach(function(e){var r=e.fieldName.toLowerCase();if(!e.hasOwnProperty("visible")||e.visible){var i=t._isExpressionField(r)?t._getExpressionInfo(o,r):null;e.label=i?i.title:e.label,s.push(e)}}),i.fieldInfos=s,i},t.prototype._setImageValue=function(e){var t=e.value,r=e.formattedAttributes,i=e.layer,o=t.linkURL,a=t.sourceURL;if(a){var n=this._fixTokens(a,i);t.sourceURL=this._substituteAttributes(r,n)}if(o){var s=this._fixTokens(o,i);t.linkURL=this._substituteAttributes(r,s)}},t.prototype._compileMedia=function(e){var t=this,r=this,i=r._expressionAttributes,a=r._layerDateFields,n=r.graphic,s=p.clone(e),l=s.mediaInfos,u=o({},n.attributes,i),f=b.getSourceLayer(n),c=this.formattedAttributes.global,d={dateFormat:{properties:a,formatter:O}};return s.mediaInfos=l&&l.map(function(e){var r=p.clone(e);if(r){var i=r.title?t._processFieldsInLinks(r.title,u):"",o=r.caption?t._processFieldsInLinks(r.caption,u):"";if(r.title=i?t._substituteAttributes(c,i,d):"",r.caption=o?t._substituteAttributes(c,o,d):"","image"===r.type){var a=r.value;return t._setImageValue({value:a,formattedAttributes:c,layer:f}),r.value.sourceURL?r:void 0}if("pie-chart"===r.type||"line-chart"===r.type||"column-chart"===r.type||"bar-chart"===r.type){var a=r.value;return t._setChartValue({value:a,attributes:u,formattedAttributes:c,layer:f}),r}}}).filter(Boolean),s},t.prototype._substituteAttributes=function(e,t,r){return w(this._removeEmptyHref(p.substitute(e,t,r)))},t.prototype._compileText=function(e){var t=this,r=t._expressionAttributes,i=t._layerDateFields,a=t.graphic,n=p.clone(e);if(n&&n.text){var s=o({},a.attributes,r),l=this.formattedAttributes.global,u={dateFormat:{properties:i,formatter:O}},f=this._processFieldsInLinks(n.text,s);n.text=this._substituteAttributes(l,f,u)}return n},t.prototype._formatEditInfo=function(e,t){var r=e.creatorField,i=e.creationDateField,o=e.editorField,a=e.editDateField;if(t){var n=t[a];if("number"==typeof n){var s=t[o],l=p.substitute({myKey:n},"{myKey:"+O+"}");return{type:"edit",date:l,user:s}}var u=t[i];if("number"==typeof u){var f=t[r],l=p.substitute({myKey:u},"{myKey:"+O+"}");return{type:"create",date:l,user:f}}}},t.prototype._compileLastEditInfo=function(){var e=this,t=e._effectivePopupTemplate,r=e.graphic;if(t){var i=t.lastEditInfoEnabled,o=r.get("sourceLayer.editFieldsInfo");if(i&&o)return this._formatEditInfo(o,r.attributes)}},t.prototype._compileTitle=function(){var e=this,t=e._expressionAttributes,r=e._effectivePopupTemplate,i=e._layerDateFields,a=e.graphic,n=r&&r.title,s=o({},a.attributes,t),l={dateFormat:{properties:i,formatter:O}},u=this.formattedAttributes.global;if("function"==typeof n)return n.call(null,{graphic:a});if("string"==typeof n&&n){var p=this._processFieldsInLinks(n,s);return this._substituteAttributes(u,p,l)}return""},t.prototype._getExpressionInfo=function(e,t){if(this._isExpressionField(t)){var r,i=t.replace(L,"").toLowerCase();return e.some(function(e){if(e.name.toLowerCase()===i)return r=e,!0}),r}},t.prototype._fixTokens=function(e,t){var r=/(\{([^\{\r\n]+)\})/g;return e.replace(r,function(e,r,i){var o=E(t,i);return o?"{"+o.name+"}":r})},t.prototype._encodeAttributes=function(e){var t=e?p.clone(e):{};return Object.keys(t).forEach(function(e){return x(e,t)}),t},t.prototype._formatAttributesToFieldInfos=function(e,t,r){var i=this,o=p.clone(this._layerDateFields);e.forEach(function(a){var n=i._getFixedFieldName(a.fieldName,t);if(a.fieldName=n,r[n]=i._formatValue(r[n],{fieldInfos:e,fieldName:n,layer:t}),o&&a.format&&a.format.dateFormat){var s=o.indexOf(n);s>-1&&o.splice(s,1)}})},t.prototype._getArcadeViewingMode=function(e){return e&&"local"===e.viewingMode?"localScene":"globalScene"},t.prototype._getViewInfo=function(){var e=this.view;if(e){var t="3d"===e.type?this._getArcadeViewingMode(e):"map",r=e.scale,i=e.spatialReference;return y.getViewInfo({viewingMode:t,scale:r,spatialReference:i})}},t.prototype._formatAttributes=function(e){var t=this,r=this,i=r._expressionAttributes,a=r.graphic,n=a.attributes,s=b.getSourceLayer(a),l=n?p.clone(n):{},u=o({},l,i);return this.addRelatedFeatureAttributes(u),e&&this._formatAttributesToFieldInfos(e,s,u),Object.keys(u).forEach(function(e){var r=u[e];null!=r&&(u[e]=t._getDomainName(e,r)||t._getTypeName(e)||y.applyTextFormattingHTML(r))}),u},t.prototype._formatValue=function(e,t){var r=this._layerDateFields,i={dateFormat:{properties:r,formatter:O}},o=t.fieldInfos,n=t.fieldName,l=this._getFieldInfo(o,n),u=p.clone(l),f=t.preventPlacesFormatting,c=t.layer,d=E(c,n);if(d&&"date"===d.type){var h=u.format||new g;h.dateFormat=h.dateFormat||"short-date-short-time",u.format=h}var m=u&&u.format;if(null==e||!u||null==m)return e;var y=[],_=!m.dateFormat&&(m.hasOwnProperty("places")||m.hasOwnProperty("digitSeparator")),v=!_||!m.hasOwnProperty("digitSeparator")||m.digitSeparator,F=_&&null!=m.places&&(!f||m.places>0);_&&F&&y.push("places: "+Number(m.places));var b=_?F?"NumberFormat("+y.join(",")+")":"NumberFormat":m.dateFormat?"DateFormat"+(s.getFormat(m.dateFormat)||D):void 0;if(!b)return e;var I=p.substitute({myKey:e},"{myKey:"+b+"}",i)||"";return _&&!v&&a.group?I.replace(R,""):I},t.prototype._getDomainName=function(e,t){if(this.isRelatedField(e))return null;var r=this.graphic,i=b.getSourceLayer(r);if(!i||"feature"!==i.type)return null;var o=i.getFieldDomain(e,{feature:r});return o&&"coded-value"===o.type?o.getName(t):null},t.prototype._getFieldInfo=function(e,t){if(e&&e.length&&t){var r=t.toLowerCase(),i=void 0;return e.some(function(e){if(e.fieldName&&e.fieldName.toLowerCase()===r)return i=e,!0}),i}},t.prototype._getTypeName=function(e){if(this.isRelatedField(e))return null;var t=this.graphic,r=b.getSourceLayer(t);if(!r||"feature"!==r.type)return null;if(e!==r.typeIdField)return null;var i=r.getFeatureType(t);return i?i.name:null},t.prototype._removeEmptyHref=function(e){var t=/href=(""|'')/gi;return e.replace(t,"")},t.prototype._processFieldsInLinks=function(e,t){var r=this.get("graphic.layer"),i=this._fixTokens(e,r),o=this._encodeAttributes(t),a=/href\s*=\s*(?:\"([^\"]+)\"|\'([^\']+)\')/gi;return i?i.replace(a,function(e,r,i){return C(e,r||i,t,o)}):i},t.prototype._compileAttachments=function(e,t){var r=p.clone(e);return!t||t&&0===t.length?r:(r.attachmentInfos=t,r)},t.prototype._queryAttachments=function(){var e=this.graphic,t=b.getSourceLayer(e);if(!t)return c.resolve([]);var r="scene"===t.type&&t.associatedLayer?t.associatedLayer:t;if(r&&"feature"===r.type){var i=r,o=i.objectIdField,a=e.attributes,n=a&&a[o],s=new F({objectIds:[n]});return i.queryAttachments(s).then(function(e){return e[n]||[]})}return c.resolve([])},t.prototype._queryContentElements=function(e){var t=this;if(!Array.isArray(e))return c.resolve();var r={};return e.forEach(function(e,i){if("attachments"===e.type){var o=t._queryAttachments();o&&(r[i]=o)}}),Object.keys(r).length?c.eachAlways(r):c.resolve()},t.prototype._getContent=function(){var e=this,t=e._effectivePopupTemplate,r=e.contentEnabled,i=e.graphic;if(!r||!i)return c.resolve();var o=t&&t.content,a="function"==typeof o?o.call(null,{graphic:i}):o;return c.isThenable(a)?a:c.resolve(a)},t.prototype._enableGeometryOperations=function(){var e=this._effectivePopupTemplate;return e&&y.hasGeometryOperations(e)?y.enableGeometryOperations():c.resolve(!1)},t.prototype._queryFeature=function(){var e=this,t=this.graphic;return this._effectivePopupTemplate=t&&t.getEffectivePopupTemplate(),this._enableGeometryOperations().then(function(){return e._getContent().then(function(t){return e._checkForRelatedFeatures(t).then(function(){return e._expressionAttributes=e._createFormattedExpressions(),e._set("formattedAttributes",e._createFormattedAttributes(t)),e._set("title",e._compileTitle()),e._queryContentElements(t).then(function(r){var i=e._compileLastEditInfo();e._set("lastEditInfo",i||null);var o=e._compileContent(t,r);return e._set("content",o||null),o})})})})},t.prototype._isExpressionField=function(e){return L.test(e)},t.prototype._createCompiledExpressionDictionary=function(e){var t=new Map;return e?(e.forEach(function(e){return t.set(e.name,y.createFunction(e.expression))}),t):t},t.prototype._getDateFields=function(e){var t=e.fields;return t?t.filter(function(e){return"date"===e.type}).map(function(e){return e.name}):[]},t.prototype._formatArcadeArray=function(e){return'<ul class="esri-widget__list">'+e.map(function(e){return"<li>"+("string"==typeof e?T(e):e)+"</li>"}).join("")+"</ul>"},t.prototype._formatArcadeDictionary=function(e){return'<table class="esri-widget__table">'+e.keys().map(function(t){var r=e.field(t);return"<tr><th>"+t+"</th><td>"+("string"==typeof r?T(r):r)+"</td></tr>"}).join("")+"</table>"},t.prototype._createFormattedExpressions=function(){var e=this,t=this,r=t._effectivePopupTemplate,i=t.graphic,o=r&&r.expressionInfos,a=this._createCompiledExpressionDictionary(o),n={};return o&&o.forEach(function(t){var r="expression/"+t.name,o=a.get(t.name),s=e._getViewInfo(),l=y.executeFunction(o,y.createExecContext(i,s));n[r]="string"==typeof l?T(l):Array.isArray(l)?e._formatArcadeArray(l):l&&"esri.arcade.Dictionary"===l.declaredClass?e._formatArcadeDictionary(l):l}),n},t.prototype._createFormattedAttributes=function(e){var t=this,r=this._effectivePopupTemplate,i=r&&r.fieldInfos,o={global:this._formatAttributes(i),content:[]};return Array.isArray(e)&&e.forEach(function(e,r){"fields"===e.type&&e.fieldInfos&&(o.content[r]=t._formatAttributes(e.fieldInfos))}),o},t.prototype._getAllFieldInfos=function(e){var t=this._effectivePopupTemplate,r=[],i=t&&t.fieldInfos;return i&&r.push.apply(r,i),e&&Array.isArray(e)?(e.forEach(function(e){if("fields"===e.type){var t=e&&e.fieldInfos;r.push.apply(r,t)}}),r):r},t.prototype._checkForRelatedFeatures=function(e){var t=this.graphic,r=this._getAllFieldInfos(e);return this.queryRelatedInfos(t,r)},t.prototype._getChartOption=function(e){var t=e.value,r=e.attributes,i=e.formattedAttributes,o=e.fieldName,n=e.relatedFieldName,s=e.fieldInfos,l=e.index,u=this.graphic,p=b.getSourceLayer(u),f=t.normalizeField,c=t.tooltipField,d=f?this.isRelatedField(f)?r[this.getRelatedFieldInfo(f).fieldName]:r[f]:null,h=n&&void 0!==r[n]?r[n]:void 0!==r[o]?r[o]:i[o],m="string"==typeof h&&a.group?parseFloat(h.replace(R,"")):h,y=void 0===m?null:m&&d?m/d:m,_=new v({x:l,y:y});if(this.isRelatedField(o)){var g=this.getRelatedFieldInfo(o),F=this.getRelatedFieldInfo(c),I=F?F.fieldName:null,A=this._formatValue(y,{fieldInfos:s,fieldName:n,layer:p,preventPlacesFormatting:!!d}),x=g?g.label||g.fieldName:n,E=I&&void 0!==r[I]?r[I]:x;return _.tooltip=E+": "+A,_}var w=this._getFieldInfo(s,o),C=this._getFixedFieldName(o,p),T=w?w.label||w.fieldName:o,N=c&&void 0!==i[c]?i[c]:T,L=i[C];return _.tooltip=N+": "+L,_},t.prototype._getFixedFieldName=function(e,t){var r=E(t,e);return r?r.name:e},t.prototype._getFixedFieldNames=function(e,t){var r=this;return e&&e.map(function(e){return r._getFixedFieldName(e,t)})},t.prototype._setChartValue=function(e){var t=this,r=e.value,i=e.attributes,o=e.formattedAttributes,a=e.layer,n=this,s=n._effectivePopupTemplate,l=n.relatedInfoCount,u=r.fields,p=r.normalizeField;if(r.fields=this._getFixedFieldNames(u,a),p&&(r.normalizeField=this._getFixedFieldName(p,a)),u.some(function(e){return!!(null!=o[e]||t.isRelatedField(e)&&l)})){var f=s&&s.fieldInfos;u.forEach(function(e,a){if(t.isRelatedField(e))return void(r.series=r.series.concat(t._getRelatedChartInfos({fieldInfos:f,fieldName:e,formattedAttributes:o,value:r})));var n=t._getChartOption({value:r,index:a,attributes:i,formattedAttributes:o,fieldName:e,fieldInfos:f});r.series.push(n)})}},t.prototype._getRelatedChartInfos=function(e){var t=this,r=e.fieldInfos,i=e.fieldName,o=e.formattedAttributes,a=e.value,n=[],s=this.getRelatedFieldInfo(i),l=s.layerId,u=s.fieldName,p=this.getRelatedInfo(l);if(!p)return n;var f=p.relatedFeatures,c=p.relation;if(!c||!f)return n;var d=c.cardinality;return f.forEach(function(e,s){var l=e.attributes;l&&Object.keys(l).forEach(function(e){e===u&&n.push(t._getChartOption({value:a,index:s,attributes:l,formattedAttributes:o,fieldName:i,relatedFieldName:e,fieldInfos:r}))})}),"one-to-many"===d||"many-to-many"===d?n:[n[0]]},i([m.property({readOnly:!0})],t.prototype,"content",void 0),i([m.property()],t.prototype,"contentEnabled",void 0),i([m.property({readOnly:!0})],t.prototype,"formattedAttributes",void 0),i([m.property({type:n})],t.prototype,"graphic",void 0),i([m.property({readOnly:!0})],t.prototype,"lastEditInfo",void 0),i([m.property({readOnly:!0})],t.prototype,"title",void 0),i([m.property()],t.prototype,"view",void 0),i([m.property({readOnly:!0})],t.prototype,"waitingForContent",null),t=i([m.subclass("esri.widgets.FeatureViewModel")],t)}(m.declared(I))});