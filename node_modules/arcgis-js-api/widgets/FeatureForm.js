// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.10/esri/copyright.txt for details.

define(["require","exports","../core/tsSupport/assignHelper","../core/tsSupport/declareExtendsHelper","../core/tsSupport/decorateHelper","dojo/date/locale","../moment","../core/accessorSupport/decorators","../layers/support/domains","../layers/support/fieldUtils","./Widget","./FeatureForm/FeatureFormViewModel","./support/widget"],function(e,t,i,r,a,n,l,u,o,s,d,p,c){function f(e){return e&&e.inputFields}var h={base:"esri-feature-form",form:"esri-feature-form__form",label:"esri-feature-form__label",inputField:"esri-feature-form__input",inputDate:"esri-feature-form__input--date",inputTime:"esri-feature-form__input--time",inputDisabled:"esri-feature-form__input--disabled",inputInvalid:"esri-feature-form__input--invalid",inputIconInvalid:"esri-feature-form__input-icon--invalid",errorMessage:"esri-feature-form__field-error-message",description:"esri-feature-form__description-text",dateInputPart:"esri-feature-form__date-input-part",dateInputContainer:"esri-feature-form__date-input-container",dateFormatHint:"esri-feature-form__date-format-hint",group:"esri-feature-form__group",groupLabel:"esri-feature-form__group-label",groupDescription:"esri-feature-form__group-description",groupCollapsed:"esri-feature-form__group--collapsed",groupSequential:"esri-feature-form__group--sequential",groupActive:"esri-feature-form__group--active",errorIcon:"esri-icon-notice-triangle",widget:"esri-widget",input:"esri-input",select:"esri-select"},v={datePattern:"M/d/y",timePattern:"h:mm:ss a"};return function(e){function t(t){var i=e.call(this)||this;return i._fieldFocusNeeded=!1,i._activeDateEdit=null,i._activeInput=null,i.feature=null,i.fieldConfig=null,i.groupDisplay="all",i.layer=null,i.strict=null,i.viewModel=new p,i._handleFormKeyDown=i._handleFormKeyDown.bind(i),i._handleInputBlur=i._handleInputBlur.bind(i),i._handleInputFocus=i._handleInputFocus.bind(i),i._handleNumberInputMouseDown=i._handleNumberInputMouseDown.bind(i),i._handleInputKeyDown=i._handleInputKeyDown.bind(i),i._handleOptionChange=i._handleOptionChange.bind(i),i._handleCollapsedGroupClick=i._handleCollapsedGroupClick.bind(i),i._handleSubmit=i._handleSubmit.bind(i),i._afterScrollerCreateOrUpdate=i._afterScrollerCreateOrUpdate.bind(i),i}return r(t,e),t.prototype.postInitialize=function(){var e=this;this.own(this.watch("feature",function(){var t=e.viewModel.inputFields[0];e._activeInput=f(t)?t.inputFields[0]:t,e._fieldFocusNeeded=!0}),this.on("submit",function(t){if(t.invalid.length>0){var i=t.invalid[0],r=e.viewModel.findField(i);e._activeInput=r,e._fieldFocusNeeded=!0,e.scheduleRender()}}))},t.prototype.getValues=function(){return null},t.prototype.submit=function(){return null},t.prototype.render=function(){var e=this.viewModel.state;return c.tsx("div",{class:this.classes(h.base,h.widget)},"ready"===e?this.renderForm():null)},t.prototype.renderForm=function(){return c.tsx("form",{class:h.form,novalidate:!0,onsubmit:this._handleSubmit,onkeydown:this._handleFormKeyDown},this.renderFields())},t.prototype.renderFields=function(){var e=this;return this.viewModel.inputFields.map(function(t,i){return f(t)?e.renderGroup(t,i):e.renderLabeledField(t)})},t.prototype.renderGroup=function(e,t){var i=this,r=e.description,a=e.label,n=e.inputFields,l=this._activeInput&&this._activeInput.group===e,u=this.id+"_group_"+t,o=this.id+"_group-label_"+t,s=this.id+"_group-description_"+t,d=r?c.tsx("p",{class:this.classes(h.groupDescription,h.description),id:s},r):null,p="sequential"===this.groupDisplay;return c.tsx("fieldset",{class:this.classes(h.group,p?h.groupSequential:null,!p||l?null:h.groupCollapsed,l?h.groupActive:null),"aria-labelledby":o,"aria-describedby":r?s:"","data-group":e,id:u,onclick:this._handleCollapsedGroupClick},c.tsx("div",{class:h.groupLabel,id:o},a),d,n.map(function(e){return i.renderLabeledField(e)}))},t.prototype.renderLabeledField=function(e){var t=e.label,i=e.layer,r=e.type;return c.tsx("label",{key:i.id+"-"+e.name,class:h.label},[t,"unsupported"!==r?this.renderInputField(e):this.renderUnsupportedField(e),this.renderAuxiliaryText(e)])},t.prototype.renderInputField=function(e){var t=this.viewModel,r=e.domain,a=e.editable,n=e.name,l=e.type,u=t.getValue(n),o=!a,s=this.getCommonInputProps(e);return r&&"coded-value"===r.type&&!o?this.renderSelectInputField(u,r.codedValues.map(function(e){return{value:e.code,name:e.name}}),s):"text"===l&&"text-area"===e.editorType||"rich-text"===e.editorType?c.tsx("textarea",i({},s)):"date"===l?this.renderDateInputField(u,s):c.tsx("input",i({type:"text"===l?"text":"number"},s))},t.prototype.renderDateInputField=function(e,t){var r=this._formatDate(0),a=r.date,n=r.time,l=this.id+"-"+t.key,u=l+"-date",o=l+"-time",s=t["data-field"];return c.tsx("div",{key:t.key+"-date",class:h.dateInputContainer},c.tsx("div",{class:h.dateInputPart},c.tsx("input",i({"aria-label":s.label,"aria-describedby":u,type:"text"},t,{"data-date-part":"date",class:this.classes(t.class,h.inputDate),value:this._formatDate(e).date})),c.tsx("div",{class:h.dateFormatHint,id:u},a)),c.tsx("div",{class:h.dateInputPart},c.tsx("input",i({"aria-describedby":o,"aria-label":s.label,type:"text"},t,{"data-date-part":"time",class:this.classes(t.class,h.inputTime),value:this._formatDate(e).time})),c.tsx("div",{class:h.dateFormatHint,id:o},n)))},t.prototype.renderUnsupportedField=function(e){var t=this.viewModel.getValue(e.name);return c.tsx("input",{class:this.classes(h.input,h.inputField,h.inputDisabled),disabled:!0,type:"text",value:""+t})},t.prototype.renderSelectInputField=function(e,t,r){var a=!1,n=t.map(function(t){return t.value===e&&(a=!0),c.tsx("option",{value:""+t.value,key:t.name},t.name)});null==e||""===e||a||n.unshift(c.tsx("option",{value:""+e,key:"outlier-option"},e));var l=r["data-field"];return l.required||null!=l.value||n.unshift(c.tsx("option",{value:"",key:"empty-option"})),c.tsx("select",i({},r,{class:this.classes(r.class,h.select),onchange:this._handleOptionChange}),n)},t.prototype.renderAuxiliaryText=function(e){return e.valid?e.valid&&e.description?c.tsx("div",{key:"description",class:h.description},e.description):void 0:c.tsx("div",{key:"error-message"},c.tsx("span",{class:this.classes(h.inputIconInvalid,h.errorIcon)}),c.tsx("div",{class:h.errorMessage},e.errorMessage))},t.prototype.getCommonInputProps=function(e){var t=this.viewModel,r=e.editable,a=e.name,n=e.required,l=e.maxLength,u=e.hint,o=e.type,s=e.valid,d=t.getValue(a),p=!r;return i({afterCreate:this._afterScrollerCreateOrUpdate,afterUpdate:this._afterScrollerCreateOrUpdate,"aria-invalid":s?"false":"true",class:this.classes(h.input,h.inputField,p?h.inputDisabled:null,s?null:h.inputInvalid),key:a,maxlength:l>-1?""+l:""},this._getNumberFieldConstraints(e),{disabled:p,value:null==d?"":""+d,"data-field":e,onfocus:this._handleInputFocus,onblur:this._handleInputBlur,onkeydown:this._handleInputKeyDown,onmousedown:"number"===o?this._handleNumberInputMouseDown:null,required:n,title:u})},t.prototype._handleNumberInputMouseDown=function(e){var t=e.target,i=t;i.disabled||i.focus(),this.scheduleRender()},t.prototype._getNumberFieldConstraints=function(e){var t=o.getDomainRange(e.domain)||s.getFieldRange(e.field);return t&&t.max!==Number.MAX_VALUE&&t.min!==Number.MIN_VALUE?t:{min:null,max:null}},t.prototype._afterScrollerCreateOrUpdate=function(e){var t=e["data-field"];t.editable&&this._fieldFocusNeeded&&this._activeInput===t&&(this._fieldFocusNeeded=!1,e.focus())},t.prototype._handleInputFocus=function(e){var t=e.target;this._activeInput=t["data-field"]},t.prototype._handleInputBlur=function(e){var t,r=e.target,a=r["data-field"],n=e.relatedTarget,l=n&&n["data-field"];if("date"===a.type){var u=r.getAttribute("data-date-part");this._activeDateEdit=i({},this._activeDateEdit,(t={},t[u]={value:r.value,input:r},t))}if(l&&"date"===a.type&&"date"===l.type&&a.field===l.field){if(""!==r.value&&""===n.value){var u=n.getAttribute("data-date-part");n.value=this._formatDate(Date.now())[u]}}else{if(this._activeDateEdit){var o=this._activeDateEdit,s=o.date,d=o.time,p=this._getDateEditValue(a,"date"),c=this._getDateEditValue(a,"time"),f=""===p||""===c;if(s){var h=s.input;h.value=f?"":p,this._updateFieldValue(h)}if(d){var v=d.input;v.value=f?"":c,this._updateFieldValue(v)}this._activeDateEdit=null}else this._updateFieldValue(r);this.scheduleRender()}},t.prototype._getDateEditValue=function(e,t){var i=this._activeDateEdit[t];if(i){if(""===i.value)return"";var r=this._parseDate(i.value,t);return r?this._formatDate(r.getTime())[t]:this._formatDate(e.value)[t]}},t.prototype._handleInputKeyDown=function(e){var t=e.key,i=e.altKey,r=e.ctrlKey,a=e.metaKey;if("Enter"===t)this._updateFieldValue(e.target),this.scheduleRender();else{var n=e.target,l=n["data-field"],u=l.field.type,o="integer"===u||"small-integer"===u,s="single"===u||"double"===u,d=!i&&!r&&!a;if((o||s)&&d&&1===t.length){var p=Number(t),c=["-","+"],f=["e","."],h=s?c.concat(f):c;isNaN(p)&&-1===h.indexOf(t)&&e.preventDefault()}}},t.prototype._updateFieldValue=function(e){var t=e["data-field"];this.viewModel.setValue(t.name,this._parseValue(e))},t.prototype._parseValue=function(e){var t=e["data-field"],i=e.value,r=t.required,a=t.type;if(!r&&""===i)return null;if("number"===a)return parseFloat(i);if("date"===a){if(!i)return null;var n=e.getAttribute("data-date-part"),u=Number(i);if(!isNaN(u))return u;var o=this._parseDate(i,n);if(!o)return null;var s=l(o),d=t.domain,p=l(),c=p;if(d&&"range"===d.type){var f=l(d.maxValue);p.isAfter(f)||(c=f)}var h=this.viewModel.getValue(t.name),v=l(null!=h?h:c);return"date"===n?(s.hour(v.hour()),s.minutes(v.minutes()),s.seconds(v.seconds())):(s.date(v.date()),s.month(v.month()),s.year(v.year())),s.valueOf()}return i},t.prototype._handleOptionChange=function(e){this._updateFieldValue(e.target),this.scheduleRender()},t.prototype._handleCollapsedGroupClick=function(e){var t=e.currentTarget["data-group"];!t||this._activeInput&&this._activeInput.group===t||(this._activeInput=t.inputFields[0],this._fieldFocusNeeded=!0,this.scheduleRender())},t.prototype._handleSubmit=function(e){e.preventDefault()},t.prototype._handleFormKeyDown=function(e){"Enter"===e.key&&this.viewModel.submit()},t.prototype._formatDate=function(e){if(null==e)return{date:"",time:""};var t=new Date(e);return{date:n.format(t,i({selector:"date"},v)),time:n.format(t,i({selector:"time"},v))}},t.prototype._parseDate=function(e,t){return null==e||""===e?null:n.parse(e,i({selector:t},v))},a([u.aliasOf("viewModel.feature")],t.prototype,"feature",void 0),a([u.aliasOf("viewModel.fieldConfig")],t.prototype,"fieldConfig",void 0),a([u.property(),c.renderable()],t.prototype,"groupDisplay",void 0),a([u.aliasOf("viewModel.layer")],t.prototype,"layer",void 0),a([u.aliasOf("viewModel.strict")],t.prototype,"strict",void 0),a([u.property(),c.renderable(["viewModel.inputFields","viewModel.state"]),c.vmEvent(["value-change","submit"])],t.prototype,"viewModel",void 0),a([u.aliasOf("viewModel.getValues")],t.prototype,"getValues",null),a([u.aliasOf("viewModel.submit")],t.prototype,"submit",null),t=a([u.subclass("esri.widgets.FeatureForm")],t)}(u.declared(d))});