// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.10/esri/copyright.txt for details.

define(["require","exports","../core/tsSupport/declareExtendsHelper","../core/tsSupport/decorateHelper","dojo/i18n!./Feature/nls/Feature","dojo/keys","../core/lang","../core/promiseUtils","../core/watchUtils","../core/accessorSupport/decorators","./Widget","./Feature/FeatureViewModel","./Feature/support/attachmentUtils","./support/uriUtils","./support/widget"],function(e,t,a,i,r,n,s,o,d,c,l,m,h,u,p){function f(e,t){return void 0===t?v+"__"+e:v+"__"+e+"-"+t}var _={iconText:"esri-icon-font-fallback-text",iconLoading:"esri-icon-loading-indicator esri-rotating",iconLeftTriangleArrow:"esri-icon-left-triangle-arrow",iconRightTriangleArrow:"esri-icon-right-triangle-arrow",iconMedia:"esri-icon-media",iconChart:"esri-icon-chart",esriTable:"esri-widget__table",esriWidget:"esri-widget",base:"esri-feature",container:"esri-feature__size-container",main:"esri-feature__main-container",btn:"esri-feature__button",icon:"esri-feature__icon",content:"esri-feature__content",contentElement:"esri-feature__content-element",text:"esri-feature__text",lastEditedInfo:"esri-feature__last-edited-info",showMediaPagination:"esri-feature--media-pagination-visible",attachments:"esri-feature__attachments",attachmentsList:"esri-feature__attachments--list",attachmentsPreview:"esri-feature__attachments--preview",attachmentsTitle:"esri-feature__attachments-title",attachmentsItems:"esri-feature__attachments-items",attachmentsItem:"esri-feature__attachments-item",attachmentsItemMask:"esri-feature__attachment-item-mask",attachmentsItemMaskIcon:"esri-feature__attachment-item-mask--icon",attachmentsItemImage:"esri-feature__attachments-image",attachmentsItemImageOverlay:"esri-feature__attachments-image-overlay",attachmentsItemLinkIcon:"esri-feature__attachments-link-icon esri-icon-link-external",attachmentsItemImageResizable:"esri-feature__attachments-image--resizable",attachmentsItemFilename:"esri-feature__attachments-filename",attachmentsItemLink:"esri-feature__attachments-item-link",fields:"esri-feature__fields",fieldHeader:"esri-feature__field-header",fieldData:"esri-feature__field-data",fieldDataDate:"esri-feature__field-data--date",media:"esri-feature__media",mediaContainer:"esri-feature__media-container",mediaItemContainer:"esri-feature__media-item-container",mediaItem:"esri-feature__media-item",mediaItemTitle:"esri-feature__media-item-title",mediaItemCaption:"esri-feature__media-item-caption",mediaPrevious:"esri-feature__media-previous",mediaPreviousIconLTR:"esri-feature__media-previous-icon",mediaPreviousIconRTL:"esri-feature__media-previous-icon--rtl",mediaNext:"esri-feature__media-next",mediaNextIconLTR:"esri-feature__media-next-icon",mediaNextIconRTL:"esri-feature__media-next-icon--rtl",mediaSummary:"esri-feature__media-summary",mediaCount:"esri-feature__media-count",mediaImageSummary:"esri-feature__media-image-summary",mediaImageIcon:"esri-feature__media-image-icon",mediaChart:"esri-feature__media-chart",mediaChartSummary:"esri-feature__media-chart-summary",mediaChartIcon:"esri-feature__media-chart-icon",loadingSpinnerContainer:"esri-feature__loading-container",spinner:"esri-feature__loading-spinner"},v="esri-feature";return function(t){function l(e){var a=t.call(this)||this;return a._chartMap=new Map,a._activeMediaMap=new Map,a._chartRequirePromise=null,a._refreshTimers=new Map,a._mediaInfo=new Map,a.contentEnabled=null,a.graphic=null,a.title=null,a.view=null,a.viewModel=new m,a}return a(l,t),l.prototype.postInitialize=function(){var e=this;this.own(d.init(this,"viewModel.content",function(){return e._setupMediaRefreshTimers()}))},l.prototype.destroy=function(){this._clearMediaRefreshTimers(),this._activeMediaMap.clear(),this._activeMediaMap=null,this._cancelChartModules(),this._destroyCharts()},l.prototype.render=function(){var e=p.tsx("div",{key:f("loading-container"),class:_.loadingSpinnerContainer},p.tsx("span",{class:this.classes(_.iconLoading,_.spinner)})),t=this.viewModel.waitingForContent,a=t?e:[this._renderContent(),this._renderLastEditInfo()];return p.tsx("div",{class:this.classes(_.base,_.esriWidget)},p.tsx("div",{class:_.container},p.tsx("div",{class:_.main},a)))},l.prototype.goToMedia=function(e,t){this._setContentElementMedia(e,t)},l.prototype.nextMedia=function(e){this._pageContentElementMedia(e,"next")},l.prototype.previousMedia=function(e){this._pageContentElementMedia(e,"previous")},l.prototype._cancelChartModules=function(){var e=this._chartRequirePromise;e&&e.cancel(),this._chartRequirePromise=null},l.prototype._destroyChart=function(e){var t=this._chartMap.get(e);t&&(t.chart.destroy(),t.tooltip.destroy()),this._chartMap.delete(e)},l.prototype._destroyCharts=function(){this._chartMap.forEach(function(e){e.chart.destroy(),e.tooltip.destroy()}),this._chartMap.clear()},l.prototype._renderContent=function(){this._destroyCharts();var e=this.viewModel.content;return"string"==typeof e?p.tsx("div",{key:f("content-string"),innerHTML:e}):p.isWidget(e)?p.tsx("div",{key:f("content-widget")},e.render()):e instanceof HTMLElement?p.tsx("div",{key:f("content-html-element"),bind:e,afterCreate:this._attachToNode}):p.isWidgetBase(e)?p.tsx("div",{key:f("content-dijit"),bind:e.domNode,afterCreate:this._attachToNode}):Array.isArray(e)?e.length?p.tsx("div",{key:f("content-content-elements")},e.map(this._renderContentElement,this)):null:void 0},l.prototype._renderContentElement=function(e,t){switch(e.type){case"attachments":return this._renderAttachments(e,t);case"fields":return this._renderFields(e,t);case"media":return this._renderMedia(e,t);case"text":return this._renderText(e,t);default:return null}},l.prototype._renderAttachmentInfo=function(e){var t,a,i=e.attachmentInfo,n=e.supportsResizeAttachments,s=i.contentType,o=i.name,d=i.url,c=n&&h.isSupportedImage(s),l=-1===d.indexOf("?")?"?":"&",m=c?""+d+l+"w=48":h.getIconPath(s),u=(t={},t[_.attachmentsItemMaskIcon]=!c,t),f=(a={},a[_.attachmentsItemImageResizable]=n,a);return p.tsx("li",{class:_.attachmentsItem,key:i},p.tsx("a",{class:_.attachmentsItemLink,href:d,target:"_blank"},p.tsx("div",{class:this.classes(u,_.attachmentsItemMask)},p.tsx("img",{alt:"",class:this.classes(f,_.attachmentsItemImage),src:m}),p.tsx("span",{class:_.attachmentsItemImageOverlay},p.tsx("span",{"aria-hidden":"true",class:_.attachmentsItemLinkIcon}))),p.tsx("span",{class:_.attachmentsItemFilename},o||r.noTitle)))},l.prototype._renderAttachments=function(e,t){var a,i=this,n=e.displayType,s=e.attachmentInfos,o=s&&s.length,d=this.get("graphic.layer.capabilities.operations.supportsResizeAttachments"),c=(a={},a[_.attachmentsList]="preview"!==n,a[_.attachmentsPreview]="preview"===n,a);return o?p.tsx("div",{key:f("attachments-element"),class:this.classes(_.attachments,_.contentElement,c)},p.tsx("div",{class:_.attachmentsTitle},r.attach),p.tsx("ul",{class:_.attachmentsItems},s.map(function(t,a){return i._renderAttachmentInfo({attachmentInfo:t,attachmentInfoIndex:a,supportsResizeAttachments:d,contentElement:e})}))):null},l.prototype._forceLTR=function(e){return"&lrm;"+e},l.prototype._renderFieldInfo=function(e,t){var a,i=this.viewModel,r=i.formattedAttributes,n=r?r.content[t]||r.global:null,s=e.fieldName,o=e.label||s,d=n?null==n[s]?"":n[s]:"",c=!(!e.format||!e.format.dateFormat),l="number"==typeof d&&!c,m=l?this._forceLTR(d):u.autoLink(d),h=(a={},a[_.fieldDataDate]=c,a);return p.tsx("tr",{key:f("fields-element-info-row",t)},p.tsx("th",{key:f("fields-element-info-row-header",t),class:_.fieldHeader,innerHTML:o}),p.tsx("td",{key:f("fields-element-info-row-data",t),class:this.classes(_.fieldData,h),innerHTML:m}))},l.prototype._renderFields=function(e,t){var a=this,i=e.fieldInfos;return i?p.tsx("div",{key:f("fields-element",t),class:this.classes(_.fields,_.contentElement)},p.tsx("table",{class:_.esriTable,summary:r.fieldsSummary,key:f("fields-element-table",t)},p.tsx("tbody",{key:f("fields-element-table-body",t)},i.map(function(e){return a._renderFieldInfo(e,t)})))):null},l.prototype._shouldOpenInNewTab=function(e){if(void 0===e&&(e=""),e){return!/^(?:mailto:|tel:)/.test(e.trim().toLowerCase())}},l.prototype._clearMediaRefreshTimers=function(){this._refreshTimers.forEach(function(e){return clearTimeout(e)}),this._refreshTimers.clear()},l.prototype._clearMediaRefreshTimer=function(e){var t=this._refreshTimers.get(e);t&&(clearTimeout(t),this._refreshTimers.delete(e))},l.prototype._getImageSource=function(e,t){var a=-1!==e.indexOf("?")?"&":"?",i=e.split("#"),r=i[0],n=i[1],s=void 0===n?"":n;return""+r+a+"timestamp="+t+(s?"#":"")+s},l.prototype._setupMediaRefreshTimer=function(e){var t=this.get("viewModel.content");if(Array.isArray(t)){var a=t[e];if(a&&"media"===a.type){var i=this._activeMediaMap.get(e);isNaN(i)&&(i=0);var r=a.mediaInfos[i];r&&"image"===r.type&&r.refreshInterval&&this._setRefreshTimeout(e,r)}}},l.prototype._setupMediaRefreshTimers=function(){var e=this;this._clearMediaRefreshTimers();var t=this.get("viewModel.content");Array.isArray(t)&&t.forEach(function(t,a){return e._setupMediaRefreshTimer(a)})},l.prototype._updateMediaInfoTimestamp=function(e,t){var a=Date.now();this._mediaInfo.set(t,{timestamp:a,sourceURL:this._getImageSource(e,a)}),this.scheduleRender()},l.prototype._setRefreshTimeout=function(e,t){var a=this,i=t.refreshInterval,r=t.value;if(i){var n=6e4*i;this._updateMediaInfoTimestamp(r.sourceURL,e);var s=setInterval(function(){a._updateMediaInfoTimestamp(r.sourceURL,e)},n);this._refreshTimers.set(e,s)}},l.prototype._renderMediaInfoType=function(e,t){var a=e.title,i=void 0===a?"":a;if("image"===e.type){var r=e,n=r.value,s=r.refreshInterval,o=n.sourceURL,d=n.linkURL,c=this._shouldOpenInNewTab(d),l=c?"_blank":"_self",m=s?this._mediaInfo.get(t):null,h=m?m.timestamp:0,u=m?m.sourceURL:o,v=p.tsx("img",{alt:i,key:f("media-image-"+h,t),src:u}),y=d?p.tsx("a",{title:i,href:d,target:l},v):null;return y||v}if(-1!==e.type.indexOf("chart"))return p.tsx("div",{key:f("chart",t),bind:this,"data-media-info":e,"data-content-element-index":t,class:_.mediaChart,afterCreate:this._getChartDependencies,afterUpdate:this._getChartDependencies})},l.prototype._getChartDependencies=function(t){var a=this,i=t["data-media-info"],r=t["data-content-element-index"],n=i.value,s=n.theme||"Claro",d=i.type,c=s;"string"==typeof s&&(c=s.replace(/\./g,"/")),this._cancelChartModules(),this._chartRequirePromise=o.create(function(t){return e(["dojox/charting/Chart2D","dojox/charting/action2d/Tooltip","dojox/charting/themes/"+c],function(){for(var e=[],a=0;a<arguments.length;a++)e[a]=arguments[a];return t(e)})}).then(function(e){var i=e[0],s=e[1],o=e[2];a._renderChart(t,r,d,n,i,s,o),a._chartRequirePromise=null})},l.prototype._renderChart=function(e,t,a,i,r,n,s){var o=new r(e,{margins:{l:4,t:4,r:4,b:4}});switch(s&&o.setTheme(s),a){case"pie-chart":o.addPlot("default",{type:"Pie",labels:!1}),o.addSeries("Series A",i.series);break;case"line-chart":o.addPlot("default",{type:"Markers"}),o.addAxis("x",{min:0,majorTicks:!1,minorTicks:!1,majorLabels:!1,minorLabels:!1}),o.addAxis("y",{includeZero:!0,vertical:!0,fixUpper:"minor"}),i.series.forEach(function(e,t){e.x=t+1}),o.addSeries("Series A",i.series);break;case"column-chart":o.addPlot("default",{type:"Columns",gap:3}),o.addAxis("y",{includeZero:!0,vertical:!0,fixUpper:"minor"}),o.addSeries("Series A",i.series);break;case"bar-chart":o.addPlot("default",{type:"Bars",gap:3}),o.addAxis("x",{includeZero:!0,fixUpper:"minor",minorLabels:!1}),o.addAxis("y",{vertical:!0,majorTicks:!1,minorTicks:!1,majorLabels:!1,minorLabels:!1}),o.addSeries("Series A",i.series)}var d=new n(o);o.render(),this._chartMap.set(t,{chart:o,tooltip:d})},l.prototype._renderMediaInfo=function(e,t){this._destroyChart(t);var a=this._renderMediaInfoType(e,t),i=e.title?p.tsx("div",{key:f("media-title",t),class:_.mediaItemTitle,innerHTML:e.title}):null,r=e.caption?p.tsx("div",{key:f("media-caption",t),class:_.mediaItemCaption,innerHTML:e.caption}):null;return p.tsx("div",{key:f("media-container",t),class:_.mediaItemContainer},p.tsx("div",{key:f("media-item-container",t),class:_.mediaItem},a),i,r)},l.prototype._renderMediaStatsItem=function(e,t,a){var i="chart"===a?this.classes(_.mediaChartIcon,_.iconChart):this.classes(_.mediaImageIcon,_.iconMedia);return p.tsx("li",{class:_.mediaImageSummary},p.tsx("span",{"aria-hidden":"true",class:i}),p.tsx("span",{class:_.mediaCount,"aria-label":e},"("+t+")"))},l.prototype._renderMediaPageButton=function(e,t){var a="previous"===e,i=a?r.previous:r.next,n=a?this.classes(_.btn,_.mediaPrevious):this.classes(_.btn,_.mediaNext),s=a?this.classes(_.icon,_.mediaPreviousIconLTR,_.iconLeftTriangleArrow):this.classes(_.icon,_.mediaNextIconLTR,_.iconRightTriangleArrow),o=a?this.classes(_.icon,_.mediaPreviousIconRTL,_.iconRightTriangleArrow):this.classes(_.icon,_.mediaNextIconRTL,_.iconLeftTriangleArrow),d=a?"previous":"next",c=a?this._previousClick:this._nextClick;return p.tsx("div",{key:f(d,t),title:i,tabIndex:0,role:"button",class:n,"data-content-element-index":t,bind:this,onkeydown:c,onclick:c},p.tsx("span",{"aria-hidden":"true",class:s}),p.tsx("span",{"aria-hidden":"true",class:o}),p.tsx("span",{class:_.iconText},i))},l.prototype._handleMediaKeyup=function(e){var t=e.currentTarget,a=t["data-content-element-index"],i=e.keyCode;i===n.LEFT_ARROW&&(e.stopPropagation(),this.previousMedia(a)),i===n.RIGHT_ARROW&&(e.stopPropagation(),this.nextMedia(a))},l.prototype._renderMedia=function(e,t){var a,i=e.mediaInfos,n=this._getMediaStats(i),s=n.total,o=(a={},a[_.showMediaPagination]=n.total>1,a),d=this._renderMediaStatsItem(r.numImages,n.images,"image"),c=this._renderMediaStatsItem(r.numCharts,n.charts,"chart"),l=this._renderMediaPageButton("previous",t),m=this._renderMediaPageButton("next",t),h=this._activeMediaMap.get(t);return isNaN(h)&&(this._activeMediaMap.set(t,0),h=0),s?p.tsx("div",{key:f("media-element",t),"data-content-element-index":t,bind:this,onkeyup:this._handleMediaKeyup,class:this.classes(_.media,_.contentElement,o)},p.tsx("ul",{class:_.mediaSummary},d,c),p.tsx("div",{key:f("media-element-container",t),class:_.mediaContainer},l,this._renderMediaInfo(i[h],t),m)):null},l.prototype._renderLastEditInfo=function(){var e=this.viewModel.lastEditInfo;if(!e)return null;var t=e.date,a=e.user,i="edit"===e.type?a?r.lastEditedByUser:r.lastEdited:a?r.lastCreatedByUser:r.lastCreated,n=s.substitute({date:t,user:a},i);return p.tsx("div",{key:f("edit-info-element"),class:this.classes(_.lastEditedInfo,_.contentElement)},n)},l.prototype._renderText=function(e,t){return e.text?p.tsx("div",{key:f("text-element",t),innerHTML:e.text,class:this.classes(_.text,_.contentElement)}):null},l.prototype._attachToNode=function(e){var t=this;e.appendChild(t)},l.prototype._getMediaStats=function(e){var t=0,a=0;return e.forEach(function(e){var i=e.type;"image"===i?t++:-1!==i.indexOf("chart")&&a++}),{total:a+t,images:t,charts:a}},l.prototype._setContentElementMedia=function(e,t){this._clearMediaRefreshTimer(e);var a=this.viewModel.content,i=a&&a[e],r=i&&i.mediaInfos;if(r&&r.length){var n=(t+r.length)%r.length;this._activeMediaMap.set(e,n),this._setupMediaRefreshTimer(e),this.scheduleRender()}},l.prototype._pageContentElementMedia=function(e,t){var a="previous"===t?-1:1,i=this._activeMediaMap.get(e)+a;this._setContentElementMedia(e,i)},l.prototype._previousClick=function(e){var t=e.currentTarget,a=t["data-content-element-index"];this.previousMedia(a)},l.prototype._nextClick=function(e){var t=e.currentTarget,a=t["data-content-element-index"];this.nextMedia(a)},i([c.aliasOf("viewModel.contentEnabled")],l.prototype,"contentEnabled",void 0),i([c.aliasOf("viewModel.graphic")],l.prototype,"graphic",void 0),i([c.aliasOf("viewModel.title")],l.prototype,"title",void 0),i([c.aliasOf("viewModel.view")],l.prototype,"view",void 0),i([c.property({type:m}),p.renderable(["viewModel.waitingForContent","viewModel.content","viewModel.lastEditInfo"])],l.prototype,"viewModel",void 0),i([p.accessibleHandler()],l.prototype,"_previousClick",null),i([p.accessibleHandler()],l.prototype,"_nextClick",null),l=i([c.subclass("esri.widgets.Feature")],l)}(c.declared(l))});