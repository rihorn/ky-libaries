// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.10/esri/copyright.txt for details.

define(["require","exports","../../core/tsSupport/assignHelper","../../core/tsSupport/declareExtendsHelper","../../core/tsSupport/decorateHelper","../../geometry","../../Graphic","../../core/Accessor","../../core/Collection","../../core/Error","../../core/Evented","../../core/Handles","../../core/Logger","../../core/watchUtils","../../core/accessorSupport/decorators","../../geometry/support/coordsUtils","../../geometry/support/graphicsUtils","../../layers/GraphicsLayer","../../symbols/SimpleFillSymbol","../../symbols/SimpleLineSymbol","../../symbols/SimpleMarkerSymbol","../../views/2d/draw/Draw","../../views/2d/draw/support/Box","../../views/2d/draw/support/GraphicMover","../../views/2d/draw/support/Reshape","./support/OperationHandle","./support/sketchUtils"],function(e,t,r,o,i,n,a,c,p,s,l,h,d,v,u,y,m,_,f,g,w,G,E,b,x,S,C){var U=d.getLogger("esri.widgets.Sketch.SketchViewModel"),k={redoKey:"r",undoKey:"z",centerKey:"Alt",constraintKey:"Control",snappingKey:"Shift",cancelKey:"Escape"};return function(e){function t(t){var r=e.call(this,t)||this;return r._activeFillGraphic=null,r._activeLineGraphic=null,r._centerIndicatorGraphic=null,r._centerSymbol=new w({style:"cross",size:6,color:[255,255,255]}),r._defaultSegmentOffset=48,r._defaultUpdateTool="transform",r._draw=null,r._handles=new h,r._layer=new _({listMode:"hide"}),r._lineGraphic=null,r._operationHandle=null,r._vertexGraphics=[],r._viewHandles=new h,r.activeFillSymbol=new f({style:"solid",color:[150,150,150,.2],outline:{color:[0,0,0,0]}}),r.activeLineSymbol=new g({color:[12,207,255,1],width:2,style:"dash"}),r.activePointSymbol=new w({style:"circle",size:6,color:[12,207,255],outline:{color:[50,50,50],width:1}}),r.createGraphic=null,r.defaultUpdateOptions={tool:"transform",graphics:[],enableRotation:!0,enableScaling:!0,preserveAspectRatio:!1,toggleToolOnClick:!0},r.hoverVertexSymbol=new w({style:"circle",size:8,color:[33,205,255],outline:{color:[0,12,255],width:1}}),r.layer=null,r.pointSymbol=new w({style:"circle",size:6,color:[255,255,255],outline:{color:[50,50,50],width:1}}),r.polygonSymbol=new f({color:[150,150,150,.2],outline:{color:[50,50,50],width:2}}),r.polylineSymbol=new g({color:[130,130,130,1],width:2}),r.selectedVertexSymbol=new w({style:"circle",size:8,color:[255,255,255],outline:{color:[0,12,255],width:1}}),r.updateGraphics=new p,r.updateOnGraphicClick=!0,r.updatePointSymbol=new w({size:10,color:[0,200,255,.5],outline:{color:"black",width:1}}),r.updatePolygonSymbol=new f({color:[12,207,255,.2],outline:{join:"round",color:[12,207,255],width:2}}),r.updatePolylineSymbol=new g({color:[12,207,255],width:2}),r.vertexSymbol=new w({style:"circle",size:6,color:[33,205,255],outline:{color:[0,12,255],width:1}}),r}return o(t,e),t.prototype.initialize=function(){var e=this;this.view&&this.view.ready&&(this._setUpViewReadyHandle(),this._draw=new G({view:this.view})),this._handles.add([v.pausable(this,"view.ready",function(t){e.reset(),t?(e._setUpViewReadyHandle(),e._draw=new G({view:e.view})):(e._viewHandles.removeAll(),e._draw&&e._draw.destroy(),e._draw=null)}),v.pausable(this,"layer",function(){return e._reset()})])},t.prototype.destroy=function(){this._reset(),this._handles.removeAll(),this._handles=null,this._viewHandles.removeAll(),this._viewHandles=null,this._removeDefaultLayer(),this._draw&&(this._draw.destroy(),this._draw=null),this._set("view",null),this.emit("destroy")},Object.defineProperty(t.prototype,"activeTool",{get:function(){return this._operationHandle&&this._operationHandle.tool?this._operationHandle.tool:null},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"state",{get:function(){var e=!(!this.get("view.ready")||!this.layer),t=this._operationHandle;return e&&t?"active":e?"ready":"disabled"},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"view",{get:function(){return this._get("view")},set:function(e){if(e&&"2d"!==e.type)return void this._logError("sketch:sceneview","Property 'view' must be of type 'MapView' on SketchViewModel.");this._set("view",e)},enumerable:!0,configurable:!0}),t.prototype.cancel=function(){this._operationHandle&&this._operationHandle.cancel()},t.prototype.complete=function(){this._operationHandle&&this._operationHandle.complete()},t.prototype.create=function(e,t){var r=this;if("disabled"===this.state)return this.layer||this._logError("sketch:missing-layer","Property 'layer' is missing on SketchViewModel."),void(this.view||this._logError("sketch:missing-view","Property 'view' is missing on SketchViewModel."));this._reset();var o,i;if("string"==typeof e?(o=e,i=t):(o=e.tool,i=e),!o)return void this._logError("sketch:missing-tool","Missing parameter 'tool'.");var n=this._setupCreateOperation(o,i);if(n){this.view.map.add(this._layer);var a=function(){if(n===r._operationHandle){var e=n.cancelled?"cancel":"complete",t=r.createGraphic;r._operationHandle.destroy(),r._operationHandle=null,r._set("createGraphic",null),r.view.map&&r.view.map.remove(r._layer),n.cancelled||r.layer.add(t),r._emitCreateEvent({graphic:t,state:e,tool:o,toolEventInfo:null})}};n.on("complete",a),n.on("cancel",a),this._operationHandle=n}},t.prototype.reset=function(){this._reset(),this._emitResetEvent()},t.prototype.update=function(e,t){var o=this;if(!e)return void this._logError("sketch:missing-graphics","Missing parameter 'graphics'.");if("disabled"===this.state)return this.layer||this._logError("sketch:missing-layer","Property 'layer' is missing on SketchViewModel."),void(this.view||this._logError("sketch:missing-view","Property 'view' is missing on SketchViewModel."));this._reset();var i,n;if(Array.isArray(e)?(i=e,n=t):(i=e.graphics,n=e),!i||!i.length)return void this._logError("sketch:missing-graphics","Missing parameter 'graphics'.");if(!i.some(function(e){return e.layer!==o.layer?(o._logError("sketch:graphic-layer","Parameter 'graphics' contains one or more graphics missing from the supplied GraphicsLayer."),!0):e.geometry?void 0:(o._logError("sketch:geometry-invalid-type","Parameter 'graphics' contains one or more Graphics with an unsupported Geometry type."),!0)})){var a=this._setupUpdateOperation(i,r({},this.defaultUpdateOptions,n));if(a){this.view.map.add(this._layer),this._emitUpdateEvent({graphics:i,state:"start",tool:a.tool,toolEventInfo:null});var c=function(){if(a===o._operationHandle){var e=a.cancelled?"cancel":"complete",t=o.updateGraphics.toArray(),r=o._operationHandle.tool;o._operationHandle.destroy(),o._operationHandle=null,o._layer.removeMany(o.updateGraphics.toArray()),o.updateGraphics.removeAll(),o.view.map&&o.view.map.remove(o._layer),o._emitUpdateEvent({graphics:t,state:e,tool:r,toolEventInfo:null})}};a.on("complete",c),a.on("cancel",c),this._operationHandle=a}}},t.prototype.undo=function(){this.canUndo()&&this._operationHandle.undo()},t.prototype.redo=function(){this.canRedo()&&this._operationHandle.redo()},t.prototype.canUndo=function(){return!(!this._operationHandle||!this._operationHandle.canUndo())},t.prototype.canRedo=function(){return!(!this._operationHandle||!this._operationHandle.canRedo())},t.prototype.toggleUpdateTool=function(){this._operationHandle&&this._operationHandle.toggleTool&&this._operationHandle.toggleTool()},t.prototype._reset=function(){this._removeCreateOperationGraphics(),this.cancel(),this._displayDefaultCursor(),this._draw&&this._draw.reset()},t.prototype._setUpViewReadyHandle=function(){var e=this;this._viewHandles.add([this.view.on("click",function(t){"disabled"!==e.state&&e.updateOnGraphicClick&&e.view.hitTest(t).then(function(t){var o=t.results;o.length?o.some(function(t){if(t.graphic){var o=t.graphic;if(e.updateGraphics.indexOf(o)>-1)return!0;if(o.layer===e.layer)return e.update([o],r({},e.defaultUpdateOptions)),!0}}):"active"===e.state&&e._reset()})})])},t.prototype._setupCreateOperation=function(e,t){if(e){var r;switch(e){case"point":r=this._setupCreatePointOperation(e,t);break;case"multipoint":r=this._setupCreateMultipointOperation(e,t);break;case"polygon":case"polyline":r=this._setupCreatePolyOperation(e,t);break;case"rectangle":r=this._setupCreateRectangleOperation(e,t);break;case"circle":r=this._setupCreateCircleOperation(e,t)}return r}},t.prototype._setupCreatePointOperation=function(e,t){var r=this,o=this._draw.create(e,t),i=[o.on("cursor-update",function(e){return r._displayCrosshairCursor()}),o.on("draw-complete",function(e){var t=e.coordinates,o=t[0],i=t[1],c=new n.Point(o,i,r.view.spatialReference),s=new a(c,r.pointSymbol);r._set("createGraphic",s),p&&p.complete()})],c=[this.view.on("key-down",function(e){e.key===k.cancelKey&&p&&p.cancel()})],p=new S({activeComponent:this._draw,tool:e,type:"create",onEnd:function(){i.forEach(function(e){return e.remove()}),c.forEach(function(e){return e.remove()}),i=[],c=[],r._layer&&r._layer.remove(r.createGraphic),r._displayDefaultCursor()}});return p},t.prototype._setupCreateMultipointOperation=function(e,t){var r=this,o=this._draw.create(e,t),i=null,n=new S({activeComponent:this._draw,tool:e,type:"create",onEnd:function(){a.forEach(function(e){return e.remove()}),c.forEach(function(e){return e.remove()}),a=[],c=[],r._removeCreateOperationGraphics(),r._layer&&r._layer.remove(r.createGraphic),r._displayDefaultCursor()},undo:function(){n.canUndo()&&(o.undo(),r._emitUndoEvent({graphics:[r.createGraphic],tool:e}))},redo:function(){n.canRedo()&&(o.redo(),r._emitRedoEvent({graphics:[r.createGraphic],tool:e}))},canUndo:function(){return o&&o.canUndo()},canRedo:function(){return o&&o.canRedo()}}),a=[o.on("vertex-add",function(t){var o=t.type,n=t.vertexIndex,a=t.vertices,c=a[n];i=t,r._drawMultipointGraphic(a,!0),r._emitCreateEvent({graphic:r.createGraphic,state:1===a.length?"start":"active",tool:e,toolEventInfo:{added:c,type:o}})}),o.on("vertex-remove",function(t){var o=t.type,n=t.vertexIndex,a=t.vertices,c=a[n];i=t,r._drawMultipointGraphic(a,!0),r._emitCreateEvent({graphic:r.createGraphic,state:"active",tool:e,toolEventInfo:{removed:c,type:o}})}),o.on("vertex-update",function(t){var o=t.type,n=t.vertexIndex,a=t.vertices,c=a[n];i=t,r._drawMultipointGraphic(a,!0),r._emitCreateEvent({graphic:r.createGraphic,state:"active",tool:e,toolEventInfo:{type:o,updated:c}})}),o.on("cursor-update",function(e){i=e}),o.on("draw-complete",function(e){var t=e.vertices.slice(0),o=C.createMultipoint(t,r.view);o?(r.createGraphic&&(r.createGraphic.geometry=o),n&&n.complete()):n&&n.cancel()}),o.on("undo",function(e){var t=e.vertices,o=i&&"cursor-update"!==i.type;r._resetCreateOperationGraphics(),t.length&&r._drawMultipointGraphic(t,o)}),o.on("redo",function(e){var t=e.vertices,o=i&&"cursor-update"!==i.type;r._resetCreateOperationGraphics(),t.length&&r._drawMultipointGraphic(t,o)})],c=[this.view.on("pointer-move",function(e){return r._displayCrosshairCursor()}),this.view.on("key-down",function(e){return r._getCommonUpdateOperationKeyDownHandlers(n,e)})];return n},t.prototype._setupCreatePolyOperation=function(e,t){var r=this,o=null;"polyline"===e?o=this._draw.create(e,t):"polygon"===e&&(o=this._draw.create(e,t));var i=new n.Point,a=null,c=!1,p=[o.on("vertex-add",function(t){var o=t.type,i=t.vertexIndex,n=t.vertices,p=n[i];c&&r._snapLastVertexToAxis(n),a=t,r._drawVertexGraphics(e,n,{userClicked:!0}),r._emitCreateEvent({graphic:r.createGraphic,state:1===n.length?"start":"active",tool:e,toolEventInfo:{added:p,type:o}})}),o.on("vertex-remove",function(t){var o=t.type,i=t.vertexIndex,n=t.vertices,p=n[i];c&&r._snapLastVertexToAxis(n),a=t,r._drawVertexGraphics(e,n,{userClicked:!0}),r._emitCreateEvent({graphic:r.createGraphic,state:"active",tool:e,toolEventInfo:{removed:p,type:o}})}),o.on("vertex-update",function(t){var o=t.type,i=t.vertexIndex,n=t.vertices,p=n[i];c&&r._snapLastVertexToAxis(n),a=t,r._drawVertexGraphics(e,n,{userClicked:!0}),r._emitCreateEvent({graphic:r.createGraphic,state:"active",tool:e,toolEventInfo:{type:o,updated:p}})}),o.on("cursor-update",function(t){var o=t.type,n=t.vertices,p=t.native;if(r.view.toMap(p.x,p.y,i),c&&r._snapLastVertexToAxis(n),a=t,r._drawVertexGraphics(e,n,{userClicked:!1}),n.length>1){var s=n[n.length-1];r._emitCreateEvent({graphic:r.createGraphic,state:"active",tool:e,toolEventInfo:{coordinates:s,type:o}})}}),o.on("draw-complete",function(t){var o=t.vertices.slice(0),i=null;"polyline"===e?i=C.createPolyline([o],r.view):"polygon"===e&&(i=C.createPolygon([o],r.view)),i?(r.createGraphic.geometry=i,l&&l.complete()):l&&l.cancel()}),o.on("undo",function(t){var o=t.vertices,i=a&&"cursor-update"!==a.type;r._resetCreateOperationGraphics(),o.length&&(c&&r._snapLastVertexToAxis(o),r._drawVertexGraphics(e,o,{userClicked:i}))}),o.on("redo",function(t){var o=t.vertices,i=a&&"cursor-update"!==a.type;r._resetCreateOperationGraphics(),o.length&&(c&&r._snapLastVertexToAxis(o),r._drawVertexGraphics(e,o,{userClicked:i}))})],s=[this.view.on("pointer-move",function(e){return r._displayCrosshairCursor()}),this.view.on("key-down",function(t){var i=o.vertices.slice(0),n=a&&"cursor-update"!==a.type;t.key!==k.constraintKey||c?t.key===k.undoKey&&l&&l.canUndo()?(t.stopPropagation(),l.undo()):t.key===k.redoKey&&l&&l.canRedo()?(t.stopPropagation(),l.redo()):t.key===k.cancelKey&&l&&l.cancel():(c=!0,!n&&r._snapLastVertexToAxis(i),r._drawVertexGraphics(e,i,{userClicked:n}))}),this.view.on("key-up",function(t){var n=o.vertices.slice(0),p=a&&"cursor-update"!==a.type;t.key===k.constraintKey&&(p||(n.pop(),n.push([i.x,i.y]),r._drawVertexGraphics(e,n,{userClicked:p})),c=!1)})];"polygon"===e&&s.concat([this.view.on("pointer-down",function(e){r.view.hitTest(e).then(function(t){var o=t.results;if(o.length&&o[0].graphic){var i=o[0].graphic;0===r._vertexGraphics.indexOf(i)&&e.stopPropagation()}})}),this.view.on("click",function(e){r.view.hitTest(e).then(function(t){var i=t.results;if(i.length&&i[0].graphic){var n=i[0].graphic;0===r._vertexGraphics.indexOf(n)&&r._vertexGraphics.length>2&&(e.stopPropagation(),a&&"cursor-update"===a.type&&o.vertices.pop(),o.complete())}})})]);var l=new S({activeComponent:this._draw,tool:e,type:"create",onEnd:function(){p.forEach(function(e){return e.remove()}),s.forEach(function(e){return e.remove()}),p=[],s=[],r._removeCreateOperationGraphics(),r._layer&&r._layer.remove(r.createGraphic),r._displayDefaultCursor()},undo:function(){l.canUndo()&&(o.undo(),r._emitUndoEvent({graphics:[r.createGraphic],tool:e}))},redo:function(){l.canRedo()&&(o.redo(),r._emitRedoEvent({graphics:[r.createGraphic],tool:e}))},canUndo:function(){return o&&o.canUndo()},canRedo:function(){return o&&o.canRedo()}});return l},t.prototype._setupCreateCircleOperation=function(e,t){var r=this,o=this._draw.create(e,t),i=!1,n=!0,c=[o.on("vertex-add",function(t){var o=t.type,a=t.vertexIndex,c=t.vertices,p=c[a];r._drawSegmentGraphic(e,c,{centered:n,constrained:i}),r._emitCreateEvent({graphic:r.createGraphic,state:1===c.length?"start":"active",tool:e,toolEventInfo:{added:p,type:o}})}),o.on("cursor-update",function(t){var o=t.type,a=t.vertices;if(r._drawSegmentGraphic(e,a,{centered:n,constrained:i}),2===a.length){var c=a[a.length-1];r._emitCreateEvent({graphic:r.createGraphic,state:"active",tool:e,toolEventInfo:{coordinates:c,type:o}})}}),o.on("draw-complete",function(e){var t=e.vertices.slice(0),o=null;if(1===t.length){var c=t[0],p=c[0],l=c[1];t.push([p+r._defaultSegmentOffset*r.view.resolution,l]),o=C.createCircle(t,r.view,!0)}else o=i?C.createEllipse(t,r.view,n):C.createCircle(t,r.view,n);r.createGraphic?r.createGraphic.geometry=o:(r._removeCreateGraphic(),r._set("createGraphic",new a(o,r.polygonSymbol))),s&&s.complete()})],p=[this.view.on("pointer-move",function(e){return r._displayCrosshairCursor()}),this.view.on("key-down",function(t){t.key!==k.constraintKey||i?t.key===k.centerKey&&n?(n=!1,r._drawSegmentGraphic(e,o.vertices,{centered:n,constrained:i})):t.key===k.cancelKey&&s&&s.cancel():(i=!0,r._drawSegmentGraphic(e,o.vertices,{centered:n,constrained:i}))}),this.view.on("key-up",function(t){t.key===k.constraintKey?(i=!1,r._drawSegmentGraphic(e,o.vertices,{centered:n,constrained:i})):t.key===k.centerKey&&(n=!0,r._drawSegmentGraphic(e,o.vertices,{centered:n,constrained:i}))})],s=new S({activeComponent:this._draw,tool:e,type:"create",onEnd:function(){c.forEach(function(e){return e.remove()}),p.forEach(function(e){return e.remove()}),c=[],p=[],r._removeCenterIndicatorGraphic(),r._layer&&r._layer.remove(r.createGraphic),r._displayDefaultCursor()},undo:function(){s.canUndo()&&(o.undo(),r._emitUndoEvent({graphics:[r.createGraphic],tool:e}))},redo:function(){s.canRedo()&&(o.redo(),r._emitRedoEvent({graphics:[r.createGraphic],tool:e}))},canUndo:function(){return o&&o.canUndo()},canRedo:function(){return o&&o.canRedo()}});return s},t.prototype._setupCreateRectangleOperation=function(e,t){var r=this,o=this._draw.create(e,t),i=!1,n=!1,c=[o.on("vertex-add",function(t){var o=t.type,a=t.vertexIndex,c=t.vertices,p=c[a];r._drawSegmentGraphic(e,c,{centered:n,constrained:i}),r._emitCreateEvent({graphic:r.createGraphic,state:1===c.length?"start":"active",tool:e,toolEventInfo:{added:p,type:o}})}),o.on("cursor-update",function(t){var o=t.type,a=t.vertices;if(r._drawSegmentGraphic(e,a,{centered:n,constrained:i}),2===a.length){var c=a[a.length-1];r._emitCreateEvent({graphic:r.createGraphic,state:"active",tool:e,toolEventInfo:{coordinates:c,type:o}})}}),o.on("draw-complete",function(e){var t=e.vertices.slice(0),o=null;if(1===t.length){var c=t[0],p=c[0],l=c[1];i=!1;var h=r.view.state.transform,d=r.view.state.inverseTransform,v=r._defaultSegmentOffset,u=h[0]*p+h[2]*l+h[4],y=h[1]*p+h[3]*l+h[5],m=d[0]*(u-v)+d[2]*(y+v)+d[4],_=d[1]*(u+v)+d[3]*(y-v)+d[5],f=d[0]*(u+v)+d[2]*(y-v)+d[4],g=d[1]*(u-v)+d[3]*(y+v)+d[5];n=!1,t=[[m,_],[f,g]]}o=i?C.createSquare(t,r.view,n):C.createRectangle(t,r.view,n),r.createGraphic?r.createGraphic.geometry=o:(r._removeCreateGraphic(),r._set("createGraphic",new a(o,r.polygonSymbol))),s&&s.complete()})],p=[this.view.on("pointer-move",function(e){return r._displayCrosshairCursor()}),this.view.on("key-down",function(t){t.key!==k.constraintKey||i?t.key!==k.centerKey||n?t.key===k.cancelKey&&s&&s.cancel():(n=!0,r._drawSegmentGraphic(e,o.vertices,{centered:n,constrained:i})):(i=!0,r._drawSegmentGraphic(e,o.vertices,{centered:n,constrained:i}))}),this.view.on("key-up",function(t){t.key===k.constraintKey?(i=!1,r._drawSegmentGraphic(e,o.vertices,{centered:n,constrained:i})):t.key===k.centerKey&&(n=!1,r._drawSegmentGraphic(e,o.vertices,{centered:n,constrained:i}))})],s=new S({activeComponent:this._draw,tool:e,type:"create",onEnd:function(){c.forEach(function(e){return e.remove()}),p.forEach(function(e){return e.remove()}),c=[],p=[],r._removeCenterIndicatorGraphic(),r._layer&&r._layer.remove(r.createGraphic),r._displayDefaultCursor()},undo:function(){s.canUndo()&&(o.undo(),r._emitUndoEvent({graphics:[r.createGraphic],tool:e}))},redo:function(){s.canRedo()&&(o.redo(),r._emitRedoEvent({graphics:[r.createGraphic],tool:e}))},canUndo:function(){return o&&o.canUndo()},canRedo:function(){return o&&o.canRedo()}});return s},t.prototype._setupUpdateOperation=function(e,t){var r=t.tool||this.defaultUpdateOptions.tool||this._defaultUpdateTool;if(e.length>1&&"reshape"===r)return void this._logError("sketch:reshape-multiple","Reshape operation does not support multiple graphics.");if("move"===r)return this._setupMoveOperation(e,t);if(e.length>1)return this._setupTransformOrReshapeOperation(e,r,t);if(1===e.length){var o=e[0],i=o.geometry.type||null;if("point"===i||"multipoint"===i)return this._setupMoveOperation(e,t);if("transform"===r||"reshape"===r)return this._setupTransformOrReshapeOperation(e,r,t)}return null},t.prototype._setupMoveOperation=function(e,t){var r=this,o=[],i=!1;e.forEach(function(e){o.push(new a(e.geometry,e.symbol,e.attributes)),e.symbol=r._getUpdateSymbol(e.geometry)}),this.updateGraphics.addMany(e);var n=[this.view.on("click",function(e){r.view.hitTest(e).then(function(t){if(p){var o=t.results;if(!o.length)return void(p.canUndo()?p.complete():p.cancel());var i=e.native&&e.native.shiftKey;o.some(function(e){if(e.graphic){var t=e.graphic;if(i&&t.layer===r.layer)return-1===r.updateGraphics.indexOf(t)?p.addToSelection(t):p.removeFromSelection(t),!0;if(r.updateGraphics.indexOf(t)>-1)return!0}})?e.stopPropagation():p.canUndo()?p.complete():p.cancel()}})}),this.view.on("key-down",function(e){return r._getCommonUpdateOperationKeyDownHandlers(p,e)}),this.view.on("key-down",function(e){e.key!==k.constraintKey||i||(i=!0,c.enableMoveAllGraphics=!i)}),this.view.on("key-up",function(e){e.key===k.constraintKey&&(i=!1,c.enableMoveAllGraphics=!i)})],c=this._getGraphicMover(e,t),p=new S({activeComponent:c,tool:"move",type:"update",onEnd:function(){s.forEach(function(e){return e.remove()}),n.forEach(function(e){return e.remove()}),s=[],n=[],c.destroy(),r._layer&&r._layer.removeMany(r.updateGraphics.toArray()),r.updateGraphics.forEach(function(e,t){e.symbol=o[t].symbol})},undo:function(){if(p.canUndo()){var e=p.history.undo.pop(),t=e.updates;p.history.redo.push({updates:m.getGeometries(r.updateGraphics.toArray())}),r.updateGraphics.forEach(function(e,r){e.geometry=t[r]}),r._emitUndoEvent({graphics:r.updateGraphics.toArray(),tool:"move"})}},redo:function(){if(p.canRedo()){var e=p.history.redo.pop(),t=e.updates;p.history.undo.push({updates:m.getGeometries(r.updateGraphics.toArray())}),r.updateGraphics.forEach(function(e,r){e.geometry=t[r]}),r._emitRedoEvent({graphics:r.updateGraphics.toArray(),tool:"move"})}},addToSelection:function(e){o.push(new a(e.geometry,e.symbol,e.attributes)),e.symbol=r._getUpdateSymbol(e.geometry),r.updateGraphics.push(e),c.graphics=r.updateGraphics.toArray(),r._emitUpdateEvent({graphics:r.updateGraphics.toArray(),state:"active",tool:r.activeTool,toolEventInfo:{added:[e],type:"selection-change"}})},removeFromSelection:function(e){var t=r.updateGraphics.indexOf(e),i=o.splice(t,1)[0];if(e.symbol=i.symbol,r.updateGraphics.remove(e),0===r.updateGraphics.length)return p.canUndo()?p.complete():p.cancel(),!0;c.graphics=r.updateGraphics.toArray()}}),s=[c.on("graphic-move-start",function(e){return p.addToHistory({updates:[e.graphic.geometry]})})];return p},t.prototype._setupTransformOrReshapeOperation=function(e,t,r){var o=this,i=r.toggleToolOnClick,n=[],c=!1;e.forEach(function(e){n.push(new a(e.geometry,e.symbol,e.attributes)),e.symbol=o._getUpdateSymbol(e.geometry)}),this.updateGraphics.addMany(e);var p=[this.view.on("click",function(e){o.view.hitTest(e).then(function(t){if(l){var r=t.results;if(!r.length)return void(l.canUndo()?l.complete():l.cancel());var n=l.activeComponent,a=e.native&&e.native.shiftKey;r.some(function(e){if(e.graphic){var t=e.graphic;if(a&&n instanceof E&&!n.isUIGraphic(t))return l.addToSelection(t),!0;if(n instanceof E&&n.isUIGraphic(t))return!1!==i&&1===o.updateGraphics.length&&("extent"===o.updateGraphics.getItemAt(0).geometry.type?o._logError("sketch:extent","The 'reshape' tool does not support Graphics with geometry type of Extent."):l.toggleTool()),!0;if(n instanceof x){if(t===n.graphic)return!1!==i&&l.toggleTool(),!0;if(n.isUIGraphic(t))return!0;if(t.layer===o._layer)return!0}else t.layer===o.layer&&(l.canUndo()?l.complete():l.cancel())}})?e.stopPropagation():l.canUndo()?l.complete():l.cancel()}})}),this.view.on("key-down",function(e){return o._getCommonUpdateOperationKeyDownHandlers(l,e)}),this.view.on("key-down",function(e){if(e.key===k.constraintKey&&!c&&l){c=!0;var t=l.activeComponent;t instanceof E&&(t.preserveAspectRatio=!t.preserveAspectRatio)}}),this.view.on("key-up",function(e){if(e.key===k.constraintKey&&l){c=!1;var t=l.activeComponent;t instanceof E&&(t.preserveAspectRatio=!t.preserveAspectRatio)}})],s="transform"===t?this._getBox(e,r):this._getReshape(e,r),l=new S({activeComponent:s,type:"update",onEnd:function(){h.forEach(function(e){return e.remove()}),p.forEach(function(e){return e.remove()}),h=[],p=[],l.activeComponent.destroy(),o._layer.removeMany(o.updateGraphics.toArray()),o.updateGraphics.forEach(function(e,t){n[t]&&n[t].symbol&&(e.symbol=n[t].symbol)})},undo:function(){if(l.canUndo()){var e=l.history.undo.pop(),t=e.updates;l.history.redo.push({updates:m.getGeometries(o.updateGraphics.toArray())}),o.updateGraphics.forEach(function(e,r){e.geometry=t[r]}),l.refreshComponent(),o._emitUndoEvent({graphics:o.updateGraphics.toArray(),tool:l.tool})}},redo:function(){if(l.canRedo()){var e=l.history.redo.pop(),t=e.updates;l.history.undo.push({updates:m.getGeometries(o.updateGraphics.toArray())}),o.updateGraphics.forEach(function(e,r){e.geometry=t[r]}),l.refreshComponent(),o._emitRedoEvent({graphics:o.updateGraphics.toArray(),tool:l.tool})}},addToSelection:function(e){var t=l.activeComponent;n.push(new a(e.geometry,e.symbol,e.attributes)),e.symbol=o._getUpdateSymbol(e.geometry),o.updateGraphics.add(e),t.graphics=o.updateGraphics.toArray(),t.refresh(),l.resetHistory(),o._emitUpdateEvent({graphics:o.updateGraphics.toArray(),state:"active",tool:o.activeTool,toolEventInfo:{added:[e],type:"selection-change"}})},toggleTool:function(){o.updateGraphics.length>1||(l.activeComponent.destroy(),"transform"===l.tool?l.activeComponent=o._getReshape(e,r):"reshape"===l.tool&&(l.activeComponent=o._getBox(e,r)),l.activeComponent&&(h.forEach(function(e){return e.remove()}),h=o._getHandlesForComponent(l)))}}),h=this._getHandlesForComponent(l);return l},t.prototype._getGraphicMover=function(e,t){var o=this,i={enableMoveAllGraphics:!1!==t.enableMidpoints};return new b(r({},i,{graphics:e,view:this.view,callbacks:{onGraphicMoveStart:function(e){var t=e.dx,r=e.dy,i=e.graphic;return o._emitUpdateEvent({graphics:o.updateGraphics.toArray(),state:"active",tool:o.activeTool,toolEventInfo:{dx:t,dy:r,mover:i,type:"move-start"}})},onGraphicMove:function(e){var t=e.dx,r=e.dy,i=e.graphic;return o._emitUpdateEvent({graphics:o.updateGraphics.toArray(),state:"active",tool:o.activeTool,toolEventInfo:{dx:t,dy:r,mover:i,type:"move"}})},onGraphicMoveStop:function(e){var t=e.dx,r=e.dy,i=e.graphic;return o._emitUpdateEvent({graphics:o.updateGraphics.toArray(),state:"active",tool:o.activeTool,toolEventInfo:{dx:t,dy:r,mover:i,type:"move-stop"}})},onGraphicPointerOver:function(e){return o._displayPointerCursor()},onGraphicPointerOut:function(e){return o._displayDefaultCursor()}}}))},t.prototype._getBox=function(e,t){var o=this,i={graphics:e,enableRotation:!1!==t.enableRotation,enableScaling:!1!==t.enableScaling,preserveAspectRatio:!!t.preserveAspectRatio};return new E(r({},i,{layer:this._layer,view:this.view,callbacks:{onMoveStart:function(e){return o._emitUpdateEvent({graphics:o.updateGraphics.toArray(),state:"active",tool:o.activeTool,toolEventInfo:r({},e)})},onMove:function(e){return o._emitUpdateEvent({graphics:o.updateGraphics.toArray(),state:"active",tool:o.activeTool,toolEventInfo:r({},e)})},onMoveStop:function(e){return o._emitUpdateEvent({graphics:o.updateGraphics.toArray(),state:"active",tool:o.activeTool,toolEventInfo:r({},e)})},onScaleStart:function(e){return o._emitUpdateEvent({graphics:o.updateGraphics.toArray(),state:"active",tool:o.activeTool,toolEventInfo:r({},e)})},onScale:function(e){return o._emitUpdateEvent({graphics:o.updateGraphics.toArray(),state:"active",tool:o.activeTool,toolEventInfo:r({},e)})},onScaleStop:function(e){return o._emitUpdateEvent({graphics:o.updateGraphics.toArray(),state:"active",tool:o.activeTool,toolEventInfo:r({},e)})},onRotateStart:function(e){return o._emitUpdateEvent({graphics:o.updateGraphics.toArray(),state:"active",tool:o.activeTool,toolEventInfo:r({},e)})},onRotate:function(e){return o._emitUpdateEvent({graphics:o.updateGraphics.toArray(),state:"active",tool:o.activeTool,toolEventInfo:r({},e)})},onRotateStop:function(e){return o._emitUpdateEvent({graphics:o.updateGraphics.toArray(),state:"active",tool:o.activeTool,toolEventInfo:r({},e)})}}}))},t.prototype._getReshape=function(e,t){var o=this,i={enableMidpoints:!1!==t.enableMidpoints};return new x(r({},i,{graphic:e[0],layer:this._layer,view:this.view,callbacks:{onReshapeStart:function(e){return o._emitUpdateEvent({graphics:o.updateGraphics.toArray(),state:"active",tool:o.activeTool,toolEventInfo:r({},e)})},onReshape:function(e){return o._emitUpdateEvent({graphics:o.updateGraphics.toArray(),state:"active",tool:o.activeTool,toolEventInfo:r({},e)})},onReshapeStop:function(e){var t=e.mover,r=e.type;return o._emitUpdateEvent({graphics:o.updateGraphics.toArray(),state:"active",tool:o.activeTool,toolEventInfo:{mover:t,type:r}})},onMoveStart:function(e){var t=e.dx,r=e.dy,i=e.mover,n=e.type;return o._emitUpdateEvent({graphics:o.updateGraphics.toArray(),state:"active",tool:o.activeTool,toolEventInfo:{dx:t,dy:r,mover:i,type:n}})},onMove:function(e){var t=e.dx,r=e.dy,i=e.mover,n=e.type;return o._emitUpdateEvent({graphics:o.updateGraphics.toArray(),state:"active",tool:o.activeTool,toolEventInfo:{dx:t,dy:r,mover:i,type:n}})},onMoveStop:function(e){var t=e.dx,r=e.dy,i=e.mover,n=e.type;return o._emitUpdateEvent({graphics:o.updateGraphics.toArray(),state:"active",tool:o.activeTool,toolEventInfo:{dx:t,dy:r,mover:i,type:n}})},onVertexAdd:function(e){var t=e.added,r=e.type,i=t.map(function(e){return y.geometryToCoordinates(e.geometry)});o._emitUpdateEvent({graphics:o.updateGraphics.toArray(),state:"active",tool:o.activeTool,toolEventInfo:{added:i,type:r}})},onVertexRemove:function(e){var t=e.removed,r=e.type,i=t.map(function(e){return y.geometryToCoordinates(e.geometry)});o._emitUpdateEvent({graphics:o.updateGraphics.toArray(),state:"active",tool:o.activeTool,toolEventInfo:{removed:i,type:r}})}}}))},t.prototype._getHandlesForComponent=function(e){var t=e.activeComponent;return t instanceof E?[t.on("move-start",function(t){return e.addToHistory({updates:m.getGeometries(t.graphics)})}),t.on("rotate-start",function(t){return e.addToHistory({updates:m.getGeometries(t.graphics)})}),t.on("scale-start",function(t){return e.addToHistory({updates:m.getGeometries(t.graphics)})})]:t instanceof x?[t.on("move-start",function(t){return e.addToHistory({updates:[t.mover.geometry]})}),t.on("reshape-start",function(t){return e.addToHistory({updates:[t.graphic.geometry]})}),t.on("vertex-add",function(t){return e.addToHistory({updates:[t.oldGraphic.geometry]})}),t.on("vertex-remove",function(t){return e.addToHistory({updates:[t.oldGraphic.geometry]})})]:void 0},t.prototype._getCommonUpdateOperationKeyDownHandlers=function(e,t){if(e){var r=t.key;r===k.undoKey&&e.canUndo()?(t.stopPropagation(),e.undo()):r===k.redoKey&&e.canRedo()?(t.stopPropagation(),e.redo()):r===k.cancelKey&&(e.canUndo()?e.complete():e.cancel())}},t.prototype._getCreateSymbol=function(e,t){var r=e.type||null;return"point"===r||"multipoint"===r?t?this.activePointSymbol:this.pointSymbol:"polyline"===r?t?this.activeLineSymbol:this.polylineSymbol:"polygon"===r?t?this.activeFillSymbol:this.polygonSymbol:null},t.prototype._getUpdateSymbol=function(e){var t=e.type||null;return"point"===t||"multipoint"===t?this.updatePointSymbol:"polyline"===t?this.updatePolylineSymbol:"polygon"===t||"extent"===t?this.updatePolygonSymbol:null},t.prototype._drawMultipointGraphic=function(e,t){var r=null;if(!t&&e.length>1){var o=e.slice(0);o.pop(),r=C.createMultipoint(o,this.view)}else r=C.createMultipoint(e,this.view);this.createGraphic?this.createGraphic.geometry=r:this._set("createGraphic",new a(r,this.pointSymbol)),t&&1===e.length&&this._layer.add(this.createGraphic)},t.prototype._drawVertexGraphics=function(e,t,r){var o=!(!r||!r.userClicked),i="polygon"===e,c=i?this.polygonSymbol:this.polylineSymbol;if(1===t.length){this._removeLineGraphic(),this._removeActiveLineGraphic();var p=t[0],s=p[0],l=p[1],h=new n.Point(s,l,this.view.spatialReference),d=i?C.createPolygon([t],this.view):C.createPolyline([t],this.view);this._vertexGraphics.length?this._vertexGraphics[0].geometry=h:this._vertexGraphics.push(new a(h,this.activePointSymbol)),this.createGraphic?this.createGraphic.geometry=d:this._set("createGraphic",new a(d,c)),o&&this._layer.add(this._vertexGraphics[0])}else if(2===t.length){
var v=t[1],s=v[0],l=v[1],u=new n.Point(s,l,this.view.spatialReference),y=this._getCreateSymbol(u,!0),m=C.createPolyline([t],this.view),d=i?C.createPolygon([t],this.view):C.createPolyline([t],this.view);if(!this._vertexGraphics.length){var _=t[0],f=_[0],g=_[1],h=new n.Point(f,g,this.view.spatialReference),w=new a(h,y);this._vertexGraphics.push(w)}if(1===this._vertexGraphics.length){var G=this._vertexGraphics[0],E=new a(u,y);this._removeLineGraphic(),this._removeActiveFillGraphic(),this._vertexGraphics.push(E),this._layer.remove(G),this._layer.add(G)}else this._vertexGraphics[1].geometry=u;this._showActiveLineGraphic(m);var b=this._vertexGraphics[0];o&&(this._activeLineGraphic.symbol=this.polylineSymbol,b.symbol=this.pointSymbol,this._layer.add(this._vertexGraphics[1])),this.createGraphic?this.createGraphic.geometry=d:this._set("createGraphic",new a(d,this.polygonSymbol)),this._layer.remove(b),this._layer.add(b)}else if(t.length>2){var d=i?C.createPolygon([t],this.view):C.createPolyline([t],this.view);"polygon"===e&&this._showFillGraphic(d);var x=t.map(function(e){return Array.apply([],e)}),S=x.pop(),U=[x[x.length-1],S],k=C.createPolyline([x],this.view),A=C.createPolyline(U,this.view);this._showLineGraphic(k),this._showActiveLineGraphic(A);for(var O in x){var R=this._vertexGraphics[O];if(R)R.symbol=this.pointSymbol;else{var T=t[O],s=T[0],l=T[1];this._showVertexGraphic(new n.Point(s,l,this.view.spatialReference))}}if(o){this._activeLineGraphic.symbol=this.polylineSymbol;var I=t[t.length-1],s=I[0],l=I[1];this._showVertexGraphic(new n.Point(s,l,this.view.spatialReference))}else this._activeLineGraphic.symbol=this.activeLineSymbol,this._vertexGraphics[this._vertexGraphics.length-1].symbol=this.activePointSymbol;this.createGraphic?this.createGraphic.geometry=d:(this._removeCreateGraphic(),this._set("createGraphic",new a(d,c)));for(var H=0,P=this._vertexGraphics;H<P.length;H++){var w=P[H];this._layer.remove(w),this._layer.add(w)}}},t.prototype._drawSegmentGraphic=function(e,t,r){if(t.length){var o=!(!r||!r.centered),i=!(!r||!r.constrained),n=null;1===t.length?(n=C.createPolygon([t],this.view),this._removeCenterIndicatorGraphic()):("rectangle"===e?n=i?C.createSquare(t,this.view,o):C.createRectangle(t,this.view,o):"circle"===e&&(n=i?C.createEllipse(t,this.view,o):C.createCircle(t,this.view,o)),n.extent&&n.extent.center&&this._showCenterIndicatorGraphic(n.extent.center)),this.createGraphic?this.createGraphic.geometry=n:(this._removeCreateGraphic(),this._set("createGraphic",new a(n,this.polygonSymbol)),this._layer.add(this.createGraphic))}},t.prototype._showCenterIndicatorGraphic=function(e){this._centerIndicatorGraphic?this._centerIndicatorGraphic.geometry=e:(this._centerIndicatorGraphic=new a(e,this._centerSymbol),this._layer.add(this._centerIndicatorGraphic))},t.prototype._removeCenterIndicatorGraphic=function(){this._centerIndicatorGraphic&&(this._layer.remove(this._centerIndicatorGraphic),this._centerIndicatorGraphic.destroy(),this._centerIndicatorGraphic=null)},t.prototype._showActiveLineGraphic=function(e){this._activeLineGraphic?this._activeLineGraphic.geometry=e:(this._activeLineGraphic=new a(e,this.activeLineSymbol),this._layer.graphics.add(this._activeLineGraphic,0))},t.prototype._showFillGraphic=function(e){this._activeFillGraphic?this._activeFillGraphic.geometry=e:(this._activeFillGraphic=new a(e,this.activeFillSymbol),this._layer.add(this._activeFillGraphic))},t.prototype._showLineGraphic=function(e){this._lineGraphic?this._lineGraphic.geometry=e:(this._lineGraphic=new a(e,this.polylineSymbol),this._layer.graphics.add(this._lineGraphic,0))},t.prototype._showVertexGraphic=function(e,t){var r=t?this.activePointSymbol:this.pointSymbol,o=new a(e,r);this._vertexGraphics.push(o),this._layer.add(o)},t.prototype._resetCreateOperationGraphics=function(){this._activeFillGraphic&&(this._activeFillGraphic.geometry=null),this._lineGraphic&&(this._lineGraphic.geometry=null),this._activeLineGraphic&&(this._activeLineGraphic.geometry=null),this._removeVertexGraphics()},t.prototype._removeCreateGraphic=function(){this.createGraphic&&(this._layer.remove(this.createGraphic),this._set("createGraphic",null))},t.prototype._removeCreateOperationGraphics=function(){this._removeCenterIndicatorGraphic(),this._removeActiveLineGraphic(),this._removeActiveFillGraphic(),this._removeLineGraphic(),this._removeVertexGraphics()},t.prototype._removeActiveLineGraphic=function(){this._activeLineGraphic&&(this._layer.remove(this._activeLineGraphic),this._activeLineGraphic.destroy(),this._activeLineGraphic=null)},t.prototype._removeActiveFillGraphic=function(){this._activeFillGraphic&&(this._layer.remove(this._activeFillGraphic),this._activeFillGraphic.destroy(),this._activeFillGraphic=null)},t.prototype._removeLineGraphic=function(){this._lineGraphic&&(this._layer.remove(this._lineGraphic),this._lineGraphic.destroy(),this._lineGraphic=null)},t.prototype._removeVertexGraphics=function(){this._vertexGraphics.length&&(this._layer.removeMany(this._vertexGraphics),this._vertexGraphics.forEach(function(e){return e.destroy()}),this._vertexGraphics=[])},t.prototype._removeDefaultLayer=function(){this._layer&&(this.view&&this.view.map.remove(this._layer),this._layer.destroy(),this._layer=null)},t.prototype._snapLastVertexToAxis=function(e){if(!(e.length<2)){var t=e.pop(),r=e[e.length-1],o=this.view.toScreen(t[0],t[1],null),i=this.view.toScreen(r[0],r[1],null),n=Math.abs(o.x-i.x),a=Math.abs(o.y-i.y),c=this.view.toMap(n>a?o.x:i.x,n>a?i.y:o.y);e.push([c.x,c.y])}},t.prototype._displayCrosshairCursor=function(){this.view&&this.view.container&&this.view.container.style&&"crosshair"!==this.view.container.style.cursor&&(this.view.container.style.cursor="crosshair")},t.prototype._displayPointerCursor=function(){this.view&&this.view.container&&this.view.container.style&&"pointer"!==this.view.container.style.cursor&&(this.view.container.style.cursor="pointer")},t.prototype._displayDefaultCursor=function(){this.view&&this.view.container&&this.view.container.style&&"default"!==this.view.container.style.cursor&&(this.view.container.style.cursor="default")},t.prototype._logError=function(e,t,r){U.error(new s(e,t,r))},t.prototype._emitCreateEvent=function(e){this.emit("create",r({},e,{type:"create"}))},t.prototype._emitUpdateEvent=function(e){this.emit("update",r({},e,{type:"update"}))},t.prototype._emitResetEvent=function(){this.emit("reset",{type:"reset"})},t.prototype._emitUndoEvent=function(e){this.emit("undo",r({},e,{type:"undo"}))},t.prototype._emitRedoEvent=function(e){this.emit("redo",r({},e,{type:"redo"}))},i([u.property()],t.prototype,"_operationHandle",void 0),i([u.property({dependsOn:["_operationHandle","_operationHandle.tool"],readOnly:!0})],t.prototype,"activeTool",null),i([u.property()],t.prototype,"activeFillSymbol",void 0),i([u.property()],t.prototype,"activeLineSymbol",void 0),i([u.property()],t.prototype,"activePointSymbol",void 0),i([u.property({readOnly:!0})],t.prototype,"createGraphic",void 0),i([u.property()],t.prototype,"defaultUpdateOptions",void 0),i([u.property()],t.prototype,"hoverVertexSymbol",void 0),i([u.property()],t.prototype,"layer",void 0),i([u.property()],t.prototype,"pointSymbol",void 0),i([u.property()],t.prototype,"polygonSymbol",void 0),i([u.property()],t.prototype,"polylineSymbol",void 0),i([u.property()],t.prototype,"selectedVertexSymbol",void 0),i([u.property({dependsOn:["view.ready","layer","_operationHandle"],readOnly:!0})],t.prototype,"state",null),i([u.property({readOnly:!0})],t.prototype,"updateGraphics",void 0),i([u.property()],t.prototype,"updateOnGraphicClick",void 0),i([u.property()],t.prototype,"updatePointSymbol",void 0),i([u.property()],t.prototype,"updatePolygonSymbol",void 0),i([u.property()],t.prototype,"updatePolylineSymbol",void 0),i([u.property()],t.prototype,"vertexSymbol",void 0),i([u.property()],t.prototype,"view",null),i([u.property()],t.prototype,"cancel",null),i([u.property()],t.prototype,"complete",null),i([u.property()],t.prototype,"create",null),i([u.property()],t.prototype,"reset",null),i([u.property()],t.prototype,"update",null),i([u.property()],t.prototype,"undo",null),i([u.property()],t.prototype,"redo",null),i([u.property()],t.prototype,"canUndo",null),i([u.property()],t.prototype,"canRedo",null),i([u.property()],t.prototype,"toggleUpdateTool",null),t=i([u.subclass("esri.widgets.Sketch.SketchViewModel")],t)}(u.declared(c,l))});